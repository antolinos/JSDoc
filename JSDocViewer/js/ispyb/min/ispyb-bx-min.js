function Event(a){this._sender=a;this._listeners=[];}Event.prototype={attach:function(a){this._listeners.push(a);},notify:function(a){for(var b=0;b<this._listeners.length;b++){this._listeners[b](this._sender,a);}}};function ItemGraphFormatter(f,c,d,b,a){this.id=f;this.args=new Object();this.defaultFormat=new ItemFormat(c);
if(d!=null){this.selected=new ItemFormat(d);}else{this.selected=new ItemFormat(c);}if(b!=null){this.over=new ItemFormat(b);}else{this.over=new ItemFormat(c);}if(a!=null){this.dragging=new ItemFormat(a);}else{this.dragging=new ItemFormat(c);}this.stateChanged=new Event(this);var e=this;this._setEvents();
}ItemGraphFormatter.prototype.getType=function(){return this.args.type;};ItemGraphFormatter.prototype.toJSON=function(){var a=this.args;a.defaultFormat=this.getDefault().toJSON();a.over=this.getOver().toJSON();a.selected=this.getSelected().toJSON();a.dragging=this.getDragging().toJSON();a.id=this.id;
return a;};ItemGraphFormatter.prototype.loadFromJSON=function(a){this.args=a;this.defaultFormat=new ItemFormat(a.defaultFormat);this.over=new ItemFormat(a.over);this.selected=new ItemFormat(a.selected);this.dragging=new ItemFormat(a.dragging);this._setEvents();};ItemGraphFormatter.prototype._setEvents=function(){var a=this;
this.defaultFormat.changed.attach(function(b,c){a.over.setSize(a.defaultFormat.getSize());a.selected.setSize(a.defaultFormat.getSize());a.dragging.setSize(a.defaultFormat.getSize());a.stateChanged.notify(a);});this.selected.changed.attach(function(b,c){a.stateChanged.notify(a);});this.over.changed.attach(function(b,c){a.stateChanged.notify(a);
});this.dragging.changed.attach(function(b,c){a.stateChanged.notify(a);});};ItemGraphFormatter.prototype.getId=function(){return this.id;};ItemGraphFormatter.prototype.getDefault=function(){return this.defaultFormat;};ItemGraphFormatter.prototype.getSelected=function(){return this.selected;};ItemGraphFormatter.prototype.getOver=function(){return this.over;
};ItemGraphFormatter.prototype.getDragging=function(){return this.dragging;};function ItemFormat(a){this.defaultFormat=new Object();this.args=new Object();this.args.title=new Object();this.args.visible=true;this.args.hidden=false;this.args.stroke="#000000";this.args.strokeOpacity=0.8;this.args["stroke-width"]=1;
this.args.fill="#000000";this.args["fill-opacity"]=1;this.args.size=1;this.args.opacity=1;this.args.fontSize="8";this.args.fontColor="#000000";if(a!=null){if(a.visible!=null){this.args.visible=a.visible;}if(a.opacity!=null){this.args.opacity=a.opacity;}if(a.size!=null){this.args.size=a.size;}if(a.hidden!=null){this.args.hidden=a.hidden;
}if(a.stroke!=null){this.args.stroke=this._fixColor(a.stroke);}if(a.strokeOpacity!=null){this.args.strokeOpacity=a.strokeOpacity;}if(a["stroke-width"]!=null){this.args["stroke-width"]=a["stroke-width"];}if(a["fill-opacity"]!=null){this.args["fill-opacity"]=a["fill-opacity"];}if(a.shape!=null){this.args.shape=a.shape;
}if(a.fill!=null){this.args.fill=this._fixColor(a.fill);}if(a.title!=null){if(a.title.fontSize!=null){this.args.title.fontSize=a.title.fontSize;}if(a.title.fill!=null){this.args.title.fill=this._fixColor(a.title.fill);}}}this.changed=new Event();}ItemFormat.prototype._fixColor=function(a){var b=a;if(a.indexOf("green")!=-1){b="#04B431";
}if(a.indexOf("blue")!=-1){b="#045FB4";}if(a.indexOf("red")!=-1){b="#DF0101";}if(a.indexOf("black")!=-1){b="#000000";}if(a.indexOf("white")!=-1){b="#FFFFFF";}if(a.indexOf("#")==-1){b="#"+a;}return b;};ItemFormat.prototype.toJSON=function(){if(this.args.strokeOpacity!=null){this.args["stroke-opacity"]=this.args.strokeOpacity;
delete this.args.strokeOpacity;}if(this.args.title.fontColor!=null){this.args.title["font-color"]=this.args.title.fontColor;}else{this.args.title["font-color"]=this.args.fontColor;}if(this.args.title.fontSize!=null){this.args.title["font-size"]=this.args.title.fontSize;}else{this.args.title["font-size"]=this.args.fontSize;
}return this.args;};ItemFormat.prototype.getAttribute=function(a){return this.args[a];};ItemFormat.prototype.setVisible=function(a){if(this.args.visible!=a){this.args.visible=a;this.changed.notify(this);}};ItemFormat.prototype.getVisible=function(){return this.args.visible;};ItemFormat.prototype.setHidden=function(a){if(this.args.hidden!=a){this.args.hidden=a;
this.changed.notify(this);}};ItemFormat.prototype.getHidden=function(){return this.args.hidden;};ItemFormat.prototype.setStroke=function(a){if(this.args.stroke!=a){this.args.stroke=a;this.changed.notify(this);}};ItemFormat.prototype.getStroke=function(){return this.args.stroke;};ItemFormat.prototype.setStrokeOpacity=function(a){if(this.args.strokeOpacity!=a){this.args.strokeOpacity=a;
this.changed.notify(this);}};ItemFormat.prototype.getStrokeOpacity=function(){return this.args["stroke-opacity"];};ItemFormat.prototype.setStrokeWidth=function(a){if(this.args["stroke-width"]!=a){this.args["stroke-width"]=a;this.changed.notify(this);}};ItemFormat.prototype.getFillOpacity=function(){return this.args["fill-opacity"];
};ItemFormat.prototype.setfillOpacity=function(a){if(this.args["fill-opacity"]!=a){this.args["fill-opacity"]=a;this.changed.notify(this);}};ItemFormat.prototype.getStrokeWidth=function(){return this.args["stroke-width"];};ItemFormat.prototype.setFill=function(a){if(this.args.fill!=a){this.args.fill=a;
this.changed.notify(this);}};ItemFormat.prototype.getFill=function(){return this.args.fill;};ItemFormat.prototype.setSize=function(a){if(this.args.size!=a){this.args.size=a;this.changed.notify(this);}};ItemFormat.prototype.getSize=function(){return this.args.size;};ItemFormat.prototype.setOpacity=function(a){if(this.args.opacity!=a){this.args.opacity=a;
this.changed.notify(this);}};ItemFormat.prototype.getOpacity=function(){return this.args.opacity;};ItemFormat.prototype.getArrowSize=function(){return this.args.arrowSize;};ItemFormat.prototype.setArrowSize=function(a){if(this.args.arrowSize!=a){this.args.arrowSize=a;this.changed.notify(this);}};ItemFormat.prototype.getFontSize=function(){return this.args.title.fontSize;
};ItemFormat.prototype.setFontSize=function(a){if(this.args.title.fontSize!=a){this.args.title.fontSize=a;this.changed.notify(this);}};function GenericGraph(a){this.width=600;this.height=400;this.targetId=null;this.top=10;this.left=10;this.bottom=50;this.right=40;this.rulerHeight=50;this.rulerWidth=50;
this.rulerStroke=2;this.rulerVerticalMarksNumber=5;this.rulerMaxValue=null;this.rulerMinValue=null;this.plotPoints=true;this.pointRadius=2;this.fillOpacityPoint=0.2;this.strokeOpacityPoint=0.2;this.clusterTitleHeight=20;this.interClassesSpace=2;this.interClustersSpace=4;this.fontSize=7;this.plotHorizontalByCluster=true;
if(a!=null){if(a.targetId!=null){this.targetId=a.targetId;}if(a.plotHorizontalByCluster!=null){this.plotHorizontalByCluster=a.plotHorizontalByCluster;}if(a.height!=null){this.height=a.height;}if(a.width!=null){this.width=a.width;}if(a.rulerMinValue!=null){this.rulerMinValue=a.rulerMinValue;}if(a.rulerMaxValue!=null){this.rulerMaxValue=a.rulerMaxValue;
}if(a.rulerHeight!=null){this.rulerHeight=a.rulerHeight;}}}GenericGraph.prototype.calculate=function(d){var a={};var c=this.cleanArray(d);c.sort(function(f,e){return f-e;});var b=this.getMedian(c);a.median=b;a.Q1=Number(this.getQ1(c));a.Q2=Number(this.getQ2(c));a.Q3=Number(this.getQ3(c));a.population=c;
a.IQR=Number(a.Q3-a.Q1);a.outlier_below_limit=a.Q1-(1.5*a.IQR);a.outlier_above_limit=a.Q3+(1.5*a.IQR);a.below_outliers=this.getBelowOutliers(a.outlier_below_limit,c);a.above_outliers=this.getAboveOutliers(a.outlier_above_limit,c);a.min_whisker=this.minValueWhisker(a.outlier_below_limit,a.Q1,c);a.max_whisker=this.maxValueWhisker(a.outlier_above_limit,a.Q3,c);
return a;};GenericGraph.prototype.drawSVGVerticalText=function(a,e,d,c){var b=["transform","translate("+a+", "+e+"), rotate(-90) "];c.push(b);SVG.drawText(0,0,d,this.svg,c);};GenericGraph.prototype.plotRuler=function(g){SVG.drawRectangle(g.vertical.x,g.vertical.y,g.vertical.width,g.vertical.height,this.svg,[["fill","black"]]);
var b=g.vertical.height/(this.rulerVerticalMarksNumber+1);for(var e=0;e<=this.rulerVerticalMarksNumber+1;e++){var h=b*e;var d=g.vertical.height-h;var j=Number((d/g.vertical.height)*(g.maxPoint-g.minPoint)+g.minPoint).toFixed(3);SVG.drawLine(g.horizontal.x,this.top+h,g.horizontal.x-g.markWidth,this.top+h,this.svg,[["stroke","black"]]);
SVG.drawText(this.left,this.top+b*e+5,j,this.svg,[["style","font-size:xx-small"]]);SVG.drawLine(g.horizontal.x,this.top+h,this.width-this.right,this.top+h,this.svg,[["stroke",g.markColor],["stroke-width","0.3"]]);if(e==this.rulerVerticalMarksNumber+1){SVG.drawLine(g.horizontal.x,this.top+h,this.width-this.right,this.top+h,this.svg,[["stroke",g.markColor]]);
}}if(!this.plotHorizontalByCluster){var c=g.horizontal.width;var f=c/(g.horizontal.xValues.range);for(e=0;e<g.horizontal.xValues.values.length;e++){var a=g.horizontal.xValues.values[e]-g.horizontal.xValues.min;SVG.drawText(g.horizontal.x+a*f,this.height-(this.bottom+(this.clusterTitleHeight)),g.horizontal.xValues.values[e],this.svg,[["style","font-size:small"]]);
}}};GenericGraph.prototype.plotAxes=function(a){this.plotRuler({minPoint:Number(a.minPoint),maxPoint:Number(a.maxPoint),markColor:"black",markWidth:20,vertical:{x:this.left+this.rulerWidth-this.rulerStroke,y:this.top,width:this.rulerStroke,height:this.height-(this.top+this.bottom+this.clusterTitleHeight)-this.rulerHeight},horizontal:{x:this.left+this.rulerWidth-this.rulerStroke,y:this.height-(this.bottom+this.clusterTitleHeight+this.rulerHeight),width:a.width,height:this.rulerStroke,xValues:a.xValues}});
};GenericGraph.prototype.cleanArray=function(c){var b=[];for(var a=0;a<c.length;a++){if(c[a]!=null){if(!isNaN(c[a])){b.push(c[a]);}}}return b;};GenericGraph.prototype.refresh=function(a){document.getElementById(this.targetId).innerHTML="";this.draw(this.targetId,a);};GenericGraph.prototype.getClassColor=function(e){for(var d=0;
d<this.data.clusters.length;d++){var a=this.data.clusters[d];for(var b=0;b<a.classes.length;b++){var c=a.classes[b];if(c.name==e){if(c.color!=null){return c.color;}}}}return"black";};GenericGraph.prototype.getDimensions=function(f){var g={};var m=[];this.data=f;var n=0;var a=[];for(var h=0;h<f.clusters.length;
h++){var l=f.clusters[h];if(!this.plotHorizontalByCluster){a.push(f.clusters[h].x);}for(var d=0;d<l.classes.length;d++){var b=l.classes[d];m=m.concat(b.values);n=n+1;}}var k=this.cleanArray(m);k.sort(function(j,i){return j-i;});g.minPoint=k[0];if(this.rulerMinValue!=null){g.minPoint=this.rulerMinValue;
}g.maxPoint=k[k.length-1];if(this.rulerMaxValue!=null){g.maxPoint=this.rulerMaxValue;}g.classesNumber=n;g.clusterNumber=f.clusters.length;var c=(n-f.clusters.length)*this.interClassesSpace;var e=(f.clusters.length)*this.interClustersSpace;g.classWidth=(this.width-(this.rulerWidth+this.left+this.right+c+e))/n;
g.width=this.width-(this.right+this.left)-this.rulerWidth+this.rulerStroke;g.xValues={};a.sort(function(j,i){return j-i;});g.xValues.values=a;if(a.length>0){g.xValues.min=a[0];g.xValues.max=a[a.length-1];g.xValues.range=g.xValues.max-g.xValues.min;}return g;};GenericGraph.prototype.draw=function(a,c){this.targetId=a;
var b=(this.getDimensions(c));this.svg=SVG.createSVGCanvas(document.getElementById(this.targetId),[["width",this.width],["height",this.height]]);this.plotAxes(b);};GenericGraph.prototype.getMedian=function(a){if(a.length%2==1){return a[Math.floor(a.length/2)];}else{return(Number(a[(a.length/2)-1])+Number(a[a.length/2]))/2;
}};GenericGraph.prototype.pointToPixel=function(b,c){var a=(b-c.minPoint)/(c.maxPoint-c.minPoint);var d=c.height-c.y+this.top;return(-1*a)*(d)+(c.y+c.height);};GenericGraph.prototype.maxValueWhisker=function(a,d,e){var c=[];for(var b=0;b<e.length;b++){if((e[b]>d)&&(e[b])<=a){c.push(e[b]);}}if(c.length>0){c.sort(function(g,f){return g-f;
});return c[c.length-1];}return null;};GenericGraph.prototype.input=function(){return DATADOC.getBoxWhikerData();};GenericGraph.prototype.test=function(a){var b=new GenericGraph({targetId:a,height:350,width:450,maxBoxWidth:25});b.refresh(this.input());};function DygraphWidget(b,a){this.width=1000;this.height=600;
this.labelsWidth=100;this.targetId=b;this.customBars=false;this.ylabel="";this.xlabel="";this.id=BUI.id();this.showRangeSelector=false;this.interactionModel=null;this.labelsDivStyles=null;this.ranges={};if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}if(a.labelsWidth!=null){this.labelsWidth=a.labelsWidth;
}if(a.labelsDivStyles!=null){this.labelsDivStyles=a.labelsDivStyles;}if(a.customBars!=null){this.customBars=a.customBars;}if(a.ylabel!=null){this.ylabel=a.ylabel;}if(a.xlabel!=null){this.xlabel=a.xlabel;}if(a.showRangeSelector!=null){this.showRangeSelector=a.showRangeSelector;}if(a.interactionModel!=null){this.interactionModel=a.interactionModel;
}if(a.scaled!=null){this.scaled=a.scaled;}if(a.ranges!=null){this.ranges=a.ranges;}}this.onZoomX=new Event(this);this.onResetZoom=new Event(this);this.dblclick=new Event(this);}DygraphWidget.prototype.dblclick=function(c,b,a){b.widget.dblclick.notify({x:b.lastx_});};DygraphWidget.prototype._createHTLMWrapper=function(d,a,f){if(document.getElementById(this.targetId)==null){return;
}document.getElementById(this.targetId).innerHTML="";var b=document.createElement("table");var c=document.createElement("tr");var e=document.createElement("td");this.canvasDiv=document.createElement("div");this.canvasDiv.setAttribute("id","dygraph_canvas_"+this.id);this.canvasDiv.setAttribute("style","width:"+this.width+"px;height:"+this.height+"px");
e.appendChild(this.canvasDiv);this.legendDiv=document.createElement("div");c.appendChild(e);b.appendChild(c);document.getElementById(this.targetId).appendChild(b);};DygraphWidget.prototype.draw=function(b,a,c){this._createHTLMWrapper(b,a,c);this.dygraph=new Dygraph(this.canvasDiv,b,{labels:c,labelsDiv:this.legendDiv,labelsSeparateLines:true,highlightCircleSize:3,strokeWidth:1,customBars:this.customBars,colors:a,scaled:this.scaled,ranges:this.ranges,xlabel:this.xlabel,ylabel:this.ylabel,showRangeSelector:this.showRangeSelector,rangeSelectorPlotStrokeColor:"rgba(50,50,50,0.3)",rangeSelectorPlotFillColor:"rgba(50,50,50,0.1)",labelsDivStyles:this.labelsDivStyles,interactionModel:this.interactionModel});
};function BiosaxsDataAdapter(){this.type="POST";this.onSuccess=new Event(this);this.onError=new Event(this);}BiosaxsDataAdapter.prototype._doAction=function(a,b){var c=this;$.ajax({type:"POST",url:"dataadapter.do?reqCode="+a,data:b,datatype:"text/json",success:function(d){c.onSuccess.notify(d);},error:function(d){c.onError.notify(d.responseText);
}});};BiosaxsDataAdapter.prototype.getFitStructureToExperimentalDataBySubtractionId=function(a){this._doAction("getFitStructureToExperimentalDataBySubtractionId",{subtractionId:a});};BiosaxsDataAdapter.prototype.addFitStructureData=function(a){this._doAction("addFitStructureData",{fitStructureToExperimentalData:JSON.stringify(a)});
};BiosaxsDataAdapter.prototype.addWorkflow=function(b,a){this._doAction("addWorkflow",{workflow:JSON.stringify(b),inputParameters:JSON.stringify(a)});};BiosaxsDataAdapter.prototype.getFitStructureToExperimentalDataFile=function(a,b,c){this._doAction("getFitStructureToExperimentalDataFile",{fitStructureToExperimentalDataId:a,type:b,format:c});
};BiosaxsDataAdapter.prototype.getStructureFile=function(a){this._doAction("getStructureFile",{structureId:a});};BiosaxsDataAdapter.prototype.getCompactAnalysisByProposalId=function(a){if(a==null){a=100;}this._doAction("getCompactAnalysisByProposalId",{limit:a});};BiosaxsDataAdapter.prototype.getCompactAnalysisBySubtractionId=function(a){this._doAction("getCompactAnalysisBySubtractionId",{subtractionId:a});
};BiosaxsDataAdapter.prototype.getAbinitioByIdsList=function(a){this._doAction("getAbinitioByIdsList",{abinitioIdsList:a.toString()});};BiosaxsDataAdapter.prototype.getCompactAnalysisByExperimentId=function(a){this._doAction("getCompactAnalysisByExperimentId",{experimentId:a});};BiosaxsDataAdapter.prototype.saveExperiment=function(c,a,b,d){this._doAction("saveExperiment",{experimentId:c,name:a,type:b,comments:d});
};BiosaxsDataAdapter.prototype.saveStoichiometry=function(b,a,c,d){this._doAction("saveStoichiometry",{macromoleculeMolarityId:a,macromoleculeId:b,ratio:c,comments:d});};BiosaxsDataAdapter.prototype.removeStoichiometry=function(a){this._doAction("removeStoichiometry",{stoichiometryId:a});};BiosaxsDataAdapter.prototype.removeStructure=function(a){this._doAction("removeStructure",{structureId:a});
};BiosaxsDataAdapter.prototype.sortMeasurements=function(b,a){this._doAction("sortMeasurements",{experimentId:b,sortBy:a});};BiosaxsDataAdapter.prototype.setMeasurementParameters=function(b,c,a){this._doAction("setMeasurementParameters",{measurementIds:b.toString(),parameter:c,value:a});};BiosaxsDataAdapter.prototype.getZipFileByAverageListId=function(a){this._doAction("getZipFileByAverageListId",{mergeIdsList:a.toString(),fileName:"test"});
};BiosaxsDataAdapter.prototype.getZipFileByMacromoleculeId=function(a){this._doAction("getZipFileByMacromoleculeId",{macromoleculeId:a});};BiosaxsDataAdapter.prototype.getH5FrameScattering=function(a,b){this._doAction("getH5FrameScattering",{experimentId:a,frames:b});};BiosaxsDataAdapter.prototype.getH5FramesMerge=function(a,b){this._doAction("getH5FramesMerge",{experimentId:a,frames:b});
};BiosaxsDataAdapter.prototype.getH5fileParameters=function(a,b){this._doAction("getH5fileParameters",{experimentId:a,parameters:b.toString()});};BiosaxsDataAdapter.prototype.mergeSpecimens=function(a,b){this._doAction("mergeSpecimens",{specimenTargetId:b,specimenOriginId:a});};BiosaxsDataAdapter.prototype.getReport=function(c,a,b,e){var d={experimentId:c,format:e,filename:a,type:"DATA_ACQUISITION"};
if(Ext.urlDecode(window.location.href).sessionId!=null){d.sessionId=Ext.urlDecode(window.location.href).sessionId;}this._doAction("getReport",d);};BiosaxsDataAdapter.prototype.updateDataBaseFromSMIS=function(){this._doAction("updateDataBaseFromSMIS",{});};BiosaxsDataAdapter.prototype.getModelFile=function(a,c,b){if(b==null){b="json";
}this._doAction("getModelFile",{type:a,modelId:c,format:b});};BiosaxsDataAdapter.prototype.getImage=function(a,b){this._doAction("getImage",{subtractionId:a,type:b});};BiosaxsDataAdapter.prototype.removeExperimentContentById=function(a){this._doAction("removeExperimentContent",{experimentId:a});};BiosaxsDataAdapter.prototype.getAbinitioModelsByExperimentId=function(a){this._doAction("getAbinitioModelsByExperimentId",{experimentId:a});
};BiosaxsDataAdapter.prototype.getMergesByIdsList=function(a){this._doAction("getMergesByIdsList",{mergeIdsList:a.toString()});};BiosaxsDataAdapter.prototype.getScatteringCurveByFrameIdsList=function(b,c,a){this._doAction("getScatteringCurveByFrameIdsList",{frameIdsList:b.toString(),mergeIdsList:c.toString(),subtractionIds:a.toString()});
};BiosaxsDataAdapter.prototype.removeExperimentById=function(a){this._doAction("removeExperiment",{experimentId:a});};BiosaxsDataAdapter.prototype.getProposal=function(a){this._doAction("getProposal",{sessionId:a});};BiosaxsDataAdapter.prototype.getExperimentById=function(b,a){if(a==null){a="MINIMAL";
}this._doAction("getExperimentById",{experimentId:b,scope:a,sessionId:Ext.urlDecode(window.location.href).sessionId});};BiosaxsDataAdapter.prototype._getInformationByMacromoleculeId=function(a){this._doAction("getInformationByMacromoleculeId",{data:JSON.stringify(a)});};BiosaxsDataAdapter.prototype.getInformationByMacromoleculeId=function(c,b){var d={macromoleculeId:c};
if(b!=null){d.bufferId=b;}var a=[d];this._getInformationByMacromoleculeId(a);};BiosaxsDataAdapter.prototype.getPDBContentByModelList=function(a){this._doAction("getPDBContentByModelList",{properties:JSON.stringify(a)});};BiosaxsDataAdapter.prototype.getAnalysisCalibrationByProposalId=function(){this._doAction("getAnalysisCalibrationByProposalId",{sessionId:Ext.urlDecode(window.location.href).sessionId});
};BiosaxsDataAdapter.prototype.getAnalysisInformationByExperimentId=function(a){this._doAction("getAnalysisInformationByExperimentId",{experimentId:a});};BiosaxsDataAdapter.prototype.createTemplate=function(b,d,a,c){this._doAction("createTemplate",{experimentId:c,name:b,comments:d,measurements:a.toString()});
};BiosaxsDataAdapter.prototype.addMeasurements=function(b,d,a,c){this._doAction("createTemplate",{experimentId:c,name:b,comments:d,measurements:a.toString()});};BiosaxsDataAdapter.prototype.getExperimentInformationByProposalId=function(a){this._doAction("getExperimentInformationByProposalId",{sessionId:a});
};BiosaxsDataAdapter.prototype.getAllInformationByExperimentId=function(a){this._doAction("getAllInformationByExperimentId",{experimentId:a});};BiosaxsDataAdapter.prototype.getAnalysisByProposalId=function(){this._doAction("getAnalysisByProposalId",{});};BiosaxsDataAdapter.prototype.getExperimentsByProposalId=function(a){if(a==null){a="MINIMAL";
}this._doAction("getExperimentsByProposalId",{scope:a});};BiosaxsDataAdapter.prototype.saveMacromolecule=function(a){this._doAction("saveMacromolecule",{macromolecule:JSON.stringify(a)});};BiosaxsDataAdapter.prototype.saveBuffer=function(a){this._doAction("saveBuffer",{buffer:JSON.stringify(a)});};BiosaxsDataAdapter.prototype.saveSpecimen=function(b,a){this._doAction("saveSpecimen",{specimen:JSON.stringify(b),experimentId:a.json.experimentId});
};BiosaxsDataAdapter.prototype.saveMeasurement=function(b,a){this._doAction("saveMeasurement",{measurement:JSON.stringify(b),experimentId:a.json.experimentId});};BiosaxsDataAdapter.prototype.removeMeasurement=function(a){this._doAction("removeMeasurement",{measurementId:JSON.stringify(a)});};BiosaxsDataAdapter.prototype.savePlates=function(a,b){var c={plates:JSON.stringify(a)};
if(b!=null){c.experimentId=b;c.scope="MEDIUM";}this._doAction("savePlate",c);};BiosaxsDataAdapter.prototype.emptyPlate=function(b,a){this._doAction("emptyPlate",{scope:"MEDIUM",sampleplateId:b,experimentId:a});};BiosaxsDataAdapter.prototype.autoFillPlate=function(b,a){this._doAction("autoFillPlate",{scope:"MEDIUM",sampleplateId:b,experimentId:a});
};BiosaxsDataAdapter.prototype.createShipment=function(c,a,e,i,b,k,f,l,j,h,d){var g=this;$.ajax({type:this.type,url:"dataadapter.do?reqCode=saveShipment",data:{shippingId:c,name:a,status:e,comments:i,sendingLabContactId:b,returnLabContactId:k,returnCourier:f,courierAccount:l,BillingReference:j,dewarAvgCustomsValue:h,dewarAvgTransportValue:d},datatype:"text/json",success:function(m){g.onSuccess.notify(m);
},error:function(m){g.onError.notify(m.responseText);}});};BiosaxsDataAdapter.prototype.removeShipment=function(a){this._doAction("removeShipment",{shippingId:a});};BiosaxsDataAdapter.prototype.addCase=function(a){this._doAction("addCase",{shippingId:a});};BiosaxsDataAdapter.prototype.saveCase=function(a,b){b.sessionVO=null;
this._doAction("saveCase",{dewar:JSON.stringify(b),dewarId:b.dewarId,shippingId:a});};BiosaxsDataAdapter.prototype.removeCase=function(b,a){this._doAction("removeCase",{dewarId:b,shippingId:a});};BiosaxsDataAdapter.prototype.removeStockSolution=function(a){this._doAction("removeStockSolution",{stockSolutionId:a});
};BiosaxsDataAdapter.prototype.saveStockSolution=function(a){this._doAction("saveStockSolution",{stockSolution:JSON.stringify(a)});};function showError(a){a=JSON.parse(a);var b="Internal server error";var c=a.message;if(this.panel==null){this.panel=Ext.create("Ext.Window",{title:b,resizable:false,constrain:false,closable:true,padding:"15",items:[{xtype:"label",forId:"myFieldId",text:c,margin:"5 0 0 10"},{xtype:"textareafield",value:a.trace,fieldLabel:"Trace",width:600,height:300,margin:"20 0 0 10"}],width:680,height:400,buttonAlign:"right",listeners:{scope:this,minimize:function(){this.panel.hide();
},destroy:function(){delete this.panel;}}});this.panel.setLoading();}this.panel.show();}function showWarning(a){BUI.showWarning(a);}function Experiment(b){this.json=b;this.onSaved=new Event(this);this.onError=new Event(this);this.name=b.name;this.experimentId=b.experimentId;this.creationDate=b.creationDate;
this.onPlateSaved=new Event(this);this.bufferColors=$.extend({},BIOSAXS.proposal.bufferColors);this.specimenBuffersColors=this.getSpecimenColors();for(var a in this.bufferColors){this.bufferColors[a]="black";}this.setMacromoleculesColors();}Experiment.prototype.getSpecimenColorByBufferId=function(a){return this.specimenBuffersColors[a];
};Experiment.prototype.setMacromoleculesColors=function(){var a=["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494"];this.macromoleculeColors={};var b=this.getMacromolecules();for(var c=0;c<b.length;c++){this.macromoleculeColors[b[c].macromoleculeId]=a[c%a.length];}};Experiment.prototype.getHPLCMacromolecule=function(){var a=this.getDataCollections();
if(a.length>0){for(var d=0;d<1;d++){var c=a[d].measurementtodatacollection3VOs;if(c!=null){for(var b=0;b<c.length;b++){if(c[b].dataCollectionOrder==2){return this.getSampleById(this.getMeasurementById(c[b].measurementId).specimenId).macromolecule3VO;}}}}}};Experiment.prototype.getSpecimenColors=function(){var e=this.getSamples();
var b=[];for(var d=0;d<e.length;d++){if(e[d].macromolecule3VO===null){b.push(e[d]);}}var a={};var c=BIOSAXS.proposal.getBufferColors();for(d=0;d<b.length;d++){a[b[d].specimenId]=c[d%c.length];}return a;};Experiment.prototype.getBuffers=function(){var c=this.getSamples();var b={};var a=[];if(c!==null){for(var d=0;
d<c.length;d++){if(b[c[d].bufferId]===null){a.push(BIOSAXS.proposal.getBufferById(c[d].bufferId));b[c[d].bufferId]=true;}}}return a;};Experiment.prototype.getBufferById=function(a){return BIOSAXS.proposal.getBufferById(a);};Experiment.prototype.getStockSolutions=function(){return this.json.stockSolution3VOs;
};Experiment.prototype.getStockSolutionById=function(a){var c=this.getStockSolutions();for(var b=0;b<c.length;b++){if(c[b].stockSolutionId==a){return c[b];}}};Experiment.prototype.getMacromolecules=function(){var d=this.getSamples();var b={};var a=[];for(var c=0;c<d.length;c++){if(d[c].macromolecule3VO!=null){if(b[d[c].macromolecule3VO.macromoleculeId]==null){a.push(d[c].macromolecule3VO);
b[d[c].macromolecule3VO.macromoleculeId]=true;}}}return a;};Experiment.prototype.getMeasurementsWithSubtractionAssociated=function(){var c=this.getMeasurements();var b=[];for(var a=0;a<c.length;a++){var d=c[a];if(d.run3VO!==null){b.push(d);}}return b;};Experiment.prototype.getSamples=function(){return this.json.samples3VOs;
};Experiment.prototype.getSampleById=function(a){return this.getSpecimenById(a);};Experiment.prototype.getSpecimenById=function(a){var b=this.getSamples();for(var c=0;c<b.length;c++){if(b[c].specimenId==a){return b[c];}}return null;};Experiment.prototype.getSpecimenByDataCollectionId=function(f){var c=this.getDataCollectionById(f);
var a={};var d=[];for(var b=0;b<c.measurementtodatacollection3VOs.length;b++){var e=this.getMeasurementById(c.measurementtodatacollection3VOs[b].measurementId);if(a[e.specimenId]==null){d.push(e);a[e.specimenId]=true;}}return d;};Experiment.prototype.setSpecimenById=function(b){for(var a=0;a<this.json.samples3VOs.length;
a++){if(this.json.samples3VOs[a].specimenId==b.specimenId){this.json.samples3VOs[a]=b;return;}}console.log("Specimen with id: "+b.specimenId+" not found");};Experiment.prototype.setMeasurement=function(c){var a=this.getMeasurements();for(var b=0;b<a.length;b++){if(a[b].measurementId==c.measurementId){a[b]=c;
return;}}};Experiment.prototype.getConcentrations=function(){var e={};var c=this.getMeasurements();for(var b=0;b<c.length;b++){if(c[b].concentration!=null){e[c[b].concentration]=[c[b].concentration];}}var a=[];for(var d in e){if(d!="null"){a.push(d);}}return a;};Experiment.prototype.getConcentrationsBysample=function(e){var f={};
var b=this.getSamples();for(var c=0;c<b.length;c++){if(b[c].macromolecule3VO!=null){if(b[c].macromolecule3VO.macromoleculeId==e.macromolecule3VO.macromoleculeId){if(b[c].concentration!=null){f[b[c].concentration]=[b[c].concentration];}}}}var a=[];for(var d in f){if(d!="null"){a.push(d);}}return a;};Experiment.prototype.setSpecimen=function(f){var b=this.getBuffers();
for(var d=0;d<b.length;d++){var a=b[d];for(var c=0;c<a.specimen3VOs.length;c++){var e=a.specimen3VOs[c];if(e.specimenId==f.specimenId){a.specimen3VOs[c]=f;return a;}}}};Experiment.prototype.getSamplePlates=function(){return this.json.samplePlate3VOs;};Experiment.prototype.getSamplePlateById=function(c){var a=this.getSamplePlates();
for(var b=0;b<a.length;b++){if(a[b].samplePlateId==c){return a[b];}}};Experiment.prototype.getSamplePlateBySlotPositionColumn=function(c){var a=this.getSamplePlates();for(var b=0;b<a.length;b++){if(a[b].slotPositionColumn==c){return a[b];}}};Experiment.prototype.getSpecimenByPosition=function(c,a,b){return this.getSampleByPosition();
};Experiment.prototype.getSpecimensBySamplePlateId=function(c){var d=this.getSamples();var a=[];for(var b=0;b<d.length;b++){if(d[b].sampleplateposition3VO!=null){if(d[b].sampleplateposition3VO.samplePlateId==c){a.push(d[b]);}}}return a;};Experiment.prototype.getSampleByPosition=function(e,b,c){var f=this.getSamples();
var a=[];for(var d=0;d<f.length;d++){if(f[d].sampleplateposition3VO!=null){if((f[d].sampleplateposition3VO.samplePlateId==e)&&(f[d].sampleplateposition3VO.rowNumber==b)&&(f[d].sampleplateposition3VO.columnNumber==c)){a.push(f[d]);}}}return a;};Experiment.prototype.getPlateGroups=function(){var a=this.getSamplePlates();
var d=[];var c={};for(var b=0;b<a.length;b++){if(a[b].plategroup3VO!=null){var e=a[b].plategroup3VO.plateGroupId;if(c[e]==null){d.push(a[b].plategroup3VO);c[e]=true;}}}return d;};Experiment.prototype.getPlatesByPlateGroupId=function(c){var b=this.getSamplePlates();var a=[];for(var d=0;d<b.length;d++){if(b[d].plategroup3VO!=null){if(b[d].plategroup3VO.plateGroupId==c){a.push(b[d]);
}}}return a;};Experiment.prototype.getMeasurements=function(){var e=[];var b=this.getSamples();if(b==null){return[];}for(var c=0;c<b.length;c++){var d=b[c];for(var a=0;a<d.measurements.length;a++){e.push(d.measurements[a]);}}return e;};Experiment.prototype.getMeasurementById=function(b){var c=this.getMeasurements();
for(var a=0;a<c.length;a++){if(c[a].measurementId==b){return c[a];}}return null;};Experiment.prototype.getMeasurementByDataCollectionId=function(d){var a=[];var b=this.getDataCollectionById(d);for(var c=0;c<b.measurementtodatacollection3VOs.length;c++){a.push(this.getMeasurementById(b.measurementtodatacollection3VOs[c].measurementId));
}return a;};Experiment.prototype.getDataCollections=function(){var a=this.json.dataCollections;var b=[];for(var c=0;c<a.length;c++){if(a[c].measurementtodatacollection3VOs.length!=0){b.push(a[c]);}}return b;};Experiment.prototype.getDataCollectionsBySpecimenId=function(d){var c=this.getMeasurementsBySpecimenId(d);
var a=[];var g={};for(var f=0;f<c.length;f++){var h=c[f];var b=this.getDataCollectionByMeasurementId(h.measurementId);for(var e=0;e<b.length;e++){if(g[b[e].dataCollectionId]==null){g[b[e].dataCollectionId]=true;a.push(b[e]);}}}return a;};Experiment.prototype.getMeasurementsBySpecimenId=function(c){var b=this.getMeasurements();
var a=[];for(var d=0;d<b.length;d++){if(b[d].specimenId==c){a.push(b[d]);}}return a;};Experiment.prototype.getDataCollectionByMeasurementId=function(f){var b=this.getDataCollections();var a=[];function d(i,h){return i.dataCollectionOrder-h.dataCollectionOrder;}for(var e=0;e<b.length;e++){if(b[e].measurementtodatacollection3VOs.length!=0){for(var c=0;
c<b[e].measurementtodatacollection3VOs.length;c++){var g=b[e].measurementtodatacollection3VOs[c];if(g.measurementId==f){b[e].measurementtodatacollection3VOs.sort(d);a.push(b[e]);}}}}return a;};Experiment.prototype.getSubtractionById=function(b){var a=this.getDataCollections();for(var d=0;d<a.length;d++){if(a[d].substraction3VOs!=null){if(a[d].substraction3VOs.length>0){for(var c=0;
c<a[d].substraction3VOs.length;c++){if(a[d].substraction3VOs[c].subtractionId==b){return a[d].substraction3VOs[c];}}}}}return null;};Experiment.prototype.getDataCollectionById=function(c){var a=this.json.dataCollections;for(var b=0;b<a.length;b++){if(a[b].dataCollectionId==c){return a[b];}}};Experiment.prototype.getVolumeToLoadBySampleId=function(b){var d=this.getSpecimenById(b);
if(d!=null){var a=0;for(var c=0;c<d.measurements.length;c++){a=a+Number(d.measurements[c].volumeToLoad);}return a;}};function ExperimentList(b){this.experiments=b;this.macromoleculeColors={};for(var a=0;a<b.length;a++){this.macromoleculeColors=$.extend({},this.macromoleculeColors,b[a].macromoleculeColors);
}}ExperimentList.prototype.getSpecimenColorByBufferId=function(d){for(var c=0;c<this.experiments.length;c++){var a=this.experiments[c];var b=a.getSpecimenColorByBufferId(d);if(b!=null){return b;}}return"black";};ExperimentList.prototype.getColorByMacromoleculeId=function(d){for(var c=0;c<this.experiments.length;
c++){var a=this.experiments[c];var b=a.getColorByMacromoleculeId(d);if(b!=null){return b;}}return"black";};ExperimentList.prototype.getMeasurements=function(){var a=[];for(var e=0;e<this.experiments.length;e++){var c=this.experiments[e];var b=c.getMeasurements();for(var d=0;d<b.length;d++){a.push(b[d]);
}}return a;};ExperimentList.prototype.getMeasurementByDataCollectionId=function(c){for(var b=0;b<this.experiments.length;b++){var a=this.experiments[b].getMeasurementByDataCollectionId(c);if(a.length!=0){return a;}}return[];};ExperimentList.prototype.getMergesByMeasurements=function(a){var d=[];for(var c=0;
c<a.length;c++){if(a[c].merge3VOs!=null){for(var b=0;b<a[c].merge3VOs.length;b++){d.push(a[c].merge3VOs[b]);}}}return d;};ExperimentList.prototype.getSamplePlateById=function(b){for(var a=0;a<this.experiments.length;a++){var c=this.experiments[a].getSamplePlateById(b);if(c!=null){return c;}}return null;
};ExperimentList.prototype.getMergesByDataCollectionId=function(a){return this.getMergesByMeasurements(this.getMeasurementByDataCollectionId(a));};ExperimentList.prototype.getMerges=function(){return this.getMergesByMeasurements(this.getMeasurements());};ExperimentList.prototype.getDataCollectionById=function(e){var a=[];
for(var d=0;d<this.experiments.length;d++){var c=this.experiments[d];var b=c.getDataCollectionById(e);if(b!=null){return b;}}return a;};ExperimentList.prototype.getDataCollectionByMeasurementId=function(d){for(var c=0;c<this.experiments.length;c++){var b=this.experiments[c];var a=b.getDataCollectionByMeasurementId(d);
if(a!=null){return a;}}return null;};ExperimentList.prototype.getMeasurementsNotCollected=function(){var a=[];for(var e=0;e<this.experiments.length;e++){var c=this.experiments[e];var b=c.getMeasurements();for(var d=0;d<b.length;d++){if(b[d].run3VO==null){a.push(b[d]);}}}return a;};ExperimentList.prototype.getMeasurementsCollected=function(){var a=[];
for(var e=0;e<this.experiments.length;e++){var c=this.experiments[e];var b=c.getMeasurements();for(var d=0;d<b.length;d++){if(b[d].run3VO!=null){a.push(b[d]);}}}return a;};ExperimentList.prototype.getMeasurementById=function(a){for(var b=0;b<this.experiments.length;b++){var c=this.experiments[b].getMeasurementById(a);
if(c!=null){return c;}}return null;};ExperimentList.prototype.getBufferById=function(c){for(var b=0;b<this.experiments.length;b++){var a=this.experiments[b].getBufferById(c);if(a!=null){return a;}}return null;};ExperimentList.prototype.getSampleById=function(a){for(var b=0;b<this.experiments.length;b++){var c=this.experiments[b].getSampleById(a);
if(c!=null){return c;}}return null;};ExperimentList.prototype.getSamplesByCondition=function(f,e){var a=[];for(var d=0;d<this.experiments.length;d++){var c=this.experiments[d].getSamples();for(var b=0;b<c.length;b++){if(c[b].macromolecule3VO!=null){if(c[b].macromolecule3VO.macromoleculeId==f){if(c[b].bufferId==e){a.push(c[b]);
}}}}}return a;};ExperimentList.prototype.getFrames=function(c){var e=[];for(var b=0;b<c.length;b++){var f=c[b];if(f.framelist3VO!=null){if(f.framelist3VO.frametolist3VOs!=null){for(var a=0;a<f.framelist3VO.frametolist3VOs.length;a++){var d=f.framelist3VO.frametolist3VOs[a].frame3VO;if(d!=null){e.push(d);
}}}}}return e;};function Proposal(a){this.macromolecules=null;this.onDataRetrieved=new Event(this);this.onError=new Event(this);this.onInitialized=new Event(this);this.buffers=null;this.macromolecules=null;this.stockSolutions=null;this.plateTypes=null;this._colors=null;this.bufferColors={};this.macromoleculeColors={};
if(a!=undefined){this.setItems(a);}this.flavour="ESRF";}Proposal.prototype.getAdditiveTypes=function(){return[["",""],["LIPID","LIPID"],["SALT","SALT"],["DETERGENT","DETERGENT"],["LIGAND","LIGAND"],["OTHER","OTHER"]];};Proposal.prototype.getBufferById=function(c){var a=this.getBuffers();for(var b=0;b<a.length;
b++){if(a[b].bufferId==c){return a[b];}}};Proposal.prototype.getShipmentByDewarId=function(c){var d=this.getShipments();for(var b=0;b<d.length;b++){for(var a=0;a<d[b].dewarVOs.length;a++){if(d[b].dewarVOs[a].dewarId==c){return d[b];}}}return null;};Proposal.prototype.getAssemblies=function(){return this.assemblies;
};Proposal.prototype.getStockSolutions=function(){return this.stockSolutions;};Proposal.prototype.getSessions=function(){return this._data.sessions;};Proposal.prototype.getUnpackedStockSolutions=function(){var c=this.getStockSolutions();var a=[];for(var b=0;b<c.length;b++){if(c[b].boxId==null){a.push(c[b]);
}}return a;};Proposal.prototype.getStockSolutionsByDewarId=function(d){var c=this.getStockSolutions();var a=[];for(var b=0;b<c.length;b++){if(c[b].boxId==d){a.push(c[b]);}}return a;};Proposal.prototype.sortByName=function(d,c){if(d.acronym<c.acronym){return -1;}if(d.acronym>c.acronym){return 1;}return 0;
};Proposal.prototype.setMacromolecules=function(a){this.macromolecules=a;this.setColors();};Proposal.prototype._getColors=function(){if(this._colors==null){var a=[];var c=8;for(var b=0;b<c;b++){a.push(BUI.rainbow(c,b));}this._colors=a;}return this._colors;};Proposal.prototype.getMacromoleculeColors=function(){return this._getColors().slice(0,3);
};Proposal.prototype.getBufferColors=function(){return["#ffffcc","#c7e9b4","#7fcdbb","#41b6c4","#2c7fb8","#253494"];};Proposal.prototype.setColors=function(){var d=this.macromolecules.sort(this.sortByName);var c=[];var g=16;for(var e=0;e<g;e++){c.push(BUI.rainbow(g,e));}var h=this.getMacromoleculeColors();
var a=this.getBufferColors();var f=0;for(e=0;e<d.length;e++){this.macromoleculeColors[d[e].macromoleculeId]=h[e%h.length];f++;}var b=this.getBuffers().sort(this.sortByName);f=0;if(b!=null){for(e=0;e<b.length;e++){this.bufferColors[b[e].bufferId]=a[e%a.length];f++;}}};Proposal.prototype.getBuffers=function(){return this.buffers;
};Proposal.prototype.getLabcontacts=function(){return this.labcontacts;};Proposal.prototype.getShipments=function(){return this.shippings;};Proposal.prototype.getShipmentById=function(b){var c=this.getShipments();for(var a=0;a<c.length;a++){if(c[a].shippingId==b){return c[a];}}};Proposal.prototype.getPlateTypes=function(){return this.plateTypes;
};Proposal.prototype.getPlateByFlavour=function(){if(this.flavour=="ESRF"){return[this.plateTypes[0],this.plateTypes[2],this.plateTypes[3]];}};Proposal.prototype.getPlateTypeById=function(a){var c=this.getPlateTypes();for(var b=0;b<c.length;b++){if(c[b].plateTypeId==a){return c[b];}}return null;};Proposal.prototype.getSafetyLevels=function(){var a=[];
a.push({safetyLevelId:"",name:"UNKNOWN"});a.push({safetyLevelId:1,name:"GREEN"});a.push({safetyLevelId:2,name:"YELLOW"});a.push({safetyLevelId:3,name:"RED"});return a;};Proposal.prototype.setItems=function(a){this._data=a;this.assemblies=a.assemblies;this.macromolecules=a.macromolecules;this.buffers=a.buffers;
this.stockSolutions=a.stockSolutions;this.labcontacts=a.labcontacts;this.shippings=a.shippings;this.plateTypes=a.plateTypes;this.setColors();};Proposal.prototype.init=function(b){var c=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(d,e){c.setItems(e);c.onInitialized.notify();});a.getProposal(b);
};Proposal.prototype.getMacromoleculeById=function(b){for(var a=0;a<this.macromolecules.length;a++){if(this.macromolecules[a].macromoleculeId==b){return this.macromolecules[a];}}return null;};Proposal.prototype.getStockSolutionById=function(a){for(var b=0;b<this.stockSolutions.length;b++){if(this.stockSolutions[b].stockSolutionId==a){return this.stockSolutions[b];
}}return null;};Proposal.prototype.getStockSolutionsBySpecimen=function(d,c){var a=[];for(var b=0;b<this.stockSolutions.length;b++){if(this.stockSolutions[b].macromoleculeId==d){if(this.stockSolutions[b].bufferId==c){a.push(this.stockSolutions[b]);}}}return a;};Proposal.prototype.getMacromolecules=function(){return this.macromolecules;
};Proposal.prototype.getSafetyLabelName=function(c){var a=this.getSafetyLevels();for(var b=0;b<a.length;b++){if(a[b].safetyLevelId==c){return a[b].name;}}return"UNKNOWN";};Proposal.prototype.getPlatesByProposal=function(){var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(f,g){var e=[];
for(var d=0;d<g.length;d++){e.push(new Experiment(g[d]));}g=[];for(d=0;d<e.length;d++){var h=e[d].getSamplePlates();for(var c=0;c<h.length;c++){g.push(h[c]);}}b.onDataRetrieved.notify(g);});a.getExperimentsByProposalId("MEDIUM");};Proposal.prototype.getLabContactsByProposalId=function(){var b=this;var a=new BiosaxsDataAdapter();
a.onLabContactsRetrieved.attach(function(c,d){b.onDataRetrieved.notify(d);});a.onError.attach(function(d,c){b.onError.notify(c);});a.getLabContactsByProposalId();};function Shipment(a){this.json=a;this.onSaved=new Event(this);this.onError=new Event(this);}Shipment.prototype.getDewars=function(){return this.json.dewarVOs;
};Shipment.prototype.getDewars=function(){return this.json.dewarVOs;};Shipment.prototype.removeCase=function(b){var c=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(e,d){c.onSaved.notify(d);});a.onError.attach(function(e,d){c.onError.notify(d);});a.removeCase(b,this.json.shippingId);
};var tabs;Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.QuickTips.init();var BIOSAXS={updateCount:0,proposal:new Proposal(),getBeans:function(){return BIOSAXS_BEANS;},welcome:function(a){this.fetchWelcome();},start:function(c){var b=b||{"log":function(){}};
this.targetId=c;var e=this;Ext.require(["Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*","Ext.form.*","Ext.tab.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.layout.container.Column","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.util.*","Ext.form.*","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.ux.data.PagingMemoryProxy","Ext.toolbar.Paging","Ext.ux.SlidingPager","Ext.form.Panel","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.ux.ajax.JsonSimlet","Ext.ux.ajax.SimManager","Ext.tip.QuickTipManager","Ext.layout.*","Ext.form.Label","Ext.selection.*","Ext.tab.Panel","Ext.tree.*","Ext.ux.LiveSearchGridPanel"]);
BIOSAXS.proposal.onInitialized=new Event();if(Ext.urlDecode(window.location.href).menu){if(Ext.urlDecode(window.location.href).menu=="stocksolutions"){this.showStockSolutionsGrid(c);}if(Ext.urlDecode(window.location.href).menu=="results"){this.showResults(c);}if(Ext.urlDecode(window.location.href).menu=="macromolecule"){if((Ext.urlDecode(window.location.href).macromoleculeId!=null)||(Ext.urlDecode(window.location.href).search)){this.showMacromolecule(c,Ext.urlDecode(window.location.href).macromoleculeId);
}}if(Ext.urlDecode(window.location.href).menu=="prepareexperiment"){new PrepareExperimentWidget().draw(this.targetId);}if(Ext.urlDecode(window.location.href).menu=="macromolecules"){this.showMacromoleculesGrid(c);}if(Ext.urlDecode(window.location.href).menu=="buffers"){this.showBuffersGrid(c);}if(Ext.urlDecode(window.location.href).menu=="templates"){this.showTemplateGrid(c);
}if(Ext.urlDecode(window.location.href).menu=="platescheme"){this.showPlateScheme(c);}if(Ext.urlDecode(window.location.href).menu=="plates"){this.showPlatesGrid(c);}if(Ext.urlDecode(window.location.href).menu=="datacollection"){this.showDataCollection(c);}if(Ext.urlDecode(window.location.href).menu=="PDBVisualizer"){if(Ext.urlDecode(window.location.href).modelId!=null){var a=new BiosaxsDataAdapter();
a.onSuccess.attach(function(h,j){if(j!=null){for(var g=0;g<j.length;g++){if(j[g].subtractionId==Ext.urlDecode(window.location.href).subtractionId){var k=Ext.urlDecode(window.location.href).modelId;var f=new DataCollectionPDBWidget({width:Ext.getBody().getWidth()-200,height:600,title:"Damaver"});f.draw(j[g],c);
}}}});a.getAnalysisInformationByExperimentId(Ext.urlDecode(window.location.href).experimentId);}}if(Ext.urlDecode(window.location.href).menu=="design"){var d=new WizardWidget({windowMode:true});d.onFinished.attach(function(h,f){var g=new BiosaxsDataAdapter();g.onSuccess.attach(function(j,k){var i=new Experiment(k);
e.openExperimentByExperiment(i);});g.createTemplate(f.name,"comments",f.data);});d.draw(this.targetId,new ExperimentTypeWizardForm());}if(Ext.urlDecode(window.location.href).menu=="list_shipment"){new ShippingWidget().draw(this.targetId);}if(Ext.urlDecode(window.location.href).menu=="shipments"){this.openShipments(c);
}if(Ext.urlDecode(window.location.href).menu=="shipment"){this.openShipmentById(c);}if(Ext.urlDecode(window.location.href).menu=="show_datacollection"){this.showCreateDataCollectionList(c);}if(Ext.urlDecode(window.location.href).menu=="runs"){this.showRuns(c);}if(Ext.urlDecode(window.location.href).menu=="samplechanger"){this.showExperiments(c,"STATIC");
}if(Ext.urlDecode(window.location.href).menu=="hplc"){this.showExperiments(c,"HPLC");}if(Ext.urlDecode(window.location.href).menu=="queue"){this.showQueue(c);}if(Ext.urlDecode(window.location.href).menu=="calibration"){this.showExperiments(c,"CALIBRATION");}}else{if(Ext.urlDecode(window.location.href).experimentId!=null){this.openExperiment(Ext.urlDecode(window.location.href).experimentId);
}else{this.showExperiments(c);}}},showDataCollection:function(b){var a=Ext.create("Ext.panel.Panel",{plain:true,frame:false,width:1000,border:0,renderTo:b,style:{padding:10},items:[]});BIOSAXS.proposal.onInitialized.attach(function(){var d=new BiosaxsDataAdapter();d.onSuccess.attach(function(e,f){var g=new DataCollectionWidget();
BIOSAXS.proposal.onInitialized=new Event(BIOSAXS.proposal);a.add(g.getPanel(f));});var c=Ext.urlDecode(window.location.href).subtractionId;d.getCompactAnalysisBySubtractionId(c);});BIOSAXS.proposal.init();},showQueue:function(a){var c=this;var b=new QueueGrid();b.getPanel([]).render(a);b.grid.setLoading();
BIOSAXS.proposal.onInitialized.attach(function(){function e(){var f=new BiosaxsDataAdapter();f.onSuccess.attach(function(g,h){b.grid.setLoading("Updating");b.refresh(h);b.grid.setLoading(false);BIOSAXS.updateCount=BIOSAXS.updateCount+1;window.clearInterval(d);d=setInterval(function(){e();},BUI.getUpdateInterval());
});f.getCompactAnalysisByProposalId(b.limit);}var d=setInterval(function(){e();},BUI.getUpdateInterval());e();});BIOSAXS.proposal.init();},showPlateScheme:function(a){var b=this;new SchemeReport().draw(a,Ext.urlDecode(window.location.href).experimentId);},fetchWelcome:function(){BIOSAXS.proposal.onInitialized.attach(function(){if(BIOSAXS.proposal!=null){document.getElementById("macromolecule_panel").innerHTML="NA";
document.getElementById("buffer_panel").innerHTML="NA";document.getElementById("stocksolution_panel").innerHTML="NA";document.getElementById("shipment_panel").innerHTML="NA";if(BIOSAXS.proposal.getMacromolecules()!=null){document.getElementById("macromolecule_panel").innerHTML=BIOSAXS.proposal.getMacromolecules().length;
}if(BIOSAXS.proposal.getBuffers()!=null){document.getElementById("buffer_panel").innerHTML=BIOSAXS.proposal.getBuffers().length;}if(BIOSAXS.proposal.getStockSolutions()!=null){document.getElementById("stocksolution_panel").innerHTML=BIOSAXS.proposal.getStockSolutions().length;}if(BIOSAXS.proposal.getShipments()!=null){document.getElementById("shipment_panel").innerHTML=BIOSAXS.proposal.getShipments().length;
}}});BIOSAXS.proposal.init();var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(c,d){var e=0;if(d!=null){for(var b=0;b<d.length;b++){if(d[b].experimentType!=null){if(d[b].experimentType=="TEMPLATE"){e++;}}}}document.getElementById("experiment_panel").innerHTML=e;});a.getExperimentInformationByProposalId();
},showMacromoleculesGrid:function(a){BIOSAXS.proposal.onInitialized.attach(function(){var c=new MacromoleculeGrid({width:900,collapsed:false,searchBar:true,tbar:true,height:700}).getPanel(BIOSAXS.proposal.getMacromolecules());var b=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,height:710,width:900,renderTo:a,style:{padding:0},items:[c]});
});BIOSAXS.proposal.init();},showBuffersGrid:function(a){BIOSAXS.proposal.onInitialized.attach(function(c){var b=new BufferGrid({height:700,searchBar:true,tbar:true});this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:725,border:0,renderTo:a,style:{padding:10},items:[b.getPanel(BIOSAXS.proposal.getBuffers())]});
});BIOSAXS.proposal.init();},showTemplateGrid:function(a){BIOSAXS.proposal.onInitialized.attach(function(d){var e=this;var c=new TemplateGrid({height:700,gridType:"Ext.grid.Panel",title:"Experiments",grouping:false,tbar:true});this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:725,border:0,renderTo:a,style:{padding:10},items:[c.getPanel([])]});
var b=new BiosaxsDataAdapter();b.onSuccess.attach(function(f,g){c.refresh(g);e.panel.setLoading(false);});this.panel.setLoading("ISPyB: Retrieving Templates");b.getExperimentInformationByProposalId();});BIOSAXS.proposal.init();},showMacromolecule:function(a,b){BIOSAXS.proposal.onInitialized.attach(function(){var c=null;
if(Ext.urlDecode(window.location.href).search!=null){c=new BiosaxsDataAdapter();c.onSuccess.attach(function(d,e){new ResultTabs().draw(a,e,b);});c._getInformationByMacromoleculeId(JSON.parse(Ext.urlDecode(window.location.href).search.replace(new RegExp("'","g"),'"')));}else{c=new BiosaxsDataAdapter();
c.onSuccess.attach(function(d,e){new ResultTabs().draw(a,e,b);});c.getInformationByMacromoleculeId(b,Ext.urlDecode(window.location.href).bufferId);}});BIOSAXS.proposal.init();},showResults:function(c){var d=this;var b={height:600,searchBar:false,tbar:false,btnResultVisible:true,width:Ext.getBody().getWidth()-250};
var a=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:725,width:Ext.getBody().getWidth()-200,border:0,renderTo:c,padding:10,items:[]});a.setLoading("ISPyB: Getting information");BIOSAXS.proposal.onInitialized.attach(function(f){var e=new BiosaxsDataAdapter();e.onSuccess.attach(function(h,i){var g=new ResultsAssemblyGrid(b);
a.insert(0,g.getPanel(i));a.setLoading(false);});e.onError.attach(function(g,h){alert("There was an error");a.setLoading(false);});e.getAnalysisByProposalId();});BIOSAXS.proposal.init();},showRuns:function(c){var b=[];var e=new FramesetGrid({height:400});var d=e.getGrid([]);var a=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,height:565,renderTo:c,style:{padding:0},items:[d]});
d.setLoading("ISPyB: getting RUNS");var f=new BiosaxsDataAdapter();f.onRunsRetrieved.attach(function(g,h){e.refresh(h);d.setLoading(false);});f.getAllRuns();},openShipmentById:function(a){var b=this;BIOSAXS.proposal.onInitialized=new Event();BIOSAXS.proposal.onInitialized.attach(function(e){var c=Ext.urlDecode(window.location.href).shippingId;
for(var d=0;d<BIOSAXS.proposal.getShipments().length;d++){if(BIOSAXS.proposal.getShipments()[d].shippingId==c){b.showShipmentTabs(BIOSAXS.proposal.getShipments()[d],a);}}});BIOSAXS.proposal.init();},openShipments:function(a){var c=this;var b=new ShipmentGrid({height:700,title:"Shipments",minHeight:700});
this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:725,border:0,renderTo:a,style:{padding:10},items:[b.getPanel([])]});BIOSAXS.proposal.onInitialized=new Event();BIOSAXS.proposal.onInitialized.attach(function(d){b.refresh(BIOSAXS.proposal.getShipments());c.panel.setLoading(false);
});this.panel.setLoading("ISPyB: Retrieving shipments");BIOSAXS.proposal.init();},showShipmentTabs:function(e,c){BIOSAXS.proposal.onInitialized=new Event();document.getElementById(c).innerHTML="";var d=new ShipmentTabs(c);var b=d.getPanel(new Shipment(e));var a=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,height:900,renderTo:c,style:{padding:0},items:b});
},showExperiments:function(c,b){var e=this;var a=[];this.experimentGrid=new ExperimentGrid({width:"96%",tbar:true,filtered:b,sessionId:Ext.urlDecode(window.location.href).sessionId});var d=this.experimentGrid.getPanel([]);this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,resizable:true,border:0,renderTo:c,style:{padding:0},items:[d]});
d.setLoading("ISPyB: Retrieving Experiments");this.proposal.onInitialized.attach(function(g){var f=new BiosaxsDataAdapter();f.onSuccess.attach(function(j,k){if(k.length===0){e.panel.insert(0,{border:0,padding:0,html:BUI.getWarningHTML("No experiments found for this proposal. Go to menu Prepare Experiment -> Experiment -> Create")+"<br/>"});
}e.experimentGrid.refresh(k);d.setLoading(false);function i(){var l=new BiosaxsDataAdapter();l.onSuccess.attach(function(m,n){d.setLoading("Updating");e.experimentGrid.refresh(n);d.setLoading(false);BIOSAXS.updateCount=BIOSAXS.updateCount+1;window.clearInterval(h);h=setInterval(function(){i();},BUI.getUpdateInterval());
});l.getExperimentInformationByProposalId(Ext.urlDecode(window.location.href).sessionId);}var h=setInterval(function(){i();},BUI.getUpdateInterval());});f.getExperimentInformationByProposalId(Ext.urlDecode(window.location.href).sessionId);});this.proposal.init(Ext.urlDecode(window.location.href).sessionId);
},showPlatesGrid:function(a){var b=new BiosaxsDataAdapter();b.onExperimentByProposalRetrieved.attach(function(c,h){var g=[];var f=null;for(f=0;f<h.length;f++){g.push(new Experiment(h[f]));}h=[];for(f=0;f<g.length;f++){var k=g[f].getSamplePlates();for(var e=0;e<k.length;e++){h.push(k[e]);}}var d=[];if(h.length===0){d.push({border:0,html:BUI.getWarningHTML("No plates found. Go into the experiment and go to tab Plates and click on add to create a new one")});
}d.push(new PlatesMacromoleculesGrid({height:400}).getGrid(g));this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,height:550,renderTo:a,style:{padding:10},items:d});});b.getExperimentsByProposalId();},showStockSolutionsGrid:function(a){var b=this;BIOSAXS.proposal.onInitialized.attach(function(e){var d=new StockSolutionGrid({height:700,searchBar:false,tbar:true});
b.test=d;var c=[];c.push(d.getPanel(BIOSAXS.proposal.getStockSolutions()));this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:725,border:0,renderTo:a,style:{padding:10},items:c});});BIOSAXS.proposal.init();},openExperiment:function(a){var c=this;if(this.panel==null){this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:725,border:0,renderTo:this.targetId,style:{padding:10},items:[]});
}this.panel.setLoading("Retrieving Experiment");if(BIOSAXS.proposal.macromolecules==null){BIOSAXS.proposal.onInitialized.attach(function(d){if(a==null){a=Ext.urlDecode(window.location.href).experimentId;}var e=new BiosaxsDataAdapter();e.onSuccess.attach(function(f,g){c.panel.setLoading(false);c.openExperimentByExperiment(new Experiment(g));
});e.getExperimentById(a,"MEDIUM");});BIOSAXS.proposal.init(Ext.urlDecode(window.location.href).sessionId);}else{var b=new BiosaxsDataAdapter();b.onSuccess.attach(function(d,e){c.panel.setLoading(false);c.openExperimentByExperiment(new Experiment(e));});b.getExperimentById(a,"MEDIUM");}},openExperimentByExperiment:function(a){document.getElementById("mainPanel").innerHTML="";
if((a.json.type=="STATIC")||(a.json.type=="CALIBRATION")){tabs=new ExperimentTabs("mainPanel");}else{if(a.json.type=="HPLC"){tabs=new HPLCTabs("mainPanel");}else{tabs=new TemplateTabs("mainPanel");}}tabs.draw(a);}};function openExperiment(a){BIOSAXS.openExperiment(a);}function BufferForm(){var a=this;
this.additiveGrid=new AdditiveGrid();this.additiveGrid.onRemoveButtonClicked.attach(function(c,b){a.onRemoveAdditive.notify(b);});this.onSaved=new Event(this);this.onRemoveAdditive=new Event(this);}BufferForm.prototype.getBuffer=function(){this.buffer.name=Ext.getCmp("buffer_name").getValue();this.buffer.acronym=Ext.getCmp("buffer_acronym").getValue();
this.buffer.comments=Ext.getCmp("buffer_comments").getValue();this.buffer.ph=Ext.getCmp("buffer_ph").getValue();this.buffer.composition=Ext.getCmp("buffer_composition").getValue();this.buffer.bufferhasadditive3VOs=this.additiveGrid.getAdditives();return this.buffer;};BufferForm.prototype._getTopPanel=function(){return{xtype:"container",layout:"hbox",border:0,frame:true,items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"textfield",items:[{xtype:"requiredtext",id:"buffer_name",fieldLabel:"Name",name:"name",width:"200px",value:this.buffer.name},{xtype:"requiredtext",id:"buffer_acronym",fieldLabel:"Acronym",name:"acronym",width:"200px",value:this.buffer.acronym}]}]},{xtype:"container",flex:1,layout:"anchor",defaultType:"textfield",margin:"0 0 0 10",items:[{id:"buffer_ph",fieldLabel:"pH",name:"ph",value:this.buffer.ph,xtype:"numberfield",width:200,minValue:0,maxValue:15},{xtype:"requiredtext",id:"buffer_composition",fieldLabel:"Composition",name:"composition",width:200,value:this.buffer.composition}]}]};
};BufferForm.prototype.getPanel=function(a){this.buffer=a;this.panel=Ext.createWidget({xtype:"container",layout:"vbox",style:{padding:"10px"},fieldDefaults:{labelAlign:"left",labelWidth:50},items:[this._getTopPanel(),{id:"buffer_comments",xtype:"textareafield",name:"comments",fieldLabel:"Comments",width:"100%",value:a.comments},this.additiveGrid.getPanel(a)]});
return this.panel;};BufferForm.prototype.input=function(){return{buffer:{"bufferId":422,"proposalId":10,"safetyLevelId":null,"name":"B1","acronym":"B1","ph":null,"composition":null,"bufferhasadditive3VOs":[],"comments":null}};};BufferForm.prototype.test=function(c){var b=new BufferForm();var a=b.getPanel(b.input().buffer);
a.render(c);};function CaseForm(a){this.width=700;this.showTitle=true;if(a!=null){if(a.showTitle!=null){this.showTitle=a.showTitle;}}var b=this;this.stockSolutionGrid=new StockSolutionGrid({width:this.width-10,minHeight:300,height:300,tbar:true,showTitle:true,isPackedVisible:false,btnAddExisting:true,btnRemoveVisible:false,btnUnpackVisible:true});
this.stockSolutionGrid.onStockSolutionSelected.attach(function(d,e){if(e!=null){for(var c=0;c<e.length;c++){b.saveStockSolution(e[c]);}}});this.stockSolutionGrid.onProposalChanged.attach(function(d,c){if(c!=null){b.saveStockSolution(c);}else{BIOSAXS.proposal.onInitialized.attach(function(){b.stockSolutionGrid.refresh(BIOSAXS.proposal.getStockSolutionsByDewarId(b.dewar.dewarId));
b.stockSolutionGrid.grid.setLoading(false);});BIOSAXS.proposal.init();}});this.onSaved=new Event(this);this.onAddPlates=new Event(this);this.onRemovePlates=new Event(this);}CaseForm.prototype.saveStockSolution=function(b){var c=this;var a=new BiosaxsDataAdapter();this.stockSolutionGrid.grid.setLoading("ISPyB: setting case to Stock solution");
a.onSuccess.attach(function(e,d){BIOSAXS.proposal.onInitialized.attach(function(){c.stockSolutionGrid.refresh(BIOSAXS.proposal.getStockSolutionsByDewarId(c.dewar.dewarId));c.stockSolutionGrid.grid.setLoading(false);});BIOSAXS.proposal.init();});a.onError.attach(function(d,e){c.stockSolutionGrid.grid.setLoading(false);
BUI.showError(e);});b.boxId=c.dewar.dewarId;a.saveStockSolution(b);};CaseForm.prototype.fillStores=function(){var b=this;this.panel.setLoading("Loading Labcontacts from database");var a=BUI.getProposal();a.onDataRetrieved.attach(function(c,d){b.labContactForSendingStore.loadData(d,false);b.labContactForReturnStore.loadData(d,false);
b.panel.setLoading(false);});a.getLabContactsByProposalId();};CaseForm.prototype.refresh=function(a){this.setDewar(a);this.stockSolutionGrid.refresh(BIOSAXS.proposal.getStockSolutionsByDewarId(a.dewarId));};CaseForm.prototype.getDewar=function(){this.dewar.code=Ext.getCmp("dewar_code").getValue();this.dewar.comments=Ext.getCmp("dewar_comments").getValue();
this.dewar.trackingNumberFromSynchrotron=Ext.getCmp("dewar_trackingNumberFromSynchrotron").getValue();this.dewar.trackingNumberToSynchrotron=Ext.getCmp("dewar_trackingNumberToSynchrotron").getValue();this.dewar.transportValue=Ext.getCmp("dewar_transportValue").getValue();this.dewar.storageLocation=Ext.getCmp("dewar_storageLocation").getValue();
this.dewar.firstExperimentId=this.macromoleculeCombo.getValue();return this.dewar;};CaseForm.prototype.setDewar=function(a){this.dewar=a;Ext.getCmp("dewar_code").setValue(this.dewar.code);Ext.getCmp("dewar_dewarStatus").setText(new String(this.dewar.dewarStatus).toUpperCase());Ext.getCmp("dewar_comments").setValue(this.dewar.comments);
Ext.getCmp("dewar_trackingNumberFromSynchrotron").setValue(this.dewar.trackingNumberFromSynchrotron);Ext.getCmp("dewar_trackingNumberToSynchrotron").setValue(this.dewar.trackingNumberToSynchrotron);Ext.getCmp("dewar_transportValue").setValue(this.dewar.transportValue);Ext.getCmp("dewar_storageLocation").setValue(this.dewar.storageLocation);
if(a.sessionVO!=null){this.macromoleculeCombo.setValue(a.sessionVO.sessionId);}};CaseForm.prototype.getSessionCombo=function(){this.macromoleculeCombo=BIOSAXS_COMBOMANAGER.getComboSessions(BIOSAXS.proposal.getSessions(),{labelWidth:100,margin:"5 0 00 0",width:250});return this.macromoleculeCombo;};CaseForm.prototype.getInformationPanel=function(){if(this.panel==null){this.informationPanel=Ext.create("Ext.form.Panel",{width:this.width-10,border:0,items:[{xtype:"container",margin:"2 2 2 2",collapsible:false,defaultType:"textfield",layout:"anchor",items:[{xtype:"container",layout:"hbox",items:[{xtype:"requiredtext",fieldLabel:"Code",allowBlank:false,name:"code",id:"dewar_code",anchor:"50%"},{xtype:"label",margin:"0 0 0 20",readOnly:true,id:"dewar_dewarStatus",anchor:"50%"}]},this.getSessionCombo(),{margin:"5 0 0 0",xtype:"textareafield",name:"comments",id:"dewar_comments",width:this.width-50,fieldLabel:"Comments"}]},{xtype:"fieldset",title:"Courier Accounts Details for Return",collapsible:false,layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"container",layout:"hbox",items:[{xtype:"textfield",labelWidth:200,width:280,fieldLabel:"Track Number From Synchrotron",id:"dewar_trackingNumberFromSynchrotron"},{xtype:"numberfield",width:190,labelWidth:110,margin:"0 0 0 30",fieldLabel:"Transport Value",id:"dewar_transportValue"}]},{xtype:"container",layout:"hbox",margin:"10 0 0 0",items:[{xtype:"textfield",labelWidth:200,width:280,fieldLabel:"Track Number To Synchrotron",id:"dewar_trackingNumberToSynchrotron"},{xtype:"textfield",margin:"0 0 0 30",width:190,labelWidth:110,fieldLabel:"Storage Location",id:"dewar_storageLocation"}]}]}]});
}return this.informationPanel;};CaseForm.prototype.getPanel=function(a){this.dewar=a;this.panel=Ext.createWidget({xtype:"container",layout:"vbox",width:this.width,border:0,items:[{items:{xtype:"container",layout:"vbox",margin:"5 5 5 5",items:[this.getInformationPanel(a),this.stockSolutionGrid.getPanel()]}}]});
this.refresh(a);return this.panel;};CaseForm.prototype.input=function(){return{dewar:{"dewarId":305861,"code":"ESRF-TEST","comments":"comments","storageLocation":"FRIDGE","dewarStatus":"opened","timeStamp":null,"isStorageDewar":null,"barCode":"ESRF305861","customsValue":null,"transportValue":null,"trackingNumberToSynchrotron":"3333","trackingNumberFromSynchrotron":"224466","type":"Dewar","sessionVO":{"sessionId":31697,"expSessionPk":null,"projectCode":null,"startDate":"2012 07 21","endDate":"2012 07 23","beamlineName":"BM29","scheduled":1,"nbShifts":2,"comments":null,"beamlineOperator":"PERNOT  P","usedFlag":null,"sessionTitle":null,"structureDeterminations":null,"dewarTransport":null,"databackupFrance":null,"databackupEurope":null,"visit_number":null,"operatorSiteNumber":"14061","timeStamp":"2012 04 25"}},proposal:{"assemblies":[],"sessions":[{"sessionId":31697,"expSessionPk":null,"projectCode":null,"startDate":"2012 07 21","endDate":"2012 07 23","beamlineName":"BM29","scheduled":1,"nbShifts":2,"comments":null,"beamlineOperator":"PERNOT  P","usedFlag":null,"sessionTitle":null,"structureDeterminations":null,"dewarTransport":null,"databackupFrance":null,"databackupEurope":null,"visit_number":null,"operatorSiteNumber":"14061","timeStamp":"2012 04 25"}],"labcontacts":[{"labContactId":787,"personVO":{"personId":304252,"personUUID":null,"familyName":"KIM","givenName":"Henry","title":null,"emailAddress":"henry-sung.kim@ibs.fr","phoneNumber":"","login":"","passwd":"","faxNumber":""},"cardName":"KIM-Institut de Bio","defaultCourrierCompany":"22","courierAccount":"","billingReference":"","dewarAvgCustomsValue":0,"dewarAvgTransportValue":0}],"buffers":[{"bufferId":811,"proposalId":3124,"safetyLevelId":null,"name":"EDTA","acronym":"EDTA","ph":null,"composition":"","bufferhasadditive3VOs":[],"comments":""},{"bufferId":810,"proposalId":3124,"safetyLevelId":null,"name":"HEPES","acronym":"HEPES","ph":null,"composition":"","bufferhasadditive3VOs":[],"comments":""}],"shippings":[{"shippingId":304107,"shippingName":"TEST","deliveryAgentAgentName":null,"deliveryAgentShippingDate":null,"deliveryAgentDeliveryDate":null,"deliveryAgentAgentCode":null,"deliveryAgentFlightCode":null,"shippingStatus":"opened","timeStamp":"2013 09 25","laboratoryId":null,"isStorageShipping":null,"creationDate":"2013 09 25","comments":"test","sendingLabContactVO":{"labContactId":787,"personVO":{"personId":304252,"personUUID":null,"familyName":"KIM","givenName":"Henry","title":null,"emailAddress":"henry-sung.kim@ibs.fr","phoneNumber":"","login":"","passwd":"","faxNumber":""},"cardName":"KIM-Institut de Bio","defaultCourrierCompany":"22","courierAccount":"","billingReference":"","dewarAvgCustomsValue":0,"dewarAvgTransportValue":0},"returnLabContactVO":{"labContactId":787,"personVO":{"personId":304252,"personUUID":null,"familyName":"KIM","givenName":"Henry","title":null,"emailAddress":"henry-sung.kim@ibs.fr","phoneNumber":"","login":"","passwd":"","faxNumber":""},"cardName":"KIM-Institut de Bio","defaultCourrierCompany":"22","courierAccount":"","billingReference":"","dewarAvgCustomsValue":0,"dewarAvgTransportValue":0},"returnCourier":null,"dateOfShippingToUser":null,"shippingType":"DewarTracking","dewarVOs":[{"dewarId":305861,"code":"ESRF-TEST","comments":"comments","storageLocation":"FRIDGE","dewarStatus":"opened","timeStamp":null,"isStorageDewar":null,"barCode":"ESRF305861","customsValue":null,"transportValue":null,"trackingNumberToSynchrotron":"3333","trackingNumberFromSynchrotron":"224466","type":"Dewar","sessionVO":{"sessionId":31697,"expSessionPk":null,"projectCode":null,"startDate":"2012 07 21","endDate":"2012 07 23","beamlineName":"BM29","scheduled":1,"nbShifts":2,"comments":null,"beamlineOperator":"PERNOT  P","usedFlag":null,"sessionTitle":null,"structureDeterminations":null,"dewarTransport":null,"databackupFrance":null,"databackupEurope":null,"visit_number":null,"operatorSiteNumber":"14061","timeStamp":"2012 04 25"}}]}],"macromolecules":[{"macromoleculeId":5933,"safetylevelId":null,"proposalId":3124,"name":"A","acronym":"A","molecularMass":"","extintionCoefficient":"","sequence":null,"creationDate":null,"comments":"","macromoleculeregion3VOs":[],"stoichiometry3VOsForHostMacromoleculeId":[],"structure3VOs":[]}],"stockSolutions":[{"stockSolutionId":6,"proposalId":3124,"macromoleculeId":5933,"bufferId":811,"instructionSet3VO":null,"boxId":305861,"storageTemperature":"20","volume":"300","concentration":"1.2","comments":"Buffer EDTA with A","name":"A_EDTA_1.2","samples":[]}]}};
};CaseForm.prototype.test=function(b){var c=new CaseForm();BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel(c.input().dewar);a.render(b);};function ExperimentForm(a){this.id=BUI.id();if(a!=null){}this.onSaved=new Event(this);}ExperimentForm.prototype._getItems=function(a){this.experiment=a;
var d=Ext.create("Ext.form.ComboBox",{id:this.id+"type",fieldLabel:"Type",store:["STATIC","CALIBRATION","HPLC"],queryMode:"local",labelWidth:120,displayField:"name",valueField:"name",value:a.json.type,disabled:(a.json.type=="TEMPLATE")});var b=[];if(a.json.type=="HPLC"){var c=BIOSAXS_COMBOMANAGER.getComboMacromoleculeByMacromolecules(BIOSAXS.proposal.getMacromolecules(),{labelWidth:120,width:"120px"});
c.setValue(a.getHPLCMacromolecule().macromoleculeId);b.push(c);}b.push(d,{id:this.id+"name",xtype:"textfield",fieldLabel:"Name",labelWidth:120,width:"100%",value:a.json.name},{id:this.id+"comments",xtype:"textareafield",name:"comments",fieldLabel:"Comments",labelWidth:120,height:120,width:"100%",value:a.json.comments});
return b;};ExperimentForm.prototype.getPanel=function(a){var b=this;this.panel=Ext.createWidget({xtype:"container",layout:"vbox",border:0,style:{padding:"10px"},fieldDefaults:{labelAlign:"left",labelWidth:50},items:this._getItems(a)});return this.panel;};ExperimentForm.prototype.input=function(){return new ExperimentHeaderForm().input();
};ExperimentForm.prototype.test=function(b){var c=new ExperimentForm();var a=c.getPanel(new Experiment(c.input().experiment));a.render(b);};function ExperimentHeaderForm(a){this.id=BUI.id();this.backgroundColor="#FFFFFF";}ExperimentHeaderForm.prototype.getHTMLSource=function(a){var b=BUI.createFormLabel("Name :",a.json.name,75,400,this.backgroundColor);
if(a.json.type=="HPLC"){if(a.getHPLCMacromolecule()!=null){b=b+BUI.createFormLabel("Molecule :",a.getHPLCMacromolecule().acronym,75,400,this.backgroundColor);}}else{b=b+BUI.createFormLabel("Type :",a.json.type,75,400,this.backgroundColor);}b=b+BUI.createFormLabel("Date :",a.json.creationDate,75,400,this.backgroundColor);
return b;};ExperimentHeaderForm.prototype.getHTMLDownload=function(b){var a="background-color:"+this.backgroundColor+";";var c="<div  style='height:25px;"+a+"'>";if((b.json.type=="CALIBATION")||(b.json.type=="STATIC")){c=c+"<img src='/ispyb/images/Edit_16x16_01.png' /><a style='"+a+"'color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getSourceFile&type=scattering&experimentId="+b.experimentId+"' title='File used by the BM control software'>  Download Source File</a></div>";
c=c+"<div style='"+a+"'height:25px;'>"+"<img style='width:16px;height:16px' src='/ispyb/images/pdf.png' /><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getReport&experimentId="+b.experimentId+"&format=PDF&filename="+b.name+"&type=DATA_ACQUISITION'   title='Download report'>  Download Report</a></div>";
}if(b.json.type=="TEMPLATE"){c=c+"<img src='/ispyb/images/Edit_16x16_01.png' /><a ' href='/ispyb/user/dataadapter.do?reqCode=getTemplateSourceFile&experimentId="+b.experimentId+"' style='color:blue;color:blue;cursor: hand; cursor: pointer;' >  Download Source File</a></div>";}if(b.json.type=="HPLC"){c=c+"<img src='/ispyb/images/Edit_16x16_01.png' /><a ' href='/ispyb/user/dataadapter.do?reqCode=getH5File&experimentId="+b.experimentId+"' style='color:blue;color:blue;cursor: hand; cursor: pointer;' >  Download h5 File</a></div>";
}return c;};ExperimentHeaderForm.prototype.getTopPanel=function(a){return{xtype:"container",layout:"hbox",items:[{margin:"0 0 0 0",width:475,border:0,html:this.getHTMLSource(a)},{margin:"0 0 0 0",width:475,border:0,html:this.getHTMLDownload(a)}]};};ExperimentHeaderForm.prototype.getButton=function(a){var b=this;
return Ext.create("Ext.Button",{text:"EDIT",minWidth:"100",margin:"10 0 0 30",handler:function(){var c=new ExperimentWindow();c.onSaved.attach(function(d,e){b.experiment.json.name=e.name;b.experiment.json.type=e.type;b.experiment.json.comments=e.comments;b.panel.remove(b.panel.items.items[0]);b.panel.remove(b.panel.items.items[0]);
b.panel.insert(b.getTopPanel(b.experiment));b.panel.insert(b.getBottomPanel(b.experiment));});c.show(a);}});};ExperimentHeaderForm.prototype.getBottomPanel=function(a){return{xtype:"container",layout:"hbox",margin:"10 0 0 0",items:[this.getComments(a),this.getButton(a)]};};ExperimentHeaderForm.prototype.getComments=function(a){return{xtype:"textareafield",labelStyle:"font-weight: bold;",name:"comments",fieldLabel:"Comments",labelWidth:70,height:40,minWidth:"450",readOnly:true,value:a.json.comments};
};ExperimentHeaderForm.prototype.getPanel=function(a){this.experiment=a;if(a.json.type=="CALIBRATION"){this.backgroundColor="#EFFBFB";}if(a.json.type=="TEMPLATE"){this.backgroundColor="#E0F8E6";}this.panel=Ext.create("Ext.container.Container",{frame:false,layout:"vbox",padding:5,bodyPadding:"5 5 0 0",width:890,margin:"0 0 10 0",height:120,style:{borderColor:"#99bce8",borderStyle:"solid",borderWidth:"1px","background-color":this.backgroundColor},fieldDefaults:{msgTarget:"side",labelWidth:100},items:[this.getTopPanel(a),this.getBottomPanel(a)]});
return this.panel;};ExperimentHeaderForm.prototype.input=function(){return{experiment:DATADOC.getExperiment_10()};};ExperimentHeaderForm.prototype.test=function(b){var c=new ExperimentHeaderForm();var a=c.getPanel(new Experiment(c.input().experiment));a.render(b);};function MacromoleculeForm(a){this.id=BUI.id();
this.width=700;this.height=500;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}MacromoleculeForm.prototype.getMacromolecule=function(){this.macromolecule.name=Ext.getCmp(this.panel.getItemId()).getValues().name;this.macromolecule.acronym=Ext.getCmp(this.panel.getItemId()).getValues().acronym;
this.macromolecule.comments=Ext.getCmp(this.panel.getItemId()).getValues().comments;this.macromolecule.extintionCoefficient=Ext.getCmp(this.panel.getItemId()).getValues().extintionCoefficient;this.macromolecule.molecularMass=Ext.getCmp(this.panel.getItemId()).getValues().molecularMass;return this.macromolecule;
};MacromoleculeForm.prototype.setMacromolecule=function(a){this.pdbStore.loadData(a.structure3VOs);};MacromoleculeForm.prototype.getForm=function(a){this.panel=Ext.createWidget("form",{frame:false,border:0,padding:15,width:550,height:350,items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"requiredtext",items:[{fieldLabel:"Name",name:"name",anchor:"95%",tooltip:"Name of the macromolecule",value:a.name},{fieldLabel:"Acronym",name:"acronym",anchor:"95%",value:a.acronym}]},{xtype:"container",flex:1,layout:"anchor",defaultType:"textfield",items:[{xtype:"numberfield",fieldLabel:"Mol. Mass (Da)",name:"molecularMass",value:a.molecularMass,decimalPrecision:6},{xtype:"numberfield",fieldLabel:"Extinction coef.",name:"extintionCoefficient",value:a.extintionCoefficient,decimalPrecision:6}]}]},{xtype:"textareafield",name:"comments",fieldLabel:"Comments",value:a.comments,width:this.width-10}]});
return this.panel;};MacromoleculeForm.prototype.getPanel=function(a){this.macromolecule=a;return Ext.createWidget("tabpanel",{height:420,margin:5,plain:true,style:{padding:5},items:[{tabConfig:{title:"General",disabled:false},items:[this.getForm(a)]},{tabConfig:{title:"PDB & Sequences ",disabled:false},items:[this.getPDBGrid(a)]},{tabConfig:{title:"Assembly",tooltip:"Description of subunits present in the macromolecule",disabled:false},items:[this.getMolarityGrid(a)]}]});
};MacromoleculeForm.prototype.update=function(){var a=this;BIOSAXS.proposal.onInitialized.attach(function(){if(BIOSAXS.proposal!=null){var b=BIOSAXS.proposal.macromolecules;for(var c=0;c<b.length;c++){if(b[c].macromoleculeId==a.macromolecule.macromoleculeId){a.macromolecule=b[c];a.setMacromolecule(a.macromolecule);
a.molarityStore.loadData(a.parseMolarityData(a.macromolecule));a.pdbGrid.setLoading(false);a.molarityGrid.setLoading(false);}}}});this.molarityGrid.setLoading("Updating");this.pdbGrid.setLoading("Updating");BIOSAXS.proposal.init();};MacromoleculeForm.prototype.parseMolarityData=function(c){var b=[];if(c.stoichiometry!=null){for(var a=0;
a<c.stoichiometry.length;a++){b.push({ratio:c.stoichiometry[a].ratio,acronym:c.stoichiometry[a].macromolecule3VO.acronym,comments:c.stoichiometry[a].macromolecule3VO.comments,stoichiometryId:c.stoichiometry[a].stoichiometryId,name:c.stoichiometry[a].macromolecule3VO.name});}}return b;};MacromoleculeForm.prototype.getMolarityGrid=function(a){var b=this;
this.molarityStore=Ext.create("Ext.data.Store",{fields:["acronym","ratio","comments","stoichiometryId","name"],data:this.parseMolarityData(a),sorters:{property:"ratio",direction:"DESC"}});this.molarityGrid=Ext.create("Ext.grid.Panel",{store:this.molarityStore,height:350,padding:5,columns:[{text:"Subunit",columns:[{text:"Acronym",width:100,hidden:false,dataIndex:"acronym",sortable:true},{text:"Name",width:100,hidden:false,dataIndex:"name",sortable:true},{text:"Comments",width:200,dataIndex:"comments",sortable:true}]},{text:"Number",flex:0.1,dataIndex:"ratio",tooltip:"Number of times this subunit is present in the macromolecule",sortable:true},{id:this.id+"MOLARITY_REMOVE",flex:0.1,sortable:false,renderer:function(g,d,c,h,f,e){return BUI.getRedButton("REMOVE");
}}],listeners:{cellclick:function(c,d,j,f,i,k,g,h){if(c.getGridColumns()[j].getId()==b.id+"MOLARITY_REMOVE"){var l=new BiosaxsDataAdapter();l.onSuccess.attach(function(){b.molarityGrid.setLoading(false);b.update();});l.removeStoichiometry(f.data.stoichiometryId);b.molarityGrid.setLoading("Removing Structure");
}}},buttons:[{text:"Add molarity",handler:function(){function d(){c.destroy();b.update();}var c=Ext.create("Ext.window.Window",{title:"Molarity",height:200,width:500,modal:true,buttons:[{text:"Save",handler:function(){var e=(b.macromoleculeCombo.getValue());var f=Ext.getCmp(b.id+"ratio").getValue();var h="";
var g=new BiosaxsDataAdapter();g.onSuccess.attach(function(j,i){b.update();c.destroy();});g.saveStoichiometry(b.macromolecule.macromoleculeId,e,f,h);}},{text:"Cancel",handler:function(){d();}}],items:[b.getMolarityForm(a)],listeners:{onEsc:function(){d();},close:function(){d();}}}).show();}}]});return this.molarityGrid;
};MacromoleculeForm.prototype.getPDBGrid=function(b){var c=this;console.log(b);this.pdbStore=Ext.create("Ext.data.Store",{fields:["filePath","structureId","structureType","structureId","name"],data:b.structure3VOs,groupField:"structureType",sorters:{property:"structureId",direction:"DESC"}});var a=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:Ext.create("Ext.XTemplate","<div style='background:#0ca3d2; color:white; float:left; font-size:10px; margin:6px 8px 0 0; padding:5px 8px;'>{name:this.formatName}</div>",{formatName:function(d){return d;
}}),hideGroupedHeader:true,startCollapsed:false});this.pdbGrid=Ext.create("Ext.grid.Panel",{store:this.pdbStore,features:[a],buttons:[{text:"Add PDB file",handler:function(){function e(){d.destroy();c.update();}var d=Ext.create("Ext.window.Window",{title:"Upload PDB File",height:200,width:400,modal:true,buttons:[{text:"Close",handler:function(){e();
}}],layout:"fit",items:{html:"<iframe style='width:500px' src='uploadPdbFileSAXS.do?reqCode=display&macromoleculeId="+b.macromoleculeId+"&type=PDB'></iframe>"},listeners:{onEsc:function(){e();},close:function(){e();}}}).show();}},{text:"Add FASTA file",handler:function(){function e(){d.destroy();c.update();
}var d=Ext.create("Ext.window.Window",{title:"Upload FASTA File",height:200,width:400,modal:true,buttons:[{text:"Close",handler:function(){e();}}],layout:"fit",items:{html:"<iframe style='width:500px' src='uploadPdbFileSAXS.do?reqCode=display&macromoleculeId="+b.macromoleculeId+"&type=FASTA'></iframe>"},listeners:{onEsc:function(){e();
},close:function(){e();}}}).show();}}],columns:[{text:"structureId",flex:0.2,hidden:true,dataIndex:"structureId",sortable:true},{text:"Name",flex:0.6,dataIndex:"name",sortable:true},{text:"Type",flex:0.2,dataIndex:"structureType",sortable:true},{id:this.id+"REMOVE",flex:0.2,sortable:false,renderer:function(h,e,d,i,g,f){return BUI.getRedButton("REMOVE");
}},],padding:5,height:350,listeners:{itemdblclick:function(f,d,g,h){c._editExperiment(d.raw.experimentId);},cellclick:function(d,f,k,g,j,l,h,i){if(d.getGridColumns()[k].getId()==c.id+"REMOVE"){var m=new BiosaxsDataAdapter();m.onSuccess.attach(function(){c.pdbGrid.setLoading(false);c.update();});m.removeStructure(g.data.structureId);
c.pdbGrid.setLoading("Removing PDB file");}}}});return this.pdbGrid;};MacromoleculeForm.prototype.getMolarityForm=function(d){var e=this;var c=[];for(var b=0;b<BIOSAXS.proposal.macromolecules.length;b++){var a=BIOSAXS.proposal.macromolecules[b];if(a.macromoleculeId!=d.macromoleculeId){c.push(a);}}this.macromoleculeCombo=BIOSAXS_COMBOMANAGER.getComboMacromoleculeByMacromolecules(c,{width:250,labelWidth:100,margin:10});
return Ext.createWidget("form",{frame:false,border:0,width:550,height:350,items:[{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"requiredtext",items:[this.macromoleculeCombo,{xtype:"numberfield",name:"Ratio",id:e.id+"ratio",fieldLabel:"Ratio",value:1,decimalPrecision:6,margin:10},{xtype:"textareafield",name:"comments",fieldLabel:"Comments",margin:10,width:400,value:""}]}]});
};MacromoleculeForm.prototype.input=function(){return{macromolecule:DATADOC.getMacromolecule_10()};};MacromoleculeForm.prototype.test=function(c){var a=new MacromoleculeForm();var b=a.getPanel(a.input().macromolecule);b.render(c);};function ModelVisualizerForm(a){this.id=BUI.id();this.width=600;this.height=400;
if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ModelVisualizerForm.prototype._getFirHTML=function(f,d,a,c,e){var b="<table>";b=b+'<tr style="text-align: center;"><td><a style="color:blue;font-weight:bold;" target="_blank" href="'+BUI.getModelFile("FIT",f,"txt")+'" >dammin.'+c+"</a></td></tr>";
b=b+'<tr style="text-align: center;font-style:italic;color:gray;"><td>'+e+"</td></tr>";b=b+'<tr><td><div background-color="red" id="'+(this.id+c+f)+'" width="'+d+'" height="'+a+'"></div></td></tr>';b=b+"</table>";return b;};ModelVisualizerForm.prototype.getItems=function(c){_this=this;var a=_this.height/2-60;
var b=_this.width/2-10;return Ext.create("Ext.container.Container",{layout:{type:"vbox",},items:[c,{xtype:"container",layout:{type:"hbox",},items:[{html:this._getFirHTML("id",b,a,"fir","Fit of the simulated scattering curve versus a smoothed experimental data (spline interpolation)"),height:a,width:b,padding:2},{html:this._getFirHTML("id",b,a,"fit","Fit of the simulated scattering curve versus the experimental data."),height:a,width:b,padding:2}]}]});
};ModelVisualizerForm.prototype.refresh=function(d){var b=[];for(var c=0;c<d.length;c++){console.log(BUI.rainbow(d.length,c).replace("#","0x"));b.push({color:BUI.rainbow(d.length,c).replace("#","0x"),modelId:d[c].modelId,opacity:0.8,radius:3,title:BUI.getFileNameByPath(d[c].pdbFile),type:"SHAPEDETERMINATIONMODEL"});
}this.panel.removeAll();this.panel.add(_this.getItems(new PDBViewer({width:this.width-10,height:(this.height/2)-10,title:""}).draw(b)));var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(h,g){var m=g.toString().split("\n");var k=[];for(var j=0;j<m.length;j++){var n=m[j].trim();var l=n.split(/\s*[\s,]\s*/);
if(l.length==4){k.push([Number(l[0]),BUI.getStvArray(l[1],l[2]),BUI.getStvArray(l[3],0)]);}}var e=(_this.id+"firid");var f=new StdDevDyGraph(e,{width:(_this.width/2)-10,height:(_this.height/2)-110,xlabel:"q(nm<sup>-1</sup>)"});f.draw(k,["#FF0000","#0000FF","#FF00FF"],["s","I(exp)","I(sim)"]);});a.getModelFile("FIR",d[0].modelId);
var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(h,g){var m=g.toString().split("\n");var k=[];for(var j=0;j<m.length;j++){var n=m[j].trim();var l=n.split(/\s*[\s,]\s*/);if(l.length==3){k.push([Number(l[0]),BUI.getStvArray(l[1],0),BUI.getStvArray(l[2],0)]);}}var e=(_this.id+"fitid");var f=new StdDevDyGraph(e,{width:(_this.width/2)-10,height:(_this.height/2)-110,xlabel:"q(nm<sup>-1</sup>)"});
f.draw(k,["#FF0000","#0000FF"],["s","I(exp)","I(sim)"]);});a.getModelFile("FIT",d[0].modelId);};ModelVisualizerForm.prototype.getPanel=function(a){_this=this;this.modelList=a;this.panel=Ext.create("Ext.Panel",{title:"Results",width:this.width,height:this.height,layout:{type:"vbox",},items:[],listeners:{afterrender:function(c,b){}}});
return this.panel;};function ResultSummaryForm(){this.radiationDamageThreshold=BUI.getRadiationDamageThreshold();this.qualityThreshold=BUI.getQualityThreshold();this.clusterByBuffers=false;this.collapseConcentrations=true;this.summaryHeight=350;this.id=BUI.id();var a=this;this.qualityControlResultsWidget=new QualityControlResultsWidget({qualityThreshold:this.radiationDamageThreshold,radiationDamageThreshold:this.qualityThreshold});
this.qualityControlResultsWidget.onQualityChanged.attach(function(b,c){a.qualityThreshold=c;a.thresholdsChanged();});this.qualityControlResultsWidget.onRadiationDatamageChanged.attach(function(b,c){a.radiationDamageThreshold=c;a.thresholdsChanged();});this.concentrationHTMLTableWidget=new ConcentrationHTMLTableWidget({height:250,showBufferColumns:this.clusterByBuffers});
this.plot=new BoxWhiskerGraph({targetId:a.id+"_boxPlot",height:350,width:450,maxBoxWidth:25});this.rangePlot=new RangeWhiskerGraph({targetId:a.id+"_rangePlot",height:350,width:450,maxBoxWidth:25});}ResultSummaryForm.prototype.thresholdsChanged=function(){var c=this.prepareData(this.rawData);var a=JSON.parse(JSON.stringify(c));
a.concentration.concentrations=[];for(var b in c.concentration.concentrations){if(c.concentration.concentrations[b].calculation.rgGnom.validNumber>0){a.concentration.concentrations.push(c.concentration.concentrations[b]);}}this.plotWhisker(a);this.plotRange(a);this.concentrationHTMLTableWidget.refresh(c);
};ResultSummaryForm.prototype.hasRadiationDamage=function(a){var c=a.bufferBeforeFramesMerged/a.framesCount;var d=a.bufferAfterFramesMerged/a.framesCount;var b=a.framesMerge/a.framesCount;return !((c>=this.radiationDamageThreshold)&&(d>=this.radiationDamageThreshold)&&(b>=this.radiationDamageThreshold));
};ResultSummaryForm.prototype.analyzeFrames=function(a){return{bufferAfterFramesMerged:a.bufferAfterFramesMerged,bufferBeforeFramesMerged:a.bufferBeforeFramesMerged,framesCount:a.framesCount,framesMerge:a.framesMerge};};ResultSummaryForm.prototype.detectDataCollectionWarnings=function(a){var c=this.analyzeFrames(a);
var b={count:0,type:[]};if(this.hasRadiationDamage(c)){b.count=b.count+1;b.type.push("RADIATION DAMAGE");}if(Number(a.quality)<this.qualityThreshold){b.count=1;b.type.push("Quality <"+this.qualityThreshold);}return b;};ResultSummaryForm.prototype.getConcentrations=function(d){var e={};for(var a=0;a<d.length;
a++){var b=this.detectDataCollectionWarnings(d[a]);var g=d[a].conc;if(this.clusterByBuffers){g=d[a].conc+"_"+d[a].bufferId;}if(e[g]==null){e[g]={id:g,concentration:Number(d[a].conc).toFixed(2),bufferId:d[a].bufferId,bufferAcronym:d[a].bufferAcronym,rgGuinier:[],i0Guinier:[],rgGnom:[],dMax:[],quality:[],frames:[],frames_warning:b.count};
}else{e[g].frames_warning=e[g].frames_warning+b.count;}e[g].frames.push(d[a]);if(b.count==0){e[g].rgGuinier.push(d[a].rgGuinier);e[g].i0Guinier.push(d[a].I0);e[g].quality.push(d[a].quality);e[g].rgGnom.push(d[a].rgGnom);e[g].dMax.push(d[a].dmax);}}var f=[];for(var c in e){if(e.hasOwnProperty(c)){f.push({concentration:e[c].concentration,id:c,bufferId:Number(e[c].bufferId).toFixed(2),bufferAcronym:e[c].bufferAcronym,rgGuinier:e[c].rgGuinier,frames:e[c].frames,frames_warning:e[c].frames_warning,calculation:{rgGuinier:BUI.getStandardDeviation(e[c].rgGuinier),i0Guinier:BUI.getStandardDeviation(e[c].i0Guinier),quality:BUI.getStandardDeviation(e[c].quality),rgGnom:BUI.getStandardDeviation(e[c].rgGnom),dMax:BUI.getStandardDeviation(e[c].dMax)}});
}}return{concentrations:f};};ResultSummaryForm.prototype.prepareData=function(d){function a(h){var g={};for(var f=0;f<h.length;f++){g[h[f].bufferId]=h[f].acronym;}var e=[];for(var j in g){if(g.hasOwnProperty(j)){e.push({acronym:g[j],bufferId:j});}}return e;}function c(e){var g=[];for(var f=0;f<e.concentrations.length;
f++){g.push(e.concentrations[f].concentration+" mg/ml ");}return g.toString();}var b=this.getConcentrations(d);return{dataCollectionCount:d.length,buffers:a(d),concentration:b,concentrationLabel:c(b)};};ResultSummaryForm.prototype.getDataForWhisker=function(f){var d=[];var h={};var b=0;var e=0;if(this.collapseConcentrations){for(b=0;
b<f.concentration.concentrations.length;b++){e=f.concentration.concentrations[b];var c=Number(e.concentration).toFixed(0);if(h[c]==null){h[c]={};h[c].concentration=c;h[c].calculation={};h[c].calculation.rgGuinier={};h[c].calculation.rgGuinier.values=[];h[c].calculation.rgGuinier.values=e.calculation.rgGuinier.values;
h[c].calculation.rgGnom={};h[c].calculation.rgGnom.values=[];h[c].calculation.rgGnom.values=e.calculation.rgGnom.values;}else{h[c].calculation.rgGuinier.values=h[c].calculation.rgGuinier.values.concat(e.calculation.rgGuinier.values);h[c].calculation.rgGnom.values=h[c].calculation.rgGnom.values.concat(e.calculation.rgGnom.values);
}}var g=[];for(var a in h){if(h.hasOwnProperty(a)){g.push(h[a]);}}f.concentration.concentrations=g;}for(b=0;b<f.concentration.concentrations.length;b++){e=f.concentration.concentrations[b];d.push({name:e.concentration+"mg/ml",concentration:Number(e.concentration),x:Number(e.concentration),classes:[]});
d[d.length-1].classes.push({name:"Guinier",color:"#9A2EFE",values:e.calculation.rgGuinier.values});d[d.length-1].classes.push({name:"P(r)",color:"#2E64FE",values:e.calculation.rgGnom.values});}return{clusters:d.sort(function(j,i){return j.concentration-i.concentration;})};};ResultSummaryForm.prototype.getDataForWhiskerQuality=function(d){var b=[];
for(var a=0;a<d.concentration.concentrations.length;a++){var c=d.concentration.concentrations[a];b.push({name:c.concentration+"mg/ml",classes:[]});b[b.length-1].classes.push({name:"Quality",values:c.calculation.quality.values});}return{clusters:b};};ResultSummaryForm.prototype.plotQualityWhisker=function(a){this.qualityPlot.refresh(this.getDataForWhiskerQuality(a));
};ResultSummaryForm.prototype.plotWhisker=function(a){this.plot.refresh(this.getDataForWhisker(a));};ResultSummaryForm.prototype.plotRange=function(a){this.rangePlot.refresh(this.getDataForWhisker(a));};ResultSummaryForm.prototype.getPanel=function(a){var c=this;c.rawData=a;var b=this.prepareData(a);
this.panel=Ext.createWidget("form",{bodyPadding:20,frame:false,border:0,width:this.width,height:this.summaryHeight+1000,items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"textfield",items:[c.qualityControlResultsWidget.getPanel(),{xtype:"fieldset",width:950,margin:"20, 0 0 0",height:this.summaryHeight+500,items:[{html:"<div align='center' style='background-color:#336699;color:white;border:1px solid black; font-weight:bold'>Concentration Analysis</div>",border:0,width:900},{html:this.concentrationHTMLTableWidget.getPanel(b),border:0,width:900,margin:"10, 0 0 10"},{xtype:"container",layout:"vbox",border:5,items:[{html:"<div align='center' style='background-color:#336699;color:white;border:1px solid black; font-weight:bold'> Rg based on Guinier and Gnom</div>",border:8,width:900,margin:"20 0 0 10"},{xtype:"container",layout:"hbox",items:[{xtype:"container",layout:"vbox",items:[{html:"<div id='"+c.id+"_boxPlot'></div>",border:0,width:this.plot.width,padding:"10 0 0 20",listeners:{afterrender:function(){c.plotWhisker(b);
}}},{html:"<div align='center' style='color:black;'> Concentration (mg/ml)</div>",width:450,border:0,margin:"-50 0 0 0"}]},{xtype:"container",layout:"vbox",items:[{html:"<div id='"+c.id+"_rangePlot'></div>",border:0,width:this.rangePlot.width,padding:"10 0 0 10",listeners:{afterrender:function(){c.plotRange(b);
}}},{html:"<div align='center' style='color:black;'> Concentration (mg/ml)</div>",width:450,border:0,margin:"-50 0 0 0"}]}]}]}]}]}]}]});return this.panel;};ResultSummaryForm.prototype.input=function(){return{data:DATADOC.getData_3367()};};ResultSummaryForm.prototype.test=function(b){var c=new ResultSummaryForm();
var a=c.getPanel(c.input().data);a.render(b);};function ShipmentForm(a){this.id=BUI.id();this.creationMode=false;this.showTitle=true;if(a!=null){if(a.creationMode!=null){this.creationMode=a.creationMode;}if(a.showTitle!=null){this.showTitle=a.showTitle;}}this.onSaved=new Event(this);}ShipmentForm.prototype.fillStores=function(){this.panel.setLoading("Loading Labcontacts from database");
this.labContactForSendingStore.loadData(BIOSAXS.proposal.getLabcontacts(),false);this.labContactForReturnStore.loadData(BIOSAXS.proposal.getLabcontacts(),false);this.panel.setLoading(false);if(this.shipment!=null){this.setShipment(this.shipment);}};ShipmentForm.prototype.draw=function(a){this.getPanel().render(a);
};ShipmentForm.prototype.setShipment=function(a){this.shipment=a;var b=this;Ext.getCmp(b.id+"shippingName").setValue(a.json.shippingName);Ext.getCmp(b.id+"shippingStatus").setValue(a.json.shippingStatus);Ext.getCmp(b.id+"comments").setValue(a.json.comments);if(a.json.sendingLabContactVO!=null){this.labContactsSendingCombo.setValue(a.json.sendingLabContactVO.labContactId);
}if(a.json.returnLabContactVO!=null){this.labContactsReturnCombo.setValue(a.json.returnLabContactVO.labContactId);}};ShipmentForm.prototype._saveShipment=function(){var d=this;var a=null;if(this.shipment!=null){a=this.shipment.json.shippingId;}var b={shippingId:a,name:Ext.getCmp(d.id+"shippingName").getValue(),status:Ext.getCmp(d.id+"shippingStatus").getValue(),sendingLabContactId:Ext.getCmp(d.id+"shipmentform_sendingLabContactId").getValue(),returnLabContactId:Ext.getCmp(d.id+"returnLabContactId").getValue(),returnCourier:Ext.getCmp(d.id+"returnCourier").getValue(),courierAccount:Ext.getCmp(d.id+"courierAccount").getValue(),BillingReference:Ext.getCmp(d.id+"BillingReference").getValue(),dewarAvgCustomsValue:Ext.getCmp(d.id+"dewarAvgCustomsValue").getValue(),dewarAvgTransportValue:Ext.getCmp(d.id+"dewarAvgTransportValue").getValue(),comments:Ext.getCmp(d.id+"comments").getValue()};
var c=new BiosaxsDataAdapter();c.onSuccess.attach(function(f,e){window.location=BUI.getShippingURL(e.shippingId);});c.onError.attach(function(f,e){d.onError.notify(e);});if(b.name==""){BUI.showError("Name field is mandatory");return;}if(b.sendingLabContactId==null){BUI.showError("Lab contact for sending field is mandatory");
return;}if(b.returnLabContactId==null){BUI.showError("Lab contact for return field is mandatory");return;}c.createShipment(b.shippingId,b.name,b.status,b.comments,b.sendingLabContactId,b.returnLabContactId,b.returnCourier,b.courierAccount,b.BillingReference,b.dewarAvgCustomsValue,b.dewarAvgTransportValue);
};ShipmentForm.prototype.getPanel=function(a){var d=this;this.shipment=a;var c='<span style="color:red;font-weight:bold" data-qtip="Required">*</span>';var b=[];if(d.creationMode){b.push({text:"Create",scope:this,handler:function(){d._saveShipment();}});}else{b.push({text:"Save",scope:this,handler:function(){d._saveShipment();
}});}this.labContactForSendingStore=Ext.create("Ext.data.Store",{fields:["cardName","labContactId"]});this.labContactForReturnStore=Ext.create("Ext.data.Store",{fields:["cardName","labContactId"]});this.labContactsSendingCombo=Ext.create("Ext.form.ComboBox",{id:d.id+"shipmentform_sendingLabContactId",fieldLabel:"Lab contact for sending",afterLabelTextTpl:c,store:this.labContactForSendingStore,queryMode:"local",labelWidth:200,displayField:"cardName",valueField:"labContactId"});
this.labContactsReturnCombo=Ext.create("Ext.form.ComboBox",{id:d.id+"returnLabContactId",fieldLabel:"If No, Lab-Contact for Return",afterLabelTextTpl:c,store:this.labContactForReturnStore,queryMode:"local",labelWidth:200,displayField:"cardName",valueField:"labContactId",listeners:{change:function(e,g){for(var f=0;
f<e.getStore().data.items.length;f++){if(e.getStore().data.items[f].raw.labContactId==g){Ext.getCmp(d.id+"returnCourier").setValue(e.getStore().data.items[f].raw.defaultCourrierCompany);Ext.getCmp(d.id+"courierAccount").setValue(e.getStore().data.items[f].raw.courierAccount);Ext.getCmp(d.id+"BillingReference").setValue(e.getStore().data.items[f].raw.billingReference);
Ext.getCmp(d.id+"dewarAvgCustomsValue").setValue(e.getStore().data.items[f].raw.dewarAvgCustomsValue);Ext.getCmp(d.id+"dewarAvgTransportValue").setValue(e.getStore().data.items[f].raw.dewarAvgTransportValue);}}}}});if(this.panel==null){this.panel=Ext.create("Ext.form.Panel",{bodyPadding:5,width:600,border:1,items:[{xtype:"fieldset",title:"Details",collapsible:false,defaultType:"textfield",layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"requiredtext",fieldLabel:"Shipment Label",allowBlank:false,name:"shippingName",id:d.id+"shippingName",value:"",anchor:"50%"},{xtype:"textareafield",name:"comments",id:d.id+"comments",fieldLabel:"Comments",value:""},{fieldLabel:"Status",readOnly:true,id:d.id+"shippingStatus",value:"Opened",anchor:"50%"}]},{xtype:"fieldset",title:"Lab-Contacts",collapsible:false,defaultType:"textfield",layout:"anchor",defaults:{anchor:"100%"},items:[this.labContactsSendingCombo,this.labContactsReturnCombo]},{border:0,html:BUI.getWarningHTML("These informations are relevant for all shipments")},{xtype:"fieldset",title:"Courier accounts details for return",collapsible:false,layout:"anchor",defaults:{anchor:"100%"},items:[{xtype:"textfield",labelWidth:400,fieldLabel:"Courier company for return (if ESRF sends a dewar back)",id:d.id+"returnCourier",value:""},{xtype:"textfield",labelWidth:400,fieldLabel:"Courier account",id:d.id+"courierAccount",value:""},{xtype:"textfield",labelWidth:400,fieldLabel:"Billing reference",id:d.id+"BillingReference",value:""},{xtype:"numberfield",labelWidth:400,fieldLabel:"Average Customs value of a dewar (Euro)",id:d.id+"dewarAvgCustomsValue",value:""},{xtype:"numberfield",labelWidth:400,fieldLabel:"Average Transport value of a dewar (Euro)",id:d.id+"dewarAvgTransportValue",value:""}]}],buttons:b});
}this.fillStores();if(this.showTitle){this.panel.setTitle("Create a new Shipment");}return this.panel;};ShipmentForm.prototype.input=function(){return{proposal:DATADOC.getProposal_10()};};ShipmentForm.prototype.test=function(b){var a=new ShipmentForm({creationMode:true});BIOSAXS.proposal=new Proposal(a.input().proposal);
a.getPanel().render(b);};function StockSolutionForm(a){this.id=BUI.id();this.actions=[];if(a!=null){if(a.actions!=null){this.actions=a.actions;}}this.onSaved=new Event(this);}StockSolutionForm.prototype.getStockSolution=function(){if(this.stockSolution!=null){this.stockSolution.concentration=Ext.getCmp(this.id+"stockSolution_concentration").getValue();
this.stockSolution.storageTemperature=Ext.getCmp(this.id+"stockSolution_storageTemperature").getValue();this.stockSolution.volume=Ext.getCmp(this.id+"stockSolution_volume").getValue();this.stockSolution.comments=Ext.getCmp(this.id+"stockSolution_comments").getValue();this.stockSolution.name=Ext.getCmp(this.id+"stockSolution_name").getValue();
this.stockSolution.bufferId=this.bufferCombo.getValue();if(this.macromoleculeCombo.getValue()!=null){this.stockSolution.macromoleculeId=this.macromoleculeCombo.getValue();}else{this.stockSolution.macromolecule3VO=null;}}else{return{concentration:Ext.getCmp(this.id+"stockSolution_concentration").getValue(),storageTemperature:Ext.getCmp(this.id+"stockSolution_storageTemperature").getValue(),volume:Ext.getCmp(this.id+"stockSolution_volume").getValue(),comments:Ext.getCmp(this.id+"stockSolution_comments").getValue(),name:Ext.getCmp(this.id+"stockSolution_name").getValue(),bufferId:this.bufferCombo.getValue(),macromoleculeId:this.macromoleculeCombo.getValue()};
}return this.stockSolution;};StockSolutionForm.prototype.setStockSolution=function(a){if(a!=null){if(a.macromoleculeId!=null){this.macromoleculeCombo.setValue(a.macromoleculeId);}this.bufferCombo.setValue(a.bufferId);Ext.getCmp(this.id+"stockSolution_concentration").setValue(this.stockSolution.concentration);
Ext.getCmp(this.id+"stockSolution_storageTemperature").setValue(this.stockSolution.storageTemperature);Ext.getCmp(this.id+"stockSolution_volume").setValue(this.stockSolution.volume);Ext.getCmp(this.id+"stockSolution_name").setValue(this.stockSolution.name);Ext.getCmp(this.id+"stockSolution_comments").setValue(this.stockSolution.comments);
}};StockSolutionForm.prototype.getBufferCombo=function(){this.bufferCombo=BIOSAXS_COMBOMANAGER.getComboBuffers(BIOSAXS.proposal.getBuffers(),{labelWidth:120,margin:"0 0 10 0",width:220});return this.bufferCombo;};StockSolutionForm.prototype.getMacromoleculeCombo=function(){this.macromoleculeCombo=BIOSAXS_COMBOMANAGER.getComboMacromoleculeByMacromolecules(BIOSAXS.proposal.getMacromolecules(),{labelWidth:120,margin:"0 0 10 0",width:220});
return this.macromoleculeCombo;};StockSolutionForm.prototype.refresh=function(){};StockSolutionForm.prototype._getTopPanel=function(){return{xtype:"container",layout:"hbox",border:0,items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"textfield",items:[this.getMacromoleculeCombo(),{xtype:"requiredtext",id:this.id+"stockSolution_name",fieldLabel:"Acronym",labelWidth:120,width:250},{xtype:"requiredtext",id:this.id+"stockSolution_concentration",fieldLabel:"Conc. (mg/ml)",labelWidth:120,width:250},{id:this.id+"stockSolution_storageTemperature",fieldLabel:"Storage Temp.(C)",labelWidth:120,width:250},{xtype:"requiredtext",id:this.id+"stockSolution_volume",fieldLabel:"Volume in Well (&#181l)",labelWidth:120,width:250}]}]},{xtype:"container",flex:1,layout:"anchor",defaultType:"textfield",margin:"0 0 0 10",items:[this.getBufferCombo()]}]};
};StockSolutionForm.prototype.getPanel=function(a){this.stockSolution=a;this.panel=Ext.createWidget({xtype:"container",layout:"vbox",border:0,style:{padding:"10px"},fieldDefaults:{labelAlign:"left",labelWidth:50},items:[this._getTopPanel(a),{id:this.id+"stockSolution_comments",xtype:"textareafield",name:"comments",fieldLabel:"Comments",labelWidth:120,width:"100%"}]});
this.setStockSolution(a);return this.panel;};StockSolutionForm.prototype.input=function(){return{stock:{"stockSolutionId":6,"proposalId":3124,"macromoleculeId":5933,"bufferId":811,"instructionSet3VO":null,"boxId":305861,"storageTemperature":"20","volume":"300","concentration":"1.2","comments":"Buffer EDTA with A","name":"A_EDTA_1.2","samples":[],"buffer":"EDTA","macromolecule":"A"},proposal:new MeasurementGrid().input().proposal};
};StockSolutionForm.prototype.test=function(b){var c=new StockSolutionForm();BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel(new Shipment(c.input().stock));a.render(b);};BoxWhiskerGraph.prototype.cleanArray=GenericGraph.prototype.cleanArray;BoxWhiskerGraph.prototype.plotAxes=GenericGraph.prototype.plotAxes;
BoxWhiskerGraph.prototype.plotRuler=GenericGraph.prototype.plotRuler;BoxWhiskerGraph.prototype.drawSVGVerticalText=GenericGraph.prototype.drawSVGVerticalText;BoxWhiskerGraph.prototype.getClassColor=GenericGraph.prototype.getClassColor;BoxWhiskerGraph.prototype.getDimensions=GenericGraph.prototype.getDimensions;
BoxWhiskerGraph.prototype.calculate=GenericGraph.prototype.calculate;BoxWhiskerGraph.prototype.getMedian=GenericGraph.prototype.getMedian;BoxWhiskerGraph.prototype.pointToPixel=GenericGraph.prototype.pointToPixel;BoxWhiskerGraph.prototype.maxValueWhisker=GenericGraph.prototype.maxValueWhisker;BoxWhiskerGraph.prototype.refresh=GenericGraph.prototype.refresh;
function BoxWhiskerGraph(a){this.maxBoxWidth=25;if(a==null){a=new Object();}a["plotHorizontalByCluster"]=true;GenericGraph.call(this,a);if(a.maxBoxWidth!=null){this.maxBoxWidth=a.maxBoxWidth;}}BoxWhiskerGraph.prototype.getQ1=function(a){a=a.slice(0,a.length/2);return this.getMedian(a);};BoxWhiskerGraph.prototype.getQ3=function(a){a=a.slice((a.length+1)/2);
return this.getMedian(a);};BoxWhiskerGraph.prototype.getQ2=function(a){return this.getMedian(a);};BoxWhiskerGraph.prototype.getBelowOutliers=function(d,c){var b=new Array();for(var a=0;a<c.length;a++){if(c[a]<=d){b.push(c[a]);}}return b;};BoxWhiskerGraph.prototype.getAboveOutliers=function(a,d){var c=new Array();
for(var b=0;b<d.length;b++){if(d[b]>=a){c.push(d[b]);}}return c;};BoxWhiskerGraph.prototype.minValueWhisker=function(e,a,d){var c=new Array();for(var b=0;b<d.length;b++){if((d[b]<a)&&(d[b])>e){c.push(d[b]);}}if(c.length>0){c.sort(function(g,f){return g-f;});return c[0];}return null;};BoxWhiskerGraph.prototype.isNumber=function(a){if(a==""){return false;
}var b=parseInt(a);if(!isNaN(b)){return true;}else{return false;}};BoxWhiskerGraph.prototype.plotBoxWhisker=function(g){if(this.maxBoxWidth!=null){if(g.width>this.maxBoxWidth){g.x=g.x+(g.width/2)-(this.maxBoxWidth/2);g.width=this.maxBoxWidth;}}if(this.plotPoints){for(var d=0;d<g.values.length;d++){var e=g.values[d];
var f=this.pointToPixel(e,g);SVG.drawCircle(g.x+(g.width/2)+2,f,this.pointRadius,this.svg,[["fill","green"],["fill-opacity",this.fillOpacityPoint],["stroke-opacity",this.strokeOpacityPoint],["stroke","black"]]);}}var c=this.getClassColor(g.name);var b=this.calculate(g.values);if(this.isNumber(b.Q1)){SVG.drawLine(g.x,this.pointToPixel(b.Q1,g),g.x+g.width,this.pointToPixel(b.Q1,g),this.svg,[["stroke",c]]);
}if(this.isNumber(b.Q2)){SVG.drawLine(g.x,this.pointToPixel(b.Q2,g),g.x+g.width,this.pointToPixel(b.Q2,g),this.svg,[["stroke","blue"],["stroke-width","2"]]);}if(this.isNumber(b.Q3)){SVG.drawLine(g.x,this.pointToPixel(b.Q3,g),g.x+g.width,this.pointToPixel(b.Q3,g),this.svg,[["stroke",c]]);}if(this.isNumber(b.Q1)&&this.isNumber(b.Q3)){SVG.drawLine(g.x,this.pointToPixel(b.Q1,g),g.x,this.pointToPixel(b.Q3,g),this.svg,[["stroke",c]]);
SVG.drawLine(g.x+g.width,this.pointToPixel(b.Q1,g),g.x+g.width,this.pointToPixel(b.Q3,g),this.svg,[["stroke",c]]);}if(b["min-whisker"]!=null){if(this.isNumber(b.Q1)){SVG.drawLine(g.x+(g.width/2)+2,this.pointToPixel(b.Q1,g),g.x+(g.width/2)+2,this.pointToPixel(b["min-whisker"],g),this.svg,[["stroke",c]]);
}SVG.drawLine(g.x,this.pointToPixel(b["min-whisker"],g),g.x+g.width,this.pointToPixel(b["min-whisker"],g),this.svg,[["stroke",c]]);}if(b["max-whisker"]!=null){if(this.isNumber(b.Q3)){SVG.drawLine(g.x+(g.width/2)+2,this.pointToPixel(b.Q3,g),g.x+(g.width/2)+2,this.pointToPixel(b["max-whisker"],g),this.svg,[["stroke",c]]);
}SVG.drawLine(g.x,this.pointToPixel(b["max-whisker"],g),g.x+g.width,this.pointToPixel(b["max-whisker"],g),this.svg,[["stroke",c]]);}if(b["above-outliers"]!=null){for(var a in b["above-outliers"]){SVG.drawCircle(g.x+(g.width/2)+2,this.pointToPixel(b["above-outliers"][a],g),this.pointRadius,this.svg,[["fill","red"],["fill-opacity","1"]]);
}}if(b["below-outliers"]!=null){for(var a in b["below-outliers"]){SVG.drawCircle(g.x+(g.width/2)+2,this.pointToPixel(b["below-outliers"][a],g),this.pointRadius,this.svg,[["fill","red"],["fill-opacity","1"]]);}}};BoxWhiskerGraph.prototype.plotClusterTitles=function(h){var b=this.left+this.rulerWidth;var f=this.data;
for(var g=0;g<f.clusters.length;g++){b=b+this.interClustersSpace;var k=f.clusters[g];var a=b;for(var d=0;d<k.classes.length;d++){var c=k.classes[d].color;this.drawSVGVerticalText(a+1/2*(h.classWidth),this.height-(this.bottom-this.clusterTitleHeight+(this.rulerHeight)),k.classes[d].name,[["style","font-size:x-small;"],["fill",c]]);
a=a+h.classWidth+this.interClassesSpace;}var e=(f.clusters[g].classes.length*h.classWidth)+((f.clusters[g].classes.length-1)*this.interClassesSpace);SVG.drawRectangle(b,this.height-(this.clusterTitleHeight+this.bottom),e,1,this.svg,[]);SVG.drawText(b,this.height-(this.bottom+(this.clusterTitleHeight*1/4)),f.clusters[g].name,this.svg,[["style","font-size:x-small"]]);
b=b+e;}};BoxWhiskerGraph.prototype.plotWhisters=function(f,e){var b=["yellow","orange","green"];var g=this.left+this.rulerWidth;for(var d=0;d<f.clusters.length;d++){var a=f.clusters[d];g=g+this.interClustersSpace;for(var c=0;c<a.classes.length;c++){this.plotBoxWhisker({name:a.classes[c].name,values:a.classes[c].values,minPoint:e.minPoint,maxPoint:e.maxPoint,x:g,y:this.top,width:e.classWidth,height:this.height-this.top-this.bottom-this.clusterTitleHeight-this.rulerHeight});
g=g+e.classWidth;if(c<a.classes.length-1){g=g+this.interClassesSpace;}}}};BoxWhiskerGraph.prototype.draw=function(a,c){this.targetId=a;var b=(this.getDimensions(c));this.svg=SVG.createSVGCanvas(document.getElementById(this.targetId),[["width",this.width],["height",this.height]]);this.plotAxes(b);this.plotClusterTitles(b);
this.plotWhisters(c,b);};BoxWhiskerGraph.prototype.input=function(){return DATADOC.getBoxWhikerData();};BoxWhiskerGraph.prototype.test=function(a){var b=new BoxWhiskerGraph({targetId:a,height:350,width:450,maxBoxWidth:25});b.refresh(this.input());};function DataSet(){this.json=null;}DataSet.prototype.loadFromJSON=function(a){if(a!=null){if(this.validate(a)){this.json=a;
}}};DataSet.prototype.toJSON=function(a){return this.json;};DataSet.prototype.validate=function(a){if(true){return true;}};Edge.prototype.getName=GraphItem.prototype.getName;Edge.prototype.setName=GraphItem.prototype.setName;Edge.prototype.getId=GraphItem.prototype.getId;function Edge(e,c,b,d,a){GraphItem.prototype.constructor.call(this,e,c,a);
this.sourceNode=b;this.targetNode=d;}Edge.prototype.toJSON=function(){return{"index":this.id,"sourceIndex":this.sourceNode.getId(),"targetIndex":this.targetNode.getId(),"args":this.args};};Edge.prototype.getNodeSource=function(){return this.sourceNode;};Edge.prototype.getNodeTarget=function(){return this.targetNode;
};Edge.prototype.remove=function(){this.getNodeSource().removeEdge(this);this.getNodeTarget().removeEdge(this);this.deleted.notify(this);};EdgeGraphFormatter.prototype.setProperties=ItemGraphFormatter.prototype.setProperties;EdgeGraphFormatter.prototype.getDefault=ItemGraphFormatter.prototype.getDefault;
EdgeGraphFormatter.prototype.getSelected=ItemGraphFormatter.prototype.getSelected;EdgeGraphFormatter.prototype.getOver=ItemGraphFormatter.prototype.getOver;EdgeGraphFormatter.prototype.getDragging=ItemGraphFormatter.prototype.getDragging;EdgeGraphFormatter.prototype.getId=ItemGraphFormatter.prototype.getId;
EdgeGraphFormatter.prototype.toJSON=ItemGraphFormatter.prototype.toJSON;EdgeGraphFormatter.prototype.loadFromJSON=ItemGraphFormatter.prototype.loadFromJSON;EdgeGraphFormatter.prototype._setEvents=ItemGraphFormatter.prototype._setEvents;function EdgeGraphFormatter(e,b,d,a,c){ItemGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);
this.getDefault().args.type="EdgeGraphFormatter";}LineEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;LineEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;LineEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;
LineEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;LineEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;LineEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;LineEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;
LineEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;LineEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;function LineEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);this.args.type="LineEdgeGraphFormatter";
}DirectedLineEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;DirectedLineEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;DirectedLineEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;DirectedLineEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;
DirectedLineEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;DirectedLineEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;DirectedLineEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;DirectedLineEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;
DirectedLineEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;function DirectedLineEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);this.args.type="DirectedLineEdgeGraphFormatter";this.args.arrowSize="3";}DirectedLineEdgeGraphFormatter.prototype.getArrowSize=function(){return this.args.arrowSize;
};OdirectedLineEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;OdirectedLineEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;OdirectedLineEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;OdirectedLineEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;
OdirectedLineEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;OdirectedLineEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;OdirectedLineEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;OdirectedLineEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;
OdirectedLineEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;function OdirectedLineEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);this.args.type="DirectedLineEdgeGraphFormatter";this.args.arrowSize="3";}OdirectedLineEdgeGraphFormatter.prototype.getArrowSize=function(){return this.args.arrowSize;
};CutDirectedLineEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;CutDirectedLineEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;CutDirectedLineEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;CutDirectedLineEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;
CutDirectedLineEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;CutDirectedLineEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;CutDirectedLineEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;CutDirectedLineEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;
CutDirectedLineEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;function CutDirectedLineEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);this.args.type="CutDirectedLineEdgeGraphFormatter";}BezierEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;
BezierEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;BezierEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;BezierEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;BezierEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;
BezierEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;BezierEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;BezierEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;BezierEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;
BezierEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;function BezierEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);this.args.type="BezierEdgeGraphFormatter";}DotDirectedLineEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;
DotDirectedLineEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;DotDirectedLineEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;DotDirectedLineEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;DotDirectedLineEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;
DotDirectedLineEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;DotDirectedLineEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;DotDirectedLineEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;DotDirectedLineEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;
function DotDirectedLineEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);this.args.type="DotDirectedLineEdgeGraphFormatter";}OdotDirectedLineEdgeGraphFormatter.prototype.setProperties=EdgeGraphFormatter.prototype.setProperties;OdotDirectedLineEdgeGraphFormatter.prototype.getDefault=EdgeGraphFormatter.prototype.getDefault;
OdotDirectedLineEdgeGraphFormatter.prototype.getSelected=EdgeGraphFormatter.prototype.getSelected;OdotDirectedLineEdgeGraphFormatter.prototype.getOver=EdgeGraphFormatter.prototype.getOver;OdotDirectedLineEdgeGraphFormatter.prototype.getDragging=EdgeGraphFormatter.prototype.getDragging;OdotDirectedLineEdgeGraphFormatter.prototype.getId=EdgeGraphFormatter.prototype.getId;
OdotDirectedLineEdgeGraphFormatter.prototype.toJSON=EdgeGraphFormatter.prototype.toJSON;OdotDirectedLineEdgeGraphFormatter.prototype.loadFromJSON=EdgeGraphFormatter.prototype.loadFromJSON;OdotDirectedLineEdgeGraphFormatter.prototype._setEvents=EdgeGraphFormatter.prototype._setEvents;function OdotDirectedLineEdgeGraphFormatter(e,b,d,a,c){EdgeGraphFormatter.prototype.constructor.call(this,e,b,d,a,c);
this.args.type="OdotDirectedLineEdgeGraphFormatter";}function GraphDataset(){DataSet.prototype.constructor.call(this);this.edges=new Object();this.vertices=new Object();this.verticesIndex=new Object();this.newVertex=new Event(this);this.vertexNameChanged=new Event(this);this.vertexDeleted=new Event(this);
this.newEdge=new Event(this);this.edgeNameChanged=new Event(this);this.edgeDeleted=new Event(this);this.json=new Object();this.json.vertices=new Array();this.json.edges=new Array();this.json.relations=new Array();}GraphDataset.prototype.loadFromJSON=DataSet.prototype.loadFromJSON;GraphDataset.prototype.toJSON=DataSet.prototype.toJSON;
GraphDataset.prototype.validate=DataSet.prototype.validate;GraphDataset.prototype.getMaxClass=function(){var b=0;for(var a in this.vertices){if(this.vertices[a].getEdgesCount()>b){b=this.vertices[a].getEdgesCount();}}return b;};GraphDataset.prototype.getMinClass=function(){var b=Math.min();for(var a in this.vertices){if(this.vertices[a].getEdgesCount()<b){b=this.vertices[a].getEdgesCount();
}}return b;};GraphDataset.prototype.getVertexByName=function(d){var b=new Array();for(var a in this.verticesIndex[d]){var c=this.getVertexById(this.verticesIndex[d][a]);b.push(c);return c;}if(b<=1){return this.getVertexById(this.verticesIndex[d]);}else{return b;}};GraphDataset.prototype.getVertexById=function(a){return this.vertices[a];
};GraphDataset.prototype.toSIF=function(){var a=new SifFileDataAdapter();return a.toSIF(this);};GraphDataset.prototype.toSIFID=function(){var a=new SifFileDataAdapter();return a.toSIFID(this);};GraphDataset.prototype.toDOT=function(){var a=new DotFileDataAdapter();return a.toDOT(this);};GraphDataset.prototype.toDOTID=function(){var a=new DotFileDataAdapter();
return a.toDOTID(this);};GraphDataset.prototype._addNode=function(b,a){return new Vertex(this._getVerticesCount()-1,b,a);};GraphDataset.prototype.addNode=function(c,a){this.json.vertices.push(c);this._addVerticesIndex(c,this._getVerticesCount()-1);var b=this._addNode(c,a);this.vertices[this._getVerticesCount()-1]=b;
this._setNodeEvents(b);this.newVertex.notify(b);};GraphDataset.prototype._addVerticesIndex=function(b,a){if(this.verticesIndex[b]==null){this.verticesIndex[b]=new Array();}this.verticesIndex[b].push(a);};GraphDataset.prototype.addEdge=function(a,g,f,d){this.json.edges.push(a);var c=this.getVertexById(g);
var e=this.getVertexById(f);var b=this.getEdgesCount()-1;this.edges[b]=new Edge(b,a,c,e,d);this.json.relations.push({"index":b,"sourceIndex":g,"targetIndex":f,"args":d});c.addEdge(this.edges[b]);e.addEdge(this.edges[b]);this._setEdgeEvents(this.edges[b]);this.newEdge.notify(this.edges[b]);};GraphDataset.prototype.getVertices=function(){return this.vertices;
};GraphDataset.prototype.getEdges=function(){return this.edges;};GraphDataset.prototype.getEdgeById=function(a){return this.edges[a];};GraphDataset.prototype._getVerticesCount=function(){return this.json.vertices.length;};GraphDataset.prototype.getVerticesCount=function(){var a=0;for(var b in this.getVertices()){a++;
}return a;};GraphDataset.prototype.getEdgesCount=function(){return this.json.edges.length;};GraphDataset.prototype.init=function(){this.edges=new Object();this.vertices=new Object();};GraphDataset.prototype._setNodeEvents=function(a){var b=this;a.deleted.attach(function(c,d){b._removeNode(d);});a.nameChanged.attach(function(g,e){var h=e.item;
var c=h.name;var d=b.verticesIndex[e.previousName];for(var f=0;f<d.length;f++){if(d[f]==h.id){d.splice(f,1);}}if(d.length==0){delete b.verticesIndex[e.previousName];}b._addVerticesIndex(c,h.id);b.json.vertices[h.id]=c;b.vertexNameChanged.notify(e);});};GraphDataset.prototype._setEdgeEvents=function(a){var b=this;
a.nameChanged.attach(function(c,d){b.edgeNameChanged.notify(d);});a.deleted.attach(function(c,d){b._removeEdge(d);});};GraphDataset.prototype._connectVerticesByName=function(c,d){var a=this.getVertexByName(c);var b=this.getVertexByName(d);if((a!=null)&&(b!=null)){this.addEdge(a.getName()+"_"+b.getName(),a.getId(),b.getId(),{});
}else{if(a==null){console.log("No encontrado: "+c);}if(b==null){console.log("No encontrado: "+d);}}};GraphDataset.prototype.loadFromJSON=function(c){var c=c;this.init();this.json=new Object();this.json.vertices=new Array();this.json.edges=new Array();this.json.relations=new Array();for(var b=0;b<c.nodes.length;
b++){if(c.nodes[b]!=null){var a=c.nodes[b];this.addNode(a);}else{this.json.vertices.push(null);}}for(var b=0;b<c.edges.length;b++){if(c.edges[b]!=null){if(c.relations[b]!=null){var a=c.edges[b];this.addEdge(a,c.relations[b].sourceIndex,c.relations[b].targetIndex,c.relations[b].args);}}else{this.json.edges.push(null);
this.json.relations.push(null);}}};GraphDataset.prototype.prettyPrint=function(){for(var b in this.vertices){console.log(this.vertices[b].getName());for(var a=0;a<this.vertices[b].getEdgesIn().length;a++){console.log("          --> "+this.vertices[b].getEdgesIn()[a].getNodeTarget().getName());}}};GraphDataset.prototype._removeEdge=function(a){this.json.edges[a.getId()]=null;
this.json.relations[a.getId()]=null;delete this.edges[a.getId()];this.edgeDeleted.notify(a);};GraphDataset.prototype._removeNode=function(a){this.json.vertices[a.getId()]=null;delete this.vertices[a.getId()];this.vertexDeleted.notify(a);};GraphDataset.prototype.toJSON=function(){var b=new Object();var a=new Array();
b.nodes=this.json.vertices;b.edges=this.json.edges;b.relations=this.json.relations;return b;};GraphDataset.prototype.clone=function(){var a=new GraphDataset();a.loadFromJSON(this.toJSON());return a;};function labels(){var j=new Array();var c=interactomeViewer.graphEditorWidget.dataset;var e=interactomeViewer.graphEditorWidget.layout;
for(var g in interactomeViewer.graphEditorWidget.dataset.getVertices()){j.push(interactomeViewer.graphEditorWidget.dataset.getVertexById(g).getName());}var f=(j.sort());console.log(f);var a=0.01;var h=0.6;for(var d=0;d<j.length;d++){var b=c.getVertexByName(j[d]).getId();e.getNodeById(b).setCoordenates(a,h);
a=parseFloat(a)+parseFloat(0.03);h=parseFloat(h)+parseFloat(0.02);if(parseFloat(h)==0.9800000000000003){h=0.6;a=a-0.51;}}}function GraphItem(c,b,a){this.id=c;this.name=b;this.type="NONE";this.args=new Object();if(a!=null){this.args=a;if(a.type!=null){this.type=a.type;}}this.nameChanged=new Event(this);
this.deleted=new Event(this);}GraphItem.prototype.getName=function(){return this.name;};GraphItem.prototype.getId=function(){return this.id;};GraphItem.prototype.setName=function(a){var b=this.getName();this.name=a;this.nameChanged.notify({"item":this,"previousName":b});};function ItemGraphFormatter(f,c,d,b,a){this.id=f;
this.args=new Object();this.defaultFormat=new ItemFormat(c);if(d!=null){this.selected=new ItemFormat(d);}else{this.selected=new ItemFormat(c);}if(b!=null){this.over=new ItemFormat(b);}else{this.over=new ItemFormat(c);}if(a!=null){this.dragging=new ItemFormat(a);}else{this.dragging=new ItemFormat(c);}this.stateChanged=new Event(this);
var e=this;this._setEvents();}ItemGraphFormatter.prototype.getType=function(){return this.args.type;};ItemGraphFormatter.prototype.toJSON=function(){var a=this.args;a.defaultFormat=this.getDefault().toJSON();a.over=this.getOver().toJSON();a.selected=this.getSelected().toJSON();a.dragging=this.getDragging().toJSON();
a.id=this.id;return a;};ItemGraphFormatter.prototype.loadFromJSON=function(a){this.args=a;this.defaultFormat=new ItemFormat(a.defaultFormat);this.over=new ItemFormat(a.over);this.selected=new ItemFormat(a.selected);this.dragging=new ItemFormat(a.dragging);this._setEvents();};ItemGraphFormatter.prototype._setEvents=function(){var a=this;
this.defaultFormat.changed.attach(function(b,c){a.over.setSize(a.defaultFormat.getSize());a.selected.setSize(a.defaultFormat.getSize());a.dragging.setSize(a.defaultFormat.getSize());a.stateChanged.notify(a);});this.selected.changed.attach(function(b,c){a.stateChanged.notify(a);});this.over.changed.attach(function(b,c){a.stateChanged.notify(a);
});this.dragging.changed.attach(function(b,c){a.stateChanged.notify(a);});};ItemGraphFormatter.prototype.getId=function(){return this.id;};ItemGraphFormatter.prototype.getDefault=function(){return this.defaultFormat;};ItemGraphFormatter.prototype.getSelected=function(){return this.selected;};ItemGraphFormatter.prototype.getOver=function(){return this.over;
};ItemGraphFormatter.prototype.getDragging=function(){return this.dragging;};function ItemFormat(a){this.defaultFormat=new Object();this.args=new Object();this.args.title=new Object();this.args.visible=true;this.args.hidden=false;this.args.stroke="#000000";this.args.strokeOpacity=0.8;this.args["stroke-width"]=1;
this.args.fill="#000000";this.args["fill-opacity"]=1;this.args.size=1;this.args.opacity=1;this.args.fontSize="8";this.args.fontColor="#000000";if(a!=null){if(a.visible!=null){this.args.visible=a.visible;}if(a.opacity!=null){this.args.opacity=a.opacity;}if(a.size!=null){this.args.size=a.size;}if(a.hidden!=null){this.args.hidden=a.hidden;
}if(a.stroke!=null){this.args.stroke=this._fixColor(a.stroke);}if(a.strokeOpacity!=null){this.args.strokeOpacity=a.strokeOpacity;}if(a["stroke-width"]!=null){this.args["stroke-width"]=a["stroke-width"];}if(a["fill-opacity"]!=null){this.args["fill-opacity"]=a["fill-opacity"];}if(a.shape!=null){this.args.shape=a.shape;
}if(a.fill!=null){this.args.fill=this._fixColor(a.fill);}if(a.title!=null){if(a.title.fontSize!=null){this.args.title.fontSize=a.title.fontSize;}if(a.title.fill!=null){this.args.title.fill=this._fixColor(a.title.fill);}}}this.changed=new Event();}ItemFormat.prototype._fixColor=function(a){var b=a;if(a.indexOf("green")!=-1){b="#04B431";
}if(a.indexOf("blue")!=-1){b="#045FB4";}if(a.indexOf("red")!=-1){b="#DF0101";}if(a.indexOf("black")!=-1){b="#000000";}if(a.indexOf("white")!=-1){b="#FFFFFF";}if(a.indexOf("#")==-1){b="#"+a;}return b;};ItemFormat.prototype.toJSON=function(){if(this.args.strokeOpacity!=null){this.args["stroke-opacity"]=this.args.strokeOpacity;
delete this.args.strokeOpacity;}if(this.args.title.fontColor!=null){this.args.title["font-color"]=this.args.title.fontColor;}else{this.args.title["font-color"]=this.args.fontColor;}if(this.args.title.fontSize!=null){this.args.title["font-size"]=this.args.title.fontSize;}else{this.args.title["font-size"]=this.args.fontSize;
}return this.args;};ItemFormat.prototype.getAttribute=function(a){return this.args[a];};ItemFormat.prototype.setVisible=function(a){if(this.args.visible!=a){this.args.visible=a;this.changed.notify(this);}};ItemFormat.prototype.getVisible=function(){return this.args.visible;};ItemFormat.prototype.setHidden=function(a){if(this.args.hidden!=a){this.args.hidden=a;
this.changed.notify(this);}};ItemFormat.prototype.getHidden=function(){return this.args.hidden;};ItemFormat.prototype.setStroke=function(a){if(this.args.stroke!=a){this.args.stroke=a;this.changed.notify(this);}};ItemFormat.prototype.getStroke=function(){return this.args.stroke;};ItemFormat.prototype.setStrokeOpacity=function(a){if(this.args.strokeOpacity!=a){this.args.strokeOpacity=a;
this.changed.notify(this);}};ItemFormat.prototype.getStrokeOpacity=function(){return this.args["stroke-opacity"];};ItemFormat.prototype.setStrokeWidth=function(a){if(this.args["stroke-width"]!=a){this.args["stroke-width"]=a;this.changed.notify(this);}};ItemFormat.prototype.getFillOpacity=function(){return this.args["fill-opacity"];
};ItemFormat.prototype.setfillOpacity=function(a){if(this.args["fill-opacity"]!=a){this.args["fill-opacity"]=a;this.changed.notify(this);}};ItemFormat.prototype.getStrokeWidth=function(){return this.args["stroke-width"];};ItemFormat.prototype.setFill=function(a){if(this.args.fill!=a){this.args.fill=a;
this.changed.notify(this);}};ItemFormat.prototype.getFill=function(){return this.args.fill;};ItemFormat.prototype.setSize=function(a){if(this.args.size!=a){this.args.size=a;this.changed.notify(this);}};ItemFormat.prototype.getSize=function(){return this.args.size;};ItemFormat.prototype.setOpacity=function(a){if(this.args.opacity!=a){this.args.opacity=a;
this.changed.notify(this);}};ItemFormat.prototype.getOpacity=function(){return this.args.opacity;};ItemFormat.prototype.getArrowSize=function(){return this.args.arrowSize;};ItemFormat.prototype.setArrowSize=function(a){if(this.args.arrowSize!=a){this.args.arrowSize=a;this.changed.notify(this);}};ItemFormat.prototype.getFontSize=function(){return this.args.title.fontSize;
};ItemFormat.prototype.setFontSize=function(a){if(this.args.title.fontSize!=a){this.args.title.fontSize=a;this.changed.notify(this);}};function LayoutDataset(){this.dataset=null;this.vertices=new Object();this.changed=new Event(this);this.args=new Object();this.args.type="CIRCLE";}LayoutDataset.prototype.loadFromJSON=function(c,a){var d=this;
this.vertices=new Object();this.dataset=c;for(var b in a){this.vertices[b]=new NodeLayout(b,a[b].x,a[b].y);this.vertices[b].changed.attach(function(e,f){d.changed.notify(f);});}this._attachDatasetEvents();};LayoutDataset.prototype.toJSON=function(){var a=new Object();for(var b in this.vertices){a[b]=new Object();
a[b].x=this.vertices[b].x;a[b].y=this.vertices[b].y;}a.dataset=new Object();a.dataset=this.dataset.toJSON();return a;};LayoutDataset.prototype.dataBind=function(a){this.dataset=a;this._attachDatasetEvents();this._calculateLayout();};LayoutDataset.prototype._removeVertex=function(a){delete this.vertices[a];
};LayoutDataset.prototype._attachDatasetEvents=function(){var a=this;this.dataset.vertexDeleted.attach(function(b,c){a._removeVertex(c.getId());});this.dataset.newVertex.attach(function(b,c){a.vertices[c.getId()]=new NodeLayout(c.getId(),0.5,0.5);a.vertices[c.getId()].changed.attach(function(d,e){a.changed.notify(e);
});});};LayoutDataset.prototype.getType=function(){return this.args.type;};LayoutDataset.prototype._calculateLayoutVertices=function(d,e){if(d=="CIRCLE"){var a=0.4;var g=0.5;var f=0.5;var b=new Array();for(var c=0;c<e;c++){x=g+a*Math.sin(c*2*Math.PI/e);y=f+a*Math.cos(c*2*Math.PI/e);b.push({"x":x,"y":y});
}return b;}};LayoutDataset.prototype._calculateLayout=function(){var k=this;if(this.getType()=="RANDOM"){for(var h in this.dataset.getVertices()){if(this.vertices[h]==null){this.vertices[h]=new NodeLayout(h,0,0);}this.vertices[h].setCoordinates(Math.random(),Math.random());this.vertices[h].changed.attach(function(i,j){k.changed.notify(j);
});}}if(this.getType()=="CIRCLE"){var l=this.dataset._getVerticesCount();var n=this._calculateLayoutVertices(this.getType(),l);var b=0;for(var h in this.dataset.getVertices()){if(this.vertices[h]==null){this.vertices[h]=new NodeLayout(h,0,0);}this.vertices[h].setCoordinates(n[b].x,n[b].y);b++;this.vertices[h].changed.attach(function(i,j){k.changed.notify(j);
});}}if(this.getType()=="SQUARE"){var l=this.dataset._getVerticesCount();var a=0.1;var g=0.9;var m=0.1;var d=0.9;var o=Math.sqrt(l);var c=(g-a)/o;var n=new Array();for(var f=0;f<o;f++){for(var e=0;e<o;e++){x=f*c+a;y=e*c+m;n.push({"x":x,"y":y});}}var b=0;for(var h in this.dataset.getVertices()){if(this.vertices[h]==null){this.vertices[h]=new NodeLayout(h,0,0);
}this.vertices[h].setCoordinates(n[b].x,n[b].y);b++;this.vertices[h].changed.attach(function(i,j){k.changed.notify(j);});}}};LayoutDataset.prototype.getNodeById=function(a){return this.vertices[a];};LayoutDataset.prototype.getVerticesByArea=function(c,e,a,d){var b=new Array();for(var f in this.dataset.getVertices()){if((this.vertices[f].x>=c)&&(this.vertices[f].x<=a)){if((this.vertices[f].y>=e)&&(this.vertices[f].y<=d)){b.push(this.vertices[f]);
}}}return b;};LayoutDataset.prototype.getLayout=function(b){if(b=="CIRCLE"){this.args.type="CIRCLE";this._calculateLayout();return;}if(b=="SQUARE"){this.args.type="SQUARE";this._calculateLayout();return;}if(b=="RANDOM"){this.args.type="RANDOM";this._calculateLayout();return;}var c=this.dataset.toDOTID();
var a="http://bioinfo.cipf.es/utils/ws/rest/network/layout/"+b+".coords";var d=this;$.ajax({async:true,type:"POST",url:a,dataType:"text",data:{dot:c},cache:false,success:function(g){var f=JSON.parse(g);for(var e in f){d.vertices[e].setCoordinates(f[e].x,f[e].y);}}});};function NodeLayout(d,a,c,b){this.id=d;
this.x=a;this.y=c;this.changed=new Event(this);}NodeLayout.prototype.getId=function(a){return this.id;};NodeLayout.prototype.setCoordinates=function(a,b){this.x=a;this.y=b;this.changed.notify(this);};function NetworkDataSetFormatter(c,a,b){DataSet.prototype.constructor.call(this);this.args=new Object();
this.vertices=new Object();this.edges=new Object();this.dataset=null;this.maxClass=0;this.minClass=0;this.args.width=1100;this.args.height=500;this.args.backgroundColor="#FFFFFF";this.args.backgroundImage=null;this.args.backgroundImageHeight=null;this.args.backgroundImageWidth=null;this.args.backgroundImageX=null;
this.args.backgroundImageY=null;this.args.balanceNodes=false;this.args.nodesMaxSize=3;this.args.nodesMinSize=0.5;this.args.zoomScale=1;this.args.zoomScaleStepFactor=0.4;if(b!=null){if(b.backgroundImage!=null){this.args.backgroundImage=b.backgroundImage;}if(b.width!=null){this.args.width=b.width;}if(b.height!=null){this.args.height=b.height;
this.args.svgHeight=b.height;}if(b.svgHeight!=null){this.args.svgHeight=b.svgHeight;}if(b.backgroundColor!=null){this.args.backgroundColor=b.backgroundColor;}if(b.balanceNodes!=null){this.args.balanceNodes=b.balanceNodes;}if(b.nodesMaxSize!=null){this.args.nodesMaxSize=b.nodesMaxSize;}if(b.nodesMinSize!=null){this.args.nodesMinSize=b.nodesMinSize;
}}this.args.defaultEdgeProperties={"fill":"#000000","radius":"1","stroke":"#000000","size":1,"title":{"fontSize":10,"fontColor":"#000000"}};this.args.vertexFormatProperties={"fill":"#000000","stroke":"#000000","stroke-opacity":"#000000"};if(c!=null){this.args.vertexFormatProperties=c;}if(a!=null){this.args.defaultEdgeProperties=a;
}this.changed=new Event(this);this.edgeChanged=new Event(this);this.resized=new Event(this);this.backgroundImageChanged=new Event(this);this.backgroundColorChanged=new Event(this);}NetworkDataSetFormatter.prototype.loadFromJSON=function(c,a){this.args=new Object();this.vertices=new Object();this.args=a;
this._setDataset(c);var e=this;for(var b in a.vertices){this.addVertex(b,a.vertices[b]);}for(var d in a.edges){this.addEdge(d,a.edges[d]);}};NetworkDataSetFormatter.prototype.toJSON=function(){var a=new Object();a=JSON.parse(JSON.stringify(this.args));a.vertices=new Object();a.edges=new Object();for(var c in this.vertices){a.vertices[c]=this.getVertexById(c).toJSON();
}for(var b in this.edges){a.edges[b]=this.getEdgeById(b).toJSON();}return(a);};NetworkDataSetFormatter.prototype._getNodeSize=function(c){if(this.isVerticesBalanced()){var b=this.maxClass-this.minClass;if(b==0){b=1;}var a=this.dataset.getVertexById(c).getEdges().length;return((a*this.args.nodesMaxSize)/b)+this.args.nodesMinSize;
}return this.getVertexById(c).getDefault().getSize();};NetworkDataSetFormatter.prototype._recalculateSize=function(){if(this.isVerticesBalanced()){this.maxClass=this.dataset.getMaxClass();this.minClass=this.dataset.getMinClass();for(var a in this.vertices){var b=this._getNodeSize(a);this.vertices[a].getDefault().setSize(b);
this.vertices[a].getSelected().setSize(b);this.vertices[a].getOver().setSize(b);}}};NetworkDataSetFormatter.prototype.addVertex=function(a,c){if(c==null){this.vertices[a]=new CircleVertexGraphFormatter(a,this.args.vertexFormatProperties.defaultFormat,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);
}else{if(c.type==null){this.vertices[a]=new CircleVertexGraphFormatter(a,this.args.vertexFormatProperties.defaultFormat,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);}if((c.type=="SquareVertexGraphFormatter")||(c.type=="SquareVertexNetworkFormatter")){this.vertices[a]=new SquareVertexGraphFormatter(a);
this.vertices[a].loadFromJSON(c);}if((c.type=="CircleVertexGraphFormatter")||(c.type=="CircleVertexNetworkFormatter")){this.vertices[a]=new CircleVertexGraphFormatter(a);this.vertices[a].loadFromJSON(c);}if((c.type=="EllipseVertexGraphFormatter")||(c.type=="EllipseVertexNetworkFormatter")){this.vertices[a]=new EllipseVertexGraphFormatter(a);
this.vertices[a].loadFromJSON(c);}if((c.type=="RectangleVertexGraphFormatter")||(c.type=="RectangleVertexNetworkFormatter")){this.vertices[a]=new RectangleVertexGraphFormatter(a);this.vertices[a].loadFromJSON(c);}if((c.type=="RoundedVertexGraphFormatter")||(c.type=="RoundedVertexNetworkFormatter")){this.vertices[a]=new RoundedVertexGraphFormatter(a);
this.vertices[a].loadFromJSON(c);}}var d=this;this.vertices[a].stateChanged.attach(function(e,f){d.changed.notify(f);});var b=this._getNodeSize(a);this.vertices[a].defaultFormat.args.size=b;this.vertices[a].selected.args.size=b;this.vertices[a].over.args.size=b;};NetworkDataSetFormatter.prototype.addEdge=function(b,a){if(a==null){if(this.dataset.getEdgeById(b).getNodeSource().getId()==this.dataset.getEdgeById(b).getNodeTarget().getId()){this.edges[b]=new BezierEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}else{this.edges[b]=new DirectedLineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);}}else{if(a.type==null){this.edges[b]=new LineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}if((a.type=="LineEdgeGraphFormatter")||(a.type=="LineEdgeNetworkFormatter")){this.edges[b]=new LineEdgeGraphFormatter(b);this.edges[b].loadFromJSON(a);}if((a.type=="DirectedLineEdgeGraphFormatter")||(a.type=="DirectedLineEdgeNetworkFormatter")){this.edges[b]=new DirectedLineEdgeGraphFormatter(b);this.edges[b].loadFromJSON(a);
}if((a.type=="BezierEdgeGraphFormatter")||(a.type=="BezierEdgeNetworkFormatter")){this.edges[b]=new BezierEdgeGraphFormatter(b);this.edges[b].loadFromJSON(a);}if((a.type=="CutDirectedLineEdgeGraphFormatter")||(a.type=="CutDirectedLineEdgeNetworkFormatter")){this.edges[b]=new CutDirectedLineEdgeGraphFormatter(b);
this.edges[b].loadFromJSON(a);}if((a.type=="DotDirectedLineEdgeGraphFormatter")||(a.type=="DotDirectedLineEdgeNetworkFormatter")){this.edges[b]=new DotDirectedLineEdgeGraphFormatter(b);this.edges[b].loadFromJSON(a);}if((a.type=="OdotDirectedLineEdgeGraphFormatter")||(a.type=="OdotDirectedLineEdgeNetworkFormatter")){this.edges[b]=new OdotDirectedLineEdgeGraphFormatter(b);
this.edges[b].loadFromJSON(a);}if((a.type=="OdirectedLineEdgeGraphFormatter")||(a.type=="OdirectedLineEdgeNetworkFormatter")){this.edges[b]=new OdirectedLineEdgeGraphFormatter(b);this.edges[b].loadFromJSON(a);}}var c=this;this.edges[b].stateChanged.attach(function(d,e){c.edgeChanged.notify(e);});this._recalculateSize();
};NetworkDataSetFormatter.prototype._setDataset=function(a){this.dataset=a;this.maxClass=a.getMaxClass();this.minClass=a.getMinClass();this._attachDatasetEvents();};NetworkDataSetFormatter.prototype.changeEdgeType=function(b,a){if((a=="LineEdgeGraphFormatter")||(a=="LineEdgeNetworkFormatter")){this.edges[b]=new LineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}if((a=="DirectedLineEdgeGraphFormatter")||(a=="DirectedLineEdgeNetworkFormatter")){this.edges[b]=new DirectedLineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}if((a=="CutDirectedLineEdgeGraphFormatter")||(a=="CutDirectedLineEdgeNetworkFormatter")){this.edges[b]=new CutDirectedLineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}if((a=="DotDirectedLineEdgeGraphFormatter")||(a=="DotDirectedLineEdgeNetworkFormatter")){this.edges[b]=new DotDirectedLineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}if((a=="OdotDirectedLineEdgeGraphFormatter")||(a=="OdotDirectedLineEdgeNetworkFormatter")){this.edges[b]=new OdotDirectedLineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}if((a=="OdirectedLineEdgeGraphFormatter")||(a=="OdirectedLineEdgeNetworkFormatter")){this.edges[b]=new OdirectedLineEdgeGraphFormatter(b,this.args.defaultEdgeProperties.defaultFormat,this.args.defaultEdgeProperties.selected,this.args.defaultEdgeProperties.over,this.args.defaultEdgeProperties.dragging);
}var c=this;this.edges[b].stateChanged.attach(function(d,e){c.edgeChanged.notify(e);});c.edgeChanged.notify(this.edges[b]);};NetworkDataSetFormatter.prototype.changeNodeType=function(a,c){var b=JSON.parse(JSON.stringify(this.vertices[a].getDefault()));var d=JSON.parse(JSON.stringify(this.vertices[a].getSelected()));
var b=JSON.parse(JSON.stringify(this.vertices[a].getDefault()));var b=JSON.parse(JSON.stringify(this.vertices[a].getDefault()));if((c=="SquareVertexGraphFormatter")||(c=="SquareVertexNetworkFormatter")){this.vertices[a]=new SquareVertexGraphFormatter(a,b,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);
}if((c=="CircleVertexGraphFormatter")||(c=="CircleVertexNetworkFormatter")){this.vertices[a]=new CircleVertexGraphFormatter(a,b,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);}if((c=="EllipseVertexGraphFormatter")||(c=="EllipseVertexNetworkFormatter")){this.vertices[a]=new EllipseVertexGraphFormatter(a,b,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);
}if((c=="RectangleVertexGraphFormatter")||(c=="RectangleVertexNetworkFormatter")){this.vertices[a]=new RectangleVertexGraphFormatter(a,b,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);}if((c=="RoundedVertexGraphFormatter")||(c=="RoundedVertexNetworkFormatter")){this.vertices[a]=new RoundedVertexGraphFormatter(a,b,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);
}if((c=="OctagonVertexGraphFormatter")||(c=="OctagonVertexNetworkhFormatter")){this.vertices[a]=new OctagonVertexGraphFormatter(a,b,this.args.vertexFormatProperties.selected,this.args.vertexFormatProperties.over,this.args.vertexFormatProperties.dragging);}var e=this;this.vertices[a].stateChanged.attach(function(f,g){e.changed.notify(g);
});e.changed.notify(this.vertices[a]);};NetworkDataSetFormatter.prototype.dataBind=function(a){var d=this;this._setDataset(a);for(var c in this.dataset.getVertices()){this.addVertex(c);}for(var b in this.dataset.getEdges()){this.addEdge(b);}};NetworkDataSetFormatter.prototype._removeEdge=function(a){delete this.edges[a];
};NetworkDataSetFormatter.prototype._removeVertex=function(a){delete this.vertices[a];};NetworkDataSetFormatter.prototype._attachDatasetEvents=function(b){var a=this;this.dataset.vertexDeleted.attach(function(c,d){a._removeVertex(d.getId());});this.dataset.edgeDeleted.attach(function(c,d){a._removeEdge(d.getId());
});this.dataset.newVertex.attach(function(c,d){a.addVertex(d.getId());});this.dataset.newEdge.attach(function(c,d){a.addEdge(d.getId());});};NetworkDataSetFormatter.prototype.getVertexById=function(a){return this.vertices[a];};NetworkDataSetFormatter.prototype.getEdgeById=function(a){return this.edges[a];
};NetworkDataSetFormatter.prototype.makeLabelsBigger=function(){for(var a in this.vertices){var b=this.vertices[a].getDefault().getFontSize()+2;this.vertices[a].getDefault().setFontSize(b);}};NetworkDataSetFormatter.prototype.makeLabelsSmaller=function(){for(var a in this.vertices){var b=this.vertices[a].getDefault().getFontSize()-2;
this.vertices[a].getDefault().setFontSize(b);}};NetworkDataSetFormatter.prototype.resize=function(b,a){this.args.width=b;this.args.height=a;this.resized.notify();};NetworkDataSetFormatter.prototype.getZoomScaleStepFactor=function(){return this.args.zoomScaleStepFactor;};NetworkDataSetFormatter.prototype.setZoomScaleStepFactor=function(a){this.args.zoomScaleStepFactor=a;
};NetworkDataSetFormatter.prototype.getZoomScale=function(){return this.args.zoomScale;};NetworkDataSetFormatter.prototype.setZoomScale=function(a){this.args.zoomScale=a;};NetworkDataSetFormatter.prototype.getNodesMaxSize=function(){return this.args.nodesMaxSize;};NetworkDataSetFormatter.prototype.getNodesMinSize=function(){return this.args.nodesMinSize;
};NetworkDataSetFormatter.prototype.isVerticesBalanced=function(){return this.args.balanceNodes;};NetworkDataSetFormatter.prototype.getWidth=function(){return this.args.width;};NetworkDataSetFormatter.prototype.getHeight=function(){return this.args.height;};NetworkDataSetFormatter.prototype.getBackgroundImage=function(){return this.args.backgroundImage;
};NetworkDataSetFormatter.prototype.setBackgroundImage=function(a){this.args.backgroundImage=a;this.backgroundImageChanged.notify(this);};NetworkDataSetFormatter.prototype.getBackgroundImageWidth=function(){return this.args.backgroundImageWidth;};NetworkDataSetFormatter.prototype.setBackgroundImageWidth=function(a){this.args.backgroundImageWidth=a;
this.backgroundImageChanged.notify(this);};NetworkDataSetFormatter.prototype.getBackgroundImageHeight=function(){return this.args.backgroundImageHeight;};NetworkDataSetFormatter.prototype.setBackgroundImageHeight=function(a){this.args.backgroundImageHeight=a;this.backgroundImageChanged.notify(this);};
NetworkDataSetFormatter.prototype.getBackgroundImageX=function(){return this.args.backgroundImageX;};NetworkDataSetFormatter.prototype.setBackgroundImageX=function(a){this.args.backgroundImageX=a;this.backgroundImageChanged.notify(this);};NetworkDataSetFormatter.prototype.getBackgroundImageY=function(){return this.args.backgroundImageX;
};NetworkDataSetFormatter.prototype.setBackgroundImageY=function(a){this.args.backgroundImageY=a;this.backgroundImageChanged.notify(this);};NetworkDataSetFormatter.prototype.getBackgroundColor=function(){return this.args.backgroundColor;};NetworkDataSetFormatter.prototype.setBackgroundColor=function(a){this.args.backgroundColor=a;
this.backgroundColorChanged.notify(this);};NetworkDataSetFormatter.prototype.getWidth=function(){return this.args.width;};NetworkDataSetFormatter.prototype.setWidth=function(a){this.args.width=a;};NetworkDataSetFormatter.prototype.getHeight=function(){return this.args.height;};NetworkDataSetFormatter.prototype.setHeight=function(a){this.args.height=a;
};Vertex.prototype.getName=GraphItem.prototype.getName;Vertex.prototype.setName=GraphItem.prototype.setName;Vertex.prototype.getId=GraphItem.prototype.getId;function Vertex(c,b,a){GraphItem.prototype.constructor.call(this,c,b,a);this.edgesIn=new Array();this.edgesOut=new Array();}Vertex.prototype.getEdges=function(){return this.edgesIn.concat(this.edgesOut);
};Vertex.prototype.getEdgesCount=function(){return this.getEdges().length;};Vertex.prototype.getEdgesIn=function(){return this.edgesIn;};Vertex.prototype.getEdgesOut=function(){return this.edgesOut;};Vertex.prototype.addEdge=function(a){if(a.getNodeSource().getId()==this.id){this.edgesIn.push(a);}else{this.edgesOut.push(a);
}};Vertex.prototype.removeEdge=function(b){for(var a=0;a<this.getEdgesIn().length;a++){var c=this.edgesIn[a];if(c.getId()==b.getId()){this.edgesIn.splice(a,1);}}for(var a=0;a<this.getEdgesOut().length;a++){var c=this.edgesOut[a];if(c.getId()==b.getId()){this.edgesOut.splice(a,1);}}};Vertex.prototype.remove=function(){var a=this.getEdges();
for(var b=0;b<a.length;b++){var c=a[b];c.remove();}this.deleted.notify(this);};VertexGraphFormatter.prototype.getDefault=ItemGraphFormatter.prototype.getDefault;VertexGraphFormatter.prototype.getSelected=ItemGraphFormatter.prototype.getSelected;VertexGraphFormatter.prototype.getOver=ItemGraphFormatter.prototype.getOver;
VertexGraphFormatter.prototype.getDragging=ItemGraphFormatter.prototype.getDragging;VertexGraphFormatter.prototype.getId=ItemGraphFormatter.prototype.getId;VertexGraphFormatter.prototype.toJSON=ItemGraphFormatter.prototype.toJSON;VertexGraphFormatter.prototype.loadFromJSON=ItemGraphFormatter.prototype.loadFromJSON;
VertexGraphFormatter.prototype._setEvents=ItemGraphFormatter.prototype._setEvents;function VertexGraphFormatter(c,d,b,a){ItemGraphFormatter.prototype.constructor.call(this,c,d,b,a);}CircleVertexGraphFormatter.prototype.getDefault=VertexGraphFormatter.prototype.getDefault;CircleVertexGraphFormatter.prototype.getSelected=VertexGraphFormatter.prototype.getSelected;
CircleVertexGraphFormatter.prototype.getOver=VertexGraphFormatter.prototype.getOver;CircleVertexGraphFormatter.prototype.getDragging=VertexGraphFormatter.prototype.getDragging;CircleVertexGraphFormatter.prototype.getId=VertexGraphFormatter.prototype.getId;CircleVertexGraphFormatter.prototype.toJSON=VertexGraphFormatter.prototype.toJSON;
CircleVertexGraphFormatter.prototype.loadFromJSON=VertexGraphFormatter.prototype.loadFromJSON;CircleVertexGraphFormatter.prototype._setEvents=VertexGraphFormatter.prototype._setEvents;function CircleVertexGraphFormatter(e,c,d,b,a){VertexGraphFormatter.prototype.constructor.call(this,e,c,d,b,a);this.args.type="CircleVertexGraphFormatter";
if(c!=null){if(c.radius!=null){this.defaultFormat.args.radius=c.radius;}}if(d!=null){if(d.radius!=null){this.selected.args.radius=d.radius;}}if(b!=null){if(b.radius!=null){this.over.args.radius=b.radius;}}if(a!=null){if(a.radius!=null){this.dragging.args.draggingFormat=a.radius;}}}SquareVertexGraphFormatter.prototype.getDefault=VertexGraphFormatter.prototype.getDefault;
SquareVertexGraphFormatter.prototype.getSelected=VertexGraphFormatter.prototype.getSelected;SquareVertexGraphFormatter.prototype.getOver=VertexGraphFormatter.prototype.getOver;SquareVertexGraphFormatter.prototype.getDragging=VertexGraphFormatter.prototype.getDragging;SquareVertexGraphFormatter.prototype.getId=VertexGraphFormatter.prototype.getId;
SquareVertexGraphFormatter.prototype.toJSON=VertexGraphFormatter.prototype.toJSON;SquareVertexGraphFormatter.prototype.loadFromJSON=VertexGraphFormatter.prototype.loadFromJSON;SquareVertexGraphFormatter.prototype._setEvents=VertexGraphFormatter.prototype._setEvents;function SquareVertexGraphFormatter(e,c,d,b,a){VertexGraphFormatter.prototype.constructor.call(this,e,c,d,b,a);
this.args.type="SquareVertexGraphFormatter";if(c!=null){if(c.radius!=null){this.defaultFormat.args.radius=c.radius;}}if(d!=null){if(d.radius!=null){this.selected.args.radius=d.radius;}}if(b!=null){if(b.radius!=null){this.over.args.radius=b.radius;}}if(a!=null){if(a.radius!=null){this.dragging.args.draggingFormat=a.radius;
}}}EllipseVertexGraphFormatter.prototype.getDefault=VertexGraphFormatter.prototype.getDefault;EllipseVertexGraphFormatter.prototype.getSelected=VertexGraphFormatter.prototype.getSelected;EllipseVertexGraphFormatter.prototype.getOver=VertexGraphFormatter.prototype.getOver;EllipseVertexGraphFormatter.prototype.getDragging=VertexGraphFormatter.prototype.getDragging;
EllipseVertexGraphFormatter.prototype.getId=VertexGraphFormatter.prototype.getId;EllipseVertexGraphFormatter.prototype.toJSON=VertexGraphFormatter.prototype.toJSON;EllipseVertexGraphFormatter.prototype.loadFromJSON=VertexGraphFormatter.prototype.loadFromJSON;EllipseVertexGraphFormatter.prototype._setEvents=VertexGraphFormatter.prototype._setEvents;
function EllipseVertexGraphFormatter(e,c,d,b,a){VertexGraphFormatter.prototype.constructor.call(this,e,c,d,b,a);this.args.type="EllipseVertexGraphFormatter";if(c!=null){if(c.radius!=null){this.defaultFormat.args.radius=c.radius;}}if(d!=null){if(d.radius!=null){this.selected.args.radius=d.radius;}}if(b!=null){if(b.radius!=null){this.over.args.radius=b.radius;
}}if(a!=null){if(a.radius!=null){this.dragging.args.draggingFormat=a.radius;}}}RectangleVertexGraphFormatter.prototype.getDefault=ItemGraphFormatter.prototype.getDefault;RectangleVertexGraphFormatter.prototype.getSelected=ItemGraphFormatter.prototype.getSelected;RectangleVertexGraphFormatter.prototype.getOver=ItemGraphFormatter.prototype.getOver;
RectangleVertexGraphFormatter.prototype.getDragging=ItemGraphFormatter.prototype.getDragging;RectangleVertexGraphFormatter.prototype.getId=ItemGraphFormatter.prototype.getId;RectangleVertexGraphFormatter.prototype.toJSON=ItemGraphFormatter.prototype.toJSON;RectangleVertexGraphFormatter.prototype.loadFromJSON=ItemGraphFormatter.prototype.loadFromJSON;
RectangleVertexGraphFormatter.prototype._setEvents=ItemGraphFormatter.prototype._setEvents;function RectangleVertexGraphFormatter(e,c,d,b,a){VertexGraphFormatter.prototype.constructor.call(this,e,c,d,b,a);this.args.type="RectangleVertexGraphFormatter";if(c!=null){if(c.radius!=null){this.defaultFormat.args.radius=c.radius;
}}if(d!=null){if(d.radius!=null){this.selected.args.radius=d.radius;}}if(b!=null){if(b.radius!=null){this.over.args.radius=b.radius;}}if(a!=null){if(a.radius!=null){this.dragging.args.draggingFormat=a.radius;}}}RoundedVertexGraphFormatter.prototype.getDefault=ItemGraphFormatter.prototype.getDefault;RoundedVertexGraphFormatter.prototype.getSelected=ItemGraphFormatter.prototype.getSelected;
RoundedVertexGraphFormatter.prototype.getOver=ItemGraphFormatter.prototype.getOver;RoundedVertexGraphFormatter.prototype.getDragging=ItemGraphFormatter.prototype.getDragging;RoundedVertexGraphFormatter.prototype.getId=ItemGraphFormatter.prototype.getId;RoundedVertexGraphFormatter.prototype.toJSON=ItemGraphFormatter.prototype.toJSON;
RoundedVertexGraphFormatter.prototype.loadFromJSON=ItemGraphFormatter.prototype.loadFromJSON;RoundedVertexGraphFormatter.prototype._setEvents=ItemGraphFormatter.prototype._setEvents;function RoundedVertexGraphFormatter(e,c,d,b,a){VertexGraphFormatter.prototype.constructor.call(this,e,c,d,b,a);this.args.type="RoundedVertexGraphFormatter";
if(c!=null){if(c.radius!=null){this.defaultFormat.args.radius=c.radius;}}if(d!=null){if(d.radius!=null){this.selected.args.radius=d.radius;}}if(b!=null){if(b.radius!=null){this.over.args.radius=b.radius;}}if(a!=null){if(a.radius!=null){this.dragging.args.draggingFormat=a.radius;}}}OctagonVertexGraphFormatter.prototype.getDefault=ItemGraphFormatter.prototype.getDefault;
OctagonVertexGraphFormatter.prototype.getSelected=ItemGraphFormatter.prototype.getSelected;OctagonVertexGraphFormatter.prototype.getOver=ItemGraphFormatter.prototype.getOver;OctagonVertexGraphFormatter.prototype.getDragging=ItemGraphFormatter.prototype.getDragging;OctagonVertexGraphFormatter.prototype.getId=ItemGraphFormatter.prototype.getId;
OctagonVertexGraphFormatter.prototype.toJSON=ItemGraphFormatter.prototype.toJSON;OctagonVertexGraphFormatter.prototype.loadFromJSON=ItemGraphFormatter.prototype.loadFromJSON;OctagonVertexGraphFormatter.prototype._setEvents=ItemGraphFormatter.prototype._setEvents;function OctagonVertexGraphFormatter(e,c,d,b,a){VertexGraphFormatter.prototype.constructor.call(this,e,c,d,b,a);
this.args.type="OctagonVertexGraphFormatter";if(c!=null){if(c.radius!=null){this.defaultFormat.args.radius=c.radius;}}if(d!=null){if(d.radius!=null){this.selected.args.radius=d.radius;}}if(b!=null){if(b.radius!=null){this.over.args.radius=b.radius;}}if(a!=null){if(a.radius!=null){this.dragging.args.draggingFormat=a.radius;
}}}var Colors=new function(){this.hashColor=[];this.getColorByScoreArrayValue=function(d){var e=new Array();for(var c=0;c<d.length;c++){var b=this.getColorByScoreValue(d[c]);e.push(b);}return e;};this.getHexStringByScoreArrayValue=function(d){var b=this.getColorByScoreArrayValue(d);var e=new Array();
for(var c=0;c<b.length;c++){e.push(b[c].HexString());}return e;};this.getColorByScoreValue=function(f){var d=f.toString().substr(0,4);if(this.hashColor[d]!=null){return this.hashColor[d];}if(isNaN(f)){return Colors.ColorFromRGB(0,0,0);}var e;var i,h;if(f<0.5){i=Colors.ColorFromRGB(0,0,255);h=Colors.ColorFromRGB(255,255,255);
e=(f*2);}else{i=Colors.ColorFromRGB(255,255,255);h=Colors.ColorFromRGB(255,0,0);e=(f*2)-1;}var b=e;var g=1-e;var c=Colors.ColorFromRGB(g*i.Red()+b*h.Red(),g*i.Green()+b*h.Green(),g*i.Blue()+b*h.Blue());this.hashColor[d]=c;return c;};this.ColorFromHSV=function(d,c,e){var b=new a();b.SetHSV(d,c,e);return b;
};this.ColorFromRGB=function(f,e,c){var d=new a();d.SetRGB(f,e,c);return d;};this.ColorFromHex=function(c){var b=new a();b.SetHexString(c);return b;};function a(){var i=0;var h=0;var b=0;var e=0;var f=0;var g=0;this.SetRGB=function(l,k,j){i=l/255;h=k/255;b=j/255;d();};this.Red=function(){return Math.round(i*255);
};this.Green=function(){return Math.round(h*255);};this.Blue=function(){return Math.round(b*255);};this.SetHSV=function(l,k,j){e=l;f=k;g=j;c();};this.Hue=function(){return e;};this.Saturation=function(){return f;};this.Value=function(){return g;};this.SetHexString=function(k){if(k==null||typeof(k)!="string"){this.SetRGB(0,0,0);
return;}if(k.substr(0,1)=="#"){k=k.substr(1);}if(k.length!=6){this.SetRGB(0,0,0);return;}var m=parseInt(k.substr(0,2),16);var l=parseInt(k.substr(2,2),16);var j=parseInt(k.substr(4,2),16);if(isNaN(m)||isNaN(l)||isNaN(j)){this.SetRGB(0,0,0);return;}this.SetRGB(m,l,j);};this.HexString=function(){var k=this.Red().toString(16);
if(k.length==1){k="0"+k;}var j=this.Green().toString(16);if(j.length==1){j="0"+j;}var l=this.Blue().toString(16);if(l.length==1){l="0"+l;}return("#"+k+j+l).toUpperCase();};this.Complement=function(){var m=(e>=180)?e-180:e+180;var k=(g*(f-1)+1);var l=(g*f)/k;var j=new a();j.SetHSV(m,l,k);return j;};function d(){var j=Math.max(Math.max(i,h),b);
var k=Math.min(Math.min(i,h),b);g=j;f=0;if(j!=0){f=1-k/j;}e=0;if(k==j){return;}var l=(j-k);if(i==j){e=(h-b)/l;}else{if(h==j){e=2+((b-i)/l);}else{e=4+((i-h)/l);}}e=e*60;if(e<0){e+=360;}}function c(){i=g;h=g;b=g;if(g==0||f==0){return;}var j=(e/60);var l=Math.floor(j);var n=j-l;var o=g*(1-f);var m=g*(1-f*n);
var k=g*(1-f*(1-n));switch(l){case 0:i=g;h=k;b=o;break;case 1:i=m;h=g;b=o;break;case 2:i=o;h=g;b=k;break;case 3:i=o;h=m;b=g;break;case 4:i=k;h=o;b=g;break;default:i=g;h=o;b=m;break;}}}}();var DOM={};DOM.createNewElement=function(d,a,b){var e=document.createElement(d);for(var c=0;c<b.length;c++){e.setAttribute(b[c][0],b[c][1]);
}a.appendChild(e);return e;};DOM.createTextNode=function(c,a){var b=document.createTextNode(c);a.appendChild(b);return b;};DOM.removeChilds=function(a){var b=document.getElementById(a);while(b.childNodes.length>0){b.removeChild(b.childNodes[0]);}};DOM.select=function(a){return document.getElementById(a);
};var Geometry={getAngleBetweenTwoPoints:function(b,d,a,c){return Math.atan2(c-d,a-b);},getAdjacentSideOfRectangleRight:function(b,a){return Math.abs(Math.cos(b)*a);},getOppositeSideOfRectangleRight:function(b,a){return Math.abs(Math.sin(b)*a);},toDegree:function(a){return a*180/Math.PI;}};var SVG={svgns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",createSVGCanvas:function(a,c){c.push(["xmlns",SVG.svgns],["xmlns:xlink","http://www.w3.org/1999/xlink"]);
var b=document.createElementNS("http://www.w3.org/2000/svg","svg");this._setProperties(b,c);a.appendChild(b);return b;},createRectangle:function(b,f,d,a,c){var e=document.createElementNS(this.svgns,"rect");e.setAttribute("x",b);e.setAttribute("y",f);e.setAttribute("width",d);e.setAttribute("height",a);
SVG._setProperties(e,c);return e;},drawImage64:function(b,h,e,a,c,g,d){var f=SVG.createImage64(b,h,e,a,c,d);g.appendChild(f);return f;},createImage64:function(b,g,f,a,c,e){var d=document.createElementNS(this.svgns,"image");d.setAttribute("x",b);d.setAttribute("y",g);d.setAttribute("width",f);d.setAttribute("height",a);
d.setAttribute("xlink:href",c);SVG._setProperties(d,e);return d;},createLine:function(d,f,c,e,b){var a=document.createElementNS(this.svgns,"line");a.setAttribute("x1",d);a.setAttribute("y1",f);a.setAttribute("x2",c);a.setAttribute("y2",e);SVG._setProperties(a,b);return a;},createClip:function(d,a,b){var c=document.createElementNS(this.svgns,"clipPath");
c.setAttribute("id",d);c.appendChild(a);return c;},drawClip:function(d,a,c){var b=SVG.createClip(d,a);c.appendChild(b);return b;},drawRectangle:function(b,i,d,a,g,c){try{var f=SVG.createRectangle(b,i,d,a,c);g.appendChild(f);}catch(h){console.log("-------------------- ");console.log("Error on drawRectangle "+h);
console.log(c);console.log("-------------------- ");}return f;},createEllipse:function(a,f,e,d,b){var c=document.createElementNS(this.svgns,"ellipse");c.setAttribute("cx",a);c.setAttribute("cy",f);c.setAttribute("rx",e);c.setAttribute("ry",d);SVG._setProperties(c,b);return c;},drawEllipse:function(a,g,f,e,d,b){var c=SVG.createEllipse(a,g,f,e,b);
d.appendChild(c);return c;},drawImage:function(a,e,d,b){var c=document.createElementNS(this.svgns,"image");c.setAttribute("x",a);c.setAttribute("y",e);d.appendChild(c);SVG._setProperties(c,b);},drawLine:function(f,h,d,g,c,b){try{var a=SVG.createLine(f,h,d,g,b);c.appendChild(a);}catch(i){}return a;},drawPath:function(e,b,a){var c=SVG.createPath(e,a);
b.appendChild(c);return c;},createPoligon:function(b,a){var c=document.createElementNS(this.svgns,"polygon");c.setAttribute("points",b);SVG._setProperties(c,a);return c;},drawPoligon:function(b,d,a){var c=SVG.createPoligon(b,a);d.appendChild(c);return c;},createPath:function(c,a){var b=document.createElementNS(this.svgns,"path");
b.setAttribute("d",c);SVG._setProperties(b,a);return b;},drawCircle:function(a,f,c,e,b){var d=document.createElementNS(this.svgns,"circle");d.setAttribute("cx",a);d.setAttribute("cy",f);d.setAttribute("r",c);e.appendChild(d);b["cursor"]="pointer";this._setProperties(d,b);return d;},_setProperties:function(d,a){if(a instanceof Array){for(var c=0;
c<a.length;c++){d.setAttribute(a[c][0],a[c][1]);}}else{for(var b in a){d.setAttribute(b,a[b]);}}},createText:function(a,f,e,b){var c=document.createElementNS(this.svgns,"text");c.setAttributeNS(null,"x",a);c.setAttributeNS(null,"y",f);var d=document.createTextNode(e);c.appendChild(d);this._setProperties(c,b);
return c;},drawText:function(a,e,d,c,b){var d=SVG.createText(a,e,d,b);c.appendChild(d);return d;},drawGroup:function(b,a){var c=SVG.createGroup(a);b.appendChild(c);return c;},createGroup:function(a){var b=document.createElementNS(this.svgns,"g");this._setProperties(b,a);return b;}};var CanvasToSVG={convert:function(h,g,a,f,e,c){var b=this._convert(h,g,a,f,e);
for(var d=0;d<c.length;d++){b.setAttribute(c[d][0],c[d][1]);}},_convert:function(e,c,h,g,b){var i="http://www.w3.org/2000/svg";var a="http://www.w3.org/1999/xlink";var d=e.toDataURL();var f=document.createElementNS(i,"image");f.setAttribute("id",b);f.setAttributeNS(a,"xlink:href",d);f.setAttribute("x",h?h:0);
f.setAttribute("y",g?g:0);f.setAttribute("width",e.width);f.setAttribute("height",e.height);f.imageData=d;c.appendChild(f);return f;},importSVG:function(d,c){svg_xml=d;var a=c.getContext("2d");var b=new Image();b.src="data:image/svg+xml;base64,"+btoa(svg_xml);a.drawImage(b,0,0);}};var Normalizer=new function(){this.normalizeArray=function(a){return this.standardizeArray(this.normal(a));
};this.normal=function(d){var c=this._getMean(d);var g=this._getStdDeviation(d);var b=this._getMaxAndMin(d);var f=b[0];var a=b[1];var h=new Array();for(var e=0;e<d.length;e++){if(g!=0){h.push((d[e]-c)/g);}else{h.push(d[e]);}}return h;};this.standardizeArray=function(c){var b=this._getMaxAndMin(c);var e=b[0];
var a=b[1];var g=(e<=0)?Math.abs(e):(-1*e);var f=new Array();for(var d=0;d<c.length;d++){if(a+g!=0){f.push((c[d]+g)/(a+g));}else{f.push(c[d]+g);}}return f;};this._getMean=function(a){var c=0;for(var b=0;b<a.length;b++){c=c+parseFloat(a[b]);}return c/a.length;};this._getStdDeviation=function(b){var a=this._getMean(b);
var d=0;for(var c=0;c<b.length;c++){d+=Math.pow(parseFloat(b[c])-a,2);}return Math.sqrt(d/b.length);};this._getMaxAndMin=function(b){var d=Number.MAX_VALUE;var a=Number.MIN_VALUE;for(var c=0;c<b.length;c++){if(b[c]<d){d=parseFloat(b[c]);}if(b[c]>a){a=parseFloat(b[c]);}}return[d,a];};};function GenericGraph(a){this.width=600;
this.height=400;this.targetId=null;this.top=10;this.left=10;this.bottom=50;this.right=40;this.rulerHeight=50;this.rulerWidth=50;this.rulerStroke=2;this.rulerVerticalMarksNumber=5;this.rulerMaxValue=null;this.rulerMinValue=null;this.plotPoints=true;this.pointRadius=2;this.fillOpacityPoint=0.2;this.strokeOpacityPoint=0.2;
this.clusterTitleHeight=20;this.interClassesSpace=2;this.interClustersSpace=4;this.fontSize=7;this.plotHorizontalByCluster=true;if(a!=null){if(a.targetId!=null){this.targetId=a.targetId;}if(a.plotHorizontalByCluster!=null){this.plotHorizontalByCluster=a.plotHorizontalByCluster;}if(a.height!=null){this.height=a.height;
}if(a.width!=null){this.width=a.width;}if(a.rulerMinValue!=null){this.rulerMinValue=a.rulerMinValue;}if(a.rulerMaxValue!=null){this.rulerMaxValue=a.rulerMaxValue;}if(a.rulerHeight!=null){this.rulerHeight=a.rulerHeight;}}}GenericGraph.prototype.calculate=function(d){var a={};var c=this.cleanArray(d);c.sort(function(f,e){return f-e;
});var b=this.getMedian(c);a.median=b;a.Q1=Number(this.getQ1(c));a.Q2=Number(this.getQ2(c));a.Q3=Number(this.getQ3(c));a.population=c;a.IQR=Number(a.Q3-a.Q1);a.outlier_below_limit=a.Q1-(1.5*a.IQR);a.outlier_above_limit=a.Q3+(1.5*a.IQR);a.below_outliers=this.getBelowOutliers(a.outlier_below_limit,c);a.above_outliers=this.getAboveOutliers(a.outlier_above_limit,c);
a.min_whisker=this.minValueWhisker(a.outlier_below_limit,a.Q1,c);a.max_whisker=this.maxValueWhisker(a.outlier_above_limit,a.Q3,c);return a;};GenericGraph.prototype.drawSVGVerticalText=function(a,e,d,c){var b=["transform","translate("+a+", "+e+"), rotate(-90) "];c.push(b);SVG.drawText(0,0,d,this.svg,c);
};GenericGraph.prototype.plotRuler=function(g){SVG.drawRectangle(g.vertical.x,g.vertical.y,g.vertical.width,g.vertical.height,this.svg,[["fill","black"]]);var b=g.vertical.height/(this.rulerVerticalMarksNumber+1);for(var e=0;e<=this.rulerVerticalMarksNumber+1;e++){var h=b*e;var d=g.vertical.height-h;
var j=Number((d/g.vertical.height)*(g.maxPoint-g.minPoint)+g.minPoint).toFixed(3);SVG.drawLine(g.horizontal.x,this.top+h,g.horizontal.x-g.markWidth,this.top+h,this.svg,[["stroke","black"]]);SVG.drawText(this.left,this.top+b*e+5,j,this.svg,[["style","font-size:xx-small"]]);SVG.drawLine(g.horizontal.x,this.top+h,this.width-this.right,this.top+h,this.svg,[["stroke",g.markColor],["stroke-width","0.3"]]);
if(e==this.rulerVerticalMarksNumber+1){SVG.drawLine(g.horizontal.x,this.top+h,this.width-this.right,this.top+h,this.svg,[["stroke",g.markColor]]);}}if(!this.plotHorizontalByCluster){var c=g.horizontal.width;var f=c/(g.horizontal.xValues.range);for(e=0;e<g.horizontal.xValues.values.length;e++){var a=g.horizontal.xValues.values[e]-g.horizontal.xValues.min;
SVG.drawText(g.horizontal.x+a*f,this.height-(this.bottom+(this.clusterTitleHeight)),g.horizontal.xValues.values[e],this.svg,[["style","font-size:small"]]);}}};GenericGraph.prototype.plotAxes=function(a){this.plotRuler({minPoint:Number(a.minPoint),maxPoint:Number(a.maxPoint),markColor:"black",markWidth:20,vertical:{x:this.left+this.rulerWidth-this.rulerStroke,y:this.top,width:this.rulerStroke,height:this.height-(this.top+this.bottom+this.clusterTitleHeight)-this.rulerHeight},horizontal:{x:this.left+this.rulerWidth-this.rulerStroke,y:this.height-(this.bottom+this.clusterTitleHeight+this.rulerHeight),width:a.width,height:this.rulerStroke,xValues:a.xValues}});
};GenericGraph.prototype.cleanArray=function(c){var b=[];for(var a=0;a<c.length;a++){if(c[a]!=null){if(!isNaN(c[a])){b.push(c[a]);}}}return b;};GenericGraph.prototype.refresh=function(a){document.getElementById(this.targetId).innerHTML="";this.draw(this.targetId,a);};GenericGraph.prototype.getClassColor=function(e){for(var d=0;
d<this.data.clusters.length;d++){var a=this.data.clusters[d];for(var b=0;b<a.classes.length;b++){var c=a.classes[b];if(c.name==e){if(c.color!=null){return c.color;}}}}return"black";};GenericGraph.prototype.getDimensions=function(f){var g={};var m=[];this.data=f;var n=0;var a=[];for(var h=0;h<f.clusters.length;
h++){var l=f.clusters[h];if(!this.plotHorizontalByCluster){a.push(f.clusters[h].x);}for(var d=0;d<l.classes.length;d++){var b=l.classes[d];m=m.concat(b.values);n=n+1;}}var k=this.cleanArray(m);k.sort(function(j,i){return j-i;});g.minPoint=k[0];if(this.rulerMinValue!=null){g.minPoint=this.rulerMinValue;
}g.maxPoint=k[k.length-1];if(this.rulerMaxValue!=null){g.maxPoint=this.rulerMaxValue;}g.classesNumber=n;g.clusterNumber=f.clusters.length;var c=(n-f.clusters.length)*this.interClassesSpace;var e=(f.clusters.length)*this.interClustersSpace;g.classWidth=(this.width-(this.rulerWidth+this.left+this.right+c+e))/n;
g.width=this.width-(this.right+this.left)-this.rulerWidth+this.rulerStroke;g.xValues={};a.sort(function(j,i){return j-i;});g.xValues.values=a;if(a.length>0){g.xValues.min=a[0];g.xValues.max=a[a.length-1];g.xValues.range=g.xValues.max-g.xValues.min;}return g;};GenericGraph.prototype.draw=function(a,c){this.targetId=a;
var b=(this.getDimensions(c));this.svg=SVG.createSVGCanvas(document.getElementById(this.targetId),[["width",this.width],["height",this.height]]);this.plotAxes(b);};GenericGraph.prototype.getMedian=function(a){if(a.length%2==1){return a[Math.floor(a.length/2)];}else{return(Number(a[(a.length/2)-1])+Number(a[a.length/2]))/2;
}};GenericGraph.prototype.pointToPixel=function(b,c){var a=(b-c.minPoint)/(c.maxPoint-c.minPoint);var d=c.height-c.y+this.top;return(-1*a)*(d)+(c.y+c.height);};GenericGraph.prototype.maxValueWhisker=function(a,d,e){var c=[];for(var b=0;b<e.length;b++){if((e[b]>d)&&(e[b])<=a){c.push(e[b]);}}if(c.length>0){c.sort(function(g,f){return g-f;
});return c[c.length-1];}return null;};GenericGraph.prototype.input=function(){return DATADOC.getBoxWhikerData();};GenericGraph.prototype.test=function(a){var b=new GenericGraph({targetId:a,height:350,width:450,maxBoxWidth:25});b.refresh(this.input());};function GraphCanvas(a,c,b){this.args={};this.targetID=c.id;
this.id=a;this.args.idGraph=this.id+"main";this.args.idBackgroundNode=this.id+"background";this.args.idEdgesGraph=this.id+"edges";this.args.idNodesGraph=this.id+"vertices";this.args.idLabelGraph=this.id+"label";this.args.idBackground=this.id+"background";this.dataset=null;this.formatter=null;this.layout=null;
this.circleDefaultRadius=2;this.squareDefaultSide=this.circleDefaultRadius*1.5;this.arrowDefaultSize=this.circleDefaultRadius;this.GraphGroup=null;this.GraphNodeGroup=null;this.GraphLabelGroup=null;this.GraphBackground=null;this.args.draggingCanvasEnabled=false;this.args.multipleSelectionEnabled=false;
this.args.interactive=false;this.args.labeled=false;this.args.linkEnabled=false;this.args.maxNumberEdgesMoving=3;this.args.maxNumberEdgesFiringEvents=50;this.args.linking=false;this.linkStartX=0;this.linkStartY=0;this.linkSVGNode=null;this.linkNodeSource=null;this.linkNodeTarget=null;this.draggingElement=null;
this.dragging=false;this.nMouseOffsetX=0;this.nMouseOffsetY=0;this.dragStartX=0;this.dragStartY=0;this.desplazamientoX=0;this.desplazamientoY=0;this.selecting=false;this.selectorX=null;this.selectorY=null;this.selectorSVGNode=null;this.args.isVertexSelected={};this.args.selectedVertices=[];this.args.isEdgeSelected={};
if(b!=null){if(b.multipleSelectionEnabled!=null){this.args.multipleSelectionEnabled=b.multipleSelectionEnabled;this.args.draggingCanvasEnabled=!(this.args.multipleSelectionEnabled);}if(b.draggingCanvasEnabled!=null){this.args.draggingCanvasEnabled=b.draggingCanvasEnabled;this.args.multipleSelectionEnabled=!(this.args.draggingCanvasEnabled);
}if(b.interactive!=null){this.args.interactive=b.interactive;}if(b.labeled!=null){this.args.labeled=b.labeled;}}this.svgLabels={};this.onVertexOut=new Event(this);this.onVertexOver=new Event(this);this.onVertexSelect=new Event(this);this.onEdgeSelect=new Event(this);this.onCanvasClicked=new Event(this);
this.onVertexUp=new Event(this);}GraphCanvas.prototype.showLabels=function(a){this.args.labeled=a;this.removeLabels();if(a){this.renderLabels();}};GraphCanvas.prototype.getSelectedVertices=function(){return this.args.selectedVertices;};GraphCanvas.prototype.getSelectedEdges=function(){var a=[];for(var b in this.args.isEdgeSelected){a.push(b);
}return a;};GraphCanvas.prototype.createSVGDom=function(d,f,e,a,c){var b=document.getElementById(d);this._svg=SVG.createSVGCanvas(b,[["style","background-color:"+c+";"],["id",f],["dragx",0],["dragy",0],["height",this.getFormatter().getHeight()],["width",this.getFormatter().getWidth()]]);return this._svg;
};GraphCanvas.prototype.isMultipleSelectionEnabled=function(){return this.args.multipleSelectionEnabled;};GraphCanvas.prototype.setMultipleSelection=function(a){this.args.multipleSelectionEnabled=a;this.args.draggingCanvasEnabled=(!a);};GraphCanvas.prototype.setSelecting=function(a){this.selecting=a;
};GraphCanvas.prototype.setLinking=function(a){this.args.linkEnabled=a;this.selecting=!a;this.dragging=!a;};GraphCanvas.prototype.setDraggingCanvas=function(a){this.args.draggingCanvasEnabled=a;this.args.multipleSelectionEnabled=!a;};GraphCanvas.prototype.isDraggingCanvasEnabled=function(){return this.args.draggingCanvasEnabled;
};GraphCanvas.prototype.getScale=function(){return this.getFormatter().getZoomScale();};GraphCanvas.prototype.setScale=function(b){var a=document.getElementById(this.args.idGraph);a.setAttribute("transform",a.getAttribute("transform").replace("scale("+this.getScale()+")","scale("+b+")"));this.getFormatter().setZoomScale(b);
};GraphCanvas.prototype.zoomIn=function(){this.setScale(this.getScale()+this.getFormatter().getZoomScaleStepFactor());};GraphCanvas.prototype.zoomOut=function(){this.setScale(this.getScale()-this.getFormatter().getZoomScaleStepFactor());};GraphCanvas.prototype.getSVGCoordenates=function(b){var c=this._svg.createSVGPoint();
c.x=b.clientX;c.y=b.clientY;var a=this._svg.getScreenCTM(document.documentElement);c=c.matrixTransform(a.inverse());return c;};GraphCanvas.prototype.mouseClick=function(a){if(a.button==0){if(!this.args.interactive){return;}if(this.isVertex(a.target)){this.clickNode(this.getVertexIdFromSVGId(a.target.id));
}if(this.dragging){this.dragging=false;}}};GraphCanvas.prototype.mouseMove=function(j){if(this.selecting){this.clearLabels();var c=(this.getSVGCoordenates(j).x-this.selectorX);var k=(this.getSVGCoordenates(j).y-this.selectorY);if((c>0)&&(k>0)){this.displaySelection(this.selectorX,this.selectorY,c,k);
}if((c>0)&&(k<0)){this.displaySelection(this.selectorX,this.getSVGCoordenates(j).y,c,Math.abs(k));}if((c<0)&&(k<0)){this.displaySelection(this.getSVGCoordenates(j).x,this.getSVGCoordenates(j).y,Math.abs(c),Math.abs(k));}if((c<0)&&(k>0)){this.displaySelection(this.selectorX+c,this.selectorY,Math.abs(c),Math.abs(k));
}var d=(parseFloat(this.selectorSVGNode.getAttribute("x"))-DOM.select(this.id).getAttribute("dragx"))/this.getFormatter().getWidth();var h=(parseFloat(this.selectorSVGNode.getAttribute("y"))-DOM.select(this.id).getAttribute("dragy"))/this.getFormatter().getHeight();var a=(d+parseFloat(this.selectorSVGNode.getAttribute("width")/this.getFormatter().getWidth()));
var g=(h+parseFloat(this.selectorSVGNode.getAttribute("height")/this.getFormatter().getHeight()));this.deselectNodes(this.getLayout());var e=this.getLayout().getVerticesByArea(d/this.getFormatter().getZoomScale(),h/this.getFormatter().getZoomScale(),a/this.getFormatter().getZoomScale(),g/this.getFormatter().getZoomScale());
for(var f=0;f<e.length;f++){this.selectNode(e[f].getId());this.renderLabel(e[f].getId());}}var b=null;if(this.args.linking){b=this.getSVGCoordenates(j);if(this.linkSVGNode!=null){this.linkSVGNode.setAttribute("x2",b.x-2);this.linkSVGNode.setAttribute("y2",b.y-2);}}if(this.dragging){b=this.getSVGCoordenates(j);
b.x-=this.nMouseOffsetX;b.y-=this.nMouseOffsetY;this.desplazamientoX=(this.getSVGCoordenates(j).x-this.dragStartX);this.desplazamientoY=(this.getSVGCoordenates(j).y-this.dragStartY);if(this.draggingElement!=null){if(this.isNodeCanvas(this.draggingElement)){b=this.getSVGCoordenates(j);b.x=this.desplazamientoX;
b.y=this.desplazamientoY;this.draggingElement.setAttribute("dragx",b.x);this.draggingElement.setAttribute("dragy",b.y);this.draggingElement=document.getElementById(this.args.idGraph);this.draggingElement.setAttribute("transform","translate("+b.x+","+b.y+"), scale("+this.getScale()+")");DOM.select(this.id).setAttribute("dragx",b.x);
DOM.select(this.id).setAttribute("dragy",b.y);if(this.NodeSVGbackgroundImage!=null){this.NodeSVGbackgroundImage.setAttribute("dragx",b.x);this.NodeSVGbackgroundImage.setAttribute("dragy",b.y);}}else{if(this.isVertex(this.draggingElement)){this.selectNode(this.getVertexIdFromSVGId(this.draggingElement.id));
this.desplazamientoX=this.desplazamientoX/this.getFormatter().getZoomScale();this.desplazamientoY=this.desplazamientoY/this.getFormatter().getZoomScale();this.moveSelectedNodes(this.desplazamientoX,this.desplazamientoY);this.dragStartX=this.getSVGCoordenates(j).x;this.dragStartY=this.getSVGCoordenates(j).y;
}else{if(this.isNodeBackground(this.draggingElement)){this.draggingElement.setAttribute("dragx",b.x);this.draggingElement.setAttribute("dragy",b.y);this.draggingElement=document.getElementById(this.args.idGraph);this.draggingElement.setAttribute("transform","translate("+b.x+","+b.y+"), scale("+this.getScale()+")");
}else{this.draggingElement.setAttribute("transform","translate("+b.x+","+b.y+")");}}}}}};GraphCanvas.prototype.moveSelectedNodes=function(b,g){for(var c=0;c<this.getSelectedVertices().length;c++){var d=this.getSelectedVertices()[c];var f=this.getSVGNodeId(d);var a=parseFloat(DOM.select(f).getAttribute("dragx"))+parseFloat(b);
var e=parseFloat(DOM.select(f).getAttribute("dragy"))+parseFloat(g);this._movingNode(DOM.select(f),a,e);}};GraphCanvas.prototype.mouseDown=function(a){if(event.button==0){if(!this.args.interactive){return;}var b=this.getSVGCoordenates(a);if(this.isNodeCanvas(a.target)||this.isNodeBackground(a.target)){this.deselectNodes();
this.deselectEdges();this.onCanvasClicked.notify();}if(this.args.linkEnabled){if(!this.args.linking){this.args.linking=true;if(this.isVertex(a.target)){this.linkStartX=b.x;this.linkStartY=b.y;this.linkSVGNode=SVG.drawLine(b.x,b.y,b.x,b.y,this._svg,{"stroke":"#FF0000"});this.linkNodeSource=this.getVertexIdFromSVGId(a.target.id);
}}else{this.linkNodeTarget=this.getVertexIdFromSVGId(a.target.id);this.args.linking=false;this.args.linkEnabled=false;if(this.isVertex(a.target)){this.getDataset().addEdge(this.linkNodeSource+"_"+this.linkNodeTarget,this.linkNodeSource,this.linkNodeTarget,{});}this.linkSVGNode.parentNode.removeChild(this.linkSVGNode);
}return;}if(this.isVertex(a.target)||this.isNodeCanvas(a.target)||this.isNodeBackground(a.target)){this._startDragging(a);}if(this.isEdge(a.target)){this.selectEdge(this.getEdgeIdFromSVGId(a.target.getAttribute("id")));}if(this.args.multipleSelectionEnabled){if(!this.dragging){this.setSelecting(true);
this.selectorX=b.x;this.selectorY=b.y;this.displaySelection(b.x,b.y,1,1);}}}if(event.button==1){this.setLinking(false);this.setMultipleSelection(false);this.selecting=false;if(this.isVertex(a.target)||this.isNodeCanvas(a.target)||this.isNodeBackground(a.target)){this._startDragging(a);}}};GraphCanvas.prototype.mouseUp=function(h){if(!this.args.interactive){return;
}if(this.dragging){this._stopDragging(h);if(this.isVertex(h.target)){var a=this.getVertexIdFromSVGId(h.target.id);if(this.getDataset().getVertexById(a).getEdges().length>=this.args.maxNumberEdgesMoving){this.moveEdge(a);}}}if(this.selecting){this.setSelecting(false);var c=(parseFloat(this.selectorSVGNode.getAttribute("x"))-DOM.select(this.id).getAttribute("dragx"))/this.getFormatter().getWidth();
var g=(parseFloat(this.selectorSVGNode.getAttribute("y"))-DOM.select(this.id).getAttribute("dragy"))/this.getFormatter().getHeight();var b=(c+parseFloat(this.selectorSVGNode.getAttribute("width")/this.formatter.getWidth()));var e=(g+parseFloat(this.selectorSVGNode.getAttribute("height")/this.formatter.getHeight()));
var f=this.getLayout().getVerticesByArea(c/this.getFormatter().getZoomScale,g/this.getFormatter().getZoomScale,b/this.getFormatter().getZoomScale,e/this.getFormatter().getZoomScale);for(var d=0;d<f.length;d++){this.selectNode(f[d].getId());}if(this.selectorSVGNode!=null){this._svg.removeChild(this.selectorSVGNode);
}if(this.args.labeled){this.clearLabels();this.renderLabels();}this.selectorSVGNode=null;}};GraphCanvas.prototype.displaySelection=function(b,d,c,a){if(this.selectorSVGNode!=null){this.selectorSVGNode.setAttribute("x",b);this.selectorSVGNode.setAttribute("y",d);this.selectorSVGNode.setAttribute("width",c);
this.selectorSVGNode.setAttribute("height",a);}else{this.selectorSVGNode=SVG.drawRectangle(b,d,c,a,this._svg,{"fill":"red","stroke":"black","opacity":"0.2","stroke-opacity":"1"});}};GraphCanvas.prototype._startDragging=function(a){if(!this.isDraggingCanvasEnabled()){if(this.isNodeCanvas(a.target)){this.draggingElement=null;
}}if(this.isVertex(a.target)||(this.isNodeBackground(a.target)&&(this.isDraggingCanvasEnabled()))||(this.isNodeCanvas(a.target)&&(this.isDraggingCanvasEnabled()))){this.clearLabels();this.draggingElement=a.target;this.dragging=true;var b=this.getSVGCoordenates(a);this.nMouseOffsetX=b.x-parseInt(a.target.getAttribute("dragx"));
this.nMouseOffsetY=b.y-parseInt(a.target.getAttribute("dragy"));if(this.isVertex(a.target)){this.dragStartX=parseInt(this.draggingElement.getAttribute("dragx"))*this.getFormatter().getZoomScale()+parseFloat(DOM.select(this.id).getAttribute("dragx"));this.dragStartY=parseInt(this.draggingElement.getAttribute("dragy"))*this.getFormatter().getZoomScale()+parseFloat(DOM.select(this.id).getAttribute("dragy"));
}else{this.dragStartX=b.x-parseInt(this.draggingElement.getAttribute("dragx"));this.dragStartY=b.y-parseInt(this.draggingElement.getAttribute("dragy"));}}};GraphCanvas.prototype._stopDragging=function(a){this.nMouseOffsetX=0;this.nMouseOffsetX=0;this.dragging=false;this.draggingElement=null;this.renderLabels();
this.setLinking(false);this.setMultipleSelection(true);this.selecting=false;};GraphCanvas.prototype.moveEdge=function(e){var j=this.getLayout().getNodeById(e).x*this.getFormatter().getWidth();var h=this.getLayout().getNodeById(e).y*this.getFormatter().getHeight();for(var b=0;b<this.getDataset().getVertexById(e).getEdgesOut().length;
b++){var g=this.getDataset().getVertexById(e).getEdgesOut()[b].getId();var a=this.getSVGEdgeId(g);var k=this.getFormatter().getEdgeById(g);if(k instanceof LineEdgeGraphFormatter){DOM.select(a+"_shadow").setAttribute("x2",j);DOM.select(a+"_shadow").setAttribute("y2",h);DOM.select(a).setAttribute("x2",j);
DOM.select(a).setAttribute("y2",h);}if((k instanceof DirectedLineEdgeGraphFormatter)||(k instanceof OdirectedLineEdgeGraphFormatter)||(k instanceof OdotDirectedLineEdgeGraphFormatter)||(k instanceof DotDirectedLineEdgeGraphFormatter)||(k instanceof CutDirectedLineEdgeGraphFormatter)){this.removeEdge(g);
this.renderEdge(g);}}for(var b=0;b<this.getDataset().getVertexById(e).getEdgesIn().length;b++){var g=this.getDataset().getVertexById(e).getEdgesIn()[b].getId();var a=this.getSVGEdgeId(g);var k=this.getFormatter().getEdgeById(g);if(k instanceof LineEdgeGraphFormatter){DOM.select(a).setAttribute("x1",j);
DOM.select(a).setAttribute("y1",h);DOM.select(a+"_shadow").setAttribute("x1",j);DOM.select(a+"_shadow").setAttribute("y1",h);}if((k instanceof DirectedLineEdgeGraphFormatter)||(k instanceof OdirectedLineEdgeGraphFormatter)||(k instanceof OdotDirectedLineEdgeGraphFormatter)||(k instanceof DotDirectedLineEdgeGraphFormatter)||(k instanceof CutDirectedLineEdgeGraphFormatter)){this.removeEdge(g);
this.renderEdge(g);}if(k instanceof BezierEdgeGraphFormatter){var c=this.getFormatter().getVertexById(e).getDefault().getSize()*this.getFormatter().getNodesMaxSize();var f=this.calculateCoordenatesBezier(c,j,h);DOM.select(a).setAttribute("d",f);}}};GraphCanvas.prototype.moveNode=function(b){var a=this.getLayout().getNodeById(b).x*this.getFormatter().getWidth();
var d=this.getLayout().getNodeById(b).y*this.getFormatter().getHeight();var c=DOM.select(this.getSVGNodeId(b));c.setAttribute("dragx",a);c.setAttribute("dragy",d);c.setAttribute("transform","translate("+a+","+d+")");if(this.getDataset().getVertexById(b).getEdges().length<this.args.maxNumberEdgesMoving){this.moveEdge(b);
}};GraphCanvas.prototype._movingNode=function(c,b,d){var a=this.getVertexIdFromSVGId(c.getAttribute("id"));this.getLayout().getNodeById(a).setCoordinates(b/this.getFormatter().getWidth(),d/this.getFormatter().getHeight());this.desplazamientoX=0;this.desplazamientoY=0;this.removeLabel(a);this.renderLabel(a);
};GraphCanvas.prototype.init=function(){this._svg=this.createSVGDom(this.targetID,this.id,this.getFormatter().getWidth(),this.getFormatter().getHeight(),this.getFormatter().getBackgroundColor());this.GraphGroup=SVG.drawGroup(this._svg,[["id",this.args.idGraph],["transform","translate(0,0), scale(1)"]]);
this.GraphBackground=SVG.drawGroup(this.GraphGroup,[["id",this.args.idBackground]]);this.GraphEdgeGroup=SVG.drawGroup(this.GraphGroup,[["id",this.args.idEdgesGraph]]);this.GraphNodeGroup=SVG.drawGroup(this.GraphGroup,[["id",this.args.idNodesGraph]]);this.GraphLabelGroup=SVG.drawGroup(this.GraphGroup,[["id",this.args.idLabelGraph]]);
if((this.getFormatter().getBackgroundImage()!=null)&&(this.getFormatter().getBackgroundImage()!="")){this.setBackgroundImage(this.getFormatter().getBackgroundImage());}var a=this;this._svg.addEventListener("click",function(b){a.mouseClick(b);},false);this._svg.addEventListener("mousemove",function(b){a.mouseMove(b,a);
},false);this._svg.addEventListener("mousedown",function(b){a.mouseDown(b,a);},false);this._svg.addEventListener("mouseup",function(b){a.mouseUp(b,a);},false);};GraphCanvas.prototype.setBackgroundImage=function(){if(this.NodeSVGbackgroundImage!=null){this.NodeSVGbackgroundImage.parentNode.removeChild(this.NodeSVGbackgroundImage);
}$("#"+this.targetID).svg();$("#"+this.targetID).svg("get");$("#"+this.targetID).svg("get")._svg=document.getElementById(this.id);var a=$("#"+this.targetID).svg("get");this.NodeSVGbackgroundImage=a.image(0,0,this.getFormatter().getWidth(),this.getFormatter().getHeight(),this.getFormatter().getBackgroundImage());
this.NodeSVGbackgroundImage.setAttribute("id",this.args.idBackgroundNode);this.NodeSVGbackgroundImage.setAttribute("x",0);this.NodeSVGbackgroundImage.setAttribute("y",0);this.NodeSVGbackgroundImage.setAttribute("dragx",0);this.NodeSVGbackgroundImage.setAttribute("dragy",0);if(this.getFormatter().args.backgroundImageHeight!=null){this.NodeSVGbackgroundImage.setAttribute("height",this.getFormatter().args.backgroundImageHeight);
}if(this.getFormatter().args.backgroundImageWidth!=null){this.NodeSVGbackgroundImage.setAttribute("width",this.getFormatter().args.backgroundImageWidth);}if(this.getFormatter().args.backgroundImageX!=null){this.NodeSVGbackgroundImage.setAttribute("x",this.getFormatter().args.backgroundImageX);}if(this.getFormatter().args.backgroundImageY!=null){this.NodeSVGbackgroundImage.setAttribute("y",this.getFormatter().args.backgroundImageY);
}this.GraphBackground.appendChild(this.NodeSVGbackgroundImage);this.NodeSVGbackgroundImage.removeAttribute("href");this.NodeSVGbackgroundImage.setAttribute("xlink:href",this.getFormatter().getBackgroundImage());};GraphCanvas.prototype.removeBackgroundImage=function(){if(this.NodeSVGbackgroundImage!=null){this.NodeSVGbackgroundImage.parentNode.removeChild(this.NodeSVGbackgroundImage);
}};GraphCanvas.prototype._setBackgroundColor=function(b){var a=[["fill",b]];SVG.drawRectangle(0,0,this.getFormatter().getWidth(),this.getFormatter().getHeight(),this.GraphBackground,a);};GraphCanvas.prototype.toJSON=function(){var a={};a.dataset={};a.formatter={};a.layout={};a.dataset=this.getDataset().toJSON();
a.formatter=this.getFormatter().toJSON();a.layout=this.getLayout().toJSON();return a;};GraphCanvas.prototype.toHTML=function(){var b=this._svg.parentElement.innerHTML;var c=b.indexOf("<svg");var a=b.indexOf("</svg>")+6;return b.substr(c,a);};GraphCanvas.prototype.draw=function(b,c,a){this.setDataset(b);
this.setFormatter(c);this.setLayout(a);var d=this;this.getFormatter().changed.attach(function(e,f){d.removeNode(f.getId());d.renderNode(f.getId());if(d.args.labeled){d.removeLabel(f.getId());d.renderLabel(f.getId());}});this.getFormatter().edgeChanged.attach(function(e,f){d.removeEdge(f.getId());d.renderEdge(f.getId());
});this.getFormatter().resized.attach(function(e,f){d.resize(d.getFormatter().getWidth(),d.getFormatter().getHeight());});this.getFormatter().backgroundImageChanged.attach(function(e,f){d.setBackgroundImage(d.getFormatter().getBackgroundImage());});this.getFormatter().backgroundColorChanged.attach(function(e,f){d._setBackgroundColor(d.getFormatter().getBackgroundColor());
});this.getLayout().changed.attach(function(e,f){d.moveNode(f.getId());d.moveEdge(f.getId());if(d.args.labeled){d.removeLabel(f.getId());d.renderLabel(f.getId());}});this.getDataset().newVertex.attach(function(e,f){d.renderNode(f.getId());if(d.args.labeled){d.renderLabel(f.getId());}});this.getDataset().newEdge.attach(function(e,f){d.renderEdge(f.getId());
});this.getDataset().vertexDeleted.attach(function(e,f){d.removeNode(f.getId());if(d.args.labeled){d.removeLabel(f.getId());}});this.getDataset().edgeDeleted.attach(function(e,f){d.removeEdge(f.getId());});this.getDataset().vertexNameChanged.attach(function(f,e){if(d.args.labeled){d.removeLabel(e.item.getId());
d.removeLabel(e.item.getId());d.renderLabel(e.item.getId());}});this.init();this.render();};GraphCanvas.prototype.render=function(){for(var a in this.getDataset().getVertices()){this.renderNode(a);}this.renderLabels();this.renderEdges();};GraphCanvas.prototype.renderLabels=function(){if(this.args.labeled){for(var a in this.getDataset().getVertices()){this.renderLabel(a);
}}};GraphCanvas.prototype.removeLabels=function(){for(var a in this.getDataset().getVertices()){this.removeLabel(a);}};GraphCanvas.prototype.isNodeCanvas=function(a){return((a.id==this.args.idGraph)||(a.id==this.id));};GraphCanvas.prototype.isNodeBackground=function(a){return((a.id==this.args.idBackgroundNode));
};GraphCanvas.prototype.isVertex=function(a){if(a.getAttribute("id")!=null){if(a.getAttribute("id").indexOf("_v_")!=-1){return true;}}return false;};GraphCanvas.prototype.isLabel=function(a){if(a.getAttribute("id")!=null){if(a.getAttribute("id").indexOf("_l_")!=-1){return true;}}return false;};GraphCanvas.prototype.isEdge=function(a){if(a.getAttribute("id")!=null){if(a.getAttribute("id").indexOf("_e_")!=-1){return true;
}}return false;};GraphCanvas.prototype.resize=function(b,a){if(this.NodeSVGbackgroundImage!=null){this.NodeSVGbackgroundImage.setAttribute("width",b);this.NodeSVGbackgroundImage.setAttribute("height",a);}this._svg.setAttribute("width",b);this._svg.setAttribute("height",a);this.clearCanvas();this.render();
};GraphCanvas.prototype.clearCanvas=function(){DOM.removeChilds(this.GraphEdgeGroup.getAttribute("id"));DOM.removeChilds(this.GraphNodeGroup.getAttribute("id"));this.clearLabels();};GraphCanvas.prototype.clearLabels=function(){DOM.removeChilds(this.GraphLabelGroup.getAttribute("id"));};GraphCanvas.prototype.getSVGNodeId=function(a){return this.id+"_v_"+a;
};GraphCanvas.prototype.getSVGEdgeId=function(a){return this.id+"_e_"+a;};GraphCanvas.prototype.getSVGArrowEdgeId=function(a){return this.id+"_arrow_"+a;};GraphCanvas.prototype.getSVGLabelId=function(a){return this.id+"_l_"+a;};GraphCanvas.prototype.blinkVertexById=function(a){$("#"+this.getSVGNodeId(a)).fadeIn().fadeOut().fadeIn().fadeOut().fadeIn().fadeOut();
};GraphCanvas.prototype.getVertexIdFromSVGId=function(a){return a.replace(this.id,"").replace("_v_","");};GraphCanvas.prototype.getEdgeIdFromSVGId=function(a){return a.replace(this.id,"").replace("_e_","");};GraphCanvas.prototype.getVertexById=function(a){return document.getElementById(this.getSVGNodeId(a));
};GraphCanvas.prototype.renderNodes=function(){for(var a in this.getDataset().getVertices()){this.renderNode(a);}};GraphCanvas.prototype.overNode=function(b){if(!this.args.interactive){return;}if(this.args.isVertexSelected[b]==null){var a=this.getFormatter().getVertexById(b).getOver();a.args["cursor"]="pointer";
this.changeVertexFormat(b,a);}};GraphCanvas.prototype.outNode=function(a){if(!this.args.interactive){return;}if(this.args.isVertexSelected[a]==null){this.changeVertexFormat(a,this.getFormatter().getVertexById(a).getDefault());}};GraphCanvas.prototype.overLabel=function(a){this.overNode(a);};GraphCanvas.prototype.outLabel=function(a){this.outNode(a);
};GraphCanvas.prototype.clickNode=function(a){if(!this.args.interactive){return;}if(this.args.isVertexSelected[a]==null){this.selectNode(a);}else{this.deselectNode(a);}};GraphCanvas.prototype.selectNode=function(c){for(var a=0;a<this.args.selectedVertices.length;a++){var b=this.getFormatter().getVertexById(c).getSelected();
b.opacity=0.2;this.changeVertexFormat(c,this.getFormatter().getVertexById(c).getSelected());}if(this.args.isVertexSelected[c]==null){var b=this.getFormatter().getVertexById(c).getSelected();b.opacity=1;this.changeVertexFormat(c,this.getFormatter().getVertexById(c).getSelected());this.args.selectedVertices.push(c);
this.args.isVertexSelected[c]=this.args.selectedVertices.length-1;this.onVertexSelect.notify(c);}};GraphCanvas.prototype.selectAllEdges=function(){this.deselectNodes();this.deselectEdges();for(var a in this.getDataset().edges){this.selectEdge(a);}};GraphCanvas.prototype.selectAllNodes=function(){this.deselectNodes();
this.deselectEdges();for(var a in this.getDataset().vertices){this.selectNode(a);}};GraphCanvas.prototype.selectAll=function(){this.deselectNodes();this.deselectEdges();for(var b in this.getDataset().vertices){this.selectNode(b);}for(var a in this.getDataset().edges){this.selectEdge(a);}};GraphCanvas.prototype.selectEdge=function(a){if(this.args.isEdgeSelected[a]==null){this.changeEdgeFormat(a,this.getFormatter().getEdgeById(a).getSelected());
this.args.isEdgeSelected[a]=true;this.onEdgeSelect.notify(a);}};GraphCanvas.prototype.selectEdges=function(a){for(var b=0;b<a.length;b++){this.selectEdge(a[b]);}};GraphCanvas.prototype.deselectNode=function(c){if(this.args.isVertexSelected[c]!=null){this.changeVertexFormat(c,this.getFormatter().getVertexById(c).getDefault());
this.args.selectedVertices.splice(this.args.isVertexSelected[c],1);var a=this.args.isVertexSelected[c];delete this.args.isVertexSelected[c];for(var b in this.args.isVertexSelected){if(this.args.isVertexSelected[b]>a){this.args.isVertexSelected[b]=this.args.isVertexSelected[b]-1;}}}};GraphCanvas.prototype.deselectNodes=function(){var b=JSON.parse(JSON.stringify(this.getSelectedVertices()));
for(var a=0;a<b.length;a++){this.deselectNode(b[a]);}};GraphCanvas.prototype.selectNodes=function(b){for(var a=0;a<b.length;a++){this.selectNode(b[a]);}};GraphCanvas.prototype.changeVertexFormat=function(f,e){var d=DOM.select(this.getSVGNodeId(f));if(d!=null){var b=e.toJSON();for(var c in b){d.setAttribute(c,b[c]);
}if(this.getFormatter().getVertexById(f) instanceof CircleVertexGraphFormatter){var a="translate("+d.getAttribute("dragx")+","+d.getAttribute("dragy")+"), scale("+e.getSize()+")";d.setAttribute("transform",a);}}};GraphCanvas.prototype.renderLabel=function(d){var a=Math.ceil(this.getLayout().getNodeById(d).x*this.getFormatter().getWidth());
var g=Math.ceil(this.getLayout().getNodeById(d).y*this.getFormatter().getHeight());var f=JSON.parse(JSON.stringify(this.getFormatter().getVertexById(d).getDefault().toJSON().title));f.id=this.getSVGLabelId(this.getDataset().getVertexById(d).getId());f.dx=(-1)*(this.getDataset().getVertexById(d).getName().length*f["font-size"])/4-4;
f.dy=parseFloat((this.getFormatter().getVertexById(d).getDefault().getSize()))+parseFloat(f["font-size"])+parseFloat(this.getFormatter().getVertexById(d).getDefault().getStrokeWidth())-4;f.dragx=Math.ceil(this.getLayout().getNodeById(d).x*this.getFormatter().getWidth());var c=parseFloat(this.getFormatter().getVertexById(d).getDefault().getSize())+Math.ceil(this.getLayout().getNodeById(d).y*this.getFormatter().getHeight());
f.dragy=c;f.transform="translate("+f.dragx+","+f.dragy+")";var b=SVG.drawText(0,0,this.getDataset().getVertexById(d).getName(),this.GraphLabelGroup,f);this.svgLabels[d]=b;var e=this;if(b!=null){b.addEventListener("mouseover",function(){e.overLabel(d);},false);b.addEventListener("mouseout",function(){e.outLabel(d);
},false);}};GraphCanvas.prototype.removeLabel=function(a){if(DOM.select(this.getSVGLabelId(a))!=null){DOM.select(this.getSVGLabelId(a)).parentNode.removeChild(DOM.select(this.getSVGLabelId(a)));}};GraphCanvas.prototype.renderNode=function(b){var d=JSON.parse(JSON.stringify(this.getFormatter().getVertexById(b).getDefault().toJSON()));
d.dragx=Math.ceil(this.getLayout().getNodeById(b).x*this.getFormatter().getWidth());d.dragy=Math.ceil(this.getLayout().getNodeById(b).y*this.getFormatter().getHeight());d.transform="translate("+d.dragx+","+d.dragy+")";d.id=this.getSVGNodeId(b);this.circleDefaultRadius=this.getFormatter().getVertexById(b).getDefault().getSize();
var a;if(this.getFormatter().getVertexById(b) instanceof CircleVertexGraphFormatter){a=SVG.drawCircle(0,0,this.circleDefaultRadius,this.GraphNodeGroup,d);}if(this.getFormatter().getVertexById(b) instanceof SquareVertexGraphFormatter){a=SVG.drawRectangle(0-(this.circleDefaultRadius),0-(this.circleDefaultRadius),(this.circleDefaultRadius*2),(this.circleDefaultRadius*2),this.GraphNodeGroup,d);
}if(this.getFormatter().getVertexById(b) instanceof EllipseVertexGraphFormatter){a=SVG.drawEllipse(0,0,this.circleDefaultRadius*1.5,this.circleDefaultRadius,this.GraphNodeGroup,d);}if(this.getFormatter().getVertexById(b) instanceof RectangleVertexGraphFormatter){a=SVG.drawRectangle(0-(this.circleDefaultRadius*1.5),0-(this.circleDefaultRadius),(this.circleDefaultRadius*2*1.5),(this.circleDefaultRadius*2),this.GraphNodeGroup,d);
}if(this.getFormatter().getVertexById(b) instanceof RoundedVertexGraphFormatter){d.ry=2;d.rx=2;a=SVG.drawRectangle(0-(this.circleDefaultRadius*1.5),0-(this.circleDefaultRadius),(this.circleDefaultRadius*2*1.5),(this.circleDefaultRadius*2),this.GraphNodeGroup,d);}if(this.getFormatter().getVertexById(b) instanceof OctagonVertexGraphFormatter){d.ry=2;
d.rx=2;a=SVG.drawRectangle(0-(this.circleDefaultRadius*1.5),0-(this.circleDefaultRadius),(this.circleDefaultRadius*2*1.5),(this.circleDefaultRadius*2),this.GraphNodeGroup,d);}a.internalId=b;var c=this;if(a!=null){a.addEventListener("mouseover",function(){c.onVertexOver.notify(b);c.overNode(b);},false);
a.addEventListener("mouseout",function(){c.onVertexOut.notify(b);c.outNode(b);},false);a.addEventListener("mouseup",function(){c.onVertexUp.notify(b);},false);}};GraphCanvas.prototype.removeNode=function(a){DOM.select(this.getSVGNodeId(a)).parentNode.removeChild(DOM.select(this.getSVGNodeId(a)));if(this.args.labeled){this.removeLabel(a);
}};GraphCanvas.prototype.removeSelected=function(){this.removeSelectedEdges();this.removeSelectedNode();};GraphCanvas.prototype.removeSelectedNode=function(){var c=JSON.parse(JSON.stringify(this.getSelectedVertices()));this.deselectNodes();var a=c.sort(function(e,d){return e-d;});for(var b=0;b<a.length;
b++){if(this.getDataset().getVertexById(a[b])!=null){this.getDataset().getVertexById(a[b]).remove();}}};GraphCanvas.prototype.removeEdge=function(a){if(DOM.select(this.getSVGEdgeId(a))!=null){DOM.select(this.getSVGEdgeId(a)).parentNode.removeChild(DOM.select(this.getSVGEdgeId(a)));}if(DOM.select(this.getSVGEdgeId(a)+"_shadow")!=null){DOM.select(this.getSVGEdgeId(a)+"_shadow").parentNode.removeChild(DOM.select(this.getSVGEdgeId(a)+"_shadow"));
}if(DOM.select(this.getSVGArrowEdgeId(a))!=null){DOM.select(this.getSVGArrowEdgeId(a)).parentNode.removeChild(DOM.select(this.getSVGArrowEdgeId(a)));}};GraphCanvas.prototype.overEdge=function(b){if((!this.args.interactive)||this.dragging||this.selecting){return;}if(this.args.isEdgeSelected[b]==null){var a=this.getFormatter().getEdgeById(b).getOver();
a.args["cursor"]="pointer";this.changeEdgeFormat(b,a);}};GraphCanvas.prototype.outEdge=function(a){if(!this.args.interactive){return;}if(this.args.isEdgeSelected[a]==null){this.changeEdgeFormat(a,this.getFormatter().getEdgeById(a).getDefault());}};GraphCanvas.prototype.changeEdgeFormat=function(e,d){var c=DOM.select(this.getSVGEdgeId(e)+"_shadow");
if(c!=null){var a=d.toJSON();for(var b in a){c.setAttribute(b,a[b]);}}};GraphCanvas.prototype.deselectEdge=function(b){if(this.args.isEdgeSelected[b]!=null){this.changeEdgeFormat(b,this.getFormatter().getEdgeById(b).getDefault());var a=this.args.isEdgeSelected[b];delete this.args.isEdgeSelected[b];}};
GraphCanvas.prototype.deselectEdges=function(){var b=JSON.parse(JSON.stringify(this.getSelectedEdges()));for(var a=0;a<b.length;a++){this.deselectEdge(b[a]);}};GraphCanvas.prototype.removeSelectedEdges=function(){var b=JSON.parse(JSON.stringify(this.getSelectedEdges()));this.deselectEdges();for(var a=0;
a<b.length;a++){if(this.getDataset().getEdgeById(b[a])!=null){this.getDataset().getEdgeById(b[a]).remove();}}};GraphCanvas.prototype.renderEdge=function(t){var r=this.getFormatter().getEdgeById(t).getDefault().toJSON();var e=this.getDataset().getEdgeById(t);var a=this.getVertexById(e.getNodeTarget().getId());
var m=this.getVertexById(e.getNodeSource().getId());r.id=this.getSVGEdgeId(e.getId())+"_shadow";var b=null;if(this.getFormatter().getEdgeById(t) instanceof LineEdgeGraphFormatter){var u=m.getAttribute("dragx");var s=m.getAttribute("dragy");var q=a.getAttribute("dragx");var p=a.getAttribute("dragy");SVG.drawLine(u,s,q,p,this.GraphEdgeGroup,r);
var k={};k.id=this.getSVGEdgeId(e.getId());k["stroke-opacity"]=0;k["stroke-width"]=4;k["stroke"]="black";b=SVG.drawLine(m.getAttribute("dragx"),m.getAttribute("dragy"),a.getAttribute("dragx"),a.getAttribute("dragy"),this.GraphEdgeGroup,k);}if(this.getFormatter().getEdgeById(t) instanceof BezierEdgeGraphFormatter){var h=e.getNodeTarget().getId();
var i=this.formatter.getVertexById(h).getDefault().getSize()*this.getFormatter().getNodesMaxSize();r.fill="none";r.id=this.getSVGEdgeId(t);var o=this.calculateCoordenatesBezier(i,m.getAttribute("dragx"),m.getAttribute("dragy"));b=SVG.drawPath(o,this.GraphEdgeGroup,r);}if((this.getFormatter().getEdgeById(t) instanceof DirectedLineEdgeGraphFormatter)||(this.getFormatter().getEdgeById(t) instanceof CutDirectedLineEdgeGraphFormatter)||(this.getFormatter().getEdgeById(t) instanceof DotDirectedLineEdgeGraphFormatter)||(this.getFormatter().getEdgeById(t) instanceof OdotDirectedLineEdgeGraphFormatter)||(this.getFormatter().getEdgeById(t) instanceof OdirectedLineEdgeGraphFormatter)){var u=m.getAttribute("dragx");
var s=m.getAttribute("dragy");var q=a.getAttribute("dragx");var p=a.getAttribute("dragy");var c=parseFloat(this.getFormatter().getVertexById(this.getDataset().getEdgeById(t).getNodeTarget().getId()).getDefault().getSize()*this.circleDefaultRadius);var j=this._calculateEdgePointerPosition(u,s,q,p,c);q=j.x;
p=j.y;SVG.drawLine(u,s,q,p,this.GraphEdgeGroup,r);var k={};k.id=this.getSVGEdgeId(e.getId());k["stroke-opacity"]=0;k["stroke-width"]=4;k["stroke"]="black";b=SVG.drawLine(u,s,q,p,this.GraphEdgeGroup,k);}if(this.getFormatter().getEdgeById(t) instanceof DirectedLineEdgeGraphFormatter||(this.getFormatter().getEdgeById(t) instanceof OdirectedLineEdgeGraphFormatter)){var u=m.getAttribute("dragx");
var s=m.getAttribute("dragy");var q=a.getAttribute("dragx");var p=a.getAttribute("dragy");var j=this._calculateEdgePointerPosition(u,s,q,p,c);q=j.x;p=j.y;var n=Geometry.toDegree(j.angle)+90;this.arrowDefaultSize=this.getFormatter().getEdgeById(t).getArrowSize();var o="-"+this.arrowDefaultSize+",0 0,-"+parseFloat(this.arrowDefaultSize)*2+" "+this.arrowDefaultSize+",0";
var g;if(this.getFormatter().getEdgeById(t) instanceof DirectedLineEdgeGraphFormatter){g=[["fill",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["stroke",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["id",this.getSVGArrowEdgeId(t)]];}else{g=[["fill","#FFFFFF"],["stroke",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["id",this.getSVGArrowEdgeId(t)]];
}var f=SVG.drawPoligon(o,this.GraphEdgeGroup,g);f.setAttribute("transform"," translate("+q+", "+p+"), rotate("+n+")");}if(this.getFormatter().getEdgeById(t) instanceof CutDirectedLineEdgeGraphFormatter){var u=m.getAttribute("dragx");var s=m.getAttribute("dragy");var q=a.getAttribute("dragx");var p=a.getAttribute("dragy");
var j=this._calculateEdgePointerPosition(u,s,q,p,c);q=j.x;p=j.y;var n=Geometry.toDegree(j.angle)+90;var o="-4,0 4,0 4,-2 -4,-2";var f=SVG.drawPoligon(o,this.GraphEdgeGroup,[["fill",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["stroke",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["id",this.getSVGArrowEdgeId(t)]]);
f.setAttribute("transform"," translate("+q+", "+p+"), rotate("+n+")");}if((this.getFormatter().getEdgeById(t) instanceof DotDirectedLineEdgeGraphFormatter)||(this.getFormatter().getEdgeById(t) instanceof OdotDirectedLineEdgeGraphFormatter)){var u=m.getAttribute("dragx");var s=m.getAttribute("dragy");
var q=a.getAttribute("dragx");var p=a.getAttribute("dragy");var j=this._calculateEdgePointerPosition(u,s,q,p,c);q=j.x;p=j.y;var n=Geometry.toDegree(j.angle)+90;var g=[];if(this.getFormatter().getEdgeById(t) instanceof OdotDirectedLineEdgeGraphFormatter){g=[["fill","#FFFFFF"],["stroke",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["id",this.getSVGArrowEdgeId(t)]];
}else{g=[["fill",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["stroke",this.getFormatter().getEdgeById(t).getDefault().getStroke()],["id",this.getSVGArrowEdgeId(t)]];}var f=SVG.drawCircle(0,0,4,this.GraphEdgeGroup,g);f.setAttribute("transform"," translate("+q+", "+p+"), rotate("+n+")");
}var l=this;if(b!=null){if(this.getDataset().getEdgesCount()<this.args.maxNumberEdgesFiringEvents){b.addEventListener("mouseover",function(){l.overEdge(t);},false);b.addEventListener("mouseout",function(){l.outEdge(t);},false);}}};GraphCanvas.prototype._calculateEdgePointerPosition=function(i,h,g,f,d){var j=Geometry.getAngleBetweenTwoPoints(i,h,g,f);
if((g-i)<0){var c=Geometry.getAdjacentSideOfRectangleRight(j,d);g=parseFloat(g)+parseFloat(c);arrowX=parseFloat(g)+parseFloat(c)+this.arrowDefaultSize/2;}else{var c=Geometry.getAdjacentSideOfRectangleRight(j,d);g=parseFloat(g)-parseFloat(c);arrowX=parseFloat(g)-parseFloat(c)-this.arrowDefaultSize/2;}if((f-h)>0){var e=Geometry.getOppositeSideOfRectangleRight(j,d);
f=parseFloat(f)-parseFloat(e);arrowY=parseFloat(f)-parseFloat(e)-this.arrowDefaultSize/2;}else{var e=Geometry.getOppositeSideOfRectangleRight(j,d);f=parseFloat(f)+parseFloat(e);arrowY=parseFloat(f)+parseFloat(e)-this.arrowDefaultSize/2;}return{"x":arrowX,"y":arrowY,"angle":j};};GraphCanvas.prototype.calculateCoordenatesBezier=function(h,c,i){var k=c-(h/2);
var b=i-(h/2);var j=parseFloat(c)+parseFloat(h/2);var a=i-(h/2);var f=(j-k)/2+k;var e=i-(h*2);var g="M"+k+","+b+" T"+f+","+e+" "+j+","+a;return g;};GraphCanvas.prototype.renderEdges=function(){for(var a in this.getDataset().getEdges()){this.renderEdge(this.getDataset().getEdgeById(a).getId());}};GraphCanvas.prototype.getLastSelectedNode=function(){var a=null;
if(this.getSelectedVertices().length>0){var b=this.getSelectedVertices()[this.getSelectedVertices().length-1];a=this.getDataset().getVertexById(b);}return a;};GraphCanvas.prototype.setDataset=function(a){this.dataset=a;};GraphCanvas.prototype.setFormatter=function(a){this.formatter=a;};GraphCanvas.prototype.setLayout=function(a){this.layout=a;
};GraphCanvas.prototype.getDataset=function(){return this.dataset;};GraphCanvas.prototype.getFormatter=function(){return this.formatter;};GraphCanvas.prototype.getLayout=function(){return this.layout;};GraphCanvas.prototype.addVertex=function(b,a){this.getDataset().addNode(b,a);};GraphCanvas.prototype.removeVertex=function(a){this.getDataset().getVertexById(a).remove();
};GraphCanvas.prototype.addEdge=function(a,d,c,b){this.getDataset().addEdge(a,d,c,b);};GraphCanvas.prototype.getWidth=function(){return this.getFormatter().getWidth();};GraphCanvas.prototype.getHeight=function(){return this.getFormatter().getHeight();};GraphCanvas.prototype.getBackgroundImage=function(){return this.getFormatter().getBackgroundImage();
};GraphCanvas.prototype.getBackgroundColor=function(){return this.getFormatter().getBackgroundColor();};GraphCanvas.prototype.setBackgroundColor=function(){this.getFormatter().setBackgroundColor(value);};GraphCanvas.prototype.setVertexSize=function(a,b){this.getFormatter().getVertexById(a).getDefault().setSize(b);
};GraphCanvas.prototype.getVertexSize=function(a){return this.getFormatter().getVertexById(a).getDefault().getSize();};GraphCanvas.prototype.setVertexStroke=function(a,b){this.getFormatter().getVertexById(a).getDefault().setStroke(b);};GraphCanvas.prototype.getVertexStroke=function(a){return this.getFormatter().getVertexById(a).getDefault().getStroke();
};GraphCanvas.prototype.setVertexStrokeOpacity=function(a,b){this.getFormatter().getVertexById(a).getDefault().setStrokeOpacity(b);};GraphCanvas.prototype.getVertexStrokeOpacity=function(a){return this.getFormatter().getVertexById(a).getDefault().getStrokeOpacity();};GraphCanvas.prototype.setVertexOpacity=function(a,b){this.getFormatter().getVertexById(a).getDefault().setOpacity(b);
};GraphCanvas.prototype.getVertexOpacity=function(a){return this.getFormatter().getVertexById(a).getDefault().getOpacity();};GraphCanvas.prototype.setVertexFill=function(a,b){this.getFormatter().getVertexById(a).getDefault().setFill(b);};GraphCanvas.prototype.getVertexFill=function(a){return this.getFormatter().getVertexById(a).getDefault().getFill();
};GraphCanvas.prototype.setEdgeSize=function(b,a){this.getFormatter().getEdgeById(b).getDefault().setSize(a);};GraphCanvas.prototype.getEdgeSize=function(a){return this.getFormatter().getEdgeById(a).getDefault().getSize();};GraphCanvas.prototype.setEdgeStroke=function(b,a){this.getFormatter().getEdgeById(b).getDefault().setStroke(a);
};GraphCanvas.prototype.getEdgeStroke=function(a){return this.getFormatter().getEdgeById(a).getDefault().getStroke();};GraphCanvas.prototype.setEdgeStrokeOpacity=function(b,a){this.getFormatter().getEdgeById(b).getDefault().setStrokeOpacity(a);};GraphCanvas.prototype.getEdgeStrokeOpacity=function(a){return this.getFormatter().getEdgeById(a).getDefault().getStrokeOpacity();
};GraphCanvas.prototype.setEdgeFill=function(b,a){this.getFormatter().getEdgeById(b).getDefault().setFill(a);};GraphCanvas.prototype.getEdgeFill=function(a){return this.getFormatter().getEdgeById(a).getDefault().getFill();};GraphCanvas.prototype.setCoordinates=function(b,a,c){return this.getLayout().getEdgeById(b).setCoordinates(a,c);
};function HPLCGraph(a){this.width=600;this.height=600;this.title="";this.bbar=false;this.plotInnerPanelPadding=10;this.plotPanelPadding=5;this.id=BUI.id();this.hidePlots=null;this.xlabel="";this.scaled=false;this.xParam=null;this.showRangeSelector=true;this.interactionModel=null;this.ranges={};if(a!=null){if(a.interactionModel!=null){this.interactionModel=a.interactionModel;
}if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}if(a.bbar!=null){this.bbar=a.bbar;}if(a.title!=null){this.title=a.title;}if(a.plots!=null){this.plots=a.plots;}if(a.scaled!=null){this.scaled=a.scaled;}if(a.xlabel!=null){this.xlabel=a.xlabel;}if(a.xParam!=null){this.xParam=a.xParam;
}if(a.showRangeSelector!=null){this.showRangeSelector=a.showRangeSelector;}}this.onZoomX=new Event(this);this.onResetZoom=new Event(this);this.dblclick=new Event(this);}HPLCGraph.prototype.getMenu=function(){var f=this;var e=[];function a(g,h){if(h){f.plots[g.param]=true;}else{delete f.plots[g.param];
}f.reloadData(this.hplcData);}for(var b=0;b<this.hplcData.length;b++){if(this.hplcData[b].showOnMenu!=false){var d=this.hplcData[b].param;var c="style='padding:0 0px 0 5px;'";e.push({text:"<table><tr><td>"+BUI.getRectangleColorDIV(this.hplcData[b].color,10,10)+"</td><td "+c+"> "+this.hplcData[b].label+"</td></tr></table>",id:f.id+d,param:d,enableToggle:true,scope:this,toggleHandler:a,pressed:(f.plots[d]!=null)});
}}e.push("-");e.push({text:"Scale",enableToggle:true,scope:this,pressed:this.scaled,icon:"../images/icon_graph.png",toggleHandler:function(g,h){f.scaled=h;f.reloadData(this.hplcData);}});e.push("->");e.push({text:"Save",scope:this,icon:"../images/save.gif",handler:function(g,h){var i=document.createElement("img");
i.style.display="block";i.style.width=200+"px";i.style.height=200+"px";i.setAttribute("src",Dygraph.Export.asCanvas(this.dygraphObject.dygraph).toDataURL());window.open(Dygraph.Export.asCanvas(this.dygraphObject.dygraph).toDataURL(),"Image","");}});return e;};HPLCGraph.prototype.scaledData=function(c){for(var b=0;
b<c.length;b++){var a=this.getMaxAndMinValue(c[b]);c[b]=this.divideValuesByMax(c[b],a.max);this.ranges[c[b].label]=a;}return c;};HPLCGraph.prototype.divideValuesByMax=function(c,a){for(var b=0;b<c.data.length;b++){if(a!=0){c.data[b]=Number(c.data[b])/a;c.std[b]=Number(c.std[b])/a;}}return c;};HPLCGraph.prototype.getMaxAndMinValue=function(d){var a=0;
var c=d.data[0];for(var b=0;b<d.data.length;b++){if(Number(d.data[b])>a){a=Number(d.data[b]);}if(Number(d.std[b])>a){a=Number(d.std[b]);}if(Number(d.data[b])<c){c=Number(d.data[b]);}}return{max:Number(a),min:Number(c)};};HPLCGraph.prototype.getPoint=function(d,c){var a=[10,10,10];var e=parseFloat(d.data[c]);
var b=parseFloat(d.std[c]);if(d.fdata==null){return[e-b,e,e+b];}else{if(d.fstd!=null){return[d.fstd(e-b),d.fdata(e),d.fstd(e+b)];}return[d.fdata(e)-b,d.fdata(e),d.fdata(e)+b];}return a;};HPLCGraph.prototype.reloadData=function(h){this.panel.setLoading(false);this.hplcData=h;var f=h;if(this.peaks!=null){for(var d in this.peaks){var n=[];
var c=[];for(var g=0;g<this.peaks[d].length;g++){n.push(this.peaks[d][g][1]);c.push(this.peaks[d][g][2]);}f.push({param:d,data:n,showOnMenu:false,fdata:function(i){var j=(Math.log(parseFloat(i)));if(isNumber(j)){return j;}},fstd:function(i){var j=Math.log(Math.abs(parseFloat(i)));if(isNumber(j)){return j;
}},std:c,color:this.colorPeak[d],label:d});}}if(this.scaled){f=this.scaledData(JSON.parse(JSON.stringify(h)));}var o={};var m=[];var e=0;for(var g=0;g<f[0].data.length-1;g++){var b=[];for(e=0;e<f.length;e++){if(this.plots!=null){if(this.plots[f[e].param]!=null){b.push(this.getPoint(f[e],g));o[f[e].param]=b.length-1;
}}else{b.push([f[e].data[g]-f[e].std[g],f[e].data[g],f[e].data[g]+f[e].std[g]]);}}m.push([]);var l=g;if(this.xParam!=null){l=parseFloat(f[this.xParam].data[g]);}m[m.length-1].push(l);for(e=0;e<f.length;e++){if(this.plots!=null){if(this.plots[f[e].param]!=null){m[m.length-1].push(b[o[f[e].param]]);}}else{m[m.length-1].push(b[e]);
}}}var a=[];var k=[""];for(e=0;e<f.length;e++){if(this.plots!=null){if(this.plots[f[e].param]!=null){a.push(f[e].color);k.push(f[e].label);}}else{m[m.length-1].push(b[e]);}}this._renderDygraph(m,a,k);};HPLCGraph.prototype._renderDygraph=function(b,a,d){this.dygraphObject=new StdDevDyGraph(this.id,{width:this.width,height:this.height-10,xlabel:this.xlabel,showRangeSelector:this.showRangeSelector,interactionModel:this.interactionModel,scaled:this.scaled,ranges:this.ranges});
this.dygraphObject.draw(b,a,d);var c=this;this.dygraphObject.onZoomX.attach(function(g,f){try{c.onZoomX.notify(f);}catch(h){}});this.dygraphObject.onResetZoom.attach(function(g,f){try{c.onResetZoom.notify(f);}catch(h){}});this.dygraphObject.dblclick.attach(function(g,f){try{c.dblclick.notify(f);}catch(h){}});
};HPLCGraph.prototype.loadData=function(a){var b=this;this.reloadData(a);this.panel.addDocked({xtype:"toolbar",items:this.getMenu()});if(this.bbar==true){this.panel.addDocked({xtype:"toolbar",dock:"bottom",items:[{xtype:"numberfield",id:"main_field_start",fieldLabel:"Range from",width:170,labelWidth:70,value:0,minValue:0},{xtype:"numberfield",id:"main_field_end",fieldLabel:"to",width:130,labelWidth:30,value:0,minValue:0},{xtype:"button",text:"Go",handler:function(){var e=parseFloat(Ext.getCmp("main_field_start").getValue());
var d=parseFloat(Ext.getCmp("main_field_end").getValue());if(e<0){e=0;}if(d<0){d=0;}if(e>d){var c=d;d=e;e=c;}b.dygraphObject.dygraph.updateOptions({isZoomedIgnoreProgrammaticZoom:true,dateWindow:[e,d]});}}]});}};HPLCGraph.prototype.getPanel=function(){this.panel=Ext.create("Ext.panel.Panel",{padding:this.plotPanelPadding,width:this.width+4*this.plotInnerPanelPadding,height:this.height+4*this.plotInnerPanelPadding,items:[{html:"",id:this.id,width:this.width,height:this.height}]});
return this.panel;};HPLCGraph.prototype.input=function(){return DATADOC.getHPLCData();};HPLCGraph.prototype.getDataByFrameNumber=function(c){var b={};b.frameNumber=c;for(var a in this.hplcData){b[this.hplcData[a].label]=this.hplcData[a].data[c];}console.log(b);return b;};HPLCGraph.prototype.test=function(b){var a=new HPLCGraph({title:"I0",width:800,height:400,plots:{"I0":true,"Rg":true,"Mass":true},xlabel:"HPLC Frames",scaled:this.scaled,interactionModel:{"dblclick":function(e,d,c){}}});
a.getPanel().render(b);a.loadData(a.input());};function MergesHPLCGraph(a){HPLCGraph.prototype.constructor.call(this,a);this.peakColors=["#DEBD00","#6D9100","#872900","#0092CC"];}MergesHPLCGraph.prototype.scaledData=HPLCGraph.prototype.scaledData;MergesHPLCGraph.prototype.divideValuesByMax=HPLCGraph.prototype.divideValuesByMax;
MergesHPLCGraph.prototype.getMaxAndMinValue=HPLCGraph.prototype.getMaxAndMinValue;MergesHPLCGraph.prototype.getPoint=HPLCGraph.prototype.getPoint;MergesHPLCGraph.prototype.reloadData=HPLCGraph.prototype.reloadData;MergesHPLCGraph.prototype._renderDygraph=HPLCGraph.prototype._renderDygraph;MergesHPLCGraph.prototype.loadData=HPLCGraph.prototype.loadData;
MergesHPLCGraph.prototype.getPanel=HPLCGraph.prototype.getPanel;MergesHPLCGraph.prototype.input=HPLCGraph.prototype.input;MergesHPLCGraph.prototype.test=HPLCGraph.prototype.test;MergesHPLCGraph.prototype.getDataByFrameNumber=HPLCGraph.prototype.getDataByFrameNumber;MergesHPLCGraph.prototype.setPeaks=function(d){this.peaks=d;
this.peakKeys=[];this.colorPeak={};var b=1;for(var c in this.peaks){if(this.peaks.hasOwnProperty(c)){var a=this.peakColors[b%this.peakColors.length];b=b+1;this.peakKeys.push(c);this.colorPeak[c]=a;}}this.peakKeys.sort();};MergesHPLCGraph.prototype.getMenu=function(){var j=this;var e=[];function h(i,l){if(l){j.plots[i.param]=true;
}else{delete j.plots[i.param];}j.reloadData(j.hplcData);}if(this.peaks!=null){var k=[];for(var g=0;g<this.peakKeys.length;g++){var d=this.colorPeak[this.peakKeys[g]];k.push({text:"<span style='color:"+d+"; font-weight:bold;'>Peak #"+g+" "+this.peakKeys[g].replace("- "," to #").replace(".0","").replace(".0","")+"</span>",peakid:this.peakKeys[g],checked:false,checkHandler:function(i,m){var l=new Object();
l.param=i.peakid;h(l,m);}});}var b=Ext.create("Ext.menu.Menu",{id:"mainMenu",style:{overflow:"visible"},items:k});var f=Ext.create("Ext.toolbar.Toolbar");f.add({text:"Peaks Avg.",menu:b});e.push(f);}for(var g=0;g<this.hplcData.length;g++){if(this.hplcData[g].showOnMenu!=false){var c=this.hplcData[g].param;
var a="style='padding:0 0px 0 5px;'";e.push({text:"<table><tr><td>"+BUI.getRectangleColorDIV(this.hplcData[g].color,10,10)+"</td><td "+a+"> "+this.hplcData[g].label+"</td></tr></table>",id:j.id+c,param:c,enableToggle:true,scope:this,margin:5,toggleHandler:h,pressed:(j.plots[c]!=null)});}}e.push("->");
e.push({text:"Save",scope:this,icon:"../images/save.gif",handler:function(i,l){var m=document.createElement("img");m.style.display="block";m.style.width=200+"px";m.style.height=200+"px";m.setAttribute("src",Dygraph.Export.asCanvas(this.dygraphObject.dygraph).toDataURL());window.open(Dygraph.Export.asCanvas(this.dygraphObject.dygraph).toDataURL(),"Image","");
}});return e;};function NetworkWidget(a){this.id="NetworkViewer_"+Math.random().toString().replace(".","_");this.label=true;if(a!=null){if(a.targetId!=null){this.targetId=a.targetId;}if(a.label!=null){this.label=a.label;}}this.onVertexOver=new Event(this);this.onVertexOut=new Event(this);}NetworkWidget.prototype.draw=function(c,a,b){this.graphCanvas=new GraphCanvas(this.id,document.getElementById(this.targetId),{"labeled":this.label,"multipleSelectionEnabled":false,"draggingCanvasEnabled":false});
this.graphCanvas.draw(c,a,b);var d=this;this.graphCanvas.onVertexOver.attach(function(e,f){d.onVertexOver.notify(f);});this.graphCanvas.onVertexOut.attach(function(e,f){d.onVertexOut.notify(f);});};NetworkWidget.prototype.selectVertexByName=function(d){var b=this.getDataset().getVertexByName(d);if(b!=null){for(var c in b){if(b.hasOwnProperty(c)){var a=b[c].getId();
this.selectVertexById(a);}}}};NetworkWidget.prototype.selectVerticesByName=function(b){for(var a=0;a<b.length;a++){this.selectVertexByName(b[a]);}};NetworkWidget.prototype.selectVertexById=function(a){this.graphCanvas.selectNode(a);this.blinkVertexById(a);};NetworkWidget.prototype.selectVerticesById=function(b){for(var a=0;
a<b.length;a++){this.selectVertexById(b[a]);}};NetworkWidget.prototype.selectNeighbourhood=function(){this.selectEdgesFromVertices();this.selectAdjacent();};NetworkWidget.prototype.deselectNodes=function(){this.graphCanvas.deselectNodes();};NetworkWidget.prototype.selectAllNodes=function(){this.getGraphCanvas().selectAllNodes();
};NetworkWidget.prototype.selectAll=function(){this.getGraphCanvas().selectAll();};NetworkWidget.prototype.selectAllEdges=function(){this.getGraphCanvas().selectAllEdges();};NetworkWidget.prototype.setScale=function(a){this.graphCanvas.setScale(a);};NetworkWidget.prototype.getScale=function(){return this.graphCanvas.getScale(value);
};NetworkWidget.prototype.selectAdjacent=function(){var d=this.getGraphCanvas().getSelectedVertices();var a=[];for(var c=0;c<d.length;c++){a=a.concat(this.getGraphCanvas().getDataset().getVertexById(d[c]).getEdges());}var b=[];for(c=0;c<a.length;c++){b.push(a[c].getNodeSource().getId());b.push(a[c].getNodeTarget().getId());
}this.selectVerticesById(b);};NetworkWidget.prototype.selectEdgesFromVertices=function(){var d=this.getGraphCanvas().getSelectedVertices();var b=[];for(var c=0;c<d.length;c++){b=b.concat(this.getGraphCanvas().getDataset().getVertexById(d[c]).getEdges());}var a=[];for(c=0;c<b.length;c++){a.push(b[c].getId());
}this.getGraphCanvas().selectEdges(a);};NetworkWidget.prototype.blinkVertexById=function(a){this.graphCanvas.blinkVertexById(a);};NetworkWidget.prototype.selectConnectedComponent=function(){var a=this.getConnectedComponent();this.selectVerticesById(a.nodes);this.graphCanvas.selectEdges(a.edges);};NetworkWidget.prototype.getConnectedComponent=function(){var a={};
var f={};var c=[];var e=[];var d=this.getGraphCanvas().getSelectedVertices();for(var b=0;b<d.length;b++){this.visitNode(d[b],a,f,c,e);}return{nodes:c,edges:e};};NetworkWidget.prototype.visitNode=function(d,l,a,k,e){l[d]=true;k.push(d);var b=this.getDataset().getVertexById(d).getEdges();for(var f=0;f<b.length;
f++){var c=b[f];var g=c.getId();if(a[g]==null){a[g]=true;e.push(g);var i=c.getNodeTarget().getId();if(l[i]==null){this.visitNode(i,l,a,k,e);}var h=c.getNodeSource().getId();if(l[h]==null){this.visitNode(h,l,a,k,e);}}}};NetworkWidget.prototype.collapse=function(){var k=this.getGraphCanvas().getSelectedVertices();
var a=-Infinity;var f=Infinity;var l=-Infinity;var b=Infinity;for(var e=0;e<k.length;e++){var g=this.getGraphCanvas().getLayout().getNodeById(k[e]);if(a<g.x){a=g.x;}if(f>g.x){f=g.x;}if(l<g.y){l=g.y;}if(b>g.y){b=g.y;}}var d=a-f;var c=l-b;var j=(f-a)/4;var h=k.length;var m=[];for(e=0;e<k.length;e++){x=d+j*Math.sin(e*2*Math.PI/h);
y=c+j*Math.cos(e*2*Math.PI/h);m.push({"x":x,"y":y});}for(e=0;e<k.length;e++){this.getGraphCanvas().getLayout().getNodeById(k[e]).setCoordinates(m[e].x,m[e].y);}};NetworkWidget.prototype.setVerticesFontSize=function(a){for(var b in this.getDataset().getVertices()){if(this.getDataset().getVertices().hasOwnProperty(b)){this.getFormatter().getVertexById(b).getDefault().setFontSize(a);
}}};NetworkWidget.prototype.getFormatter=function(){return this.getGraphCanvas().getFormatter();};NetworkWidget.prototype.getLayout=function(){return this.getGraphCanvas().getLayout();};NetworkWidget.prototype.getDataset=function(){return this.getGraphCanvas().getDataset();};NetworkWidget.prototype.getGraphCanvas=function(){return this.graphCanvas;
};RangeWhiskerGraph.prototype.cleanArray=GenericGraph.prototype.cleanArray;RangeWhiskerGraph.prototype.plotAxes=GenericGraph.prototype.plotAxes;RangeWhiskerGraph.prototype.plotRuler=GenericGraph.prototype.plotRuler;RangeWhiskerGraph.prototype.drawSVGVerticalText=GenericGraph.prototype.drawSVGVerticalText;
RangeWhiskerGraph.prototype.getClassColor=GenericGraph.prototype.getClassColor;RangeWhiskerGraph.prototype.getDimensions=GenericGraph.prototype.getDimensions;RangeWhiskerGraph.prototype.calculate=GenericGraph.prototype.calculate;RangeWhiskerGraph.prototype.getMedian=GenericGraph.prototype.getMedian;RangeWhiskerGraph.prototype.pointToPixel=GenericGraph.prototype.pointToPixel;
RangeWhiskerGraph.prototype.maxValueWhisker=GenericGraph.prototype.maxValueWhisker;RangeWhiskerGraph.prototype.refresh=GenericGraph.prototype.refresh;function RangeWhiskerGraph(a){this.maxBoxWidth=25;if(a==null){a={};}a.plotHorizontalByCluster=false;GenericGraph.call(this,a);if(a.maxBoxWidth!=null){this.maxBoxWidth=a.maxBoxWidth;
}}RangeWhiskerGraph.prototype.refresh=function(a){document.getElementById(this.targetId).innerHTML="";this.draw(this.targetId,a);};RangeWhiskerGraph.prototype.isNumber=function(a){if(a==""){return false;}var b=parseInt(a);if(!isNaN(b)){return true;}else{return false;}};RangeWhiskerGraph.prototype.getQ1=function(a){a=a.slice(0,a.length/2);
return this.getMedian(a);};RangeWhiskerGraph.prototype.getQ3=function(a){a=a.slice((a.length+1)/2);return this.getMedian(a);};RangeWhiskerGraph.prototype.getQ2=function(a){return this.getMedian(a);};RangeWhiskerGraph.prototype.getBelowOutliers=function(d,c){var b=[];for(var a=0;a<c.length;a++){if(c[a]<=d){b.push(c[a]);
}}return b;};RangeWhiskerGraph.prototype.getAboveOutliers=function(a,d){var c=[];for(var b=0;b<d.length;b++){if(d[b]>=a){c.push(d[b]);}}return c;};RangeWhiskerGraph.prototype.minValueWhisker=function(e,a,d){var c=[];for(var b=0;b<d.length;b++){if((d[b]<a)&&(d[b])>e){c.push(d[b]);}}if(c.length>0){c.sort(function(g,f){return g-f;
});return c[0];}return null;};RangeWhiskerGraph.prototype.drawPoints=function(d){if(this.plotPoints){for(var a=0;a<d.values.length;a++){var b=d.values[a];var c=this.pointToPixel(b,d);SVG.drawCircle(d.x,c,this.pointRadius,this.svg,[["fill","green"],["fill-opacity",this.fillOpacityPoint],["stroke-opacity",this.strokeOpacityPoint],["stroke","black"]]);
}}};RangeWhiskerGraph.prototype.plotRangeQ1Q3=function(A,b){var d=this.left+this.rulerWidth;var p=[];var m=[];var o=[];for(var t=0;t<A.clusters.length;t++){var u=A.clusters[t];d=d+this.interClustersSpace;for(var r=0;r<u.classes.length;r++){var c=b.width/(b.xValues.range);var w=(u.x-b.xValues.min)*c+this.rulerWidth;
var a={name:u.classes[r].name,values:u.classes[r].values,minPoint:b.minPoint,maxPoint:b.maxPoint,x:w+this.left,y:this.top,width:b.classWidth,height:this.height-this.top-this.bottom-this.clusterTitleHeight-this.rulerHeight};var l=this.calculate(a.values);var n=this.getClassColor(a.name);if(this.isNumber(l.Q1)&&this.isNumber(l.Q3)){var h=a.x;
var g=this.pointToPixel(l.Q1,a);if(p[u.classes[r].name]==null){p[u.classes[r].name]=[];}p[u.classes[r].name].push({x:h,y:g});h=a.x;g=this.pointToPixel(l.Q3,a);if(m[u.classes[r].name]==null){m[u.classes[r].name]=[];}m[u.classes[r].name].push({x:h,y:g});}else{if(this.isNumber(l.Q2)){if(p[u.classes[r].name]==null){p[u.classes[r].name]=[];
}if(m[u.classes[r].name]==null){m[u.classes[r].name]=[];}p[u.classes[r].name].push({x:a.x,y:this.pointToPixel(l.Q2,a)});m[u.classes[r].name].push({x:a.x,y:this.pointToPixel(l.Q2,a)});}}}}for(var v in p){var s=p[v];var f="";for(var q=0;q<s.length;q++){f=Number(s[q].x).toFixed(1)+","+Number(s[q].y).toFixed(1)+" "+f;
}s=m[v];for(var e=s.length-1;e>=0;e--){f=Number(s[e].x).toFixed(1)+","+Number(s[e].y).toFixed(1)+" "+f;}SVG.drawPoligon(f,this.svg,[["fill",this.getClassColor(v)],["opacity","0.3"],["stroke","black"],["stroke-width",1]]);}};RangeWhiskerGraph.prototype.plotWhisters=function(d,g){var a=["yellow","orange","green"];
this.plotRangeQ1Q3(d,g);var h={};for(var e=0;e<d.clusters.length;e++){var m=d.clusters[e];for(var c=0;c<m.classes.length;c++){var f=g.width/(g.xValues.range);var b=(m.x-g.xValues.min)*f+this.left+this.rulerWidth-this.rulerStroke;var l={name:m.classes[c].name,values:m.classes[c].values,minPoint:g.minPoint,maxPoint:g.maxPoint,x:b,y:this.top,width:g.classWidth,height:this.height-this.top-this.bottom-this.clusterTitleHeight-this.rulerHeight};
this.drawPoints(l);var n=this.calculate(l.values);var k=this.getClassColor(l.name);if(this.isNumber(n.Q2)){if(h[l.name]!=null){SVG.drawLine(l.x,this.pointToPixel(n.Q2,l),h[l.name].x,h[l.name].y,this.svg,[["stroke",k],["stroke-width","2"]]);}h[l.name]={x:l.x,y:this.pointToPixel(n.Q2,l)};}}}};RangeWhiskerGraph.prototype.draw=function(a,c){this.targetId=a;
var b=(this.getDimensions(c));this.svg=SVG.createSVGCanvas(document.getElementById(this.targetId),[["width",this.width],["height",this.height]]);this.plotAxes(b);this.plotWhisters(c,b);};RangeWhiskerGraph.prototype.input=function(){return DATADOC.getBoxWhikerData();};RangeWhiskerGraph.prototype.test=function(a){var b=new RangeWhiskerGraph({targetId:a,height:350,width:450,maxBoxWidth:25});
b.refresh(this.input());};StdDevDyGraph.prototype.dblclick=DygraphWidget.prototype.dblclick;StdDevDyGraph.prototype._createHTLMWrapper=DygraphWidget.prototype._createHTLMWrapper;StdDevDyGraph.prototype.draw=DygraphWidget.prototype.draw;function StdDevDyGraph(b,a){this.scaled=false;if(a==null){a={};}a.customBars=true;
DygraphWidget.prototype.constructor.call(this,b,a);}StdDevDyGraph.prototype.input=function(){return{data:[[1,[2,3,3.5],[4,4.2,5]],[2,[5,5.5,5.7],[4,4.2,5]]],colors:["blue","red"],labels:["","data1","data2"]};};StdDevDyGraph.prototype.test=function(b){var a=new StdDevDyGraph(b,{width:500,height:400,xlabel:"xLabel",showRangeSelector:false});
a.draw(a.input().data,a.input().colors,a.input().labels);};function AbinitioGrid(a){this.onSelected=new Event(this);}AbinitioGrid.prototype.refresh=function(a){this.store.loadData(this._prepareData(a));};AbinitioGrid.prototype._prepareData=function(d){var e=[];for(var a=0;a<d.length;a++){var c=d[a];if(c.averagedModel!=null){e.push(c.averagedModel);
e[e.length-1].type="Reference";}if(c.shapeDeterminationModel!=null){e.push(c.shapeDeterminationModel);e[e.length-1].type="Refined";}if(c.modelList3VO!=null){if(c.modelList3VO.modeltolist3VOs!=null){for(var b=0;b<c.modelList3VO.modeltolist3VOs.length;b++){e.push(c.modelList3VO.modeltolist3VOs[b].model3VO);
e[e.length-1].type="Model";}}}}return e;};AbinitioGrid.prototype.getPanel=function(c){var e=this;var d=this._prepareData(c);var a=["modelId","type","chiSqrt","dmax","firFile","logFile","fitFile","pdbFile","rfactor","rg","volume"];Ext.define("AbinitioModel",{extend:"Ext.data.Model",fields:a});this.store=Ext.create("Ext.data.Store",{model:"AbinitioModel",autoload:true,data:d,groupField:"type"});
var b=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{name} ({rows.length} model{[values.rows.length > 1 ? "s" : ""]})',startCollapsed:true,collapsible:true});this.grid=Ext.create("Ext.grid.Panel",{collapsible:false,resizable:true,features:[b],autoscroll:true,multiSelect:true,store:this.store,height:300,columns:[{text:"Type",dataindex:"type",hidden:true,renderer:function(h,f,g){return g.data.type;
},flex:1},{text:"ModelId",dataindex:"modelId",hidden:true,renderer:function(h,f,g){return g.data.modelId;},flex:1},{text:"chiSqrt",dataindex:"chiSqrt",renderer:function(h,f,g){if(g.data.dmax!=null){return BUI.formatValuesUnits(g.data.chiSqrt,"",12,this.decimals);}},flex:1},{text:"Dmax",dataindex:"dmax",renderer:function(h,f,g){if(g.data.dmax!=null){return BUI.formatValuesUnits(g.data.dmax,"nm",12,this.decimals);
}},flex:1},{text:"rFactor",dataindex:"rfactor",hidden:true,renderer:function(h,f,g){if(g.data.rfactor!=null){return g.data.rfactor;}},flex:1},{text:"Rg",dataindex:"rg",renderer:function(h,f,g){if(g.data.rg!=null){return BUI.formatValuesUnits(g.data.rg,"nm",12,this.decimals);}},flex:1},{text:"Volume",dataindex:"volume",renderer:function(h,f,g){if(g.raw.volume!=null){return BUI.formatValuesUnits(g.raw.volume,"")+"<span style='font-size:8px;color:gray;'> nm<sub>3</sub></span>";
}},flex:1},{text:"PDB",dataindex:"pdbFile",renderer:function(h,f,g){if(g.data.pdbFile!=null){return g.data.pdbFile.split("/")[g.data.pdbFile.split("/").length-1];}},flex:1},{text:"Fir",dataindex:"firFile",renderer:function(h,f,g){if(g.data.firFile!=null){return g.data.firFile.split("/")[g.data.firFile.split("/").length-1];
}},flex:1},{text:"LOG",dataindex:"logFile",hidden:true,renderer:function(h,f,g){if(g.data.logFile!=null){return g.data.logFile.split("/")[g.data.logFile.split("/").length-1];}},flex:1}],viewConfig:{enableTextSelection:true,preserveScrollOnRefresh:true,stripeRows:true,listeners:{"celldblclick":function(i,m,g,f,j,l,k,h){},"cellclick":function(f,h,o,k,n,p,l,m){var g=[];
for(var j=0;j<f.getSelectionModel().selected.items.length;j++){g.push(f.getSelectionModel().selected.items[j].raw);}e.onSelected.notify(g);}}}});return this.grid;};function AdditiveGrid(a){this.onRemoveButtonClicked=new Event(this);}AdditiveGrid.prototype.getBuffer=function(){return this.buffer;};AdditiveGrid.prototype._getActions=function(){var b=this;
var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add",disabled:true,alwaysEnabled:true,handler:function(d,c){b.buffer.bufferhasadditive3VOs.push(BIOSAXS_BEANS.getBufferhasAdditive3VO());b.refresh(b.buffer,b.experiment);}}));return a;};AdditiveGrid.prototype.refresh=function(b,a){this.buffer=b;
this.experiment=a;if(b){if(b.bufferhasadditive3VOs){this.features=b.bufferhasadditive3VOs;}}this.experiment=a;this.store.loadData(this._prepareData(),false);};AdditiveGrid.prototype.getAdditives=function(){var b=[];for(var a=0;a<this.store.getCount();a++){var d=BIOSAXS_BEANS.getBufferhasAdditive3VO();
var c=this.store.getAt(a).getData();d.additive3VO.name=c.name;d.additive3VO.comments=c.comments;d.additive3VO.additiveType=c.additiveType;d.bufferId=this.buffer.bufferId;d.bufferHasAdditiveId=c.bufferHasAdditiveId;d.quantity=c.quantity;b.push(d);}return b;};AdditiveGrid.prototype._getFields=function(a){var b=[{header:"Name",dataIndex:"name",type:"string",editor:{allowBlank:true},flex:1},{header:"Type",name:"additiveType",dataIndex:"additiveType",editor:{xtype:"combobox",typeAhead:true,triggerAction:"all",selectOnTab:true,store:BIOSAXS.proposal.getAdditiveTypes(),lazyRender:true,listClass:"x-combo-list-small"},flex:0.6},{header:"Quantity",dataIndex:"quantity",name:"quantity",editor:{allowBlank:true},type:"string",flex:1},{xtype:"actioncolumn",items:[{icon:"../images/cancel.png",tooltip:"Delete additive",scope:this,handler:function(d,e,c){if((d.getStore().getAt(e).data.bufferHasAdditiveId==null)||(d.getStore().getAt(e).data.bufferHasAdditiveId=="")){d.getStore().removeAt(e);
}else{this.onRemoveButtonClicked.notify({"bufferId":this.buffer.bufferId,"bufferHasAdditiveId":this.store.getAt(e).data.bufferHasAdditiveId});}}}]}];return b;};AdditiveGrid.prototype._prepareData=function(){var c=[];if(this.features==null){this.features=[];}for(var b=0;b<this.features.length;b++){var a=this.features[b];
a.name=this.features[b].additive3VO.name;a.additiveType=this.features[b].additive3VO.additiveType;a.comments=this.features[b].additive3VO.comments;a.additiveId=this.features[b].additive3VO.additiveId;c.push(a);}return c;};AdditiveGrid.prototype.getPanel=function(b,a){this.buffer=b;this.features=b.bufferhasadditive3VOs;
this.experiment=a;return this._renderGrid();};AdditiveGrid.prototype.getStore=function(){var b=this;var a=Ext.create("Ext.data.Store",{fields:["name","additiveType","comments","additiveId","bufferHasAdditiveId","quantity"],autoload:false,data:this._prepareData(),listeners:{update:function(d,c){c.index=b.grid.getSelectionModel().getCurrentPosition().row;
b.buffer.bufferhasadditive3VOs[c.index].additive3VO.name=c.data.name;b.buffer.bufferhasadditive3VOs[c.index].additive3VO.additiveType=c.data.additiveType;b.buffer.bufferhasadditive3VOs[c.index].additive3VO.comments=c.data.comments;b.buffer.bufferhasadditive3VOs[c.index].quantity=c.data.quantity;}}});
a.loadData(this._prepareData(),false);return a;};AdditiveGrid.prototype._renderGrid=function(){var b=this;this.store=this.getStore();var a=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.grid=Ext.create("Ext.grid.Panel",{dockedItems:[{xtype:"toolbar",items:this._getActions()}],store:this.store,height:230,title:"Additives",width:"100%",columns:b._getFields(),plugins:[a],viewConfig:{stripeRows:true,listeners:{itemcontextmenu:function(c,h,f,d,g){g.stopEvent();
contextMenu.showAt(g.getXY());return false;}}},selModel:{mode:"SINGLE"}});return this.grid;};AdditiveGrid.prototype.input=function(){};AdditiveGrid.prototype.test=function(b){var c=new AdditiveGrid();var a=c.getPanel([]);a.render(b);};function AnalysisGrid(a){var b=this;this.id=BUI.id();this.width=Ext.get("mainPanel").getWidth();
this.maxWidth=1500;this.isGuinierTabVisible=true;this.isGnomTabVisible=true;this.isPorodTabVisible=true;this.isScatteringPlotVisible=true;this.isAbinitioTabVisible=true;this.showButtonsVisible=true;this.isI0Visible=true;this.margin=null;this.grouped=true;this.hideNulls=false;this.decimals=4;this.height=null;
this.sorters=[{property:"conc",direction:"ASC"}];if(a!=null){if(a.grouped!=null){this.grouped=a.grouped;}if(a.showButtonsVisible!=null){this.showButtonsVisible=a.showButtonsVisible;}if(a.isI0Visible!=null){this.isI0Visible=a.isI0Visible;}if(a.sorters!=null){this.sorters=a.sorters;}if(a.isScatteringPlotVisible!=null){this.isScatteringPlotVisible=a.isScatteringPlotVisible;
}if(a.isGuinierTabVisible!=null){this.isGuinierTabVisible=a.isGuinierTabVisible;}if(a.isGnomTabVisible!=null){this.isGnomTabVisible=a.isGnomTabVisible;}if(a.isPorodTabVisible!=null){this.isPorodTabVisible=a.isPorodTabVisible;}if(a.hideNulls!=null){this.hideNulls=a.hideNulls;}if(a.height!=null){this.height=a.height;
}if(a.width!=null){this.width=a.width;}if(a.maxWidth!=null){this.maxWidth=a.maxWidth;}}}AnalysisGrid.prototype.refresh=function(b,a){this.store.loadData(this._prepareData(b),false);if(a!=null){if(a.experiment!=null){this.experiment=a.experiment;}}};AnalysisGrid.prototype._getPorod=function(){return{text:"Porod",name:"Porod",columns:[{text:"Volume",dataIndex:"volumeEdna",width:75,sortable:true,hidden:!this.isPorodTabVisible,renderer:function(b,c,a){if(a.raw.volume!=null){return BUI.formatValuesUnits(a.raw.volume,"")+"<span style='font-size:8px;color:gray;'> nm<sub>3</sub></span>";
}}},{text:"MM Vol. est.",dataIndex:"volumeEdna",tooltip:"[Volume/2 - Volume/1.5] (Guinier)",sortable:true,width:95,hidden:!this.isPorodTabVisible,renderer:function(b,c,a){if(a.raw.volume!=null){return Number(a.raw.volume/2).toFixed(1)+" - "+Number(a.raw.volume/1.5).toFixed(1)+"<span style='font-size:8px;color:gray;'>kD</span>";
}}}]};};AnalysisGrid.prototype._getFramesColumn=function(){var a=this;return{text:"Frames (Averaged/Total)",dataIndex:"datacollection",name:"datacollection",sortable:true,width:150,renderer:function(k,m,i){var g=i.raw.bufferAcronym;var l=i.raw.macromoleculeAcronym;var n=i.raw.bufferBeforeFramesMerged;
var p=i.raw.framesMerge;var h=i.raw.bufferAfterFramesMerged;var d=i.raw.framesCount;var c=i.raw.bufferId;var o=i.raw.macromoleculeId;var b=null;if(a.experiment!=null){b=a.experiment.macromoleculeColors[i.raw.macromoleculeId];}try{if(d!=null){if(p!=null){if(parseFloat(d)<parseFloat(p)){var f=d;d=p;p=f;
}}}}catch(j){}return BUI.getHTMLTableForFrameAveraged(g,l,n,p,h,d,c,o,b);}};};AnalysisGrid.prototype._getColumns=function(){var a=this;return[{name:"groupeField",dataIndex:"groupeField",hidden:true},{"header":"subtractionId",hidden:true,"dataIndex":"subtractionId","name":"subtractionId"},{header:"Macromolecule",dataIndex:"macromoleculeAcronym",name:"macromoleculeAcronym",renderer:function(c,d,b){return'<table><tr><td><span style="color:green;font-size:14;">'+c+"</span></td></tr><tr><td>"+BUI.formatValuesUnits(b.raw.conc,"mg/ml",10,this.decimals)+"</td></tr><tr><td>"+BUI.formatValuesUnits(b.raw.exposureTemperature,"C",10,this.decimals)+"</td></tr></table>";
}},{header:"Order",dataIndex:"priorityLevelId",name:"priorityLevelId",hidden:true},{header:"Code",dataIndex:"code",name:"code",hidden:true},{header:"Conc.",dataIndex:"conc",width:80,name:"conc",type:"number",hidden:true,renderer:function(c,d,b){return BUI.formatValuesUnits(c,"mg/ml",10,this.decimals);
}},{text:"Scattering",width:100,dataIndex:"subtractionId",name:"subtractionId",hidden:!this.isScatteringPlotVisible,renderer:function(e,f,d){var b=BUI.getURL()+"&type=scattering&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="80" width="80" '+c+">";
}},{text:"Kratky",width:100,dataIndex:"subtractionId",hidden:true,name:"subtractionId",renderer:function(e,f,d){var b=BUI.getURL()+"&type=kratky&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="80" width="80" '+c+">";}},this._getFramesColumn(),{text:"File Name",dataIndex:"averageFilePath",name:"averageFilePath",sortable:true,width:150,hidden:true,renderer:function(b,d,c){return BUI.getHTMLTableForPrefixes(c.raw.bufferBeforeAverageFilePath,c.raw.averageFilePath,c.raw.bufferAfterAverageFilePath);
}},{text:"Guinier",name:"Guinier",columns:[{text:"Rg",dataIndex:"rgGuinier",name:"rgGuinier",hidden:!this.isGuinierTabVisible,width:75,tooltip:"In polymer physics, the radius of gyration is used to describe the dimensions of a polymer chain.",sortable:true,renderer:function(c,d,b){if(b.raw.rgGuinier!=null){if(Math.abs(b.raw.rgGuinier-b.raw.rgGnom)>(b.raw.rgGuinier*0.1)){return"<span style='color:orange;'>"+BUI.formatValuesUnits(b.raw.rgGuinier,"")+"</span>";
}return BUI.formatValuesUnits(b.raw.rgGuinier,"nm",12,this.decimals);}}},{text:"Points",dataIndex:"points",sortable:true,width:100,type:"string",hidden:!this.isGuinierTabVisible,renderer:function(c,d,b){if((b.raw.firstPointUsed=="")||(b.raw.firstPointUsed==null)){return;}return"<span>"+b.raw.firstPointUsed+" - "+b.raw.lastPointUsed+" ("+(b.raw.lastPointUsed-b.raw.firstPointUsed)+" )</span>";
}},{text:"Quality",dataIndex:"quality",hidden:!this.isGuinierTabVisible,tooltip:"Estimated data quality. 1.0 - means ideal quality, 0.0 - unusable data. In table format it is given in percent (100% - ideal quality, 0% - unusable data). Please note that this estimation is based only on the Guinier interval (very low angles).",width:60,sortable:true,renderer:function(c,d,b){if(b.raw.quality!=null){c=b.raw.quality;
if((c!=null)&&(c!="")){return"<span>"+(Number(c)*100).toFixed(2)+"</span><span style='font-size:8px;color:gray;'> %</span>";}}}},{text:"I(0)",dataIndex:"I0",sortable:true,hidden:!this.isI0Visible,tooltip:"Extrapolated scattering intensity at zero angle I(0) (forward scattering)",width:75,type:"string",renderer:function(c,d,b){if(b.raw.I0!=null){return BUI.formatValuesErrorUnitsScientificFormat(b.raw.I0,b.raw.i0stdev,"");
}}},{text:"Aggregated",tooltip:"If aggregation was detected from the slope of the data curve at low angles the value is '1', otherwise '0'.",dataIndex:"isagregated",hidden:true,width:75,renderer:function(c,d,b){if((b.raw.isagregated!=null)){if(c==true){return"Yes";}else{return"No";}}}},{text:"Guinier",sortable:true,dataIndex:"subtractionId",type:"string",width:100,hidden:true,renderer:function(e,f,d){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=guinier&subtractionId="+d.raw.subtractionId;
var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="80" width="80" '+c+">";}}}]},{text:"Gnom",name:"Gnom",columns:[{text:"Rg",dataIndex:"rgGnom",type:"string",width:65,hidden:!this.isGnomTabVisible,sortable:true,renderer:function(c,d,b){if(b.raw.rgGnom!=null){if(Math.abs(b.raw.rgGuinier-b.raw.rgGnom)>(b.raw.rgGuinier*0.1)){return"<span style='color:orange;'>"+BUI.formatValuesUnits(b.raw.rgGnom,"")+"</span>";
}return BUI.formatValuesUnits(b.raw.rgGnom,"nm");}}},{text:"Total",dataIndex:"total",width:65,hidden:!this.isGnomTabVisible,sortable:true,renderer:function(c,d,b){if(b.raw.total!=null){return BUI.formatValuesUnits(b.raw.total,"");}}},{text:"D<sup>max</sup>",dataIndex:"dmax",sortable:true,width:75,hidden:!this.isGnomTabVisible,renderer:function(c,d,b){if(b.raw.dmax!=null){return BUI.formatValuesUnits(b.raw.dmax,"")+"<span style='font-size:8px;color:gray;'> nm</span>";
}}},{text:"P(r)",sortable:true,hidden:true,width:100,dataIndex:"subtractionId",type:"string",renderer:function(e,f,d){var b=BUI.getURL()+"&type=gnom&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="80" width="80" '+c+">";}}]},this._getPorod(),{text:"AbInitio Modeling",name:"AbInitio_modeling",columns:[{text:"NSD",dataIndex:"volumeEdna",width:100,sortable:true,hidden:true,renderer:function(e,f,d){var b=BUI.getNSDImageURL(d.raw.modelListId);
var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="80" width="80" '+c+">";}},{text:"Chi2",dataIndex:"volumeEdna",sortable:true,hidden:true,width:100,renderer:function(e,f,d){var b=BUI.getCHI2ImageURL(d.raw.modelListId);var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="80" width="80" '+c+">";
}},{text:"Pdb",dataIndex:"volumeEdna",tooltip:"Damaver: The program suite DAMAVER is a set of programs to align ab initio models, select the most typical one and build an averaged model. Dammif : Rapid ab initio shape determination by simulated annealing using a single phase dummy atom model. Dammin :Ab initio shape determination by simulated annealing using a single phase dummy atom model",sortable:true,width:125,hidden:!this.isAbinitioTabVisible,renderer:function(g,h,f){var e=new String();
var d=null;var b=null;var c=f.raw.averagedModel;if(c!=null){d=c.split("/");if(d.length>0){b=BUI.getPdbURL()+"&type=AVERAGED&abInitioModelId="+f.raw.abInitioModelId;e=e+"<a href="+b+' style="color:blue;font-weight:bold;"  height="80" width="80" >'+d[d.length-1]+"</a><br /><br />";}}c=f.raw.rapidShapeDeterminationModel;
if(c!=null){d=c.split("/");if(d.length>0){b=BUI.getPdbURL()+"&type=RAPIDSHAPEDETERMINATIONMODEL&abInitioModelId="+f.raw.abInitioModelId;e=e+"<a href="+b+' style="color:blue;font-weight:bold;"  height="80" width="80" >'+d[d.length-1]+"</a><br /><br />";}}c=f.raw.shapeDeterminationModel;if(c!=null){d=c.split("/");
if(d.length>0){b=BUI.getPdbURL()+"&type=SHAPEDETERMINATIONMODEL&abInitioModelId="+f.raw.abInitioModelId;e=e+"<a href="+b+' style="color:blue;font-weight:bold;"  height="80" width="80" >'+d[d.length-1]+"</a>";}}return e;}},{text:"Damaver",dataIndex:"volumeEdna",hidden:true,tooltip:"Damaver: The program suite DAMAVER is a set of programs to align ab initio models, select the most typical one and build an averaged model. ",sortable:true,width:125,renderer:function(f,g,e){var d=e.raw.averagedModel;
if(d!=null){var c=d.split("/");if(c.length>0){var b=BUI.getPdbURL()+"&type=AVERAGED&abInitioModelId="+e.raw.abInitioModelId;return"<a href="+b+' style="color:blue;font-weight:bold;"  height="80" width="80" >'+c[c.length-1]+"</a>";}}return e.raw.averagedModel;}},{text:"Dammif",dataIndex:"volumeEdna",hidden:true,tooltip:"Dammif : Rapid ab initio shape determination by simulated annealing using a single phase dummy atom model",sortable:true,width:125,renderer:function(f,g,e){var d=e.raw.rapidShapeDeterminationModel;
if(d!=null){var c=d.split("/");if(c.length>0){var b=BUI.getPdbURL()+"&type=RAPIDSHAPEDETERMINATIONMODEL&abInitioModelId="+e.raw.abInitioModelId;return"<a href="+b+' style="color:blue;font-weight:bold;"  height="80" width="80" >'+c[c.length-1]+"</a>";}}return e.raw.averagedModel;}},{text:"Dammin",dataIndex:"volumeEdna",hidden:true,tooltip:"Dammin :Ab initio shape determination by simulated annealing using a single phase dummy atom model",sortable:true,width:125,renderer:function(f,g,e){var d=e.raw.shapeDeterminationModel;
if(d!=null){var c=d.split("/");if(c.length>0){var b=BUI.getPdbURL()+"&type=SHAPEDETERMINATIONMODEL&abInitioModelId="+e.raw.abInitioModelId;return"<a href="+b+' style="color:blue;font-weight:bold;"  height="80" width="80" >'+c[c.length-1]+"</a>";}}return e.raw.averagedModel;}}]},{text:"Time",dataIndex:"substractionCreationTime",name:"substractionCreationTime",hidden:true,width:80,sortable:true,renderer:function(g,c,b,i,f,d){try{if(b.raw.substractionCreationTime!=null){return moment(b.raw.substractionCreationTime).format("h:mm:ss a");
}}catch(h){return"NA";}}},{text:"Date",dataIndex:"substractionCreationTime",name:"substractionCreationTime",hidden:true,width:80,sortable:true,renderer:function(g,c,b,i,f,d){try{if(b.raw.substractionCreationTime!=null){return moment(b.raw.substractionCreationTime).format("LL");}}catch(h){return"NA";}}},this._getButtons()];
};AnalysisGrid.prototype._getButtons=function(){return{id:this.id+"buttonPlot",name:"buttonPlot",hidden:!this.showButtonsVisible,width:110,sortable:false,renderer:function(f,a,e,g,c,b){var d="<table><tr><td style='padding:2px;'>"+BUI.getGreenButton("Calibration",{height:20,width:100})+"</td></tr>";if(e.raw.subtractionId){d=d+"<tr><td style='padding:2px;'>"+BUI.getGreenButton("Primary Data Proc.",{height:20,width:100})+"</td></tr>";
if(e.raw.rapidShapeDeterminationModelId!=null){d=d+"<tr><td  style='padding:2px;'>"+BUI.getGreenButton("AbInitio Modeling",{height:20,width:100})+"<td></tr>";}}return d+"</table>";}};};AnalysisGrid.prototype._prepareData=function(c){if(this.hideNulls){var a=[];for(var b=0;b<c.length;b++){if(c[b].subtractionId!=null){c[b].groupeField=c[b].macromoleculeAcronym+" "+c[b].bufferAcronym;
a.push(c[b]);}}return a;}else{return c;}};AnalysisGrid.prototype.getPanel=function(d){var e=this;var b=this._getColumns();var a=JSON.parse(JSON.stringify(b));a.push({name:"experimentId",dataIndex:"experimentId"});this.store=Ext.create("Ext.data.Store",{fields:a,autoload:true,data:this._prepareData(d),groupField:"groupeField"});
this.store.sort(this.sorters);var c=[];if(this.grouped){c.push({ftype:"grouping",groupHeaderTpl:"{name}",hideGroupedHeader:false,startCollapsed:false});}this.grid=Ext.create("Ext.grid.Panel",{style:{padding:5},maxWidth:this.maxWidth,width:this.width,height:this.height,store:this.store,columns:b,resizable:true,features:c,viewConfig:{preserveScrollOnRefresh:true,stripeRows:true,listeners:{cellclick:function(f,h,m,i,l,n,j,k){if(f.getGridColumns()[m].getId()==e.id+"buttonPlot"){if(j.target.defaultValue=="AbInitio Modeling"){var g=BUI.getPDBVisualizerURL(i.raw.averagedModelId,i.raw.subtractionId,i.raw.experimentId);
window.open(g,"_blank");}if(j.target.defaultValue=="Primary Data Proc."){e._edit(i.raw);}if(j.target.defaultValue=="Calibration"){e._showCalibration(i.raw);}}}}},selModel:{mode:"SINGLE"}});return this.grid;};AnalysisGrid.prototype._openVisualizarBySubstractionId=function(c){var d=c.experimentId;var b=c.subtractionId;
var e=this;var a=new BiosaxsDataAdapter();this.subtractionId=b;a.onSuccess.attach(function(h,j){var f=new Experiment(j);var i=new ExperimentList([f]);var g=f.getSubtractionById(e.subtractionId);e.grid.setLoading(false);e._openVisualizer(i,g,c);});this.grid.setLoading("ISPyB: Fetching experiment");a.getExperimentById(d,"MEDIUM");
};AnalysisGrid.prototype._edit=function(a){var b=a.experimentId;var c=this;if(BIOSAXS.proposal.macromolecules==null){this.grid.setLoading("ISPyB: Fetching proposal");BIOSAXS.proposal.onInitialized.attach(function(d,e){c._openVisualizarBySubstractionId(a);});BIOSAXS.proposal.init();}else{this._openVisualizarBySubstractionId(a);
}};AnalysisGrid.prototype._showCalibration=function(b){var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(c,d){Ext.create("Ext.window.Window",{title:"Calibration",width:900,resizable:true,height:400,modal:true,frame:false,draggable:true,closable:true,autoscroll:true,paddin:5,layout:{type:"vbox",align:"stretch"},items:[new AnalysisGrid({isGuinierTabVisible:false,isGnomTabVisible:false,isPorodTabVisible:false,isAbinitioTabVisible:false,isI0Visible:true,showButtonsVisible:false,height:350,sorters:[{property:"experimentId",direction:"DESC"}]}).getPanel(d)]}).show();
});a.getAnalysisCalibrationByProposalId();};AnalysisGrid.prototype._openVisualizer=function(e,d,b){var f=e.getMergesByDataCollectionId(d.dataCollectionId);var a=[];for(var c=0;c<f.length;c++){a.push(f[c].mergeId);}var g=new BiosaxsDataAdapter();g.onSuccess.attach(function(h,i){var j=new DataCollectionCurveVisualizer();
j.draw();j.refresh(i,e,d.dataCollectionId,b);});g.onError.attach(function(i,h){});g.getMergesByIdsList(a);};AnalysisGrid.prototype.input=function(){return{data:DATADOC.getData_3367().slice(20,30),proposal:new ResultsAssemblyGrid().input().proposal};};AnalysisGrid.prototype.test=function(c){var a=new AnalysisGrid();
BIOSAXS.proposal=new Proposal(a.input().proposal);var b=a.getPanel(a.input().data);b.render(c);};function HPLCAnalysisGrid(a){AnalysisGrid.prototype.constructor.call(this,a);}HPLCAnalysisGrid.prototype._edit=AnalysisGrid.prototype._edit;HPLCAnalysisGrid.prototype._getColumns=AnalysisGrid.prototype._getColumns;
HPLCAnalysisGrid.prototype._openVisualizarBySubstractionId=AnalysisGrid.prototype._openVisualizarBySubstractionId;HPLCAnalysisGrid.prototype._openVisualizer=AnalysisGrid.prototype._openVisualizer;HPLCAnalysisGrid.prototype._prepareData=AnalysisGrid.prototype._prepareData;HPLCAnalysisGrid.prototype._showCalibration=AnalysisGrid.prototype._showCalibration;
HPLCAnalysisGrid.prototype.getPanel=AnalysisGrid.prototype.getPanel;HPLCAnalysisGrid.prototype.input=AnalysisGrid.prototype.input;HPLCAnalysisGrid.prototype.test=AnalysisGrid.prototype.test;HPLCAnalysisGrid.prototype.refresh=AnalysisGrid.prototype.refresh;HPLCAnalysisGrid.prototype._getPorod=AnalysisGrid.prototype._getPorod;
HPLCAnalysisGrid.prototype._getButtons=function(){return{id:this.id+"buttonPlot",name:"buttonPlot",hidden:!this.showButtonsVisible,width:110,sortable:false,renderer:function(f,a,e,g,c,b){var d="<table>";if(e.raw.subtractionId){if(e.raw.rapidShapeDeterminationModelId!=null){d=d+"<tr><td  style='padding:2px;'>"+BUI.getGreenButton("AbInitio Modeling",{height:20,width:100})+"<td></tr>";
}}return d+"</table>";}};};HPLCAnalysisGrid.prototype._getFramesColumn=function(){return{text:"Frames",dataIndex:"datacollection",name:"datacollection",sortable:true,width:150,renderer:function(a,c,b){molmerges=b.raw.framesMerge;totalframes=b.raw.framesCount;return molmerges+" - "+totalframes;}};};function BufferGrid(a){this.height=500;
this.searchBar=false;this.tbar=false;this.collapsed=false;this.id=BUI.id();if(a!=null){if(a.height!=null){this.height=a.height;}if(a.searchBar!=null){this.searchBar=a.searchBar;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.collapsed!=null){this.collapsed=a.collapsed;}if(a.width!=null){this.width=a.width;}}}BufferGrid.prototype._edit=function(a){var c=this;
var b=new BufferWindow();b.onSuccess.attach(function(e,d){c.store.loadData(BIOSAXS.proposal.getBuffers());});b.draw(BIOSAXS.proposal.getBufferById(a));};BufferGrid.prototype.refresh=function(a){this.store.loadData(this._prepareData(a),false);};BufferGrid.prototype._prepareData=function(a){return a;};
BufferGrid.prototype._getTbar=function(){var b=this;var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add buffer",disabled:false,handler:function(e,d){var c=new BufferWindow();c.onSuccess.attach(function(f){b.store.loadData(BIOSAXS.proposal.getBuffers());});c.draw({});}}));return a;
};BufferGrid.prototype.getPanel=function(a){var c=this;this.store=Ext.create("Ext.data.Store",{fields:["bufferId","acronym","name","composition"],data:a});this.store.sort("acronym");var b="Ext.grid.Panel";if(this.searchBar==true){b="Ext.ux.LiveSearchGridPanel";}this.grid=Ext.create(b,{title:"Buffers",collapsible:true,collapsed:this.collapsed,store:this.store,height:this.height,width:this.width,columns:[{text:"Acronym",dataIndex:"acronym",flex:1},{text:"Name",dataIndex:"name",flex:1,hidden:true},{text:"Composition",dataIndex:"composition",flex:1,hidden:true},{id:c.id+"buttonEditBuffer",width:80,sortable:false,renderer:function(h,e,d,i,g,f){return BUI.getGreenButton("EDIT");
}},{id:c.id+"buttonRemoveBuffer",width:85,hidden:true,sortable:false,renderer:function(h,e,d,i,g,f){return BUI.getRedButton("REMOVE");}}],flex:1,viewConfig:{stripeRows:true,listeners:{"celldblclick":function(h,l,f,d,i,k,j,g){c._edit(d.data.bufferId);},"cellclick":function(h,l,f,d,i,k,j,g){if(h.getGridColumns()[f].getId()==c.id+"buttonEditBuffer"){c._edit(d.data.bufferId);
}if(h.getGridColumns()[f].getId()==c.id+"buttonRemoveBuffer"){BUI.showBetaWarning();}}}}});if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:this._getTbar()});}return this.grid;};BufferGrid.prototype.input=function(){return new MacromoleculeGrid().input();};BufferGrid.prototype.test=function(b){var c=new BufferGrid({width:800,height:350,collapsed:false,tbar:true});
BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel(BIOSAXS.proposal.macromolecules);a.render(b);};function CaseGrid(a){this.height=100;this.btnEditVisible=true;this.btnRemoveVisible=true;if(a!=null){if(a.height!=null){this.height=a.height;}if(a.btnEditVisible!=null){this.btnEditVisible=a.btnEditVisible;
}if(a.btnRemoveVisible!=null){this.btnRemoveVisible=a.btnRemoveVisible;}}this.onEditButtonClicked=new Event(this);this.onAddButtonClicked=new Event(this);this.onRemoveButtonClicked=new Event(this);this.onDuplicateButtonClicked=new Event(this);}CaseGrid.prototype._getColumns=function(){var c=this;function b(g,h,d,i,f,e){}var a=[{header:"Code",dataIndex:"code",name:"code",type:"string",flex:1},{header:"Bar Code",dataIndex:"barCode",name:"barCode",type:"string",flex:1,hidden:true},{header:"BeamLine",dataIndex:"barCode",type:"string",flex:1,renderer:function(e,f,d){if(d.raw.sessionVO!=null){return"<span style='font-weight:bold;'>"+d.raw.sessionVO.beamlineName+"</span>";
}}},{header:"Session",dataIndex:"barCode",type:"string",flex:1,renderer:function(e,f,d){if(d.raw.sessionVO!=null){return"<span>"+moment(d.raw.sessionVO.startDate).format("MMM Do YY")+"</span>";}}},{header:"Status",dataIndex:"dewarStatus",name:"dewarStatus",type:"string",flex:1,renderer:function(e,f,d){if(new String(d.raw.dewarStatus).toUpperCase()=="OPENED"){return"<span style='color:green;font-weight:bold;'>"+new String(d.raw.dewarStatus).toUpperCase()+"</span>";
}return"<span style='font-weight:bold;'>"+new String(d.raw.dewarStatus).toUpperCase()+"</span>";}},{header:"Type",dataIndex:"type",name:"type",type:"string",flex:1,hidden:true},{header:"Sample Plates",dataIndex:"plates",name:"plates",type:"string",flex:1,hidden:true},{header:"Stock Solutions",dataIndex:"plates",name:"plates",type:"string",width:100,renderer:function(e,h,d){var f="<div>";
var g=BIOSAXS.proposal.getStockSolutionsByDewarId(d.raw.dewarId);f=f+"<span style='font-size:18px'>"+g.length+"</span> x<img height='15px' src='/ispyb/images/SampleHolder_24x24_01.png'>";return f+"</div>";}},{header:"isStorageDewar",dataIndex:"isStorageDewar",name:"isStorageDewar",type:"string",flex:1,hidden:true},{header:"Tracking Number From Synchrotron",dataIndex:"trackingNumberFromSynchrotron",name:"trackingNumberFromSynchrotron",type:"string",flex:1,hidden:true},{header:"Tracking Number To Synchrotron",dataIndex:"trackingNumberToSynchrotron",name:"trackingNumberToSynchrotron",type:"string",flex:1,hidden:true},{header:"Storage Location",dataIndex:"storageLocation",name:"storageLocation",type:"string",flex:1,hidden:false},{header:"Comments",dataIndex:"comments",name:"comments",type:"string",flex:1,hidden:false}];
if(this.btnEditVisible){a.push({id:c.id+"buttonEdit",text:"",hidden:!c.btnEditVisible,width:85,sortable:false,renderer:function(h,e,d,i,g,f){return BUI.getGreenButton("EDIT");}});}if(this.btnRemoveVisible){a.push({id:c.id+"buttonRemove",width:85,sortable:false,renderer:function(h,e,d,i,g,f){if(c.btnRemoveVisible){return BUI.getRedButton("REMOVE");
}}});}a.push({dataIndex:"comments",type:"string",width:85,hidden:false,renderer:function(e,f,d){return BUI.getBlueButton("LABELS",{href:BUI.getPrintcomponentURL(d.raw.dewarId)});}});return a;};CaseGrid.prototype._getTopButtons=function(){var b=this;var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add",disabled:false,handler:function(d,c){b.onAddButtonClicked.notify();
}}));return a;};CaseGrid.prototype.refresh=function(a){this.features=a;this.store.loadData(this._prepareData(a),false);};CaseGrid.prototype._sort=function(a){a.sort("dewarId","DESC");};CaseGrid.prototype._prepareData=function(){var b=[];for(var a=0;a<this.features.length;a++){b.push(this.features[a]);
}return b;};CaseGrid.prototype.getPanel=function(b,a){this.features=b;this.plates=a;return this._renderGrid();};CaseGrid.prototype._edit=function(c){var b=this;var a=new CaseWindow();a.onSaved.attach(function(e,f){var d=new BiosaxsDataAdapter();d.onSuccess.attach(function(h,g){b.refresh(g.dewarVOs);});
d.saveCase(BIOSAXS.proposal.getShipmentByDewarId(f.dewarId).shippingId,f);});a.draw(c);};CaseGrid.prototype._getStoreFields=function(a){return[{name:"dewarId",type:"string"},{name:"barCode",type:"string"},{name:"code",type:"string"},{name:"comments",type:"string"},{name:"dewarStatus",type:"string"},{name:"isStorageDewar",type:"string"},{name:"plates",type:"string"},{name:"transportValue",type:"string"},{name:"trackingNumberFromSynchrotron",type:"string"},{name:"trackingNumberToSynchrotron",type:"string"},{name:"timeStamp",type:"string"},{name:"storageLocation",type:"string"},{name:"type",type:"string"}];
};CaseGrid.prototype._renderGrid=function(){var c=this;var a=this._prepareData();this.store=Ext.create("Ext.data.Store",{fields:this._getStoreFields(a),autoload:true,data:a});this._sort(this.store);this.store.loadData(a,false);this.grid=Ext.create("Ext.grid.Panel",{style:{padding:5},height:this.height,store:this.store,columns:this._getColumns(),viewConfig:{stripeRows:true,listeners:{itemdblclick:function(f,d,g,h){c._edit(d.raw);
},cellclick:function(h,l,f,d,i,k,j,g){if(h.getGridColumns()[f].getId()==c.id+"buttonEdit"){c._edit(d.raw);}if(h.getGridColumns()[f].getId()==c.id+"buttonRemove"){c.onRemoveButtonClicked.notify(c.store.getAt(k).raw.dewarId);}}}},selModel:{mode:"SINGLE"}});var b=c._getTopButtons();this.grid.addDocked({xtype:"toolbar",items:b});
this.grid.getSelectionModel().on({selectionchange:function(f,e){if(e.length){for(var d=0;d<b.length;d++){if(b[d].enable){b[d].enable();}}}else{for(var d=0;d<b.length;d++){if(b[d].alwaysEnabled==false){if(b[d].disable){b[d].disable();}}}}}});return this.grid;};CaseGrid.prototype.input=function(){return{proposal:DATADOC.getProposal_10(),dewars:DATADOC.getDewars_10()};
};CaseGrid.prototype.test=function(b){var c=new CaseGrid({height:150});BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel(c.input().dewars);a.render(b);};function ExperimentGrid(a){this.width="100%";this.height=700;this.minHeight=500;this.id=BUI.id();this.gridType="Ext.grid.Panel";this.tbar=false;
this.hideHeaders=false;this.grouping=true;this.title=null;this.filtered=null;this.limit=100;this.sessionIdFilter=null;this.date=null;this.sorters=[{property:"date",direction:"DESC"},{property:"time",direction:"DESC"}];this.dates={};if(a!=null){if(a.height!=null){this.height=a.height;}if(a.limit!=null){this.limit=a.limit;
}if(a.sorters!=null){this.sorters=a.sorters;}if(a.sessionId!=null){this.sessionIdFilter=a.sessionId;}if(a.filtered!=null){this.filtered=a.filtered;}if(a.minHeight!=null){this.minHeight=a.minHeight;}if(a.gridType!=null){this.gridType=a.gridType;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.grouping!=null){this.grouping=a.grouping;
}if(a.width!=null){this.width=a.width;}if(a.title!=null){this.title=a.title;}}this.onEditButtonClicked=new Event(this);}ExperimentGrid.prototype._getFilterTypes=function(){return[];};ExperimentGrid.prototype._prepareData=function(d){var c=[];var b=0;d.sort(function(g,f){return f.experimentId-g.experimentId;
});for(var a=0;a<d.length;a++){var e=d[a];this.dates[moment(e.creationDate).format("YYYYMMDD")]=moment(e.creationDate).format("MMM Do YY");if((this.filtered==null||e.experimentType==this.filtered)&&(b<this.limit||this.limit==null)&&(this.sessionIdFilter==null||this.date!=null||(this.date==null&&this.sessionIdFilter==e.sessionId))){c.push({experimentId:e.experimentId,status:e.status,dataAcquisitionFilePath:e.dataAcquisitionFilePath,type:e.experimentType,name:e.name,macromolecules_names:e.macromolecules,percentageAnalysed:{value:(e.dataCollectionDoneCount/e.dataCollectionCount)*100,text:e.dataCollectionDoneCount+" of "+e.dataCollectionCount},percentageCollected:{value:(e.measurementDoneCount/e.measurementCount)*100,text:e.measurementDoneCount+" of "+e.measurementCount},percentageMerged:{value:(e.measurementAveragedCount/e.measurementCount)*100,text:e.measurementAveragedCount+" of "+e.measurementCount},date:moment(e.creationDate).format("YYYYMMDD"),time:moment(e.creationDate).format("YYYYMMDDHHmmss"),creationDate:e.creationDate});
b++;}}return c;};ExperimentGrid.prototype.getPanel=function(a){this.features=a;return this._renderGrid(a);};ExperimentGrid.prototype.refresh=function(e){this.experiments=e;var c=[];for(var d=0;d<e.length;d++){if(e[d].experimentType!="TEMPLATE"){c.push(e[d]);}}this.parsedData=this._prepareData(c);var a={};
var f=[];for(var d=0;d<this.experiments.length;d++){var b=moment(this.experiments[d].creationDate).format("MMM Do YYYY");if(a[b]==null){f.push({date:b,value:moment(this.experiments[d].creationDate)});a[b]=true;}}this.storeDate.loadData(f,false);this.store.loadData(this.parsedData,false);if(this.date!=null){this._filterByDate(this.date);
}};ExperimentGrid.prototype._getTopButtons=function(){var b=this;var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/calendar_icon.png",text:"Show Calendar",disabled:false,handler:function(g,f){var e=Ext.create("Ext.window.Window",{title:"Calendar",width:600,height:600,modal:true,closable:true,layout:{type:"vbox",align:"stretch"},items:[{xtype:"label",html:"Click on a data acquisition to select:",margin:"5 5 5 5"},{html:'<div id="calendar" style="height:450px;overflow-y: scroll;"></div>',margin:"5 5 5 5"}]}).show();
var d=new CalendarWidget({height:450});var c=b.limit;b.limit=null;b.sessionIdFilter=null;d.loadData(b._prepareData(b.experiments));b.limit=c;d.draw("calendar");d.onClick.attach(function(i,h){h=moment(h,"YYYY-MM-DD");b._filterByDate(h);e.close();});}}));this.storeDate=Ext.create("Ext.data.ArrayStore",{fields:["date","value"],data:[]});
this.dateMenu=Ext.create("Ext.form.field.ComboBox",{hideLabel:true,store:this.storeDate,displayField:"date",typeAhead:true,queryMode:"local",margin:"0 0 0 30",triggerAction:"all",emptyText:"Select a date...",selectOnFocus:true,width:135,listeners:{scope:this,"select":function(e,d,f){b.limit=null;b._filterByDate(moment(d[0].raw.value,"YYYY-MM-DD"));
}}});a.push(this.dateMenu);a.push("->");if(b.filtered!=null){a.push({html:"<span>Experiment Type: "+b.filtered+"</span>"});}else{a.push({html:"<span>Experiment Type: ALL</span>"});}return a;};ExperimentGrid.prototype._filterByDate=function(d){var c=[];for(var e=0;e<this.experiments.length;e++){var b=this.experiments[e];
if(b.creationDate!=null){var a=moment(b.creationDate);if(a.year()==d.year()){if(a.month()==d.month()){if(a.date()==d.date()){c.push(b);}}}}}var f=this._prepareData(c);this.store.loadData(f);this.date=d;};ExperimentGrid.prototype._removeExperimentById=function(b){var c=this;var a=new BiosaxsDataAdapter();
a.onSuccess.attach(function(d,e){c.grid.setLoading(false);document.getElementById(BIOSAXS.targetId).innerHTML="";BIOSAXS.start(BIOSAXS.targetId);});this.grid.setLoading("Removing experiment ");a.removeExperimentById(b);};ExperimentGrid.prototype._renderGrid=function(){var c=this;this.store=Ext.create("Ext.data.Store",{fields:this._getColumns(),groupField:"date",autoload:true,data:[],remoteSort:false,sorters:this.sorters});
var a=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:Ext.create("Ext.XTemplate","<div style='background:#0ca3d2; color:white; float:left; margin:6px 8px 0 0; padding:5px 8px;'>{name:this.formatName}</div>",{formatName:function(d){return c.dates[d];}}),hideGroupedHeader:true,startCollapsed:false});
this.features=[];if(this.grouping){this.features.push(a);}this.grid=Ext.create(this.gridType,{hideHeaders:this.hideHeaders,resizable:true,title:this.title,width:this.width,minHeight:this.minHeight,height:this.height,features:this.features,store:this.store,columns:this._getColumns(),selModel:{mode:"SINGLE"},viewConfig:{stripeRows:true,getRowClass:function(d,f,g,e){if(d.raw.type=="TEMPLATE"){return"template-color-row";
}if((d.raw.type=="CALIBRATION")&&(d.raw.status=="FINISHED")){return"blue-row";}},listeners:{itemdblclick:function(f,d,g,h){c._editExperiment(d.raw.experimentId);},cellclick:function(h,l,f,d,i,k,j,g){if(h.getGridColumns()[f].getId()==c.id+"GO"){c._editExperiment(d.raw.experimentId);}if(h.getGridColumns()[f].getId()==c.id+"REMOVE"){c._removeExperimentById(d.raw.experimentId);
}}}}});var b=c._getTopButtons();if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:b});this.grid.getSelectionModel().on({selectionchange:function(f,e){if(e.length){for(var d=0;d<b.length;d++){if(b[d].enable){b[d].enable();}}}else{for(var d=0;d<b.length;d++){if(b[d].alwaysEnabled==false){if(b[d].disable){b[d].disable();
}}}}}});}return this.grid;};ExperimentGrid.prototype._getColumns=function(){var b=this;function a(f,g,c,h,e,d){if(c.raw.buffer3VOs!=null){if(c.raw.buffer3VOs.length>0){return"x-hide-display";}}if(c.data.platesCount>0){return"x-hide-display";}}return[{text:"experimentId",dataIndex:"experimentId",name:"experimentId",type:"string",hidden:true},{xtype:"rownumberer",width:40},{text:"Name",dataIndex:"name",name:"name",type:"string",flex:1},{text:"Type",dataIndex:"type",name:"type",type:"string",flex:1,renderer:function(c){if(c=="CALIBRATION"){return"<span style='color:blue;'>"+c+"</span>";
}return c;}},{text:"Macromolecules",name:"macromolecules_names",dataIndex:"macromolecules_names",flex:1,renderer:function(c){if(c!=null){return" <span style='font-weight:bold'>"+c+"</span>";}return" <span style='font-style:italic;color:gray;'>Information not available</span>";}},{text:"Buffers",dataIndex:"buffer_names",name:"buffer_names",flex:1,hidden:true,renderer:function(c){return"Buffer/s: <span style='font-weight:bold'>"+c+"</span>";
}},{text:"Status",dataIndex:"status",name:"status",type:"string",flex:1,renderer:function(e,c,d){if(d.raw.type=="TEMPLATE"){return"READY";}if(d.raw.status=="ABORTED"){return"<span style='color:red;'>"+e+"</span>";}return"<span style='color:green;'>"+e+"</span>";}},{text:"Download",dataIndex:"creationDate",name:"creationDate",renderer:function(e,c,d){if(d!=null){if(d.raw.type=="HPLC"){return;
}return BUI.getZipHTMLByExperimentId(d.raw.experimentId,d.raw.name);}},width:100},{header:"Measurements",dataIndex:"percentageCollected",name:"percentageCollected",type:"string",renderer:function(d,e,c){if((c.raw.type=="TEMPLATE")||(c.raw.type=="HPLC")){return;}return"<table><tr><td>"+BUI.getProgessBar(c.raw.percentageCollected.value,c.raw.percentageCollected.text)+"</td></table>";
},width:100},{header:"Averaged",dataIndex:"percentageMerged",name:"percentageMerged",type:"string",renderer:function(d,e,c){if((c.raw.type=="TEMPLATE")||(c.raw.type=="HPLC")){return;}return"<table><tr><td>"+BUI.getProgessBar(c.raw.percentageMerged.value,c.raw.percentageMerged.text)+"</td></table>";},width:100},{header:"Subtractions",dataIndex:"percentageAnalysed",name:"percentageAnalysed",type:"string",renderer:function(d,e,c){if((c.raw.type=="TEMPLATE")||(c.raw.type=="HPLC")){return;
}return"<table><tr><td>"+BUI.getProgessBar(c.raw.percentageAnalysed.value,c.raw.percentageAnalysed.text)+"</td></table>";},width:100},{text:"time",dataIndex:"time",name:"time",hidden:true,renderer:function(c){return c;},width:100},{text:"Date",dataIndex:"date",name:"date",renderer:function(c){return c;
},width:100},{text:"Time",dataIndex:"creationDate",name:"creationDate",renderer:function(c){return moment(c).format(" HH:mm:ss");},width:100},{id:b.id+"GO",width:80,sortable:false,renderer:function(g,d,c,h,f,e){return BUI.getGreenButton("GO");}}];};ExperimentGrid.prototype._editExperiment=function(a){if(Ext.urlDecode(window.location.href).sessionId!=null){location.href="viewProjectList.do?reqCode=display&experimentId="+a+"&sessionId="+Ext.urlDecode(window.location.href).sessionId;
}else{location.href="viewProjectList.do?reqCode=display&experimentId="+a;}};ExperimentGrid.prototype.input=function(){var a=DATADOC.getExperimentList_10();return{experiments:a,proposal:new MeasurementGrid().input().proposal};};ExperimentGrid.prototype.test=function(c){var b=new ExperimentGrid({height:350,minHeight:350,width:1000});
BIOSAXS.proposal=new Proposal(b.input().proposal);var a=b.getPanel(b.input().experiments);b.refresh(b.input().experiments);a.render(c);};function FitStructureToExperimentDataGrid(){}FitStructureToExperimentDataGrid.prototype.getStructuresByMacromolecule=function(c){var b=[];if(c.structure3VOs!=null){if(c.structure3VOs.length>0){for(var a=0;
a<c.structure3VOs.length;a++){b.push(c.structure3VOs[a]);}}}return b;};FitStructureToExperimentDataGrid.prototype._prepareData=function(d,e){var f=[];for(var c=0;c<d.length;c++){function a(g){for(var h=0;h<e.length;h++){if(e[h].structureId==g.structureId){return e[h];}}return null;}f.push(d[c]);var b=a(d[c]);
if(b!=null){f[f.length-1]["fitStructureToExperimentalDataId"]=b.fitStructureToExperimentalDataId;f[f.length-1]["comments"]=b.comments;}f[f.length-1]["subtractionId"]=this.subtractionId;}return f;};FitStructureToExperimentDataGrid.prototype.refresh=function(b,c){var d=this;this.subtractionId=b;this.macromolecule=c;
var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(e,g){var f=d.getStructuresByMacromolecule(c);d.store.loadData(d._prepareData(f,g),false);});a.getFitStructureToExperimentalDataBySubtractionId(b);};FitStructureToExperimentDataGrid.prototype.getPanel=function(){var a=this;this.store=Ext.create("Ext.data.Store",{fields:["name","structureId","fitStructureToExperimentalDataId","subtractionId","comments"],data:[]});
this.store.sort([{property:"name",direction:"ASC"}]);this.panel=Ext.create("Ext.grid.Panel",{title:"Fitting Structures to Experimental Data",store:this.store,deferredRender:false,tbar:[{text:"Refresh",icon:"../images/export.gif",handler:function(){a.refresh(a.subtractionId,a.macromolecule);}}],columns:[{text:"Name",dataIndex:"name"},{text:"structureId",dataIndex:"structureId",hidden:true,flex:1},{text:"Comments",dataIndex:"comments",flex:1},{dataIndex:"fitStructureToExperimentalDataId",sortable:true,width:400,id:"showFit",renderer:function(c,e,b){var d=c;
if(b.raw.comments!=null){if(b.raw.comments.indexOf("Sent")!=-1){return"";}}if((d==null)||(c=="")){return BUI.getBlueButton("RUN",{height:20,width:100});}return BUI.getGreenButton("SHOW",{height:20,width:100});}}],listeners:{cellclick:function(b,d,j,f,i,k,g,h){if(b.getGridColumns()[j].getId()=="showFit"){if((f.data.fitStructureToExperimentalDataId!=null)&&(f.data.fitStructureToExperimentalDataId!="")){var c=new FitStructureToDataWidget();
Ext.create("Ext.window.Window",{title:"Fit Structure to Data",height:600,width:900,layout:"fit",items:[c.getPanel()]}).show();c.refresh(f.data.fitStructureToExperimentalDataId,f.data.structureId);}else{a.RUNFitScattering(f.data.subtractionId,f.data.structureId);}}},afterrender:function(){}}});return this.panel;
};FitStructureToExperimentDataGrid.prototype.RUNFitScattering=function(c,d){var f=this;var b=new BiosaxsDataAdapter();var e={"workflowTitle":"FitExperimentalDatatoStructure","comments":"FitExperimentalDatatoStructure run from ISPyB for subtractionId: "+c+" and structureId "+d};var a=[{name:"subtractionId",value:c},{name:"structureId",value:d}];
b.onSuccess.attach(function(h,j){var i=new BiosaxsDataAdapter();var g={"workflowId":j.workflowId,"subtractionId":c,"structureId":d,"comments":"Sent to workflow engine"};i.onSuccess.attach(function(l,k){f.refresh(f.subtractionId,f.macromolecule);});i.addFitStructureData(g);});b.addWorkflow(e,a);};function FrameGrid(a){this.height=500;
this.width=500;this.searchBar=false;this.tbar=false;this.collapsed=false;if(a!=null){if(a.height!=null){this.height=a.height;}if(a.searchBar!=null){this.searchBar=a.searchBar;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.collapsed!=null){this.collapsed=a.collapsed;}if(a.width!=null){this.width=a.width;}}}FrameGrid.prototype._edit=function(a){var c=this;
var b=new BufferWindow();b.onSuccess.attach(function(e,d){c.store.loadData(BIOSAXS.proposal.getBuffers());});b.draw(BIOSAXS.proposal.getBufferById(a));};FrameGrid.prototype.refresh=function(a,b){this.experimentId=b;this.store.loadData(this._prepareData(a),false);};FrameGrid.prototype._prepareData=function(a){return a;
};FrameGrid.prototype._getTbar=function(){var b=this;var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add Buffer",disabled:false,handler:function(e,d){var c=new BufferWindow();c.onSuccess.attach(function(f){b.store.loadData(BIOSAXS.proposal.getBuffers());});c.draw({});}}));return a;
};FrameGrid.prototype.getPanel=function(a){var c=this;this.store=Ext.create("Ext.data.Store",{fields:["frameNumber","I0","Rg","Mass","Vc","Qr","quality"],data:a});this.store.sort("frameNumber");var b="Ext.grid.Panel";if(this.searchBar==true){b="Ext.ux.LiveSearchGridPanel";}this.grid=Ext.create(b,{store:this.store,height:this.height,width:this.width,margin:5,columns:[{text:"Frame",dataIndex:"frameNumber",flex:1},{text:"I0",dataIndex:"I0",flex:1,renderer:function(e,f,d){return BUI.formatValuesUnits(d.data.I0,"",12,3);
}},{text:"Rg",dataIndex:"Rg",flex:1,renderer:function(e,f,d){return BUI.formatValuesUnits(d.data.Rg,"nm",12,3);}},{text:"Mass",dataIndex:"Mass",flex:1,renderer:function(e,f,d){return BUI.formatValuesUnits(d.data.Mass,"",12,3);}},{text:"Vc",dataIndex:"Vc",flex:1,renderer:function(e,f,d){return BUI.formatValuesUnits(d.data.Vc,"",12,3);
}},{text:"Qr",dataIndex:"Qr",flex:1,renderer:function(e,f,d){return BUI.formatValuesUnits(d.data.Qr,"",12,3);}},{text:"Quality",dataIndex:"quality",flex:1,renderer:function(e,f,d){return(Number(d.data.quality)*100).toFixed(2)+"%";}},{text:"",renderer:function(f,d,e){if(e!=null){return BUI.getZipHTMLByFrameRangeId(c.experimentId,e.raw.frameNumber,e.raw.frameNumber);
}},width:100}],flex:1,viewConfig:{stripeRows:true}});if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:this._getTbar()});}return this.grid;};FrameGrid.prototype.input=function(){return[];};FrameGrid.prototype.test=function(c){var b=new FrameGrid({width:800,height:350,collapsed:false,tbar:true});
var a=b.getPanel([]);a.render(c);};function PeakGrid(a){this.height=500;this.searchBar=false;this.tbar=false;this.collapsed=false;this.width=500;this.showExtendedColumns=false;if(a!=null){if(a.showExtendedColumns!=null){this.showExtendedColumns=a.showExtendedColumns;}if(a.height!=null){this.height=a.height;
}if(a.searchBar!=null){this.searchBar=a.searchBar;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.collapsed!=null){this.collapsed=a.collapsed;}if(a.width!=null){this.width=a.width;}}}PeakGrid.prototype.refresh=function(a){this.store.loadData(this._prepareData(a),false);};PeakGrid.prototype._prepareData=function(a){if(a.length>0){a.unshift({name:"BUFFER",start:0,experimentId:a[0].experimentId,end:a[0].start-1});
}return a;};PeakGrid.prototype._getTbar=function(){var b=this;var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add Buffer",disabled:false,handler:function(e,d){var c=new BufferWindow();c.onSuccess.attach(function(f){b.store.loadData(BIOSAXS.proposal.getBuffers());});c.draw({});
}}));return a;};PeakGrid.prototype.getPanel=function(a){var c=this;this.peakCount=0;this.store=Ext.create("Ext.data.Store",{fields:["name",{name:"start",type:"int"},{name:"end",type:"int"}],data:a});this.store.sort("start");var b="Ext.grid.Panel";if(this.searchBar==true){b="Ext.ux.LiveSearchGridPanel";
}this.grid=Ext.create(b,{store:this.store,height:this.height,width:this.width,margin:5,columns:[{text:"",dataIndex:"name",width:100,hidden:c.showExtendedColumns,renderer:function(e,f,d){if(d.data.name=="BUFFER"){return"BUFFER";}c.peakCount++;return"Peak #"+c.peakCount;}},{text:"Peaks",dataIndex:"start",sortable:true,width:100,hidden:!c.showExtendedColumns,renderer:function(e,f,d){return"From "+Number(d.raw.start)+" to "+Number(d.raw.end);
}},{text:"Frames",hidden:c.showExtendedColumns,columns:[{text:"Start",dataIndex:"start",sortable:true,hidden:c.showExtendedColumns,width:100,renderer:function(e,f,d){return Number(e);}},{text:"End",dataIndex:"end",width:100,hidden:c.showExtendedColumns,renderer:function(e,f,d){return Number(e);}},{text:"Total",dataIndex:"end",width:100,hidden:c.showExtendedColumns,renderer:function(e,f,d){return"<span style='font-style:italic'>"+(d.raw.end-d.raw.start)+" frames</span>";
}}]}],flex:1,viewConfig:{stripeRows:true,getRowClass:function(d,f,g,e){if(d.raw.name=="BUFFER"){return"blue-row";}}}});if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:this._getTbar()});}return this.grid;};PeakGrid.prototype.input=function(){return[];};PeakGrid.prototype.test=function(c){var b=new b({width:800,height:350,collapsed:false,tbar:true});
var a=b.getPanel([]);a.render(c);};function MacromoleculeGrid(a){this.height=500;this.width=500;this.id=BUI.id();this.maxHeight=this.height;this.searchBar=false;this.tbar=false;this.collapsible=true;this.collapsed=true;this.btnEditVisible=true;this.btnRemoveVisible=false;this.multiselect=false;this.cssFontStyle=null;
if(a!=null){if(a.height!=null){this.height=a.height;this.maxHeight=this.height;}if(a.maxHeight!=null){this.maxHeight=a.maxHeight;}if(a.width!=null){this.width=a.width;}if(a.cssFontStyle!=null){this.cssFontStyle=a.cssFontStyle;}if(a.searchBar!=null){this.searchBar=a.searchBar;}if(a.tbar!=null){this.tbar=a.tbar;
}if(a.collapsible!=null){this.collapsible=a.collapsible;}if(a.collapsed!=null){this.collapsed=a.collapsed;}if(a.btnEditVisible!=null){this.btnEditVisible=a.btnEditVisible;}if(a.btnRemoveVisible!=null){this.btnRemoveVisible=a.btnRemoveVisible;}if(a.multiselect!=null){this.multiselect=a.multiselect;}}this.onSelected=new Event();
this.onMacromoleculesChanged=new Event();}MacromoleculeGrid.prototype.edit=function(a){var c=this;var b=new MacromoleculeWindow();b.onSuccess.attach(function(e,d){c.store.loadData(BIOSAXS.proposal.getMacromolecules());c.onMacromoleculesChanged.notify();});b.draw(BIOSAXS.proposal.getMacromoleculeById(a));
};MacromoleculeGrid.prototype.getTbar=function(){var b=this;var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add macromolecule",disabled:false,handler:function(e,d){var c=new MacromoleculeWindow();c.onSuccess.attach(function(f){b.store.loadData(BIOSAXS.proposal.getMacromolecules());
});c.draw({});}}));a.push("->");a.push(Ext.create("Ext.Action",{icon:"../images/folder_go.png",text:"Update From SMIS",tooltip:"Retrieve all the macromolecules of your proposal from SMIS database",disabled:false,handler:function(e,d){b.grid.setLoading("Connecting to SMIS");var c=new BiosaxsDataAdapter();
c.onSuccess.attach(function(f,g){BIOSAXS.proposal.setMacromolecules(g.macromolecules);b.refresh(BIOSAXS.proposal.macromolecules);b.grid.setLoading(false);});c.onError.attach(function(f,g){b.grid.setLoading(false);});c.updateDataBaseFromSMIS();}}));return a;};MacromoleculeGrid.prototype.deselectAll=function(){this.grid.getSelectionModel().deselectAll();
};MacromoleculeGrid.prototype.selectById=function(b){this.grid.getSelectionModel().deselectAll();for(var a=0;a<this.grid.getStore().data.items.length;a++){var c=this.grid.getStore().data.items[a].raw;if(c.macromoleculeId==b){this.grid.getSelectionModel().select(a);}}};MacromoleculeGrid.prototype.refresh=function(a){this.store.loadData(a,false);
};MacromoleculeGrid.prototype.getColumns=function(){var b=this;var a=[{text:"Acronym",dataIndex:"acronym",id:this.id+"acronym",flex:1,renderer:function(g,d,c,h,f,e){if(b.cssFontStyle!=null){return"<span style='"+b.cssFontStyle+"'>"+g+"</span>";}return g;}},{text:"Name",dataIndex:"name",id:this.id+"name",flex:1,hidden:true}];
if(this.btnEditVisible){a.push({id:b.id+"buttonEditMacromolecule",width:85,sortable:false,renderer:function(g,d,c,h,f,e){if(b.btnEditVisible){return BUI.getGreenButton("EDIT");}return null;}});}if(this.btnRemoveVisible){a.push({id:b.id+"buttonRemoveMacromolecule",width:85,sortable:false,renderer:function(g,d,c,h,f,e){if(b.btnRemoveVisible){return BUI.getRedButton("REMOVE");
}return null;}});}return a;};MacromoleculeGrid.prototype._prepareData=function(a){return a;};MacromoleculeGrid.prototype.getPanel=function(b){var d=this;this.store=Ext.create("Ext.data.Store",{fields:["macromoleculeId","name","acronym"],data:d._prepareData(b)});this.store.sort("acronym");var c="Ext.grid.Panel";
if(this.searchBar==true){c="Ext.ux.LiveSearchGridPanel";}var a=null;if(this.multiselect){a=Ext.create("Ext.selection.CheckboxModel",{multiSelect:this.multiselect,listeners:{selectionchange:function(h,g){var e=[];for(var f=0;f<g.length;f++){e.push(g[f].raw);}d.onSelected.notify(e);}}});}this.grid=Ext.create(c,{id:this.id,title:"Macromolecules",collapsible:this.collapsible,collapsed:this.collapsed,store:this.store,height:this.height,maxHeight:this.maxHeight,selModel:a,allowDeselect:true,columns:this.getColumns(),width:this.width,viewConfig:{stripeRows:true,listeners:{"celldblclick":function(i,m,g,f,j,l,k,h){d.edit(f.data.macromoleculeId);
},"cellclick":function(i,m,g,f,j,l,k,h){if(i.getGridColumns()[g].getId()==d.id+"buttonEditMacromolecule"){d.edit(f.data.macromoleculeId);}if(i.getGridColumns()[g].getId()==d.id+"buttonRemoveMacromolecule"){BUI.showBetaWarning();}}}}});if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:this.getTbar()});
}return this.grid;};MacromoleculeGrid.prototype.input=function(){return{proposal:DATADOC.getProposal_10()};};MacromoleculeGrid.prototype.test=function(b){var c=new MacromoleculeGrid({width:800,height:350,collapsed:false,tbar:true});BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel(BIOSAXS.proposal.macromolecules);
a.render(b);};function MeasurementGrid(a){this.id=BUI.id();this.height=500;this.width=900;this.maxWidth=1200;this.maxHeight=600;this.minHeight=500;this.unitsFontSize=9;this.title="Measurements";this.estimateTime=false;this.collapsed=true;this.tbar=true;this.showTitle=true;this.resizable=true;this.updateRowEnabled=true;
this.editor={comments:{xtype:"textfield",allowBlank:true}};this.isTimeColumnHidden=false;this.isStatusColumnHidden=false;this.isPriorityColumnHidden=true;this.margin="0 0 0 0";this.addBtnEnable=true;this.sorter=[{property:"priority",direction:"ASC"}];this.removeBtnEnabled=false;this.collapseBtnEnable=true;
this.addBtnMultipleEdit=false;this.sortingBtnEnable=false;var b=this;this.selModel=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(f,e){var d=[];for(var c=0;c<e.length;c++){d.push(e[c].raw);}b.onSelected.notify(d);}}});if(a!=null){if(a.selModel!=null){this.selModel=a.selModel;
}if(a.removeBtnEnabled!=null){this.removeBtnEnabled=a.removeBtnEnabled;}if(a.addBtnMultipleEdit!=null){this.addBtnMultipleEdit=a.addBtnMultipleEdit;}if(a.collapsed!=null){this.collapsed=a.collapsed;}if(a.resizable!=null){this.resizable=a.resizable;}if(a.editor!=null){this.editor=a.editor;}if(a.collapseBtnEnable!=null){this.collapseBtnEnable=a.collapseBtnEnable;
}if(a.addBtnEnable!=null){this.addBtnEnable=a.addBtnEnable;}if(a.sortingBtnEnable!=null){this.sortingBtnEnable=a.sortingBtnEnable;}if(a.isPriorityColumnHidden!=null){this.isPriorityColumnHidden=a.isPriorityColumnHidden;}if(a.width!=null){this.width=a.width;}if(a.updateRowEnabled!=null){this.updateRowEnabled=a.updateRowEnabled;
}if(a.showTitle!=null){this.showTitle=a.showTitle;if(this.showTitle==false){this.title=null;}}if(a.height!=null){this.height=a.height;}if(a.maxHeight!=null){this.maxHeight=a.maxHeight;}if(a.minHeight!=null){this.minHeight=a.minHeight;}if(a.maxWidth!=null){this.maxWidth=a.maxWidth;}if(a.isStatusColumnHidden!=null){this.isStatusColumnHidden=a.isStatusColumnHidden;
}if(a.isTimeColumnHidden!=null){this.isTimeColumnHidden=a.isTimeColumnHidden;}if(a.title!=null){this.title=a.title;}if(a.estimateTime!=null){this.estimateTime=a.estimateTime;}if(a.margin!=null){this.margin=a.margin;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.sorter!=null){this.sorter=a.sorter;}}this.onClick=new Event(this);
this.onSelected=new Event(this);this.onRemoved=new Event(this);this.onUpdateTime=new Event(this);this.onMeasurementChanged=new Event(this);this.onExperimentChanged=new Event(this);}MeasurementGrid.prototype._sortBy=function(b){var c=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(d,e){c.onExperimentChanged.notify(e);
c.grid.setLoading(false);});a.onError.attach(function(d,e){c.grid.setLoading(false);alert("Oops, there was a problem");});c.grid.setLoading("Sorting");a.sortMeasurements(this.experiments.experiments[0].experimentId,b);};MeasurementGrid.prototype._getMenu=function(){var d=this;if(this.tbar){var b=[];if(d.addBtnEnable){b.push({icon:"../images/add.png",text:"Add measurements",handler:function(){d._openAddMeasurementWindow();
}});}if(d.addBtnMultipleEdit){b.push({icon:"../images/Edit_16x16_01.png",text:"Multiple Edit",handler:function(){var e=new MultipleEditMeasurementGridWindow();e.onExperimentChanged.attach(function(f,g){d.onExperimentChanged.notify(g);});e.draw(d.measurements,d.experiments);}});}b.push("->");if(d.sortingBtnEnable){var c=Ext.create("Ext.button.Split",{text:"Sort by",handler:function(){},menu:new Ext.menu.Menu({items:[{text:"First Created First Measured",handler:function(){d._sortBy("FIFO");
}},"-",{text:"Default",handler:function(){d._sortBy("DEFAULT");}}]})});b.push(c);}if(d.collapseBtnEnable){b.push({text:"Collapse buffers",enableToggle:true,scope:this,toggleHandler:function(e,f){this.collapsed=f;this.grid.getStore().loadData(this._prepareData(this.measurements,this.experiments),false);
},pressed:this.collapsed});}var a=Ext.create("Ext.toolbar.Toolbar",{items:b});return a;}return null;};MeasurementGrid.prototype._openAddMeasurementWindow=function(a,b){var d=this;var c=new WizardWidget();c.onFinished.attach(function(g,e){var f=new BiosaxsDataAdapter();f.onSuccess.attach(function(h,i){d.onExperimentChanged.notify(i);
d.grid.setLoading(false);c.window.close();});c.current.setLoading("ISPyB: Adding measurements");f.addMeasurements(e.name,"comments",e.data,d.experiments.experiments[0].experimentId);});c.draw(null,new MeasurementCreatorStepWizardForm(BIOSAXS.proposal.getMacromolecules(),{noNext:true}));};MeasurementGrid.prototype._prepareData=function(a,j){var f=[];
for(var g=0;g<a.length;g++){var c=a[g];var l=j.getSampleById(c.specimenId);var e=j.getBufferById(l.bufferId);c.buffer_acronym=e.acronym;c.bufferId=e.bufferId;c.volume=l.volume;if(l.macromolecule3VO!=null){c.acronym=l.macromolecule3VO.acronym;c.macromoleculeId=l.macromolecule3VO.macromoleculeId;}c.concentration=l.concentration;
if(c.run3VO!=null){c.energy=c.run3VO.energy;c.expExposureTemperature=c.run3VO.exposureTemperature;c.storageTemperature=c.run3VO.storageTemperature;c.timePerFrame=c.run3VO.timePerFrame;c.radiationAbsolute=c.run3VO.radiationAbsolute;c.radiationRelative=c.run3VO.radiationRelative;c.status="DONE";try{if(c.run3VO.timeStart!=null){if(c.run3VO.timeStart!=""){c.miliseconds=moment(c.run3VO.timeStart).format("X");
}}}catch(m){console.log(m);}}if(j.getDataCollectionByMeasurementId(c.measurementId).length>0){var h=j.getDataCollectionByMeasurementId(c.measurementId)[0].measurementtodatacollection3VOs;for(var d=0;d<h.length;d++){if(h[d].dataCollectionOrder==1){var b=j.getSampleById(j.getMeasurementById(h[d].measurementId).specimenId);
if(b.sampleplateposition3VO!=null){c.bufferSampleplateposition3VO=b.sampleplateposition3VO;c.bufferSampleplate=(j.getSamplePlateById(b.sampleplateposition3VO.samplePlateId));}}}}if(this.collapsed){if(l.macromolecule3VO!=null){f.push(c);}}else{f.push(c);}}return f;};MeasurementGrid.prototype.refresh=function(a,b){this.experiments=b;
this.measurements=a;this.store.loadData(this._prepareData(a,b),false);};MeasurementGrid.prototype._showStatusBarBusy=function(b){var a=Ext.getCmp(this.id+"basic-statusbar");a.setStatus({text:b,iconCls:"x-status-busy",clear:false});};MeasurementGrid.prototype._showStatusBarReady=function(b){var a=Ext.getCmp(this.id+"basic-statusbar");
a.setStatus({text:b,iconCls:"x-status-valid",clear:false});};MeasurementGrid.prototype._getPlugins=function(){var b=this;var a=[];if(this.updateRowEnabled){a.push(Ext.create("Ext.grid.plugin.RowEditing",{clicksToEdit:1,listeners:{validateedit:function(f,g){for(var d in b.editor){g.record.raw[d]=g.newValues[d];
}g.record.raw.comments=g.newValues.comments;var c=new BiosaxsDataAdapter();c.onSuccess.attach(function(e,h){b.onMeasurementChanged.notify(h);b.grid.setLoading(false);});c.onError.attach(function(){alert("Error");b.grid.setLoading(false);});b.grid.setLoading();c.saveMeasurement(g.record.raw,b.experiments.experiments[0]);
}}}));}return a;};MeasurementGrid.prototype._getEditor=function(a){if(this.editor[a]!=null){return this.editor[a];}return null;};MeasurementGrid.prototype.getPanel=function(a,b){this.experiments=b;this.measurements=a;var e=this;this.store=Ext.create("Ext.data.Store",{fields:[{name:"miliseconds",type:"int"},"priority","bufferId",{name:"exposureTemperature",type:"numeric"},"volumeToLoad","code","transmission","viscosity","waitTime","flow","buffer_acronym","macromoleculeId","acronym","concentration","extraFlowTime","volume","energy","expExposureTemperature","storageTemperature","timePerFrame","radiationAbsolute","radiationRelative","status","comments"],data:this._prepareData(a,b)});
this.store.sort(this.sorter);var d={};try{d=Ext.create("Ext.ux.StatusBar",{id:e.id+"basic-statusbar",defaultText:"Ready",text:"Ready",iconCls:"x-status-valid",items:[]});}catch(c){console.log("bbar error");}this.grid=Ext.create("Ext.grid.Panel",{id:this.id,title:this.title,store:this.store,selModel:this.selModel,plugins:this._getPlugins(),resizable:this.resizable,margin:this.margin,maxHeight:this.maxHeight,minHeight:this.minHeight,maxWidth:this.maxWidth,width:this.width,tbar:this._getMenu(),columns:[{text:"Order",dataIndex:"priority",width:50,hidden:e.isPriorityColumnHidden,sortable:true},{text:"Run Number",dataIndex:"code",width:50,hidden:true,sortable:true},{text:"Specimen",columns:[{text:"",dataIndex:"macromoleculeId",width:30,renderer:function(g,h,f){if(g!=null){if(e.experiments==null){return BUI.getRectangleColorDIV(BIOSAXS.proposal.macromoleculeColors[g],10,10);
}else{return BUI.getRectangleColorDIV(e.experiments.macromoleculeColors[g],10,10);}}},sortable:true},{text:"Macromo.",dataIndex:"acronym",width:80,renderer:function(g,h,f){return g;},sortable:true},{text:"Conc. ",dataIndex:"concentration",width:80,renderer:function(g,h,f){if(f.raw.macromoleculeId==null){return"";
}if(isNaN(g)){return g;}if(g!=0){return BUI.formatValuesUnits(g,"",{fontSize:16,decimals:3,unitsFontSize:this.unitsFontSize});}else{return;}},sortable:true},{text:"",dataIndex:"bufferId",width:30,hidden:false,renderer:function(i,j,h){if(i!=null){var g="#FFCCFF";if(e.experiments!=null){var f=e.experiments.getDataCollectionByMeasurementId(h.raw.measurementId);
if(f!=null){if(f.length>0){g=e.experiments.getSpecimenColorByBufferId(e.experiments.getMeasurementById(f[0].measurementtodatacollection3VOs[0].measurementId).specimenId);}}}else{g=BIOSAXS.proposal.bufferColors[i];}return BUI.getRectangleColorDIV(g,10,10);}},sortable:true},{text:"Buffer",dataIndex:"buffer_acronym",width:120,renderer:function(g,h,f){if(f.raw.bufferSampleplateposition3VO!=null){return BIOSAXS.proposal.getBufferById(f.raw.bufferId).acronym+"<span style='font-style:oblique;'> Plate: ["+f.raw.bufferSampleplate.slotPositionColumn+", "+BUI.getSamplePlateLetters()[f.raw.bufferSampleplateposition3VO.rowNumber-1]+"-"+f.raw.bufferSampleplateposition3VO.columnNumber+"]</span>";
}return g;},sortable:true},{text:"Position",width:100,hidden:true,renderer:function(g,h,f){if(e.experiments!=null){return BUI.getSamplePositionHTML(e.experiments.getSampleById(f.raw.specimenId),e.experiments.experiments[0]);}}}]},{text:"Parameters",columns:[{text:"Ex. Flow. time (s)",dataIndex:"extraFlowTime",width:100,hidden:true,renderer:function(g,h,f){return BUI.formatValuesUnits(g,"s",{fontSize:12,decimals:0,unitsFontSize:this.unitsFontSize});
}},{text:"Exp. Temp.",dataIndex:"exposureTemperature",width:70,renderer:function(g,h,f){if(Number(g)){return BUI.formatValuesUnits(g,"C",{fontSize:12,decimals:2,unitsFontSize:this.unitsFontSize});}return null;},sortable:true,editor:this._getEditor("exposureTemperature")},{text:"Vol. Load",dataIndex:"volumeToLoad",width:60,hidden:false,editor:this._getEditor("volumeToLoad"),renderer:function(g,h,f){return BUI.formatValuesUnits(g,"&#181l",{fontSize:12,decimals:2,unitsFontSize:this.unitsFontSize});
}},{text:"Volume in Well",dataIndex:"volume",hidden:true,editor:this._getEditor("volume"),width:80,renderer:function(g,h,f){return BUI.formatValuesUnits(g,"&#181l",{fontSize:12,decimals:2,unitsFontSize:this.unitsFontSize});}},{text:"Trans.",dataIndex:"transmission",width:60,editor:this._getEditor("transmission"),renderer:function(g,h,f){return BUI.formatValuesUnits(g,"%",{fontSize:12,decimals:0,unitsFontSize:this.unitsFontSize});
}},{text:"Wait T.",dataIndex:"waitTime",editor:this._getEditor("waitTime"),width:50,renderer:function(g,h,f){return BUI.formatValuesUnits(g,"s",{fontSize:12,decimals:0,unitsFontSize:this.unitsFontSize});}},{text:"Flow",dataIndex:"flow",editor:this._getEditor("flow"),width:50,renderer:function(g,h,f){if(g==true){return"yes";
}return null;}},{text:"Viscosity",dataIndex:"viscosity",tooltip:'The viscosity of a fluid is a measure of its resistance to gradual deformation by shear stress or tensile stress. For liquids, it corresponds to the informal notion of "thickness"',editor:this._getEditor("viscosity"),width:50,renderer:function(g,h,f){return g;
}}]},{text:"Status",dataIndex:"status",width:50,hidden:e.isStatusColumnHidden,renderer:function(g,h,f){if(g!=null){if(g=="DONE"){return"<span style='color:green; font-weight:bold;'>"+g+" </span>";}}}},{text:"Time",dataIndex:"time",width:80,hidden:e.isTimeColumnHidden,renderer:function(h,i,g){if(g.raw.run3VO!=null){if(g.raw.run3VO.timeStart!=null){if(g.raw.run3VO.timeStart!=""){var f=moment(g.raw.run3VO.timeStart);
return f.format("hh:mm:ss a");}}}}},{text:"Energy",dataIndex:"energy",width:100,hidden:true},{text:"Real Exp. Temp.(C)",width:100,dataIndex:"expExposureTemperature",hidden:true},{text:"Storage Temp.(C)",width:100,dataIndex:"storageTemperature",hidden:true},{text:"Time/Frame (s)",width:100,dataIndex:"timePerFrame",hidden:true},{text:"Radiation Relative",dataIndex:"radiationRelative",width:100,hidden:true},{text:"Radiation Absolute",dataIndex:"radiationAbsolute",width:100,hidden:true},{text:"Comments",dataIndex:"comments",flex:1,hidden:false,editor:this._getEditor("comments")},{id:e.id+"buttonRemoveSample",text:"",hidden:!e.removeBtnEnabled,width:100,sortable:false,renderer:function(j,g,f,k,i,h){if(f.raw.macromoleculeId!=null){if(e.removeBtnEnabled){return BUI.getRedButton("REMOVE");
}}}}],bbar:d,viewConfig:{stripeRows:true,getRowClass:function(f,h,i,g){if(f.data.status=="DONE"){return"green-row";}},listeners:{"itemclick":function(i,f,j,g,k,h){e.onClick.notify({specimen:f.raw});},"cellclick":function(f,g,l,h,k,m,i,j){if(f.getGridColumns()[l].getId()==e.id+"buttonRemoveSample"){f.getStore().removeAt(m);
if(h.raw.measurementId!=null){f.setLoading("ISPyB: Removing measurement");var n=new BiosaxsDataAdapter();n.onSuccess.attach(function(o,q){f.setLoading(false);var p=new BiosaxsDataAdapter();p.onSuccess.attach(function(s,r){e.onRemoved.notify(r);e._showStatusBarReady("Ready");});if(e.experiments.experiments[0].experimentId!=null){p.getExperimentById(e.experiments.experiments[0].experimentId,"MEDIUM");
e._showStatusBarBusy("ISPyB: Removing Unused Specimens");}});n.onError.attach(function(o,p){alert("Error: "+p);f.setLoading(false);});n.removeMeasurement(h.raw);}}}}}});this.grid.on("afterrender",function(){function i(){try{e.estimatedTime=e.estimatedTime-1;e.onUpdateTime.notify({hours:(Number(e.estimatedTime/3600).toFixed()),minutes:(Number((e.estimatedTime/60)%60).toFixed()),seconds:(Number(e.estimatedTime%60).toFixed())});
if(Number(e.estimatedTime)<0){e.timer=null;grid.setTitle(e.title);}}catch(o){console.log(o);e.timer=null;}}if(e.estimateTime){var k=e.experiments;var l=k.getMeasurementsCollected();if(l.length>0){if(l[0].run3VO!=null){try{var h=l[0].run3VO.timeEnd;var f=l[0].run3VO.timeStart;var n=moment(f);var g=moment(h);
var m=Number(g.diff(n)/1000).toFixed();e.estimatedTime=(m*k.getMeasurementsNotCollected().length);if(e.estimatedTime>0){i();e.timer=setInterval(function(){i();},1000);}}catch(j){}}}}});return this.grid;};MeasurementGrid.prototype.input=function(){var b=DATADOC.getExperiment_10();var a=DATADOC.getMeasurements_10();
var c=DATADOC.getProposal_10();return{experiment:b,measurements:a,proposal:c};};MeasurementGrid.prototype.test=function(b){var c=new MeasurementGrid({tbar:true});BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel(c.input().measurements,new ExperimentList([new Experiment(c.input().experiment)]));
a.render(b);};function PrimaryDataProcessingGrid(a){QueueGrid.prototype.constructor.call(this,a);this.onSelected=new Event(this);}PrimaryDataProcessingGrid.prototype.update=QueueGrid.prototype.update;PrimaryDataProcessingGrid.prototype.refresh=QueueGrid.prototype.refresh;PrimaryDataProcessingGrid.prototype._prepareData=QueueGrid.prototype._prepareData;
PrimaryDataProcessingGrid.prototype._getTbar=QueueGrid.prototype._getTbar;PrimaryDataProcessingGrid.prototype._getHTMLRow=QueueGrid.prototype._getHTMLRow;PrimaryDataProcessingGrid.prototype.openCurveVisualizer=QueueGrid.prototype.openCurveVisualizer;PrimaryDataProcessingGrid.prototype.getStore=QueueGrid.prototype.getStore;
PrimaryDataProcessingGrid.prototype.getColumns=function(){var a=this;return[{header:"Exp. Id",name:"experimentId",dataIndex:"experimentId",hidden:true},{header:"measurementId",name:"experimentId",dataIndex:"measurementId",hidden:true,renderer:function(c,d,b){return b.raw.measurementId;}},{header:"Run",width:75,name:"runNumber",dataIndex:"measurementCode",hidden:true,renderer:function(d,e,c){var b="<span style='font-style:bold;font-weight:bold;'>"+d+"</span>";
if(c.raw.runCreationDate!=null){b=b+"<br/><span style='font-style: italic;color:gray;'>"+moment(c.raw.runCreationDate).format("HH:mm:ss")+"</span>";}else{if(c.raw.creationTime!=null){b=b+"<br/><span style='font-style: italic;color:gray;'>"+moment(c.raw.creationTime).format("HH:mm:ss")+"</span>";}}return b;
}},{header:"priorityLevelId",name:"priorityLevelId",dataIndex:"priorityLevelId",hidden:true},{header:"Sample",dataIndex:"macromoleculeId",name:"macromoleculeAcronym",flex:1,renderer:function(f,g,c){var b="<table>";var d=BIOSAXS.proposal.getMacromoleculeById(c.raw.macromoleculeId);if(d!=null){b=b+'<tr><td><span style="color:green;font-size:14;">'+d.acronym+"</span></td></tr>";
b=b+"<tr><td>"+BUI.formatValuesUnits(c.raw.concentration,"mg/ml",10,this.decimals)+"</td></tr>";}if(c.raw.bufferId!=null){if(BIOSAXS.proposal.getBufferById(c.raw.bufferId)!=null){var e=BIOSAXS.proposal.getBufferById(c.raw.bufferId).acronym;if((e=="")||(e==null)){e="No name";}b=b+'<tr><td><span style="color:blue;font-size:14;">'+e+"</span></td></tr><tr><td>";
}}b=b+"<tr><td>"+BUI.formatValuesUnits(c.raw.exposureTemperature,"C",10,this.decimals)+"</td></tr>";return b+"</table>";}},{header:"Average",dataIndex:"macromoleculeId",name:"macromoleculeAcronym",width:60,renderer:function(g,h,d){var c="<table>";if(d.raw.runId!=null){if(d.raw.framesMerge!=null){var e="new SubtractionCurveVisualizer().refresh(["+d.raw.mergeId+"], [])";
c=c+"<tr onmouseover='' style='color:blue;cursor: pointer;' onclick='"+e+"'><td >"+d.raw.framesMerge+" of "+d.raw.framesCount+"</td></tr>";}}if(d.raw.averages!=null){for(var b=1;b<d.raw.averages.length;b++){if(d.raw.averages[b].framesMerge!=null){var e="new SubtractionCurveVisualizer().refresh(["+d.raw.averages[b].mergeId+"], [])";
c=c+"<tr onmouseover='' style='color:gray;font-style: italic; cursor: pointer;'  onclick='"+e+"'><td >"+d.raw.averages[b].framesMerge+" of "+d.raw.averages[b].framesCount+"</td></tr>";}}}return c+"</table>";}},{text:"Scattering",dataIndex:"subtractionId",width:66,name:"subtractionId",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=scattering&subtractionId="+d.raw.subtractionId;
var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";}}}},{text:"Kratky.",dataIndex:"subtractionId",width:66,hidden:true,name:"subtractionId",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=kratky&subtractionId="+d.raw.subtractionId;
var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";}}}},{text:"P(r).",hidden:true,width:66,dataIndex:"subtractionId",type:"string",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=gnom&subtractionId="+d.raw.subtractionId;
var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";}}}},{text:"Guinier.",hidden:true,width:66,dataIndex:"subtractionId",type:"string",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=guinier&subtractionId="+d.raw.subtractionId;
var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">sdfsdfs</img>";}}}},{text:"Guinier",name:"Guinier",columns:[{text:"Rg",dataIndex:"rg",name:"rg",width:70,tooltip:"In polymer physics, the radius of gyration is used to describe the dimensions of a polymer chain.",sortable:true,renderer:function(c,d,b){c=b.raw.rg;
if(c!=null){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(Math.abs(c-b.raw.rgGnom)>(c*0.1)){return"<span style='color:orange;'>"+BUI.formatValuesUnits(c,"")+"</span>";}return BUI.formatValuesUnits(c,"nm",12,this.decimals);}}}}},{text:"Points",dataIndex:"points",sortable:true,width:70,type:"string",renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if((b.raw.firstPointUsed=="")||(b.raw.firstPointUsed==null)){return;
}return"<span>"+b.raw.firstPointUsed+" - "+b.raw.lastPointUsed+"<br/> ("+(b.raw.lastPointUsed-b.raw.firstPointUsed)+" )</span>";}}}},{text:"I(0)",dataIndex:"I0",sortable:true,tooltip:"Extrapolated scattering intensity at zero angle I(0) (forward scattering)",width:80,type:"string",renderer:function(c,d,b){c=b.raw.I0;
if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(c!=null){return BUI.formatValuesErrorUnitsScientificFormat(c,b.raw.I0Stdev,"",{decimals:2});}}}}},{text:"Quality",dataIndex:"quality",tooltip:"Estimated data quality. 1.0 - means ideal quality, 0.0 - unusable data. In table format it is given in percent (100% - ideal quality, 0% - unusable data). Please note that this estimation is based only on the Guinier interval (very low angles).",width:60,sortable:true,renderer:function(c,d,b){c=b.raw.quality;
if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(c!=null){if((c!=null)&&(c!="")){return Number(c).toFixed(2);}}}}}},{text:"Aggregated",tooltip:"If aggregation was detected from the slope of the data curve at low angles the value is '1', otherwise '0'.",dataIndex:"isagregated",width:80,hidden:true,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if((b.raw.isagregated!=null)){if(c==true){return"Yes";
}else{return"No";}}}}}}]},{text:"Gnom",name:"Gnom",columns:[{text:"Rg",dataIndex:"rgGnom",type:"string",width:80,sortable:true,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(b.raw.rgGnom!=null){if(Math.abs(b.raw.rgGuinier-b.raw.rgGnom)>(b.raw.rgGuinier*0.1)){return"<span style='color:orange;'>"+BUI.formatValuesUnits(b.raw.rgGnom,"")+"</span>";
}return BUI.formatValuesUnits(b.raw.rgGnom,"nm");}}}}},{text:"Total",dataIndex:"total",width:70,sortable:true,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(b.raw.total!=null){return BUI.formatValuesUnits(b.raw.total,"");}}}}},{text:"D<sup>max</sup>",dataIndex:"dmax",sortable:true,width:70,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(b.raw.dmax!=null){return BUI.formatValuesUnits(b.raw.dmax,"")+"<span style='font-size:8px;color:gray;'> nm</span>";
}}}}},{text:"P(r)",sortable:true,dataIndex:"subtractionId",type:"string",hidden:true,renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=gnom&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";
}}}}]},this._getPorod()];};PrimaryDataProcessingGrid.prototype._getPorod=function(){return{text:"Porod",name:"Porod",columns:[{text:"Volume",dataIndex:"volumePorod",sortable:true,renderer:function(b,c,a){if(a.raw.macromoleculeId!=null){if(a.raw.subtractionId!=null){if(a.raw.volumePorod!=null){return BUI.formatValuesUnits(a.raw.volumePorod,"")+"<span style='font-size:8px;color:gray;'> nm<sub>3</sub></span>";
}}}}},{text:"MM Vol. est.",dataIndex:"volumeEdna",tooltip:"[Volume/2 - Volume/1.5] (Guinier)",sortable:true,renderer:function(b,c,a){if(a.raw.macromoleculeId!=null){if(a.raw.subtractionId!=null){if(a.raw.volume!=null){return Number(a.raw.volume/2).toFixed(1)+" - "+Number(a.raw.volume/1.5).toFixed(1)+"<span style='font-size:8px;color:gray;'>kD</span>";
}}}}}]};};PrimaryDataProcessingGrid.prototype.getPanel=function(d){var e=this;this.data=e._prepareData(d);this.store=this.getStore();var b=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(h,g){e.selected=new Array();for(var f=0;f<g.length;f++){e.selected.push(g[f].raw);
}}}});var c={text:"Primary Data Processing ",xtype:"button",icon:"../images/magnif.png",handler:function(){var h=[];var g=[];for(var f=0;f<e.selected.length;f++){if(e.selected[f].mergeId!=null){h.push(e.selected[f].mergeId);}if(e.selected[f].macromoleculeId!=null){if(e.selected[f].subtractionId!=null){g.push(e.selected[f].subtractionId);
}}}e.openCurveVisualizer(h,g);}};var a=Ext.create("Ext.toolbar.Toolbar",{flex:1,border:0,items:[c]});this.grid=Ext.create("Ext.grid.Panel",{collapsible:false,resizable:true,selModel:b,tbar:[a],autoscroll:true,store:this.store,columns:this.getColumns(),viewConfig:{enableTextSelection:true,preserveScrollOnRefresh:true,stripeRows:true,listeners:{"celldblclick":function(i,m,g,f,j,l,k,h){},"cellclick":function(f,g,p,l,o,q,m,n){if(f.getGridColumns()[p].getId()==e.id+"buttonEditBuffer"){e._edit(l.data.bufferId);
}if(f.getGridColumns()[p].getId()==e.id+"buttonRemoveBuffer"){BUI.showBetaWarning();}if(f.getGridColumns()[p].getId()==e.id+"PorodColumn"){var j=new MacromoleculeWindow();j.draw(BIOSAXS.proposal.getMacromoleculeById(l.raw.macromoleculeId));j.onSuccess.attach(function(i){e.update();});}var h=[];for(var k=0;
k<f.getSelectionModel().selected.items.length;k++){h.push(f.getSelectionModel().selected.items[k].raw);}e.onSelected.notify(h);}}}});this.grid.on("afterrender",function(){});return this.grid;};Ext.define("Ext.ux.data.PagingMemoryProxy",{extend:"Ext.data.proxy.Memory",alias:"proxy.pagingmemory",alternateClassName:"Ext.data.PagingMemoryProxy",read:function(c,g,h){var d=this.getReader(),i=d.read(this.data),e,a,f,b;
h=h||this;a=c.filters;if(a.length>0){b=[];Ext.each(i.records,function(j){var o=true,p=a.length,k;for(k=0;k<p;k++){var n=a[k],m=n.filterFn,l=n.scope;o=o&&m.call(l,j);}if(o){b.push(j);}},this);i.records=b;i.totalRecords=i.total=b.length;}e=c.sorters;if(e.length>0){f=function(l,k){var j=e[0].sort(l,k),n=e.length,m;
for(m=1;m<n;m++){j=j||e[m].sort.call(this,l,k);}return j;};i.records.sort(f);}if(c.start!==undefined&&c.limit!==undefined){i.records=i.records.slice(c.start,c.start+c.limit);i.count=i.records.length;}Ext.apply(c,{resultSet:i});c.setCompleted();c.setSuccessful();Ext.Function.defer(function(){Ext.callback(g,h,[c]);
},10);}});function QueueGrid(a){this.height=700;this.searchBar=false;this.tbar=true;this.bbar=false;this.collapsed=false;this.id=BUI.id();this.filter=[];this.title="Data Collections";this.limit=500;this.pageSize=100;this.pageCount=null;this.currentPage=1;this.selected=[];this.decimals=3;if(a!=null){if(a.height!=null){this.height=a.height;
}if(a.searchBar!=null){this.searchBar=a.searchBar;}if(a.title!=null){this.title=a.title;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.collapsed!=null){this.collapsed=a.collapsed;}if(a.width!=null){this.width=a.width;}}}QueueGrid.prototype.update=function(){var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(c,d){b.grid.setLoading(false);
b.refresh(d);});b.grid.setLoading("Updating");a.getCompactAnalysisByProposalId(this.limit);};QueueGrid.prototype.refresh=function(a){this.store.loadData(this._prepareData(a),false);this.refreshNavigationBar();};QueueGrid.prototype.refreshNavigationBar=function(){if(this.bbar==true){Ext.getCmp(this.id+"currentPage").setValue(this.currentPage);
}};QueueGrid.prototype._prepareData=function(c){var e=[];var a=[];for(var d=0;d<c.length;d++){if((c[d].experimentType=="STATIC")||((c[d].experimentType=="CALIBRATION"))){a.push(c[d]);}}c=a;var b={};for(var d=0;d<c.length;d++){if(c[d].specimenId!=null){if(c[d].mergeId!=null){if(b[c[d].measurementId]==null){b[c[d].measurementId]=[];
e.push(c[d]);}b[c[d].measurementId].push(c[d]);c[d].averages=b[c[d].measurementId];}else{c[d].averages=[];e.push(c[d]);}}}for(var d=0;d<e.length;d++){e[d]["date"]=moment(e[d].creationDate).format("YYYYMMDD");}return e;};QueueGrid.prototype.getTbar=function(){var b={text:"Primary Data Processing ",xtype:"button",icon:"../images/magnif.png",handler:function(){var f=[];
var e=[];for(var d=0;d<c.selected.length;d++){if(c.selected[d].mergeId!=null){f.push(c.selected[d].mergeId);}if(c.selected[d].macromoleculeId!=null){if(c.selected[d].subtractionId!=null){e.push(c.selected[d].subtractionId);}}}c.openCurveVisualizer(f,e);}};var c=this;function a(e,d){if(e.text!=c.limit){if(e.text=="All"){c.limit=2000;
}else{c.limit=e.text;c.update();}}}return Ext.create("Ext.toolbar.Toolbar",{flex:1,border:1,items:[{xtype:"button",text:"Search",icon:"../images/magnif.png",menu:[{text:"By date"},{text:"By macromolecule"}]},{xtype:"button",text:"View",menu:[{text:"Hide solvents",checked:false},{text:"Fetch",menu:{items:['<b class="menu-title">Choose a number of data collection to be fetched</b>',{text:"100",checked:true,group:"theme",checkHandler:a},{text:"200",checked:false,group:"theme",checkHandler:a},{text:"500",checked:false,group:"theme",checkHandler:a},{text:"1000",checked:false,group:"theme",checkHandler:a},{text:"All",checked:false,group:"theme",checkHandler:a}]}}]}]});
};QueueGrid.prototype._getPorod=function(){return{text:"Porod",name:"Porod",columns:[{text:"Volume",dataIndex:"volumePorod",width:80,sortable:true,renderer:function(b,c,a){if(a.raw.macromoleculeId!=null){if(a.raw.subtractionId!=null){if(a.raw.volumePorod!=null){return BUI.formatValuesUnits(a.raw.volumePorod,"")+"<span style='font-size:8px;color:gray;'> nm<sub>3</sub></span>";
}}}}},{text:"MM Vol. est.",dataIndex:"volumeEdna",tooltip:"[Volume/2 - Volume/1.5] (Guinier)",sortable:true,width:95,renderer:function(b,c,a){if(a.raw.macromoleculeId!=null){if(a.raw.subtractionId!=null){if(a.raw.volume!=null){return Number(a.raw.volume/2).toFixed(1)+" - "+Number(a.raw.volume/1.5).toFixed(1)+"<span style='font-size:8px;color:gray;'>kD</span>";
}}}}}]};};QueueGrid.prototype._getHTMLRow=function(d,e,c,b,a){if(e!=null){if(a!=null){e=Number(e).toFixed(a);}if(c!=null){return"<td style='padding:2px;color:gray'>"+d+": </td><td style='padding-left:10px;font-size:12px;'>"+e+" "+b+"  <span style='font-size:10px;padding-left:5px;'>&#177; "+c+"</span></td>";
}else{return"<tr><td style='padding:2px;color:gray'>"+d+": </td><td style='padding-left:10px'>"+e+" "+b+"</td></tr>";}}return"";};QueueGrid.prototype.openCurveVisualizerBySelected=function(c,b){var c=[];var b=[];for(var a=0;a<this.selected.length;a++){if(this.selected[a].mergeId!=null){c.push(this.selected[a].mergeId);
}if(this.selected[a].macromoleculeId!=null){if(this.selected[a].subtractionId!=null){b.push(this.selected[a].subtractionId);}}}this.openCurveVisualizer(c,b);};QueueGrid.prototype.openCurveVisualizer=function(c,b){var a=new SubtractionCurveVisualizer();Ext.create("Ext.window.Window",{title:"Fit Structure to Data",height:500,width:800,layout:"fit",items:[a.getPanel()]}).show();
a.refresh(c,b);};QueueGrid.prototype.getStore=function(){Ext.define("Queue",{extend:"Ext.data.Model",fields:["name","date","volumePorod","runCreationDate","measurementCode","macromoleculeAcronym","bufferAcronym","I0","I0Stdev","acronym","averageFilePath","bufferAverageFilePath","bufferId","bufferOnedimensionalFiles","code","comments","composition","concentration","creationDate","creationTime","dataAcquisitionFilePath","dataCollectionId","discardedFrameNameList","dmax","experimentId","experimentType","exposureTemperature","extintionCoefficient","extraFlowTime","firstPointUsed","flow","frameListId","framesCount","framesMerge","gnomFilePath","gnomFilePathOutput","guinierFilePath","isagregated","kratkyFilePath","lastPointUsed","macromoleculeId","measurementId","mergeId","molecularMass","name","pH","priorityLevelId","proposalId","quality","rg","rgGnom","rgGuinier","rgStdev","runId","safetyLevelId","sampleAverageFilePath","sampleOneDimensionalFiles","samplePlatePositionId","scatteringFilePath","sequence","sessionId","sourceFilePath","specimenId","status","stockSolutionId","substractedFilePath","subtractionId","total","transmission","viscosity","volume","volumeToLoad","waitTime","reference","refined"]});
return Ext.create("Ext.data.Store",{model:"Queue",pageSize:this.pageSize,autoload:true,data:this.data,groupField:"date",groupDir:"DESC",sorters:[{property:"measurementId",direction:"DESC"}],proxy:{type:"pagingmemory"}});};QueueGrid.prototype.getBbar=function(){this.bbar=Ext.create("Ext.PagingToolbar",{dock:"bottom",store:this.store,pageSize:this.pageSize,displayInfo:true,displayMsg:"Displaying dataCollections {0} - {1} of {2}",emptyMsg:"No dataCollection to display"});
return this.bbar;this.bbar=Ext.create("Ext.toolbar.Toolbar",{dock:"bottom",items:[{cls:"x-btn-icon x-tbar-page-first"},{cls:"x-btn-icon x-tbar-page-prev"},{xtype:"textfield",id:this.id+"currentPage",width:40,cls:"x-btn-icon x-tbar-page-next"},{cls:"x-btn-icon x-tbar-page-next"},{cls:"x-btn-icon x-tbar-page-last"}]});
return this.bbar;};QueueGrid.prototype.getPanel=function(c){var d=this;this.data=d._prepareData(c);this.store=this.getStore();var b=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:Ext.create("Ext.XTemplate","<div style='background:#0ca3d2; color:white; float:left; margin:6px 8px 0 0; padding:5px 8px;'>{name:this.formatName}</div>",{formatName:function(e){return moment(e,"YYYYMMDD").format("MMM Do YY");
}}),hideGroupedHeader:true,startCollapsed:false});var a=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(g,f){d.selected=new Array();for(var e=0;e<f.length;e++){d.selected.push(f[e].raw);}}}});this.grid=Ext.create("Ext.grid.Panel",{title:this.title,collapsible:false,features:[b],resizable:true,selModel:a,autoscroll:true,store:this.store,border:1,height:this.height,width:this.width,columns:this.getColumns(),viewConfig:{enableTextSelection:true,preserveScrollOnRefresh:true,stripeRows:true,getRowClass:function(e,g,h,f){console.log(e.raw);
if(!e.raw.runCreationDate){return"gray-row";}if(e.raw.macromoleculeId!=null){return"purple-row";}},listeners:{"celldblclick":function(f,h,o,i,n,p,k,l){for(var q in f.getSelectionModel().selected.items){if(f.getSelectionModel().selected.items[q].data.macromoleculeId!=null){var m=(f.getSelectionModel().selected.items[q].raw.subtractionId);
if(m!=null){var g="/ispyb/user/viewProjectList.do?reqCode=display&menu=datacollection&subtractionId="+m;var j=window.open(g,"_blank");j.focus();}else{BUI.showWarning("No subtraction found for this measurement");}}else{d.openCurveVisualizerBySelected();}}},"cellclick":function(f,g,m,i,l,n,j,k){if(f.getGridColumns()[m].getId()==d.id+"buttonEditBuffer"){d._edit(i.data.bufferId);
}if(f.getGridColumns()[m].getId()==d.id+"buttonRemoveBuffer"){BUI.showBetaWarning();}if(f.getGridColumns()[m].getId()==d.id+"PorodColumn"){var h=new MacromoleculeWindow();h.draw(BIOSAXS.proposal.getMacromoleculeById(i.raw.macromoleculeId));h.onSuccess.attach(function(e){d.update();});}}}}});if(this.tbar){this.grid.addDocked(this.getTbar());
}if(this.bbar){this.grid.addDocked(this.getBbar());}return this.grid;};QueueGrid.prototype.getColumns=function(){var a=this;return[{header:"Exp. Id",name:"experimentId",dataIndex:"experimentId",hidden:true},{header:"Exp. Name",name:"name",dataIndex:"name",hidden:true},{header:"Measurmt. Id",name:"experimentId",dataIndex:"measurementId",hidden:true,renderer:function(c,d,b){return b.raw.measurementId;
}},{header:"date",name:"date",dataIndex:"date",renderer:function(c,d,b){return b.raw.date;}},{header:"Run",flex:0.2,name:"runNumber",dataIndex:"measurementCode",renderer:function(d,e,c){var b="";if(d!=null){b=b+"<span style='font-style:bold;font-weight:bold;'>"+d+"</span>";}if(c.raw.runCreationDate!=null){b=b+"<br/><span class='ispyb-text-gray'>"+moment(c.raw.runCreationDate).format("HH:mm:ss")+"</span>";
}else{b=b+"<br /><span class='ispyb-text-gray'>Scheduled</span>";}return b;}},{header:"priorityLevelId",name:"priorityLevelId",dataIndex:"priorityLevelId",hidden:true},{header:"Sample",dataIndex:"macromoleculeId",name:"macromoleculeAcronym",flex:0.5,renderer:function(f,g,c){var b="<table>";var d=BIOSAXS.proposal.getMacromoleculeById(c.raw.macromoleculeId);
if(d!=null){b=b+'<tr><td><span style="color:green;font-size:14;">'+d.acronym+"</span></td></tr>";b=b+"<tr><td>"+BUI.formatValuesUnits(c.raw.concentration,"mg/ml",10,this.decimals)+"</td></tr>";}if(c.raw.bufferId!=null){if(BIOSAXS.proposal.getBufferById(c.raw.bufferId)!=null){var e=BIOSAXS.proposal.getBufferById(c.raw.bufferId).acronym;
if((e=="")||(e==null)){e="No name";}b=b+'<tr><td><span style="color:blue;font-size:14;">'+e+"</span></td></tr><tr><td>";}}b=b+"<tr><td>"+BUI.formatValuesUnits(c.raw.exposureTemperature,"C",10,this.decimals)+"</td></tr>";return b+"</table>";}},{header:"Average",dataIndex:"macromoleculeId",name:"macromoleculeAcronym",flex:0.2,renderer:function(g,h,d){var c="<table>";
if(d.raw.runId!=null){if(d.raw.framesMerge!=null){var e="new SubtractionCurveVisualizer().refresh(["+d.raw.mergeId+"], [])";c=c+"<tr onmouseover='' style='color:blue;cursor: pointer;' onclick='"+e+"'><td >"+d.raw.framesMerge+" of "+d.raw.framesCount+"</td></tr>";}}if(d.raw.averages!=null){for(var b=1;
b<d.raw.averages.length;b++){if(d.raw.averages[b].framesMerge!=null){var e="new SubtractionCurveVisualizer().refresh(["+d.raw.averages[b].mergeId+"], [])";c=c+"<tr onmouseover='' style='color:gray;font-style: italic; cursor: pointer;'  onclick='"+e+"'><td >"+d.raw.averages[b].framesMerge+" of "+d.raw.averages[b].framesCount+"</td></tr>";
}}}return c+"</table>";}},{text:"Scattering",dataIndex:"subtractionId",width:66,name:"subtractionId",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=scattering&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";
}}}},{text:"Kratky.",dataIndex:"subtractionId",width:66,hidden:true,name:"subtractionId",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=kratky&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";
}}}},{text:"P(r).",hidden:true,width:66,dataIndex:"subtractionId",type:"string",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=gnom&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";
}}}},{text:"Guinier.",hidden:true,width:66,dataIndex:"subtractionId",type:"string",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=guinier&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">sdfsdfs</img>";
}}}},{text:"Guinier",name:"Guinier",columns:[{text:"Rg",dataIndex:"rg",name:"rg",width:80,tooltip:"In polymer physics, the radius of gyration is used to describe the dimensions of a polymer chain.",sortable:true,renderer:function(c,d,b){c=b.raw.rg;if(c!=null){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(Math.abs(c-b.raw.rgGnom)>(c*0.1)){return"<span style='color:orange;'>"+BUI.formatValuesUnits(c,"")+"</span>";
}return BUI.formatValuesUnits(c,"nm",12,this.decimals);}}}}},{text:"Points",dataIndex:"points",sortable:true,hidden:true,width:80,type:"string",renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if((b.raw.firstPointUsed=="")||(b.raw.firstPointUsed==null)){return;}return"<span>"+b.raw.firstPointUsed+" - "+b.raw.lastPointUsed+"<br/> ("+(b.raw.lastPointUsed-b.raw.firstPointUsed)+" )</span>";
}}}},{text:"I(0)",dataIndex:"I0",sortable:true,tooltip:"Extrapolated scattering intensity at zero angle I(0) (forward scattering)",width:80,type:"string",renderer:function(c,d,b){c=b.raw.I0;if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(c!=null){return BUI.formatValuesErrorUnitsScientificFormat(c,b.raw.I0Stdev,"");
}}}}},{text:"Quality",dataIndex:"quality",hidden:true,tooltip:"Estimated data quality. 1.0 - means ideal quality, 0.0 - unusable data. In table format it is given in percent (100% - ideal quality, 0% - unusable data). Please note that this estimation is based only on the Guinier interval (very low angles).",width:80,sortable:true,renderer:function(c,d,b){c=b.raw.quality;
if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(c!=null){if((c!=null)&&(c!="")){return"<span>"+(Number(c)).toFixed(2)+"</span><span style='font-size:8px;color:gray;'> %</span>";}}}}}},{text:"Aggregated",tooltip:"If aggregation was detected from the slope of the data curve at low angles the value is '1', otherwise '0'.",dataIndex:"isagregated",hidden:true,width:80,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if((b.raw.isagregated!=null)){if(c==true){return"Yes";
}else{return"No";}}}}}}]},{text:"Gnom",name:"Gnom",columns:[{text:"Rg",dataIndex:"rgGnom",type:"string",sortable:true,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(b.raw.rgGnom!=null){if(Math.abs(b.raw.rgGuinier-b.raw.rgGnom)>(b.raw.rgGuinier*0.1)){return"<span style='color:orange;'>"+BUI.formatValuesUnits(b.raw.rgGnom,"")+"</span>";
}return BUI.formatValuesUnits(b.raw.rgGnom,"nm");}}}}},{text:"Total",dataIndex:"total",sortable:true,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(b.raw.total!=null){return BUI.formatValuesUnits(b.raw.total,"");}}}}},{text:"D<sup>max</sup>",dataIndex:"dmax",sortable:true,renderer:function(c,d,b){if(b.raw.macromoleculeId!=null){if(b.raw.subtractionId!=null){if(b.raw.dmax!=null){return BUI.formatValuesUnits(b.raw.dmax,"")+"<span style='font-size:8px;color:gray;'> nm</span>";
}}}}},{text:"P(r)",sortable:true,hidden:true,dataIndex:"subtractionId",type:"string",renderer:function(e,f,d){if(d.raw.macromoleculeId!=null){if(d.raw.subtractionId!=null){var b=BUI.getURL()+"&type=gnom&subtractionId="+d.raw.subtractionId;var c="OnClick= window.open('"+b+"')";return"<img src="+b+'   height="60" width="60" '+c+">";
}}}}]},this._getPorod()];};function SpecimenSelectorResultGrid(){this.id=BUI.id();}SpecimenSelectorResultGrid.prototype._prepareData=function(d){var a=[];for(var c=0;c<d.length;c++){var e=d[c];for(var b=0;b<e.conditions.length;b++){a.push({bufferId:e.conditions[b].bufferId,macromoleculeId:e.macromoleculeId,macromoleculeAcronym:BIOSAXS.proposal.getMacromoleculeById(e.macromoleculeId).acronym,bufferAcronym:BIOSAXS.proposal.getBufferById(e.conditions[b].bufferId).acronym});
}}return a;};SpecimenSelectorResultGrid.prototype.refresh=function(a){this.store.loadData(this._prepareData(a));};SpecimenSelectorResultGrid.prototype.getPanel=function(a){var b=this;this.store=Ext.create("Ext.data.Store",{fields:["macromoleculeId","bufferId","macromoleculeAcronym","bufferAcronym","concentration"],data:this._prepareData(a),groupField:"macromoleculeAcronym"});
this.store.sort("concentration");this.grid=Ext.create("Ext.grid.Panel",{id:this.id,store:this.store,width:this.width,height:this.height,maxHeight:this.maxHeight,border:1,features:[{ftype:"grouping",groupHeaderTpl:"{name}",hideGroupedHeader:true,startCollapsed:false}],selModel:Ext.create("Ext.selection.CheckboxModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(e,d){b.selected=[];
for(var c=0;c<d.length;c++){b.selected.push(d[c].raw);}}}}),margin:10,sortableColumns:true,columns:[{text:"Macromolecule",dataIndex:"macromoleculeAcronym",flex:1},{text:"",dataIndex:"bufferId",width:20,hidden:false,renderer:function(d,e,c){return BUI.getRectangleColorDIV(BIOSAXS.proposal.bufferColors[d],10,10);
}},{text:"Buffer",dataIndex:"bufferAcronym",flex:1},{text:"Concentration",dataIndex:"concentration",flex:1,renderer:function(d,e,c){return d+" mg/ml";}}]});if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:this.getTbar()});}return this.grid;};SpecimenSelectorResultGrid.prototype.input=function(){return{data:new ResultsAssemblyGrid()._prepareData(new ResultsAssemblyGrid().input().data),proposal:new ResultsAssemblyGrid().input().proposal};
};SpecimenSelectorResultGrid.prototype.test=function(c){var b=new SpecimenSelectorResultGrid();BIOSAXS.proposal=new Proposal(b.input().proposal);var a=b.getPanel(b.input().data);a.render(c);};function ResultsAssemblyGrid(a){this.height=500;this.id=BUI.id();this.maxHeight=this.height;this.width=900;this.searchBar=false;
this.tbar=false;this.btnResultVisible=false;this.processed={};this.renderedPlotIndex=0;this.plotWidth=210;this.plotHeight=80;this.validColor=BUI.getValidColor();this.warningColor=BUI.getWarningColor();this.notValidColor=BUI.getErrorColor();this.guinierQuality=BUI.getQualityThreshold();this.framePercentageThreshold=BUI.getRadiationDamageThreshold();
if(a!=null){if(a.height!=null){this.height=a.height;this.maxHeight=this.height;}if(a.maxHeight!=null){this.maxHeight=a.maxHeight;}if(a.width!=null){this.width=a.width;}if(a.searchBar!=null){this.searchBar=a.searchBar;}if(a.tbar!=null){this.tbar=a.tbar;}if(a.btnResultVisible!=null){this.btnResultVisible=a.btnResultVisible;
}}this.onClick=new Event();}ResultsAssemblyGrid.prototype.edit=function(a){var c=this;var b=new MacromoleculeWindow();b.onSuccess.attach(function(e,d){c.store.loadData(c._prepareData(BIOSAXS.proposal.getMacromolecules()));});b.draw(BIOSAXS.proposal.getMacromoleculeById(a));};ResultsAssemblyGrid.prototype.getTbar=function(){var b=this;
var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add Macromolecule",disabled:false,handler:function(e,d){var c=new MacromoleculeWindow();c.onSuccess.attach(function(f){b.refresh();});c.draw({});}}));a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Define an Assembly",disabled:false,handler:function(d,c){var e=new CreateAssemblyWindow();
e.onSaved.attach(function(g,h){if(h.macromoleculeIds.length>0){var f=new BiosaxsDataAdapter();f.onSuccess.attach(function(j,i){b.refresh();});f.saveAssembly(h.assemblyId,h.macromoleculeIds);}});e.draw(b.experiment);}}));return a;};ResultsAssemblyGrid.prototype.refresh=function(){this.store.loadData(this._prepareData());
};ResultsAssemblyGrid.prototype.addCondition=function(a,e,c){function f(g){return{concentration:g.conc,quality:g.quality,bufferBeforeFramesMerged:g.bufferBeforeFramesMerged,bufferAfterFramesMerged:g.bufferAfterFramesMerged,framesCount:g.framesCount,framesMerge:g.framesMerge};}if(e[c].conditions!=null){var d=false;
for(var b in e[c].conditions){condition=e[c].conditions[b];if((condition.macromoleculeId==a.macromoleculeId)&&(condition.bufferId==a.bufferId)){e[c].conditions[b].concentrations.push(f(a));d=true;}}if(!d){e[c].conditions.push({macromoleculeId:a.macromoleculeId,bufferId:a.bufferId,concentrations:[f(a)]});
}}};ResultsAssemblyGrid.prototype.process=function(a,c){if(this.processed[a.macromoleculeId]==null){this.processed[a.macromoleculeId]=true;a.measurementCount=1;a.subtractionCount=1;a.averageCount=1;a.conditions=[];c.push(a);}for(var b=0;b<c.length;b++){if(c[b].macromoleculeId==a.macromoleculeId){c[b].measurementCount=c[b].measurementCount+1;
if(a.subtractionId!=null){c[b].subtractionCount=c[b].subtractionCount+1;this.addCondition(a,c,b);}if(a.framesMerge!=null){c[b].averageCount=c[b].averageCount+1;}if(a.timeStart!=null){if(c[b].timeStart!=null){if(moment(c[b].timeStart).format("X")>moment(a.timeStart).format("X")){c[b].timeStart=a.timeStart;
}}}}}return c;};ResultsAssemblyGrid.prototype._prepareData=function(c){var b=[];for(var a=0;a<c.length;a++){b=this.process(c[a],b);}this.data=b;return b;};ResultsAssemblyGrid.prototype.parseConcentrations=function(f,e,c,g){var e=[];var c={};var g=[];for(var b=0;b<f.length;b++){var d=Number(f[b].concentration).toFixed(1);
var g=Number(f[b].quality).toFixed(2);if(c[d]==null){c[d]=0;e.push({concentration:d,quality:[g],frames:[{bufferAfterFramesMerged:f[b].bufferAfterFramesMerged,bufferBeforeFramesMerged:f[b].bufferBeforeFramesMerged,framesMerge:f[b].framesMerge,framesCount:f[b].framesCount}]});}else{for(var a=0;a<e.length;
a++){if(e[a].concentration==d){e[a].quality.push(g);e[a].frames.push({bufferAfterFramesMerged:f[b].bufferAfterFramesMerged,bufferBeforeFramesMerged:f[b].bufferBeforeFramesMerged,framesMerge:f[b].framesMerge,framesCount:f[b].framesCount});}}}c[d]=c[d]+1;}e.sort(function(i,h){return i.concentration-h.concentration;
});return{concentrations:e,differentConcentration:c};};ResultsAssemblyGrid.prototype.getConditionWarnings=function(c){var b=0;for(var a=0;a<c.frames.length;a++){if(c.quality[a]==null){b=b+1;continue;}else{if(Number(c.quality[a])<this.guinierQuality){b=b+1;continue;}}if(c.frames[a].bufferBeforeFramesMerged/c.frames[a].framesCount<this.framePercentageThreshold||c.frames[a].framesMerged/c.frames[a].framesCount<this.framePercentageThreshold||c.frames[a].bufferAfterFramesMerged/c.frames[a].framesCount<this.framePercentageThreshold){b=b+1;
continue;}}return{withWarnings:b,withoutWarnings:c.frames.length-b};};ResultsAssemblyGrid.prototype.getFrameHTMLTable=function(a){var b="";if(a.withWarnings>0){b=b+"<div style='cursor: pointer;'><span style='font-size:9px;padding-left:5px;'>"+a.withWarnings+"x </span> <img height='15px' src='../images/warning_01.png'> </div>";
}if(a.withoutWarnings>0){b=b+"<div style='cursor: pointer;'><span style='font-size:9px;padding-left:5px;'>"+a.withoutWarnings+"x </span> <img height='15px' src='../images/accept.png'> </div>";}return b;};ResultsAssemblyGrid.prototype.createConcentrationRow=function(d,c,a){var b="<tr><td>";if(d>1){b=b+"<span style='font-size:9px;'>"+d+"x </span>"+BUI.formatConcentration(c.concentration);
}else{b=b+BUI.formatConcentration(c.concentration);}b=b+"</td><td>";b=b+this.getFrameHTMLTable(a);+"</td>";b=b+"</tr>";return b;};ResultsAssemblyGrid.prototype.getConditionHTMLTable=function(t,q,c){var d=2;var j="<div><table class='conditions'><tr>";var a=0;for(var k=0;k<t.length;k++){if(a==d){a=0;j=j+"<tr>";
}j=j+"<td>";var l=t[k];var f=(BIOSAXS.proposal.getBufferById(l.bufferId).acronym);var h=(this.parseConcentrations(l.concentrations));var g=h.concentrations;var e=h.differentConcentration;var b=[];var s=0;var p=0;for(var o=0;o<g.length;o++){p=p+g[o].frames.length;var n=this.getConditionWarnings(g[o]);
b.push(n);if(n.withoutWarnings>0){s=s+1;}}this.validColor="#E0F8E0";this.warningColor="#F5DA81";this.notValidColor="#F6CED8";var m=this.warningColor;if(s>2){m=this.validColor;}if(p<3){m=this.notValidColor;}j=j+"<table class='condition''>";j=j+"<tr style='background-color:"+m+";'><th  ><a style='color:blue;' href='"+BUI.getMacromoleculeBufferResultsURL(c.raw.macromoleculeId,t[k].bufferId)+"'>"+f.toUpperCase()+"</a></th></tr>";
for(var o=0;o<g.length;o++){j=j+this.createConcentrationRow(e[g[o].concentration],g[o],b[o]);}j=j+"</td></tr>";j=j+"</table>";j=j+"</td>";a=a+1;}j=j+"</tr></table></div>";return j;};ResultsAssemblyGrid.prototype._getTbar=function(){function a(c){window.location=c;}var b=this;return[{icon:"../images/application_view_list.png",text:"Multiple Select",handler:function(){var c=new SpecimenSelectorResultGrid();
var d=Ext.create("Ext.window.Window",{title:"Multiple select",height:600,width:600,layout:"fit",items:[c.getPanel(b.data)],buttons:[{text:"Go",handler:function(){var g=[];for(var e=0;e<c.selected.length;e++){var f=c.selected[e];g.push({macromoleculeId:f.macromoleculeId,bufferId:f.bufferId});}a(BUI.getMacromoleculeResultsURLByMultipleSearch(g));
}},{text:"Cancel",handler:function(){d.close();}}]}).show();}}];};ResultsAssemblyGrid.prototype.getLegendPanel=function(){return{html:"<table><tr><td>"+BUI.getRectangleColorDIV(this.validColor,10,10)+'</td><td style="padding-left:5px;">Good quality measurements</td><td style="padding-left:20px;">'+BUI.getRectangleColorDIV(this.warningColor,10,10)+'</td><td style="padding-left:5px;">Probably valid with manual processing</td><td style="padding-left:20px;">'+BUI.getRectangleColorDIV(this.notValidColor,10,10)+'</td><td style="padding-left:5px;">More measurements need to be done</td></tr></table>'};
};ResultsAssemblyGrid.prototype.getPanel=function(a){var b=this;this.store=Ext.create("Ext.data.Store",{fields:["macromoleculeId","macromoleculeAcronym","measurementCount","subtractionCount","averageCount","timeStart","concentrationArray","bufferConditions","conditions"],data:this._prepareData(a)});this.store.sort("macromoleculeAcronym");
this.grid=Ext.create("Ext.grid.Panel",{id:this.id,title:"Macromolecules",store:this.store,tbar:this._getTbar(),bbar:[this.getLegendPanel()],width:this.width,height:this.height,maxHeight:this.maxHeight,sortableColumns:true,columns:[{text:"",dataIndex:"macromoleculeId",width:20,hidden:false,renderer:function(d,e,c){return BUI.getRectangleColorDIV(BIOSAXS.proposal.macromoleculeColors[d],10,10);
}},{text:"Macromolecule",dataIndex:"macromoleculeAcronym",width:200},{text:"Buffer Conditions",dataIndex:"conditions",flex:1,renderer:function(e,d,c){return b.getConditionHTMLTable(e,d,c);}},{header:"Average",dataIndex:"percentageCollected",name:"percentageCollected",type:"string",hidden:true,renderer:function(d,e,c){return"<table><tr><td>"+BUI.getProgessBar((c.raw.averageCount/c.raw.measurementCount)*100,c.raw.averageCount+"/"+c.raw.measurementCount)+"</td></table>";
},width:100,sorter:false},{header:"Subtractions",dataIndex:"percentageCollected",name:"percentageCollected",type:"string",hidden:true,renderer:function(d,e,c){return"<table><tr><td>"+BUI.getProgessBar((c.raw.subtractionCount/c.raw.measurementCount)*100,c.raw.subtractionCount+"/"+c.raw.measurementCount)+"</td></table>";
},width:100},{header:"Date",dataIndex:"timeStart",name:"timeStart",type:"string",renderer:function(g,d,c,h,f,e){if(c.raw.timeStart!=null){return moment(c.raw.timeStart).format("MMM Do YY");}}},{header:"Download",dataIndex:"percentageCollected",name:"percentageCollected",type:"string",renderer:function(d,e,c){return BUI.getZipHTMLByMacromoleculeId(c.raw.macromoleculeId);
},width:100},{id:"btnResultVisible",width:85,sortable:false,renderer:function(g,d,c,h,f,e){return BUI.getGreenButton("GO");}}],viewConfig:{stripeRows:true,listeners:{afterrender:function(g,k,d,c,h,j,i,f){},celldblclick:function(g,k,d,c,h,j,i,f){b.edit(c.data.macromoleculeId);},cellclick:function(g,k,d,c,h,j,i,f){if(g.getGridColumns()[d].getId()=="buttonEditMacromolecule"){b.edit(c.data.macromoleculeId);
}if(g.getGridColumns()[d].getId()=="buttonRemoveMacromolecule"){BUI.showBetaWarning();}if(g.getGridColumns()[d].getId()=="btnResultVisible"){window.location=BUI.getMacromoleculeResultsURL(c.data.macromoleculeId);}}}}});if(this.tbar){this.grid.addDocked({xtype:"toolbar",items:this.getTbar()});}return this.grid;
};ResultsAssemblyGrid.prototype.input=function(a){return{data:DATADOC.getData_3367(),proposal:DATADOC.getProposal_3367()};};ResultsAssemblyGrid.prototype.test=function(b){var c=new ResultsAssemblyGrid({height:600,searchBar:false,tbar:false,btnResultVisible:true,width:1000});BIOSAXS.proposal=new Proposal(c.input().proposal);
var a=c.getPanel(c.input().data);a.render(b);};function ShipmentGrid(a){this.id=BUI.id();this.height=100;this.width=null;this.minHeight=null;this.btnEditVisible=true;if(a!=null){if(a.height!=null){this.height=a.height;}if(a.width!=null){this.width=a.width;}if(a.minHeight!=null){this.minHeight=a.minHeight;
}if(a.btnEditVisible!=null){this.btnEditVisible=a.btnEditVisible;}}}ShipmentGrid.prototype._getColumns=function(){var b=this;var a=[{text:"Name",dataIndex:"shippingName",flex:1},{header:"Type",dataIndex:"shippingType",flex:1,hidden:true,renderer:function(e,d,c){if(e!=null){return e.toUpperCase();}}},{header:"Status",type:"string",flex:1,hidden:false,renderer:function(d,e,c){if(c.raw.shippingStatus!=null){if(new String(c.raw.shippingStatus).toUpperCase()=="OPENED"){return"<span style='color:green;font-weight:bold;'>"+new String(c.raw.shippingStatus).toUpperCase()+"</span>";
}return"<span style='font-weight:bold;'>"+new String(c.raw.shippingStatus).toUpperCase()+"</span>";}}},{text:"Cases",flex:1,hidden:false,renderer:function(e,g,d){var f=BIOSAXS.proposal.getShipmentById(d.data.shippingId);var c="<table><tr>";if(f.dewarVOs.length>0){c=c+"<td><span style='font-size:18px'>"+f.dewarVOs.length+"</span>x <img src='../images/box-icon-very-small.png'></td>";
}else{return"<span style='font-size:10px;'>Empty</span>";}return c+"</tr></table>";}},{header:"Comments",dataIndex:"comments",flex:1,hidden:false},{header:"Creation Date",dataIndex:"creationDate",hidden:true}];if(this.btnEditVisible){a.push({id:b.id+"buttonEdit",text:"",hidden:!b.btnEditVisible,width:100,sortable:false,renderer:function(g,d,c,h,f,e){return BUI.getGreenButton("EDIT");
}});}a.push({id:b.id+"buttonRemove",text:"",width:100,sortable:false,renderer:function(h,d,c,i,f,e){var g=BIOSAXS.proposal.getShipmentById(c.data.shippingId);if(g.dewarVOs.length==0){return BUI.getRedButton("REMOVE");}}});return a;};ShipmentGrid.prototype._getTopButtons=function(){var b=this;var a=[];
a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add Shipment",handler:function(f,e){var g=this;var c=new ShipmentForm({creationMode:true,showTitle:false});c.onSaved.attach(function(i,h){g.showShipmentTabs(h,targetId);});var d=Ext.create("Ext.window.Window",{title:"New Shipment",height:600,width:800,layout:"fit",items:[c.getPanel()]}).show();
}}));return a;};ShipmentGrid.prototype.refresh=function(a){this.features=a;this.store.loadData(this._prepareData(),false);};ShipmentGrid.prototype._prepareData=function(){var b=[];for(var a=0;a<this.features.length;a++){b.push(this.features[a]);}return b;};ShipmentGrid.prototype.getPanel=function(a){this.features=a;
return this._renderGrid();};ShipmentGrid.prototype.edit=function(a){window.location=BUI.getShippingURL(a);};ShipmentGrid.prototype._getStoreFields=function(a){var b=this;return[{name:"shippingId"},{name:"shippingName"},{name:"shippingStatus"},{name:"shippingType"},{name:"creationDate"},{name:"comments"}];
};ShipmentGrid.prototype._renderGrid=function(){var c=this;var a=this._prepareData();this.store=Ext.create("Ext.data.Store",{fields:this._getStoreFields(a),autoload:true,data:a});this.store.loadData(a,false);this.grid=Ext.create("Ext.grid.Panel",{title:"Shipping",icon:"/ispyb/images/plane.gif",width:this.width,minWidth:this.minWidth,height:this.height,store:this.store,columns:this._getColumns(),viewConfig:{stripeRows:true,listeners:{itemdblclick:function(f,d,g,h){c.edit(d.raw.shippingId);
},cellclick:function(d,f,l,h,k,m,i,j){if(d.getGridColumns()[l].getId()==c.id+"buttonEdit"){c.edit(h.data.shippingId);}if(d.getGridColumns()[l].getId()==c.id+"buttonRemove"){var g=BIOSAXS.proposal.getShipmentById(h.data.shippingId);if(g.dewarVOs.length==0){var n=new BiosaxsDataAdapter();c.grid.setLoading("ISPyB: Removing shipment");
n.onSuccess.attach(function(e){BIOSAXS.proposal.onInitialized.attach(function(o){c.refresh(BIOSAXS.proposal.getShipments());c.grid.setLoading(false);});BIOSAXS.proposal.init();});n.onError.attach(function(e){alert("Error");c.grid.setLoading(false);});n.removeShipment(h.data.shippingId);}}}}},selModel:{mode:"SINGLE"}});
var b=c._getTopButtons();this.grid.addDocked({xtype:"toolbar",items:b});this.grid.getSelectionModel().on({selectionchange:function(f,e){if(e.length){for(var d=0;d<b.length;d++){if(b[d].enable){b[d].enable();}}}else{for(var d=0;d<b.length;d++){if(b[d].alwaysEnabled==false){if(b[d].disable){b[d].disable();
}}}}}});return this.grid;};ShipmentGrid.prototype.input=function(){return{proposal:new MeasurementGrid().input().proposal,shippings:DATADOC.getShippings_10()};};ShipmentGrid.prototype.test=function(c){var b=new ShipmentGrid({minHeight:300,height:440});BIOSAXS.proposal=new Proposal(b.input().proposal);
var a=b.getPanel(c);a.render(c);b.refresh(b.input().shippings);};function SpecimenGrid(a){this.id=BUI.id();this.height=500;this.maxHeight=this.height;this.unitsFontSize=9;this.editEnabled=false;this.margin="0 5 0 5";this.isPositionColumnHidden=false;this.removeBtnEnabled=false;this.selectionMode="MULTI";
this.updateRowEnabled=false;this.grouped=true;this.width=900;this.title="Specimens";if(a!=null){if(a.height!=null){this.height=a.height;}if(a.showTitle==false){this.title=null;}if(a.grouped==false){this.grouped=null;}if(a.width!=null){this.width=a.width;}if(a.minHeight!=null){this.minHeight=a.minHeight;
}if(a.maxHeight!=null){this.maxHeight=a.maxHeight;}if(a.editEnabled!=null){this.editEnabled=a.editEnabled;}if(a.removeBtnEnabled!=null){this.removeBtnEnabled=a.removeBtnEnabled;}if(a.margin!=null){this.margin=a.margin;}if(a.isPositionColumnHidden!=null){this.isPositionColumnHidden=a.isPositionColumnHidden;
}if(a.selectionMode!=null){this.selectionMode=a.selectionMode;}if(a.updateRowEnabled!=null){this.updateRowEnabled=a.updateRowEnabled;}}this.onClick=new Event(this);this.onSelected=new Event(this);this.onRemoved=new Event(this);this.onSpecimenChanged=new Event();}SpecimenGrid.prototype._prepareData=function(a){var f=[];
var b=a.getSamples();for(var c=0;c<b.length;c++){var d=b[c];if(d.macromolecule3VO!=null){d.macromolecule=d.macromolecule3VO.acronym;d.exposureTemperature=[];d.macromoleculeId=d.macromolecule3VO.macromoleculeId;}if(d.sampleplateposition3VO!=null){if(d.sampleplateposition3VO.samplePlateId!=null){d.samplePlateId=d.sampleplateposition3VO.samplePlateId;
d.rowNumber=d.sampleplateposition3VO.rowNumber;d.columnNumber=d.sampleplateposition3VO.columnNumber;if(a.getSamplePlateById(d.sampleplateposition3VO.samplePlateId).plategroup3VO!=null){d.plateGroupName=a.getSamplePlateById(d.sampleplateposition3VO.samplePlateId).plategroup3VO.name;d.samplePlateName=a.getSamplePlateById(d.sampleplateposition3VO.samplePlateId).name+"  ["+d.plateGroupName+"]";
d.slotPositionColumn=a.getSamplePlateById(d.sampleplateposition3VO.samplePlateId).slotPositionColumn;}}}else{d.samplePlateName="Unallocated Specimens";}d.groupIndex=d.bufferId+d.macromoleculeId;var e=BIOSAXS.proposal.getMacromoleculeById(d.macromoleculeId);d.acronym="Buffers";if(e!=null){d.acronym=BIOSAXS.proposal.getMacromoleculeById(d.macromoleculeId).acronym;
}d.buffer=a.getBufferById(d.bufferId);d.volumeToLoad=a.getVolumeToLoadBySampleId(d.sampleId);f.push(d);}return f;};SpecimenGrid.prototype.getStore=function(){return this.store;};SpecimenGrid.prototype.deselectAll=function(){this.grid.getSelectionModel().deselectAll();};SpecimenGrid.prototype.selectById=function(a){this.grid.getSelectionModel().deselectAll();
for(var b=0;b<this.grid.getStore().data.items.length;b++){var c=this.grid.getStore().data.items[b].raw;if(c.specimenId==a){this.grid.getSelectionModel().select(b);}}};SpecimenGrid.prototype.getPlugins=function(){var b=this;var a=[];if(this.updateRowEnabled){a.push(Ext.create("Ext.grid.plugin.RowEditing",{clicksToEdit:1,listeners:{validateedit:function(c,l){var d=[];
if(l.newValues.bufferId!=l.record.raw.bufferId){var n=[];if(l.record.raw.macromoleculeId==null){n=n.concat(b.experiment.getDataCollectionsBySpecimenId(l.record.raw.specimenId));}else{var q=b.experiment.getDataCollectionsBySpecimenId(l.record.raw.specimenId);for(var h=0;h<q.length;h++){var r=q[h];if(r!=null){for(var g=0;
g<r.measurementtodatacollection3VOs.length;g++){var k=r.measurementtodatacollection3VOs[g];if(k.dataCollectionOrder==1){n=n.concat(b.experiment.getDataCollectionsBySpecimenId(b.experiment.getMeasurementById(k.measurementId).specimenId));}}}}}var h=null;for(h=0;h<n.length;h++){var o=n[h];var u=b.experiment.getSpecimenByDataCollectionId(o.dataCollectionId);
d=d.concat(u);}for(h=0;h<d.length;h++){var f=d[h];var t=b.experiment.getSpecimenById(f.specimenId);t.bufferId=l.newValues.bufferId;new BiosaxsDataAdapter().saveSpecimen(t,b.experiment);}}l.record.raw.concentration=l.newValues.concentration;l.record.raw.volume=l.newValues.volume;if(l.record.raw.sampleplateposition3VO!=null){var m=b.experiment.getSamplePlateBySlotPositionColumn(l.newValues.slotPositionColumn);
if(m!=null){l.record.raw.sampleplateposition3VO={columnNumber:l.newValues.columnNumber,rowNumber:l.newValues.rowNumber,samplePlateId:m.samplePlateId};}}else{if(l.newValues.slotPositionColumn!=null){var m=b.experiment.getSamplePlateBySlotPositionColumn(l.newValues.slotPositionColumn);if(m!=null){l.record.raw.sampleplateposition3VO={columnNumber:l.newValues.columnNumber,rowNumber:l.newValues.rowNumber,samplePlateId:m.samplePlateId};
}}}var s=l.record.data.macromoleculeId;var p=new BiosaxsDataAdapter();p.onSuccess.attach(function(e,i){if(s!=null){i.macromolecule3VO=BIOSAXS.proposal.getMacromoleculeById(s);}b.onSpecimenChanged.notify(i);b.grid.setLoading(false);});p.onError.attach(function(){alert("Error");b.grid.setLoading(false);
});b.grid.setLoading();p.saveSpecimen(l.record.raw,b.experiment);}}}));}return a;};SpecimenGrid.prototype._getRowCombo=function(){var b=[];for(var a=1;a<=8;a++){b.push({rowNumber:a,name:BUI.getSamplePlateLetters()[a-1]});}var c=Ext.create("Ext.data.Store",{fields:["rowNumber","name"],data:b});return Ext.create("Ext.form.ComboBox",{store:c,queryMode:"local",displayField:"name",valueField:"rowNumber"});
};SpecimenGrid.prototype._getColumnCombo=function(){var b=[];for(var a=1;a<=12;a++){b.push({columnNumber:a});}var c=Ext.create("Ext.data.Store",{fields:["columnNumber"],data:b});return Ext.create("Ext.form.ComboBox",{store:c,queryMode:"local",displayField:"columnNumber",valueField:"columnNumber"});};
SpecimenGrid.prototype._getSlotColumBombo=function(){var b=this.experiment.getSamplePlates().length;var c=[];for(var a=1;a<=b;a++){c.push({slotPositionColumn:a});}var d=Ext.create("Ext.data.Store",{fields:["slotPositionColumn"],data:c});return Ext.create("Ext.form.ComboBox",{store:d,queryMode:"local",displayField:"slotPositionColumn",valueField:"slotPositionColumn"});
};SpecimenGrid.prototype.getPanelByExperiment=function(a){this.experiment=a;var b=this._prepareData(a);return this.getPanel(b);};SpecimenGrid.prototype.refresh=function(a){this.experiment=a;var b=this._prepareData(a);this.store.loadData(b);};SpecimenGrid.prototype.getPanel=function(c){var d=this;this.store=Ext.create("Ext.data.Store",{fields:["buffer","bufferId","code","macromolecule","acronym","macromoleculeId","concentration","volume","samplePlateId","slotPositionColumn","rowNumber","columnNumber","groupIndex"],data:c,groupField:"acronym"});
this.store.sort([{property:"concentration",direction:"ASC"},{property:"buffer",direction:"ASC"}]);var a=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:this.selectionMode,listeners:{selectionchange:function(h,g){var f=[];for(var e=0;e<g.length;e++){f.push(g[e].raw);}d.onSelected.notify(f);
}}});var b=[];if(this.grouped){b.push({ftype:"grouping",groupHeaderTpl:"{name}",hideGroupedHeader:false,startCollapsed:false,id:"myGroupedStore"});}this.grid=Ext.create("Ext.grid.Panel",{title:this.title,height:this.height,width:this.width,selModel:a,minHeight:this.minHeight,maxHeight:this.maxHeight,store:this.store,features:b,margin:this.margin,plugins:this.getPlugins(),columns:[{text:"",dataIndex:"macromolecule",width:20,renderer:function(g,h,f){var e=null;
if(f.raw.macromolecule3VO!=null){e=f.raw.macromolecule3VO.macromoleculeId;}else{e=f.raw.macromoleculeId;}if(e==null){return;}return BUI.getRectangleColorDIV(d.experiment.macromoleculeColors[e],10,10);}},{text:"Macromolecule",dataIndex:"macromolecule",width:100},{text:"",dataIndex:"buffer",width:20,renderer:function(g,h,f){var e="black";
if(f.raw.bufferId!=null){if(d.experiment.getDataCollectionsBySpecimenId(f.raw.specimenId)[0]!=null){e=d.experiment.getSpecimenColorByBufferId(d.experiment.getMeasurementById(d.experiment.getDataCollectionsBySpecimenId(f.raw.specimenId)[0].measurementtodatacollection3VOs[0].measurementId).specimenId);
}return BUI.getRectangleColorDIV(e,10,10);}}},{text:"Buffer",dataIndex:"bufferId",width:140,renderer:function(f,g,e){if(e.raw.bufferId!=null){return BIOSAXS.proposal.getBufferById(f).acronym;}},editor:BIOSAXS_COMBOMANAGER.getComboBuffers(BIOSAXS.proposal.getBuffers(),{noLabel:true,width:300})},{text:"Conc.",dataIndex:"concentration",width:100,editor:{allowBlank:false},renderer:function(g,f,e){if(isNaN(g)){f.tdCls="yellow-cell";
return g;}else{if(g!=0){return BUI.formatValuesUnits(g,"mg/ml",{fontSize:16,decimals:3,unitsFontSize:this.unitsFontSize});}else{return;}}}},{text:"Vol. Well",dataIndex:"volume",width:70,editor:{allowBlank:true},renderer:function(f,g,e){return BUI.formatValuesUnits(e.data.volume,"&#181l",{fontSize:12,decimals:2,unitsFontSize:this.unitsFontSize});
}},{text:"Position",hidden:true,flex:1,renderer:function(f,g,e){return BUI.getSamplePositionHTML(e.raw,d.experiment);}},{text:"samplePlateId",dataIndex:"samplePlateId",hidden:true},{text:"Plate",hidden:this.isPositionColumnHidden,dataIndex:"slotPositionColumn",editor:d._getSlotColumBombo(),flex:1,renderer:function(g,f,e){if((g!=null)&(g!="")){return g;
}else{f.tdCls="yellow-cell";}}},{text:"Row",hidden:this.isPositionColumnHidden,dataIndex:"rowNumber",editor:this._getRowCombo(),flex:1,renderer:function(g,f,e){if((g!=null)&&(g!="")){return BUI.getSamplePlateLetters()[g-1];}else{f.tdCls="yellow-cell";}}},{text:"Well",hidden:this.isPositionColumnHidden,dataIndex:"columnNumber",editor:this._getColumnCombo(),flex:1,renderer:function(g,f,e){if((g!=null)&&(g!="")){return g;
}else{f.tdCls="yellow-cell";}}},{id:d.id+"buttonEditSample",text:"Edit",width:80,sortable:false,hidden:!d.editEnabled,renderer:function(i,f,e,j,h,g){if(d.editEnabled){return BUI.getGreenButton("EDIT");}}},{id:d.id+"buttonRemoveSample",text:"",hidden:!d.removeBtnEnabled,width:100,sortable:false,renderer:function(i,f,e,j,h,g){if(d.removeBtnEnabled){return BUI.getRedButton("REMOVE");
}}}],viewConfig:{preserveScrollOnRefresh:true,stripeRows:true,getRowClass:function(e){var f=d.experiment.getSampleByPosition(e.data.samplePlateId,e.data.rowNumber,e.data.columnNumber);if(f.length>1){return"red-row";}},listeners:{selectionchange:function(e,f){d.onClick.notify(record.raw);},cellclick:function(g,i,f,e,h){if(g.getGridColumns()[f].getId()==d.id+"buttonEditSample"){}if(g.getGridColumns()[f].getId()==d.id+"buttonRemoveSample"){g.getStore().removeAt(rowIndex);
d.onRemoved.notify();}}}}});return this.grid;};SpecimenGrid.prototype.input=function(){return{experiment:DATADOC.getExperiment_10(),proposal:DATADOC.getProposal_10()};};SpecimenGrid.prototype.test=function(c){var d=new SpecimenGrid({height:400,maxHeight:400,width:1000});BIOSAXS.proposal=new Proposal(d.input().proposal);
var b=new Experiment(d.input().experiment);var a=d.getPanelByExperiment(b);a.render(c);};function StockSolutionGrid(a){this.id=BUI.id();this.height=100;this.width=null;this.minHeight=null;this.tbar=true;this.title="Stock Solutions";this.btnEditVisible=true;this.btnRemoveVisible=true;this.btnAddVisible=true;
this.btnAddExisting=false;this.isPackedVisible=true;this.btnUnpackVisible=false;this.multiselect=false;this.selectedStockSolutions=[];if(a!=null){if(a.btnUnpackVisible!=null){this.btnUnpackVisible=a.btnUnpackVisible;}if(a.multiselect!=null){this.multiselect=a.multiselect;}if(a.height!=null){this.height=a.height;
}if(a.btnEditVisible!=null){this.btnEditVisible=a.btnEditVisible;}if(a.btnAddVisible!=null){this.btnAddVisible=a.btnAddVisible;}if(a.btnAddExisting!=null){this.btnAddExisting=a.btnAddExisting;}if(a.width!=null){this.width=a.width;}if(a.minHeight!=null){this.minHeight=a.minHeight;}if(a.tbar!=null){this.tbar=a.tbar;
}if(a.btnRemoveVisible!=null){this.btnRemoveVisible=a.btnRemoveVisible;}if(a.isPackedVisible!=null){this.isPackedVisible=a.isPackedVisible;}if(a.showTitle!=null){this.showTitle=a.showTitle;if(this.showTitle==false){this.title=null;}}}this.onProposalChanged=new Event(this);this.onStockSolutionSelected=new Event(this);
}StockSolutionGrid.prototype._getColumns=function(){var b=this;var a=[{header:"Macromolecule",dataIndex:"macromolecule",id:b.id+"macromolecule",type:"string",renderer:function(c,e,d){return'<span style="color:blue;">'+c+"</span>";},hidden:false,flex:1},{header:"Buffer",dataIndex:"buffer",name:"buffer",hidden:false,renderer:function(c,e,d){return'<span style="color:green;">'+c+"</span>";
},type:"string",flex:1},{header:"Acronym",dataIndex:"name",name:"name",type:"string",flex:1,hidden:true},{header:"Storage Temp.",dataIndex:"storageTemperature",name:"storageTemperature",type:"string",flex:1,hidden:false,renderer:function(c){return BUI.formatValuesUnits(c,"C",{fontSize:12,decimals:2,unitsFontSize:10});
}},{header:"Volume",dataIndex:"volume",type:"string",flex:1,hidden:false,renderer:function(c){return BUI.formatValuesUnits(c,"&#181l",{fontSize:12,decimals:2,unitsFontSize:10});}},{header:"Concentration",dataIndex:"concentration",name:"concentration",type:"string",flex:1,renderer:function(c){return BUI.formatValuesUnits(c,"mg/ml",{fontSize:12,decimals:2,unitsFontSize:10});
}},{header:"Packed",dataIndex:"comments",id:b.id+"box",type:"string",width:50,hidden:!this.isPackedVisible,renderer:function(e,d,c){if(c.raw.boxId!=null){return"<div style='cursor: pointer;'><img height='15px' src='../images/plane.gif'></div>";}}},{header:"Comments",dataIndex:"comments",type:"string",flex:1}];
if(this.btnEditVisible){a.push({id:b.id+"buttonEdit",width:85,sortable:false,renderer:function(g,d,c,h,f,e){if(b.btnEditVisible){return BUI.getGreenButton("EDIT");}}});}if(this.btnRemoveVisible){a.push({id:b.id+"buttonRemove",width:85,sortable:false,renderer:function(g,d,c,h,f,e){if(b.btnRemoveVisible){return BUI.getRedButton("REMOVE");
}}});}if(this.btnUnpackVisible){a.push({id:b.id+"buttonUnpack",width:85,sortable:false,renderer:function(g,d,c,h,f,e){if(b.btnUnpackVisible){return BUI.getBlueButton("UNPACK");}}});}return a;};StockSolutionGrid.prototype._getTopButtons=function(){var b=this;var a=[];if(this.btnAddVisible){a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add Stock Solution",tooltip:"Will create a new stock solution",disabled:false,alwaysEnabled:true,handler:function(d,c){b.edit();
}}));}if(this.btnAddExisting){a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add Existing",tooltip:"Allows to select upacked stock solutions",disabled:false,alwaysEnabled:true,handler:function(e,d){var f=new StockSolutionGrid({btnAddVisible:false,btnEditVisible:false,btnRemoveVisible:false,btnAddExisting:false,isPackedVisible:true,multiselect:true});
var c=Ext.create("Ext.window.Window",{title:"Select",height:400,width:800,layout:"fit",items:[f.getPanel()],buttons:[{text:"Pack",handler:function(){b.onStockSolutionSelected.notify(f.selectedStockSolutions);c.close();}},{text:"Cancel",handler:function(){c.close();}}]}).show();f.refresh(BIOSAXS.proposal.getUnpackedStockSolutions());
}}));}return a;};StockSolutionGrid.prototype.refresh=function(a){this.features=a;this.store.loadData(this._prepareData(),false);};StockSolutionGrid.prototype._prepareData=function(){var c=[];for(var b=0;b<this.features.length;b++){var a=this.features[b];a.buffer=BIOSAXS.proposal.getBufferById(a.bufferId).acronym;
if(a.macromoleculeId!=null){a.macromolecule=BIOSAXS.proposal.getMacromoleculeById(a.macromoleculeId).acronym;}c.push(a);}return c;};StockSolutionGrid.prototype.getPanel=function(){return this._renderGrid();};StockSolutionGrid.prototype.edit=function(a){var c=this;var b=new StockSolutionWindow();b.onSaved.attach(function(e,d){c.onProposalChanged.notify(d);
});b.draw(BIOSAXS.proposal.getStockSolutionById(a));};StockSolutionGrid.prototype._getStoreFields=function(){return[{name:"name",type:"string"},{name:"stockSolutionId",type:"string"},{name:"macromolecule",type:"string"},{name:"buffer",type:"string"},{name:"storageTemperature",type:"numeric"},{name:"volume",type:"string"},{name:"concentration",type:"string"},{name:"buffer",type:"string"},{name:"comments",type:"string"}];
};StockSolutionGrid.prototype._renderGrid=function(){var e=this;this.store=Ext.create("Ext.data.Store",{fields:this._getStoreFields(),autoload:true});var c={ftype:"filters",local:true,filters:this.filters};var a=null;if(this.multiselect){a=Ext.create("Ext.selection.CheckboxModel",{mode:"SINGLE",listeners:{selectionchange:function(h,g){e.selectedStockSolutions=[];
for(var f=0;f<g.length;f++){e.selectedStockSolutions.push(g[f].raw);}}}});}else{a={mode:"SINGLE"};}this.store.sort("stockSolutionId","desc");this.grid=Ext.create("Ext.grid.Panel",{style:{padding:5},icon:"/ispyb/images/SampleHolder_24x24_01.png",title:this.title,height:this.height,width:this.width,minWidth:this.minWidth,selModel:a,store:this.store,columns:this._getColumns(),viewConfig:{stripeRows:true,listeners:{itemdblclick:function(g,f,h,i){e.edit(f.raw.stockSolutionId);
},cellclick:function(f,g,l,h,k,m,i,j){var n=null;if(f.getGridColumns()[l].getId()==e.id+"buttonUnpack"){e.grid.setLoading("ISPyB: Unpacking stock solution");n=new BiosaxsDataAdapter();n.onSuccess.attach(function(o){e.onProposalChanged.notify();e.grid.setLoading(false);});n.onError.attach(function(o){e.onProposalChanged.notify();
e.grid.setLoading(false);});h.raw.boxId=null;n.saveStockSolution(h.raw);}if(f.getGridColumns()[l].getId()==e.id+"box"){window.location=BUI.getShippingURL(BIOSAXS.proposal.getShipmentByDewarId(h.raw.boxId).shippingId);}if(f.getGridColumns()[l].getId()==e.id+"buttonEdit"){e.edit(h.data.stockSolutionId);
}if(f.getGridColumns()[l].getId()==e.id+"buttonRemove"){e.grid.setLoading("ISPyB: Removing stock solution");n=new BiosaxsDataAdapter();n.onSuccess.attach(function(o){e.onProposalChanged.notify();e.grid.setLoading(false);});n.onError.attach(function(o){e.onProposalChanged.notify();e.grid.setLoading(false);
});n.removeStockSolution(h.data.stockSolutionId);}}}}});var d=e._getTopButtons();this.grid.addDocked({xtype:"toolbar",items:d});var b=null;this.grid.getSelectionModel().on({selectionchange:function(g,f){if(f.length){for(b=0;b<d.length;b++){if(d[b].enable){d[b].enable();}}}else{for(b=0;b<d.length;b++){if(d[b].alwaysEnabled==false){if(d[b].disable){d[b].disable();
}}}}}});return this.grid;};StockSolutionGrid.prototype.input=function(){return{proposal:DATADOC.getProposal_10()};};StockSolutionGrid.prototype.test=function(b){var c=new StockSolutionGrid({height:300,width:900});BIOSAXS.proposal=new Proposal(c.input().proposal);var a=c.getPanel();c.refresh(BIOSAXS.proposal.getStockSolutions());
a.render(b);};function TemplateGrid(a){if(a==null){a={};}a.sorters=[{property:"experimentId",direction:"DESC"}];ExperimentGrid.prototype.constructor.call(this,a);}TemplateGrid.prototype._getFilterTypes=ExperimentGrid.prototype._getFilterTypes;TemplateGrid.prototype._prettyPrintMacromolecules=ExperimentGrid.prototype._prettyPrintMacromolecules;
TemplateGrid.prototype._getPercentage=ExperimentGrid.prototype._getPercentage;TemplateGrid.prototype._getPercentageCollected=ExperimentGrid.prototype._getPercentageCollected;TemplateGrid.prototype.getPercentageMerged=ExperimentGrid.prototype.getPercentageMerged;TemplateGrid.prototype._prepareData=ExperimentGrid.prototype._prepareData;
TemplateGrid.prototype.getPanel=ExperimentGrid.prototype.getPanel;TemplateGrid.prototype._renderGrid=ExperimentGrid.prototype._renderGrid;TemplateGrid.prototype._editExperiment=ExperimentGrid.prototype._editExperiment;TemplateGrid.prototype._removeExperimentById=ExperimentGrid.prototype._removeExperimentById;
TemplateGrid.prototype._getTopButtons=function(){var a=[];a.push(Ext.create("Ext.Action",{icon:"../images/add.png",text:"Add experiment",handler:function(d,b){var c=new WizardWidget({windowMode:true});c.onFinished.attach(function(g,e){var f=new BiosaxsDataAdapter();f.onSuccess.attach(function(i,j){var h=new Experiment(j);
BIOSAXS.openExperimentByExperiment(h);c.window.close();});c.current.setLoading("ISPyB: Creating experiment");f.createTemplate(e.name,"comments",e.data);});c.draw(this.targetId,new ExperimentTypeWizardForm());}}));return a;};TemplateGrid.prototype.refresh=function(c){var a=[];for(var b=0;b<c.length;b++){if(c[b].experimentType=="TEMPLATE"){a.push(c[b]);
}}this.store.loadData(this._prepareData(a),false);};TemplateGrid.prototype._getColumns=function(){var b=this;function a(f,g,c,h,e,d){if(c.raw.buffer3VOs!=null){if(c.raw.buffer3VOs.length>0){return"x-hide-display";}}if(c.data.platesCount>0){return"x-hide-display";}}return[{xtype:"rownumberer",width:40},{text:"experimentId",dataIndex:"experimentId",name:"experimentId",type:"string",hidden:true},{text:"Name",dataIndex:"name",name:"name",type:"string",flex:1},{text:"Type",dataIndex:"type",name:"type",type:"string",hidden:true,flex:1,renderer:function(c){return c;
}},{text:"Macromolecules",name:"macromolecules_names",dataIndex:"macromolecules_names",flex:1,renderer:function(c){return" <span style='font-weight:bold'>"+c+"</span>";}},{id:b.id+"GO",width:80,sortable:false,renderer:function(g,d,c,h,f,e){return BUI.getGreenButton("EDIT");}},{id:b.id+"REMOVE",width:100,sortable:false,renderer:function(g,d,c,h,f,e){return BUI.getRedButton("REMOVE");
}}];};TemplateGrid.prototype.input=function(){var a=DATADOC.getExperimentList_10();return{experiments:a,proposal:new MeasurementGrid().input().proposal};};TemplateGrid.prototype.test=function(c){var b=new TemplateGrid({height:350,minHeight:350,width:1000,gridType:"Ext.grid.Panel",title:"Experiments",grouping:false,tbar:true});
BIOSAXS.proposal=new Proposal(b.input().proposal);var a=b.getPanel(b.input().experiments);b.refresh(b.input().experiments);a.render(c);};function VolumeGrid(){this.id=BUI.id();}VolumeGrid.prototype.getPanel=function(a){this.experiment=a;return this.render();};VolumeGrid.prototype.getVolumesPanel=function(c,d){var e=this;
var a=Ext.create("Ext.data.Store",{fields:["name","volume","macromoleculeId","bufferId"],data:c});a.sort([{property:"name",direction:"ASC"}]);var b=Ext.create("Ext.grid.Panel",{title:d,height:400,maxHeight:400,width:900,store:a,margin:"10 0 50 10",tbar:[{text:"Go to Shipment",icon:"../images/plane-small.gif",handler:function(){window.location=BUI.getCreateShipmentList();
}}],viewConfig:{stripeRows:true,listeners:{cellclick:function(f,i,p,j,o,q,m,n){if(f.getGridColumns()[p].getId()==e.id+"buttonCreate"){var g=new StockSolutionWindow();g.onSaved.attach(function(s,r){BIOSAXS.proposal.onInitialized.attach(function(t,u){e.refresh(e.experiment);});BIOSAXS.proposal.init();});
var h="ST";if(j.raw.macromoleculeId!=null){h=h+"_"+BIOSAXS.proposal.getMacromoleculeById(j.raw.macromoleculeId).acronym;}if(j.raw.bufferId!=null){h=h+"_"+BIOSAXS.proposal.getBufferById(j.raw.bufferId).acronym;}g.draw({concentration:j.raw.concentration,macromoleculeId:j.raw.macromoleculeId,bufferId:j.raw.bufferId,name:h,volume:j.raw.volume});
}if(f.getGridColumns()[p].getId()==e.id+"buttonStockSolutions"){var l=new StockSolutionGrid({btnAddVisible:false,btnEditVisible:false,btnRemoveVisible:false,btnAddExisting:false,isPackedVisible:true,multiselect:false});var k=Ext.create("Ext.window.Window",{title:"Stock solutions by specimen",height:400,width:800,layout:"fit",items:[l.getPanel()],buttons:[{text:"Close",handler:function(){k.close();
}}]}).show();l.refresh(BIOSAXS.proposal.getStockSolutionsBySpecimen(j.raw.macromoleculeId,j.raw.bufferId));}}}},columns:[{text:"Specimen",dataIndex:"name",flex:0.5},{text:"Estimated Volume",dataIndex:"volume",tooltip:"Estimation of the maximum volume needed for making this experiment",flex:0.5,editor:{allowBlank:true},renderer:function(g,h,f){return BUI.formatValuesUnits(f.data.volume,"&#181l",{fontSize:16,decimals:2,unitsFontSize:this.unitsFontSize});
}},{text:"Stock Solution",id:e.id+"buttonStockSolutions",dataIndex:"name",flex:0.5,tooltip:"Stock Solutions containing this specimen in this proposal",renderer:function(k,g,i,j,m,l){var n=i.raw.macromoleculeId;var f=i.raw.bufferId;var h=BIOSAXS.proposal.getStockSolutionsBySpecimen(n,f);if(h.length>0){return"<div><span style='font-size:18px'>"+h.length+"</span> x<img height='15px' src='/ispyb/images/SampleHolder_24x24_01.png'></div>";
}}},{id:e.id+"buttonCreate",text:"",tooltip:"Create a new stock solution for shipping",width:170,sortable:false,renderer:function(j,g,f,k,i,h){return BUI.getGreenButton("NEW STOCK SOLUTION",{width:160});}}]});return b;};VolumeGrid.prototype._prepareData=function(a){var e={};for(var c=0;c<a.getSamples().length;
c++){var d=a.getSamples()[c];var b="";if(d.macromoleculeId==null){b=a.getBufferById(d.bufferId).acronym;if(e[b]==null){e[b]={macromoleculeId:d.macromoleculeId,name:b,bufferId:d.bufferId,volume:0};}e[b].volume=Number(d.volume)+Number(e[b].volume);}if((d.macromolecule3VO!=null)||(d.macromoleculeId!=null)){macromoleculeId=d.macromoleculeId;
if(d.macromoleculeId==null){d.macromoleculeId=d.macromolecule3VO.macromoleculeId;}b=BIOSAXS.proposal.getMacromoleculeById(d.macromoleculeId).acronym+" + "+a.getBufferById(d.bufferId).acronym;if(e[b]==null){e[b]={macromoleculeId:d.macromoleculeId,name:b,bufferId:d.bufferId,volume:0};}e[b].volume=Number(d.volume)+Number(e[b].volume);
}}var f=[];for(var g in e){f.push(e[g]);}return f;};VolumeGrid.prototype.refresh=function(a){this.experiment=a;this.macromoleculeGrid.getStore().loadData(this._prepareData(this.experiment),false);};VolumeGrid.prototype.render=function(){this.macromoleculeGrid=this.getVolumesPanel(this._prepareData(this.experiment),"Estimation of required Volume");
return{xtype:"container",layout:"vbox",margin:"0, 0, 0, 5",items:[{xtype:"container",layout:"hbox",margin:"0, 0, 0, 0",items:[this.macromoleculeGrid]}]};};VolumeGrid.prototype.input=function(a){return{experiment:DATADOC.getExperiment_10()};};VolumeGrid.prototype.test=function(b){var c=new VolumeGrid();
BIOSAXS.proposal=new Proposal(new MeasurementGrid().input().proposal);var a=c.getPanel(new Experiment(new VolumeGrid().input().experiment));Ext.create("Ext.panel.Panel",{height:500,width:1000,renderTo:b,items:[a]});};function ExperimentTabs(a){this.height=900;this.targetId=a;this.id=BUI.id();var b=this;
this.INTERVAL_UPDATE=BUI.getUpdateInterval();this.gridHeight=1000;this.experiment=null;this.samplePlateGroupWidget=new SamplePlateGroupWidget({showTitle:false,height:250,margin:5,border:0});this.measurementSamplePlateGroupWidget=new SamplePlateGroupWidget({showTitle:false,height:250,margin:"5 0 0 0",border:0});
this.measurementGridDone=new MeasurementGrid({height:800,minHeight:400,maxHeight:800,positionColumnsHidden:true,showTitle:false,estimateTime:true,width:900,maxWidth:1500,addBtnEnable:false,markDone:true,removeBtnEnabled:false});this.measurementGridDone.onSelected.attach(function(e,c){var f=[];for(var d=0;
d<c.length;d++){f.push(b.experiment.getSampleById(c[d].specimenId));}b.measurementSamplePlateGroupWidget.selectSpecimens(f);});this.analysisGrid=new AnalysisGrid({height:Ext.getBody().getViewSize().height*0.9-300,positionColumnsHidden:true,sorters:[{property:"priorityLevelId",direction:"ASC"}]});}ExperimentTabs.prototype.error=function(a){var b=JSON.parse(a);
showError(b);this.panel.setLoading(false);};ExperimentTabs.prototype.draw=function(a){this.renderDataAcquisition(a);};ExperimentTabs.prototype.refreshAnalysisData=function(){var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(c,d){b.analysisGrid.refresh(d,{experiment:b.experiment});
});a.getAnalysisInformationByExperimentId(this.experiment.experimentId);};ExperimentTabs.prototype.getSpecimenContainerHeight=function(b){var c=0;if(c<b.getSamples().length+1){c=b.getSamples().length+1;}var a=(c+1)*40+40;if(a>400){a=400;}return a;};ExperimentTabs.prototype.getExperimentTitle=function(){var a=new ExperimentHeaderForm();
return a.getPanel(this.experiment);};ExperimentTabs.prototype.renderDataAcquisition=function(b){var f=this;this.experiment=b;var e=new SpecimenGrid({height:400,maxHeight:500,width:890});e.onClick.attach(function(h,g){});e.onSelected.attach(function(g,h){f.samplePlateGroupWidget.selectSpecimens(h);});
var c=Ext.create("Ext.container.Container",{layout:"hbox",width:900,padding:"10 0 0 2",items:[e.getPanelByExperiment(b)]});var d=new ExperimentList([f.experiment]);var a=Ext.create("Ext.container.Container",{layout:"vbox",padding:"5px 0px 0px 10px",items:[]});a.insert(0,f.measurementGridDone.getPanel(this.experiment.getMeasurements(),d));
a.insert(1,f.measurementSamplePlateGroupWidget.getPanel(b));this.panel=Ext.createWidget("tabpanel",{plain:true,style:{padding:2},items:[{tabConfig:{id:"genralTabl",title:"Overview"},items:[{xtype:"container",layout:"vbox",border:1,height:f.gridHeight,flex:1,items:[c,{xtype:"container",defaults:{style:{padding:"1px"}},items:[this.samplePlateGroupWidget.getPanel(b)]}]}]},{tabConfig:{title:"Measurements"},items:[{xtype:"container",layout:"vbox",border:1,height:1400,flex:1,items:[a]}]},{tabConfig:{id:"SpecimenTab",title:"Analysis",hidden:this.isTemplate()},items:[{xtype:"container",layout:"vbox",padding:"5px 0px 10px 10px",items:[f.analysisGrid.getPanel([])]}]}]});
return this.getPanel(this.panel);};ExperimentTabs.prototype.isTemplate=function(){if(this.experiment.json.type=="TEMPLATE"){return true;}return false;};ExperimentTabs.prototype.update=function(){var c=this;var a;if(!c.isTemplate()){function b(){console.log("Updating ");c.refreshAnalysisData();window.clearInterval(a);
a=setInterval(function(){b();},c.INTERVAL_UPDATE);var d=new BiosaxsDataAdapter();d.onSuccess.attach(function(f,g){var e=new Experiment(g);c.measurementGridDone.refresh(e.getMeasurements(),new ExperimentList([e]));});d.getExperimentById(c.experiment.json.experimentId,"MEDIUM");}a=setInterval(function(){b();
},c.INTERVAL_UPDATE);}};ExperimentTabs.prototype.getPanel=function(a){var b=this;if(this.experimentPanel==null){this.experimentPanel=Ext.create("Ext.container.Container",{bodyPadding:2,width:Ext.getBody().getViewSize().width*0.9,renderTo:this.targetId,style:{padding:2},items:[this.getExperimentTitle(),this.panel],listeners:{afterrender:function(){b.refreshAnalysisData();
b.update();}}});}return this.experimentPanel;};ExperimentTabs.prototype.input=function(){return{proposal:new MeasurementGrid().input().proposal,experiment:{"experimentId":1137,"name":"MG386_2.xml","creationDate":"Jul 17, 2013 5:08:37 PM","sourceFilePath":"/data/pyarch/bm29/opd29/1137/MG386_2.xml","type":"STATIC","comments":"[BsxCube] Generated from BsxCube","dataAcquisitionFilePath":"/data/pyarch/bm29/opd29/1137/1137.zip","status":"FINISHED","proposalId":10,"samplePlate3VOs":[{"samplePlateId":3409,"platetype3VO":{"plateTypeId":4,"name":"96 Well plate","description":null,"rowCount":8,"columnCount":12,"shape":"REC"},"instructionSet3VO":null,"plategroup3VO":{"plateGroupId":1137,"storageTemperature":"20.0","name":"BsxCube Group 1"},"boxId":null,"name":"96 Well plate","slotPositionRow":"1","slotPositionColumn":"3","storageTemperature":"20.0","sampleplateposition3VOs":[],"experimentId":1137},{"samplePlateId":3411,"platetype3VO":{"plateTypeId":1,"name":"Deep Well","description":null,"rowCount":8,"columnCount":12,"shape":"REC"},"instructionSet3VO":null,"plategroup3VO":{"plateGroupId":1137,"storageTemperature":"20.0","name":"BsxCube Group 1"},"boxId":null,"name":"Deep Well","slotPositionRow":"1","slotPositionColumn":"1","storageTemperature":"20.0","sampleplateposition3VOs":[],"experimentId":1137},{"samplePlateId":3410,"platetype3VO":{"plateTypeId":2,"name":" 4 x ( 8 + 3 ) Block","description":null,"rowCount":4,"columnCount":11,"shape":"REC"},"instructionSet3VO":null,"plategroup3VO":{"plateGroupId":1137,"storageTemperature":"20.0","name":"BsxCube Group 1"},"boxId":null,"name":" 4 x ( 8 + 3 ) Block","slotPositionRow":"1","slotPositionColumn":"2","storageTemperature":"20.0","sampleplateposition3VOs":[{"samplePlatePositionId":8512,"samplePlateId":3410,"rowNumber":1,"columnNumber":7,"volume":null},{"samplePlatePositionId":8513,"samplePlateId":3410,"rowNumber":1,"columnNumber":8,"volume":null},{"samplePlatePositionId":8511,"samplePlateId":3410,"rowNumber":1,"columnNumber":9,"volume":null}],"experimentId":1137}],"platetype3VOs":[{"plateTypeId":4,"name":"96 Well plate","description":null,"rowCount":8,"columnCount":12,"shape":"REC"},{"plateTypeId":3,"name":"Disk Well plate","description":null,"rowCount":8,"columnCount":2,"shape":"CIR"},{"plateTypeId":2,"name":" 4 x ( 8 + 3 ) Block","description":null,"rowCount":4,"columnCount":11,"shape":"REC"},{"plateTypeId":1,"name":"Deep Well","description":null,"rowCount":8,"columnCount":12,"shape":"REC"}],"samples3VOs":[{"specimenId":8526,"macromolecule3VO":null,"sampleplateposition3VO":{"samplePlatePositionId":8511,"samplePlateId":3410,"rowNumber":1,"columnNumber":9,"volume":null},"bufferId":707,"stockSolutionId":null,"experimentId":1137,"safetyLevelId":null,"concentration":"0.0","code":"","volume":"75","comments":null,"measurements":[{"measurementId":22152,"specimenId":8526,"flow":true,"priority":3,"exposureTemperature":"20.0","viscosity":"Low","extraFlowTime":"10","volumeToLoad":"75","comments":"MESbuffer","code":"_20.0","transmission":"100.0","waitTime":"0.0","run3VO":{"runId":12611,"timePerFrame":"1.0","timeStart":"2013-07-17 17:11:39.434973","timeEnd":"2013-07-17 17:12:53.944725","storageTemperature":"20.0","exposureTemperature":"20.04","spectrophotometer":"spectrophotometer","energy":"12.4996471418","transmission":"100.0","beamCenterX":"763","beamCenterY":"136","pixelSizeX":"172.0","pixelSizeY":"172.0","radiationRelative":"0","radiationAbsolute":"1e-50","normalization":null},"merge3VOs":[{"mergeId":12374,"framelist3VO":{"_filter_signature":[-13,121,4],"serialVersionUID":-1,"comments":null,"frametolist3VOs":[]},"measurementId":22152,"discardedFrameNameList":null,"averageFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_017_ave.dat","framesCount":"10","framesMerge":"10"}],"dataCollectionOrder":null},{"measurementId":22155,"specimenId":8526,"flow":true,"priority":5,"exposureTemperature":"20.0","viscosity":"Low","extraFlowTime":"10","volumeToLoad":"75","comments":"MESbuffer","code":"_20.0","transmission":"100.0","waitTime":"0.0","run3VO":{"runId":12613,"timePerFrame":"1.0","timeStart":"2013-07-17 17:14:10.359208","timeEnd":"2013-07-17 17:15:24.547522","storageTemperature":"20.0","exposureTemperature":"20.04","spectrophotometer":"spectrophotometer","energy":"12.4996471418","transmission":"100.0","beamCenterX":"763","beamCenterY":"136","pixelSizeX":"172.0","pixelSizeY":"172.0","radiationRelative":"0","radiationAbsolute":"1e-50","normalization":null},"merge3VOs":[{"mergeId":12376,"framelist3VO":{"_filter_signature":[-13,121,4],"serialVersionUID":-1,"comments":null,"frametolist3VOs":[]},"measurementId":22155,"discardedFrameNameList":null,"averageFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_019_ave.dat","framesCount":"10","framesMerge":"10"}],"dataCollectionOrder":null},{"measurementId":22150,"specimenId":8526,"flow":true,"priority":1,"exposureTemperature":"20.0","viscosity":"Low","extraFlowTime":"10","volumeToLoad":"75","comments":"MESbuffer","code":"_20.0","transmission":"100.0","waitTime":"0.0","run3VO":{"runId":12609,"timePerFrame":"1.0","timeStart":"2013-07-17 17:09:09.684852","timeEnd":"2013-07-17 17:10:24.069393","storageTemperature":"20.0","exposureTemperature":"20.04","spectrophotometer":"spectrophotometer","energy":"12.4996471418","transmission":"100.0","beamCenterX":"763","beamCenterY":"136","pixelSizeX":"172.0","pixelSizeY":"172.0","radiationRelative":"0","radiationAbsolute":"1e-50","normalization":null},"merge3VOs":[{"mergeId":12372,"framelist3VO":{"_filter_signature":[-13,121,4],"serialVersionUID":-1,"comments":null,"frametolist3VOs":[]},"measurementId":22150,"discardedFrameNameList":null,"averageFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_015_ave.dat","framesCount":"10","framesMerge":"10"}],"dataCollectionOrder":null}],"macromoleculeId":null},{"specimenId":8528,"macromolecule3VO":{"macromoleculeId":112,"safetylevelId":null,"proposalId":10,"name":"MG386","acronym":"MG386","molecularMass":null,"extintionCoefficient":null,"sequence":null,"creationDate":null,"comments":null,"stoichiometry3VOsForHostMacromoleculeId":[],"structure3VOs":[]},"sampleplateposition3VO":{"samplePlatePositionId":8513,"samplePlateId":3410,"rowNumber":1,"columnNumber":8,"volume":null},"bufferId":707,"stockSolutionId":null,"experimentId":1137,"safetyLevelId":null,"concentration":"0.65000000000000002","code":"","volume":"75","comments":null,"measurements":[{"measurementId":22154,"specimenId":8528,"flow":true,"priority":4,"exposureTemperature":"20.0","viscosity":"Low","extraFlowTime":"10","volumeToLoad":"75","comments":"[2] MES","code":"_20.0_0.65000000000000002","transmission":"100.0","waitTime":"0.0","run3VO":{"runId":12612,"timePerFrame":"1.0","timeStart":"2013-07-17 17:12:55.837462","timeEnd":"2013-07-17 17:14:10.243329","storageTemperature":"20.0","exposureTemperature":"20.04","spectrophotometer":"spectrophotometer","energy":"12.4996471418","transmission":"100.0","beamCenterX":"763","beamCenterY":"136","pixelSizeX":"172.0","pixelSizeY":"172.0","radiationRelative":"0","radiationAbsolute":"1e-50","normalization":null},"merge3VOs":[{"mergeId":12375,"framelist3VO":{"_filter_signature":[-13,121,4],"serialVersionUID":-1,"comments":null,"frametolist3VOs":[]},"measurementId":22154,"discardedFrameNameList":null,"averageFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_018_ave.dat","framesCount":"10","framesMerge":"10"}],"dataCollectionOrder":null}],"macromoleculeId":null},{"specimenId":8527,"macromolecule3VO":{"macromoleculeId":112,"safetylevelId":null,"proposalId":10,"name":"MG386","acronym":"MG386","molecularMass":null,"extintionCoefficient":null,"sequence":null,"creationDate":null,"comments":null,"stoichiometry3VOsForHostMacromoleculeId":[],"structure3VOs":[]},"sampleplateposition3VO":{"samplePlatePositionId":8512,"samplePlateId":3410,"rowNumber":1,"columnNumber":7,"volume":null},"bufferId":707,"stockSolutionId":null,"experimentId":1137,"safetyLevelId":null,"concentration":"1.25","code":"","volume":"75","comments":null,"measurements":[{"measurementId":22151,"specimenId":8527,"flow":true,"priority":2,"exposureTemperature":"20.0","viscosity":"Low","extraFlowTime":"10","volumeToLoad":"75","comments":"[1] MES","code":"_20.0_1.25","transmission":"100.0","waitTime":"0.0","run3VO":{"runId":12610,"timePerFrame":"1.0","timeStart":"2013-07-17 17:10:25.743734","timeEnd":"2013-07-17 17:11:39.319728","storageTemperature":"20.0","exposureTemperature":"20.04","spectrophotometer":"spectrophotometer","energy":"12.4996471418","transmission":"100.0","beamCenterX":"763","beamCenterY":"136","pixelSizeX":"172.0","pixelSizeY":"172.0","radiationRelative":"0","radiationAbsolute":"1e-50","normalization":null},"merge3VOs":[{"mergeId":12373,"framelist3VO":{"_filter_signature":[-13,121,4],"serialVersionUID":-1,"comments":null,"frametolist3VOs":[]},"measurementId":22151,"discardedFrameNameList":null,"averageFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_016_ave.dat","framesCount":"10","framesMerge":"10"}],"dataCollectionOrder":null}],"macromoleculeId":null}],"dataCollections":[{"dataCollectionId":7385,"measurementtodatacollection3VOs":[{"measurementToDataCollectionId":22153,"measurementId":22152,"dataCollectionOrder":1},{"measurementToDataCollectionId":22155,"measurementId":22155,"dataCollectionOrder":3},{"measurementToDataCollectionId":22154,"measurementId":22154,"dataCollectionOrder":2}],"experimentId":1137,"substraction3VOs":[{"subtractionId":5166,"dataCollectionId":7385,"rg":"2.95541","rgStdev":"0.125183","i0":"31.4366153846","i0stdev":"0.100250461538","firstPointUsed":"21","lastPointUsed":"80","quality":"0.870164","isagregated":"False","concentration":null,"rgGuinier":"2.95541","rgGnom":"2.9963404542","dmax":"10.343935","total":"0.582641941147","volume":"42.2255","creationTime":"Jul 17, 2013 5:15:02 PM","gnomFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_018_sub-density.png","kratkyFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_018_sub-Kratky.png","scatteringFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_018_sub-scattering.png","guinierFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_018_sub-Guinier.png","substractedFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_018_sub.dat","gnomFilePathOutput":" /data/pyarch/bm29/opd29/1137/1d/MG386_018_sub.out"}],"comments":null},{"dataCollectionId":7384,"measurementtodatacollection3VOs":[{"measurementToDataCollectionId":22150,"measurementId":22150,"dataCollectionOrder":1},{"measurementToDataCollectionId":22152,"measurementId":22152,"dataCollectionOrder":3},{"measurementToDataCollectionId":22151,"measurementId":22151,"dataCollectionOrder":2}],"experimentId":1137,"substraction3VOs":[{"subtractionId":5165,"dataCollectionId":7384,"rg":"2.96883","rgStdev":"0.0455043","i0":"32.50776","i0stdev":"0.05726128","firstPointUsed":"30","lastPointUsed":"92","quality":"0.87091","isagregated":"False","concentration":null,"rgGuinier":"2.96883","rgGnom":"3.05242714339","dmax":"10.390905","total":"0.447505552082","volume":"44.1406","creationTime":"Jul 17, 2013 5:12:32 PM","gnomFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_016_sub-density.png","kratkyFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_016_sub-Kratky.png","scatteringFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_016_sub-scattering.png","guinierFilePath":"/data/pyarch/bm29/opd29/1137/1d/MG386_016_sub-Guinier.png","substractedFilePath":" /data/pyarch/bm29/opd29/1137/1d/MG386_016_sub.dat","gnomFilePathOutput":" /data/pyarch/bm29/opd29/1137/1d/MG386_016_sub.out"}],"comments":null}]}};
};ExperimentTabs.prototype.test=function(b){var a=new ExperimentTabs(b);BIOSAXS.proposal=new Proposal(a.input().proposal);a.draw(new Experiment(a.input().experiment));};function HPLCTabs(a){this.height=1400;this.targetId=a;this.id=BUI.id();this.gridHeight=600;this.pointsCount=1036;this.plotHeight=350;
this.plotWidth=800;this.plotPanelPadding=5;var b=this;this.analysisGrid=new HPLCAnalysisGrid({height:Ext.getBody().getViewSize().height*0.9-300,positionColumnsHidden:true,sorters:[{property:"priorityLevelId",direction:"ASC"}]});this.frameGrid=new FrameGrid({width:600,height:60,collapsed:false,tbar:false});
this.peakGrid=new PeakGrid({width:550,height:500,collapsed:false,tbar:false});this.peakGrid2=new PeakGrid({width:102,height:this.plotHeight,collapsed:false,tbar:false,showExtendedColumns:true});this.mainPlotPanel=new HPLCGraph({title:"I0",width:this.plotWidth-110,height:this.plotHeight,bbar:true,plots:{"I0":true,"Rg":true},xlabel:"HPLC Frames",scaled:true,interactionModel:{"dblclick":function(e,d,c){b._selectFrame(d.lastx_);
var f=[];f.push({series:d.selPoints_[0].name,x:d.lastx_,width:100,height:23,tickHeight:4,shortText:d.lastx_,text:d.lastx_,attachAtBottom:true});d.setAnnotations(f);}}});this.intensityPlotPanel=new MergesHPLCGraph({title:"Scattering",width:this.plotWidth,height:500,showRangeSelector:false,xParam:0,xlabel:"scattering_I",plots:{"scattering_I":true,"subtracted_I":true,"buffer_I":true}});
}HPLCTabs.prototype._selectFrame=function(b){try{this._renderScatteringCurve(b);this.frameGrid.refresh([this.mainPlotPanel.getDataByFrameNumber(b)],this.experiment.experimentId);}catch(a){console.log(a);}};HPLCTabs.prototype.error=function(a){var b=JSON.parse(a);showError(b);this.panel.setLoading(false);
};HPLCTabs.prototype.loadDataMainPlot=function(b){var c=[];for(var a=0;a<b.I0.length;a++){c.push(0);}b=[{param:"I0",data:b.I0,std:b.I0_Stdev,color:"#0066CC",label:"I0"},{param:"sum_I",label:"sum_I",color:"#00FF00",data:b.sum_I,std:c},{param:"Rg",label:"Rg",color:"#21610B",data:b.Rg,std:b.Rg_Stdev},{param:"Mass",data:b.mass,std:b.mass_Stdev,color:"#FF9900",label:"Mass"},{param:"Vc",data:b.Vc,std:b.Vc_Stdev,color:"#990099",label:"Vc"},{param:"Qr",data:b.Qr,std:b.Qr_Stdev,color:"#FF0066",label:"Qr"},{param:"quality",label:"quality",color:"#FF00FF",data:b.quality,std:c}];
this.data=b;this.mainPlotPanel.loadData(b);};HPLCTabs.prototype._loadIntensityPlotByFrameNumber=function(b){var c=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(d,e){var f=[];e=[{param:"q",data:e[b].q,std:e[b].q,fstd:function(g){return parseFloat(g);},color:"#green",label:"q",showOnMenu:false},{param:"scattering_I",data:e[b].scattering_I,fdata:function(g){return Math.log(parseFloat(g));
},std:e[b].scattering_Stdev,fstd:function(g){return Math.log(Math.abs(parseFloat(g)));},color:"green",label:"Log(I) Sample"},{param:"buffer_I",data:e[b].buffer_I,fdata:function(g){return Math.log(parseFloat(g));},fstd:function(g){return Math.log(Math.abs(parseFloat(g)));},std:e[b].subtracted_Stdev,color:"#0000FF",label:"Log(I) Avg Buf."},{param:"subtracted_I",data:e[b].subtracted_I,fdata:function(g){var h=(Math.log(parseFloat(g)));
if(isNumber(h)){return h;}},fstd:function(g){var h=Math.log(Math.abs(parseFloat(g)));if(isNumber(h)){return h;}},std:e[b].subtracted_Stdev,color:"red",label:"Log(I) Sub."}];c.intensityPlotPanel.xlabel="Frame "+b+" (q, nm-1)";if(c.intensityPlotPanel.hplcData==null){c.intensityPlotPanel.loadData(e);}else{c.intensityPlotPanel.reloadData(e);
}c.intensityPlotPanel.panel.setLoading(false);});a.onError.attach(function(d,e){c.intensityPlotPanel.panel.setLoading(false);});this.intensityPlotPanel.panel.setLoading("Retrieving Frame "+b);a.getH5FrameScattering(this.experiment.json.experimentId,b);};HPLCTabs.prototype._renderScatteringCurve=function(b){var c=this;
var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(f,g){c.intensityPlotPanel.setPeaks(g);c._loadIntensityPlotByFrameNumber(b);try{var d=[];for(key in g){d.push({start:key.split("-")[0],end:key.split("-")[1],experimentId:c.experiment.json.experimentId});}c.peakGrid2.refresh(JSON.parse(JSON.stringify(d)));
c.peakGrid.refresh(d);}catch(h){showError(h);}});a.onError.attach(function(d,e){c.intensityPlotPanel.setLoading(false);});this.intensityPlotPanel.panel.setLoading("Reading HDF5 File ");a.getH5FramesMerge(this.experiment.json.experimentId);};HPLCTabs.prototype._postRenderOverviewPanel=function(){var b=this;
var a=new BiosaxsDataAdapter();a.onError.attach(function(c,d){d=d.replace(/NaN/g,"0");b.loadDataMainPlot(JSON.parse(d));});a.onSuccess.attach(function(c,d){b.loadDataMainPlot(d);b._renderScatteringCurve(0);});a.getH5fileParameters(this.experiment.json.experimentId,["I0","I0_Stdev","sum_I","Rg","Rg_Stdev","Vc","Vc_Stdev","Qr","Qr_Stdev","mass","mass_Stdev","quality"]);
};HPLCTabs.prototype._postRenderDetailsPanel=function(){if(this.data!=null){this.I0PlotPanel.loadData(this.data);this.RgPlotPanel.loadData(this.data);this.MassPlotPanel.loadData(this.data);this.VcPlotPanel.loadData(this.data);}};HPLCTabs.prototype.draw=function(a){var b=this;this.renderDataAcquisition(a);
};HPLCTabs.prototype.getExperimentTitle=function(){var a=new ExperimentHeaderForm();return a.getPanel(this.experiment);};HPLCTabs.prototype.renderDataAcquisition=function(a){var b=this;this.experiment=a;if(this.experimentPanel==null){this.experimentPanel=Ext.create("Ext.container.Container",{bodyPadding:2,height:this.height,width:Ext.getBody().getViewSize().width*0.9,renderTo:this.targetId,style:{padding:2},items:[this.getExperimentTitle(),this.getPanel()],listeners:{afterrender:function(){var c=new BiosaxsDataAdapter();
c.onSuccess.attach(function(d,e){b.analysisGrid.refresh(e);});c.getAnalysisInformationByExperimentId(b.experiment.experimentId);}}});}return this.experimentPanel;};HPLCTabs.prototype.getPanel=function(){var a=this;this.panel=Ext.createWidget("tabpanel",{plain:true,height:this.height,style:{padding:2},items:[{tabConfig:{title:"Overview"},items:[{xtype:"container",layout:"hbox",border:1,flex:1,items:[{xtype:"container",layout:"vbox",border:1,items:[{xtype:"container",margin:"10px",border:1,items:[{xtype:"container",margin:"0px",layout:"hbox",border:1,items:[this.peakGrid2.getPanel([]),this.mainPlotPanel.getPanel()]},{xtype:"container",layout:"vbox",border:1,items:[{html:'<div style="font-weight:bold;width:600px;border-bottom:1px solid #000000;">Select a frame by double-clicking on the HPLC Frames plot</div>',margin:5,border:0},this.frameGrid.getPanel([]),this.intensityPlotPanel.getPanel()]}]}],listeners:{afterrender:function(){a._postRenderOverviewPanel();
}}}]}]},{tabConfig:{title:"Analysis"},items:[{xtype:"container",layout:"vbox",padding:"5px 0px 10px 10px",items:[a.analysisGrid.getPanel([])]}]},{tabConfig:{title:"File Manager"},items:[{xtype:"container",layout:"vbox",padding:"5px 0px 10px 10px",items:[{html:'<div style="font-weight:bold;width:900px;border-bottom:1px solid #000000;">Custom Download</div>',margin:"10 0 10 5",border:0},{html:'<div style="font-weight:bold;width:900px;border:1px solid red;color:red">Download has been temporary disabled. Contact your labcontact if you want to extract the frames from the HDF5 file</div>',margin:"10 0 10 5",border:0},{xtype:"container",layout:"hbox",margin:"0 0 0 20",flex:1,items:[{xtype:"numberfield",id:"field_start",fieldLabel:"Frames from",value:0,minValue:0},{xtype:"numberfield",id:"field_end",fieldLabel:"to",labelWidth:20,margin:"0 0 0 10",minValue:0},{xtype:"button",disabled:true,text:"Download",margin:"0 0 0 10",handler:function(){var e=a.experiment.experimentId;
var f=Ext.getCmp("field_start").getValue();var c=Ext.getCmp("field_end").getValue();if(f>c){var b=c;c=f;f=b;}var d=BUI.getZipFrameHPLCUrl(e,f,c);window.open(d);}}]},a.peakGrid.getPanel([])]}]}]});return this.panel;};function ResultTabs(){}ResultTabs.prototype.draw=function(b,d,c){var a=this.getPanel(b,d,c);
return Ext.create("Ext.container.Container",{renderTo:b,items:[BUI.getMacromoleculeHeader(c),a]});};ResultTabs.prototype._splitBySpecimen=function(b){var d={};for(var a=0;a<b.length;a++){var c=b[a];if(d[c.macromoleculeId+"_"+c.bufferId]==null){d[c.macromoleculeId+"_"+c.bufferId]=[];}d[c.macromoleculeId+"_"+c.bufferId].push(c);
}return d;};ResultTabs.prototype._getTabTitle=function(c,d){var b=c.split("_")[0];var a=c.split("_")[1];return BIOSAXS.proposal.getMacromoleculeById(b).acronym+" + "+BIOSAXS.proposal.getBufferById(a).acronym+"("+d.length+")";};ResultTabs.prototype.getPanel=function(b,e,d){var f=new AnalysisGrid({hideNulls:true,grouped:true,sorters:[{property:"quality",direction:"DESC"}]})._prepareData(e);
var a=[{tabConfig:{title:"Analysis ("+f.length+")"},items:[{xtype:"container",layout:"vbox",padding:10,items:[new AnalysisGrid({isScatteringPlotVisible:false}).getPanel(f)]}]},{tabConfig:{title:"Concentration Effects"},items:[new ResultSummaryForm().getPanel(e)]}];var g=this._splitBySpecimen(f);for(var c in g){a.push({tabConfig:{title:this._getTabTitle(c,g[c])},items:[new ResultSummaryForm().getPanel(g[c])]});
}this.panel=Ext.createWidget("tabpanel",{style:{padding:2},items:a});return this.panel;};function ShipmentTabs(a){this.targetId=a;var b=this;this.gridHeight=500;this.shipment=null;this.shipmentForm=new ShipmentForm({creationMode:false,showTitle:false});this.shipmentForm.onSaved.attach(function(c,d){b.refresh(d);
});this.caseGrid=new CaseGrid({height:this.gridHeight});this.caseGrid.onAddButtonClicked.attach(function(d,e){b.caseGrid.grid.setLoading("ISPyB: Creating a new case");var c=new BiosaxsDataAdapter();c.onSuccess.attach(function(h,g){for(var f=0;f<BIOSAXS.proposal.shippings.length;f++){if(BIOSAXS.proposal.shippings[f].shippingId==g.shippingId){BIOSAXS.proposal.shippings[f]=g;
}}b.refresh(g);});c.onError.attach(function(g,f){b.caseGrid.grid.setLoading(false);});c.addCase(b.shipment.json.shippingId);});this.caseGrid.onRemoveButtonClicked.attach(function(c,d){b.panel.setLoading("ISPyB: removing case");b.shipment.onSaved.attach(function(f,e){b.refresh(e);});b.shipment.removeCase(d);
});}ShipmentTabs.prototype.refresh=function(b){var c=this;this.shipment=b;var a=new Proposal();a.onDataRetrieved.attach(function(e,d){c.refreshWithPlates(b,d);c.caseGrid.grid.setLoading(false);});a.getPlatesByProposal();};ShipmentTabs.prototype.refreshWithPlates=function(b,a){this.shipment=new Shipment(b);
this.caseGrid.refresh(this.shipment.getDewars(),a);this.panel.setLoading(false);};ShipmentTabs.prototype.error=function(a){var b=JSON.parse(a);showError(b);this.panel.setLoading(false);};ShipmentTabs.prototype.draw=function(a){var b=this;b.plates=[];b.shipment=a;b.render(a);};ShipmentTabs.prototype.render=function(a){return this.getPanel(a);
};ShipmentTabs.prototype.getShipmentHeader=function(b){var c=this;function a(){var f=b.json.shippingName;var e=b.json.shippingStatus;var d=b.json.creationDate;var g=BUI.createFormLabel("Name :",f,75,400);g=g+BUI.createFormLabel("Status :",e,75,400);g=g+BUI.createFormLabel("Date :",d,75,400);return g;
}return Ext.create("Ext.container.Container",{frame:false,layout:"hbox",title:"General",padding:5,bodyPadding:"5 5 0 0",width:890,margin:"0 0 10 0",height:100,style:{borderColor:"#BDBDBD",borderStyle:"solid",borderWidth:"1px"},fieldDefaults:{msgTarget:"side",labelWidth:100},items:[{margin:"0 0 0 0",width:475,border:0,html:a()}]});
};ShipmentTabs.prototype.getTabPanel=function(a){this.panel=Ext.createWidget("tabpanel",{height:600,style:{padding:2},items:[{tabConfig:{id:"Shipment",title:"Shipment",icon:"/ispyb/images/plane-small.gif"},items:[{xtype:"container",margin:"5 5 5 5",items:[this.shipmentForm.getPanel(a)]}]},{tabConfig:{id:"Cases",title:"Cases",icon:"../images/box-icon-very-small.png"},items:[{xtype:"container",margin:"5 5 5 5",items:[this.caseGrid.getPanel(a.getDewars(),this.plates)]}]}]});
return this.panel;};ShipmentTabs.prototype.getPanel=function(a){var b=this;this.shipment=a;if(this.plates==null){this.plates=[];}if(this.shipPanel==null){this.shipPanel=Ext.create("Ext.container.Container",{bodyPadding:2,width:Ext.getBody().getViewSize().width*0.9,renderTo:this.targetId,style:{padding:2},items:[this.getShipmentHeader(a),this.getTabPanel(a)]});
}return this.shipPanel;};function TemplateTabs(c){this.height=900;this.targetId=c;this.id=BUI.id();var d=this;this.gridHeight=1000;this.experiment=null;this.specimenSelected=null;this.samplePlateGroupWidget=new SamplePlateGroupWidget({showTitle:false,height:250,margin:5,bbar:true});this.samplePlateGroupWidget.onExperimentChanged.attach(function(f,e){d.refresh(new Experiment(e));
});this.samplePlateGroupWidget.onClick.attach(function(h,f){var k=f.row;var i=f.column;var g=f.samplePlate.samplePlateId;if(d.specimenSelected!=null){if(d.experiment.getSampleByPosition(f.samplePlate.samplePlateId,f.row,f.column).length==0){var l=d.experiment.getSampleById(d.specimenSelected.specimenId);
if(l.sampleplateposition3VO==null){l.sampleplateposition3VO={};}l.sampleplateposition3VO={columnNumber:i,rowNumber:k,samplePlateId:g};d.samplePlateGroupWidget.panel.setLoading("ISPyB: Saving specimen");var e=new BiosaxsDataAdapter();e.onSuccess.attach(function(n,m){d.samplePlateGroupWidget.panel.setLoading(false);
});e.onError.attach(function(n,m){d.samplePlateGroupWidget.panel.setLoading(false);showError(m);});e.saveSpecimen(l,d.experiment);d.samplePlateGroupWidget.refresh(d.experiment);d.specimenGrid.refresh(d.experiment);d.refresh(d.experiment);d.specimenGrid.deselectAll();}else{var j=d.experiment.getSampleByPosition(f.samplePlate.samplePlateId,f.row,f.column)[0];
var l=d.experiment.getSampleById(d.specimenSelected.specimenId);if((l.bufferId==j.bufferId)&&(l.concentration==j.concentration)){if(((l.macromolecule3VO!=null)&&(j.macromolecule3VO!=null)&&(l.macromolecule3VO.macromoleculeId==j.macromolecule3VO.macromoleculeId))||((l.macromolecule3VO==null)&&(j.macromolecule3VO==null))){var e=new BiosaxsDataAdapter();
e.onSuccess.attach(function(m,n){d.refresh(new Experiment(n));d.samplePlateGroupWidget.panel.setLoading(false);});e.onError.attach(function(n,m){d.samplePlateGroupWidget.panel.setLoading(false);showError(m);});d.samplePlateGroupWidget.panel.setLoading("ISPyB: Merging specimens");e.mergeSpecimens(l.specimenId,j.specimenId);
}}else{alert("Well is not empty. Select another well!");}}}else{var l=d.experiment.getSampleByPosition(f.samplePlate.samplePlateId,f.row,f.column)[0];if(l!=null){d.specimenGrid.selectById(l.specimenId);}}});this.volumePlanificator=new VolumeGrid();var b=Ext.create("Ext.data.Store",{fields:["name"],data:[{"name":"low"},{"name":"medium"},{"name":"high"}]});
var a=Ext.create("Ext.form.ComboBox",{fieldLabel:"",store:b,queryMode:"local",displayField:"name",valueField:"name"});this.measurementGrid=new MeasurementGrid({height:this.gridHeight,width:940,maxWidth:1500,estimateTime:false,positionColumnsHidden:true,isPriorityColumnHidden:true,isStatusColumnHidden:true,isTimeColumnHidden:true,updateRowEnabled:true,collapsed:true,removeBtnEnabled:true,showTitle:false,collapseBtnEnable:false,addBtnMultipleEdit:true,sortingBtnEnable:true,editor:{exposureTemperature:{xtype:"textfield",allowBlank:true},comments:{xtype:"textfield",allowBlank:true},volumeToLoad:{xtype:"numberfield",allowBlank:true},transmission:{xtype:"numberfield",allowBlank:true},viscosity:a,waitTime:{xtype:"numberfield",allowBlank:true},flow:{xtype:"checkbox",allowBlank:true}}});
this.measurementGrid.onSelected.attach(function(g,e){var h=[];for(var f=0;f<e.length;f++){h.push(d.experiment.getSampleById(e[f].specimenId));}});this.measurementGrid.onMeasurementChanged.attach(function(e,f){d.experiment.setMeasurement(f);d.refresh(d.experiment);});this.measurementGrid.onExperimentChanged.attach(function(f,e){d.refresh(new Experiment(e));
});this.measurementGrid.onRemoved.attach(function(f,e){d.refreshSpecimen(new Experiment(e));});this.measurementGrid.onUpdateTime.attach(function(f,e){document.getElementById(d.id+"_counter").innerHTML=e.hours+"h,  "+e.minutes+"min and "+e.seconds+" seconds";});this.specimenGrid=new SpecimenGrid({minHeight:425,selectionMode:"SINGLE",editEnabled:false,updateRowEnabled:true,width:900,showTitle:false});
this.specimenGrid.onSpecimenChanged.attach(function(e,f){d.experiment.setSpecimenById(f);d.refresh(d.experiment);});this.specimenGrid.onSelected.attach(function(e,f){if(f.length>0){d.specimenSelected=f[0];}else{d.specimenSelected=null;}d.samplePlateGroupWidget.selectSpecimens(f);});}TemplateTabs.prototype.refreshMeasurement=function(a){this.experiment=a;
this.experiment.onSaved=new Event(this);this.experiment.onSpecimenSaved=new Event(this);var b=new ExperimentList([this.experiment]);this.measurementGrid.refresh(b.getMeasurementsNotCollected(),b);};TemplateTabs.prototype.refreshSpecimen=function(a){this.experiment=a;this.experiment.onSaved=new Event(this);
this.experiment.onSpecimenSaved=new Event(this);this.samplePlateGroupWidget.refresh(this.experiment);this.specimenGrid.refresh(this.experiment);this.volumePlanificator.refresh(this.experiment);};TemplateTabs.prototype.refresh=function(a){this.experiment=a;this.experiment.onSaved=new Event(this);this.experiment.onSpecimenSaved=new Event(this);
this.refreshMeasurement(a);this.refreshSpecimen(a);this.panel.setLoading(false);};TemplateTabs.prototype.error=function(a){var b=JSON.parse(a);showError(b);this.panel.setLoading(false);};TemplateTabs.prototype.draw=function(a){this.render(a);};TemplateTabs.prototype.getAssemblyTitle=function(){return"Assemblies";
};TemplateTabs.prototype.getMacromoleculeTitle=function(){return"Macromolecules";};TemplateTabs.prototype.getBuffersTitle=function(){return"Buffers";};TemplateTabs.prototype.getPlateGroupsTitle=function(){return"Plate Groups";};TemplateTabs.prototype.getSampleChangerTitle=function(){return"Sample Changer";
};TemplateTabs.prototype.getSpecimenTitle=function(){return"Solution/Specimens";};TemplateTabs.prototype.getPlatesTitle=function(){return"Plates";};TemplateTabs.prototype.getSpecimenContainerHeight=function(b){var c=0;if(c<b.getSamples().length+1){c=b.getSamples().length+1;}var a=(c+1)*40+40;if(a>400){a=400;
}return a;};TemplateTabs.prototype.getGeneralContainerHeight=function(b){var c=0;if(c<b.getExperimentMacromolecules().length){c=b.getExperimentMacromolecules().length;}if(c<b.getBuffers().length){c=b.getBuffers().length;}var a=(c+1)*40+40;if(a>200){a=200;}return a;};TemplateTabs.prototype.getExperimentTitle=function(){var b=this;
var a=new ExperimentHeaderForm();return a.getPanel(this.experiment);};TemplateTabs.prototype.render=function(b){var e=this;this.experiment=b;var c=Ext.create("Ext.container.Container",{type:"vbox",minHeight:425,border:0,width:1000,padding:"5px",items:[this.specimenGrid.getPanelByExperiment(b),this.samplePlateGroupWidget.getPanel(b)]});
var d=new ExperimentList([e.experiment]);var a=Ext.create("Ext.container.Container",{layout:{type:"vbox"},defaults:{style:{padding:"5px 0px 0px 10px"}},items:[e.measurementGrid.getPanel(d.getMeasurementsNotCollected(),d)]});this.panel=Ext.createWidget("tabpanel",{plain:true,style:{padding:2},items:[{tabConfig:{title:"Measurements"},items:[{xtype:"container",layout:"vbox",border:1,height:e.gridHeight,flex:1,items:[a]}]},{tabConfig:{id:"genralTabl",title:"Specimens"},items:[c]},{tabConfig:{title:"Requirements"},items:[{html:BUI.getTipHTML("Estimated volume is the maximum volume required. Depending on the order of your measurements you may use less. Click on create stock solutions if you plan to ship these stock solutions"),margin:"10 10 10 10",border:0},this.volumePlanificator.getPanel(b)]}]});
return this.getPanel(this.panel);};TemplateTabs.prototype.isTemplate=function(){if(this.experiment.json.type=="TEMPLATE"){return true;}return false;};TemplateTabs.prototype.getPanel=function(a){var b=this;if(this.experimentPanel==null){this.experimentPanel=Ext.create("Ext.container.Container",{bodyPadding:2,width:Ext.getBody().getViewSize().width*0.9,renderTo:this.targetId,style:{padding:2},items:[this.getExperimentTitle(),this.panel],listeners:{afterrender:function(c){$("#SchemeReport"+b.experiment.experimentId).click(function(){$(this).target="_blank";
window.open("viewProjectList.do?reqCode=display&menu=platescheme&experimentId="+b.experiment.experimentId);return false;});}}});}return this.experimentPanel;};TemplateTabs.prototype.input=function(a){return new ExperimentTabs().input();};TemplateTabs.prototype.test=function(b){var a=new TemplateTabs(b);
BIOSAXS.proposal=new Proposal(a.input().proposal);a.draw(new Experiment(a.input().experiment));};var BUI={interval:6000,rainbow:function(p,e){var a,l,o;var k=e/p;var j=~~(k*6);var m=k*6-j;var d=1-m;switch(j%6){case 0:a=1,l=m,o=0;break;case 1:a=d,l=1,o=0;break;case 2:a=0,l=1,o=m;break;case 3:a=0,l=d,o=1;
break;case 4:a=m,l=0,o=1;break;case 5:a=1,l=0,o=d;break;}var n="#"+("00"+(~~(a*255)).toString(16)).slice(-2)+("00"+(~~(l*255)).toString(16)).slice(-2)+("00"+(~~(o*255)).toString(16)).slice(-2);return(n);},getFileNameByPath:function(b){if(b!=null){var a=b.split("/");if(a.length>0){return a[a.length-1];
}}return"Not file";},getUpdateInterval:function(){this.interval=this.interval+2000;return this.interval;},getRadiationDamageThreshold:function(){return 0.7;},getQualityThreshold:function(){return 0.7;},getCreateShipmentURL:function(){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=create_shipment";
},getCreateShipmentList:function(){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=list_shipment";},getShippingURL:function(a){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=shipment&shippingId="+a;},getMacromoleculeResultsURLByMultipleSearch:function(a){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=macromolecule&search="+JSON.stringify(a).replace(new RegExp('"',"g"),"'");
},getMacromoleculeResultsURL:function(a){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=macromolecule&macromoleculeId="+a;},getMacromoleculeBufferResultsURL:function(b,a){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=macromolecule&bufferId="+a+"&macromoleculeId="+b;},getMacromoleculeHeader:function(b){function a(d){if(d!=null){var c=BUI.createFormLabel("Name :",BIOSAXS.proposal.getMacromoleculeById(d).name,75,400);
c=c+BUI.createFormLabel("Acronym :",BIOSAXS.proposal.getMacromoleculeById(d).acronym,75,400);if(BIOSAXS.proposal.getMacromoleculeById(d).comments!=null){c=c+BUI.createFormLabel("Comments :",BIOSAXS.proposal.getMacromoleculeById(d).comments,75,400);}return c;}}return Ext.create("Ext.container.Container",{frame:false,layout:"hbox",title:"Macromolecule",bodyPadding:"5",width:890,margin:"0 0 10 0",height:100,style:{borderColor:"#BDBDBD",borderStyle:"solid",borderWidth:"1px"},fieldDefaults:{msgTarget:"side",labelWidth:100},items:[{margin:"10 0 0 10",width:475,border:0,html:a(b)},{margin:"10 0 0 10",width:475,border:0,html:BUI.getZipHTMLByMacromoleculeId(b)}]});
},getZipHTMLByMacromoleculeId:function(a){if(a!=null){var b=BIOSAXS.proposal.getMacromoleculeById(a).acronym;return"<div><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getZipFileByMacromoleculeId&fileName="+b+"&macromoleculeId="+a+"'><img src='../images/download.png' /> Download</a></div>";
}},getZipHTMLByExperimentId:function(b,a){if(a==null){a="experiment";}return"<div><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getZipFileByExperimentId&fileName="+a+"&experimentId="+b+"'><img src='../images/download.png' /> Download</a></div>";},getZipHTMLByFrameRangeId:function(b,d,a){var c="experiment";
return"<div><a style='color:blue;' href='/ispyb/user/dataadapter.do?reqCode=getZipFileH5ByFramesRange&f&experimentId="+b+"&start="+Number(d)+"&end="+Number(a)+"'><img src='../images/download.png' /> Download</a></div>";},getZipFrameHPLCUrl:function(b,c,a){return"/ispyb/user/dataadapter.do?reqCode=getZipFileH5ByFramesRange&f&experimentId="+b+"&start="+Number(c)+"&end="+Number(a);
},getStandardDeviation:function(h){var f=0;var e=0;var d=null;var j=new Array();for(var c=0;c<h.length;c++){var g=h[c];if(g!=null){if(!isNaN(g)){e=e+1;f=f+Number(g);j.push(Number(g));}}}if(e>0){d=f/e;}else{d=f;}var a=0;for(var c=0;c<j.length;c++){var g=j[c];a=a+Math.pow(g-d,2);}var b=Math.sqrt(a/e);return{std:(b),sum:(f),avg:(d),validNumber:e,totalNumber:h.length,values:h};
},getHTMLTableForFrameAveraged:function(d,h,j,l,e,c,b,m,a){function i(n,o){return"<td style='font:normal 9px tahoma,arial,verdana,sans-serif;color:"+"black"+"'>("+n+" of "+o+")</td>";}function k(n,o){if(n/o<0.5){return"#FA5858";}if((n/o>=0.5)&&(n/o<0.8)){return"#FF9900";}return"white";}function g(p,o,n,q){return"<tr style='background-color:"+k(n,q)+";height:12px;padding:1px;'><td style=' width:10px; height:10px;'> "+BUI.getRectangleColorDIV(p,10,10)+"</td> <td style='padding:5px;'> "+o+"</td>"+i(n,q)+"</tr>";
}var f="<table style='margin: 1,1,1,1;width:100%;font:normal 10px tahoma,arial,verdana,sans-serif;'>";if(d!=null){if(j!=null){color=BIOSAXS.proposal.bufferColors[b];f=f+g(color,d,j,c);}}if(h!=null){if(l!=null){if(a==null){color=BIOSAXS.proposal.macromoleculeColors[m];}else{color=a;}f=f+g(color,h,l,c);
}}if(d!=null){if(e!=null){color=BIOSAXS.proposal.bufferColors[b];f=f+g(color,d,e,c);}}return f+"</table>";},isWebGLEnabled:function(c){if(!!window.WebGLRenderingContext){var a=document.createElement("canvas");names=["webgl","experimental-webgl","moz-webgl","webkit-3d"];context=false;for(var b=0;b<4;b++){try{context=a.getContext(names[b]);
if(context&&typeof context.getParameter=="function"){if(c){return{name:names[b],gl:context};}return true;}}catch(d){}}return false;}return false;},getHTMLTableForPrefixes:function(d,e,c){function b(g){file=g;try{file=g.split("/")[g.split("/").length-1];}catch(f){file="NA";}return"<tr><td  style='height:12px;padding:5px;'>"+file+"</td></tr>";
}var a="<table style='margin: 1,1,1,1;width:100%;font:normal 10px tahoma,arial,verdana,sans-serif;'>";if(d!=null){a=a+b(d);}if(e!=null){a=a+b(e);}if(c!=null){a=a+b(c);}return a+"</table>";},getBaseURL:function(){return"/ispyb/user/dataadapter.do";},getPrintcomponentURL:function(a){return"/ispyb/user/viewDewarAction.do?reqCode=generateLabels&dewarId="+a;
},getPDBVisualizerURL:function(c,a,b){return"/ispyb/user/viewProjectList.do?reqCode=display&menu=PDBVisualizer&modelId="+c+"&experimentId="+b+"&subtractionId="+a;},getURL:function(){return this.getBaseURL()+"?reqCode=getImage";},getAbinitioImageURL:function(){return this.getBaseURL()+"?reqCode=getAbinitioImage";
},getNSDImageURL:function(a){return BUI.getAbinitioImageURL()+"&type=NSD&modelListId="+a;},getCHI2ImageURL:function(a){return BUI.getAbinitioImageURL()+"&type=CHI2&modelListId="+a;},getModelFile:function(a,c,b){return this.getBaseURL()+"?reqCode=getModelFile"+"&type="+a+"&modelId="+c+"&format="+b;},getPdbURL:function(){return this.getBaseURL()+"?reqCode=getPdbFiles";
},getStvArray:function(b,a){b=Number(b);a=Number(a);return[b-a,b,b+a];},getPointArrayForDygraph:function(a,c,b){return[a,BUI.getStvArray(c,b)];},createDIV:function(f,d,c,a){var b=document.createElement("div");var e=document.createElement("span");if(c!=null){e.setAttribute("class",c);}if(a!=null){e.setAttribute("style","float:left;width:"+d+"px;height:18px;background-color:"+a);
}else{e.setAttribute("style","float:left;width:"+d+"px;height:18px;");}e.appendChild(document.createTextNode(f));b.appendChild(e);return b;},createFormLabel:function(c,e,a,d,b){var f=document.createElement("div");f.appendChild(BUI.createDIV(c,a,"bLabel",b));f.appendChild(BUI.createDIV(e,d,"btext",b));
return f.innerHTML;},createTextArea:function(b,f,a,c,d){var g=document.createElement("div");g.appendChild(BUI.createDIV(b,a,"bLabel"));var e=document.createElement("textarea");e.setAttribute("rows",c);e.setAttribute("cols",d);e.appendChild(document.createTextNode(f));g.appendChild(e);return g.innerHTML;
},showBetaWarning:function(){alert("ISPyB for Biosaxs version Beta has not this functionality enabled");},formatValuesErrorUnitsScientificFormat:function(a,f,h,e){var i=14;var b=2;var c=10;var g=true;if(e!=null){if(e.fontSize!=null){i=e.fontSize;}if(e.decimals!=null){b=e.decimals;}if(e.errorFontSize!=null){c=e.errorFontSize;
}if(e.lineBreak!=null){g=e.lineBreak;}}if(a==""){return"";}if(f==null){return"<span style='font-size:"+i+"px'>"+Number(a).toFixed(b)+"</span>";}var d="<span style='font-size:"+i+"px'>"+Number(a).toFixed(b)+"<span style='font-size:"+c+"px;color:gray'>  "+h+"</span></span>";if(g){d=d+"<br/>";}return d+"<span style='font-size:"+c+"px'> &#177; "+Number(Number(f).toFixed(3)).toExponential()+"</span></span>";
},formatValuesErrorUnits:function(a,f,h,e){var i=16;var b=2;var c=10;var g=true;if(e!=null){if(e.fontSize!=null){i=e.fontSize;}if(e.decimals!=null){b=e.decimals;}if(e.errorFontSize!=null){c=e.errorFontSize;}if(e.lineBreak!=null){g=e.lineBreak;}}if(a==""){return"";}if(f==null){return"<span style='font-size:"+i+"px'>"+Number(a).toFixed(b)+"</span>";
}var d="<span style='font-size:"+i+"px'>"+Number(a).toFixed(b)+"<span style='font-size:"+c+"px;color:gray'>  "+h+"</span></span>";if(g){d=d+"<br/>";}return d+"<span style='font-size:"+c+"px'> &#177; "+Number(Number(f).toFixed(8)).toExponential()+"</span></span>";},formatValuesUnits:function(f,c,b){var e=12;
var a=2;var d=10;if(b!=null){if(b.fontSize!=null){e=b.fontSize;}if(b.decimals!=null){a=b.decimals;}if(b.unitsFontSize!=null){d=b.unitsFontSize;}}if(f===""){return"";}if(c==null){return"<span style='font-size:"+e+"px'>"+Number(f).toFixed(a)+"</span>";}return"<span style='font-size:"+e+"px'>"+Number(f).toFixed(a)+" </span><span style='font-size:"+d+"px;color:gray'>  "+c+"</span></span>";
},getGreenButton:function(d,b){var c=70;var a=20;if(b!=null){if(b.width!=null){c=b.width;}if(b.height!=null){a=b.height;}}return'<input type="button" name="btn" style= "width:'+c+"px; height:"+a+'px" class="btn-green" value="'+d+'"/>';},getBlueButton:function(e,c){var d=70;var a=20;var b=null;if(c!=null){if(c.width!=null){d=c.width;
}if(c.height!=null){a=c.height;}if(c.href!=null){b=c.href;}}if(b!=null){return"<a href="+b+'><input type="button"  name="btn" style= "width:'+d+"px; height:"+a+'px" class="btn-blue" value="'+e+'"></input></a>';}else{return'<a><input type="button"  name="btn" style= "width:'+d+"px; height:"+a+'px" class="btn-blue" value="'+e+'"></input></a>';
}},getSubmitGreenButton:function(a){return'<input type="submit" type="button" name="btn" class="btn-green" value="'+a+'"/>';},getRedButton:function(a){return'<input type="button"  name="btn" class="btn-red" value="'+a+'" />';},getRectangleColorDIV:function(b,a,c){return'<div style="border: 1px solid gray;background-color: '+b+"; height:"+a+"px;width:"+c+'px" ></div>';
},openBufferWindow:function(a){var b=new BufferWindow();b.draw(tabs.experiment.getBufferById(a),tabs.experiment);},safetyRenderer:function(b,d,c){var a=b;if(b=="YELLOW"){a="#E9AB17";}return'<span style="color:'+a+';">'+b+"</span>";},getSampleColor:function(){return"#CB181D";},getLightSampleColor:function(){return"#FCBBA1";
},getBufferColor:function(){return"#6A51A3";},getLightBufferColor:function(){return"#BCBDDC";},formatConcentration:function(a){if(a!=null){return"<span style='font-size:16px'>"+Number(a).toFixed(2)+"</span><span style='font-size:9px'> mg/ml </span>";}return a;},formatVolume:function(b,a){if(Number(b.data.volumeToLoad)>Number(b.data.volume)){return"<span style='color:red;font-weight:bold;'>"+a+"</span><span style='font-size:9;color:red;'> l</span>";
}if(Number(b.data.volumeToLoad)==Number(b.data.volume)){return"<span style='color:orange;font-weight:bold;'>"+a+"</span><span style='font-size:9;color:orange;'> l</span>";}return"<span>"+a+"</span><span style='font-size:9'> l</span>";},getProposal:function(){return new Proposal();},getSampleNameRenderer:function(c,d,a){var b=a.data;
if(a.raw.macromolecule3VO==null){return'<span style="color:blue;">'+b.code+"</span>";}else{return'<span style="color:green;">'+b.code+"</span>";}},getSafetyLevels:function(){var a=new Array();a.push({safetyLevelId:"",name:"UNKNOWN"});a.push({safetyLevelId:1,name:"GREEN"});a.push({safetyLevelId:2,name:"YELLOW"});
a.push({safetyLevelId:3,name:"RED"});return a;},getErrorColor:function(){return"#F6CED8";},getWarningColor:function(){return"#F5DA81";},getValidColor:function(){return"#E0F8E0";},getSamplePlateLetters:function(){return["A","B","C","D","E","F","G","H"];},getSamplePositionHTML:function(e,a){var b="";var g="";
var d="";var f=this.getSamplePlateLetters();if(e.sampleplateposition3VO!=null){var h=a.getSamplePlateById(e.sampleplateposition3VO.samplePlateId);if(h!=null){b=(h.slotPositionColumn);g=(e.sampleplateposition3VO.rowNumber);d=(e.sampleplateposition3VO.columnNumber);var c="<span style='font-weight:italic'>Plate: </span><span style='font-weight:bold'>"+b+"</span>-<span style='font-weight:bold'>"+f[g-1]+"</span><span style='font-weight:bold'>"+d+"</span>";
return c;}}return"";},getSafetyLabelName:function(c){var a=BUI.getSafetyLevels();for(var b=0;b<a.length;b++){if(a[b].safetyLevelId==c){return a[b].name;}}return"UNKNOWN";},id:function(){var c="";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var b=0;b<5;b++){c+=a.charAt(Math.floor(Math.random()*a.length));
}return c;},showWarning:function(a){Ext.Msg.show({title:"Warning",msg:a,icon:Ext.Msg.WARNING,animEl:"elId"});},showError:function(a){Ext.Msg.show({title:"Warning",msg:a,icon:Ext.Msg.ERROR,animEl:"elId"});},getTipHTML:function(a){return"<div  class='panelMacro' ><table class='tipMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/check.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Tip</b><br clear='none'>"+a+"</td></tr></tbody></table></div>";
},getWarningHTML:function(a){return"<div class='panelMacro' ><table class='warningMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/warning.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Warning</b><br clear='none'>"+a+"</td></tr></tbody></table></div>";
},getErrorHTML:function(a){return"<div class='panelMacro' ><table class='errorMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/forbidden.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Error</b><br clear='none'>"+a+"</td></tr></tbody></table></div>";
},getProgessBar:function(a,d){var b="#0a0";b="#99CC00";if(a>100){b="yellow";a=100;}if(isNaN(a)){b="white";a=0;}var c=a+"%";if(d!=null){c=d;}return"<div class='meter-wrap'><div class='meter-value' style='background-color: "+b+" ; width: "+a+"%;'><div class='meter-text'>"+c+"</div></div></div>";}};Ext.ux.form.RequiredCombo=Ext.extend(Ext.form.ComboBox,{config:{cls:"custom-field-text-required"},initComponent:function(){Ext.ux.form.RequiredCombo.superclass.initComponent.apply(this,arguments);
},checkChange:function(){if((this.getValue()==null)||String(this.getValue()).length==0){this.addCls("custom-field-text-required");}else{this.removeCls("custom-field-text-required");}}});Ext.define("Ext.form.field.RequiredNumber",{extend:"Ext.form.field.Number",alias:"widget.requirednumberfield",alternateClassName:["Ext.form.RequiredNumberField","Ext.form.RequiredNumber"],config:{cls:"custom-field-text-required"},initComponent:function(){var a=this;
a.callParent();a.setMinValue(a.minValue);a.setMaxValue(a.maxValue);},onChange:function(){if((this.getValue()==null)||String(this.getValue()).length==0){this.addCls("custom-field-text-required");}else{this.removeCls("custom-field-text-required");}this.toggleSpinners();this.callParent(arguments);}});Ext.define("Ext.form.field.RequiredText",{extend:"Ext.form.field.Text",alias:"widget.requiredtext",requires:["Ext.form.field.VTypes","Ext.layout.component.field.Text"],alternateClassName:["Ext.form.RequiredTextField","Ext.form.RequiredText"],config:{cls:"custom-field-text-required"},initComponent:function(){var a=this;
if(a.allowOnlyWhitespace===false){a.allowBlank=false;}a.callParent();a.addEvents("autosize","keydown","keyup","keypress");a.addStateEvents("change");a.setGrowSizePolicy();},checkChange:function(){if((this.getValue()==null)||String(this.getValue()).length==0){this.addCls("custom-field-text-required");
}else{this.removeCls("custom-field-text-required");}}});var BIOSAXS_COMBOMANAGER={getComboMacromoleculeByMacromolecules:function(c,d){var a=150;var f="0 0 5 0";var e=300;if(d!=null){if(d.labelWidth!=null){a=d.labelWidth;}if(d.margin!=null){f=d.margin;}if(d.width!=null){e=d.width;}}var b=Ext.create("Ext.data.Store",{fields:["macromoleculeId","acronym"],data:c,sorters:["acronym"]});
return Ext.create("Ext.form.ComboBox",{fieldLabel:"Macromolecules",labelWidth:a,width:e,margin:f,store:b,queryMode:"local",displayField:"acronym",valueField:"macromoleculeId"});},getComboBuffers:function(b,e){var a=150;var g="0 0 5 0";var f=300;var d="Buffer";if(e!=null){if(e.labelWidth!=null){a=e.labelWidth;
}if(e.margin!=null){g=e.margin;}if(e.width!=null){f=e.width;}if(e.noLabel!=null){d=null;}}var c=Ext.create("Ext.data.Store",{fields:["bufferId","acronym"],data:b,sorters:["acronym"]});return Ext.create("Ext.form.ComboBox",{fieldLabel:d,labelWidth:a,width:f,margin:g,store:c,queryMode:"local",displayField:"acronym",valueField:"bufferId"});
},getComboSessions:function(g,c){var a=150;var f="0 0 5 0";var e=300;if(c!=null){if(c.labelWidth!=null){a=c.labelWidth;}if(c.margin!=null){f=c.margin;}if(c.width!=null){e=c.width;}}for(var d=0;d<g.length;d++){g[d]["startDateFormatted"]=moment(g[d].startDate).format("MMM Do YY");g[d]["sorter"]=moment(g[d].startDate).format("YYYYMMDD");
}var b=Ext.create("Ext.data.Store",{fields:["sessionId","startDateFormatted","beamlineName","startDate","endDate","beamlineOperator"],data:g,sorters:["sorter"]});return Ext.create("Ext.form.ComboBox",{fieldLabel:"Sessions",labelWidth:a,width:e,margin:f,store:b,queryMode:"local",valueField:"sessionId",tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="x-boundlist-item">{startDateFormatted}<span style="font-weight:bold"> {beamlineName}</span></div>',"</tpl>"),displayTpl:Ext.create("Ext.XTemplate",'<tpl for=".">',"{startDateFormatted}","</tpl>")});
}};function GenericWindow(a){this.title="title";this.width=700;this.height=500;this.id=BUI.id();this.close=false;this.draggable=true;this.modal=true;if(a!=null){if(a.actions!=null){this.actions=a.actions;}if(a.form!=null){this.form=a.form;}if(a.width!=null){this.width=a.width;}if(a.modal!=null){this.modal=a.modal;
}if(a.height!=null){this.height=a.height;}if(a.title!=null){this.title=a.title;}if(a.form!=null){this.form=a.form;}if(a.close!=null){this.close=a.close;}if(a.draggable!=null){this.draggable=a.draggable;}}this.onSaved=new Event(this);}GenericWindow.prototype.getButtons=function(){var a=this;if(this.close){return[{text:"Close",handler:function(){a.panel.close();
}}];}else{return[{text:"Save",handler:function(){a.save();}},{text:"Cancel",handler:function(){a.panel.close();}}];}};GenericWindow.prototype.save=function(){alert("Method save of GenerciWindow class is abstract");};GenericWindow.prototype._postRender=function(b,a){};GenericWindow.prototype.draw=function(b,a){this._render(b,a);
};GenericWindow.prototype.refresh=function(b,a){this.data=b;this.experiment=a;this.form.refresh(b,a);};GenericWindow.prototype._render=function(b,a){this.data=b;var c=this;if(this.panel==null){this.panel=Ext.create("Ext.Window",{id:this.id,title:this.title,resizable:true,constrain:true,border:1,modal:this.modal,frame:false,draggable:this.draggable,closable:true,autoscroll:true,layout:{type:"vbox",align:"stretch"},width:this.width,height:this.form.height,buttonAlign:"right",buttons:this.getButtons(),items:this.form.getPanel(b,a),listeners:{scope:this,minimize:function(){this.panel.hide();
},destroy:function(){delete this.panel;}}});this.panel.setLoading();}this.panel.show();this._postRender();};function CalendarWidget(a){this.height=740;if(a!=null){if(a.height!=null){this.height=a.height;}}this.onClick=new Event();}CalendarWidget.prototype.loadData=function(d){this.events=[];for(var b=0;
b<d.length;b++){var a=moment(d[b].creationDate);var c="black";if(d[b].status=="FINISHED"){c="green";}if(d[b].status=="ABORTED"){c="red";}this.events.push({title:d[b].name,start:a.format("YYYY-MM-DD HH:mm:ss"),end:a.format("YYYY-MM-DD HH:mm:ss"),date:a,allDay:false,color:c,className:a.format("YYYY-MM-DD")});
}};CalendarWidget.prototype.draw=function(a){var b=this;$("#"+a).fullCalendar({eventClick:function(e,d,c){b.onClick.notify(e.className[0]);},contentHeight:b.height,header:{left:"prev,next today",center:"title",right:"month,basicWeek,basicDay"},editable:false,events:this.events});};function ConcentrationHTMLTableWidget(a){this.id=BUI.id();
this.showBufferColumns=true;if(a!=null){if(a.height!=null){this.height=a.height;}if(a.showBufferColumns!=null){this.showBufferColumns=a.showBufferColumns;}}}ConcentrationHTMLTableWidget.prototype.refresh=function(a){document.getElementById(this.id).innerHTML=this.getPanel(a);};ConcentrationHTMLTableWidget.prototype.getPanel=function(f){var b="<div  style='overflow-y: auto;height:"+this.height+"px;'; id='"+this.id+"'>";
b=b+"<table class='ver-minimalist'  style='width:880px;'>";b=b+"<tr>";b=b+"<th rowspan='2' >Concentration</th>";if(this.showBufferColumns){b=b+"<th rowspan='2' >Buffer</th>";}b=b+"<th  colspan='2'>Measurements</th>";b=b+"<th  colspan='3'>Guinier</th>";b=b+"<th  colspan='3'>Gnom</th>";b=b+"</tr>";b=b+"<tr>";
b=b+"<th>Passed</th>";b=b+"<th>Discarded</th>";b=b+"<th>Rg</th>";b=b+"<th>I0</th>";b=b+"<th>Quality</th>";b=b+"<th>Rg</th>";b=b+"<th>dMax</th>";b=b+"</tr>";f.concentration.concentrations.sort(function(h,g){return h.concentration-g.concentration;});for(var a=0;a<f.concentration.concentrations.length;a++){var e=f[a];
var d="<tr>";if(a%2==1){d="<tr class='ver-minimalist-odd'>";}var c=(f.concentration.concentrations[a].frames.length-f.concentration.concentrations[a].frames_warning);if(c==0){d="<tr class='ver-minimalist-error'>";}b=b+d;b=b+"<td>"+f.concentration.concentrations[a].concentration+"</td>";if(this.showBufferColumns){b=b+"<td>"+f.concentration.concentrations[a].bufferAcronym+"</td>";
}b=b+"<td><span style='color:green;font-weight:bold;'>"+c+"</span> of "+f.concentration.concentrations[a].frames.length+"</td>";b=b+"<td style='color:orange;font-weight:bold;'>"+f.concentration.concentrations[a].frames_warning+"</td>";b=b+"<td>"+BUI.formatValuesErrorUnits(f.concentration.concentrations[a].calculation.rgGuinier.avg,f.concentration.concentrations[a].calculation.rgGuinier.std,"nm",{lineBreak:false})+"</td>";
b=b+"<td>"+BUI.formatValuesErrorUnits(f.concentration.concentrations[a].calculation.i0Guinier.avg,f.concentration.concentrations[a].calculation.i0Guinier.std," ",{lineBreak:false})+"</td>";b=b+"<td>"+BUI.formatValuesErrorUnits(f.concentration.concentrations[a].calculation.quality.avg,f.concentration.concentrations[a].calculation.quality.std," ",{lineBreak:false})+"</td>";
b=b+"<td>"+BUI.formatValuesErrorUnits(f.concentration.concentrations[a].calculation.rgGnom.avg,f.concentration.concentrations[a].calculation.rgGnom.std," ",{lineBreak:false})+"</td>";b=b+"<td>"+BUI.formatValuesErrorUnits(f.concentration.concentrations[a].calculation.dMax.avg,f.concentration.concentrations[a].calculation.dMax.std," ",{lineBreak:false})+"</td>";
b=b+"</tr>";}return b+"</table>";};ConcentrationHTMLTableWidget.prototype.input=function(){return{data:{"dataCollectionCount":4,"buffers":[{"bufferId":"422"}],"concentration":{"concentrations":[{"concentration":"7.17","id":"7.1699999999999999","bufferId":"422.00","bufferAcronym":"B1","rgGuinier":["5.12723"],"frames":[{"total":"0.515705406286","bufferBeforeMeasurementId":15045,"sampleMergeId":8176,"averagedModelId":null,"I0":"183.457461646","proposalCode":"OPD","averagedModel":null,"bufferAfterMergeId":8177,"framesCount":"10","bufferBeforeMergeId":8175,"averageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_065_ave.dat","bufferAfterMeasurementId":15048,"rgGuinier":"5.12723","subtractedFilePath":" /data/pyarch/bm29/opd29/700/1d/data_065_sub.dat","firstPointUsed":"17","chi2RgFilePath":null,"abInitioModelId":null,"macromoleculeId":649,"code":"_4.0_7.17","transmission":"100.0","timeStart":"2013-06-05 15:43:54.348723","bufferAcronym":"B1","quality":"0.853011","shapeDeterminationModelId":null,"expermientComments":"[BsxCube] Generated from BsxCube","bufferId":422,"isagregated":"False","dmax":"25.63615","bufferBeforeAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_064_ave.dat","exposureTemperature":"4.0","subtractionId":3377,"conc":"7.1699999999999999","rapidShapeDeterminationModel":null,"experimentCreationDate":"Jun 5, 2013 3:30:30 PM","lastPointUsed":"36","modelListId":null,"framesMerge":"9","rapidShapeDeterminationModelId":null,"bufferAfterAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_066_ave.dat","nsdFilePath":null,"bufferAfterFramesMerged":"10","experimentId":700,"macromoleculeAcronym":"L9","i0stdev":"0.139364435146","sampleMeasurementId":15047,"measurementComments":"[5]","priorityLevelId":10,"bufferBeforeFramesMerged":"10","substractionCreationTime":"Jun 5, 2013 3:46:31 PM","proposalNumber":"29","rgGnom":"5.40297914939","volume":"475.302","shapeDeterminationModel":null,"comments":null,"groupeField":"L9 B1"}],"frames_warning":0,"calculation":{"rgGuinier":{"std":0,"sum":5.12723,"avg":5.12723,"validNumber":1,"totalNumber":1,"values":["5.12723"]},"i0Guinier":{"std":0,"sum":183.457461646,"avg":183.457461646,"validNumber":1,"totalNumber":1,"values":["183.457461646"]},"quality":{"std":0,"sum":0.853011,"avg":0.853011,"validNumber":1,"totalNumber":1,"values":["0.853011"]},"rgGnom":{"std":0,"sum":5.40297914939,"avg":5.40297914939,"validNumber":1,"totalNumber":1,"values":["5.40297914939"]},"dMax":{"std":0,"sum":25.63615,"avg":25.63615,"validNumber":1,"totalNumber":1,"values":["25.63615"]}}},{"concentration":"3.53","id":"3.5299999999999998","bufferId":"422.00","bufferAcronym":"B1","rgGuinier":["4.38278"],"frames":[{"total":"0.497164741078","bufferBeforeMeasurementId":15048,"sampleMergeId":8178,"averagedModelId":null,"I0":"160.023229462","proposalCode":"OPD","averagedModel":null,"bufferAfterMergeId":8179,"framesCount":"10","bufferBeforeMergeId":8177,"averageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_067_ave.dat","bufferAfterMeasurementId":15051,"rgGuinier":"4.38278","subtractedFilePath":" /data/pyarch/bm29/opd29/700/1d/data_067_sub.dat","firstPointUsed":"36","chi2RgFilePath":null,"abInitioModelId":null,"macromoleculeId":649,"code":"_4.0_3.53","transmission":"100.0","timeStart":"2013-06-05 15:47:04.630129","bufferAcronym":"B1","quality":"0.742825","shapeDeterminationModelId":null,"expermientComments":"[BsxCube] Generated from BsxCube","bufferId":422,"isagregated":"False","dmax":"15.33973","bufferBeforeAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_066_ave.dat","exposureTemperature":"4.0","subtractionId":3378,"conc":"3.5299999999999998","rapidShapeDeterminationModel":null,"experimentCreationDate":"Jun 5, 2013 3:30:30 PM","lastPointUsed":"61","modelListId":null,"framesMerge":"10","rapidShapeDeterminationModelId":null,"bufferAfterAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_068_ave.dat","nsdFilePath":null,"bufferAfterFramesMerged":"10","experimentId":700,"macromoleculeAcronym":"L9","i0stdev":"0.1499898017","sampleMeasurementId":15050,"measurementComments":"[6]","priorityLevelId":12,"bufferBeforeFramesMerged":"10","substractionCreationTime":"Jun 5, 2013 3:49:42 PM","proposalNumber":"29","rgGnom":"4.40615474861","volume":"372.656","shapeDeterminationModel":null,"comments":null,"groupeField":"L9 B1"}],"frames_warning":0,"calculation":{"rgGuinier":{"std":0,"sum":4.38278,"avg":4.38278,"validNumber":1,"totalNumber":1,"values":["4.38278"]},"i0Guinier":{"std":0,"sum":160.023229462,"avg":160.023229462,"validNumber":1,"totalNumber":1,"values":["160.023229462"]},"quality":{"std":0,"sum":0.742825,"avg":0.742825,"validNumber":1,"totalNumber":1,"values":["0.742825"]},"rgGnom":{"std":0,"sum":4.40615474861,"avg":4.40615474861,"validNumber":1,"totalNumber":1,"values":["4.40615474861"]},"dMax":{"std":0,"sum":15.33973,"avg":15.33973,"validNumber":1,"totalNumber":1,"values":["15.33973"]}}},{"concentration":"1.75","id":"1.75","bufferId":"422.00","bufferAcronym":"B1","rgGuinier":[],"frames":[{"total":"0.5538035065","bufferBeforeMeasurementId":15051,"sampleMergeId":8180,"averagedModelId":null,"I0":"146.927428571","proposalCode":"OPD","averagedModel":null,"bufferAfterMergeId":8181,"framesCount":"10","bufferBeforeMergeId":8179,"averageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_069_ave.dat","bufferAfterMeasurementId":15054,"rgGuinier":"4.27139","subtractedFilePath":" /data/pyarch/bm29/opd29/700/1d/data_069_sub.dat","firstPointUsed":"33","chi2RgFilePath":null,"abInitioModelId":null,"macromoleculeId":649,"code":"_4.0_1.75","transmission":"100.0","timeStart":"2013-06-05 15:50:09.395824","bufferAcronym":"B1","quality":"0.765999","shapeDeterminationModelId":null,"expermientComments":"[BsxCube] Generated from BsxCube","bufferId":422,"isagregated":"False","dmax":"14.949865","bufferBeforeAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_068_ave.dat","exposureTemperature":"4.0","subtractionId":3379,"conc":"1.75","rapidShapeDeterminationModel":null,"experimentCreationDate":"Jun 5, 2013 3:30:30 PM","lastPointUsed":"62","modelListId":null,"framesMerge":"6","rapidShapeDeterminationModelId":null,"bufferAfterAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_070_ave.dat","nsdFilePath":null,"bufferAfterFramesMerged":"10","experimentId":700,"macromoleculeAcronym":"L9","i0stdev":"0.191914285714","sampleMeasurementId":15053,"measurementComments":"[7]","priorityLevelId":14,"bufferBeforeFramesMerged":"10","substractionCreationTime":"Jun 5, 2013 3:52:31 PM","proposalNumber":"29","rgGnom":"4.28379338749","volume":"356.326","shapeDeterminationModel":null,"comments":null,"groupeField":"L9 B1"}],"frames_warning":1,"calculation":{"rgGuinier":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"i0Guinier":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"quality":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"rgGnom":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"dMax":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]}}},{"concentration":"0.91","id":"0.91000000000000003","bufferId":"422.00","bufferAcronym":"B1","rgGuinier":[],"frames":[{"total":null,"bufferBeforeMeasurementId":15054,"sampleMergeId":8182,"averagedModelId":null,"I0":"0.0","proposalCode":"OPD","averagedModel":null,"bufferAfterMergeId":8183,"framesCount":"10","bufferBeforeMergeId":8181,"averageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_071_ave.dat","bufferAfterMeasurementId":15057,"rgGuinier":null,"subtractedFilePath":" /data/pyarch/bm29/opd29/700/1d/data_071_sub.dat","firstPointUsed":"0","chi2RgFilePath":null,"abInitioModelId":null,"macromoleculeId":649,"code":"_4.0_.91","transmission":"100.0","timeStart":"2013-06-05 15:52:58.133705","bufferAcronym":"B1","quality":"0.0","shapeDeterminationModelId":null,"expermientComments":"[BsxCube] Generated from BsxCube","bufferId":422,"isagregated":"False","dmax":null,"bufferBeforeAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_070_ave.dat","exposureTemperature":"4.0","subtractionId":3380,"conc":"0.91000000000000003","rapidShapeDeterminationModel":null,"experimentCreationDate":"Jun 5, 2013 3:30:30 PM","lastPointUsed":"0","modelListId":null,"framesMerge":"10","rapidShapeDeterminationModelId":null,"bufferAfterAverageFilePath":" /data/pyarch/bm29/opd29/700/1d/data_072_ave.dat","nsdFilePath":null,"bufferAfterFramesMerged":"10","experimentId":700,"macromoleculeAcronym":"L9","i0stdev":"0.0","sampleMeasurementId":15056,"measurementComments":"[8]","priorityLevelId":16,"bufferBeforeFramesMerged":"10","substractionCreationTime":"Jun 5, 2013 3:55:35 PM","proposalNumber":"29","rgGnom":null,"volume":null,"shapeDeterminationModel":null,"comments":null,"groupeField":"L9 B1"}],"frames_warning":1,"calculation":{"rgGuinier":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"i0Guinier":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"quality":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"rgGnom":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]},"dMax":{"std":null,"sum":0,"avg":0,"validNumber":0,"totalNumber":0,"values":[]}}}]},"concentrationLabel":"7.17 mg/ml ,3.53 mg/ml ,1.75 mg/ml ,0.91 mg/ml "}};
};ConcentrationHTMLTableWidget.prototype.test=function(b){var a=new ConcentrationHTMLTableWidget();document.getElementById(b).innerHTML=a.getPanel(a.input().data);};function DataCollectionWidget(){}DataCollectionWidget.prototype.refresh=function(a){};DataCollectionWidget.prototype.getMacromolecule=function(b){for(var a=0;
a<b.length;a++){if(b[a].macromoleculeId!=null){return BIOSAXS.proposal.getMacromoleculeById(b[a].macromoleculeId);}}return null;};DataCollectionWidget.prototype.getMacromoleculeContainer=function(d){var c=this.getMacromolecule(d);var b=false;if(c==null){b=true;}var a=(c==null?"":c.acronym);var f=(c==null?"":c.molecularMass);
var e=(c==null?"":c.comments);return Ext.create("Ext.Panel",{width:500,height:200,disabled:b,title:"Macromolecule",layout:"form",bodyPadding:5,defaultType:"textfield",tbar:{defaultButtonUI:"default",items:[{xtype:"button",text:"Edit",style:{borderColor:"#D1D1D1",borderStyle:"solid"},handler:function(){var g=new MacromoleculeWindow();
g.draw(c);}}]},items:[{fieldLabel:"Acronym",name:"first",readOnly:true,value:a},{fieldLabel:"Molecular Mass",name:"last",readOnly:true,value:f},{xtype:"textareafield",fieldLabel:"Comments",value:"",name:"last",readOnly:true,value:e}]});};DataCollectionWidget.prototype.getBufferContainer=function(b){var c=this;
var a=BIOSAXS.proposal.getBufferById(b[0].bufferId);return Ext.create("Ext.Panel",{width:500,height:200,title:"Buffer",layout:"form",bodyPadding:5,defaultType:"textfield",style:{padding:"0px 0px 0px 2px"},tbar:{defaultButtonUI:"default",items:[{xtype:"button",text:"Edit",style:{borderColor:"#D1D1D1",borderStyle:"solid"},handler:function(){var d=new BufferWindow();
d.draw(BIOSAXS.proposal.getBufferById(b[0].bufferId));}}]},items:[{fieldLabel:"Buffer",name:"acronym",readOnly:true,value:a.acronym},{fieldLabel:"Composition",name:"last",readOnly:true,value:a.composition},{xtype:"textareafield",fieldLabel:"Comments",value:a.comments,name:"last",readOnly:true}]});};DataCollectionWidget.prototype.getSpecimenContainer=function(a){return Ext.create("Ext.container.Container",{layout:{type:"hbox"},style:{margin:"10px 10px 10px 10px"},border:0,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},defaults:{labelWidth:80,xtype:"datefield",flex:1,},items:[this.getMacromoleculeContainer(a),this.getBufferContainer(a)]});
};DataCollectionWidget.prototype.getSeparator=function(){return{html:"<br/>",border:0};};DataCollectionWidget.prototype.getFitStructurePanel=function(b){var c=this;var a=this.getMacromolecule(b);if(a.structure3VOs!=null){if(a.structure3VOs.length>0){}}return Ext.create("Ext.container.Container",{layout:{type:"hbox"},style:{margin:"10px 10px 10px 10px"},border:0,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},defaults:{labelWidth:80,xtype:"datefield",flex:1},items:[]});
};DataCollectionWidget.prototype.getFitStructurePanelWorkflow=function(d){var e=this;var c=this.getMacromolecule(d);var b=[];var a=new FitStructureToExperimentDataGrid();a.refresh(e.data[0].subtractionId,e.getMacromolecule(d));return Ext.create("Ext.container.Container",{style:{margin:"10px 10px 10px 10px"},border:0,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},defaults:{labelWidth:80,xtype:"datefield",flex:1},items:[a.getPanel()],listeners:{afterrender:function(){}}});
};DataCollectionWidget.prototype.RUNFitScattering=function(c,d){var f=this;var b=new BiosaxsDataAdapter();var e={"workflowTitle":"FitExperimentalDatatoStructure","comments":"FitExperimentalDatatoStructure run from ISPyB for subtractionId: "+c+" and structureId "+d};var a=[{name:"subtractionId",value:c},{name:"structureId",value:d}];
b.onSuccess.attach(function(h,j){var i=new BiosaxsDataAdapter();var g={"workflowId":j.workflowId,"subtractionId":c,"structureId":d,"comments":"Sent to workflow engine"};i.onSuccess.attach(function(l,k){});i.addFitStructureData(g);});b.addWorkflow(e,a);};DataCollectionWidget.prototype.getAdvancedTab=function(a){var b=this;
return Ext.create("Ext.container.Container",{style:{margin:"10px 10px 10px 10px"},border:0,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"},items:[b.getFitStructurePanel(a),b.getFitStructurePanelWorkflow(a)]});};DataCollectionWidget.prototype.getTabs=function(a){var b=this;this.subtractionCurveVisualizer=new SubtractionCurveVisualizer();
this.tabs=Ext.createWidget("tabpanel",{activeTab:1,plain:true,defaults:{autoScroll:true,bodyPadding:10},items:[{title:"Solution",items:[b.getSpecimenContainer(a)]},{title:"Primary Data Reduction",active:true,tabConfig:{xtype:"tab",margins:"0 0 0 20",},items:[b.subtractionCurveVisualizer.getPanel()]},{title:"Modeling",items:[b.getAbinitioModellingContainer(a),b.getSeparator(),b.getModelViz(a)]},{title:"Advanced",items:[b.getAdvancedTab(a)]}]});
return this.tabs;};DataCollectionWidget.prototype.getPanel=function(a){var b=this;b.data=a;this.panel=Ext.create("Ext.container.Container",{width:1000,layout:{type:"vbox",align:"stretch",padding:5},items:[b.getPrimaryDataProcessingContainer(a),b.getSeparator(),b.getTabs(a)],});this.panel.on("afterrender",function(){b.subtractionCurveVisualizer.refresh([b.data[1].mergeId],[b.data[1].subtractionId]);
});return this.panel;};DataCollectionWidget.prototype.getModelViz=function(a){this.modelViz=new ModelVisualizerForm({height:800,width:1000});return this.modelViz.getPanel();};DataCollectionWidget.prototype.getPrimaryDataProcessingContainer=function(a){var b=this;this.primaryDataProcessingGrid=new PrimaryDataProcessingGrid({height:250,width:1000,title:"Primary Data Processing"});
this.primaryDataProcessingGrid.onSelected.attach(function(e,f){var c=[];var g=[];var h={};for(var d=0;d<f.length;d++){if(f[d].mergeId!=null){c.push(f[d].mergeId);}if(f[d].subtractionId!=null){if(f[d].macromoleculeId!=null){if(h[f[d].subtractionId]==null){g.push(f[d].subtractionId);}h[f[d].subtractionId]=true;
}}}b.subtractionCurveVisualizer.refresh(c,g);});return this.primaryDataProcessingGrid.getPanel(a);};DataCollectionWidget.prototype.getAbinitioModellingContainer=function(e){var f=this;this.abinitioGrid=new AbinitioGrid();this.abinitioGrid.onSelected.attach(function(g,h){f.modelViz.refresh(h);});var c=[];
for(var d=0;d<e.length;d++){c.push(e[d].abInitioId);}var b=[];$.each(c,function(g,h){if($.inArray(h,b)===-1){b.push(h);}});var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(g,h){f.abinitioGrid.refresh(h);});a.getAbinitioByIdsList(b);return this.abinitioGrid.getPanel([]);};function DygraphWidget(b,a){this.width=1000;
this.height=600;this.labelsWidth=100;this.targetId=b;this.customBars=false;this.ylabel="";this.xlabel="";this.id=BUI.id();this.showRangeSelector=false;this.interactionModel=null;this.labelsDivStyles=null;this.ranges={};if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}if(a.labelsWidth!=null){this.labelsWidth=a.labelsWidth;}if(a.labelsDivStyles!=null){this.labelsDivStyles=a.labelsDivStyles;}if(a.customBars!=null){this.customBars=a.customBars;}if(a.ylabel!=null){this.ylabel=a.ylabel;}if(a.xlabel!=null){this.xlabel=a.xlabel;}if(a.showRangeSelector!=null){this.showRangeSelector=a.showRangeSelector;
}if(a.interactionModel!=null){this.interactionModel=a.interactionModel;}if(a.scaled!=null){this.scaled=a.scaled;}if(a.ranges!=null){this.ranges=a.ranges;}}this.onZoomX=new Event(this);this.onResetZoom=new Event(this);this.dblclick=new Event(this);}DygraphWidget.prototype.dblclick=function(c,b,a){b.widget.dblclick.notify({x:b.lastx_});
};DygraphWidget.prototype._createHTLMWrapper=function(d,a,f){if(document.getElementById(this.targetId)==null){return;}document.getElementById(this.targetId).innerHTML="";var b=document.createElement("table");var c=document.createElement("tr");var e=document.createElement("td");this.canvasDiv=document.createElement("div");
this.canvasDiv.setAttribute("id","dygraph_canvas_"+this.id);this.canvasDiv.setAttribute("style","width:"+this.width+"px;height:"+this.height+"px");e.appendChild(this.canvasDiv);this.legendDiv=document.createElement("div");c.appendChild(e);b.appendChild(c);document.getElementById(this.targetId).appendChild(b);
};DygraphWidget.prototype.draw=function(b,a,c){this._createHTLMWrapper(b,a,c);this.dygraph=new Dygraph(this.canvasDiv,b,{labels:c,labelsDiv:this.legendDiv,labelsSeparateLines:true,highlightCircleSize:3,strokeWidth:1,customBars:this.customBars,colors:a,scaled:this.scaled,ranges:this.ranges,xlabel:this.xlabel,ylabel:this.ylabel,showRangeSelector:this.showRangeSelector,rangeSelectorPlotStrokeColor:"rgba(50,50,50,0.3)",rangeSelectorPlotFillColor:"rgba(50,50,50,0.1)",labelsDivStyles:this.labelsDivStyles,interactionModel:this.interactionModel});
};function FitStructureToDataWidget(){this.id=BUI.id();this.width=875;this.height=565;}FitStructureToDataWidget.prototype.getPlotContainerDimensions=function(){return{width:this.width*2/3-4,height:this.height-8};};FitStructureToDataWidget.prototype.getPlotId=function(){return this.id+"plot";};FitStructureToDataWidget.prototype.getTextAreaHeight=function(){return 200;
};FitStructureToDataWidget.prototype.getPlotContainer=function(){var e=this;var d=this.getTextAreaHeight();var c=this.getPlotContainerDimensions().width;var a=this.getPlotContainerDimensions().height;function b(){var f="width:"+(c-5)+"px;height:"+(a-d-8)+"px;";return"<div id='"+e.getPlotId()+"' style='"+f+"'></div>";
}this.plot=Ext.create("Ext.panel.Panel",{margin:"2 2 2 2",layout:"hbox",width:e.width,height:(a-d-6),border:0,items:[{html:b()},this.getSummaryContainer()],listeners:{afterrender:function(){}}});return this.plot;};FitStructureToDataWidget.prototype.getSecondaryContainerDimensions=function(){return{width:this.width/3-16,height:(this.height-8)/2};
};FitStructureToDataWidget.prototype.getPdbId=function(){return this.id+"pdb";};FitStructureToDataWidget.prototype.getPdbContainer=function(){var c=this.getSecondaryContainerDimensions().width;var a=this.getSecondaryContainerDimensions().height;var d=this;function b(){var e="background-color:black;width:"+(c-5)+"px;height:"+(a-5)+"px;";
return"<textarea id='"+d.getPdbId()+"_src'; style='display: none;'></textarea><div id='"+d.getPdbId()+"' style='"+e+"'></div>";}this.pdbContainer=Ext.create("Ext.panel.Panel",{margin:"2 2 2 2",width:c,height:a,items:[{html:b()}]});return this.pdbContainer;};FitStructureToDataWidget.prototype.getDataContainer=function(){return Ext.create("Ext.panel.Panel",{margin:"2 2 2 2",width:this.getSecondaryContainerDimensions().width,height:this.getSecondaryContainerDimensions().height,items:[]});
};FitStructureToDataWidget.prototype.getSummaryContainer=function(){return Ext.create("Ext.panel.Panel",{margin:"2 2 2 2",width:this.width/3-10,height:this.height-15-this.getTextAreaHeight()-1,layout:"vbox",items:[this.getPdbContainer()],listeners:{afterrender:function(){}}});};FitStructureToDataWidget.prototype.getPanel=function(){var b=this;
var a=this.getTextAreaHeight();this.panel=Ext.create("Ext.container.Container",{layout:"vbox",width:this.width,height:this.height,items:[this.getPlotContainer(),{id:b.id+"textArea",xtype:"textareafield",grow:true,height:a-10,width:this.width-10,name:"message",anchor:"100%",margin:5}],listeners:{afterrender:function(){}}});
return this.panel;};FitStructureToDataWidget.prototype.refreshPlot=function(b){var c=this;var a=new BiosaxsDataAdapter();this.plot.setLoading("Plotting");a.onSuccess.attach(function(k,j){var e=[];var m=["X"];var p=[];function r(n,i){i=parseFloat(i);n=parseFloat(n);return DataCollectionCurveVisualizer.prototype._getCoordinates(n,i);
}m.push("fit");m.push("scattering");e.push("#58ACFA");e.push("green");var o=0;if(j!=null){if(j.length>0){for(var q in j[0]){var d=j[0][q];for(var h=0;h<d.length;h++){var g=parseFloat(d[h][1]);p.push([parseFloat(d[h][0])]);p[p.length-1].push(r(d[h][1],d[h][2]));var l=parseFloat(d[h][3]);p[p.length-1].push(r(l,l));
o++;}}}}var f=new StdDevDyGraph(c.getPlotId(),{width:c.getPlotContainerDimensions().width-20,height:c.getPlotContainerDimensions().height-10-c.getTextAreaHeight(),xlabel:"q (nm-1)",showRangeSelector:false});f.draw(p,e,m);c.plot.setLoading(false);});a.getFitStructureToExperimentalDataFile(b,"fit","json");
};FitStructureToDataWidget.prototype.refreshPdbViz=function(b){var c=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(e,d){c.pdbContainer.setLoading("Rendering PDB");document.getElementById(c.getPdbId()+"_src").innerHTML=d;var f=new GLmol(c.getPdbId());c.pdbContainer.setLoading(false);
});c.pdbContainer.setLoading("Reading PDB");a.getStructureFile(b);};FitStructureToDataWidget.prototype.refreshOutputfileContent=function(b){var c=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(d,e){console.log(e);Ext.getCmp(c.id+"textArea").setValue(e);});a.getFitStructureToExperimentalDataFile(b,"OUTPUT","txt");
};FitStructureToDataWidget.prototype.refresh=function(a,b){this.refreshPlot(a);this.refreshOutputfileContent(a);this.refreshPdbViz(b);};function DataCollectionPDBWidget(a){this.id=BUI.id();this.width=900;this.height=600;this.title="";this.mergedEnabled=true;this.damminEnabled=false;this.damaverEnabled=false;
this.damfiltEnabled=false;this.radius=3;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height-100;}}}DataCollectionPDBWidget.prototype.getPDBViewerPanel=function(b,c,a){return new PDBViewer({width:c,height:a,title:b.title}).draw(b);};DataCollectionPDBWidget.prototype.get2x2=function(b,a){return[{xtype:"container",type:"vbox",items:[this.getPDBViewerPanel([b[0]],this.width/2,this.height/2),this.getPDBViewerPanel([b[1]],this.width/2,this.height/2)]},{xtype:"container",type:"vbox",padding:"0 0 0 5",items:[this.getPDBViewerPanel([b[2]],this.width/2,this.height/2),this.getPDBViewerPanel(b[3],this.width/2,this.height/2)]}];
};DataCollectionPDBWidget.prototype.getContainers=function(c){var a=[];if(c.length<4){for(key in c){var b=c[key];if(b.length==null){b=[b];}a.push({xtype:"container",type:"vbox",margin:"2",items:[this.getPDBViewerPanel(b,this.width/c.length,this.height)]});}}if(c.length==4){return this.get2x2(c);}return a;
};DataCollectionPDBWidget.prototype.getColors=function(){var a=[];a.push("0xFF6600");a.push("0x00CC00");a.push("0x0099FF");return a;};DataCollectionPDBWidget.prototype.getPDBPanel=function(b){var a=Ext.create("Ext.panel.Panel",{layout:{type:"hbox"},margin:"5 0 0 0",width:this.width,items:this.getContainers(b)});
a.addDocked({xtype:"toolbar",items:this.getMenu()});return a;};DataCollectionPDBWidget.prototype._getFirHTML=function(f,d,a,c,e){var b="<table>";b=b+'<tr style="text-align: center;"><td><a style="color:blue;font-weight:bold;" target="_blank" href="'+BUI.getModelFile("FIT",f,"txt")+'" >dammin.'+c+"</a></td></tr>";
b=b+'<tr style="text-align: center;font-style:italic;color:gray;"><td>'+e+"</td></tr>";b=b+'<tr><td><div background-color="red" id="'+(this.id+c+f)+'" width="'+d+'" height="'+a+'"></div></td></tr>';b=b+"</table>";return b;};DataCollectionPDBWidget.prototype.getNSDPlot=function(e,a){var d="<table>";d=d+'<tr><td><div background-color="red"  width="'+e+'" height="'+a+'"></div></td></tr>';
var c=BUI.getNSDImageURL(this.data.modelListId);var f='window.open("'+c+'")';var b='<img style="width:'+e+"px;height:"+a+'px;"   src="'+c+'">';d=d+'<tr style="text-align: center;font-style:italic;color:gray;"><td><a href='+c+' style="color:blue;font-weight:bold;" target="_blank">NSD file</a></td></tr>';
d=d+'<tr style="text-align: center;font-style:italic;color:gray;"><td>Normalized squared displacement comparison</td></tr>';d=d+'<tr style="text-align: center;font-style:italic;color:gray;"><td> '+b+"</td></tr>";d=d+"</table>";return d;};DataCollectionPDBWidget.prototype.getCHI2Plot=function(e,a){var d="<table>";
d=d+'<tr><td><div background-color="red"  width="'+e+'" height="'+a+'"></div></td></tr>';var c=BUI.getCHI2ImageURL(this.data.modelListId);var b='<img style="width:'+e+"px;height:"+a+'px;"   src="'+c+'">';d=d+'<tr style="text-align: center;font-style:italic;color:gray;"><td><a href='+c+' style="color:blue;font-weight:bold;" target="_blank">CHI2 file</a></td></tr>';
d=d+'<tr style="text-align: center;font-style:italic;color:gray;"><td>CHI  comparison</td></tr>';d=d+'<tr style="text-align: center;font-style:italic;color:gray;"><td> '+b+"</td></tr>";d=d+"</table>";return d;};DataCollectionPDBWidget.prototype.getImagesPanel=function(){var a=this;return{xtype:"container",layout:"hbox",width:this.width,height:300,border:1,margin:"5 0 0 0",items:[{html:a._getFirHTML(a.data.shapeDeterminationModelId,(this.width/4)-5,250,"fir","Fit of the simulated scattering curve versus a smoothed experimental data (spline interpolation)"),width:(this.width/4)-5,height:300,border:1,margin:"0 5 0 0"},{html:a._getFirHTML(a.data.shapeDeterminationModelId,(this.width/4)-5,250,"fit","Fit of the simulated scattering curve versus the experimental data."),width:(this.width/4)-5,height:300,border:1,margin:"0 5 0 0"},{html:a.getCHI2Plot(this.width/4,250),width:(this.width/4)-5,height:300,border:1,margin:"0 5 0 0"},{html:a.getNSDPlot(this.width/4,250),width:(this.width/4)-5,height:300,border:1}]};
};DataCollectionPDBWidget.prototype.draw=function(b,a){this.data=b;var c=this;this.analysisGrid=new AnalysisGrid({height:150,grouped:false,maxHeight:200,positionColumnsHidden:true,sorters:[{property:"priorityLevelId",direction:"ASC"}]});this.panelPDB=this.getPDBPanel(this.getModels());this.panel=Ext.create("Ext.container.Container",{layout:{type:"vbox"},width:this.width,renderTo:a,listeners:{afterrender:function(){var d=new BiosaxsDataAdapter();
d.onSuccess.attach(function(g,k){var m=k.toString().split("\n");var l=[];for(var f=0;f<m.length;f++){var e=m[f].trim();var j=e.split(/\s*[\s,]\s*/);if(j.length==3){l.push([Number(j[0]),BUI.getStvArray(j[1],0),BUI.getStvArray(j[2],0)]);}}var h=new StdDevDyGraph(c.id+"fit"+c.data.shapeDeterminationModelId,{width:400,height:250,xlabel:"q(nm<sup>-1</sup>)"});
h.draw(l,["#FF0000","#0000FF"],["s","I(exp)","I(sim)"]);});d.getModelFile("FIT",c.data.shapeDeterminationModelId);d=new BiosaxsDataAdapter();d.onSuccess.attach(function(g,k){var m=k.toString().split("\n");var l=[];for(var f=0;f<m.length;f++){var e=m[f].trim();var j=e.split(/\s*[\s,]\s*/);if(j.length==4){l.push([Number(j[0]),BUI.getStvArray(j[1],j[2]),BUI.getStvArray(j[3],0)]);
}}var h=new StdDevDyGraph(c.id+"fir"+c.data.shapeDeterminationModelId,{width:400,height:250,xlabel:"q(nm<sup>-1</sup>)"});h.draw(l,["#FF0000","#0000FF","#FF00FF"],["s","I(exp)","I(sim)"]);});d.getModelFile("FIR",c.data.shapeDeterminationModelId);}},items:[this.analysisGrid.getPanel([b]),this.panelPDB,this.getImagesPanel()]});
};DataCollectionPDBWidget.prototype.getDamaverModel=function(){if(this.data.averagedModel!=null){return{type:"AVERAGED",modelId:this.data.averagedModelId,abInitioModelId:this.data.abInitioModelId,color:this.getColors()[0],title:this.data.averagedModel.split("/")[this.data.averagedModel.split("/").length-1],opacity:0.5,radius:this.radius};
}};DataCollectionPDBWidget.prototype.getDamfiltModel=function(){if(this.data.rapidShapeDeterminationModel!=null){return{type:"RAPIDSHAPEDETERMINATIONMODEL",modelId:this.data.rapidShapeDeterminationModelId,abInitioModelId:this.data.abInitioModelId,color:this.getColors()[1],title:this.data.rapidShapeDeterminationModel.split("/")[this.data.rapidShapeDeterminationModel.split("/").length-1],opacity:0.5,radius:this.radius};
}};DataCollectionPDBWidget.prototype.getDammin=function(){if(this.data.shapeDeterminationModel!=null){return{type:"SHAPEDETERMINATIONMODEL",modelId:this.data.shapeDeterminationModelId,abInitioModelId:this.data.abInitioModelId,color:this.getColors()[2],title:this.data.shapeDeterminationModel.split("/")[this.data.shapeDeterminationModel.split("/").length-1],opacity:0.5,radius:this.radius};
}};DataCollectionPDBWidget.prototype.refresh=function(a){this.panel.remove(this.panelPDB);this.panelPDB=this.getPDBPanel(a);this.panel.insert(this.panelPDB,0);};DataCollectionPDBWidget.prototype.getModels=function(){var a=[];var d=this.data;if(this.damaverEnabled){a.push(this.getDamaverModel());}if(this.damfiltEnabled){a.push(this.getDamfiltModel());
}if(this.damminEnabled){a.push(this.getDammin());}if(this.mergedEnabled){var i=[];var e=[];var g="Merged [";var b=[];if(a.length==0){var h=this.getDamaverModel();if(h!=null){h.opacity=0.2;b.push(h);}var f=this.getDamfiltModel();if(f!=null){f.opacity=0.6;b.push(f);}var c=this.getDammin();if(c!=null){c.opacity=0.8;
b.push(c);}b=[b];}else{b=a;b.push(JSON.parse(JSON.stringify(b)));}return b;}return a;};DataCollectionPDBWidget.prototype.getMenu=function(){var b=this;var a=[];a.push({text:"Dammaver",id:b.id+"damaverBtn",enableToggle:true,scope:this,toggleHandler:function(c,d){b.damaverEnabled=d;b.refresh(b.getModels());
},pressed:this.damaverEnabled});a.push({text:"Damfilt",id:b.id+"damfiltBtn",enableToggle:true,scope:this,toggleHandler:function(c,d){b.damfiltEnabled=d;b.refresh(b.getModels());},pressed:this.damfiltEnabled});a.push({text:"Dammin",id:b.id+"damminBtn",enableToggle:true,scope:this,toggleHandler:function(c,d){b.damminEnabled=d;
b.refresh(b.getModels());},pressed:this.damminEnabled});a.push({text:"Merged",id:b.id+"mergedBtn",enableToggle:true,scope:this,toggleHandler:function(c,d){b.mergedEnabled=d;b.refresh(b.getModels());},pressed:this.mergedEnabled});return a;};DataCollectionPDBWidget.prototype.input=function(){return{data:DATADOC.getPDBData()};
};DataCollectionPDBWidget.prototype.test=function(b){var a=new DataCollectionPDBWidget({width:1000,height:300,title:"Damaver"});a.draw(a.input().data,b);};function PDBViewer(a){this.id=BUI.id();this.glMol=null;this.width=600;this.height=600;this.title="";if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}if(a.title!=null){this.title=a.title;}}}PDBViewer.prototype.getTitle=function(){return"<div style='width:"+this.width+"px; height:20px; font-weight:bold;background-color: #E6E6E6;color:black'>"+this.title+"</div>";};PDBViewer.prototype.getTextAreaId=function(){return this.id+"_src";
};PDBViewer.prototype.getCanvas=function(){var a="width:"+this.width+"px; height: "+this.height+"px;display: none;";var c="<textarea id='"+this.getTextAreaId()+"'; style='"+a+"' ></textarea>";var b="width: "+this.width+"px; height: "+this.height+"px; background-color: black;";return c+"<div id='"+this.id+"'; style='"+b+"' ></div>";
};PDBViewer.prototype.getDownload=function(b,c){var a=BUI.getPdbURL()+"&type="+b+"&abInitioModelId="+c;html="<a href="+a+' style="color:blue;font-weight:bold;"  height="80" width="80" >Download</a><br /><br />';return"<div style='width:"+this.width+"px; height:20px; font-weight:bold;background-color: #336699;color:white'>"+html+"</div>";
};PDBViewer.prototype.getBar=function(){return"<div style='width:"+this.width+"px; height:20px; font-weight:bold;background-color: #336699;color:white'></div>";};PDBViewer.prototype.refresh=function(c){var b=this;if(BUI.isWebGLEnabled()){this.models=c;var a=new BiosaxsDataAdapter();b.panel.setLoading("Rendering");
a.onSuccess.attach(function(d,e){document.getElementById(b.getTextAreaId()).innerHTML=e.XYZ;if(b.glMol==null){b.glMol=new GLmol(b.id);}else{b.glMol.loadMolecule();}b.panel.setLoading(false);});a.onError.attach(function(d,e){b.panel.setLoading("Not available");});a.getPDBContentByModelList(c);}else{document.getElementById(b.id).innerHTML=BUI.getWarningHTML("Your browser doesn't support WebGL");
document.getElementById(b.id).innerHTML=document.getElementById(b.id).innerHTML+"<br />";document.getElementById(b.id).innerHTML=document.getElementById(b.id).innerHTML+BUI.getTipHTML("<a href='http://www.browserleaks.com/webgl#howto-enable-disable-webgl'>How to enable WebGL</a>");document.getElementById(b.id).innerHTML=document.getElementById(b.id).innerHTML+"<br />";
document.getElementById(b.id).innerHTML=document.getElementById(b.id).innerHTML+BUI.getTipHTML("<a href='http://caniuse.com/webgl'>Can I use WebGL?</a>");}};PDBViewer.prototype.getOpacity=function(a){if(a=="Invisible"){return"0";}if(a=="Minimum"){return"0.2";}if(a=="Medium"){return"0.5";}if(a=="High"){return"0.7";
}return"1";};PDBViewer.prototype.getMenu=function(b){var c=this;function a(e,j,h){if(j){var g=null;if(e.group=="Opacity"){for(g=0;g<c.models.length;g++){var f=c.getOpacity(e.text);b.opacity=f;}}if(e.group=="Radius"){for(g=0;g<c.models.length;g++){var d=c.getOpacity(e.text);b.radius=d;}}c.refresh(c.models);
}}return Ext.create("Ext.menu.Menu",{items:[{text:"Opacity",menu:{items:[{text:"Invisible",checked:false,group:"Opacity",checkHandler:a},{text:"Minimum",checked:false,group:"Opacity",checkHandler:a},{text:"Medium",checked:false,group:"Opacity",checkHandler:a},{text:"High",checked:false,group:"Opacity",checkHandler:a},{text:"Opaque",checked:false,group:"Opacity",checkHandler:a}]}}]});
};PDBViewer.prototype.getTbar=function(){var e=this;var a=Ext.create("Ext.toolbar.Toolbar");var d=[];for(var c=0;c<this.models.length;c++){a.add({text:this.models[c].title,menu:this.getMenu(this.models[c])});var b="#"+this.models[c].color.replace("0x","");d.push({html:"<table><tr><td width='15px'>"+BUI.getRectangleColorDIV(b,10,10)+"</td><td>"+this.models[c].title+"</td></table>"});
}a.add({xtype:"numberfield",labelWidth:50,width:120,fieldLabel:"Radius",value:3,maxValue:10,step:0.2,minValue:0.1,listeners:{change:function(h){var f=h.getValue();for(var g=0;g<e.models.length;g++){e.models[g].radius=f;}e.refresh(e.models);}}});a.add("->");a.add(d);return a;};PDBViewer.prototype.draw=function(b){this.models=b;
var a=this;this.panel=Ext.create("Ext.panel.Panel",{margin:2,layout:{type:"vbox"},tbar:this.getTbar(),width:this.width-4,height:this.height+30,items:[{html:this.getCanvas()}],listeners:{afterRender:function(){a.refresh(b);}}});this.panel.setLoading("Rendering");return this.panel;};function PrepareExperimentWidget(a){this.id=BUI.id();
this.height=800;this.width=900;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}var b=this;this.macromoleculeGrid=new MacromoleculeGrid({width:425,height:350,collapsed:false,tbar:true});this.macromoleculeGrid.onMacromoleculesChanged.attach(function(c){b.getProposal();
});this.bufferGrid=new BufferGrid({width:425,height:350,collapsed:false,tbar:true});this.templateGrid=new TemplateGrid({width:this.width,minHeight:300,height:440,gridType:"Ext.grid.Panel",title:"Experiments",grouping:false,tbar:true});}PrepareExperimentWidget.prototype.draw=function(a){this.renderPanel(a);
this.getProposal();this.getTemplates();};PrepareExperimentWidget.prototype.renderPanel=function(a){this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,height:this.height,width:this.width,renderTo:a,items:[{xtype:"container",layout:"hbox",margin:"0, 0, 0, 0",items:[{xtype:"container",layout:"vbox",margin:"0, 0, 0, 0",width:450,items:[this.macromoleculeGrid.getPanel([])]},this.bufferGrid.getPanel([])]},{xtype:"container",layout:"hbox",margin:"10, 0, 0, 0",items:[this.templateGrid.getPanel([])]}]});
};PrepareExperimentWidget.prototype.getTemplates=function(){var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(c,d){b.templateGrid.refresh(d);b.templateGrid.grid.setLoading(false);});b.templateGrid.grid.setLoading("ISPyB: Retrieving Templates");a.getExperimentInformationByProposalId();
};PrepareExperimentWidget.prototype.getProposal=function(){var a=this;BIOSAXS.proposal.onInitialized=new Event();BIOSAXS.proposal.onInitialized.attach(function(b){a.macromoleculeGrid.refresh(BIOSAXS.proposal.macromolecules);a.bufferGrid.refresh(BIOSAXS.proposal.buffers);a.macromoleculeGrid.grid.setLoading(false);
a.bufferGrid.grid.setLoading(false);});a.macromoleculeGrid.grid.setLoading("ISPyB: Retrieving Macromolecules");a.bufferGrid.grid.setLoading("ISPyB: Retrieving Buffers");BIOSAXS.proposal.init();};function QualityControlResultsWidget(a){this.id=BUI.id();this.qualityThreshold=0.25;this.radiationDamageThreshold=0.25;
if(a!=null){if(a.qualityThreshold!=null){this.qualityThreshold=a.qualityThreshold;}if(a.radiationDamageThreshold!=null){this.radiationDamageThreshold=a.radiationDamageThreshold;}}this.onQualityChanged=new Event(this);this.onRadiationDatamageChanged=new Event(this);}QualityControlResultsWidget.prototype.getPanel=function(){var c=this;
var b=Ext.create("Ext.slider.Single",{width:400,value:c.qualityThreshold*100,increment:1,fieldLabel:"Quality (%)",labelWidth:220,minValue:0,maxValue:100,listeners:{change:function(d,e){Ext.getCmp(c.id+"_qualityField").setText("> "+e+" %");c.onQualityChanged.notify(e/100);}}});var a=Ext.create("Ext.slider.Single",{width:400,value:c.radiationDamageThreshold*100,increment:1,fieldLabel:"Radiation Damage/Inhomogenety (%)",labelWidth:220,minValue:0,maxValue:100,listeners:{change:function(d,e){Ext.getCmp(c.id+"_rdField").setText("> "+e+" %");
c.onRadiationDatamageChanged.notify(e/100);}}});return{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"textfield",items:[{xtype:"container",layout:"hbox",items:[b,{xtype:"label",id:c.id+"_qualityField",labelWidth:50,margin:"0 0 0 20",readOnly:true,text:"> "+c.qualityThreshold*100+" %"},{html:"<span style='font-style:italic;'> Guinier Quality <span style='font-weight:bold;'>Recommended value is > 70.</span></span>",margin:"0 0 0 20",border:0,padding:"0 100 0 0 "}]},{xtype:"container",layout:"hbox",items:[a,{xtype:"label",id:c.id+"_rdField",labelWidth:50,margin:"0 0 0 20",readOnly:true,text:"> "+c.radiationDamageThreshold*100+" %"},{html:"<span style='font-style:italic;'> Percentage of frames merged <span style='font-weight:bold;'>Recommended value is > 70.</span></span>",margin:"0 0 0 20",border:0,padding:"0 100 0 0 "}]}]};
};QualityControlResultsWidget.prototype.input=function(){};QualityControlResultsWidget.prototype.test=function(b){var c=new QualityControlResultsWidget();var a=c.getPanel();Ext.create("Ext.panel.Panel",{width:1000,items:[a],renderTo:b});};function SamplePlateGroupWidget(a){this.id=BUI.id();this.width=900;
this.height=300;this.titleTypePlate=20;this.heightPlates=this.height-this.titleTypePlate-55;this.margin=0;this.samplePlateWidgets=[];this.bbar=false;this.border=1;this.showTitle=true;this.title=null;this.nodeSize=8;if(a!=null){if(a.margin!=null){this.margin=a.margin;}if(a.bbar!=null){this.bbar=a.bbar;
}if(a.showTitle!=null){this.showTitle=a.showTitle;if(this.showTitle){this.title="Plates Groups";}}if(a.border!=null){this.border=a.border;}if(a.height!=null){this.height=a.height;this.heightPlates=this.height-this.titleTypePlate-55;}}this.onClick=new Event(this);this.onExperimentChanged=new Event(this);
}SamplePlateGroupWidget.prototype.drawPlate=function(a,b,c){var e=this;var d=new SamplePlateWidget({width:(this.width/3)-5,height:this.heightPlates,nodeSize:this.nodeSize,fontSize:0,strokeWidth:1.5});d.draw(a,b,c);d.onVertexUp.attach(function(g,f){e.onClick.notify({samplePlate:f.samplePlate,row:f.row,column:f.column});
});this.samplePlateWidgets.push(d);};SamplePlateGroupWidget.prototype.drawPlates=function(b){var f=b.getPlateGroups();for(var e=0;e<f.length;e++){var g=f[e].plateGroupId;var a=b.getPlatesByPlateGroupId(g);for(var d=0;d<a.length;d++){var c=("id",this.id+"_"+a[d].samplePlateId);if(document.getElementById(c)!=null){this.drawPlate(b,a[d],c);
}}}};SamplePlateGroupWidget.prototype._sortPlates=function(d,c){return d.slotPositionColumn-c.slotPositionColumn;};SamplePlateGroupWidget.prototype.getPlates=function(a){var e=a.getPlateGroups();var b=document.createElement("div");var n=document.createElement("table");n.setAttribute("width",this.width-30+"px");
n.setAttribute("height",this.heightPlates+"px");for(var g=0;g<e.length;g++){var h=document.createElement("tr");var c=e[g].plateGroupId;var k=a.getPlatesByPlateGroupId(c);k.sort(this._sortPlates);for(var f=0;f<k.length;f++){var d=document.createElement("td");d.setAttribute("id",this.id+"_"+k[f].samplePlateId);
d.setAttribute("style","background-color:#E6E6E6;border-width:1px;border-style:solid;");var l=document.createElement("div");l.setAttribute("class","menu-title");var m=document.createTextNode((f+1)+".- "+k[f].platetype3VO.name);l.appendChild(m);h.appendChild(d);d.appendChild(l);}n.appendChild(h);}b.appendChild(n);
return b.innerHTML;};SamplePlateGroupWidget.prototype.selectSpecimens=function(b){for(var a=0;a<this.samplePlateWidgets.length;a++){this.samplePlateWidgets[a].clearSelection();}for(var a=0;a<b.length;a++){this.selectSpecimen(b[a]);}};SamplePlateGroupWidget.prototype.selectSpecimen=function(c){if(c.sampleplateposition3VO!=null){var b=c.sampleplateposition3VO.samplePlateId;
for(var a=0;a<this.samplePlateWidgets.length;a++){var b=this.samplePlateWidgets[a].samplePlate.samplePlateId;if(this.samplePlateWidgets[a].samplePlate.samplePlateId==c.sampleplateposition3VO.samplePlateId){this.samplePlateWidgets[a].selectSpecimen(c);return;}}}};SamplePlateGroupWidget.prototype.refresh=function(a){this.experiment=a;
this.samplePlateWidgets=[];if(document.getElementById(this.id+"_container")!=null){document.getElementById(this.id+"_container").innerHTML="";document.getElementById(this.id+"_container").innerHTML=this.getPlates(a);this.drawPlates(a);}this.panel.removeDocked(Ext.getCmp(this.id+"bbar"));this.panel.addDocked(this.getBbar());
};SamplePlateGroupWidget.prototype._getAutoFillButton=function(){var h=this;var f=null;function d(){}function g(k){if(k=="yes"){var j=f.samplePlateId;var i=new BiosaxsDataAdapter();h.panel.setLoading("ISPyB: Saving Plate");i.onSuccess.attach(function(m,l){h.onExperimentChanged.notify(l);h.panel.setLoading(false);
});i.onError.attach(function(l){alert("error");h.panel.setLoading(false);});i.autoFillPlate(j,h.experiment.experimentId);}}function e(j){f=j;Ext.MessageBox.confirm("Confirm",'Are you sure you want to fill "'+h.experiment.getSamplePlateById(f.samplePlateId).platetype3VO.name+'" plate?',g);}var b=[];b.push('<b class="menu-title">Select a plate:</b>');
var a=this.experiment.getSamplePlates();a.sort(function(j,i){return j.slotPositionColumn-i.slotPositionColumn;});for(var c=0;c<a.length;c++){b.push({samplePlateId:a[c].samplePlateId,text:(c+1)+".- <b> "+a[c].platetype3VO.name+"</b>",handler:e});}return Ext.create("Ext.button.Split",{text:"Auto Fill",handler:d,tooltip:{text:"This will fill, if there is place, the specimens in the plate",title:"Auto Fill"},menu:{items:b}});
};SamplePlateGroupWidget.prototype._getZoomButton=function(){var f=this;var e=null;function d(g){Ext.create("Ext.window.Window",{title:f.experiment.getSamplePlateById(g.samplePlateId).platetype3VO.name,height:600,width:900,layout:"fit",modal:true,listeners:{afterrender:function(){var h=new SamplePlateWidget({width:880,height:560,nodeSize:4,fontSize:0,strokeWidth:1.5,showLabels:true,backgroundColor:"#FFFFFF"});
h.draw(f.experiment,f.experiment.getSamplePlateById(g.samplePlateId),"plateZoom");}},items:[{html:'<div id="plateZoom" style="background-color:red"></div>',padding:5}]}).show();}var b=[];var a=this.experiment.getSamplePlates();a.sort(function(h,g){return h.slotPositionColumn-g.slotPositionColumn;});b.push('<b class="menu-title">Select a plate:</b>');
for(var c=0;c<a.length;c++){b.push({samplePlateId:a[c].samplePlateId,text:(c+1)+".- <b> "+a[c].platetype3VO.name+"</b>",handler:d});}return Ext.create("Ext.button.Split",{text:"Zoom In",tooltip:{text:"This will show a plate bigger",title:"Zoom In Action"},menu:{items:b}});};SamplePlateGroupWidget.prototype._getEmptyButton=function(){var h=this;
var f=null;function d(){}function g(k){if(k=="yes"){var j=f.samplePlateId;var i=new BiosaxsDataAdapter();h.panel.setLoading("ISPyB: Saving Plate");i.onSuccess.attach(function(m,l){h.onExperimentChanged.notify(l);h.panel.setLoading(false);});i.onError.attach(function(l){alert("error");h.panel.setLoading(false);
});i.emptyPlate(j,h.experiment.experimentId);}}function e(j){f=j;Ext.MessageBox.confirm("Confirm",'Are you sure you want to empty "'+h.experiment.getSamplePlateById(f.samplePlateId).platetype3VO.name+'" plate?',g);}var b=[];var a=this.experiment.getSamplePlates();a.sort(function(j,i){return j.slotPositionColumn-i.slotPositionColumn;
});b.push('<b class="menu-title">Select a plate:</b>');for(var c=0;c<a.length;c++){b.push({samplePlateId:a[c].samplePlateId,text:(c+1)+".- <b> "+a[c].platetype3VO.name+"</b>",handler:e});}return Ext.create("Ext.button.Split",{text:"Empty",handler:d,tooltip:{text:"This will empty the specimen of a plate. It will NOT remove the specimen but will removed their position",title:"Empty Action"},menu:{items:b}});
};SamplePlateGroupWidget.prototype._getPlateTypes=function(){var f=this;var n=null;function c(){}function l(r){if(r=="yes"){var q=n.samplePlateId;var j=n.plateTypeId;var p=BIOSAXS.proposal.getPlateTypeById(j);var o=f.experiment.getSamplePlateById(q);o.platetype3VO=p;var q=n.samplePlateId;var i=new BiosaxsDataAdapter();
f.panel.setLoading("ISPyB: Saving Plate");i.onSuccess.attach(function(t,s){f.onExperimentChanged.notify(s);f.panel.setLoading(false);});i.onError.attach(function(s){alert("error");f.panel.setLoading(false);});i.savePlates([o],f.experiment.experimentId);}}function m(p){n=p;var o=p.samplePlateId;var j=p.plateTypeId;
if(f.experiment.getSamplePlateById(o).platetype3VO.plateTypeId!=j){Ext.MessageBox.confirm("Confirm",'Are you sure you want to change the type of "'+f.experiment.getSamplePlateById(n.samplePlateId).platetype3VO.name+'" plate?',l);}}var h=[];h.push('<b class="menu-title">Select an EMPTY plate:</b>');var k=this.experiment.getSamplePlates();
k.sort(function(j,i){return j.slotPositionColumn-i.slotPositionColumn;});var g=BIOSAXS.proposal.getPlateTypes();for(var e=0;e<k.length;e++){var d=k[e];var a=[];for(var b=0;b<g.length;b++){a.push({text:g[b].name,plateTypeId:g[b].plateTypeId,samplePlateId:d.samplePlateId,checked:(d.platetype3VO.plateTypeId==g[b].plateTypeId),group:"theme"+d.samplePlateId,checkHandler:m});
}h.push({text:(e+1)+".- <b> "+d.platetype3VO.name+"</b>",disabled:(f.experiment.getSpecimensBySamplePlateId(d.samplePlateId).length>0),menu:{items:a}});}return Ext.create("Ext.button.Split",{text:"Plate Types",handler:c,tooltip:{text:"This will change the type of a plate.",title:"Change plate type"},menu:{items:h}});
};SamplePlateGroupWidget.prototype.getBbar=function(a){var b=this;if(this.bbar){return Ext.create("Ext.toolbar.Toolbar",{id:b.id+"bbar",dock:"bottom",items:[this._getPlateTypes(),"-",this._getAutoFillButton(),this._getEmptyButton(),"-",this._getZoomButton()]});}return null;};SamplePlateGroupWidget.prototype.getPanel=function(a){this.experiment=a;
var b=this;this.panel=Ext.create("Ext.panel.Panel",{title:this.title,bbar:this.getBbar(),height:this.height,width:this.width,margin:this.margin,border:this.border,items:[{border:0,height:this.height,id:this.id+"_container",html:this.getPlates(a)}]});this.panel.on("afterrender",function(){b.drawPlates(b.experiment);
});return this.panel;};function SamplePlateWidget(a){this.actions=[];this.width="1";this.height="1";this.legendFontSize=7;this.backgroundColor="#E6E6E6";this.wellColor="#FFFFFF ";this.id=BUI.id();this.notSupportedMessage="IE doesn't support HTML5 features";this.nodeSize=14;this.fontSize=10;this.strokeWidth=2;
this.showTooltip=true;this.showBorderLabels=true;this.showFullName=false;this.showLabels=false;if(a!=null){if(a.showBorderLabels!=null){this.showBorderLabels=a.showBorderLabels;}if(a.showLabels!=null){this.showLabels=a.showLabels;}if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}if(a.nodeSize!=null){this.nodeSize=a.nodeSize;}if(a.notSupportedMessage!=null){this.notSupportedMessage=a.notSupportedMessage;}if(a.fontSize!=null){this.fontSize=a.fontSize;}if(a.showFullName!=null){this.showFullName=a.showFullName;}if(a.showTooltip!=null){this.showTooltip=a.showTooltip;}if(a.backgroundColor!=null){this.backgroundColor=a.backgroundColor;
}if(a.strokeWidth!=null){this.strokeWidth=a.strokeWidth;}}this.ids={};this.onVertexUp=new Event(this);this.selectedSVGNodes=[];this.markedSpecimenId={};}SamplePlateWidget.prototype.clear=function(a,c,b){if(document.getElementById(this.targetId)!=null){document.getElementById(this.targetId).innerHTML="";
}};SamplePlateWidget.prototype.draw=function(a,k,m,b){var h=this;this.windowContainerId=b;if(Ext.isIE6||Ext.isIE7||Ext.isIE8){document.getElementById(m).innerHTML=BUI.getWarningHTML(this.notSupportedMessage);return;}this.onVertexUp=new Event(this);this.samplePlate=k;this.experiment=a;this.targetId=m;
var n=this.samplePlate.platetype3VO.rowCount;var c=this.samplePlate.platetype3VO.columnCount;this.network=new NetworkWidget({targetId:m});var e=new GraphDataset();var l=new NetworkDataSetFormatter({defaultFormat:{type:"LineEdgeNetworkFormatter","fill-opacity":1,fill:this.wellColor,"stroke-width":this.strokeWidth,"stroke-opacity":1,stroke:"#000000",size:this.nodeSize,title:{fontSize:this.fontSize,fill:"#000000"}}},null,{labeled:false,height:this.height,width:this.width,right:this.width,backgroundColor:this.backgroundColor,balanceNodes:false,nodesMaxSize:12,nodesMinSize:2});
l.dataBind(e);var g=new LayoutDataset();g.dataBind(e);this.network.draw(e,l,g);for(var f=1;f<=n;f++){for(var d=1;d<=c;d++){this.network.getDataset().addNode("",{row:f,column:d});if(this.samplePlate.platetype3VO.name==" 4 x ( 8 + 3 ) Block"){if(d<9){this.network.getFormatter().vertices[this.network.getDataset().getVerticesCount()-1].getDefault().setSize(this.nodeSize*0.8);
}else{this.network.getFormatter().vertices[this.network.getDataset().getVerticesCount()-1].getDefault().setSize(this.nodeSize*1.4);}}}}this.network.graphCanvas.onVertexUp.attach(function(i,j){h.onVertexUp.notify({samplePlate:h.samplePlate,row:h.network.getDataset().getVertexById(j).args.row,column:h.network.getDataset().getVertexById(j).args.column});
});this.network.graphCanvas.onVertexOver.attach(function(i,j){});this.relayout(this.network,n,c);this.fillSimulator(this.experiment.getSamples());if(this.showBorderLabels){this.drawBorders();}};SamplePlateWidget.prototype.drawBorders=function(){var b={};var e={};var a=[];var j=[];var c=this.network.graphCanvas.getLayout().vertices;
for(var k in c){var h=c[k].x;if(b[h]==null){b[h]=true;a.push(h);}var g=c[k].y;if(e[g]==null){e[g]=true;j.push(g);}}var f=BUI.getSamplePlateLetters();for(var d=1;d<=a.length;d++){SVG.drawText(a[d-1]*this.network.graphCanvas.getWidth()-5,this.network.graphCanvas.getHeight(),d,this.network.graphCanvas._svg,[["font-size",this.legendFontSize+"px"],["font-weight","bold"],["fill","black"]]);
}for(var d=1;d<=j.length;d++){SVG.drawText(5,j[d-1]*this.network.graphCanvas.getHeight()+5,f[d-1],this.network.graphCanvas._svg,[["font-size",this.legendFontSize+"px"],["font-weight","bold"],["fill","black"]]);}};SamplePlateWidget.prototype.addOkIcon=function(a,f,e,d){var b=this.network.graphCanvas._svg;
var c=this;var e=e+"_marked";if(this.markedSpecimenId[e]==null){SVG.drawRectangle(a-10,f-10,22,22,b,[["id",e],["fill","gray"],["stroke-opacity","0.5"],["fill-opacity","0.2"],["stroke","black"]]);$("#"+e).qtip({content:{text:c._getToolTipContent(d)},position:{adjust:{x:0,y:20}},style:{width:true,classes:"ui-tooltip-shadow"}});
this.markedSpecimenId[e]=true;}};SamplePlateWidget.prototype.selectSpecimen=function(e){var c=this.getVertexByPosition(e.sampleplateposition3VO.rowNumber,e.sampleplateposition3VO.columnNumber);var a=this.network.getLayout().vertices[c.id].x*this.width;var d=this.network.getLayout().vertices[c.id].y*this.height;
var b=this.network.graphCanvas._svg;this.selectedSVGNodes.push(SVG.drawRectangle(a-9,d-9,20,20,b,[["fill","red"],["fill-opacity","0"],["stroke","blue"],["stroke-width","2"]]));};SamplePlateWidget.prototype.clearSelection=function(){var a=this.network.graphCanvas._svg;for(var b=0;b<this.selectedSVGNodes.length;
b++){a.removeChild(this.selectedSVGNodes[b]);}this.selectedSVGNodes=[];};SamplePlateWidget.prototype.getVertexByPosition=function(d,c){var b=this.network.getDataset().getVertices();for(var a in b){if((b[a].args.row==d)&&(b[a].args.column==c)){return b[a];}}return null;};SamplePlateWidget.prototype.showLabel=function(c,a,d){if(d!=null){var b=this.getVertexByPosition(c,a);
if(this.fontSize!=0){if(d.macromolecule3VO!=null){if(this.showFullName){b.setName(d.code);}else{b.setName(d.macromolecule3VO.acronym);}}else{if(this.showFullName){b.setName(d.code);}else{b.setName(d.macromolecule3VO.acronym);}}}}};SamplePlateWidget.prototype.getNodeIdBySpecimenId=function(a){var b=this.ids[a];
};SamplePlateWidget.prototype.markSpecimenAsOk=function(e,a,d,c){if(e.measurements!=null){for(var b=0;b<e.measurements.length;b++){if(e.measurements[b].merge3VOs!=null){if(e.measurements[b].merge3VOs.length>0){this.addOkIcon((a*this.network.graphCanvas.getWidth()),d*this.network.graphCanvas.getHeight(),c,e);
}}}}};SamplePlateWidget.prototype.getSpecimenBufferColorFromSampleSpecimenId=function(b){var a=this.experiment.getDataCollectionsBySpecimenId(b);if(a.length>0){var c=a[0];for(var d=0;d<c.measurementtodatacollection3VOs.length;d++){var f=c.measurementtodatacollection3VOs[d];if(f.dataCollectionOrder==1){var e=this.experiment.getMeasurementById(f.measurementId);
if(e!=null){return this.experiment.getSpecimenColorByBufferId(e.specimenId);}return"pink";}}}return"orange";};SamplePlateWidget.prototype.fillWell=function(k,d,j){var g=this;if(j!=null){var f=this.getVertexByPosition(k,d);if(f==null){console.log(k+", "+d+" not found");return;}var a=this.network.getGraphCanvas().getSVGNodeId(f.id);
this.showLabel(k,d,j);this.ids[j.specimenId]=f.id;var i=this.network.getLayout().vertices[f.id].x;var h=this.network.getLayout().vertices[f.id].y;this.markSpecimenAsOk(j,i,h,a);if(j.macromolecule3VO==null){var e=this.experiment.getSpecimenColorByBufferId(j.specimenId);this.network.getFormatter().getVertexById(f.id).getDefault().setFill(e);
this.network.getFormatter().getVertexById(f.id).getDefault().setStroke("blue");this.network.getFormatter().getVertexById(f.id).getDefault().setStrokeWidth(2);}else{this.network.getFormatter().getVertexById(f.id).getDefault().setFill(this.experiment.macromoleculeColors[j.macromolecule3VO.macromoleculeId]);
this.network.getFormatter().getVertexById(f.id).getDefault().setStroke("black");this.network.getFormatter().getVertexById(f.id).getDefault().setStrokeWidth(1);}if(this.showLabels){i=this.network.getLayout().vertices[f.id].x;h=this.network.getLayout().vertices[f.id].y;if(j.macromolecule3VO!=null){var b=j.macromolecule3VO.acronym;
if(b.length>10){b=b.slice(0,10)+"...";}SVG.drawText((i*this.network.graphCanvas.getWidth())-this.nodeSize-10,h*this.network.graphCanvas.getHeight()+(this.nodeSize*3)+20,b,this.network.graphCanvas._svg,[["font-size","xx-small"],["fill","black"]]);SVG.drawText((i*this.network.graphCanvas.getWidth())-this.nodeSize-10,h*this.network.graphCanvas.getHeight()+(this.nodeSize*3)+35,Number(j.concentration).toFixed(2)+" mg/ml",this.network.graphCanvas._svg,[["font-size","xx-small"],["fill","black"]]);
}var c=this.experiment.getBufferById(j.bufferId).acronym;if(c.length>10){c=c.slice(0,10)+"...";}SVG.drawText((i*this.network.graphCanvas.getWidth())-this.nodeSize-10,h*this.network.graphCanvas.getHeight()+(this.nodeSize*3)+5,this.experiment.getBufferById(j.bufferId).acronym,this.network.graphCanvas._svg,[["font-size","xx-small"],["fill","blue"]]);
}if(this.showTooltip){var a=this.network.getGraphCanvas().getSVGNodeId(f.id);if(g.windowContainerId!=null){$("#"+a).qtip({content:{text:g._getToolTipContent(j)},position:{adjust:{x:0,y:20}}});}else{$("#"+a).qtip({content:{text:g._getToolTipContent(j)},position:{adjust:{x:0,y:20}}});}}}};SamplePlateWidget.prototype._getToolTipContent=function(b){var a="<table style='font-size:11px;'>";
a=a+"<TR><TD>"+"Specimen "+"</TD><TD style='color:black; font-weight:bold;'>"+b.code+"</TD></TR>";a=a+"<TR style='height:20px'><TD>"+""+"</TD><TD style='color:black; font-weight:bold;'></TD></TR>";a=a+"<TR><TD>"+"Buffer: "+"</TD><TD style='color:blue; font-weight:bold;'>"+this.experiment.getBufferById(b.bufferId).name+"</TD></TR>";
if(b.macromolecule3VO!=null){a=a+"<TR><TD>"+"Macromolecule: "+"</TD><TD  style='color:green; font-weight:bold;'>"+b.macromolecule3VO.acronym+"</TD></TR>";a=a+"<TR><TD>"+"Concentration: "+"</TD><TD >"+b.concentration+"</TD></TR>";}a=a+"<TR><TD>"+"Volume: "+"</TD><TD>"+b.volume+"</TD></TR>";if(b.viscosity!=null){a=a+"<TR><TD>"+"Viscosity: "+"</TD><TD>"+b.viscosity+"</TD></TR>";
}a=a+"</table>";return a;};SamplePlateWidget.prototype.fillSimulator=function(b){for(var c=0;c<b.length;c++){var d=b[c];if(d.sampleplateposition3VO!=null){if(d.sampleplateposition3VO.samplePlateId==this.samplePlate.samplePlateId){var a=d.sampleplateposition3VO;this.fillWell(a.rowNumber,a.columnNumber,d);
}}}};SamplePlateWidget.prototype.relayout=function(b,c,a){if(this.samplePlate.platetype3VO.shape=="REC"){this.squareRelayout(b,c,a);}if(this.samplePlate.platetype3VO.shape=="CIR"){this.circleRelayout(b,c,a);}};SamplePlateWidget.prototype.squareRelayout=function(d,q,e){var l=d.getDataset()._getVerticesCount();
var n=0.07;var c=0.9;var a=0.075;var h=0.95;var m=(c-n)/(q-1);var p=(h-a)/(e-1);var o=[];for(var g=0;g<q;g++){for(var f=0;f<e;f++){y=g*m+n;x=f*p+a;o.push({"x":x,"y":y});}}var b=0;for(var k in d.getDataset().getVertices()){if(d.getLayout().vertices[k]==null){this.vertices[k]=new NodeLayout(k,0,0);}d.getLayout().vertices[k].setCoordinates(o[b].x,o[b].y);
b++;d.getLayout().vertices[k].changed.attach(function(i,j){_this.changed.notify(j);});}};SamplePlateWidget.prototype.circleRelayout=function(b,c,a){b.getLayout().getLayout("CIRCLE");};function ShippingWidget(a){this.id=BUI.id();this.height=800;this.width=900;if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}}var b=this;this.stockSolutionGrid=new StockSolutionGrid({width:this.width,minHeight:300,height:350,tbar:true});this.stockSolutionGrid.onProposalChanged.attach(function(c){b.refresh();});this.shipmentGrid=new ShipmentGrid({width:this.width,minHeight:300,height:440});
}ShippingWidget.prototype.draw=function(a){this.renderPanel(a);this.refresh();};ShippingWidget.prototype.renderPanel=function(a){this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,height:this.height,width:this.width,renderTo:a,items:[{xtype:"container",layout:"hbox",margin:"0, 0, 0, 0",items:[{xtype:"container",layout:"vbox",margin:"0, 0, 0, 0",items:[this.stockSolutionGrid.getPanel()]}]},{xtype:"container",layout:"hbox",margin:"10, 0, 0, 0",items:[this.shipmentGrid.getPanel([])]}]});
};ShippingWidget.prototype.refresh=function(){var a=this;BIOSAXS.proposal.onInitialized=new Event();BIOSAXS.proposal.onInitialized.attach(function(b){a.stockSolutionGrid.refresh(BIOSAXS.proposal.getStockSolutions());a.shipmentGrid.refresh(BIOSAXS.proposal.getShipments());a.stockSolutionGrid.grid.setLoading(false);
a.shipmentGrid.grid.setLoading(false);});this.stockSolutionGrid.grid.setLoading("ISPyB: Retrieving Stock Solutions");this.shipmentGrid.grid.setLoading("ISPyB: Retrieving shipments");BIOSAXS.proposal.init();};function WarningWidget(a){this.actions=[];this.width=580;this.height=380;this.title="Warning";
this.message=null;this.messageType=1;this.pageSize=3;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}if(a.title!=null){this.title=a.title;}if(a.messageType!=null){this.messageType=a.messageType;}if(a.message!=null){this.message=a.message;}}this.onVertexUp=new Event(this);
}WarningWidget.prototype.draw=function(e){var g=this;var f=[];for(var d=0;d<e.length;d++){f.push({warnings:e[d]});}var b=Ext.create("Ext.data.Store",{fields:["warnings"],remoteSort:true,pageSize:this.pageSize,data:f,proxy:{type:"pagingmemory"}});var c=Ext.createWidget("gridpanel",{store:b,height:264,border:0,flex:1,columns:[{text:"Description",sortable:true,dataIndex:"warnings",flex:1}],bbar:Ext.create("Ext.PagingToolbar",{pageSize:this.pageSize,store:b,displayInfo:true,plugins:Ext.create("Ext.ux.SlidingPager",{})})});
if(this.message==null){this.height=this.height-55;}var a=[];if(this.message!=null){if(this.messageType==0){a.push({padding:"0 0 0 2",border:0,html:BUI.getTipHTML(this.message)});}if(this.messageType==1){a.push({padding:"0 0 0 2",border:0,html:BUI.getWarningHTML(this.message)});}if(this.messageType==2){a.push({padding:"0 0 0 2",border:0,html:BUI.getErrorHTML(this.message)});
}}a.push(c);this.window=Ext.create("Ext.Window",{title:this.title,items:a,height:this.height,width:this.width,buttonAlign:"right",listeners:{scope:this,minimize:function(){this.window.hide();},destroy:function(){delete this.window;}},buttons:[{text:"Close",handler:function(){g.window.hide();}}]});this.window.show();
};function DataCollectionCurveVisualizer(a){this.id=BUI.id();this.width=1000;this.height=650;this.linear=false;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.orderColors={1:"#58ACFA",2:"#0B610B",3:"#08088A"};}DataCollectionCurveVisualizer.prototype.draw=function(){Ext.create("Ext.window.Window",{title:"Primary Data Processing",height:this.height,width:this.width,layout:"fit",items:[this.getPanel()]}).show();
};DataCollectionCurveVisualizer.prototype._getPrefixes=function(a){var c="";var f="";var d="";try{if(a.bufferBeforeAverageFilePath!=null){c=a.bufferBeforeAverageFilePath.split("/")[a.bufferBeforeAverageFilePath.split("/").length-1].replace("_ave.dat","");}if(a.averageFilePath!=null){f=a.averageFilePath.split("/")[a.averageFilePath.split("/").length-1].replace("_ave.dat","");
}if(a.bufferAfterAverageFilePath!=null){d=a.bufferAfterAverageFilePath.split("/")[a.bufferAfterAverageFilePath.split("/").length-1].replace("_ave.dat","");}}catch(b){console.log(b);}return[c,f,d];};DataCollectionCurveVisualizer.prototype._getFrames=function(e,d){var f=new Array();for(var c=0;c<e.length;
c++){var g=e[c];for(var b=0;b<g.framelist3VO.frametolist3VOs.length;b++){g.framelist3VO.frametolist3VOs.sort(function(i,h){return i.frame3VO.frameId-h.frame3VO.frameId;});var a=g.framelist3VO.frametolist3VOs[b];if((a.frame3VO.filePath.indexOf("ave.dat")==-1)&&a.frame3VO.filePath.indexOf("sub.dat")==-1&&a.frame3VO.filePath.indexOf("sub.out")==-1){f.push(a.frame3VO);
f[f.length-1]["specimen"]=d.getSampleById(d.getMeasurementById(g.measurementId).specimenId);f[f.length-1]["merged"]=false;f[f.length-1]["merge"]=g;if(a.frame3VO.filePath.indexOf("averbuffer.dat")==-1){if(g.framesMerge!=null){if(Number(g.framesMerge)>(b)){f[f.length-1]["merged"]=true;}}}else{f[f.length-1]["merged"]=true;
}}}}return f;};DataCollectionCurveVisualizer.prototype._getAverages=function(d,c){var a=new Array();d.sort(function(f,e){return f.mergeId-e.mergeId;});for(var b=0;b<d.length;b++){a.push({filePath:d[b].averageFilePath,specimen:c.getSampleById(c.getMeasurementById(d[b].measurementId).specimenId),merged:true,merge:d[b]});
}return a;};DataCollectionCurveVisualizer.prototype._getSubtractionByDataCollectionId=function(b,a){if(a.getDataCollectionById(b).substraction3VOs!=null){if(a.getDataCollectionById(b).substraction3VOs.length>0){return a.getDataCollectionById(b).substraction3VOs[0];}}return null;};DataCollectionCurveVisualizer.prototype.getLastMerges=function(a,e,d){var j=[];
function f(n,m){var k=[];for(var l=0;l<n.length;l++){var o=n[l];if(o.measurementId==m){k.push(o);}}k.sort(function(p,i){return p.mergeId-i.mergeId;});return k[k.length-1];}var h=e.getDataCollectionById(d);if(h.measurementtodatacollection3VOs!=null){for(var b=0;b<h.measurementtodatacollection3VOs.length;
b++){var c=h.measurementtodatacollection3VOs[b];var g=c.measurementId;j.push(f(a,g));}}return j;};DataCollectionCurveVisualizer.prototype._prepareData=function(a,h,g,d){var c=[];var a=this.getLastMerges(a,h,g);var l=this._getSubtractionByDataCollectionId(g,h);var j=null;if(l!=null){j=l.subtractionId;
var k="SUBTRACTED";c.push({filePath:l.substractedFilePath.split("/")[l.substractedFilePath.split("/").length-1],type:k,name:k,frameId:null,mergeId:null,specimen:null,color:"#DF01D7",merged:true,merge:null,subtractionId:j});}var e=this._getAverages(a,h);for(var b=0;b<e.length;b++){var k="AVERAGED";c.push({filePath:e[b].filePath.split("/")[e[b].filePath.split("/").length-1],type:k,name:k,frameId:null,mergeId:e[b].merge.mergeId,specimen:e[b].specimen,color:this._getSpecimenColor(e[b].specimen,e[b].merge,h,g,e[b].merged,k),merged:e[b].merged,merge:e[b].merge,subtractionId:j});
}var f=this._getFrames(a,h);for(var b=0;b<f.length;b++){var k="FRAMES";c.push({filePath:f[b].filePath.split("/")[f[b].filePath.split("/").length-1],type:k,name:k,frameId:f[b].frameId,specimen:f[b].specimen,color:this._getSpecimenColor(f[b].specimen,f[b].merge,h,g,f[b].merged,k),merged:f[b].merged,merge:f[b].merge,subtractionId:j});
}return c;};DataCollectionCurveVisualizer.prototype._renderSpecimenBox=function(a,h,g,d){try{a=this.getLastMerges(a,h,g);var b=h.getMeasurementById(a[1].measurementId);var j=h.getSampleById(b.specimenId);var c=BIOSAXS.proposal.getBufferById(j.bufferId);var i=BIOSAXS.proposal.getMacromoleculeById(d.macromoleculeId);
bufferAcronym=c.acronym;macromoleculeAcronym=i.acronym;if(a[0]!=null){bbmerges=a[0].framesMerge;}else{bbmerges="None";}if(a[1]!=null){if(a[1].framesMerge!=null){molmerges=a[1].framesMerge;}if(a[1].framesCount!=null){totalframes=a[1].framesCount;}}else{molmerges="None";}if(a[2]!=null){if(a[2].framesMerge!=null){bamerges=a[2].framesMerge;
}}else{bamerges="None";}bufferId=c.bufferId;macromoleculeId=i.macromoleculeId;document.getElementById(this.id+"_header").innerHTML=BUI.getHTMLTableForFrameAveraged(bufferAcronym,macromoleculeAcronym,bbmerges,molmerges,bamerges,totalframes,bufferId,macromoleculeId);}catch(f){console.log(f);}};DataCollectionCurveVisualizer.prototype._getImageHTML=function(g,e,b,a,d){var c=BUI.getURL()+"&type="+e+"&subtractionId="+b;
var f="OnClick= window.open('"+c+"')";return"<table ><tr><td><img src="+c+'   height="'+a+'" width="'+d+'" '+f+'></td></tr><tr><td style="font-weight:bold;text-align:center;">'+g+"</td></tr></table>";};DataCollectionCurveVisualizer.prototype.refresh=function(b,h,g,f){var e=this._prepareData(b,h,g,f);
this.store.loadData(e);this._renderSpecimenBox(b,h,g,f);var a=this.width*1/5-50;var j=a;if(e[0].subtractionId!=null){document.getElementById(this.id+"_scattering").innerHTML=this._getImageHTML("Scattering","scattering",e[0].subtractionId,j,a);document.getElementById(this.id+"_kratky").innerHTML=this._getImageHTML("Kratky Plot","kratky",e[0].subtractionId,j,a);
document.getElementById(this.id+"_guinier").innerHTML=this._getImageHTML("Guinier Approx.","guinier",e[0].subtractionId,j,a);document.getElementById(this.id+"_gnom").innerHTML=this._getImageHTML("P(r)","gnom",e[0].subtractionId,j,a);}var c=new Array();for(var d=0;d<e.length;d++){var f=e[d];if((f.type=="AVERAGED")||(f.type=="SUBTRACTED")){c.push(f);
}}this._renderPlot(c);this.legendStore.loadData(c);};DataCollectionCurveVisualizer.prototype._getSpecimenColor=function(k,g,e,d,j,f){var h=e.getDataCollectionById(d);var a=null;for(var b=0;b<h.measurementtodatacollection3VOs.length;b++){var c=h.measurementtodatacollection3VOs[b];if(c.measurementId==g.measurementId){a=c.dataCollectionOrder;
}}if(!j){if(f=="FRAMES"){return"gray";}}if(f=="SUBTRACTED"){return"#DF01D7";}return this.orderColors[a];};DataCollectionCurveVisualizer.prototype._getDataStore=function(){return Ext.create("Ext.data.Store",{fields:["filePath","type","frameId","specimen","subtractionId"],data:[],groupField:"type",sorters:[{property:"filePath",direction:"ASC"}]});
};DataCollectionCurveVisualizer.prototype.getLegendGrid=function(){this.legendStore=this._getDataStore();var a=this.height*2/3-10-60;var c=this.width/5-10;var b=this.getFrameGrid(this.legendStore,c,a,"Legend",false);return b;};DataCollectionCurveVisualizer.prototype.getSettingsPanel=function(a){var b=this;
return{xtype:"container",layout:"vbox",items:[{xtype:"fieldset",height:50,width:a,margin:"5 0 5 0",items:[{xtype:"radiogroup",listeners:{change:function(e,f,c,d){b.linear=f.linear;b._renderPlot(b.selected);}},items:[{boxLabel:"Log",name:"linear",inputValue:false,checked:true},{boxLabel:"Linear",name:"linear",inputValue:true}]}]}]};
};DataCollectionCurveVisualizer.prototype.getFrameGrid=function(c,d,a,f,e){var g=this;var b=null;if(e){b=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(l,k){var j=new Array();for(var h=0;h<k.length;h++){j.push(k[h].raw);}g._renderPlot(j);g.legendStore.loadData(j);
}}});}return Ext.create("Ext.grid.Panel",{store:c,height:a-120,width:d,selModel:b,features:[{ftype:"grouping"}],columns:[{text:f,dataIndex:"filePath",flex:1,renderer:function(m,h,j,i){var l="italic";var k=j.raw.color;if(j.raw.merged){l="bold";}else{if(j.raw.type=="FRAMES"){m=m+" <span style='font-size:9px;font-weight:bold;color:red';>[discarded]</span>";
}}if(((j.raw.type=="SUBTRACTED")||(j.raw.type=="OUT"))&&(k==g.orderColors[1])){m=m+" <span style='font-size:9px;font-weight:bold;color:gray';>[Previous data collection]</span>";}return"<span style='font-weight:"+l+";color:"+k+"'>"+m+"</span>";}},{text:"Type",dataIndex:"type",flex:1,hidden:true}]});};
DataCollectionCurveVisualizer.prototype.getGrid=function(){var d=this;this.store=this._getDataStore();var a=this.height;var c=this.width/5-5;var b=this.getFrameGrid(this.store,c,a,"Frames",true);b.on("afterrender",function(){});return b;};DataCollectionCurveVisualizer.prototype._renderPlotFromData=function(d){var u=this.id+"_plot";
var s=new Array();if(d!=null){if(d.length>0){for(var f=0;f<d.length;f++){for(var m in d[f]){s.push(d[f][m]);}}}}var g=["X"];var a=new Array();if(d!=null){if(d.length>0){for(var f=0;f<d.length;f++){for(var m in d[f]){g.push(m);}}}}for(var b=0;b<this.selected.length;b++){a.push(this.selected[b].color);
}var p=new Array();var t=10000000;var h=0;for(var f=0;f<s.length;f++){var o=Number(s[f].length);if(o<t){t=o;h=f;}}for(var f=0;f<s[h].length;f++){var r=Number(s[h][f][0]);p.push([r]);}for(var f=0;f<s.length;f++){for(var c=0;c<t;c++){try{var q=(parseFloat(s[f][c][1]));var n=Math.abs(parseFloat(s[f][c][2]));
if(c==1705){}p[c].push(this._getCoordinates(q,n));}catch(l){}}}this._renderDygraph(u,p,a,g);};DataCollectionCurveVisualizer.prototype._renderDygraph=function(d,c,b,e){var a=new StdDevDyGraph(d,{width:this.width*3/5-60,height:this.height*2/3-30,xlabel:"q (nm-1)",showRangeSelector:false});a.draw(c,b,e);
};DataCollectionCurveVisualizer.prototype._getCoordinates=function(d,b){var c=d-b;var a=d+b;if(this.linear){return[Math.abs(c),d,Math.abs(a)];}if((c!=0)&&(a!=0)){return[Math.log(Math.abs(c)),Math.log(d),Math.log(Math.abs(a))];}else{return[Math.log(d),Math.log(d),Math.log(d)];}};DataCollectionCurveVisualizer.prototype._renderPlot=function(c){var g=this;
this.selected=c;var a=new Array();var f=new Array();var d=new Array();for(var b=0;b<c.length;b++){if(c[b].frameId!=null){a.push(c[b].frameId);}if(c[b].mergeId!=null){f.push(c[b].mergeId);}if((c[b].mergeId==null)&&(c[b].frameId==null)){if(c[b].subtractionId!=null){d.push(c[b].subtractionId);}}}var e=new BiosaxsDataAdapter();
e.onSuccess.attach(function(h,i){g._renderPlotFromData(i);});e.onError.attach(function(i,h){alert("Oooops... there was an error");});e.getScatteringCurveByFrameIdsList(a,f,d);};DataCollectionCurveVisualizer.prototype.getPanel=function(){var a=this;this.panel=Ext.create("Ext.form.Panel",{id:this.id+"main",border:0,height:this.height,width:this.width,layout:{type:"table",columns:3},layout:"hbox",items:[{xtype:"container",layout:"vbox",items:[{html:'<div style="background-color:gray;" id="'+a.id+'_header";></div>',height:70,width:a.width/5-5,margin:"0 0 5 0"},this.getGrid()]},{xtype:"container",layout:"vbox",items:[{xtype:"container",layout:"hbox",width:this.width*4/5-40,height:this.height*2/3-10,items:[{html:'<br/><div id="'+this.id+'_plot" ></div>',width:this.width*3/5-40,height:this.height*2/3-10,margin:"0 5 0 5"},{xtype:"container",layout:"vbox",items:[this.getLegendGrid(),this.getSettingsPanel(this.width/5-10)]}]},{xtype:"container",layout:"hbox",width:this.width*4/5-40,height:this.height/2-10,margin:"5 0 0 0",items:[{html:'<div id="'+this.id+'_scattering" ></div>',width:this.width*1/5-20,height:this.height/3-45,margin:"0 5 0 5"},{html:'<div id="'+this.id+'_kratky" ></div>',width:this.width*1/5-20,height:this.height/3-45,margin:"0 5 0 5"},{html:'<div id="'+this.id+'_guinier" ></div>',width:this.width*1/5-20,height:this.height/3-45,margin:"0 5 0 5"},{html:'<div id="'+this.id+'_gnom" ></div>',width:this.width*1/5-20,height:this.height/3-45,margin:"0 5 0 5"},]}]}]});
return this.panel;};function CurveVisualizer(a){if(a==null){a={};}this.width=800;this.height=500;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}DataCollectionCurveVisualizer.prototype.constructor.call(this,{width:this.width,height:this.height});}CurveVisualizer.prototype.draw=DataCollectionCurveVisualizer.prototype.draw;
CurveVisualizer.prototype._getFrames=DataCollectionCurveVisualizer.prototype._getFrames;CurveVisualizer.prototype._getAverages=DataCollectionCurveVisualizer.prototype._getAverages;CurveVisualizer.prototype._getSubtractionByDataCollectionId=DataCollectionCurveVisualizer.prototype._getSubtractionByDataCollectionId;
CurveVisualizer.prototype.getLastMerges=DataCollectionCurveVisualizer.prototype.getLastMerges;CurveVisualizer.prototype._prepareData=DataCollectionCurveVisualizer.prototype._prepareData;CurveVisualizer.prototype._getImageHTML=DataCollectionCurveVisualizer.prototype._getImageHTML;CurveVisualizer.prototype._getDataStore=DataCollectionCurveVisualizer.prototype._getDataStore;
CurveVisualizer.prototype.getGrid=DataCollectionCurveVisualizer.prototype.getGrid;CurveVisualizer.prototype._renderPlotFromData=DataCollectionCurveVisualizer.prototype._renderPlotFromData;CurveVisualizer.prototype._getCoordinates=DataCollectionCurveVisualizer.prototype._getCoordinates;CurveVisualizer.prototype.refresh=function(c){this.mergeIdsList=c;
this.draw();var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(f,n){var h=[];if(n!=null){if(n.length>0){for(var g=0;g<n.length;g++){var d=n[g];h.push(d.mergeId);if(d.framelist3VO!=null){var k=[];if(d.framelist3VO.frametolist3VOs!=null){var m=[];k.push({type:"AVERAGE",color:"blue",merged:"true",filePath:d.averageFilePath,frameId:null,mergeId:d.mergeId});
d.framelist3VO.frametolist3VOs.sort(function(j,i){return j.frame3VO.frameId-i.frame3VO.frameId;});for(var e=0;e<d.framelist3VO.frametolist3VOs.length;e++){if(d.framelist3VO.frametolist3VOs[e].frame3VO!=null){m.push(d.framelist3VO.frametolist3VOs[e].frame3VO.frameId);k.push(d.framelist3VO.frametolist3VOs[e].frame3VO);
if((parseInt(d.framesMerge))>e){k[k.length-1]["type"]="FRAMES";k[k.length-1]["merged"]=true;k[k.length-1]["color"]="green";}else{k[k.length-1]["type"]="FRAMES";k[k.length-1]["merged"]=false;k[k.length-1]["color"]="red";}}}b.selected=k;b.store.loadData(k,true);}}}var l=new BiosaxsDataAdapter();l.onSuccess.attach(function(i,j){b._renderPlotFromData(j);
});l.getScatteringCurveByFrameIdsList(m,h,[]);}}});a.getMergesByIdsList(c);};CurveVisualizer.prototype.getPanel=function(){var a=this;this.panel=Ext.create("Ext.form.Panel",{id:this.id+"main",bodyStyle:"padding:5px 5px 5px  5px",height:this.height,width:this.width,layout:"hbox",items:[{xtype:"container",layout:"vbox",items:[this.getGrid()]},{html:'<br/><div id="'+this.id+'_plot" ></div>',width:this.width*4/5-30,height:this.height-50,margin:"0 5 0 5"}]});
return this.panel;};CurveVisualizer.prototype.getFrameGrid=function(c,d,a,f,e){var g=this;var b=null;if(e){b=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(l,k){var j=new Array();for(var h=0;h<k.length;h++){j.push(k[h].raw);}g._renderPlot(j);}}});
}return Ext.create("Ext.grid.Panel",{store:c,height:a-50,width:d,selModel:b,features:[{ftype:"grouping"}],dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{xtype:"button",text:"Download",handler:function(){var i="download";var h="/ispyb/user/dataadapter.do?reqCode=getZipFileByAverageListId&fileName="+i+"&mergeIdsList="+g.mergeIdsList.toString()+"&subtractionIdList="+g.subtractionIdList.toString();
console.log(h);window.location.href=h;}}]}],columns:[{text:f,dataIndex:"filePath",flex:1,renderer:function(m,h,j,i){m=m.split("/")[m.split("/").length-1];var l="italic";var k=j.raw.color;if(j.raw.merged){l="bold";}else{if(j.raw.type=="FRAMES"){m=m;}}if(((j.raw.type=="SUBTRACTED")||(j.raw.type=="OUT"))&&(k==g.orderColors[1])){m=m+" <span style='font-size:9px;font-weight:bold;color:gray';>[Previous data collection]</span>";
}return"<span style='font-weight:"+l+";color:"+k+"'>"+m+"</span>";}},{text:"Type",dataIndex:"type",flex:1,hidden:true}]});};CurveVisualizer.prototype._renderDygraph=function(d,c,b,e){var a=new StdDevDyGraph(d,{width:this.width*4/5-60,height:this.height-50,xlabel:"q (nm-1)",showRangeSelector:false});a.draw(c,b,e);
};function SubtractionCurveVisualizer(a){if(a==null){a={};}this.width=800;this.height=500;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}CurveVisualizer.prototype.constructor.call(this,{width:this.width,height:this.height});}SubtractionCurveVisualizer.prototype.draw=CurveVisualizer.prototype.draw;
SubtractionCurveVisualizer.prototype._getFrames=CurveVisualizer.prototype._getFrames;SubtractionCurveVisualizer.prototype._getAverages=CurveVisualizer.prototype._getAverages;SubtractionCurveVisualizer.prototype._getSubtractionByDataCollectionId=CurveVisualizer.prototype._getSubtractionByDataCollectionId;
SubtractionCurveVisualizer.prototype.getLastMerges=CurveVisualizer.prototype.getLastMerges;SubtractionCurveVisualizer.prototype._prepareData=CurveVisualizer.prototype._prepareData;SubtractionCurveVisualizer.prototype._getImageHTML=CurveVisualizer.prototype._getImageHTML;SubtractionCurveVisualizer.prototype._getDataStore=CurveVisualizer.prototype._getDataStore;
SubtractionCurveVisualizer.prototype.getGrid=CurveVisualizer.prototype.getGrid;SubtractionCurveVisualizer.prototype._renderPlotFromData=CurveVisualizer.prototype._renderPlotFromData;SubtractionCurveVisualizer.prototype._getCoordinates=CurveVisualizer.prototype._getCoordinates;SubtractionCurveVisualizer.prototype.refresh=function(e,b){this.mergeIdsList=e;
this.subtractionIdList=b;var d=this;var a=new BiosaxsDataAdapter();d.rawFrameData=[];d.store.loadData([],false);var c=[];a.onSuccess.attach(function(h,p){var m=[];d.selected=[];if(p!=null){if(p.length>0){for(var k=0;k<p.length;k++){var f=p[k];m.push(f.mergeId);if(f.framelist3VO!=null){var n=[];if(f.framelist3VO.frametolist3VOs!=null){n.push({type:"AVERAGE",color:"blue",merged:"true",filePath:f.averageFilePath,frameId:null,mergeId:f.mergeId,key:f.mergeId});
d.selected.push(n[n.length-1]);f.framelist3VO.frametolist3VOs.sort(function(j,i){return j.frame3VO.frameId-i.frame3VO.frameId;});for(var g=0;g<f.framelist3VO.frametolist3VOs.length;g++){if(f.framelist3VO.frametolist3VOs[g].frame3VO!=null){var l=f.framelist3VO.frametolist3VOs[g].frame3VO.frameId;c.push(l);
n.push(f.framelist3VO.frametolist3VOs[g].frame3VO);n[n.length-1]["type"]="FRAME";n[n.length-1]["key"]=l;if((parseInt(f.framesMerge))>g){n[n.length-1]["merged"]=true;n[n.length-1]["color"]="#00CC66";}else{n[n.length-1]["merged"]=false;n[n.length-1]["color"]="#FF6666";}}}d.store.loadData(n,true);}}}var o=new BiosaxsDataAdapter();
o.onSuccess.attach(function(u,t){d.rawFrameData=d.rawFrameData.concat(t);var w=[];var A="*SUBTRACTION*";for(index in Object.keys(t)){var B=Object.keys(t[index])[0];if(B.indexOf(A)!=-1){c.push(B);var r=B.split("*")[B.split("*").length-1];w.push({filePath:r,color:"purple",merged:true,type:"SUBTRACTION",key:B});
}}var v="*SAMPLE*AVERAGE*";var j="*BUFFER*AVERAGE*";for(index in Object.keys(t)){var B=Object.keys(t[index])[0];if(B.indexOf(v)!=-1){c.push(B);var r=B.split("*")[B.split("*").length-1];w.push({filePath:r,color:"black",merged:true,type:"SUBTRACTION",key:B});}if(B.indexOf(j)!=-1){c.push(B);var r=B.split("*")[B.split("*").length-1];
w.push({filePath:r,color:"grey",merged:true,type:"SUBTRACTION",key:B});}}d.selected=d.selected.concat(w);d.store.loadData(w,true);var q={};for(var s in d.selected){q[d.selected[s].key]=true;}var z=[];for(var s=0;s<t.length;s++){var B=Object.keys(t[s])[0];if(q[B]!=null){z.push(t[s]);}}d._renderPlotFromData(z);
});o.getScatteringCurveByFrameIdsList(c,m,b);}}});a.getMergesByIdsList(e);};SubtractionCurveVisualizer.prototype.getPanel=function(){var a=this;this.panel=Ext.create("Ext.form.Panel",{id:this.id+"main",bodyStyle:"padding:5px 5px 5px  5px",height:this.height,width:this.width,layout:"hbox",items:[{xtype:"container",layout:"vbox",items:[this.getGrid()]},{html:'<br/><div id="'+this.id+'_plot" ></div>',width:this.width*4/5-30,height:this.height-50,margin:"0 5 0 5"}]});
return this.panel;};SubtractionCurveVisualizer.prototype.getFrameGrid=function(c,d,a,f,e){var g=this;var b=null;if(e){b=Ext.create("Ext.selection.RowModel",{allowDeselect:true,mode:"MULTI",listeners:{selectionchange:function(l,k){var j=new Array();for(var h=0;h<k.length;h++){j.push(k[h].raw);}if(j.length>0){g._renderPlot(j);
}}}});}this.frameGrid=Ext.create("Ext.grid.Panel",{store:c,height:a-50,width:d,selModel:b,features:[{ftype:"grouping"}],dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{xtype:"button",text:"Download",handler:function(){var i="download";var h="/ispyb/user/dataadapter.do?reqCode=getZipFileByAverageListId&fileName="+i+"&mergeIdsList="+g.mergeIdsList.toString()+"&subtractionIdList="+g.subtractionIdList.toString();
window.location.href=h;}}]}],columns:[{text:f,dataIndex:"filePath",flex:1,renderer:function(m,h,j,i){m=m.split("/")[m.split("/").length-1];var l="italic";var k=j.raw.color;if(j.raw.merged){l="bold";}else{if(j.raw.type=="FRAMES"){m=m;}}if(((j.raw.type=="SUBTRACTED")||(j.raw.type=="OUT"))&&(k==g.orderColors[1])){m=m+" <span style='font-size:9px;font-weight:bold;color:gray';>[Previous data collection]</span>";
}return"<span style='font-weight:"+l+";color:"+k+"'>"+m+"</span>";}},{text:"Type",dataIndex:"type",flex:1,hidden:true}]});return this.frameGrid;};SubtractionCurveVisualizer.prototype._renderDygraph=function(d,c,b,e){var a=new StdDevDyGraph(d,{width:this.width*4/5-60,height:this.height-50,xlabel:"q (nm-1)",showRangeSelector:false});
a.draw(c,b,e);};SubtractionCurveVisualizer.prototype._renderPlot=function(c){var e=this;this.selected=c;var d=[];for(var a=0;a<c.length;a++){for(var b=0;b<e.rawFrameData.length;b++){if(Object.keys(e.rawFrameData[b])[0]==c[a].key){d.push(e.rawFrameData[b]);}}}this._renderPlotFromData(d);};function DataCollectionFrameTree(a){this.height=100;
if(a!=null){if(a.height!=null){this.height=a.height;}}this.id=BUI.id();this.framesIdToVisualize=[];this.framesId={};this.labelsId={};this.onSelectionChanged=new Event();}DataCollectionFrameTree.prototype.getPanel=function(){return{id:this.id,title:"Criteria",split:true,width:250,minHeight:550,collapsible:true,collapseDirection:Ext.Component.DIRECTION_LEFT,margins:"0 5 5 0",layout:"accordion",height:this.height-90,layoutConfig:{animate:true},items:[{title:"List",autoScroll:true,border:false,items:[this.getListGrid()]},{title:"Tree",border:false,autoScroll:true,items:[this.getFramesTree()]}]};
};DataCollectionFrameTree.prototype.getListGrid=function(){var a=this;this.listStore=Ext.create("Ext.data.Store",{fields:["frameId","filePath"],autoload:false});this.listStore.sort("filePath");this.listGrid=Ext.create("Ext.grid.Panel",{id:"listGrid"+this.id,store:this.listStore,columns:[{text:"File",dataIndex:"filePath",flex:1,renderer:function(b){return b.split("/")[b.split("/").length-1];
}}],columnLines:true,multiSelect:true,flex:1,border:0,listeners:{"selectionchange":function(b,e,d){var f=[];for(var c=0;c<e.length;c++){f.push(e[c].data.frameId);}a.notifySelectionChanged(f);}}});return this.listGrid;};DataCollectionFrameTree.prototype.getDataCollectionCode=function(a){var c="";for(var b=0;
b<a.measurementtodatacollection3VOs.length;b++){var d=this.getMacromoleculeByMeasurementId(a.measurementtodatacollection3VOs[b].measurementId);if(d!=null){return d.acronym;}}return c;};DataCollectionFrameTree.prototype.getCollectionNode=function(a,b){return{File:this.getDataCollectionCode(a),expanded:true,children:this.getMeasurements(a,b)};
};DataCollectionFrameTree.prototype.getData=function(a,c){var d=[];for(var b=0;b<a.length;b++){dataCollection=a[b];d.push(this.getCollectionNode(dataCollection,c));}return d;};DataCollectionFrameTree.prototype.getSpecimenByMeasurementId=function(a){var b=this.experiments[0].getMeasurementById(a);return this.experiments[0].getSpecimenById(b.specimenId);
};DataCollectionFrameTree.prototype.getMacromoleculeByMeasurementId=function(a){var b=this.getSpecimenByMeasurementId(a);return BIOSAXS.proposal.getMacromoleculeById(b);};DataCollectionFrameTree.prototype.getMeasurements=function(g,b){var c=[];for(var e=0;e<g.measurementtodatacollection3VOs.length;e++){var h=this.getSpecimenByMeasurementId(g.measurementtodatacollection3VOs[e].measurementId);
var a="BUFFER";if(h.macromolecule3VO!=null){a=h.macromolecule3VO.acronym+":  "+parseFloat(h.concentration).toFixed(2)+" mg/ml";}else{a=BIOSAXS.proposal.getBufferById(h.bufferId);}var k=this.getFrames(g.measurementtodatacollection3VOs[e].measurementId,b);if(k.length>0){var f=[];for(var d=0;d<k.length;
d++){if(k[d].children!=null){if(k[d].children.length>0){f.push(k[d]);}}else{f.push(k[d]);}}c.push({File:a,dataCollectionOrder:g.measurementtodatacollection3VOs[e].dataCollectionOrder,expanded:false,children:f,frameId:null});}}return c;};DataCollectionFrameTree.prototype.getFrames=function(b,e){var d=[];
if(e!=null){for(var a=0;a<e.length;a++){if(e[a].measurementId==b){for(var c=0;c<e[a].framelist3VO.frametolist3VOs.length;c++){var g=e[a].framelist3VO.frametolist3VOs[c].frame3VO.filePath.split("/")[e[a].framelist3VO.frametolist3VOs[c].frame3VO.filePath.split("/").length-1];this.framesId[e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId]=this.getSpecimenByMeasurementId(b);
this.labelsId[e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId]=g;if(g.indexOf("_ave.dat")!=-1){d.push({File:g,frameId:e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId,id:e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId,expanded:true,leaf:true});this.framesIdToVisualize.push(e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId);
}}}}d.push({File:"Frames",children:this.getFramesNoAverage(b,e),expanded:false,leaf:false});}return d;};DataCollectionFrameTree.prototype.getFramesNoAverage=function(b,e){var d=[];if(e!=null){for(var a=0;a<e.length;a++){if(e[a].measurementId==b){for(var c=0;c<e[a].framelist3VO.frametolist3VOs.length;
c++){var g=e[a].framelist3VO.frametolist3VOs[c].frame3VO.filePath.split("/")[e[a].framelist3VO.frametolist3VOs[c].frame3VO.filePath.split("/").length-1];this.framesId[e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId]=this.getSpecimenByMeasurementId(b);this.labelsId[e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId]=g;
if(g.indexOf("_ave.dat")==-1){d.push({File:g,frameId:e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId,id:e[a].framelist3VO.frametolist3VOs[c].frame3VO.frameId,expanded:false,leaf:true});}}}}}return d;};DataCollectionFrameTree.prototype.getSpecimenById=function(a){for(var b=0;b<this.experiments.length;
b++){var c=this.experiments[b].getMeasurementById(a);if(c!=null){return c;}}return null;};DataCollectionFrameTree.prototype.loadDatacollections=function(e,a,j){this.experiments=j;var h=[];var f=[];for(var c=0;c<a.length;c++){var b=this.experiments[0].getMeasurementById(a[c].measurementId);var k=this.experiments[0].getSpecimenById(b.specimenId);
var g=BIOSAXS.proposal.getMacromoleculeById(k);if(g!=null){if(f[g.acronym]==null){h.push(g);f[g.acronym]=true;}}}this.store.getRootNode().removeAll();this.store.getRootNode().appendChild(this.getData(e,a));var d=new ExperimentList().getFrames(a);this.listStore.loadData(d);};DataCollectionFrameTree.prototype.getDataCollectionById=function(c){for(var b=0;
b<this.experiments.length;b++){var a=this.experiments[b].getDataCollectionById(c);if(a!=null){return a;}}return null;};DataCollectionFrameTree.prototype.notifySelectionChanged=function(a){this.onSelectionChanged.notify({ids:a,framesHash:this.framesId,labelsHash:this.labelsId});};DataCollectionFrameTree.prototype.getFramesTree=function(){var a=this;
Ext.define("File",{extend:"Ext.data.Model",fields:[{name:"dataCollectionOrder",type:"string"},{name:"File",type:"string"},{name:"frameId",type:"string"},{name:"id",type:"string"}]});this.store=Ext.create("Ext.data.TreeStore",{model:"File",root:{expanded:true,children:[]},autoload:true});this.store.sort([{property:"dataCollectionOrder",direction:"ASC"},{property:"File",direction:"ASC"}]);
this.tree=Ext.create("Ext.tree.Panel",{height:"465",minHeight:"465",selModel:{mode:"MULTI",allowDeselect:true},allowDeselect:true,rootVisible:false,store:this.store,columns:[{xtype:"treecolumn",text:"Data Collections",flex:2,sortable:true,dataIndex:"File",renderer:function(c,d,b){if(b.raw.frameId==null){return"<span style='font-size:small;'>"+c+"</span>";
}if(c.indexOf("_ave.dat")!=-1){return"<span style='font-weight:bold;'>"+c+"</span>";}return"<span style='font-size:x-small;'>"+c+"</span>";}}],listeners:{"selectionchange":function(b,e,d){var f=[];for(var c=0;c<e.length;c++){if(e[c].data.frameId!=null){if(e[c].data.frameId!=null){if(e[c].data.frameId!=""){f.push(e[c].data.frameId);
}}}}if(f.length>0){a.notifySelectionChanged(f);}}}});return this.tree;};DataCollectionFrameTree.prototype.input=function(){return DATADOC.getFrameTreeData();};DataCollectionFrameTree.prototype.test=function(b){var c=new DataCollectionFrameTree({height:this.height});BIOSAXS.proposal=new Proposal(c.input().proposal);
var a=c.getPanel();c.loadDatacollections(c.input().dataCollections,c.input().merges,[new Experiment(c.input().experiment)]);Ext.create("Ext.panel.Panel",{width:1000,items:[a],renderTo:b});};function ExperimentTypeWizardForm(a){var b=this;this.height=500;GenericStepWizardForm.call(this,"Select your type of experiment",{margin:"0 0 0 0",width:475,border:0,html:"Two type of experiments are allowed: <span style='font-weight:bold'>STATIC</span> and  <span style='font-weight:bold'>HPLC</span>. Static use quartz capillary as a part of automated sample changer allowing temperature variations (from 4 to 60C). HPLC (high performance liquid chromatography) system can be used in parallel with sample changer"},{experimentType:"None"},function(){console.log(b.data);
},function(){});}ExperimentTypeWizardForm.prototype.getForm=function(){var a=this;return Ext.create("Ext.panel.Panel",{width:600,height:250,border:0,margin:"100 0 0 150",layout:"vbox",items:[{xtype:"fieldset",items:[{xtype:"checkboxgroup",width:400,height:100,border:0,fieldLabel:"Experiment Type",columns:1,items:[{boxLabel:"Sample Changer",name:"cb-col-2",checked:true},{boxLabel:"HPLC",name:"cb-col-3",disabled:true}]}]}]});
};ExperimentTypeWizardForm.prototype.getNextForm=function(){return new MacromoleculeSelectorWizardForm();};ExperimentTypeWizardForm.prototype.input=function(){return[];};ExperimentTypeWizardForm.prototype.test=function(a){var c=new ExperimentTypeWizardForm();var b=c.getForm();b.render(a);};function FinalStepWizardForm(a){this.result={};
this.id=BUI.id();this.title="Confirmation";this.description="This is the last step of this wizard. Write a name and a description (optional) for your experiment. Remember you are able to add new measurements later on";this.height=500;this.data={measurements:a};var b=this;this.onNext=function(c){this.result={name:Ext.getCmp(b.id+"name").getValue(),comments:Ext.getCmp(b.id+"description").getValue(),data:b.data.measurements};
b.onWizardFinished.notify(this.result);};this.onBack=function(){};this.onWizardFinished=new Event(this);}FinalStepWizardForm.prototype.getForm=function(){this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:1,margin:"100 100 100 100",fieldDefaults:{labelAlign:"left",labelWidth:90,anchor:"100%"},items:[{xtype:"textfield",name:"Name",id:this.id+"name",width:600,fieldLabel:"Name",margin:"20 20 20 20",value:""},{xtype:"textareafield",name:"textarea1",id:this.id+"description",margin:"20 20 20 20",width:600,fieldLabel:"Description",value:""}]});
return this.panel;};FinalStepWizardForm.prototype.getNextForm=function(){return null;};FinalStepWizardForm.prototype.input=function(){return[];};FinalStepWizardForm.prototype.test=function(a){var c=new FinalStepWizardForm();var b=c.getForm();b.render(a);};function GenericStepWizardForm(e,c,d,b,a){this.id=BUI.id();
this.title=e;this.description=c;this.data=d;this.onNext=b;this.onBack=a;}GenericStepWizardForm.prototype.getForm=function(){alert("[getForm] Not implemented");};GenericStepWizardForm.prototype.getNextForm=function(){alert("[getNextForm] Not implemented");};GenericStepWizardForm.prototype.reload=function(){alert("[getNextForm] Not implemented");
};function MacromoleculeSelectorWizardForm(a){var b=this;this.height=500;GenericStepWizardForm.call(this,"Select Macromolecules",{margin:"0 0 0 0",width:475,border:0,html:"Define the macromolecules involved in the experiment.<br /> Click on the macromolecule you want to select and <span style='font-weight:bold'>hold CONTROL</span> to select severals"},{macromoleculesSelected:null},function(){if(b.nextForm!=null){}},function(){});
}MacromoleculeSelectorWizardForm.prototype.reload=function(){if(this.data.macromoleculesSelected!=null){for(var a=0;a<this.data.macromoleculesSelected.length;a++){this.MacromoleculeGrid.selectById(this.data.macromoleculesSelected[a].macromoleculeId);}}};MacromoleculeSelectorWizardForm.prototype.getForm=function(){var a=this;
this.MacromoleculeGrid=new MacromoleculeGrid({height:310,searchBar:false,tbar:false,collapsed:false,collapsible:false,btnEditVisible:false,btnRemoveVisible:false,multiselect:true,cssFontStyle:"font-size:small;"});this.MacromoleculeGrid.onSelected.attach(function(c,d){a.data.macromoleculesSelected=d;var e="Selected: ";
for(var b=0;b<d.length;b++){e=e+d[b].acronym+", ";if(b==5){e=e+"<span style='font-weight:bold;'> and "+(d.length-6)+" more</span>";b=d.length-1;}}document.getElementById(a.id+"selectHTML").innerHTML=e;});this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,height:450,border:0,margin:"20 5 5 10",items:[a.MacromoleculeGrid.getPanel([]),{margin:"10 0 0 10",width:475,border:0,html:"<div id='"+a.id+"selectHTML'>None selected</div>"}]});
BIOSAXS.proposal.onInitialized.attach(function(b){a.macromolecules=BIOSAXS.proposal.macromolecules;a.MacromoleculeGrid.refresh(a.macromolecules);});BIOSAXS.proposal.init();return this.panel;};MacromoleculeSelectorWizardForm.prototype.getNextForm=function(){if(this.nextForm==null){this.nextForm=new MeasurementCreatorStepWizardForm(this.data.macromoleculesSelected);
}return this.nextForm;};function MeasurementCreatorStepWizardForm(a,b){var c=this;this.height=700;this.noNext=false;this.macromolecules=a;GenericStepWizardForm.call(this,"Define Measurements",{margin:"0 0 0 0",width:475,border:0,html:"Define only the macromolecule's measurement you want to make. This wizard will add <span style='font-weight:bold;'> buffers' measurement needed for substraction automatically. </span>"},{measurementsSelected:null},function(){if(c.noNext){var d={name:"",comments:"",data:JSON.stringify(c.parseMeasurements(c.data.measurementsSelected))};
c.onWizardFinished.notify(d);}},function(){});if(b!=null){if(b.noNext!=null){this.noNext=b.noNext;}}if(this.noNext){this.onWizardFinished=new Event(this);}}MeasurementCreatorStepWizardForm.prototype.setData=function(f){this.data.measurementsSelected=f;var b={};var c={};for(var e=0;e<this.data.measurementsSelected.length;
e++){var a=this.data.measurementsSelected[e];if(b[a.bufferId]==null){b[a.bufferId]={buffer:a.buffer_acronym,bufferId:a.bufferId,volume:0,concentration:0};}var d=a.macromoleculeId+"_"+a.bufferId+"_"+a.concentration;if(c[d]==null){c[d]={macromolecule:a.acronym,macromoleculeId:a.macromoleculeId,buffer:a.buffer_acronym,bufferId:a.bufferId,volume:0,concentration:a.concentration};
}b[a.bufferId].volume=Number(b[a.bufferId].volume)+(2*a.volumeToLoad);c[d].volume=Number(c[d].volume)+(a.volumeToLoad);}};MeasurementCreatorStepWizardForm.prototype.getSingleMeasurementForm=function(){var c=BIOSAXS_COMBOMANAGER.getComboMacromoleculeByMacromolecules(this.macromolecules,{width:200,labelWidth:100});
var a=BIOSAXS_COMBOMANAGER.getComboBuffers(BIOSAXS.proposal.getBuffers(),{margin:"0 0 0 80",width:200,labelWidth:100});var b=Ext.create("Ext.Button",{width:200,height:25,margin:"0 0 20 300",text:"Add",scope:this,handler:function(){var f=Ext.getCmp(this.id+"quantity").getValue();var d=[];for(var e=0;e<f;
e++){d.push({acronym:BIOSAXS.proposal.getMacromoleculeById(c.getValue()).acronym,macromoleculeId:c.getValue(),bufferId:a.getValue(),buffer_acronym:BIOSAXS.proposal.getBufferById(a.getValue()).acronym,concentration:Ext.getCmp(this.id+"conc").getValue(),volumeToLoad:Ext.getCmp(this.id+"volume").getValue(),exposureTemperature:Ext.getCmp(this.id+"seu").getValue(),transmission:Ext.getCmp(this.id+"transmission").getValue(),waitTime:Ext.getCmp(this.id+"waitTime").getValue(),viscosity:Ext.getCmp(this.id+"viscosity").getValue(),flow:Ext.getCmp(this.id+"flow").getValue()});
}this.measurementGrid.grid.getStore().loadData(d,true);this.setData(JSON.parse(Ext.encode(Ext.pluck(this.measurementGrid.grid.getStore().data.items,"data"))));}});return Ext.create("Ext.panel.Panel",{padding:"0 0 0 0",border:0,margin:"10 5 20 10",height:220,items:[{xtype:"container",layout:"hbox",items:[c,a,{xtype:"numberfield",id:this.id+"quantity",fieldLabel:"Repeat",labelWidth:100,width:200,margin:"0 0 0 50",minValue:0,maxValue:300,value:1}]},{xtype:"container",layout:"hbox",items:[{xtype:"numberfield",id:this.id+"conc",fieldLabel:"Conc. (mg/ml)",labelWidth:100,width:200,margin:"0 0 0 0",minValue:0,maxValue:300,value:1},{xtype:"numberfield",id:this.id+"seu",fieldLabel:"Exposure. Temp.",labelWidth:100,width:200,margin:"0 0 0 80",value:4,minValue:4,maxValue:60}]},{xtype:"container",margin:"5 0 0 0",layout:"hbox",items:[{xtype:"numberfield",id:this.id+"volume",fieldLabel:"Vol. To Load (&#181l)",labelWidth:100,width:200,value:40,minValue:10,maxValue:300},{xtype:"numberfield",id:this.id+"transmission",fieldLabel:"Transmission (%)",labelWidth:100,width:200,margin:"0 0 0 80",value:100,minValue:0,maxValue:100}]},{xtype:"container",layout:"hbox",margin:"5 0 0 0",items:[{xtype:"numberfield",id:this.id+"waitTime",fieldLabel:"Wait Time",labelWidth:100,width:200,value:0,minValue:0,maxValue:100},{xtype:"combo",id:this.id+"viscosity",store:["low","medium","high"],fieldLabel:"Viscosity",value:"low",labelWidth:100,width:200,margin:"0 0 0 80"},{xtype:"checkbox",id:this.id+"flow",checked:true,fieldLabel:"Flow",labelWidth:100,width:250,margin:"0 0 0 80"}]},{xtype:"container",layout:"hbox",margin:"30 0 0 0",items:[b]}]});
};MeasurementCreatorStepWizardForm.prototype.getConcentrationMeasurementForm=function(){var c=BIOSAXS_COMBOMANAGER.getComboMacromoleculeByMacromolecules(this.macromolecules,{width:200,labelWidth:100});var a=BIOSAXS_COMBOMANAGER.getComboBuffers(BIOSAXS.proposal.getBuffers(),{margin:"0 0 0 80",width:200,labelWidth:100});
var b=Ext.create("Ext.Button",{width:200,height:25,margin:"0 0 20 300",text:"Add",scope:this,handler:function(){var o=c.getValue();var d=a.getValue();var h=Ext.getCmp(this.id+"_cs_conc").getValue();var m=Ext.getCmp(this.id+"_cs_volume").getValue();var g=Ext.getCmp(this.id+"_cs_transmission").getValue();
var n=Ext.getCmp(this.id+"_cs_seu").getValue();var f=Ext.getCmp(this.id+"_cs_waitTime").getValue();var k=Ext.getCmp(this.id+"_cs_viscosity").getValue();var e=Ext.getCmp(this.id+"_cs_flow").getValue();var l=[];for(var j=1;j<=h;j++){l.push({acronym:BIOSAXS.proposal.getMacromoleculeById(o).acronym,macromoleculeId:o,bufferId:d,buffer_acronym:BIOSAXS.proposal.getBufferById(d).acronym,concentration:j,volumeToLoad:m,exposureTemperature:n,transmission:g,waitTime:f,viscosity:k,flow:e});
}this.measurementGrid.grid.getStore().loadData(l,true);this.setData(JSON.parse(Ext.encode(Ext.pluck(this.measurementGrid.grid.getStore().data.items,"data"))));}});return Ext.create("Ext.panel.Panel",{padding:"0 0 0 0",border:0,margin:"5 5 20 10",height:220,items:[{xtype:"container",layout:"hbox",items:[c,a]},{xtype:"container",layout:"hbox",items:[{xtype:"requirednumberfield",id:this.id+"_cs_conc",fieldLabel:"How many unknow concentrations do you have?",labelWidth:380,style:{fontWeight:"bold"},width:480,margin:"10 0 0 0",minValue:0,maxValue:20,value:0}]},{xtype:"container",margin:"10 0 0 0",layout:"hbox",items:[{xtype:"numberfield",id:this.id+"_cs_seu",fieldLabel:"Exposure. Temp.",labelWidth:100,width:200,margin:"0 0 0 0",value:4,minValue:4,maxValue:60},{xtype:"numberfield",margin:"0 0 0 80",id:this.id+"_cs_volume",fieldLabel:"Vol. To Load (&#181l)",labelWidth:100,width:200,value:40,minValue:10,maxValue:300},{xtype:"numberfield",id:this.id+"_cs_transmission",fieldLabel:"Transmission (%)",labelWidth:100,width:200,margin:"0 0 0 80",value:100,minValue:0,maxValue:100}]},{xtype:"container",layout:"hbox",margin:"5 0 0 0",items:[{xtype:"numberfield",id:this.id+"_cs_waitTime",fieldLabel:"Wait Time",labelWidth:100,width:200,value:0,minValue:0,maxValue:100},{xtype:"combo",id:this.id+"_cs_viscosity",store:["low","medium","high"],fieldLabel:"Viscosity",value:"low",labelWidth:100,width:200,margin:"0 0 0 80"},{xtype:"checkbox",id:this.id+"_cs_flow",fieldLabel:"Flow",checked:true,labelWidth:100,width:250,margin:"0 0 0 80"}]},{xtype:"container",layout:"hbox",margin:"20 0 0 0",items:[b]}]});
};MeasurementCreatorStepWizardForm.prototype.getForm=function(){var a=this;this.formPanel=Ext.create("Ext.tab.Panel",{padding:"0 0 0 0",margin:"20 5 20 10",height:220,items:[{tabConfig:{title:"Individual Measurement"},items:[this.getSingleMeasurementForm()]},{tabConfig:{title:"Concentration Series"},items:this.getConcentrationMeasurementForm()}]});
this.measurementGrid=new MeasurementGrid({height:300,maxHeight:300,minHeight:300,width:870,tbar:false,maxWidth:870,resizable:false,margin:"0 10 10 10",isStatusColumnHidden:true,isTimeColumnHidden:true,removeBtnEnabled:true,isPriorityColumnHidden:true});this.measurementGrid.onRemoved.attach(function(b,c){a.setData(JSON.parse(Ext.encode(Ext.pluck(a.measurementGrid.grid.getStore().data.items,"data"))));
});this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,items:[this.formPanel,this.addButton,this.measurementGrid.getPanel([])]});if(this.data.measurementsSelected!=null){this.measurementGrid.grid.getStore().loadData(this.data.measurementsSelected,false);this.setData(JSON.parse(Ext.encode(Ext.pluck(this.measurementGrid.grid.getStore().data.items,"data"))));
}return this.panel;};MeasurementCreatorStepWizardForm.prototype.getBuffers=function(d){var c={};var e={};var b=null;for(var f=0;f<d.length;f++){b=d[f];if(c[b.bufferId]==null){c[b.bufferId]={buffer:b.buffer_acronym,bufferId:b.bufferId,volumeToLoad:b.volumeToLoad,volume:0,concentration:0,transmission:b.transmission,flow:b.flow,viscosity:b.viscosity,};
}c[b.bufferId].volume=Number(c[b.bufferId].volume)+(2*b.volumeToLoad);}var g=[];for(var a in c){if(c.hasOwnProperty(a)){b=c[a];g.push({bufferId:b.bufferId,buffer:BIOSAXS.proposal.getBufferById(b.bufferId).acronym,concentration:b.concentration,volume:b.volume,volumeToLoad:b.volumeToLoad,transmission:b.transmission,flow:b.flow,viscosity:b.viscosity});
}}return g;};MeasurementCreatorStepWizardForm.prototype.parseMeasurements=function(a){var e=this;var g=[];var b=null;var c=null;var j=this.getBuffers(a);for(c=0;c<j.length;c++){b=j[c];g.push({SEUtemperature:"",buffer:b.buffer,buffername:b.buffer,code:b.buffer,comments:"",concentration:0,enable:true,flow:b.flow,recuperate:false,title:"",transmission:b.transmission,macromolecule:b.buffer,type:"Buffer",typen:1,viscosity:b.viscosity,volume:b.volume,volumeToLoad:b.volumeToLoad,waittime:0,plate:null,row:null,well:null});
}for(c=0;c<a.length;c++){b=a[c];var f="Buffer";var h="";if(b.macromoleculeId!=null){f="Sample";h=BIOSAXS.proposal.getMacromoleculeById(b.macromoleculeId).acronym;}g.push({SEUtemperature:b.exposureTemperature,buffer:b.buffer_acronym,buffername:b.buffer_acronym,code:h,comments:"",concentration:b.concentration,enable:true,flow:b.flow,recuperate:false,title:"",transmission:b.transmission,macromolecule:h,type:f,typen:1,viscosity:b.viscosity,volume:b.volumeToLoad,volumeToLoad:b.volumeToLoad,waittime:b.waitTime,plate:null,row:null,well:null});
}var d=new SampleAutomaticPositionFactory(g);return d.setPosition();};MeasurementCreatorStepWizardForm.prototype.getNextForm=function(){return new FinalStepWizardForm(JSON.stringify(this.parseMeasurements(this.data.measurementsSelected)));};function SampleAutomaticPositionFactory(a){this.samples=a;}SampleAutomaticPositionFactory.prototype.getAvailablePlates=function(){var j=BIOSAXS.proposal.getPlateByFlavour();
var k=[];var a=[];for(var d=0;d<j.length;d++){if(j[d].plateTypeId==2){for(var h=0;h<12;h++){k.push({plate:2,row:Math.floor(h/3)+1,well:Number(Number(h%3)+9)});}var g=0;var b={};for(var h=0;h<32;h++){var e={plate:2,row:Math.floor(h/8)+1,well:Number(h%8)+1-g};a.push(e);}}}for(var d=0;d<j.length;d++){if(j[d].plateTypeId!=2){for(var f=0;
f<j[d].rowCount;f++){for(var c=0;c<j[d].columnCount;c++){k.push({plate:d+1,row:f+1,well:c+1});}}for(var f=0;f<j[d].rowCount;f++){for(var c=0;c<j[d].columnCount;c++){a.push({plate:d+1,row:f+1,well:c+1});}}}}return{buffer:k.reverse(),sample:a.reverse()};};SampleAutomaticPositionFactory.prototype._getKey=function(a,c,b){return a+":"+c+"-"+b;
};SampleAutomaticPositionFactory.prototype.setPosition=function(){var b=(this.getAvailablePlates());var a={};for(var f=0;f<this.samples.length;f++){if(this.samples[f].type=="Buffer"){var e=this._getKey(this.samples[f].plate,this.samples[f].row,this.samples[f].well);this.samples[f].plate=b.buffer[b.buffer.length-1].plate,this.samples[f].row=b.buffer[b.buffer.length-1].row;
this.samples[f].well=b.buffer[b.buffer.length-1].well;a[e]=true;b.buffer.pop();}}var d={};for(var f=0;f<this.samples.length;f++){if(this.samples[f].type=="Sample"){var e=this._getKey(b.sample[b.sample.length-1].plate,b.sample[b.sample.length-1].row,b.sample[b.sample.length-1].well);while(a[e]!=null){b.sample.pop();
e=this._getKey(b.sample[b.sample.length-1].plate,b.sample[b.sample.length-1].row,b.sample[b.sample.length-1].well);}var c=this.samples[f].macromolecule+"_"+this.samples[f].buffer+"_"+this.samples[f].concentration;if(d[c]==null){d[c]={plate:b.sample[b.sample.length-1].plate,row:b.sample[b.sample.length-1].row,well:b.sample[b.sample.length-1].well,};
}else{this.samples[f].plate=d[c].plate,this.samples[f].row=d[c].row;this.samples[f].well=d[c].well;continue;}this.samples[f].plate=b.sample[b.sample.length-1].plate,this.samples[f].row=b.sample[b.sample.length-1].row;this.samples[f].well=b.sample[b.sample.length-1].well;a[e]=true;b.sample.pop();}}return this.samples;
};function WizardWidget(a){this.targetId=null;this.width=910;this.height=400;this.windowMode=true;if(a!=null){if(a.windowMode!=null){this.windowMode=a.windowMode;}}this.step=0;this.forms=[];this.onFinished=new Event(this);}WizardWidget.prototype.draw=function(a,b){this.targetId=a;this.forms.push(b);this.renderMasterContainer();
};WizardWidget.prototype.getButtons=function(c,b,a){var d=this;if(d.forms[d.step].onWizardFinished!=null){return[{text:"Back",handler:function(){d.step=d.step-1;d.renderMasterContainer();a();d.forms[d.step].reload();}},"->",{text:"Finish",handler:function(){d.forms[d.step].onWizardFinished.attach(function(f,e){d.onFinished.notify(e);
});d.step=d.step+1;b(d.forms[d.step-1].data);}}];}if(c==0){return["->",{text:"Next",handler:function(){d.forms.push(d.forms[d.step].getNextForm());d.step=d.step+1;d.renderMasterContainer();b(d.forms[d.step-1].data);}}];}if((this.step>0)&&(this.forms[d.step].onWizardFinished==null)){return[{text:"Back",handler:function(){d.step=d.step-1;
d.renderMasterContainer();a();d.forms[d.step].reload();}},"->",{text:"Next",handler:function(){if(d.forms[d.step].onWizardFinished==null){d.forms.push(d.forms[d.step].getNextForm());d.step=d.step+1;b(d.forms[d.step-1].data);d.renderMasterContainer();}else{d.forms[d.step].onWizardFinished.attach(function(f,e){d.window.close();
d.onFinished.notify(e);});d.step=d.step+1;b(d.forms[d.step-1].data);}}}];}};WizardWidget.prototype.renderMasterContainer=function(){var a=this;if(this.current!=null){this.current.destroy();}if(this.window!=null){this.window.destroy();}this.current=Ext.create("Ext.form.Panel",{width:this.width,height:this.forms[this.step].height,items:[{margin:"10 0 0 20",width:475,border:0,html:"<span style='font-weight:bold;'>"+this.forms[this.step].title+"</span>"},{margin:"10 0 0 40",width:475,border:0,html:this.forms[this.step].description},this.forms[this.step].getForm()],buttons:this.getButtons(this.step,this.forms[this.step].onNext,this.forms[this.step].onBack)});
if(this.windowMode==false){this.current.render(this.targetId);}else{this.window=Ext.create("Ext.Window",{id:this.id,resizable:true,constrain:true,border:1,modal:true,frame:false,draggable:true,autoscroll:true,layout:{type:"vbox",align:"stretch"},items:this.current,width:this.width,title:"BIOSAXS Experiment Designer",height:this.forms[this.step].height+60,listeners:{scope:this,minimize:function(){this.panel.hide();
},destroy:function(){delete this.panel;}}});this.window.show();}};function AbinitioWindow(a){}AbinitioWindow.prototype.getGrid=function(a){this.grid=new AbinitioGrid().getPanel(a);return this.grid;};AbinitioWindow.prototype.show=function(a){Ext.create("Ext.window.Window",{title:"Abinitio Models",height:500,width:800,layout:"fit",items:[this.getGrid(a)]}).show();
};BufferWindow.prototype.getButtons=GenericWindow.prototype.getButtons;BufferWindow.prototype._render=GenericWindow.prototype._render;BufferWindow.prototype._postRender=GenericWindow.prototype._postRender;function BufferWindow(a){this.width=550;this.height=500;if(a!=null){if(a.actions!=null){this.actions=a.actions;
}}_this=this;this.form=new BufferForm();this.onSuccess=new Event();GenericWindow.prototype.constructor.call(this,{form:this.form,width:this.width,height:this.height});}BufferWindow.prototype.save=function(){var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(d,c){BIOSAXS.proposal.setItems(c);
b.onSuccess.notify(c);b.panel.close();});if(this.form.getBuffer().name==""){BUI.showError("Name field is mandatory");return;}if(this.form.getBuffer().acronym==""){BUI.showError("Acroynm field is mandatory");return;}if(this.form.getBuffer().composition==""){BUI.showError("Composition field is mandatory");
return;}this.panel.setLoading("ISPyB: Saving buffer");a.saveBuffer(this.form.getBuffer());};BufferWindow.prototype.draw=function(a){if(a.bufferId==null){this.title="New buffer";}else{this.title=a.name;}this._render(a);};CaseWindow.prototype.getButtons=GenericWindow.prototype.getButtons;CaseWindow.prototype._render=GenericWindow.prototype._render;
CaseWindow.prototype._postRender=GenericWindow.prototype._postRender;function CaseWindow(a){this.width=720;this.height=500;if(a!=null){if(a.actions!=null){this.actions=a.actions;}}_this=this;this.onRemoveAdditive=new Event(this);this.form=new CaseForm();this.form.onAddPlates.attach(function(c,b){_this.onSavePlates.notify(b);
});this.form.onRemovePlates.attach(function(c,b){_this.onSavePlates.notify([b]);});GenericWindow.prototype.constructor.call(this,{title:"Edit Case",form:this.form,width:this.width,height:this.height});}CaseWindow.prototype.save=function(){if(this.form.getDewar().code==""){BUI.showError("Code field is mandatory");
return;}this.onSaved.notify(this.form.getDewar());this.panel.close();};CaseWindow.prototype.draw=function(b,a){this.dewar=b;this.plates=a;this._render(b,a);};function ExperimentWindow(a){this.id=BUI.id();this.actions=new Array();if(a!=null){if(a.actions!=null){this.actions=a.actions;}}this.onSaved=new Event(this);
}ExperimentWindow.prototype.getButtons=function(){var a=this;return[{text:"Save",handler:function(){var e=a.experiment.json.experimentId;var c=Ext.getCmp(a.form.id+"name").getValue();var d=Ext.getCmp(a.form.id+"type").getValue();var f=Ext.getCmp(a.form.id+"comments").getValue();var b=new BiosaxsDataAdapter();
a.form.panel.setLoading("ISPyB: Saving experiment");b.onSuccess.attach(function(g){a.form.panel.setLoading(false);a.onSaved.notify({name:c,type:d,comments:f});a.panel.close();});b.onError.attach(function(g){a.form.panel.setLoading(false);BUI.showError("Ooops: There was an error");});b.saveExperiment(e,c,d,f);
}},{text:"Cancel",handler:function(){a.panel.close();}}];};ExperimentWindow.prototype.show=function(a){this.experiment=a;this.form=new ExperimentForm();this.panel=Ext.create("Ext.window.Window",{title:"Experiment",height:300,width:500,layout:"fit",buttonAlign:"right",buttons:this.getButtons(),items:[this.form.getPanel(a)]});
this.panel.show();};MacromoleculeWindow.prototype.getButtons=GenericWindow.prototype.getButtons;MacromoleculeWindow.prototype._render=GenericWindow.prototype._render;MacromoleculeWindow.prototype._postRender=GenericWindow.prototype._postRender;function MacromoleculeWindow(a){this.width=600;this.height=500;
if(a!=null){if(a.actions!=null){this.actions=a.actions;}}this.form=new MacromoleculeForm({width:this.width-100});GenericWindow.prototype.constructor.call(this,{form:this.form,width:this.width,height:this.height});this.onSuccess=new Event();}MacromoleculeWindow.prototype.save=function(){var b=this;var a=new BiosaxsDataAdapter();
a.onSuccess.attach(function(d,c){BIOSAXS.proposal.setItems(c);b.onSuccess.notify(c);b.panel.close();});if(this.form.getMacromolecule().name==""){BUI.showError("Name field is mandatory");return;}if(this.form.getMacromolecule().acronym==""){BUI.showError("Acroynm field is mandatory");return;}this.panel.setLoading("ISPyB: Saving Macromolecule");
a.saveMacromolecule(this.form.getMacromolecule());};MacromoleculeWindow.prototype.draw=function(b,a){this.title="Macromolecule ";if(b.name!=null){this.title="Macromolecule "+b.name;}this.experiment=a;this._render(b,a);};function MultipleEditMeasurementGridWindow(){this.id=BUI.id();var a=this;this.measurementGrid=new MeasurementGrid({height:400,maxHeight:400,width:960,maxWidth:1000,resizable:false,estimateTime:false,positionColumnsHidden:true,isPriorityColumnHidden:true,isStatusColumnHidden:true,isTimeColumnHidden:true,updateRowEnabled:false,collapsed:true,addBtnEnable:false,showTitle:false,removeBtnEnabled:false,collapseBtnEnable:false,addBtnMultipleEdit:false,selModel:Ext.create("Ext.selection.CheckboxModel",{allowDeselect:true,scope:this,mode:"MULTI",listeners:{selectionchange:function(c,b){if(b.length==0){this.scope.measurementGrid._showStatusBarBusy("No measurements Selected");
this.scope.saveBtn.setDisabled(true);this.scope.macromoleculeSaveBtn.setDisabled(true);this.scope.bufferSaveBtn.setDisabled(true);}else{this.scope.measurementGrid._showStatusBarReady(b.length+" measurements selected");this.scope.saveBtn.setDisabled(false);this.scope.macromoleculeSaveBtn.setDisabled(false);
this.scope.bufferSaveBtn.setDisabled(false);}}}}),editor:{},sorter:[{property:"priority",direction:"ASC"}]});this.onExperimentChanged=new Event(this);}MultipleEditMeasurementGridWindow.prototype.getMacromoleculeCombo=function(){this.macromoleculeCombo=BIOSAXS_COMBOMANAGER.getComboMacromoleculeByMacromolecules(BIOSAXS.proposal.getMacromolecules(),{labelWidth:100,margin:"0 0 0 10",width:300});
this.macromoleculeCombo.setFieldLabel("or Macromolecule");return this.macromoleculeCombo;};MultipleEditMeasurementGridWindow.prototype.getBufferCombo=function(){this.bufferCombo=BIOSAXS_COMBOMANAGER.getComboBuffers(BIOSAXS.proposal.getBuffers(),{labelWidth:100,margin:"0 0 0 10",width:300});this.bufferCombo.setFieldLabel("or Buffer");
return this.bufferCombo;};MultipleEditMeasurementGridWindow.prototype.save=function(g,e){var d=this.measurementGrid.grid.getSelectionModel().getSelection();var c=new Array();for(var b=0;b<d.length;b++){c.push(d[b].raw.measurementId);}var f=this;if(g!=""){this.measurementGrid.grid.setLoading("ISPyB: Saving measurements");
if(c.length>0){var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(h,j){var i=new BiosaxsDataAdapter();i.onSuccess.attach(function(l,m){var k=new Experiment(m);f.measurementGrid.refresh(k.getMeasurements(),new ExperimentList([k]));f.measurementGrid.grid.setLoading(false);f.onExperimentChanged.notify(m);
f.measurementGrid._showStatusBarReady("Ready");});f.measurementGrid.grid.setLoading("ISPyB: Getting Experiment");i.getExperimentById(f.experiments.experiments[0].experimentId,"MEDIUM");});a.setMeasurementParameters(c,g,e);}}};MultipleEditMeasurementGridWindow.prototype.draw=function(a,b){var c=this;this.experiments=b;
this.parameterComboBox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Select Parameter",labelWidth:100,width:300,margin:"10 0 10 10",store:["Exp. Temp.","Volume To Load","Transmission","Wait Time","Viscosity"],queryMode:"local"});this.macromoleculeComboBox=this.getMacromoleculeCombo();this.bufferComboBox=this.getBufferCombo();
this.saveBtn=Ext.create("Ext.Button",{text:"Save",width:100,disabled:true,margin:"10 0 10 20",scope:this,handler:function(){c.save(this.parameterComboBox.getRawValue(),Ext.getCmp(this.id+"value").getValue());}});this.macromoleculeSaveBtn=Ext.create("Ext.Button",{text:"Save",width:100,disabled:true,margin:"0 0 10 20",scope:this,handler:function(){c.save("macromoleculeId",this.macromoleculeComboBox.getValue());
}});this.bufferSaveBtn=Ext.create("Ext.Button",{text:"Save",width:100,disabled:true,margin:"0 0 10 20",scope:this,handler:function(){c.save("bufferId",this.bufferComboBox.getValue());}});this.panel=Ext.create("Ext.Window",{id:this.id,title:"Multiple Edit",resizable:true,constrain:true,border:1,modal:true,frame:false,closable:true,autoscroll:true,layout:{type:"vbox",align:"stretch"},width:this.measurementGrid.width+50,height:this.measurementGrid.height+200,buttonAlign:"right",items:[{xtype:"container",layout:"vbox",padding:10,items:[this.measurementGrid.getPanel(a,b),{xtype:"container",layout:"hbox",items:[this.parameterComboBox,{xtype:"requiredtext",fieldLabel:"Value",id:c.id+"value",margin:"10 0 10 20",width:"200",labelWidth:50,value:""},this.saveBtn]},{xtype:"container",layout:"hbox",items:[this.macromoleculeComboBox,this.macromoleculeSaveBtn]}]}],listeners:{scope:this,minimize:function(){this.panel.hide();
},destroy:function(){delete this.panel;}}});this.panel.show();};StockSolutionWindow.prototype.getButtons=GenericWindow.prototype.getButtons;StockSolutionWindow.prototype._render=GenericWindow.prototype._render;StockSolutionWindow.prototype._postRender=GenericWindow.prototype._postRender;function StockSolutionWindow(a){this.width=550;
this.height=300;if(a!=null){if(a.actions!=null){this.actions=a.actions;}}_this=this;this.form=new StockSolutionForm();this.form.onSaved.attach(function(c,b){_this.save();});GenericWindow.prototype.constructor.call(this,{form:this.form,width:this.width,height:this.height});this.onSaved=new Event(this);
}StockSolutionWindow.prototype.save=function(){var b=this;var a=new BiosaxsDataAdapter();a.onSuccess.attach(function(d,c){b.panel.close();b.onSaved.notify(c);});if(this.form.getStockSolution().bufferId==null){BUI.showError("Buffer field is mandatory");return;}if(this.form.getStockSolution().name==""){BUI.showError("Acronym field is mandatory");
return;}if(this.form.getStockSolution().concentration==""){BUI.showError("Concentration field is mandatory");return;}if(this.form.getStockSolution().volume==""){BUI.showError("Volume field is mandatory");return;}this.panel.setLoading("ISPyB: saving stock solution");a.saveStockSolution(this.form.getStockSolution());
};StockSolutionWindow.prototype.draw=function(b,a){this.experiment=a;this.title="Stock Solution";this._render(b,a);};