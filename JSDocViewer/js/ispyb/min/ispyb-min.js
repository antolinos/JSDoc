function ErrorPanel(a){var b=this;this.width=600;this.height=200;this.targetId=null;this.errors=null;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}if(a.targetId!=null){this.targetId=a.targetId;}if(a.errors!=null){this.errors=a.errors;}}this.getPanel();}ErrorPanel.prototype.getPanel=function(){var c=this;
var a=[];if(c.errors){c.height=0;for(var b=0;b<c.errors.length;b++){a.push({xtype:"displayfield",name:"error"+b,fieldLabel:"Error",value:c.errors[b]});c.height+=50;}}c.panel=Ext.widget({xtype:"form",layout:{type:"fit"},collapsible:false,frame:true,renderTo:c.targetId,border:0,fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",items:a});
return c.panel;};function Event(a){this._sender=a;this._listeners=[];}Event.prototype={attach:function(a){this._listeners.push(a);},notify:function(a){for(var b=0;b<this._listeners.length;b++){this._listeners[b](this._sender,a);}}};function GenericWindow(a){this.title="title";this.width=700;this.height=500;
this.close=false;this.draggable=true;this.modal=true;if(a!=null){if(a.actions!=null){this.actions=a.actions;}if(a.form!=null){this.form=a.form;}if(a.width!=null){this.width=a.width;}if(a.modal!=null){this.modal=a.modal;}if(a.height!=null){this.height=a.height;}if(a.title!=null){this.title=a.title;}if(a.form!=null){this.form=a.form;
}if(a.close!=null){this.close=a.close;}if(a.draggable!=null){this.draggable=a.draggable;}}this.onSaved=new Event(this);this.onCancelled=new Event(this);}GenericWindow.prototype.getButtons=function(){var a=this;if(this.close){return[{text:"Close",handler:function(){a.panel.close();}}];}else{return[{text:"Save",handler:function(){a.save();
}},{text:"Cancel",handler:function(){a.cancel();}}];}};GenericWindow.prototype.save=function(){alert("Method save of GenerciWindow class is abstract");};GenericWindow.prototype.cancel=function(){_this.panel.close();};GenericWindow.prototype._postRender=function(a){};GenericWindow.prototype.draw=function(a){this._render(a);
};GenericWindow.prototype.refresh=function(a){this.data=a;this.form.refresh(a);};GenericWindow.prototype._render=function(a){this.data=a;var b=this;if(this.panel==null){this.panel=Ext.create("Ext.Window",{id:this.id,title:this.title,resizable:true,constrain:true,border:1,modal:this.modal,frame:false,draggable:this.draggable,closable:true,autoscroll:true,layout:{type:"vbox",align:"stretch"},items:this.form.getPanel(a),width:this.width,height:this.height,buttonAlign:"right",buttons:this.getButtons(),listeners:{scope:this,minimize:function(){this.panel.hide();
},destroy:function(){delete this.panel;}}});this.panel.setLoading();}this.panel.show();this._postRender();};function ProposalGrid(){}ProposalGrid.prototype.show=function(f,c){var b=[];for(var e=0;e<f.length;e++){if(f[e].type=="MB"){f[e].type="MX";b.push(JSON.parse(JSON.stringify(f[e])));f[e].type="BX";
b.push(JSON.parse(JSON.stringify(f[e])));}else{b.push(f[e]);}}var a=Ext.create("Ext.data.Store",{fields:[{name:"code"},{name:"number"},{name:"title"},{name:"type"}],data:b,groupField:"type"});var d=Ext.create("Ext.grid.Panel",{store:a,columns:[{text:"Proposal",flex:0.2,sortable:false,dataIndex:"code",renderer:function(j,g,h){return h.raw.code+h.raw.number;
}},{text:"Title",flex:0.6,sortable:true,dataIndex:"title"},{text:"Type",width:75,sortable:true,dataIndex:"type",renderer:function(h,j,g){if(g.data.type=="BX"){return"SAXS";}return g.data.type;}},{renderer:function(j,g,h){var k="<form action='/ispyb/user/userproposalchooseaction.do'>";k=k+"<input type='hidden' name='reqCode' value='goToProposal'>";
k=k+"<input type='hidden' name='userProposalType' value='"+h.raw.type+"'>";k=k+"<input type='hidden' name='proposalId' value='"+h.raw.proposalId+"'>";k=k+"<input type='submit' value='GO'></input></form>";return k;},width:100}],height:350,width:600,title:"Proposals",renderTo:c,features:[{id:"type",ftype:"groupingsummary",groupHeaderTpl:"{name}",hideGroupedHeader:false,enableGroupingMenu:true}],viewConfig:{stripeRows:true},listeners:{itemdblclick:function(h,g,j,k){window.location.href="/ispyb/user/userproposalchooseaction.do?reqCode=goToProposal&userProposalType="+g.raw.type+"&proposalId="+g.raw.proposalId;
}}});};var BUI={getTipHTML:function(a){return"<div class='panelMacro' ><table class='tipMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/check.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Tip</b><br clear='none'>"+a+"</td></tr></tbody></table></div>";
},getWarningHTML:function(a){return"<div class='panelMacro' ><table class='warningMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/warning.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Warning</b><br clear='none'>"+a+"</td></tr></tbody></table></div>";
},getErrorHTML:function(a){return"<div class='panelMacro' ><table class='errorMacro'><colgroup span='1'><col span='1' width='24'><col span='1'></colgroup><tbody><tr><td colspan='1' rowspan='1' valign='top'><img align='middle' src='https://cwiki.apache.org/confluence/images/emoticons/forbidden.gif' width='16' height='16' alt='' border='0'></td><td colspan='1' rowspan='1'><b>Error</b><br clear='none'>"+a+"</td></tr></tbody></table></div>";
},showWarning:function(b){var a=new WarningWidget();a.draw(b);},showError:function(a){Ext.Msg.show({title:"Error",msg:a,icon:Ext.Msg.ERROR,animEl:"elId"});}};function DataConfidentialityPanel(a){var b=this;this.width=550;this.height=500;this.onLaunch=new Event(this);this.onError=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}}}DataConfidentialityPanel.prototype.update=function(b){var d=this;var c;while(c=d.panel.items.first()){d.panel.remove(c,true);}var a=d.getIFrame(b.all,b.perMonth,b.month,b.year,b.perDate,b.logDate);d.panel.add(a);d.panel.doLayout();};DataConfidentialityPanel.prototype.getIFrame=function(e,b,f,d,g,a){var c=Ext.create("Ext.ux.SimpleIFrame",{src:"dataConfidentialityAction.do?reqCode=getDataConfidentialityLog&all="+e+"&perMonth="+b+"&month="+f+"&year="+d+"&perDate="+g+"&logDate="+a});
c.setSize(600,600);return c;};DataConfidentialityPanel.prototype.launchDataConfidentiality=function(a){var b=this;$.ajax({type:this.type,url:"/ispyb/manager/launchDataConfidentiality.do?reqCode=launchJs&dateTo="+a.dateTo+"&dateFrom="+a.dateFrom+"&sesId="+a.sesId,data:{},datatype:"text/json",success:function(c){b.onLaunch.notify({"listSessions":sessionsIds});
},error:function(e,c,d){b.onError.notify(e.responseText);}});};DataConfidentialityPanel.prototype.getPanel=function(){var e=this;e.dcLog="";var a=new Date();var c=a.getMonth()+1;var d=a.getFullYear();var b=e.getIFrame(null,true,c,d,false,null);e.panel=Ext.create("Ext.Panel",{layout:"fit",collapsible:false,frame:true,bodyPadding:"5 5 0",items:[b]});
return e.panel;};function LaunchDataConfidentialityPanel(a){var b=this;this.width=400;this.height=500;this.onLaunchDataConfidentiality=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}LaunchDataConfidentialityPanel.prototype.getLaunchCriteria=function(){var e=this;
var b=Ext.getCmp(this.panel.getItemId()).getValues().dateTo;var d=Ext.getCmp(this.panel.getItemId()).getValues().dateFrom;var a=Ext.getCmp(this.panel.getItemId()).getValues().sesId;var c=[];c.dateTo=b;c.dateFrom=d;c.sesId=a;return c;};LaunchDataConfidentialityPanel.prototype.getPanel=function(){var f=this;
var d=new Date();var b=d.getTime();var a=(1000*60*60*24);b=b-2*a;d=d.setTime(b);b=b-3*a;var e=new Date();e=e.setTime(b);var c;f.panel=Ext.widget({xtype:"form",collapsible:true,id:"launchDataConfidentialityForm",frame:true,title:"Launch Data Confidentiality",width:this.width,fieldDefaults:{msgTarget:"side",labelWidth:100},style:{marginBottom:"10px"},defaultType:"textfield",layout:{type:"table",columns:2},defaults:{labelStyle:"padding-left:10px;"},items:[{xtype:"datefield",name:"dateFrom",fieldLabel:"(DD/MM/YYYY)",format:"d/m/Y",submitFormat:"d/m/Y",value:e,colspan:2},{xtype:"datefield",name:"dateTo",fieldLabel:"(DD/MM/YYYY)",format:"d/m/Y",submitFormat:"d/m/Y",value:d,colspan:2},{xtype:"numberfield",name:"sesId",fieldLabel:"sessionId",value:c,colspan:2}],buttons:[{text:"Launch",handler:function(){f.onLaunchDataConfidentiality.notify();
}},{text:"Reset",handler:function(){this.up("form").getForm().reset();}}]});return f.panel;};Ext.Loader.setConfig({enabled:true});var dataConfidentialityPanel=null;var IspybDataConfidentiality={start:function(a){this.targetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showDataConfidentialityPage(a);},showDataConfidentialityPage:function(b){var e=this;dataConfidentialityPanel=new DataConfidentialityPanel();var c=new ViewLogOptionPanel();c.onViewLog.attach(function(f,h){var g=c.getSearchCriteria();dataConfidentialityPanel.update(g);});var a=new LaunchDataConfidentialityPanel();
a.onLaunchDataConfidentiality.attach(function(f,g){var h=a.getLaunchCriteria();dataConfidentialityPanel.launchDataConfidentiality(h);});var d=Ext.create("Ext.panel.Panel",{plain:false,frame:false,layout:{type:"hbox"},border:0,style:{padding:0},items:[c.getPanel(),a.getPanel()]});e.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,autoScroll:true,renderTo:b,style:{padding:0},items:[d,dataConfidentialityPanel.getPanel()]});
}};function ViewLogOptionPanel(a){var b=this;this.width=550;this.height=500;this.onViewLog=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.all=false;this.perMonth=false;this.perDate=false;}ViewLogOptionPanel.prototype.getSearchCriteria=function(){var e=this;
var d=Ext.getCmp(this.panel.getItemId()).getValues().month;var c=Ext.getCmp(this.panel.getItemId()).getValues().year;var a=Ext.getCmp(this.panel.getItemId()).getValues().logDate;var b=[];b.all=e.all;b.perMonth=e.perMonth;b.month=d;b.year=c;b.perDate=e.perDate;b.logDate=a;return b;};ViewLogOptionPanel.prototype.changeLogPeriod=function(e){var d=this;
var b=Ext.getCmp(this.panel.getItemId()).items.items;for(var a=0;a<b.length;a++){var c=b[a];if(c.name=="logDate"){c.setDisabled(!(e=="perDate"));}else{if(c.name=="month"){c.setDisabled(!(e=="perMonth"));}else{if(c.name=="year"){c.setDisabled(!(e=="perMonth"));}}}}d.perDate=(e=="perDate");d.perMonth=(e=="perMonth");
d.all=(e=="all");};ViewLogOptionPanel.prototype.getPanel=function(){var d=this;var a=new Date();var b=a.getMonth()+1;var c=a.getFullYear();d.panel=Ext.widget({xtype:"form",collapsible:true,id:"viewLogForm",frame:true,title:"View Data Protection Log",width:this.width,fieldDefaults:{msgTarget:"side",labelWidth:100},style:{marginBottom:"10px"},defaultType:"textfield",layout:{type:"table",columns:3},defaults:{labelStyle:"padding-left:10px;"},items:[{xtype:"radio",boxLabel:"All",name:"log-period",inputValue:"all",colspan:3,listeners:{change:{fn:function(h,g,f,e){if(g==true){d.changeLogPeriod(h.inputValue);
}}}}},{xtype:"radio",boxLabel:"Per month",checked:true,name:"log-period",inputValue:"perMonth",listeners:{change:{fn:function(h,g,f,e){if(g==true){d.changeLogPeriod(h.inputValue);}}}}},{xtype:"numberfield",name:"month",fieldLabel:"Month",labelWidth:50,value:b,width:150,minValue:1,maxValue:12},{xtype:"numberfield",name:"year",fieldLabel:"Year",labelWidth:50,width:200,value:c,minValue:2013},{xtype:"radio",boxLabel:"Per date",name:"log-period",inputValue:"perDate",listeners:{change:{fn:function(h,g,f,e){if(g==true){d.changeLogPeriod(h.inputValue);
}}}}},{xtype:"datefield",name:"logDate",fieldLabel:"(DD/MM/YYYY)",format:"d/m/Y",submitFormat:"d/m/Y",value:a,colspan:2}],buttons:[{text:"View Log",handler:function(){d.onViewLog.notify();}},{text:"Reset",handler:function(){this.up("form").getForm().reset();}}]});d.changeLogPeriod("perMonth");return d.panel;
};function Collection(a){this.type="POST";this.json=a;this.collectionRetrieved=new Event(this);this.workflowRetrieved=new Event(this);this.referencesRetrieved=new Event(this);this.criteriaRetrieved=new Event(this);this.onRank=new Event(this);this.onRankAutoProc=new Event(this);this.onSaved=new Event(this);
this.onError=new Event(this);}Collection.prototype.getLastCollect=function(c,a,f,d,b){var g=this;var e=Ext.MessageBox.wait("Please wait...","Loading Last Collects");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getLastCollect&searchBeamline="+c+"&startDate="+a+"&endDate="+f+"&startTime="+d+"&endTime="+b,data:{},datatype:"text/json",success:function(h){g.collectionRetrieved.notify(h);
e.hide();},error:function(k,h,j){g.onError.notify(k.responseText);e.hide();}});};Collection.prototype.getSearchCriteria=function(){var a=this;$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getSearchCriteria",data:{},datatype:"text/json",success:function(b){a.criteriaRetrieved.notify(b);},error:function(d,b,c){a.onError.notify(d.responseText);
}});};Collection.prototype.getDataCollectionByDataCollectionGroup=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getDataCollectionByDataCollectionGroup&dataCollectionGroupId="+a,datatype:"text/json",success:function(d){c.collectionRetrieved.notify(d);
b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});};Collection.prototype.getDataCollectionBySession=function(){var b=this;var a=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getDataCollectionBySession",datatype:"text/json",success:function(c){b.collectionRetrieved.notify(c);
a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};Collection.prototype.saveDataCollection=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Saving Data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=saveAllDataCollection",data:{dataCollectionList:a},datatype:"text/json",success:function(d){c.onSaved.notify(d);
b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});};Collection.prototype.rank=function(a){var b=this;$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=rankJs&dataCollectionIdList="+a,data:{},datatype:"text/json",success:function(c){b.onRank.notify();},error:function(e,c,d){b.onError.notify(e.responseText);
}});};Collection.prototype.rankAutoProc=function(a){var b=this;$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=rankAutoProcJs&dataCollectionIdList="+a,data:{},datatype:"text/json",success:function(c){b.onRankAutoProc.notify();},error:function(e,c,d){b.onError.notify(e.responseText);}});};Collection.prototype.getWorkflow=function(){var b=this;
var a=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewWorkflow.do?reqCode=getWorkflow",datatype:"text/json",success:function(c){b.workflowRetrieved.notify(c);a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};Collection.prototype.getDataCollectionBySample=function(){var b=this;
var a=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getDataCollectionBySample",datatype:"text/json",success:function(c){b.collectionRetrieved.notify(c);a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};Collection.prototype.getDataCollectionByProtein=function(){var b=this;
var a=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getDataCollectionByProtein",datatype:"text/json",success:function(c){b.collectionRetrieved.notify(c);a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};Collection.prototype.getDataCollectionByCustomQuery=function(){var b=this;
var a=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getDataCollectionByCustomQuery",datatype:"text/json",success:function(c){b.collectionRetrieved.notify(c);a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});
};Collection.prototype.getDataCollectionBySampleId=function(){var b=this;var a=Ext.MessageBox.wait("Please wait...","Loading data");$.ajax({type:this.type,url:"viewDataCollection.do?reqCode=getDataCollectionBySampleId",datatype:"text/json",success:function(c){b.collectionRetrieved.notify(c);a.hide();
},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};function CollectionGroup(a){this.type="POST";this.json=a;this.collectionGroupRetrieved=new Event(this);this.sessionRetrieved=new Event(this);this.imageSaved=new Event(this);this.onSaved=new Event(this);this.onError=new Event(this);
}CollectionGroup.prototype.getCollectionGroupBySession=function(){var b=this;var a=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"viewDataCollectionGroup.do?reqCode=getDataCollectionGroupBySession",data:{},datatype:"text/json",success:function(c){b.collectionGroupRetrieved.notify(c);
a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};CollectionGroup.prototype.getCollectionGroupBySample=function(){var b=this;var a=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"viewDataCollectionGroup.do?reqCode=getDataCollectionGroupBySample",data:{},datatype:"text/json",success:function(c){b.collectionGroupRetrieved.notify(c);
a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};CollectionGroup.prototype.saveDataCollectionGroup=function(a,c){var d=this;var b=Ext.MessageBox.wait("Please wait...","Saving Data");$.ajax({type:this.type,url:"viewDataCollectionGroup.do?reqCode=saveAllDataCollectionGroups",data:{sessionId:c,dataCollectionGroupList:a},datatype:"text/json",success:function(e){d.onSaved.notify(e);
b.hide();},error:function(g,e,f){d.onError.notify(g.responseText);b.hide();}});};CollectionGroup.prototype.saveXRFSpectra=function(b,c){var d=this;var a=Ext.MessageBox.wait("Please wait...","Saving Data");$.ajax({type:this.type,url:"viewDataCollectionGroup.do?reqCode=saveAllXFE",data:{sessionId:c,listXFESpectra:b},datatype:"text/json",success:function(e){d.onSaved.notify(e);
a.hide();},error:function(g,e,f){d.onError.notify(g.responseText);a.hide();}});};CollectionGroup.prototype.getSessionInformation=function(b){var c=this;var a=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"viewDataCollectionGroup.do?reqCode=getSessionInformation",data:{sessionId:b},datatype:"text/json",success:function(d){c.sessionRetrieved.notify(d);
a.hide();},error:function(f,d,e){c.onError.notify(f.responseText);a.hide();}});};CollectionGroup.prototype.saveImageForExport=function(b,d,a){var e=this;var c={listSvg:JSON.stringify(b)};c.sessionId=d;c.listId=JSON.stringify(a);$.ajax({type:this.type,url:"exportDataCollection.do?reqCode=saveImageForExport",data:c,dataType:"json",success:function(f){e.imageSaved.notify(f);
},error:function(h,f,g){e.onError.notify(h.responseText);}});};function CrystalClassGrid(c){var b=false;var a="";this.title="Summary";if(c!=null){if(c.height!=null){this.height=c.height;}if(c.isFx!=null){this.isFx=c.isFx;}if(c.contextPath!=null){this.contextPath=c.contextPath;}if(c.title!=null){this.title=c.title;
}}Ext.define("CrystalClassModel",{extend:"Ext.data.Model",fields:[{name:"crystalClassCode",mapping:"crystalClassCode"},{name:"crystalClassName",mapping:"crystalClassName"},{name:"numberOfCrystals",mapping:"numberOfCrystals"}],idProperty:"crystalClassCode"});}CrystalClassGrid.prototype.getFilterTypes=function(){return[];
};CrystalClassGrid.prototype.refresh=function(a){this.features=a.listCrystal;this.store.loadData(this.features,false);};CrystalClassGrid.prototype._sort=function(a){a.sort("crystalClassName","ASC");};CrystalClassGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(a);};CrystalClassGrid.prototype.renderGrid=function(){var d=this;
var c=[];var b=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"CrystalClassModel",autoload:false});this._sort(this.store);this.store.loadData(this.features,false);var a=Ext.create("Ext.Panel",{id:"noCrystalDataPanel",layout:{type:"fit",align:"center",bodyPadding:0,border:0},html:""});
if(this.features.length==0){return a;}this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0,marginTop:"10px"},model:"CrystalClassModel",store:this.store,columns:b,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"}});return this.grid;};CrystalClassGrid.prototype._getColumns=function(){var b=this;
var a=[{text:"Crystal class name",dataIndex:"crystalClassName",flex:0.2},{text:"Crystal class code",dataIndex:"crystalClassCode",flex:0.1},{text:"Number of crystals",dataIndex:"numberOfCrystals",flex:0.1}];return a;};function DataCollectionGrid(b){var a="";this.pageSize=100;this.title="Last Data Collection";
this.listOfCrystalClass=[];this.contextPath="";this.displayLastCollect=false;this.isManager=false;this.isIndustrial=false;this.pagingMode=false;this.groupFieldDefault="";this.setArgs(b);this.onSaveButtonClicked=new Event(this);this.onPagingMode=new Event(this);this.onRankButtonClicked=new Event(this);
this.onRankAutoProcButtonClicked=new Event(this);this.hideCol=true;this.rankEDNA=true;this.minDCId=1;this.maxDCId=0;this.rMergeCutoff=10;this.iSigmaCutoff=1;Ext.define("DataCollectionModel",{extend:"Ext.data.Model",fields:[{name:"dataCollectionId",mapping:"dataCollectionId"},{name:"experimentType",mapping:"experimentType"},{name:"startTime",mapping:"startTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"endTime",mapping:"endTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"beamLineName",mapping:"beamLineName"},{name:"proposal",mapping:"proposal"},{name:"imagePrefix",mapping:"imagePrefix"},{name:"dataCollectionNumber",mapping:"dataCollectionNumber"},{name:"proteinAcronym",mapping:"proteinAcronym"},{name:"pdbFileName",mapping:"pdbFileName"},{name:"numberOfImages",mapping:"numberOfImages"},{name:"hasSnapshot",mapping:"hasSnapshot"},{name:"runStatus",mapping:"runStatus"},{name:"autoProc",mapping:"autoProc"},{name:"autoProcStatisticsOverall",mapping:"autoProcStatisticsOverall"},{name:"autoProcStatisticsInner",mapping:"autoProcStatisticsInner"},{name:"autoProcStatisticsOuter",mapping:"autoProcStatisticsOuter"},{name:"screeningOutput",mapping:"screeningOutput"},{name:"lattice",mapping:"lattice"},{name:"comments",mapping:"comments"},{name:"autoprocessingStatus",mapping:"autoprocessingStatus"},{name:"autoprocessingStep",mapping:"autoprocessingStep"},{name:"wavelength",mapping:"wavelength"},{name:"transmission",mapping:"transmission"},{name:"exposureTime",mapping:"exposureTime"},{name:"axisStart",mapping:"axisStart"},{name:"axisRange",mapping:"axisRange"},{name:"resolution",mapping:"resolution"},{name:"transmission",mapping:"transmission"},{name:"hasAutoProcAttachment",mapping:"hasAutoProcAttachment"},{name:"printableForReport",mapping:"printableForReport"},{name:"skipForReport",mapping:"skipForReport"}],idProperty:"dataCollectionId"});
}DataCollectionGrid.prototype.setArgs=function(a){if(a!=null){if(a.height!=null){this.height=a.height;}if(a.contextPath!=null){this.contextPath=a.contextPath;}if(a.title!=null){this.title=a.title;}if(a.listOfCrystalClass!=null){this.listOfCrystalClass=a.listOfCrystalClass;}if(a.contextPath!=null){this.contextPath=a.contextPath;
}if(a.displayLastCollect!=null){this.displayLastCollect=a.displayLastCollect;}if(a.isManager!=null){this.isManager=a.isManager;}if(a.pagingMode!=null){this.pagingMode=a.pagingMode;}if(a.isIndustrial!=null){this.isIndustrial=a.isIndustrial;}if(a.groupFieldDefault!=null){this.groupFieldDefault=a.groupFieldDefault;
}if(a.iSigmaCutoff!=null){this.iSigmaCutoff=a.iSigmaCutoff;}if(a.rMergeCutoff!=null){this.rMergeCutoff=a.rMergeCutoff;}}};DataCollectionGrid.prototype._sort=function(){this.store.sort("startTime","DESC");};DataCollectionGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(a);};DataCollectionGrid.prototype.refresh=function(a){this.features=a.dataCollectionList;
this.store.loadData(this.features,false);this.title="Last "+this.features.length+" DataCollections";this.grid.setTitle(this.title);};DataCollectionGrid.prototype.renderGrid=function(){var n=this;if(this.features&&this.features.length>0){this.minDCId=this.features[0].dataCollectionId;this.maxDCId=this.features[0].dataCollectionId;
var p=this.features.length;for(var j=0;j<p;j++){var c=this.features[j].dataCollectionId;if(c>this.maxDCId){this.maxDCId=c;}if(c<this.minDCId){this.minDCId=c;}}}var h=[];var e=this._getColumns();if(this.pagingMode){this.store=Ext.create("Ext.data.Store",{model:"DataCollectionModel",autoload:false,pageSize:this.pageSize,proxy:{type:"pagingmemory",data:this.features,reader:{type:"array"}}});
}else{if(n.groupFieldDefault){this.store=Ext.create("Ext.data.Store",{model:"DataCollectionModel",autoload:false,groupField:n.groupFieldDefault});}else{this.store=Ext.create("Ext.data.Store",{model:"DataCollectionModel",autoload:false});}}var a=null;var b="Pagination";if(this.pagingMode){b="Remove pagination";
a=Ext.create("Ext.PagingToolbar",{store:this.store,pageSize:this.pageSize,displayInfo:true,displayMsg:"Displaying dataCollections {0} - {1} of {2}",emptyMsg:"No dataCollection to display",listeners:{afterrender:function(){var s=Ext.query("button[data-qtip=Refresh]");for(var r=0;r<s.length;r++){s[r].style.display="none";
}}}});}this.store.loadData(this.features,false);if(this.displayLastCollect){this.title="Last "+this.features.length+" DataCollections";}else{this.title=this.features.length+" DataCollections";}var o=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});n.groupingFeature=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{columnName}: {name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})',hideGroupedHeader:true,startCollapsed:false,id:"dataCollectionGrouping"});
var d=this.store.getGroups();var m=d.length;var l=function(r){var s=r.text;if(r.checked){n.groupingFeature.expand(s,true);}else{n.groupingFeature.collapse(s,true);}};Ext.regModel("Rank",{fields:[{type:"string",name:"name"}]});var k=[{"name":"EDNA"},{"name":"AutoProc"}];var q=Ext.create("Ext.data.Store",{model:"Rank",data:k});
var g=Ext.create("Ext.form.field.ComboBox",{displayField:"name",width:100,labelWidth:10,store:q,queryMode:"local",typeAhead:true,forceSelection:true,value:"EDNA",listeners:{change:function(t,s,r){n.changeRank();}}});var f=[];if(!this.displayLastCollect){f.push({text:"Save",tooltip:"Save dataCollections: comments and skip status",icon:"../images/save.gif",handler:function(){n.onSaveButtonClicked.notify({});
}});f.push({text:"Experiment Parameters",tooltip:"Expand or Collapse Experiment Parameter",icon:"../images/Info_16x16_01.png",handler:function(){n.hideAndShowExperimentParameter();}});f.push({text:"Rank",tooltip:"Start Sample Ranking",handler:function(){n.startRank();}},g);}if(this.displayLastCollect){f.push({text:b,handler:function(){n.onPagingMode.notify();
}});}f.push("->");f.push({text:"Expand All",handler:function(){var r=n.groupingFeature.view.getEl().query(".x-grid-group-body");Ext.each(r,function(s){n.groupingFeature.expand(Ext.get(s));});}},{text:"Collapse All",handler:function(){var r=n.groupingFeature.view.getEl().query(".x-grid-group-body");Ext.each(r,function(s){n.groupingFeature.collapse(Ext.get(s));
});}});f.push({text:"Clear Grouping",iconCls:"icon-clear-group",handler:function(){n.groupingFeature.disable();}});this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:"100%",height:"100%",model:"DataCollectionModel",store:this.store,resizable:true,columns:e,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},plugins:[o],features:[n.groupingFeature],tbar:f,bbar:a});
if(this.pagingMode){this.store.load();}return this.grid;};DataCollectionGrid.prototype._getIndex=function(b){var d=this.grid.columns;var c=d.length;for(var a=0;a<c;a++){if(d[a].dataIndex==b){return a;}}return -1;};DataCollectionGrid.prototype._hideCol=function(){if(!this.displayLastCollect){var e=this._getIndex("experimentParameters");
if(e!=-1){this.grid.columns[e].setVisible(this.hideCol);}var d=this._getIndex("wavelength");var c=this._getIndex("resolution");if(d!=-1&&c!=-1){var a=c-d+1;for(var b=0;b<a;b++){this.grid.columns[d+b].setVisible(!this.hideCol);}}}};DataCollectionGrid.prototype._getColumns=function(){var p=this;function j(v,w,u){return Ext.Date.format(v,"d-m-Y H:i:s");
}function k(v,w,u){return"<a href='"+p.contextPath+"/user/viewResults.do?reqCode=display&dataCollectionId="+u.getId()+"'>"+v+"</a>";}function g(v,w,u){if(u.data.pdbFileName&&u.data.pdbFileName!==""){w.tdAttr='data-qtip="'+("pdb file uploaded:"+u.data.pdbFileName)+'"';return"<img src='../images/attach.png' border='0'  />"+v;
}else{return v;}}function e(v,w,u){if(v){return v.toFixed(2);}else{return"";}}function a(v,w,u){if(v){return v.toFixed(3);}else{return"";}}function s(z,u,y,C,x,B,w,A){var v="";v+="<TABLE cellSpacing=2 cellPadding=0 width=100% border=0>";v+="<TR><TD valign=middle><img src='"+z+"' border=0/></TD><TD class='smallText_black' nowrap>"+u+"</TD></TR>";
v+="<TR><TD valign=middle><img src='"+y+"' border=0/></TD><TD class='smallText_black' nowrap>"+C+"</TD></TR>";v+="<TR><TD valign=middle><img src='"+x+"' border=0/></TD><TD class='smallText_black' nowrap>"+B+"</TD></TR>";v+="<TR><TD valign=middle><img src='"+w+"' border=0/></TD><TD class='smallText_black' nowrap>"+A+"</TD></TR>";
v+="</TABLE>";return v;}function q(B,v,w){var A="../images/Sphere_White_12.png";var z="../images/Sphere_White_12.png";var y="../images/Sphere_White_12.png";var x="../images/Sphere_White_12.png";var u="";var F="";var E="";var C="";if(w.data.hasSnapshot&&w.data.hasSnapshot){A="../images/Sphere_Green_12.png";
u="This collection has a crystal snapshot.";}else{A="../images/Sphere_White_12.png";u="This collection has no crystal snapshot.";}if(w.data.runStatus){F=w.data.runStatus;if(w.data.runStatus.search("successful")!=-1){z="../images/Sphere_Green_12.png";}else{if(w.data.runStatus.search("failed")!=-1){z="../images/Sphere_Red_12.png";
}else{if(w.data.runStatus.search("Running")!=-1){z="../images/Sphere_Orange_12.png";}else{z="../images/Sphere_Yelow_12.png";}}}}if(w.data.screeningOutput){if(w.data.screeningOutput.indexingSuccess){if(w.data.screeningOutput.strategySuccess){if(w.data.screeningOutput.indexingSuccess==1){if(w.data.screeningOutput.strategySuccess==1){y="../images/Sphere_Green_12.png";
E="Indexing is successful.";}else{y="../images/Sphere_Orange_12.png";E="Indexing is successful but no strategy.";}}else{y="../images/Sphere_Red_12.png";E="Indexing failed.";}}else{y="../images/Sphere_Yelow_12.png";E="Indexing status unknown.";}}else{y="../images/Sphere_Yelow_12.png";E="Indexing status unknown.";
}}else{y="../images/Sphere_White_12.png";E="Indexing has not been launched.";}if(w.data.autoprocessingStatus){if(w.data.autoprocessingStatus=="Successful"){x="../images/Sphere_Green_12.png";C="Autoprocessing: "+w.data.autoprocessingStep+" Successful";}else{if(w.data.autoprocessingStatus=="Launched"){x="../images/Sphere_Orange_12.png";
C="Autoprocessing: "+w.data.autoprocessingStep+" Launched";}else{if(w.data.autoprocessingStatus=="Failed"){x="../images/Sphere_Red_12.png";C="Autoprocessing: "+w.data.autoprocessingStep+" Failed";}}}}else{x="../images/Sphere_White_12.png";C="Autoprocessing status unknown.";}var D=s(A,u,z,F,y,E,x,C);v.tdAttr='data-qtip="'+D+'"';
return"<img src='"+A+"' border=0>"+"<img src='"+z+"' border=0>"+"<img src='"+y+"' border=0>"+"<img src='"+x+"' border=0>";}function t(M,L,v){if(v.data.autoProcStatisticsOverall&&v.data.autoProcStatisticsOuter&&v.data.autoProcStatisticsInner){var H=v.data.autoProcStatisticsInner.completeness;var F=v.data.autoProcStatisticsOuter.completeness;
var E=v.data.autoProcStatisticsOverall.completeness;var u=-61;var J=122;var C=(J/2)/100;var y=C*H;var B=u+y;var I=H<85?4:1;var x=C*F;var A=u+x;var G=F<85?4:1;var w=C*E;var z=u+w;var D=E<85?4:1;var K="";if(!(H===0&&F===0&&E===0)){K+='<img " src="../images/percentImage_small.png" title="'+H+'% (inner)" alt="'+H+'% (inner)" class="percentImage'+I+'" style="background-position: '+B+'px 0pt; "/><br/>';
K+='<img  src="../images/percentImage_small.png" title="'+F+'% (outer)" alt="'+F+'% (outer)" class="percentImage'+G+'" style="background-position: '+A+'px 0pt; "/><br/>';K+='<img  src="../images/percentImage_small.png" title="'+E+'% (overall)" alt="'+E+'% (overall)" class="percentImage'+D+'" style="background-position: '+z+'px 0pt; "/><br/>';
}return K;}return"";}function c(w,x,u){if(u.data.autoProcStatisticsOverall&&u.data.autoProcStatisticsOuter&&u.data.autoProcStatisticsInner){var v=(u.data.autoProcStatisticsInner.resolutionLimitLow?u.data.autoProcStatisticsInner.resolutionLimitLow:"")+" - "+(u.data.autoProcStatisticsInner.resolutionLimitHigh?u.data.autoProcStatisticsInner.resolutionLimitHigh:"")+"<br />";
v+=(u.data.autoProcStatisticsOuter.resolutionLimitLow?u.data.autoProcStatisticsOuter.resolutionLimitLow:"")+" - "+(u.data.autoProcStatisticsOuter.resolutionLimitHigh?u.data.autoProcStatisticsOuter.resolutionLimitHigh:"")+"<br />";v+=(u.data.autoProcStatisticsOverall.resolutionLimitLow?u.data.autoProcStatisticsOverall.resolutionLimitLow:"")+" - "+(u.data.autoProcStatisticsOverall.resolutionLimitHigh?u.data.autoProcStatisticsOverall.resolutionLimitHigh:"")+"<br />";
return v;}else{if(u.data.screeningOutput){return Number(u.data.screeningOutput.rankingResolution).toFixed(2);}}return"";}function r(w,x,u){if(u.data.autoProcStatisticsOverall&&u.data.autoProcStatisticsOuter&&u.data.autoProcStatisticsInner){var v=(u.data.autoProcStatisticsInner.rmerge?Number(u.data.autoProcStatisticsInner.rmerge).toFixed(1):"")+"<br />";
v+=(u.data.autoProcStatisticsOuter.rmerge?Number(u.data.autoProcStatisticsOuter.rmerge).toFixed(1):"")+"<br />";v+=(u.data.autoProcStatisticsOverall.rmerge?Number(u.data.autoProcStatisticsOverall.rmerge).toFixed(1):"")+"<br />";return v;}return"";}function b(x,y,u){var z=2;if(u.data.autoProc){var w=(u.data.autoProc.refinedCellA?Number(u.data.autoProc.refinedCellA).toFixed(z)+", ":"");
w+=(u.data.autoProc.refinedCellB?Number(u.data.autoProc.refinedCellB).toFixed(z)+", ":"");w+=(u.data.autoProc.refinedCellC?Number(u.data.autoProc.refinedCellC).toFixed(z)+"<br />":"");w+=(u.data.autoProc.refinedCellAlpha?Number(u.data.autoProc.refinedCellAlpha).toFixed(z)+", ":"");w+=(u.data.autoProc.refinedCellBeta?Number(u.data.autoProc.refinedCellBeta).toFixed(z)+", ":"");
w+=(u.data.autoProc.refinedCellGamma?Number(u.data.autoProc.refinedCellGamma).toFixed(z):"");return w;}else{if(u.data.lattice){var v=(u.data.lattice.unitCell_a?Number(u.data.lattice.unitCell_a).toFixed(z)+", ":"");v+=(u.data.lattice.unitCell_b?Number(u.data.lattice.unitCell_b).toFixed(z)+", ":"");v+=(u.data.lattice.unitCell_c?Number(u.data.lattice.unitCell_c).toFixed(z)+"<br />":"");
v+=(u.data.lattice.unitCell_alpha?Number(u.data.lattice.unitCell_alpha).toFixed(z)+", ":"");v+=(u.data.lattice.unitCell_beta?Number(u.data.lattice.unitCell_beta).toFixed(z)+", ":"");v+=(u.data.lattice.unitCell_gamma?Number(u.data.lattice.unitCell_gamma).toFixed(z):"");return v;}}return"";}function h(v,w,u){if(u.data.autoProc){return u.data.autoProc.spaceGroup;
}else{if(u.data.lattice){return u.data.lattice.spaceGroup;}else{return"";}}}function o(u){if(u){return'<div style="white-space:normal !important;">'+u+"</div>";}else{return"";}}function m(w,x,u){var v="../images/Info_16x16_01.png";var y="";y+="Wavelength: "+(u.data.wavelength?u.data.wavelength.toFixed(3):"");
y+="<br/>";y+="Transmission: "+(u.data.transmission?u.data.transmission.toFixed(3):"");y+="<br/>";y+="ex. Time: "+(u.data.exposureTime?u.data.exposureTime.toFixed(2):"");y+="<br/>";y+="PhiStart: "+(u.data.axisStart?u.data.axisStart.toFixed(2):"");y+="<br/>";y+="PhiRange: "+(u.data.axisRange?u.data.axisRange.toFixed(2):"");
y+="<br/>";y+="Detector Resolution: "+(u.data.resolution?u.data.resolution.toFixed(2):"");x.tdAttr='data-qtip="'+y+'"';return"<img src='"+v+"' border=0>";}function n(y,z,v){var u=false;var x=false;if(v.data.screeningOutput){if(v.data.screeningOutput.indexingSuccess){if(v.data.screeningOutput.strategySuccess){if(v.data.screeningOutput.indexingSuccess==1){u=true;
}}}}else{if(v.data.autoProc){x=true;}}var w="";if(u){w+="<input checked='"+u+"' name='rankIdList["+v.data.dataCollectionId+"]' value='on' type='checkbox'>";w+="<img  src='../images/checkbox_grey.png' id='rankIdImage["+v.data.dataCollectionId+"]' style='display:none'>";}if(x){w+="<input checked='"+x+"' name='rankIdAutoProcList["+v.data.dataCollectionId+"]' value='on' type='checkbox' style='display:none'>";
w+="<img  src='../images/checkbox_grey.png' id='rankIdAutoProcImage["+v.data.dataCollectionId+"]' style='display:none'>";}if(!u&&!x){return"<img src='../images/checkbox_grey.png' border=0>";}else{return w;}}function l(w,x,u){var v="<input "+(w?"checked='checked'":"")+" property='skipIdList["+u.data.dataCollectionId+"]'  value='1' type='checkbox'>";
return v;}function f(x,y,u,z,w,v){if(!u.get("hasAutoProcAttachment")){return"x-hide-display";}}var d=[];if(this.displayLastCollect){d.push({text:"Beamline<br/>Name",dataIndex:"beamLineName",flex:0.08,id:"beamLineName"});}if(this.isManager){d.push({text:"Proposal",dataIndex:"proposal",flex:0.1,id:"proposal"});
}d.push({text:"Image<br/>Prefix",dataIndex:"imagePrefix",flex:0.12,renderer:k},{text:"Run<br/>No",dataIndex:"dataCollectionNumber",flex:0.02},{text:"Experiment<br/>Type",dataIndex:"experimentType",flex:0.06},{text:"Protein<br>Acronym",dataIndex:"proteinAcronym",flex:0.05,renderer:g},{text:"Start time",dataIndex:"startTime",flex:0.14,renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s")},{text:"# images",dataIndex:"numberOfImages",flex:0.06});
if(!this.displayLastCollect){d.push({text:"Experiment<br/>Parameters<br/>",dataIndex:"experimentParameters",flex:0.07,renderer:m});d.push({text:"Wavelenth",dataIndex:"wavelength",flex:0.07,renderer:a},{text:"Transm.",dataIndex:"transmission",flex:0.07,renderer:a});if(this.isIndustrial){d.push({text:"Distance",dataIndex:"detectorDistance",flex:0.05,renderer:e});
}d.push({text:"Ex.<br>Time",dataIndex:"exposureTime",flex:0.05,renderer:e},{text:"Phi<br>start",dataIndex:"axisStart",flex:0.05,renderer:e},{text:"Phi<br>range",dataIndex:"axisRange",flex:0.05,renderer:e});if(this.isIndustrial){d.push({text:"Xbeam",dataIndex:"xbeam",flex:0.05,renderer:e},{text:"Ybeam",dataIndex:"ybeam",flex:0.05,renderer:e});
}d.push({text:"Detector<br/>Resolution",dataIndex:"resolution",flex:0.07,renderer:e});}d.push({text:"Status",dataIndex:"status",flex:0.1,renderer:q},{text:"Space<br/>Group",dataIndex:"autoProc",flex:0.07,renderer:h},{text:"Completeness",dataIndex:"completeness",flex:0.075,renderer:t},{text:"Resolution",dataIndex:"resolution",flex:0.075,renderer:c},{text:"Rsymm<br/><small><i>Inner<br/>Outer<br/>Overall</i></small>",dataIndex:"autoProcStatisticsOverall",flex:0.06,renderer:r},{text:"Unit_cell<br/><small><i>a, b, c<br/>alpha, beta, gamma</i></small>",dataIndex:"autoProcStatisticsInner",flex:0.15,renderer:b});
if(!this.displayLastCollect){d.push({header:"Sample<br/>Ranking",dataIndex:"dataCollectionId",flex:0.05,renderer:n});}if(!this.isIndustrial){d.push({xtype:"checkcolumn",header:"Skip",dataIndex:"skipForReport",flex:0.04,renderer:l});}if(this.displayLastCollect||this.isIndustrial){d.push({text:"Comments",dataIndex:"comments",flex:0.2,renderer:o});
}else{d.push({text:"Comments",dataIndex:"comments",flex:0.2,editor:{xtype:"textfield",allowBlank:true},renderer:o});}d.push({xtype:"actioncolumn",width:50,header:"Download<br>autoproc<br>files",items:[{icon:"../images/download.png",tooltip:"Download autoproc",getClass:f,handler:function(v,w,u){p.downloadAutoproc(p.store.getAt(w).data.dataCollectionId);
}}],sortable:false});return d;};DataCollectionGrid.prototype.viewDataCollection=function(a){document.location.href=this.contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollection.do?reqCode=displayForDataCollectionGroup&dataCollectionGroupId="+a;};DataCollectionGrid.prototype.getPagingMode=function(){return this.pagingMode;
};DataCollectionGrid.prototype.hideAndShowExperimentParameter=function(){this.hideCol=!this.hideCol;this._hideCol();};DataCollectionGrid.prototype.getListDataCollection=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};DataCollectionGrid.prototype.changeRank=function(){this.rankEDNA=!this.rankEDNA;
this.setRankValue();};DataCollectionGrid.prototype.setRankValue=function(){for(var c=this.minDCId;c<=this.maxDCId;c++){var a=document.getElementsByName("rankIdList["+c+"]");if(a!=null&&a.item(0)!=null){if(this.rankEDNA){a.item(0).style.display="";}else{a.item(0).style.display="none";}}var b=document.getElementsByName("rankIdAutoProcList["+c+"]");
if(b!=null&&b.item(0)!=null){if(this.rankEDNA){b.item(0).style.display="none";}else{b.item(0).style.display="";}}var e=document.getElementById("rankIdImage["+c+"]");if(e!=null){if(this.rankEDNA){e.style.display="none";}else{e.style.display="";}}var d=document.getElementById("rankIdAutoProcImage["+c+"]");
if(d!=null){if(this.rankEDNA){d.style.display="";}else{d.style.display="none";}}}};DataCollectionGrid.prototype.startRank=function(){if(this.rankEDNA){this.onRankButtonClicked.notify({});}else{this.onRankAutoProcButtonClicked.notify({});}};DataCollectionGrid.prototype.getListDataCollectionRank=function(){var c=[];
for(var b=this.minDCId;b<=this.maxDCId;b++){var a=document.getElementsByName("rankIdList["+b+"]");if(a!=null&&a.item(0)!=null){c.push(b);}}return c;};DataCollectionGrid.prototype.getListDataCollectionRankAutoProc=function(){var c=[];for(var b=this.minDCId;b<=this.maxDCId;b++){var a=document.getElementsByName("rankIdAutoProcList["+b+"]");
if(a!=null&&a.item(0)!=null){c.push(b);}}return c;};DataCollectionGrid.prototype.getListDataCollectionSkip=function(){var c=[];for(var a=this.minDCId;a<=this.maxDCId;a++){var b=document.getElementsByName("skipIdList["+a+"]");if(b!=null&&b.item(0)!=null&&b.item(0)==false){c.push(a);}}return c;};DataCollectionGrid.prototype.downloadAutoproc=function(c){var b=this.rMergeCutoff;
var a=this.iSigmaCutoff;document.location.href=this.contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollection.do?reqCode=download&dataCollectionId="+c+"&rmerge="+b+"&isigma="+a+"&anomalous=false";};function DataCollectionGroupGrid(c){this.onSaveButtonClicked=new Event(this);
var b=false;var d=false;var a="";this.title="DataCollectionGroups";this.canSave=false;this.listOfCrystalClass=[];if(c!=null){if(c.height!=null){this.height=c.height;}if(c.isFx!=null){this.isFx=c.isFx;}if(c.isIndus!=null){this.isIndus=c.isIndus;}if(c.contextPath!=null){this.contextPath=c.contextPath;}if(c.title!=null){this.title=c.title;
}if(c.listOfCrystalClass!=null){this.listOfCrystalClass=c.listOfCrystalClass;}if(c.sessionId!=null){this.sessionId=c.sessionId;}if(c.canSave!=null){this.canSave=c.canSave;}}this._setCrystalClass();Ext.define("DataCollectionGroupModel",{extend:"Ext.data.Model",fields:[{name:"dataCollectionGroupId",mapping:"dataCollectionGroupId"},{name:"experimentType",mapping:"experimentType",type:"string"},{name:"startTime",mapping:"startTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"endTime",mapping:"endTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"crystalClass"},{name:"comments",mapping:"comments"},{name:"detectorMode",mapping:"detectorMode"},{name:"actualSampleBarcode",mapping:"actualSampleBarcode"},{name:"actualSampleSlotInContainer",mapping:"actualSampleSlotInContainer"},{name:"actualContainerBarcode",mapping:"actualContainerBarcode"},{name:"actualContainerSlotInSC",mapping:"actualContainerSlotInSC"},{name:"xtalSnapshotFileFullPath",mapping:"xtalSnapshotFileFullPath"},{name:"blSampleVO",mapping:"blSampleVO"},{name:"workflowVO",mapping:"workflowVO"},{name:"dataCollectionVOs",mapping:"dataCollectionVOs"},{name:"runNumber",mapping:"runNumber"},{name:"sampleName",mapping:"sampleName"},{name:"proteinAcronym",mapping:"proteinAcronym"},{name:"imagePrefix",mapping:"imagePrefix"},{name:"sampleNameProtein",mapping:"sampleNameProtein"},{name:"groupExperimentType"}],idProperty:"dataCollectionGroupId"});
}DataCollectionGroupGrid.prototype.getFilterTypes=function(){return[];};DataCollectionGroupGrid.prototype._sort=function(b,a){if(a){b.sort("startTime","DESC");}else{b.sort("startTime","ASC");}};DataCollectionGroupGrid.prototype._setCrystalClass=function(){this.crystalClass=[];for(var a=0;a<this.listOfCrystalClass.length;
a++){this.crystalClass.push(this.listOfCrystalClass[a].crystalClassName);}};DataCollectionGroupGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(a);};DataCollectionGroupGrid.prototype.refresh=function(a){this.features=a.dataCollectionGroupList;this.setGroupExperimentType();this.store.loadData(this.features,false);
};DataCollectionGroupGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;};DataCollectionGroupGrid.prototype.setGroupExperimentType=function(){var b=this;for(var a=0;a<b.features.length;a++){if(b.features[a].workflowVO){b.features[a].groupExperimentType=b.features[a].workflowVO.workflowType;
}else{b.features[a].groupExperimentType=b.features[a].experimentType;}}};DataCollectionGroupGrid.prototype.renderGrid=function(){var j=this;var e=[];var m=true;var c=null;j.setGroupExperimentType();for(var f=0;f<j.features.length;f++){if(j.features[f].sampleName&&j.features[f].sampleName!==""){m=false;
c="sampleNameProtein";break;}}var d=this._getColumns(m);this.store=Ext.create("Ext.data.Store",{model:"DataCollectionGroupModel",autoload:false,groupField:c});this.store.loadData(this.features,false);this._sort(this.store,m);var n=Ext.create("Ext.Panel",{id:"noGroupDataPanel",layout:{type:"fit",align:"center",bodyPadding:0,border:0},html:"<html><h4>No Data Collections Groups have been found</h4></html>"});
if(this.features.length==0){return n;}var l=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});var b=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{columnName}: {name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})',hideGroupedHeader:true,startCollapsed:false,id:"dataCollectionGroupGrouping"}),a=this.store.getGroups(),h=a.length,g=function(o){var p=o.text;
if(o.checked){b.expand(p,true);}else{b.collapse(p,true);}};var k=[];if(this.canSave){k.push({text:"Save Comments",tooltip:"Save dataCollections Groups",icon:"../images/save.gif",handler:function(){j.onSaveButtonClicked.notify({});}});}if(this.sessionId&&this.sessionId!="null"){k.push({text:"View DataCollection for all groups",tooltip:"View DataCollection for all groups",icon:"../images/magnif_16.png",handler:function(){document.location.href=contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollection.do?reqCode=displayForSession&sessionId="+j.sessionId;
}});}k.push("->");k.push({text:"Expand All",handler:function(){var o=b.view.getEl().query(".x-grid-group-body");Ext.each(o,function(p){b.expand(Ext.get(p));});}},{text:"Collapse All",handler:function(){var o=b.view.getEl().query(".x-grid-group-body");Ext.each(o,function(p){b.collapse(Ext.get(p));});}});
k.push({text:"Clear Grouping",iconCls:"icon-clear-group",handler:function(){b.disable();}});this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},model:"DataCollectionGroupModel",store:this.store,columns:d,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},plugins:[l],features:[b],tbar:k});
return this.grid;};DataCollectionGroupGrid.prototype.getListDataCollectionGroup=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};DataCollectionGroupGrid.prototype.getSessionId=function(){return this.sessionId;};DataCollectionGroupGrid.prototype._getColumns=function(l){var j=this;
function h(r,s,q){return Ext.Date.format(r,"d-m-Y H:i:s");}function k(t,u,q){var r="";if(q.data.actualSampleSlotInContainer!=null){r+=q.data.actualSampleSlotInContainer;}if(q.data.actualContainerSlotInSC!=null){r+=" ("+q.data.actualContainerSlotInSC+")";}r+="<br />";if(q.data.actualSampleBarcode!=null){r+=q.data.actualSampleBarcode;
}if(q.data.actualContainerBarcode!=null){r+=" ("+q.data.actualContainerBarcode+")";}return r;}function d(p){if(p){return'<div style="white-space:normal !important;word-wrap: break-word">'+p+"</div>";}else{return"";}}function a(s,t,p,u,r,q){if(p.get("dataCollectionVOs").length==0){return"x-hide-display";
}}function b(r,s,q){if(q.get("dataCollectionVOs")!=null){return q.get("dataCollectionVOs").length;}else{return 0;}}function m(r,s,q){if(q.get("dataCollectionVOs")!==null&&q.get("dataCollectionVOs").length>0){return q.get("dataCollectionVOs")[0].numberOfImages;}else{return 0;}}function g(s,t,q){if(q.data.workflowVO){var v="";
if(q.data.workflowVO.status){v=q.data.workflowVO.status;}var r="../images/Sphere_White_12.png";if(v){if(v.search("Error")!=-1||v.search("Failure")!=-1){r="../images/Sphere_Red_12.png";}else{if(v.search("Started")!=-1||v.search("Launched")!=-1){r="../images/Sphere_Orange_12.png";}else{if(v.search("Success")!=-1){r="../images/Sphere_Green_12.png";
}}}}var u=" <img src='"+r+"' border=0/>"+v+"<br/>"+q.data.workflowVO.workflowTitle+"<br/>"+q.data.workflowVO.comments;t.tdAttr='data-qtip="'+u+'"';return"<img src='"+r+"' border=0> <a href='"+contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewWorkflow.do?reqCode=display&workflowId="+q.data.workflowVO.workflowId+"'>"+q.data.workflowVO.workflowType+"</a>";
}else{return"";}}function f(t,u,q){if(q.data.workflowVO){var w="";if(q.data.workflowVO.status){w=q.data.workflowVO.status;}var s="../images/Sphere_White_12.png";if(w){if(w.search("Error")!=-1||w.search("Failure")!=-1){s="../images/Sphere_Red_12.png";}else{if(w.search("Started")!=-1||w.search("Launched")!=-1){s="../images/Sphere_Orange_12.png";
}else{if(w.search("Success")!=-1){s="../images/Sphere_Green_12.png";}}}}var r="";if(q.data.workflowVO.comments){r=q.data.workflowVO.comments;}var v=" <img src='"+s+"' border=0/>"+w+"<br/>"+q.data.workflowVO.workflowTitle+"<br/>"+r;u.tdAttr='data-qtip="'+v+'"';return"<img src='"+s+"' border=0> <a href='"+contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewWorkflow.do?reqCode=display&workflowId="+q.data.workflowVO.workflowId+"'>"+q.data.workflowVO.workflowType+"</a>";
}else{return q.data.experimentType;}}function n(t,u,q){if(q.data.crystalClass!=null){var s=q.data.crystalClass;for(var r=0;r<j.listOfCrystalClass.length;r++){var v=j.listOfCrystalClass[r].crystalClassCode;if(v==s){return j.listOfCrystalClass[r].crystalClassName;}return s;}}else{return"";}}Ext.util.Format.comboRenderer=function(p){return function(r){var q=p.findRecord(p.valueField,r);
return q?q.get(p.displayField):p.valueNotFoundText;};};var o=Ext.create("Ext.data.Store",{fields:["crystalClassCode","crystalClassName"],data:j.listOfCrystalClass});var c=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:o,valueField:"crystalClassCode",displayField:"crystalClassName",allowBlank:true,typeAhead:true,triggerAction:"all"});
var e=[{text:"Experiment<br/>Type",renderer:f,dataIndex:"groupExperimentType",flex:0.1},{text:"Protein<br/> Acronym",dataIndex:"proteinAcronym",flex:0.075},{text:"Image Prefix",dataIndex:"imagePrefix",flex:0.2},{text:"Run No",dataIndex:"runNumber",align:"center",flex:0.1},{text:"Sample name",dataIndex:"sampleName",hidden:l,flex:0.15},{text:"Acronym - Sample name",dataIndex:"sampleNameProtein",hidden:l,flex:0.15},{text:"Sample position",dataIndex:"actualSampleSlotInContainer",renderer:k,align:"center",type:"string",flex:0.15},{text:"Start Time",dataIndex:"startTime",renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s"),flex:0.15}];
if(j.isFx){if(j.canSave){e.push({text:"Crystal class",dataIndex:"crystalClass",flex:0.2,editor:c,renderer:Ext.util.Format.comboRenderer(c)});}else{e.push({text:"Crystal class",dataIndex:"crystalClass",flex:0.2,renderer:Ext.util.Format.comboRenderer(c)});}}if(j.canSave){e.push({text:"Comments",dataIndex:"comments",editor:{xtype:"textfield",allowBlank:true},flex:0.2,renderer:d});
}else{e.push({text:"Comments",dataIndex:"comments",flex:0.2,renderer:d});}e.push({text:"Nb<br/>Data<br/>Collections",dataIndex:"dataCollectionVOs",type:"int",align:"center",renderer:b,flex:0.05},{text:"Nb<br/>images",dataIndex:"dataCollectionVOs",type:"int",align:"center",renderer:m,flex:0.04});e.push({xtype:"actioncolumn",width:70,header:"View<br/>Collections",sortable:false,items:[{icon:"../images/magnif_16.png",tooltip:"View Collections",getClass:a,handler:function(q,r,p){j.viewCollections(j.store.getAt(r).data.dataCollectionGroupId);
}}]});return e;};DataCollectionGroupGrid.prototype.viewCollections=function(a){document.location.href=contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollection.do?reqCode=displayForDataCollectionGroup&dataCollectionGroupId="+a;};function ExptCellChart(){var a=this;this.store=null;
this.chart=null;this.panel=null;this.width=1000;this.height=500;}ExptCellChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",position:"left",fields:["cellEdgeA","cellEdgeB","cellEdgeC"],minorTickSteps:1,title:"Unit cell axes (A)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"right",fields:["totalIntegratedSignal"],minorTickSteps:1,title:"Total integrated signal",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["relativeHumidity"],title:"Relative Humidity (%)"}],series:[{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"relativeHumidity",yField:"totalIntegratedSignal",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"cellEdgeA",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"cellEdgeB",markerConfig:{type:"line",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"cellEdgeC",markerConfig:{type:"triangle",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};ExptCellChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function ExptCellTimeChart(){var a=this;this.store=null;this.chart=null;this.panel=null;this.width=1000;this.height=500;}ExptCellTimeChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",position:"left",fields:["relativeHumidity"],minorTickSteps:1,title:"Relative humidity (%)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"right",fields:["cellEdgeA","cellEdgeB","cellEdgeC"],minorTickSteps:1,title:"Unit cell edges (A)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["time"],title:"Time (seconds)"}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"time",yField:"relativeHumidity",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"cellEdgeA",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"cellEdgeB",markerConfig:{type:"line",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"cellEdgeC",markerConfig:{type:"triangle",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};ExptCellTimeChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function ExptLabelitChart(){var a=this;this.store=null;this.chart=null;this.panel=null;this.width=1000;this.height=500;}ExptLabelitChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",position:"left",fields:["numberOfSpots","braggPeaks"],minorTickSteps:1,title:"Number of Bragg peaks or spots",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"right",fields:["totalIntegratedSignal"],minorTickSteps:1,title:"Total integrated signal",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["relativeHumidity"],title:"Relative Humidity (%)"}],series:[{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"relativeHumidity",yField:"totalIntegratedSignal",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"numberOfSpots",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"braggPeaks",markerConfig:{type:"line",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};ExptLabelitChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function ExptResChart(){var a=this;this.store=null;this.chart=null;this.panel=null;this.width=1000;this.height=500;}ExptResChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",position:"left",fields:["rankingResolution","labelitR1","labelitR2"],minorTickSteps:1,title:"Resolution (A)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"right",fields:["mosaicSpread"],minorTickSteps:1,maximum:0.3,title:"Mosaic Spread",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["relativeHumidity"],title:"Relative Humidity (%)"}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"rankingResolution",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"relativeHumidity",yField:"mosaicSpread",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"labelitR1",markerConfig:{type:"line",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"relativeHumidity",yField:"labelitR2",markerConfig:{type:"triangle",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};ExptResChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function ExptResolutionTimeChart(){var a=this;this.store=null;this.chart=null;this.panel=null;this.width=1000;this.height=500;}ExptResolutionTimeChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",position:"left",fields:["relativeHumidity"],minorTickSteps:1,title:"Relative humidity (%)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"right",fields:["rankingResolution","labelitR1","labelitR2"],minorTickSteps:1,title:"Resolution (A)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["time"],title:"Time (seconds)"}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"time",yField:"relativeHumidity",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"labelitR1",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"labelitR2",markerConfig:{type:"line",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"rankingResolution",markerConfig:{type:"triangle",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};ExptResolutionTimeChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});
var a=new Ext.Toolbar({items:[d]});this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function ExptSpotsTimeChart(){var a=this;this.store=null;this.chart=null;this.panel=null;this.width=1000;this.height=500;}ExptSpotsTimeChart.prototype.getChart=function(){var a=this;
a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",position:"left",fields:["relativeHumidity"],minorTickSteps:1,title:"Relative humidity (%)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"right",fields:["braggPeaks","numberOfSpots"],minorTickSteps:1,title:"Number of Bragg peaks or spots",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["time"],title:"Time (seconds)"}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"time",yField:"relativeHumidity",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"braggPeaks",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"right",xField:"time",yField:"numberOfSpots",markerConfig:{type:"line",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};ExptSpotsTimeChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});
var a=new Ext.Toolbar({items:[d]});this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function DehydrationPanel(a){var b=this;this.width=1380;this.height=700;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}}DehydrationPanel.prototype.getPanel=function(e){var g=this;var j=e.dehydrationValues;var c=new ExptCellTimeChart();var b=new ExptCellChart();var f=new ExptLabelitChart();var n=new ExptResChart();var a=new ExptResolutionTimeChart();var l=new ExptSpotsTimeChart();var h=[];for(i=0;i<j.length;i++){var o={time:j[i].time,relativeHumidity:j[i].relativeHumidity,labelitR1:j[i].labelitR1,labelitR2:j[i].labelitR2,numberOfSpots:j[i].numberOfSpots,braggPeaks:j[i].braggPeaks,totalIntegratedSignal:j[i].totalIntegratedSignal,cellEdgeA:j[i].cellEdgeA,cellEdgeB:j[i].cellEdgeB,cellEdgeC:j[i].cellEdgeC,mosaicSpread:j[i].mosaicSpread,rankingResolution:j[i].rankingResolution};
h.push(o);}var m=Ext.create("Ext.data.JsonStore",{fields:["time","relativeHumidity","rFactor","labelitR1","labelitR2","numberOfSpots","braggPeaks","totalIntegratedSignal","cellEdgeA","cellEdgeB","cellEdgeC","mosaicSpread","rankingResolution"],data:h});var k=Ext.create("Ext.tab.Panel",{activeTab:0,defaults:{bodyPadding:0},items:[{tabConfig:{id:"exptCellTimeChart",title:"Expt Cell Time"},items:[c.getPanel(m)]},{tabConfig:{id:"exptCellChart",title:"Expt Cell"},items:[b.getPanel(m)]},{tabConfig:{id:"exptLabelitChart",title:"Expt labelit"},items:[f.getPanel(m)]},{tabConfig:{id:"exptResChart",title:"Expt res"},items:[n.getPanel(m)]},{tabConfig:{id:"exptResolutionTimeChart",title:"Expt resolution time"},items:[a.getPanel(m)]},{tabConfig:{id:"exptSpotsTimeChart",title:"Expt spots time"},items:[l.getPanel(m)]}]});
g.panel=Ext.create("Ext.Panel",{layout:"fit",items:[k]});return g.panel;};function EnergyScanGrid(b){this.onSaveButtonClicked=new Event(this);var a=false;this.contextPath="";this.title="EnergyScan";this.listOfCrystalClass=[];this.canSave=false;if(b!=null){if(b.height!=null){this.height=b.height;}if(b.isFx!=null){this.isFx=b.isFx;
}if(b.contextPath!=null){this.contextPath=b.contextPath;}if(b.title!=null){this.title=b.title;}if(b.listOfCrystalClass!=null){this.listOfCrystalClass=b.listOfCrystalClass;}if(b.sessionId!=null){this.sessionId=b.sessionId;}if(b.canSave!=null){this.canSave=b.canSave;}}this._setCrystalClass();Ext.define("EnergyScanModel",{extend:"Ext.data.Model",fields:[{name:"energyScanId",mapping:"energyScanId"},{name:"fluorescenceDetector",mapping:"fluorescenceDetector"},{name:"startTime",mapping:"startTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"endTime",mapping:"endTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"sampleName",mapping:"sampleName"},{name:"crystalClass"},{name:"comments",mapping:"comments"},{name:"scanFileFullPath",mapping:"scanFileFullPath"},{name:"choochFileFullPath",mapping:"choochFileFullPath"},{name:"jpegChoochFileFullPath",mapping:"jpegChoochFileFullPath"},{name:"element",mapping:"element"},{name:"startEnergy",mapping:"startEnergy"},{name:"endEnergy",mapping:"endEnergy"},{name:"transmissionFactor",mapping:"transmissionFactor"},{name:"exposureTime",mapping:"exposureTime"},{name:"synchrotronCurrent",mapping:"synchrotronCurrent"},{name:"temperature",mapping:"temperature"},{name:"peakEnergy",mapping:"peakEnergy"},{name:"peakFPrime",mapping:"peakFPrime"},{name:"peakFDoublePrime",mapping:"peakFDoublePrime"},{name:"inflectionEnergy",mapping:"inflectionEnergy"},{name:"inflectionFPrime",mapping:"inflectionFPrime"},{name:"inflectionFDoublePrime",mapping:"inflectionFDoublePrime"},{name:"xrayDose",mapping:"xrayDose"},{name:"edgeEnergy",mapping:"edgeEnergy"},{name:"filename",mapping:"filename"},{name:"beamSizeVertical",mapping:"beamSizeVertical"},{name:"beamSizeHorizontal",mapping:"beamSizeHorizontal"},{name:"scanFileFullPathExists",mapping:"scanFileFullPathExists"},{name:"shortFileName",mapping:"shortFileName"},{name:"choochExists",mapping:"choochExists"},{name:"jpegChoochFileFitPath",mapping:"jpegChoochFileFitPath"}],idProperty:"energyScanId"});
}EnergyScanGrid.prototype.getFilterTypes=function(){return[];};EnergyScanGrid.prototype._sort=function(a){a.sort("startTime","DESC");};EnergyScanGrid.prototype._setCrystalClass=function(){this.crystalClass=[];for(var a=0;a<this.listOfCrystalClass.length;a++){this.crystalClass.push(this.listOfCrystalClass[a].crystalClassName);
}};EnergyScanGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(a);};EnergyScanGrid.prototype.refresh=function(a){this.features=a.energyScansList;this.store.loadData(this.features,false);};EnergyScanGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;
};EnergyScanGrid.prototype.renderGrid=function(){var f=this;var d=[];var b=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"EnergyScanModel",autoload:false});this._sort(this.store);this.store.totalCount=this.features.length;this.store.loadData(this.features,false);var a=Ext.create("Ext.Panel",{id:"noEnergyScanDataPanel",layout:{type:"fit"},html:"<html><h4>No Energy Scans have been found</h4></html>"});
if(this.features.length==0){return a;}var e=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});var c=[];if(this.canSave){c.push({text:"Save Comments",tooltip:"Save energy scans",icon:"../images/save.gif",handler:function(){f.onSaveButtonClicked.notify({});}});}this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:"100%",model:"EnergyScanModel",height:"100%",store:this.store,columns:b,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},plugins:[e],tbar:c});
return this.grid;};EnergyScanGrid.prototype.getListEnergyScan=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};EnergyScanGrid.prototype.getSessionId=function(){return this.sessionId;};EnergyScanGrid.prototype._getColumns=function(){var h=this;function e(n,o,m){return Ext.Date.format(n,"d-m-Y H:i:s");
}function b(m){if(m){return'<div style="white-space:normal !important;word-wrap: break-word;">'+m+"</div>";}else{return"";}}function k(q,r,m){if(m.data.crystalClass!=null){var o=m.data.crystalClass;for(var n=0;n<h.listOfCrystalClass.length;n++){var s=h.listOfCrystalClass[n].crystalClassCode;if(s==o){return h.listOfCrystalClass[n].crystalClassName;
}return o;}}else{return"";}}Ext.util.Format.comboRenderer=function(m){return function(o){var n=m.findRecord(m.valueField,o);return n?n.get(m.displayField):m.valueNotFoundText;};};function d(n,o,m){if(n===null){return"";}return Number(n).toFixed(3);}function f(n,o,m){if(n===null){return"";}return Number(n).toFixed(1);
}function g(n,o,m){if(!m.data.scanFileFullPath){return"";}else{if(!m.data.scanFileFullPathExists){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Raw data file not found:<br>"+n+"</h4></div>";}else{return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewDataCollection.do?reqCode=downloadFile&fullFilePath= "+n+"'  styleClass='LIST'>"+m.data.shortFileName+"</a></div>";
}}}function j(n,o,m){if(!m.data.jpegChoochFileFullPath){return"";}else{if(!m.data.choochExists){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Chooch output not found:<br>"+n+"</h4></div>";}else{return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewResults.do?reqCode=viewJpegImageFromFile&file="+m.data.jpegChoochFileFitPath+"'  styleClass='LIST'>"+"<img width='150' height='110' src='imageDownload.do?reqCode=getImageJpgFromFile&file="+m.data.jpegChoochFileFitPath+"' border='0' alt='Click to zoom the image' >"+"</a></div>";
}}}var l=Ext.create("Ext.data.Store",{id:0,fields:["crystalClassCode","crystalClassName"],data:h.listOfCrystalClass});var a=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:l,valueField:"crystalClassCode",displayField:"crystalClassName",allowBlank:true,typeAhead:true,triggerAction:"all"});var c=[{text:"Element",dataIndex:"element",flex:0.05,id:"element"},{text:"Sample name",dataIndex:"sampleName",flex:0.1},{text:"Inflection<br>Energy<br>(keV)",dataIndex:"inflectionEnergy",flex:0.075,renderer:d,id:"inflectionEnergy"},{text:"Exposure<br>Time<br>(s)",dataIndex:"exposureTime",flex:0.075,renderer:f,id:"exposureTime"},{text:"Inflection <br>f'<br>(e)",dataIndex:"inflectionFPrime",flex:0.075,renderer:f,id:"inflectionFPrime"},{text:"Inflection <br>f''<br>(e)",dataIndex:"inflectionFDoublePrime",flex:0.075,renderer:f,id:"inflectionFDoublePrime"},{text:"Peak<br>Energy<br>(keV)",dataIndex:"peakEnergy",flex:0.05,renderer:d,id:"peakEnergy"},{text:"Peak <br>f'<br>(e)",dataIndex:"peakFPrime",flex:0.05,renderer:f,id:"peakFPrime"},{text:"Peak <br>f''<br>(e)",dataIndex:"peakFDoublePrime",flex:0.05,renderer:f,id:"peakFDoublePrime"},{text:"Start Time",dataIndex:"startTime",renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s"),flex:0.15},{text:"End Time",dataIndex:"endTime",renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s"),flex:0.15},{text:"Beam<br>size Hor.<br>(&#181m)",dataIndex:"beamSizeHorizontal",flex:0.05,id:"beamSizeHorizontal"},{text:"Beam<br>size Ver.<br>(&#181m)",dataIndex:"beamSizeVertical",flex:0.05,id:"beamSizeVertical"},{text:"Transm.<br>Factor<br>(%)",dataIndex:"transmissionFactor",flex:0.05,renderer:d,id:"transmissionFactor"},{text:"Raw data File",dataIndex:"scanFileFullPath",flex:0.2,renderer:g,id:"scanFileFullPath"},{text:"Chooch Output",dataIndex:"jpegChoochFileFullPath",flex:0.2,renderer:j,id:"jpegChoochFileFullPath"}];
if(h.isFx){c.push({text:"Crystal class",dataIndex:"crystalClass",flex:0.2,editor:a,renderer:Ext.util.Format.comboRenderer(a)});}if(this.canSave){c.push({text:"Comments",dataIndex:"comments",editor:{xtype:"textfield",allowBlank:true},flex:0.2,renderer:b});}else{c.push({text:"Comments",dataIndex:"comments",flex:0.2,renderer:b});
}return c;};EnergyScanGrid.prototype.getListEnergyScan=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};function ImagePanel(a){var b=this;this.width="100%";this.height=800;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ImagePanel.prototype.getPanel=function(c,h,d,a){var g=this;
var f=new XtalSnapshotPanel();f=f.getPanel(c);var e=new WallImagePanel();e=e.getPanel(h);if(d==1){e=new MeshWallImagePanel();e=e.getPanel(h,a);}var b=[];b.push(f);b.push(e);g.panel=Ext.create("Ext.Panel",{layout:"vbox",items:b});return g.panel;};function ImageTabPanel(a){var b=this;this.width=1380;this.height=700;
if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ImageTabPanel.prototype.getPanel=function(c){var f=this;var h=[];if(c&&c.listOfImages){var e=c.listOfImages.length;for(var d=0;d<e;d++){var g=new ImagePanel();var k=""+d;if(c.listOfCollect&&c.listOfCollect.length>d){collects=c.listOfCollect[d];
if(collects.length>0){k=collects[0].imagePrefix;}}var b=null;if(c.listOfMeshData&&c.listOfMeshData.length>d){b=c.listOfMeshData[d];}var a=null;if(c.listOfSnapshot&&c.listOfSnapshot.length>d){a=c.listOfSnapshot[d];}h.push({tabConfig:{title:k},items:[g.getPanel(a,c.listOfImages[d],c.displayMesh,b)]});}}var j=Ext.create("Ext.tab.Panel",{layout:"fit",activeTab:0,defaults:{bodyPadding:0},items:h});
f.panel=Ext.create("Ext.Panel",{layout:"fit",items:[j]});return f.panel;};Ext.Loader.setConfig({enabled:true});var dataCollectionsList;var dataCollectionGrid;var imagePanel;var workflowPanel;var meshScanPanel;var dehydrationPanel;var reportPanel;var referencePanel=null;var parametersPanel=null;var reportPanel=null;
var resultPanel;var parametersPanel;var IspybCollection={start:function(a,b){this.tartgetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showCollectionPage(a,b);},showCollectionPage:function(a,c){var d=this;var b=new Collection();b.onSaved.attach(function(e,f){d.refreshDataCollection(f);});b.onRank.attach(function(e,f){document.location.href="/ispyb/user/sampleRanking.do?reqCode=display";});b.onRankAutoProc.attach(function(e,f){document.location.href="/ispyb/user/autoProcRanking.do?reqCode=display";
});dataCollectionsList=[];b.collectionRetrieved.attach(function(n,g){if(g.errors&&g.errors.length>0){var h=[];h.targetId=a;h.errors=g.errors;var e=new ErrorPanel(h);return;}dataCollectionsList=g.dataCollectionList;var o=g.listOfCrystalClass;g.pagingMode=false;if(dataCollectionsList.length>500){g.pagingMode=true;
}dataCollectionGrid=new DataCollectionGrid(g);dataCollectionGrid.onSaveButtonClicked.attach(function(r,q){var p=dataCollectionGrid.getListDataCollection();b.saveDataCollection(p);});dataCollectionGrid.onRankButtonClicked.attach(function(q,p){var r=dataCollectionGrid.getListDataCollectionRank();b.rank(r);
});dataCollectionGrid.onRankAutoProcButtonClicked.attach(function(q,p){var r=dataCollectionGrid.getListDataCollectionRankAutoProc();b.rankAutoProc(r);});var j=[];j.push({tabConfig:{title:"DataCollections"},items:[dataCollectionGrid.getGrid(dataCollectionsList)]});if(g.displayWorkflow==1){workflowPanel=new WorkflowPanel();
j.push({tabConfig:{title:"Workflow"},items:[workflowPanel.getPanel(g)]});}if(g.displayMesh==1){meshScanPanel=new MeshScanPanel();j.push({tabConfig:{title:"Mesh"},items:[meshScanPanel.getPanel(g.meshData,g.snapshot,0)]});}if(g.displayDehydration==1){dehydrationPanel=new DehydrationPanel();j.push({tabConfig:{title:"Dehydration"},items:[dehydrationPanel.getPanel(g)]});
}if(g&&g.workflowVO&&g.workflowVO.resultFiles&&g.workflowVO.resultFiles.length>0){resultPanel=new ResultPanel();j.push({tabConfig:{title:"Results"},items:[resultPanel.getPanel(g)]});}var k=Ext.create("Ext.tab.Panel",{activeTab:0,style:{marginTop:"10px"},defaults:{bodyPadding:0,autoScroll:true},items:j});
referencePanel=new ReferencePanel();parametersPanel=new ParametersPanel();reportPanel=new ReportPanel();var f=[];f.push(reportPanel.getPanel(g));f.push(parametersPanel.getPanel(g));f.push(referencePanel.getPanel(g));var m=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,collapsible:true,title:"Data Collection info...",layout:{type:"hbox"},style:{padding:0},items:f});
var l=[];l.push(m);l.push(k);d.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,renderTo:a,style:{padding:0},items:l});dataCollectionGrid.setRankValue();dataCollectionGrid._hideCol();dataCollectionGrid._sort();});if(c==1){b.getDataCollectionByDataCollectionGroup();}else{if(c==0){b.getDataCollectionBySession();
}}if(c=="session"){b.getDataCollectionBySession();}else{if(c=="dataCollectionGroup"){b.getDataCollectionByDataCollectionGroup();}else{if(c=="sample"){b.getDataCollectionBySample();}else{if(c=="protein"){b.getDataCollectionByProtein();}else{if(c=="customQuery"){b.getDataCollectionByCustomQuery();}else{if(c=="sampleId"){b.getDataCollectionBySampleId();
}}}}}}},refreshDataCollection:function(a){var b=this;dataCollectionGrid.refresh(a);}};Ext.Loader.setConfig({enabled:true});var dataCollectionGroupsList;var dataCollectionGroupGrid;var xrfSpectraGrid;var energyScanGrid;var sessionForm;var crystalClassGrid;var IspybCollectionGroup={start:function(a,b){this.tartgetId=a;
Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showCollectionGroup(a,b);},showCollectionGroup:function(b,c){var d=this;collectionGroup=new CollectionGroup();collectionGroup.onSaved.attach(function(e,f){d.refreshDataCollectionGroup(f);d.refreshEnergyScan(f);d.refreshXRFSpectra(f);});var a=[];dataCollectionGroupsList=[];xrfSpectraList=[];
energyScanList=[];collectionGroup.collectionGroupRetrieved.attach(function(q,h){if(h.errors&&h.errors.length>0){var l=[];l.targetId=b;l.errors=h.errors;var g=new ErrorPanel(l);return;}dataCollectionGroupsList=h.dataCollectionGroupList;xrfSpectraList=h.xrfSpectraList;listOfCrystalClass=h.listOfCrystalClass;
energyScanList=h.energyScansList;dataCollectionGroupGrid=new DataCollectionGroupGrid(h);xrfSpectraGrid=new XRFSpectraGrid(h);energyScanGrid=new EnergyScanGrid(h);crystalClassGrid=new CrystalClassGrid(h);dataCollectionGroupGrid.onSaveButtonClicked.attach(function(t,s){var r=dataCollectionGroupGrid.getListDataCollectionGroup();
var u=dataCollectionGroupGrid.getSessionId();collectionGroup.saveDataCollectionGroup(r,u);});xrfSpectraGrid.onSaveButtonClicked.attach(function(s,r){var u=xrfSpectraGrid.getListXRFSpectra();var t=xrfSpectraGrid.getSessionId();collectionGroup.saveXRFSpectra(u,t);});energyScanGrid.onSaveButtonClicked.attach(function(s,r){var t=energyScanGrid.getListEnergyScan();
var u=energyScanGrid.getSessionId();collectionGroup.saveEnergyScan(t,u);});sessionForm=new SessionForm(h);var e=400;var k=300;if(h.isFx){k=420;}if(h.isIx){k=370;}if(h&&h.session){panelSession=Ext.widget({xtype:"form",layout:"fit",collapsible:true,id:"sessionForm",frame:true,title:"Session Information",bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:90},style:{marginTop:"10px"},defaultType:"textfield",items:[sessionForm.getPanel(h.session)],buttons:[{text:"Save",handler:function(){var r=sessionForm.getSession();
if(this.up("form").getForm().isValid()){this.up("form").getForm().submit({url:"viewDataCollectionGroup.do?reqCode=saveSession&session="+JSON.stringify(sessionForm.getSession()),success:function(s,t){d.refreshSession(h);}});}}}]});}var n=Ext.create("Ext.tab.Panel",{activeTab:0,defaults:{bodyPadding:0,autoScroll:true},style:{marginTop:"10px"},items:[{tabConfig:{id:"dataCollectionGroup",title:"DataCollectionGroups"},items:[dataCollectionGroupGrid.getGrid(dataCollectionGroupsList),crystalClassGrid.getGrid(h.listCrystal)]},{tabConfig:{id:"energyScans",title:"EnergyScans"},items:[energyScanGrid.getGrid(energyScanList)]},{tabConfig:{id:"xrfspectra",title:"XRFSpectra"},items:[xrfSpectraGrid.getGrid(xrfSpectraList)]}]});
referencePanel=new ReferencePanel();var m=new SessionStatsPanel();var j=new ReportSessionPanel();var f=[];if(h&&h.session){f.push(panelSession);}if(h&&h.session){f.push(m.getPanel(h.session));}if(h&&h.listOfReferences&&h.listOfReferences.length>0){f.push(referencePanel.getPanel(h));}if(h&&h.sessionHasMXpressOWF&&h.sessionHasMXpressOWF==true){f.push(j.getPanel(h));
}var p=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,layout:{type:"hbox"},style:{padding:0},items:f});var o=[];o.push(p);o.push(n);d.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,layout:{type:"vbox",align:"stretch"},renderTo:b,items:o});});collectionGroup.sessionRetrieved.attach(function(e,f){sessionForm.refresh(f.session);
});if(c&&c!="null"){collectionGroup.getCollectionGroupBySession();}else{collectionGroup.getCollectionGroupBySample();}},refreshDataCollectionGroup:function(a){var b=this;dataCollectionGroupGrid.refresh(a);crystalClassGrid.refresh(a);},refreshXRFSpectra:function(a){var b=this;xrfSpectraGrid.refresh(a);
},refreshEnergyScan:function(a){var b=this;energyScanGrid.refresh(a);},refreshSession:function(){var b=this;var a=dataCollectionGroupGrid.getSessionId();collectionGroup.getSessionInformation(a);}};Ext.Loader.setConfig({enabled:true});var imagePanel;var workflowPanel;var meshScanPanel;var dehydrationPanel;
var emptyPanel=null;var referencePanel=null;var IspybCollection2={start:function(b,c,a){this.tartgetId=b;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showCollectionPage(b,c,a);},showCollectionPage:function(b,d,a){var e=this;var c=new Collection();c.onSaved.attach(function(f,g){e.refreshDataCollection(g);});c.onRank.attach(function(f,g){document.location.href="/ispyb/user/sampleRanking.do?reqCode=display";});c.onRankAutoProc.attach(function(f,g){document.location.href="/ispyb/user/autoProcRanking.do?reqCode=display";
});c.collectionRetrieved.attach(function(f,l){if(l.errors&&l.errors.length>0){var h=[];h.targetId=b;h.errors=l.errors;var k=new ErrorPanel(h);return;}listOfCrystalClass=l.listOfCrystalClass;l.pagingMode=false;var g=[];if(l.displayWorkflow==1){workflowPanel=new WorkflowPanel();g.push({tabConfig:{title:"Workflow"},items:[workflowPanel.getPanel(l)]});
}if(l.displayMesh==1){meshScanPanel=new MeshScanPanel();g.push({tabConfig:{title:"Mesh"},items:[meshScanPanel.getPanel(l.meshData,l.snapshot,0)]});}if(l.displayDehydration==1){dehydrationPanel=new DehydrationPanel();g.push({tabConfig:{title:"Dehydration"},items:[dehydrationPanel.getPanel(l)]});}if(l&&l.workflowVO&&l.workflowVO.resultFiles&&l.workflowVO.resultFiles.length>0){resultPanel=new ResultPanel();
g.push({tabConfig:{title:"Results"},items:[resultPanel.getPanel(l)]});}if(g.length>0){var j=Ext.create("Ext.tab.Panel",{width:"99%",activeTab:0,defaults:{bodyPadding:0,autoScroll:true},items:g});var m=[];m.push(j);e.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,width:"99%",border:0,layout:"fit",renderTo:b,style:{padding:0},items:m});
}});if(d=="dataCollectionGroup"){c.getDataCollectionByDataCollectionGroup(a);}else{if(d==0){}}},refreshDataCollection:function(a){var b=this;}};Ext.Loader.setConfig({enabled:true});var dataCollectionList;var dataCollectionGrid=null;var searchDataCollectionPanel=null;var emptyPanel=null;var searchBeamline="";
var startDate="";var endDate="";var startTime="";var endTime="";var IspybLastCollect={start:function(a){this.tartgetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showLastCollect(a);},showLastCollect:function(b){var d=this;var c=new Collection();var a=[];dataCollectionList=[];searchDataCollectionPanel=new SearchDataCollectionPanel();searchDataCollectionPanel.onSearchDataCollection.attach(function(e,g){var f=searchDataCollectionPanel.getSearchCriteria();
c.getLastCollect(f.beamline,f.startDate,f.endDate,f.startTime,f.endTime);});emptyPanel=Ext.create("Ext.Panel",{id:"emptyPanel",border:false,bodyStyle:{"background-color":"#99FFCC"},width:600,height:20});c.collectionRetrieved.attach(function(e,f){dataCollectionList=f.dataCollectionList;listOfCrystalClass=f.listOfCrystalClass;
if(d.panel){d.refreshCollections(f);}else{a.push(searchDataCollectionPanel.getPanel(f.beamlines));searchDataCollectionPanel.setCriteria(searchBeamline,startDate,endDate,startTime,endTime);a.push(emptyPanel);if(f.dataCollectionList.length==0){a.push(d.getNoCollectPanel());}else{f.pagingMode=true;d.createDataCollectionGrid(f);
a.push(dataCollectionGrid.getGrid(dataCollectionList));}d.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,bodyStyle:{"background-color":"#99FFCC"},renderTo:b,style:{padding:0},items:a});}});c.criteriaRetrieved.attach(function(e,f){if(f){searchBeamline=f.searchBeamline;startDate=f.startDate;
endDate=f.endDate;startTime=f.startTime;endTime=f.endTime;}c.getLastCollect(searchBeamline,startDate,endDate,startTime,endTime);});c.getSearchCriteria();},getNoCollectPanel:function(){var a=Ext.create("Ext.Panel",{id:"noCollectDataPanel",width:600,height:200,border:0,bodyStyle:{"background-color":"#99FFCC"},layout:{type:"vbox",align:"center",bodyPadding:0,border:0},html:"<html><h4>No Data Collections  have been found</h4></html>"});
return a;},createDataCollectionGrid:function(a){var b=this;dataCollectionGrid=new DataCollectionGrid(a);dataCollectionGrid.onPagingMode.attach(function(c,d){a.pagingMode=!dataCollectionGrid.getPagingMode();b.clearExtjsComponent();dataCollectionGrid.setArgs(a);b.panel.add(dataCollectionGrid.getGrid(dataCollectionList));
b.panel.doLayout();});},clearExtjsComponent:function(){var a=this;a.panel.items.removeAt(2);},refreshCollections:function(a){var b=this;if(a.dataCollectionList.length==0){if(dataCollectionGrid!=null){this.clearExtjsComponent();dataCollectionGrid=null;b.panel.add(b.getNoCollectPanel());b.panel.doLayout();
}}else{this.clearExtjsComponent();a.pagingMode=true;b.createDataCollectionGrid(a);b.panel.add(dataCollectionGrid.getGrid(dataCollectionList));b.panel.doLayout();}}};Ext.Loader.setConfig({enabled:true});var sessionForm;var sessionViewGrid;var reportSessionPanel;var crystalClassGrid;var collectionGroup;
var sessionSummary;var IspybSessionSummary={start:function(a,c,b){this.targetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showSessionSummary(a,c,b);},showSessionSummary:function(b,d,c){var e=this;collectionGroup=new CollectionGroup();sessionSummary=new SessionSummaryObject();collectionGroup.onSaved.attach(function(f,g){e.refreshData(g);});collectionGroup.imageSaved.attach(function(f,g){reportSessionPanel.exportSessionReport();
});collectionGroup.sessionRetrieved.attach(function(f,g){sessionForm.refresh(g.session);});var a=[];sessionSummary.sessionSummaryRetrieved.attach(function(s,k){if(k.errors&&k.errors.length>0){var o=[];o.targetId=b;o.errors=k.errors;var j=new ErrorPanel(o);return;}var t=k.listSessionDataObjectInformation;
sessionViewGrid=new SessionViewGrid(k);sessionViewGrid.onExportReportWithGraphSelected.attach(function(x,v){var w=v.listSvg;var y=v.sessionId;var u=v.listId;collectionGroup.saveImageForExport(w,y,u);});sessionViewGrid.onSaveButtonClicked.attach(function(v,u){var x=sessionViewGrid.getListData();var y=sessionViewGrid.getSessionId();
var w=sessionViewGrid.getNbOfItems();sessionSummary.saveData(x,y,w);});sessionViewGrid.onPageChanged.attach(function(v,u){sessionSummary.changeSessionReportPageNumber(u.sessionReportCurrentPageNumber,u.sessionId);});crystalClassGrid=new CrystalClassGrid(k);sessionForm=new SessionForm(k);var f=400;var m=300;
if(k.isFx){m=420;}if(k.isIx){m=370;}var n;if(k&&k.session){n=Ext.widget({xtype:"form",layout:"fit",collapsible:true,id:"sessionForm",frame:true,title:"Session Information",bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:90},style:{marginTop:"10px"},defaultType:"textfield",items:[sessionForm.getPanel(k.session)],buttons:[{text:"Save",handler:function(){var u=sessionForm.getSession();
if(this.up("form").getForm().isValid()){this.up("form").getForm().submit({url:"viewDataCollectionGroup.do?reqCode=saveSession&session="+JSON.stringify(sessionForm.getSession()),success:function(v,w){e.refreshSession(k);}});}}}]});}var g=new ReferencePanel();var p=new SessionStatsPanel();var l=new ReportSessionPanel();
l.onExportReportSelected.attach(function(v,u){sessionViewGrid.saveGraphAsImg();});var h=[];if(k&&k.session){h.push(n);}if(k&&k.session){h.push(p.getPanel(k.session));}if(k&&k.listOfReferences&&k.listOfReferences.length>0){h.push(g.getPanel(k));}if(k){h.push(l.getPanel(k));}var r=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,width:"100%",layout:{type:"hbox"},style:{padding:0},items:h});
var q=[];q.push(r);q.push(sessionViewGrid.getGrid(t));q.push(crystalClassGrid.getGrid(k.listCrystal));e.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,width:"100%",layout:{type:"vbox",align:"stretch"},renderTo:b,items:q});});if(d&&d!="null"){sessionSummary.getSessionSummary(c);}},refreshSession:function(){var b=this;
var a=sessionViewGrid.getSessionId();collectionGroup.getSessionInformation(a);},refreshData:function(a){var b=this;sessionViewGrid.refresh(a);crystalClassGrid.refresh(a);}};Ext.Loader.setConfig({enabled:true});var workflowPanel;var meshScanPanel;var dehydrationPanel;var emptyPanel=null;var referencePanel=null;
var IspybWorkflow={start:function(a,b){this.tartgetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showWorkflowPage(a,b);},showWorkflowPage:function(a,b){var c=this;collection=new Collection();collection.onSaved.attach(function(d,e){c.refreshDataCollection(e);});collection.onRank.attach(function(d,e){document.location.href="/ispyb/user/sampleRanking.do?reqCode=display";});
collection.onRankAutoProc.attach(function(d,e){document.location.href="/ispyb/user/autoProcRanking.do?reqCode=display";});dataCollectionsList=[];collection.workflowRetrieved.attach(function(s,h){if(h.errors&&h.errors.length>0){var n=[];n.targetId=a;n.errors=h.errors;var f=new ErrorPanel(n);return;}dataCollectionsList=[];
for(var k=0;k<h.listOfCollect.length;k++){collects=h.listOfCollect[k];for(var g=0;g<collects.length;g++){dataCollectionsList.push(collects[g]);}}listOfCrystalClass=h.listOfCrystalClass;h.pagingMode=false;dataCollectionGrid=new DataCollectionGrid(h);dataCollectionGrid.onSaveButtonClicked.attach(function(u,t){var j=dataCollectionGrid.getListDataCollection();
collection.saveDataCollection(j);});dataCollectionGrid.onRankButtonClicked.attach(function(t,j){var u=dataCollectionGrid.getListDataCollectionRank();collection.rank(u);});dataCollectionGrid.onRankAutoProcButtonClicked.attach(function(t,j){var u=dataCollectionGrid.getListDataCollectionRankAutoProc();collection.rankAutoProc(u);
});var o=[];o.push({tabConfig:{title:"DataCollections"},items:[dataCollectionGrid.getGrid(dataCollectionsList)]});if(h.displayWorkflow==1){workflowPanel=new WorkflowPanel();o.push({tabConfig:{title:"Workflow"},items:[workflowPanel.getPanel(h)]});}if(h.displayMesh==1){var l=h.listOfMeshData.length;if(l>1){var p=new MeshTabPanel();
o.push({tabConfig:{title:"Mesh"},items:[p.getPanel(h)]});}else{if(l==1){var m=new MeshScanPanel();var e=h.listOfMeshData[0];var d=null;if(h.listOfSnapshot&&h.listOfSnapshot.length>0){d=h.listOfSnapshot[0];}o.push({tabConfig:{title:"Mesh"},items:[m.getPanel(e,d,0)]});}}}if(h.displayDehydration==1){dehydrationPanel=new DehydrationPanel();
o.push({tabConfig:{title:"Dehydration"},items:[dehydrationPanel.getPanel(h)]});}if(h&&h.workflowVO&&h.workflowVO.resultFiles&&h.workflowVO.resultFiles.length>0){resultPanel=new ResultPanel();o.push({tabConfig:{title:"Results"},items:[resultPanel.getPanel(h)]});}if(o.length>0){var q=Ext.create("Ext.tab.Panel",{width:"99%",activeTab:0,defaults:{bodyPadding:0,autoScroll:true},items:o});
var r=[];r.push(q);c.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,width:"99%",border:0,layout:"fit",renderTo:a,style:{padding:0},items:r});}dataCollectionGrid.setRankValue();dataCollectionGrid._hideCol();dataCollectionGrid._sort();});collection.getWorkflow(b);},refreshDataCollection:function(a){var b=this;
dataCollectionGrid.refresh(a);}};function ColorRangeManager(a){var b=this;this.redFrequency=0.1;this.grnFrequency=0.2;this.bluFrequency=0.3;this.center=128;this.width=127;this.phase1=0;this.phase2=0;this.phase3=0;this.len=20;this.reverseOrder=false;this._emptyDataColor="#E8DFE8";this._dataRange={min:null,max:null};
this._debug=false;this._colorRange=null;this._dataStep=null;this._maxDataSpace=null;if(a!=null){if(a.dataRange!=null){this._dataRange=a.dataRange;}}this._colorRange=[];this._setupColorRange();}ColorRangeManager.prototype.loadData=function(a,b){this._dataRange=a;this._setupColorRange();this.reverseOrder=b;
};ColorRangeManager.prototype.getMaxValue=function(){return this._dataRange.max;};ColorRangeManager.prototype.getMinValue=function(){return this._dataRange.min;};ColorRangeManager.prototype.getCellColorString=function(b){var a=this.getCellColorRGBA(b);return a;};ColorRangeManager.prototype.getCellColorRGBA=function(d){if(d==null){return this._emptyDataColor;
}var c=this.getLen();var e=d/this._dataStep;var a=this._dataRange.min/this._dataStep;var b=(e-a);b=d*this._colorRange.length/this._dataRange.max;if(b<0){b=Math.ceil(b);}else{b=Math.floor(b);}this._log("value: "+d+" bin: "+e+" new bin: "+b+" / nbCol="+this._colorRange.length+" & max= "+this._dataRange.max);
if(this.reverseOrder){b=this._dataRange.max/this._dataStep-b;}if(b<0){b=0;}if(b>=this._colorRange.length){b=(this._colorRange.length)-1;}return this._colorRange[b];};ColorRangeManager.prototype._setupColorRange=function(){var a=this._dataRange;var b=this.getLen();this._colorRange=[];this._addColorsToRange();
this._maxDataSpace=Math.abs(a.min)+Math.abs(a.max);this._dataStep=this._maxDataSpace/b;this._log("dataStep: "+this._dataStep);};ColorRangeManager.prototype._addColorsToRange=function(){var a=this.getLen();for(var d=0;d<a;++d){var e=Math.sin(this.redFrequency*d+this.phase1)*this.width+this.center;var b=Math.sin(this.grnFrequency*d+this.phase2)*this.width+this.center;
var c=Math.sin(this.bluFrequency*d+this.phase3)*this.width+this.center;this._colorRange[this._colorRange.length]=this._RGB2Color(e,b,c);}};ColorRangeManager.prototype._RGB2Color=function(d,c,a){return"#"+this._byte2Hex(d)+this._byte2Hex(c)+this._byte2Hex(a);};ColorRangeManager.prototype._byte2Hex=function(b){var a="0123456789ABCDEF";
return String(a.substr((b>>4)&15,1))+a.substr(b&15,1);};ColorRangeManager.prototype.getLen=function(){return this.len;};ColorRangeManager.prototype.createColorGradient=function(d,g){var a=this.getLen();document.getElementById(d).innerHTML="0 ";for(var e=0;e<a;++e){var f=Math.sin(this.redFrequency*e+this.phase1)*this.width+this.center;
var b=Math.sin(this.grnFrequency*e+this.phase2)*this.width+this.center;var c=Math.sin(this.bluFrequency*e+this.phase3)*this.width+this.center;document.getElementById(d).innerHTML+='<font color="'+this._RGB2Color(f,b,c)+'">&#9608;</font>';}document.getElementById(d).innerHTML+=g;};ColorRangeManager.prototype.getColorRange=function(c){c=c-this._dataRange.min/this._dataStep;
if(this.reverseOrder){c=Math.floor(this._dataRange.max/this._dataStep-c);}var d=Math.sin(this.redFrequency*c+this.phase1)*this.width+this.center;var a=Math.sin(this.grnFrequency*c+this.phase2)*this.width+this.center;var b=Math.sin(this.bluFrequency*c+this.phase3)*this.width+this.center;return this._RGB2Color(d,a,b);
};ColorRangeManager.prototype._log=function(a){if(this._debug){console.log(a);}};function DetailsPanel(a){var b=this;this.width="800";this.height="200";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}DetailsPanel.prototype.getPanel=function(){var c=this;var b=new PositionGrid();
b=b.getGrid();var a=new XtalSnapshotPanel();a=a.getPanel();c.panel=Ext.create("Ext.Panel",{width:800,height:200,layout:"border",items:[{region:"center",split:true,collapsible:false,floatable:false,items:[b]},{region:"east",width:200,height:200,split:true,collapsible:false,floatable:false,items:[a]}]});
return c.panel;};var SVG={svgns:"http://www.w3.org/2000/svg",xlinkns:"http://www.w3.org/1999/xlink",createSVGCanvas:function(a,c){c.push(["xmlns",SVG.svgns],["xmlns:xlink","http://www.w3.org/1999/xlink"]);var b=document.createElementNS("http://www.w3.org/2000/svg","svg");this._setProperties(b,c);a.appendChild(b);
return b;},createRectangle:function(b,f,d,a,c){var e=document.createElementNS(this.svgns,"rect");e.setAttribute("x",b);e.setAttribute("y",f);e.setAttribute("width",d);e.setAttribute("height",a);SVG._setProperties(e,c);return e;},drawImage64:function(b,h,e,a,c,g,d){var f=SVG.createImage64(b,h,e,a,c,d);
g.appendChild(f);return f;},createImage64:function(b,g,f,a,c,e){var d=document.createElementNS(this.svgns,"image");d.setAttribute("x",b);d.setAttribute("y",g);d.setAttribute("width",f);d.setAttribute("height",a);d.setAttribute("xlink:href",c);SVG._setProperties(d,e);return d;},createLine:function(d,f,c,e,b){var a=document.createElementNS(this.svgns,"line");
a.setAttribute("x1",d);a.setAttribute("y1",f);a.setAttribute("x2",c);a.setAttribute("y2",e);SVG._setProperties(a,b);return a;},createClip:function(d,a,b){var c=document.createElementNS(this.svgns,"clipPath");c.setAttribute("id",d);c.appendChild(a);return c;},drawClip:function(d,a,c){var b=SVG.createClip(d,a);
c.appendChild(b);return b;},drawRectangle:function(b,j,d,a,g,c){var f=null;try{f=SVG.createRectangle(b,j,d,a,c);g.appendChild(f);}catch(h){console.log("-------------------- ");console.log("Error on drawRectangle "+h);console.log(c);console.log("-------------------- ");}return f;},createEllipse:function(a,f,e,d,b){var c=document.createElementNS(this.svgns,"ellipse");
c.setAttribute("cx",a);c.setAttribute("cy",f);c.setAttribute("rx",e);c.setAttribute("ry",d);SVG._setProperties(c,b);return c;},drawEllipse:function(a,g,f,e,d,b){var c=SVG.createEllipse(a,g,f,e,b);d.appendChild(c);return c;},drawImage:function(a,e,d,b){var c=document.createElementNS(this.svgns,"image");
c.setAttribute("x",a);c.setAttribute("y",e);d.appendChild(c);SVG._setProperties(c,b);},drawLine:function(f,h,d,g,c,b){var a=null;try{a=SVG.createLine(f,h,d,g,b);c.appendChild(a);}catch(j){}return a;},drawPath:function(e,b,a){var c=SVG.createPath(e,a);b.appendChild(c);return c;},createPoligon:function(b,a){var c=document.createElementNS(this.svgns,"polygon");
c.setAttribute("points",b);SVG._setProperties(c,a);return c;},drawPoligon:function(b,d,a){var c=SVG.createPoligon(b,a);d.appendChild(c);return c;},createPath:function(c,a){var b=document.createElementNS(this.svgns,"path");b.setAttribute("d",c);SVG._setProperties(b,a);return b;},drawCircle:function(a,f,c,e,b){var d=document.createElementNS(this.svgns,"circle");
d.setAttribute("cx",a);d.setAttribute("cy",f);d.setAttribute("r",c);e.appendChild(d);this._setProperties(d,b);return d;},_setProperties:function(d,a){if(a instanceof Array){for(var c=0;c<a.length;c++){d.setAttribute(a[c][0],a[c][1]);}}else{for(var b in a){d.setAttribute(b,a[b]);}}},createText:function(a,f,e,b){var c=document.createElementNS(this.svgns,"text");
c.setAttributeNS(null,"x",a);c.setAttributeNS(null,"y",f);var d=document.createTextNode(e);c.appendChild(d);this._setProperties(c,b);return c;},drawText:function(b,f,e,d,c){var a=SVG.createText(b,f,e,c);d.appendChild(a);return a;},drawGroup:function(b,a){var c=SVG.createGroup(a);b.appendChild(c);return c;
},createGroup:function(a){var b=document.createElementNS(this.svgns,"g");this._setProperties(b,a);return b;}};var CanvasToSVG={convert:function(h,g,a,f,e,c){var b=this._convert(h,g,a,f,e);for(var d=0;d<c.length;d++){b.setAttribute(c[d][0],c[d][1]);}},_convert:function(e,c,h,g,b){var j="http://www.w3.org/2000/svg";
var a="http://www.w3.org/1999/xlink";var d=e.toDataURL();var f=document.createElementNS(j,"image");f.setAttribute("id",b);f.setAttributeNS(a,"xlink:href",d);f.setAttribute("x",h?h:0);f.setAttribute("y",g?g:0);f.setAttribute("width",e.width);f.setAttribute("height",e.height);f.imageData=d;c.appendChild(f);
return f;},importSVG:function(d,c){svg_xml=d;var a=c.getContext("2d");var b=new Image();b.src="data:image/svg+xml;base64,"+btoa(svg_xml);a.drawImage(b,0,0);}};var SHAPE=0;var SQUARE=1;var RECTANGLE=2;var ROUNDEDREC=3;var CIRCLE=4;var TRIANGLE=5;var PANEL=6;var TEXT=7;var LINE=9;var VERTICAL=0;var HORIZONTAL=1;
function Point(a,b){this.x=a;this.y=b;}Point.prototype.getDistance=function(a){var c=Math.pow(this.x-a.x,2);var b=Math.pow(this.y-a.y,2);return Math.sqrt(c+b);};function Shape(b,a){this.top=b;this.left=a;this.color="#000000";this.canvas=null;this.visible=true;this.type=SHAPE;this.borderColor="#000000";
this.borderWidth=0;}Shape.prototype.toString=function(){return this.type+": "+this.top+" "+this.left;};Shape.prototype.setBorderColor=function(a){this.borderColor=a;};Shape.prototype.setBorderWidth=function(a){this.borderWidth=a;};Shape.prototype.setColor=function(a){this.color=a;};Shape.prototype.render=function(a){this.canvas=a;
};Shape.prototype.setVisible=function(a){this.visible=a;};function Rectangle(d,c,a,b){Shape.call(this,d,c);this.width=b;this.height=a;this.type=RECTANGLE;}Rectangle.prototype=new Shape();Rectangle.prototype.constructor=Rectangle;Rectangle.prototype.render=function(a){if(!this.visible){return;}a.save();
a.lineWidth=2;a.strokeStyle="#000000";a.beginPath();a.moveTo(this.left,this.top);a.lineTo(this.left+this.width,this.top);a.lineTo(this.left+this.width,this.top+this.height);a.lineTo(this.left,this.top+this.height);a.closePath();a.stroke();a.fillStyle=this.color;a.fillRect(this.left,this.top,this.width,this.height);
a.restore();};Rectangle.prototype.remove=function(){this.canvas.clearRect(this.left,this.top,this.width,this.height);};Rectangle.prototype.contains=function(a,b){if(b>=this.left&&b<=this.width+this.left){if(a>=this.top&&a<=this.height+this.top){return true;}else{return false;}}else{return false;}};function RoundedRec(e,d,c,a,b){Rectangle.call(this,d,e,a,c);
this.radio=b;this.type=ROUNDEDREC;}RoundedRec.prototype=new Rectangle();RoundedRec.prototype.constructor=RoundedRec;RoundedRec.prototype.render=function(a){if(!this.visible){return;}a.save();a.fillStyle=this.color;a.beginPath();a.moveTo(this.left,this.top+this.radio);a.lineTo(this.left,this.top+this.height-this.radio);
a.quadraticCurveTo(this.left,this.top+this.height,this.left+this.radio,this.top+this.height);a.lineTo(this.left+this.width-this.radio,this.top+this.height);a.quadraticCurveTo(this.left+this.width,this.top+this.height,this.left+this.width,this.top+this.height-this.radio);a.lineTo(this.left+this.width,this.top+this.radio);
a.quadraticCurveTo(this.left+this.width,this.top,this.left+this.width-this.radio,this.top);a.lineTo(this.left+this.radio,this.top);a.quadraticCurveTo(this.left,this.top,this.left,this.top+this.radio);a.fill();if(this.borderWidth!=0){a.strokeStyle=this.borderColor;a.lineWidth=this.borderWidth;a.stroke();
}a.restore();};function Square(c,b,a){Shape.call(this,b,c);this.height=a;this.width=a;this.type=SQUARE;}Square.prototype=new Shape();Square.prototype.constructor=Square;Square.prototype.remove=function(){this.canvas.clearRect(this.top,this.left,this.width,this.height);};Square.prototype.render=function(a){Shape.prototype.render.call(this,a);
if(!this.visible){return;}a.save();a.fillStyle=this.color;a.fillRect(this.top,this.left,this.width,this.height);if(this.borderWidth!=0){a.strokeStyle=this.borderColor;a.lineWidth=this.borderWidth;a.strokeRect(this.top,this.left,this.width,this.height);}a.restore();};Square.prototype.contains=function(a,b){if(b>=this.left&&b<=this.width+this.left){if(a>=this.top&&a<=this.height+this.top){return true;
}else{return false;}}else{return false;}};function Circle(b,a,c){Shape.call(this,a,b);this.radio=c;this.type=CIRCLE;}Circle.prototype=new Shape();Circle.prototype.constructor=Circle;Circle.prototype.render=function(a){Shape.prototype.render.call(this,a);if(!this.visible){return;}a.save();a.beginPath();
a.fillStyle=this.color;a.arc(this.top+this.radio,this.left+this.radio,this.radio,0,Math.PI*2,true);if(this.borderWidth!=0){a.strokeStyle=this.borderColor;a.lineWidth=this.borderWidth;a.stroke();}a.closePath();a.fill();a.restore();};Circle.prototype.contains=function(b,d){var a=new Point(b,d);var c=a.getDistance(new Point(this.top+this.radio,this.left+this.radio));
if(c<=this.radio){return true;}else{return false;}};function Triangle(d,f,b,e,a,c){Shape.call(this,d,f);this.x1=d;this.y1=f;this.x2=b;this.y2=e;this.x3=a;this.y3=c;this.type=TRIANGLE;}Triangle.prototype=new Shape();Triangle.prototype.constructor=Triangle;Triangle.prototype.render=function(a){if(!this.visible){return;
}a.save();a.fillStyle=this.color;a.beginPath();a.moveTo(this.x1,this.y1);a.lineTo(this.x2,this.y2);a.lineTo(this.x3,this.y3);a.closePath();a.fill();if(this.borderWidth!=0){a.strokeStyle=this.borderColor;a.lineWidth=this.borderWidth;a.stroke();}a.restore();};Triangle.prototype.toString=function(){return this.type;
};Triangle.prototype.contains=function(a,b){return false;};function Text(b,a,c){Shape.call(this,a,b);this.text=c;this.type=TEXT;this.orientation=HORIZONTAL;}function Text(c,b,d,a){Shape.call(this,c,b);this.text=d;this.type=TEXT;this.orientation=a;}Text.prototype=new Shape();Text.prototype.constructor=Text;
Text.prototype.setFont=function(a){this.font=a;};Text.prototype.render=function(a){a.save();a.fillStyle=this.color;a.font=this.font;a.textBaseline="top";var b=a.measureText(this.text);if(this.orientation!=HORIZONTAL){a.rotate(-Math.PI/2);a.translate(-this.top,this.left);}else{}a.fillText(this.text,0,0);
a.restore();};function Line(b,a){Shape.call(this,b.x,b.y);this.point=a;this.type=LINE;this.color="#FFCCFF";}Line.prototype=new Shape();Line.prototype.constructor=Line;Line.prototype.remove=function(){this.canvas.clearRect(this.top,this.left,1,1);};Line.prototype.render=function(a){Shape.prototype.render.call(this,a);
a.save();a.fillStyle=this.color;a.beginPath();a.moveTo(this.left,this.top);a.lineTo(this.point.x,this.point.y);a.closePath();a.stroke();a.restore();};function Grid(f,e,a,c,b,d,g){this._top=f;this._left=e;this._height=a;this._width=c;this._svg=SVG.createSVGCanvas(d,[["id","meshSvgId_"+g],["height",a+260],["width",c+630]]);
this._canvas=b;this.model=new GridModel();this.gridView=new GridView(this._svg,b,g);this.controller=new GridController(this.model,this.gridView,this._svg,this._canvas,f,e,a,c,25,g);}Grid.prototype.refresh=function(){this.controller.setHeight((this.model.getRowNamesCount()*this.model.getSquareSize()));
this.controller.setWidth((this.model.getColumnNamesCount()*this.model.getSquareSize()));return this.controller.refresh();};Grid.prototype.getColumnNameSpace=function(){return this.controller._columnNameHeight;};Grid.prototype.setColumnNameSpace=function(a){this.controller.setColumnNameSpace(parseInt(a));
};Grid.prototype.getRowNameSpace=function(){return this.controller._rowNameWidth;};Grid.prototype.setRowNameSpace=function(a){this.controller.setRowNameSpace(parseInt(a));};Grid.prototype.getFontSize=function(){return this.gridView._fontSize;};Grid.prototype.setFontSize=function(a){this.gridView._fontSize=a;
};Grid.prototype.setWidth=function(a){this.controller.setWidth(parseInt(a));};Grid.prototype.getWidth=function(a){return this.controller.getWidth();};Grid.prototype.setHeight=function(a){this.controller.setHeight(parseInt(a));};Grid.prototype.getHeight=function(a){return this.controller.getHeight();};
Grid.prototype.fill=function(n,k,e,c,f,j,m,d,b,a,l,h,g){this.model.setRowsName(n);this.model.setColumnsName(k);this.model.setScores(c);this.model.setPositions(f);this.model.setData(e);this.model.setTitle(m);this.model.setAxisXName(d);this.model.setAxisYName(b);this.model.setSquareSize(a);this.model.setMinValue(l);
this.model.setMaxValue(h);this.model.setColorRangeManager(g);this.model.setImages(j);};Grid.prototype.loadImage=function(a){this.model.setBackgroundImage(a);this.controller.loadBackgroundImage();};Grid.prototype.unloadImage=function(){this.model.setBackgroundImage(null);this.controller.unloadBackgroundImage();
};function GridController(f,k,g,c,j,e,l,b,d,a){this._model=f;this._view=k;this._top=j;this._left=e;this._height=l;this._width=b;this.id=a;this._cellWidth=d;this._cellHeight=null;this._columnNameSpace=10;this._columnNameHeight=20;this._pixelPerCharacter=6;this._rowNameWidth=null;this._rowNameSpace=10;
this._spanCell=1;this._row_id_prefix=a+"_row_name_";this._row_name_class="NO_EVENT";this._columnName_id_prefix=a+"_columnName_";this._columnName_name_class="COLUMN";this._columnNameHeader_name_class="COLUMN_HEADER";this._title_id_prefix=a+"_title";this._title_name_class="NO_EVENT";this._column_id_prefix=a+"_column_";
this._column_name_class="COLUMN";var h=this;this._model.rowsNameAdded.attach(function(){h._cellHeight=h._height/h._model.getRowNamesCount();h.renderRowsName();});this._model.columnsNameAdded.attach(function(){h._cellWidth=h._width/h._model.getColumnNamesCount();h.renderColumnsName(0,h._model.getColumnNamesCount()-1);
});this._model.dataAdded.attach(function(){h._cellWidth=h._width/h._model.getColumnNamesCount();h._cellHeight=h._height/h._model.getRowNamesCount();h.renderGrid(0,h._model.getColumnNamesCount()-1);});this._view.mousedown.attach(function(){});this._view.refreshEvent.attach(function(){h.refresh();});this._view.moveColumnsEvent.attach(function(m){});
}GridController.prototype.setHeight=function(a){this._height=a;this.setCellSize();};GridController.prototype.setWidth=function(a){this._width=a;this.setCellSize();};GridController.prototype.getHeight=function(){return this._height;};GridController.prototype.getWidth=function(){return this._width;};GridController.prototype.setCellSize=function(){this._cellHeight=this._height/this._model.getRowNamesCount();
this._cellWidth=this._width/this._model.getColumnNamesCount();};GridController.prototype.getRelativeTop=function(){return 10;};GridController.prototype.setSpaceCell=function(a){this._spanCell=a;this.renderGrid(0,this._model.getColumnNamesCount()-1);};GridController.prototype.setRowNameSpace=function(a){this._rowNameWidth=a;
};GridController.prototype.setColumnNameSpace=function(a){this._columnNameSpace=a;};GridController.prototype._getCalculatedcolumnNameHeight=function(a){return this._getLengthColumnNames()*this._pixelPerCharacter;};GridController.prototype._getCalculatedAxisYNameSpace=function(a){return this._model.getAxisYName().length*this._pixelPerCharacter;
};GridController.prototype._getCalculatedTitleHeight=function(a){return this._pixelPerCharacter;};GridController.prototype._getCalculatedRowNameWidth=function(a){return this._getLengthRowNames()*this._pixelPerCharacter;};GridController.prototype._getMaxLengthArray=function(c){var a=0;for(var b=0;b<c.length;
b++){if(c[b]){if(a<c[b].length){a=c[b].length;}}}return a;};GridController.prototype._getLengthRowNames=function(){if(this._model.getRowNames()==null){return 5;}else{return this._getMaxLengthArray(this._model.getRowNames());}};GridController.prototype._getLengthColumnNames=function(){if(this._model.getColumnNames()==null){return 5;
}else{return this._getMaxLengthArray(this._model.getColumnNames());}};GridController.prototype._getLengthTitle=function(){return 6;};GridController.prototype.refresh=function(){this._view.clearRowsName();this._view.clearColumnsName();this._view.clearGrid(0,this._model.getColumnNamesCount()-1);this._view.clearTitle();
this._view.clearAxisYName();this._view.clearAxisXName();this._view.clearColorRange();this.unloadBackgroundImage();this.renderTitle();this.renderAxisYName();this.renderAxisXName();this.renderRowsName();this.renderColumnsName(0,this._model.getColumnNamesCount()-1);this.renderGrid(0,this._model.getColumnNamesCount()-1);
this.renderColorRange();this.loadBackgroundImage();};GridController.prototype.paint=function(){this.renderTitle();this.renderAxisYName();this.renderAxisXName();this.renderRowsName();this.renderColumnsName(0,this._model.getColumnNamesCount()-1);this.renderGrid(0,this._model.getColumnNamesCount()-1);this.renderColorRange();
};GridController.prototype.renderColorRange=function(){var b=this.getRelativeTop();var c=this._top+this._columnNameHeight+this._columnNameSpace+((this._model.getRowNamesCount()+1)*this._cellHeight)+b+this._getCalculatedTitleHeight()*5;var a=this._left+this._rowNameWidth+this._rowNameSpace+this._getCalculatedAxisYNameSpace()+this._cellHeight;
this._view.renderColorRanger(c,a,this._model.getMinValue(),this._model.getMaxValue(),this._model.getColorRangeManager(),10,10,this._column_id_prefix,this._column_name_class,this.id);};GridController.prototype.renderTitle=function(){var b=this.getRelativeTop();var c=this._top+this._columnNameSpace+b;var a=this._left+this._rowNameWidth+this._rowNameSpace;
this._view.renderTitle(c,a,this._model.getTitle(),this._title_id_prefix,this._title_name_class);};GridController.prototype.renderAxisYName=function(){var b=this.getRelativeTop();if(this._columnNameHeight==null){this._columnNameHeight=this._getCalculatedcolumnNameHeight();}var c=this._top+this._columnNameHeight+this._columnNameSpace+this.getRelativeTop()+(this._model.getRowNamesCount()*this._cellHeight)/2+this._getCalculatedTitleHeight();
var a=this._left;this._view.renderAxisYName(c,a,this._model.getAxisYName(),this.id+"_axisYName",this._row_name_class);};GridController.prototype.renderAxisXName=function(){var b=this.getRelativeTop();if(this._columnNameHeight==null){this._columnNameHeight=this._getCalculatedcolumnNameHeight();}var c=this._top+this._columnNameHeight+this._columnNameSpace+((this._model.getRowNamesCount()+1)*this._cellHeight)+b+this._getCalculatedTitleHeight()*3;
var a=this._left+this._rowNameWidth+this._rowNameSpace+this._getCalculatedAxisYNameSpace()+(this._model.getRowNamesCount()*this._cellHeight)/3;this._view.renderAxisYName(c,a,this._model.getAxisXName(),this.id+"_axisXName",this._row_name_class);};GridController.prototype.renderRowsName=function(){if(this._columnNameHeight==null){this._columnNameHeight=this._getCalculatedcolumnNameHeight();
}var b=this.getRelativeTop();var c=this._top+this._columnNameSpace+this._columnNameHeight+this._cellHeight/2+b+this._getCalculatedTitleHeight();var a=this._left+this._getCalculatedAxisYNameSpace()+this._cellHeight/2;this._view.renderRowNames(c,a,this._cellHeight,this._model.getRowNames(),this._row_id_prefix,this._row_name_class);
};GridController.prototype.renderColumnsName=function(d,c){if(this._rowNameWidth==null){this._rowNameWidth=this._getCalculatedRowNameWidth();}var f=this._left+this._rowNameWidth+this._rowNameSpace+this._cellWidth/2+this._getCalculatedAxisYNameSpace()+(this._cellHeight/2);if(this._columnNameHeight==null){this._columnNameHeight=this._getCalculatedcolumnNameHeight();
}var e=this._top+this.getRelativeTop()+this._columnNameSpace+this._columnNameHeight+this._getCalculatedTitleHeight()+((this._model.getRowNamesCount())*this._cellHeight)+this._getCalculatedTitleHeight();this._view.renderColumnNames(e,f,d,c,this._cellWidth,this._model.getColumnNames(),this._columnName_id_prefix,this._columnNameHeader_name_class);
};GridController.prototype.renderGrid=function(d,c){if(this._rowNameWidth==null){this._rowNameWidth=this._getCalculatedRowNameWidth();}var f=this._left+this._rowNameWidth+this._rowNameSpace+this._getCalculatedAxisYNameSpace()+this._cellHeight;if(this._columnNameHeight==null){this._columnNameHeight=this._getCalculatedcolumnNameHeight();
}var e=this._top+this._columnNameHeight+this._columnNameSpace+this.getRelativeTop()+this._getCalculatedTitleHeight();this._view.renderGrid(e,f,d,c,this._cellWidth,this._cellHeight,this._spanCell,this._column_id_prefix,this._column_name_class,this._model.getData(),this._model.getScores(),this._model.getPositions(),this._model.getImages());
};GridController.prototype.loadBackgroundImage=function(){if(this._rowNameWidth==null){this._rowNameWidth=this._getCalculatedRowNameWidth();}var b=this._left+this._rowNameWidth+this._rowNameSpace+this._getCalculatedAxisYNameSpace();var a=this._top+this._columnNameHeight+this._columnNameSpace+this.getRelativeTop()+this._getCalculatedTitleHeight();
this._view.loadBackgroundImage(this._model.getBackgroundImage(),a,b);};GridController.prototype.unloadBackgroundImage=function(){this._view.clearBackgroundImage();};function GridModel(){this._rows=null;this._columns=null;this._data=null;this._rowNames=null;this._columnNames=null;this.rowsNameAdded=new Event(this);
this.columnsNameAdded=new Event(this);this.dataAdded=new Event(this);this._scores=null;this._images=null;this._positions=null;this._title=null;this._axisXName=null;this._axisYName=null;this._squareSize=null;this._minValue=null;this._maxValue=null;this._colorRangeManager=null;this._backgroundImage=null;
}GridModel.prototype.setBackgroundImage=function(a){this._backgroundImage=a;};GridModel.prototype.getBackgroundImage=function(){return this._backgroundImage;};GridModel.prototype.setScores=function(a){this._scores=a;};GridModel.prototype.getScores=function(){return this._scores;};GridModel.prototype.setImages=function(a){this._images=a;
};GridModel.prototype.getImages=function(){return this._images;};GridModel.prototype.setPositions=function(a){this._positions=a;};GridModel.prototype.getPositions=function(){return this._positions;};GridModel.prototype.setColumnsName=function(a){this._columnNames=a;};GridModel.prototype.getColumnNames=function(){return this._columnNames;
};GridModel.prototype.getColumnNamesCount=function(){return this._columnNames.length;};GridModel.prototype.setRowsName=function(a){this._rowNames=a;};GridModel.prototype.getRowNames=function(){return this._rowNames;};GridModel.prototype.getRowNamesCount=function(){return this._rowNames.length;};GridModel.prototype.setTitle=function(a){this._title=a;
};GridModel.prototype.getTitle=function(){return this._title;};GridModel.prototype.setAxisXName=function(a){this._axisXName=a;};GridModel.prototype.getAxisXName=function(){return this._axisXName;};GridModel.prototype.setAxisYName=function(a){this._axisYName=a;};GridModel.prototype.getAxisYName=function(){return this._axisYName;
};GridModel.prototype.setSquareSize=function(a){this._squareSize=a;};GridModel.prototype.getSquareSize=function(){return this._squareSize;};GridModel.prototype.setMinValue=function(a){this._minValue=a;};GridModel.prototype.getMinValue=function(){return this._minValue;};GridModel.prototype.setMaxValue=function(a){this._maxValue=a;
};GridModel.prototype.getMaxValue=function(){return this._maxValue;};GridModel.prototype.setColorRangeManager=function(a){this._colorRangeManager=a;};GridModel.prototype.getColorRangeManager=function(){return this._colorRangeManager;};GridModel.prototype.render=function(){this.rowsNameAdded.notify({item:this._rowNames});
this.columnsNameAdded.notify({item:this._columnNames});this.dataAdded.notify(this._data);};GridModel.prototype.setData=function(a){this._data=a;this._rows=this._data.length;this._columns=0;if(this._data[0]){this._columns=this._data[0].length;}};GridModel.prototype.getData=function(){return this._data;
};GridModel.prototype.copy=function(d,c){for(var e=0;e<this.getRowNamesCount();e++){this._data[e][c]=this._data[e][d];}};GridModel.prototype.move=function(d,c){var j=[];var g=this._columnNames[c];var h=this._columnNames[d];if(c>d){for(var e=0;e<this.getRowNamesCount();e++){j.push(this._data[e][d]);}for(var e=d;
e<=c;e++){var f=parseInt(e)+1;this.copy(f,e);this._columnNames[e]=this._columnNames[f];}for(var e=0;e<this.getRowNamesCount();e++){this._data[e][c]=j[e];this._columnNames[c]=g;}this._columnNames[c]=h;}else{for(var e=0;e<this.getRowNamesCount();e++){j.push(this._data[e][d]);}for(var e=d;e>c;e--){this.copy(e-1,e);
this._columnNames[e]=this._columnNames[e-1];}for(var e=0;e<this.getRowNamesCount();e++){this._data[e][c]=j[e];}this._columnNames[c]=h;}};function GridView(a,b,d){this._svg=a;this._canvas=b;this.id=d;this._fontSize=9;this._fontTitleSize=12;this.cellInfo=true;this.columnName_id_prefix=null;this.columnName_name_class=null;
this.columnHeaderName_name_class=null;this.column_id_prefix=null;this.column_class=null;this.rowName_id_prefix=null;this.rowName_name_class=null;this.title="";this.axisXName="";this.axisYName="";this.rowNames=null;this.columnNames=null;this.rowsName=null;this.data=null;this.scores=null;this.positions=null;
this.images=null;this.columnConfiguration=null;this.enableDraggin=true;this.draggin=false;this.originColumnX=null;this.originColumnID=null;this.columnIndex=[];this.columnPosX=[];this.cellZoomId=d+"_cellZoom";this.enableMovingGrid=true;this.dragginGrid=false;this.movingGridPrevX=null;this.movingGridcurrentX=null;
this.gridOffset=0;this.previousGridOffset=0;this.prevMouse=null;this.dragTarget=null;this.left=null;this.topGrid=null;this.cellWidth=null;var c=this;this.mousedown=new Event(this);this.moveColumnsEvent=new Event(this);this.refreshEvent=new Event(this);this.cellSelected=new Event(this);this._svg.addEventListener("mousedown",function(e){c.onmousedown(e,c);
},false);this._svg.addEventListener("mousemove",function(e){c.onmousemove(e,c);},false);this._svg.addEventListener("mouseup",function(e){c.onmouseup(e,c);},false);this.columnNamesXpos=[];this.lastColumnNameHeaderSelected=null;this.lastRowNameHeaderSelected=null;this.rowSelected=null;this.columnSelected=null;
}GridView.prototype.setFontSize=function(a){this._fontSize=a;this.refreshEvent.notify();};GridView.prototype.checkRangeForMovingColumns=function(a){return((a<this.columnNames.length)&&(a>=0));};GridView.prototype.doOverEffect=function(a,b){};GridView.prototype.recolocateColumns=function(){for(var a=0;
a<this.columnIndex.length;a++){document.getElementById(this.columnIndex[a]).setAttribute("x",this.columnPosX[a]);document.getElementById(this.columnIndex[a]).setAttributeNS(null,"transform","translate("+this.gridOffset+")");}};GridView.prototype.moveClientSideColumnNames=function(d,e){var a=this.columnIndex[d];
var b=this.columnNames[d];if(d<e){for(var c=parseInt(parseInt(d)+parseInt(1));parseInt(e)>=c;c++){this.columnIndex[(c-1)]=this.columnIndex[c];this.columnNames[(c-1)]=this.columnNames[c];}}if(d>e){for(var c=parseInt(parseInt(d));parseInt(e)<c;c--){this.columnIndex[(c)]=this.columnIndex[(c-1)];this.columnNames[(c)]=this.columnNames[(c-1)];
}}this.columnIndex[e]=a;this.columnNames[e]=b;this.recolocateColumns();};GridView.prototype.moveHorizontaleColumns=function(b){this.gridOffset=b+this.previousGridOffset;for(var a=0;a<this.columnIndex.length;a++){document.getElementById(this.columnIndex[a]).setAttributeNS(null,"transform","translate("+parseInt(b+this.previousGridOffset)+")");
document.getElementById(this.columnName_id_prefix+a).setAttributeNS(null,"transform","translate("+parseInt(b+this.previousGridOffset)+")");if(document.getElementById("LINE_"+a)!=null){document.getElementById(this.id_dom_prefix_class+a).setAttributeNS(null,"transform","translate("+parseInt(b+this.previousGridOffset)+")");
document.getElementById("LINE_"+a).setAttributeNS(null,"transform","translate("+parseInt(b+this.previousGridOffset)+")");}}this.clearColumnsName();this.renderClientSideColumnNames(this.columnConfiguration);try{this.renderClassesName();}catch(c){}};GridView.prototype.moveHorizontalGrid=function(a){this.moveHorizontaleColumns(a);
};GridView.prototype.drawCellInfoDiv=function(g,e,c){var b=getMouseCoords(c,this._svg);this.rowSelected=g;this.columnSelected=e;if((g<0)||(e<0)||(g>this.rowNames.length)||(e>this.columnNames.length)){this.removeCellInfoDiv();return;}if(this.columnIndex[e]==null){return;}var h="";if(this.images!=null){h="imageDownload.do?reqCode=getImageJpgThumb&imageId="+this.images[g][this.columnIndex[e].replace(this.column_id_prefix,"")];
}var f="";var d="";if(this.scores!=null){d="Position: "+this.positions[g][this.columnIndex[e].replace(this.column_id_prefix,"")];f="Value = "+this.scores[g][this.columnIndex[e].replace(this.column_id_prefix,"")];}var a=this.data[g][this.columnIndex[e].replace(this.column_id_prefix,"")];this.drawCellInfoSVG(b.x+10,b.y+10,this._svg,h,f,d,a);
this.doOverEffect(e,g);};GridView.prototype.drawCellInfoSVG=function(n,m,p,k,h,f,t){var g=SVG.createGroup([["id",this.cellZoomId]]);var r=[["fill-opacity","0.85"],["fill","white"],["stroke","black"],["rx",5],["ry",5]];var a=SVG.createRectangle(n,m,350,210,r);var q=20;var d=n+10;var c=m+25;var b=[["fill-opacity","1"],["x",d],["y",c],["stroke","black"],["fill",t]];
var e=SVG.createRectangle(d,c,12,12,b);var s=[["font-size","12"]];var o="http://www.w3.org/2000/svg";var v=document.createElementNS(o,"image");v.setAttributeNS(null,"x",n+30);v.setAttributeNS(null,"y",m+(q*3));v.setAttributeNS(null,"height",125);v.setAttributeNS(null,"width",125);var u="http://www.w3.org/1999/xlink";
v.setAttributeNS(u,"xlink:href",k);s=[["font-size","12"]];var l=SVG.createText(n+30,m+(q*1),h,s);s=[["font-size","12"]];var j=SVG.createText(n+30,m+(q*2),f,s);g.appendChild(a);g.appendChild(e);g.appendChild(l);g.appendChild(j);g.appendChild(v);p.appendChild(g);};GridView.prototype.removeCellInfoDiv=function(){var a=document.getElementById(this.cellZoomId);
if(a!=null){this._svg.removeChild(a);}};GridView.prototype.onmousemove=function(h,a){var c=getMouseCoords(h,this._svg);var g=this.getRowOver(h);var f=this.getColumnOver(h);if(this.data!=null){if(this.cellInfo){this.removeCellInfoDiv();if(g<this.rowNames.length){this.drawCellInfoDiv(g,f,h);}}}if(this.dragginGrid&&this.enableMovingGrid){this.movingGridcurrentX=c.x;
this.gridOffset=this.movingGridcurrentX-this.movingGridPrevX+this.previousGridOffset;this.moveHorizontalGrid(this.movingGridcurrentX-this.movingGridPrevX);}if(this.draggin&&this.enableDraggin){switch(this.dragTarget.className.animVal){case this.columnName_name_class:var j=(this.dragTarget.id.replace(this.column_id_prefix,""));
if(this.checkRangeForMovingColumns(this.selectedColumn,f)){this.dragTarget._translateX+=c.x-this.prevMouse.x;var d=(c.x-this.prevMouse.x);var b="translate("+d+", "+65+")";document.getElementById(this.column_id_prefix+j).setAttributeNS(null,"transform","translate("+this.offsetGrid+")");document.getElementById(this.column_id_prefix+j).setAttributeNS(null,"x",(c.x-this.cellWidth/2));
this.doOverEffect(f,g);}break;default:break;}}};GridView.prototype.movingOpacity=function(c){var a=this.dragTarget.id.replace(this.column_id_prefix,"");document.getElementById(this.columnName_id_prefix+a).setAttributeNS(null,"opacity","1");document.getElementById(this.columnName_id_prefix+c).setAttributeNS(null,"opacity","1");
try{document.getElementById(this.columnName_id_prefix+parseInt(c-1)).setAttributeNS(null,"opacity","0.5");document.getElementById(this.columnName_id_prefix+parseInt(c+1)).setAttributeNS(null,"opacity","0.5");}catch(b){}};GridView.prototype.removeOpacity=function(){for(var a=0;a<this.columnNames.length;
a++){document.getElementById(this.column_id_prefix+a).setAttributeNS(null,"opacity","1");}};GridView.prototype.doOpacity=function(){var b=this.dragTarget.id.replace(this.column_id_prefix,"");if(this.columnNames==null){return;}for(var a=0;a<this.columnNames.length;a++){if(a!=b){document.getElementById(this.column_id_prefix+a).setAttributeNS(null,"opacity","0.5");
}}};GridView.prototype.getIndexColumnID=function(b){for(var a=0;a<this.columnIndex.length;a++){if(this.columnIndex[a]==b){return a;}}};GridView.prototype.onmousedown=function(b,a){this.moveColumnsEvent.notify();};GridView.prototype.onmouseup=function(f,a){var b=getMouseCoords(f,this._svg);var d=this.getRowOver(f);
var c=this.getColumnOver(f);if(this.data!=null){if(d<this.rowNames.length){this.clickOnCellGrid(d,c,f);}}};GridView.prototype.clickOnCellGrid=function(d,c,b){this.rowSelected=d;this.columnSelected=c;if((d<0)||(c<0)||(d>this.rowNames.length)||(c>this.columnNames.length)){return;}if(this.columnIndex[c]==null){return;
}var a=this.images[d][this.columnIndex[c].replace(this.column_id_prefix,"")];window.location.href="viewResults.do?reqCode=viewJpegImage&imageId="+a;};GridView.prototype.moveOnTop=function(a){this._svg.appendChild(a);};GridView.prototype.getRowOver=function(b){var a=getMouseCoords(b,this._svg);return Math.floor(((a.y-this.topGrid)/this.cellHeight));
};GridView.prototype.getColumnOver=function(b){var a=getMouseCoords(b,this._svg);return Math.floor(((a.x-this.left-this.gridOffset)/this.cellWidth));};GridView.prototype.clearCanvas=function(){this.clearRowsName();this.clearColumnsName();this.clearTitle();this.clearColorRange();this.clearAxisYName();
this.clearAxisXName();};GridView.prototype.clearGrid=function(e,d){if(e>d){var c=e;e=d;d=c;}for(var g=e;g<=d;g++){var f=document.getElementById(this.column_id_prefix+g);if(f!=null){this._svg.removeChild(f);}f=document.getElementById(this.columnName_id_prefix+g);if(f!=null){this._svg.removeChild(f);}f=document.getElementById(this.row_id_prefix+g);
if(f!=null){this._svg.removeChild(f);}f=document.getElementById(this.rowName_id_prefix+g);if(f!=null){this._svg.removeChild(f);}}};GridView.prototype.clearColumnsName=function(){var c=this._svg.getElementsByTagName(this.id+"_text");for(var b=0;b<this.columnNames.length;b++){for(var a=0;a<c.length;a++){if(c[a].id==this.columnName_id_prefix+b){this._svg.removeChild(c[a]);
}}}};GridView.prototype.clearRowsName=function(){var c=this._svg.getElementsByTagName(this.id+"_text");for(var b=0;b<this.rowNames.length;b++){for(var a=0;a<c.length;a++){if(c[a].id==this.rowName_id_prefix+b){this._svg.removeChild(c[a]);}}}};GridView.prototype.clearTitle=function(){var a=document.getElementById(this.id+"_title");
if(a!=null){this._svg.removeChild(a);}};GridView.prototype.clearAxisXName=function(){var a=document.getElementById(this.id+"_axisXName");if(a!=null){this._svg.removeChild(a);}};GridView.prototype.clearAxisYName=function(){var a=document.getElementById(this.id+"_axisYName");if(a!=null){this._svg.removeChild(a);
}};GridView.prototype.clearColorRange=function(){var b=document.getElementById(this.id+"_minValue");if(b!=null){this._svg.removeChild(b);}b=document.getElementById(this.id+"_maxValue");if(b!=null){this._svg.removeChild(b);}var a=0;b=document.getElementById(this.id+"_rect_"+a);while(b!=null){this._svg.removeChild(b);
a++;b=document.getElementById(this.id+"_rect_"+a);}};GridView.prototype.clearBackgroundImage=function(){var a=document.getElementById("backgroundImage");if(a!=null){this._svg.removeChild(a);}};GridView.prototype.renderColorRanger=function(p,c,q,m,l,d,n,h,b,a){var k=l.getLen();var f="http://www.w3.org/2000/svg";
var g=[["id",a+"_minValue"],["class",b],["fill","#000000"],["font-size",this._fontTitleSize+"px"]];SVG.drawText(c,p,q,this._svg,g);for(var j=0;j<k;j++){var e=l.getColorRange(j);var o=document.createElementNS(f,"rect");o.setAttributeNS(null,"x",c+j*d);o.setAttributeNS(null,"y",p);o.setAttributeNS(null,"height",d);
o.setAttributeNS(null,"width",n);o.setAttributeNS(null,"fill",e);o.setAttributeNS(null,"id",a+"_rect_"+j);this._svg.appendChild(o);}g=[["id",a+"_maxValue"],["class",b],["fill","#000000"],["font-size",this._fontTitleSize+"px"]];SVG.drawText(c+(k)*d,p,m,this._svg,g);};GridView.prototype.renderTitle=function(d,c,f,e,b){this.title=f;
this.topGrid=d;var a=[["id",e],["class",b],["fill","#000000"],["id",e],["font-size",this._fontTitleSize+"px"]];SVG.drawText(c+100,d,f,this._svg,a);};GridView.prototype.renderAxisYName=function(e,d,a,f,c){this.axisYName=a;var b=[["id",f],["class",c],["fill","#000000"],["id",f],["font-size",this._fontSize+"px"]];
SVG.drawText(d,e,a,this._svg,b);};GridView.prototype.renderAxisXName=function(e,d,b,f,c){this.axisXName=b;var a=[["id",f],["class",c],["fill","#000000"],["id",f],["font-size",this._fontSize+"px"]];SVG.drawText(d,e,b,this._svg,a);};GridView.prototype.renderRowNames=function(g,f,a,d,h,e){this.rowNames=d;
this.rowName_id_prefix=h;this.rowName_name_class=e;for(var c=0;c<d.length;c++){var b=[["id",h+c],["class",e],["fill","#000000"],["font-size",this._fontSize+"px"]];SVG.drawText(f,a*c+g+(a/2),d[c],this._svg,b);}};GridView.prototype.renderClientSideColumnNames=function(a){this.renderColumnNames(a.top,a.left,a.a,a.b,a.cellWidth,this.columnNames,a.dom_id_prefix,a.dom_name_class);
};GridView.prototype.renderColumnNames=function(k,d,n,l,e,j,h,m){this.columnConfiguration=new ColumnConfiguration(k,d,n,l,e,j,h,m);if(n>l){var c=n;n=l;l=c;}this.left=d;this.columnNames=j;this.columnName_id_prefix=h;this.columnHeaderName_name_class=m;for(var g=n;g<=l;g++){var f=[["transform","rotate(-45, "+parseInt(d+g*e+(e/2))+","+parseInt(k)+"), translate(0,"+this.gridOffset+")"],["id",h+g],["class",m],["cursor","move"],["fill","#000000"],["id",h+g],["font-size",this._fontSize+"px"]];
SVG.drawText(d+(g-1)*e+(e/2),k,j[g],this._svg,f);}};GridView.prototype.renderGrid=function(n,d,p,o,e,m,g,h,c,k,f,j,l){this.cellWidth=e;this.cellHeight=m;this.data=k;this.scores=f;this.images=l;this.positions=j;this.column_id_prefix=h;this.column_class=c;this._canvas.width=e+1;this._canvas.height=m*this.data.length;
this.topGrid=n;this.renderMatrixGridByCanvas(n,d,p,o,e,m,g,h,c,k);};GridView.prototype.renderMatrixGridByCanvas=function(o,e,r,p,f,n,h,k,c,m){this.column_id_prefix=k;this.columnName_name_class=c;if(r>p){var d=r;r=p;p=d;}this._canvas.height=this._canvas.height+1;for(var g=r;g<=p;g++){this._canvas.width=this._canvas.width;
for(var l=0;l<this.data.length;l++){this._canvas.getContext("2d").shadowOffsetX=1;this._canvas.getContext("2d").shadowOffsetY=1;this._canvas.getContext("2d").shadowBlur=0;var q=new Rectangle(n*l+1,1,n-h,f-h);q.setColor(m[l][g]);q.render(this._canvas.getContext("2d"));}this.columnIndex.push(k+g);this.columnPosX.push((e+g*f));
CanvasToSVG.convert(this._canvas,this._svg,(e+g*f),o+1,k+g,[["cursor","pointer"],["class",c]]);}this._canvas.width=0;this._canvas.height=0;};GridView.prototype.renderMatrixGridBySVG=function(p,e,r,q,f,o,h,k,c,n){if(r>q){var d=r;r=q;q=d;}var m=0;for(var g=r;g<=q;g++){this._canvas.width=this._canvas.width;
for(var l=0;l<this.data.length;l++){h=0;SVG.drawRectangle(e+g*f,o*l+p,n[l][g],o-h,f-h,1,k+g,c,this._svg);m++;}}this._canvas.width=0;this._canvas.height=0;};GridView.prototype.loadBackgroundImage=function(d,c,b){if(d){var a=document.createElementNS("http://www.w3.org/2000/svg","image");a.setAttributeNS(null,"height","197");
a.setAttributeNS(null,"width","316");a.setAttributeNS("http://www.w3.org/1999/xlink","href",d);a.setAttributeNS(null,"x",b);a.setAttributeNS(null,"y",c);a.setAttributeNS(null,"visibility","visible");a.setAttributeNS(null,"id","backgroundImage");a.setAttributeNS(null,"opacity",0.5);this._svg.appendChild(a);
}};function ColumnConfiguration(h,g,d,c,e,k,j,f){this.top=h;this.left=g;this.a=d;this.b=c;this.cellWidth=e;this.columnNames=k;this.dom_id_prefix=j;this.dom_name_class=f;}function getMouseCoords(g,c){var a,h;muna=c;if(document.getBoxObjectFor){var d=document.getBoxObjectFor(c);a=g.pageX-d.x;h=g.pageY-d.y;
}else{if(c.getBoundingClientRect){var f=c.createSVGPoint();f.x=g.clientX;f.y=g.clientY;var b=f.matrixTransform(c.getScreenCTM().inverse());a=b.x;h=b.y;}else{a=g.pageX-(c.offsetLeft||0);h=g.pageY-(c.offsetTop||0);}}return{x:a,y:h};}function MapPanel(a){var b=this;this.width=1350;this.height=500;this.mapTitle="Map title";
this.minValue=0;this.maxValue=1000;this.cellWidthValue=30;this.id=0;this.grid=null;this.snapshot=null;this.axisXName=null;this.axisYName=null;this.stepX=0.05;this.stepY=0.05;this.nbDecX=this.getNbDec(""+this.stepX);this.nbDecY=this.getNbDec(""+this.stepY);this.axisXName="GridIndexY";this.axisYName="GridIndexZ";
this.colorRangeManager=null;this.data=null;this.positions=null;this.images=null;this.meshValues=null;this.scaleDataX=null;this.scaleDataY=null;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}Ext.define("CriteriaPlotModel",{extend:"Ext.data.Model",fields:[{type:"string",name:"id"},{type:"string",name:"name"}]});
}MapPanel.prototype.getNbDec=function(b){var a=b.indexOf(".")+1;return b.length-a;};MapPanel.prototype.getValue=function(a,b){if(a){return(a).toFixed(b);}else{return null;}};MapPanel.prototype.getValueRound=function(b,d,a){var c=this.getValue(b,d);var e=1/(a*2);return(Math.floor((c*e))/e);};MapPanel.prototype.getScaleDataX=function(c){if(c.length>0){var b=c[0].motorPosition.gridIndexY;
var f=b;var a=b;for(var e=1;e<c.length;e++){b=c[e].motorPosition.gridIndexY;if(b<f){f=b;}else{if(b>a){a=b;}}}var g=[];var d=0;if(f){d=f;}while(d<a){g.push(d);d=Number(d)+1;}if(a){g.push(a);}else{g.push(0);}return g;}return[];};MapPanel.prototype.getScaleDataY=function(b){if(b.length>0){var g=b[0].motorPosition.gridIndexZ;
var e=g;var a=g;for(var d=1;d<b.length;d++){g=b[d].motorPosition.gridIndexZ;if(g<e){e=g;}else{if(g>a){a=g;}}}var f=[];var c=0;if(e){c=e;}while(c<a){f.push(c);c=Number(c)+1;}if(a){f.push(a);}else{f.push(0);}return f;}return[];};MapPanel.prototype.getValueForCriteria=function(a,b){if(b=="totalSpots"){return a.spotTotal;
}else{if(b=="goodBraggCandidates"){return a.goodBraggCandidates;}else{if(b=="method1Res"){return a.method1Res;}else{if(b=="method2Res"){return a.method2Res;}else{if(b=="totalIntegratedSignal"){return a.totalIntegratedSignal;}else{if(b=="dozor_score"){return a.dozor_score;}}}}}}};MapPanel.prototype.buildDataCriteria=function(g){var e=this.meshValues.length;
this.data=new Array(e);for(var b=0;b<e;b++){var c=this.meshValues[b].length;this.data[b]=new Array(c);for(var a=0;a<c;a++){var f=this.meshValues[b][a];this.data[b][a]=this.getValueForCriteria(f,g);}}};MapPanel.prototype.buildData=function(a){this.meshValues=[];if(a){if(a.gridInfo&&a.gridInfo.steps_x){this.stepX=a.gridInfo.steps_x;
this.nbDecX=this.getNbDec(""+this.stepX);}if(a.gridInfo&&a.gridInfo.steps_y){this.stepY=a.gridInfo.steps_y;this.nbDecY=this.getNbDec(""+this.stepY);}this.scaleDataX=this.getScaleDataX(a);this.scaleDataY=this.getScaleDataY(a);var o=this.scaleDataX.length;var m=this.scaleDataY.length;this.meshValues=new Array(m);
this.positions=new Array(m);this.images=new Array(m);for(var c=0;c<m;c++){this.meshValues[c]=new Array(o);this.positions[c]=new Array(o);this.images[c]=new Array(o);for(var b=0;b<o;b++){this.meshValues[c][b]=this.getDefaultMeshData();this.positions[c][b]="Unknown";this.positions[c][b]="";}}for(var c=0;
c<a.length;c++){var g=a[c];var l=g.motorPosition.gridIndexY;var k=g.motorPosition.gridIndexZ;var h=this.getCoordPos(l,k);this.meshValues[h[0]][h[1]]=g;var n="";if(g.motorPosition.phiY){n=g.motorPosition.phiY.toFixed(3);}var e="";if(g.motorPosition.sampY){e=g.motorPosition.sampY.toFixed(3);}var f="";if(g.motorPosition.sampX){f=g.motorPosition.sampX.toFixed(3);
}this.positions[h[0]][h[1]]="phiY="+n+" sampX="+f+" sampY="+e;this.images[h[0]][h[1]]=g.imageId;}this.buildDataCriteria("dozor_score");}};MapPanel.prototype.getDefaultMeshData=function(){var a=[];a.dataCollectionId=-1;a.imageId=-1;a.imageQualityIndicatorsId=-1;a.imageFileLocation="";a.imageFilePresent=false;
a.imagePrefix="";a.dataCollectionNumber=0;a.motorPosition=[];a.motorPosition.phiX=0;a.motorPosition.phiY=0;a.motorPosition.phiZ=0;a.motorPosition.sampX=0;a.motorPosition.sampY=0;a.motorPosition.omega=0;a.motorPosition.kappa=0;a.motorPosition.phi=0;a.motorPosition.gridIndexY=0;a.motorPosition.gridIndexZ=0;
a.gridInfo=[];a.gridInfo.xOffset=0;a.gridInfo.yOffset=0;a.gridInfo.dx_mm=0;a.gridInfo.dy_mm=0;a.gridInfo.steps_x=0;a.gridInfo.steps_y=0;a.gridInfo.meshAngle=0;a.spotTotal=0;a.goodBraggCandidates=0;a.method1Res=0;a.method2Res=0;a.totalIntegratedSignal=0;a.dozor_score=0;return a;};MapPanel.prototype.getCoordPos=function(a,g){var f=new Array(2);
var e=this.scaleDataX.length;var d=this.scaleDataY.length;var c=0;while(a>this.scaleDataX[c]&&c<e){c++;}var b=0;while(g>this.scaleDataY[b]&&b<d){b++;}f[0]=b<d?b:(d-1);f[1]=c<e?c:(e-1);return f;};MapPanel.prototype.saveSettings=function(a){var b=this;this.mapTitle=a.mapTitle;this.maxValue=a.maxValue;this.minValue=a.minValue;
};MapPanel.prototype._refresh=function(){var a=this._getDataRange();this.colorRangeManager.loadData(a,this.reverseOrder);this.refresh(this.data,this.positions,this.images,this.scaleDataX,this.scaleDataY,this.colorRangeManager,this.mapTitle,this.axisXName,this.axisYName,this.cellWidthValue);};MapPanel.prototype.sliderChange=function(){this.cellWidthValue=this.slider.getSliderValue();
this._refresh();};MapPanel.prototype.getPanel=function(e,b,d){var m=this;m.id=d;this.snapshot=b;this.colorRangeManager=new ColorRangeManager();this.buildData(e);this.maxValue=this._calculateMaxValue();var n=m._getDataRange();this.colorRangeManager.loadData(n,this.reverseOrder);this.slider=new SliderWidget("slider");
this.slider.sliderChange.attach(function(){m.sliderChange();});var f=function(r){if(r.id==m.id+"_settingsBtn"){var q=new MapSettingsWindow();q.onSaved.attach(function(s,u,v,t){m.saveSettings(u,v,t);m._refresh();});q.draw(m.mapTitle,m.maxValue,m.minValue);return;}if(r.id==m.id+"_saveAsImageBtn"){m.saveAsImage();
return;}if(r.id==m.id+"_loadImgBtn"){m.loadImage();return;}if(r.id==m.id+"_unloadImgBtn"){m.unloadImage();return;}return alert("not yet implemented");};var l=(b&&b.filePresent);var j=new Ext.Button({id:m.id+"_saveAsImageBtn",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:f});var g=new Ext.Button({id:m.id+"_loadImgBtn",text:"",disabled:!l,tooltip:"Load the crystal image",icon:"../images/image_add.png",handler:f});
var h=new Ext.Button({id:m.id+"_unloadImgBtn",text:"",disabled:!l,tooltip:"Unload the crystal image",icon:"../images/image_remove.png",handler:f});var a=new Ext.Button({id:m.id+"_settingsBtn",text:"",tooltip:"map settings...",icon:"../images/cog.png",handler:f});var o=[{"id":"dozor_score","name":"Dozor Score"},{"id":"totalIntegratedSignal","name":"Total Integrated Signal"},{"id":"goodBraggCandidates","name":"Good bragg candidates"},{"id":"totalSpots","name":"Total Spots"},{"id":"method1Res","name":"Method 1 resolution"},{"id":"method2Res","name":"Method 2 resolution"}];
var k=Ext.create("Ext.data.Store",{autoDestroy:true,model:"CriteriaPlotModel",data:o});var p=Ext.create("Ext.form.field.ComboBox",{fieldLabel:"Select Criteria for plotting",displayField:"name",width:300,labelWidth:140,store:k,queryMode:"local",typeAhead:true,listeners:{change:function(s,r,q){m.updateCriteria(r);
}}});p.setValue("dozor_score");var c=new Ext.Toolbar({items:[j,g,h,a,p,this.slider.draw()]});m.panel=Ext.create("Ext.Panel",{layout:"fit",tbar:c,width:"100%",listeners:{"afterrender":function(q){m.postRender();}},html:"<div style='position:left; ' id='scaleColorMapPanel_"+d+"'></div> <div id='container_"+d+"'></div><div id='canvasarea_"+d+"' style='text-align:right'><canvas id='canvas_"+d+"' width='0' height='0' style='position:absolute; top:1000; left:1000;'>No map found</canvas></div>"});
return m.panel;};MapPanel.prototype.postRender=function(){var g=this;var c=document.getElementById("canvas_"+g.id+"");var b=document.getElementById("svg_"+g.id+"");var d=g.data.length;var f=0;if(g.data[0]){f=g.data[0].length;}var e=g.getRowsNamesBDA(d);var a=g.getColumnsNamesBDA(f);g.grid=new Grid(0,20,(e.length*g.cellWidthValue),(a.length*g.cellWidthValue),c,document.getElementById("container_"+g.id+""),g.id);
g.grid.fill(e,a,g.getDataBDA(d,f),g.data,g.positions,g.images,this.mapTitle,g.axisXName,g.axisYName,g.cellWidthValue,g.minValue,g.maxValue,g.colorRangeManager);g.grid.model.render();g.grid.refresh();};MapPanel.prototype._getDataRange=function(){var b=this;var a={min:0,max:0};a.min=b.minValue;a.max=b.maxValue;
return a;};MapPanel.prototype._calculateMaxValue=function(){var a=0;var e=this.data.length;for(var d=0;d<e;d++){var b=this.data[d].length;for(var c=0;c<b;c++){a=Math.max(a,this.data[d][c]);}}return a;};MapPanel.prototype._calculateMinValue=function(){var d=0;var e=this.data.length;if(e>0&&this.data[0].length>0){d=this.data[0][0];
}for(var c=0;c<e;c++){var a=this.data[c].length;for(var b=0;b<a;b++){d=Math.min(d,this.data[c][b]);}}return d;};MapPanel.prototype.updateCriteria=function(a){var b="";if(a=="Total Integrated Signal"){b="totalIntegratedSignal";}else{if(a=="Good bragg candidates"){b="goodBraggCandidates";}else{if(a=="Total Spots"){b="totalSpots";
}else{if(a=="Method 1 resolution"){b="method1Res";}else{if(a=="Method 2 resolution"){b="method2Res";}else{if(a=="Dozor Score"){b="dozor_score";}}}}}}if(b!=""){this.buildDataCriteria(b);this.maxValue=this._calculateMaxValue();this.reverseOrder=false;if(b=="method1Res"||b=="method2Res"){this.reverseOrder=true;
}this._refresh();}};MapPanel.prototype.saveAsImage=function(){svgenie.save("meshSvgId_"+this.id,{name:"mesh.png"});};MapPanel.prototype.refresh=function(r,l,m,c,a,g,s,n,d,e){var q=this;q.data=r;q.positions=l;q.images=m;q.colorRangeManager=g;q.scaleDataX=c;q.scaleDataY=a;q.mapTitle=s;q.axisXName=n;q.axisYName=d;
var f=document.getElementById("canvas_"+q.id+"");var p=document.getElementById("svg_"+q.id+"");var j=q.data.length;var k=q.data[0].length;var h=e;var b=q.getRowsNamesBDA(j);var o=q.getColumnsNamesBDA(k);q.grid.fill(b,o,q.getDataBDA(j,k),q.data,q.positions,q.images,q.mapTitle,q.axisXName,q.axisYName,h,q.colorRangeManager.getMinValue(),q.colorRangeManager.getMaxValue(),q.colorRangeManager);
q.grid.refresh();};MapPanel.prototype.getRowsNamesBDA=function(b){var d=this;var c=[];for(var a=0;a<b;a++){c.push(d.scaleDataY[a]);}return c;};MapPanel.prototype.getColumnsNamesBDA=function(b){var d=this;var c=[];for(var a=0;a<b;a++){c.push(d.scaleDataX[a]);}return c;};MapPanel.prototype.getDataBDA=function(d,f){var h=this;
var e=[];for(var c=0;c<d;c++){e[c]=[];}var b=[];var g=[];for(var a=0;a<f;a++){g[a]="COLUMN_#"+a;for(var c=0;c<d;c++){e[c][a]=h.getColorCell(c,a);b[c]="ROW_NAMES_#"+c;}}return e;};MapPanel.prototype.getColorCell=function(b,a){var c=this;return this.colorRangeManager.getCellColorString(c.data[b][a]);};
MapPanel.prototype.loadImage=function(){if(this.snapshot&&this.snapshot.filePresent){var a="imageDownload.do?reqCode=getImageJpgFromFile&file="+this.snapshot.fileLocation;this.grid.loadImage(a);}};MapPanel.prototype.unloadImage=function(){this.grid.unloadImage();};function MapSettingsPanel(a){this.actions=new Array();
if(a!=null){if(a.actions!=null){this.actions=a.actions;}}}MapSettingsPanel.prototype.getPanel=function(c){var e=this;var b=c.mapTitle;var d=c.maxValue;var a=c.minValue;if(this.panel==null){this.panel=Ext.createWidget("form",{bodyPadding:5,width:60,frame:true,fieldDefaults:{labelAlign:"left",labelWidth:60},items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,border:false,layout:"anchor",defaultType:"textfield",items:[{fieldLabel:"Map title",name:"mapTitle",id:"mapTitle",tooltip:"Title of the map",value:b},{xtype:"container",flex:1,layout:"anchor",defaultType:"textfield",items:[{xtype:"numberfield",fieldLabel:"Value max",allowNegative:false,name:"maxValue",value:d,decimalPrecision:0,minValue:1,validator:function(f){if(!Ext.isEmpty(f)){if(f<0){return"Value cannot be negative";
}return true;}else{return"Value cannot be empty";}}}]}]}]}]});}return this.panel;};MapSettingsPanel.prototype.getMapTitle=function(){var a=Ext.getCmp(this.panel.getItemId()).getValues().mapTitle;return a;};MapSettingsPanel.prototype.getMaxValue=function(){var a=Ext.getCmp(this.panel.getItemId()).getValues().maxValue;
return a;};MapSettingsPanel.prototype.getMinValue=function(){var a=Ext.getCmp(this.panel.getItemId()).getValues().minValue;return a;};MapSettingsWindow.prototype.getButtons=GenericWindow.prototype.getButtons;MapSettingsWindow.prototype._render=GenericWindow.prototype._render;MapSettingsWindow.prototype._postRender=GenericWindow.prototype._postRender;
function MapSettingsWindow(a){this.title="Map Settings";this.height=200;if(a!=null){if(a.actions!=null){this.actions=a.actions;}}this.onSavedButtonClicked=new Event(this);this.form=new MapSettingsPanel();GenericWindow.prototype.constructor.call(this,{form:this.form,title:this.title,height:this.height});
}MapSettingsWindow.prototype.getButtons=function(){return[];};MapSettingsWindow.prototype.cancel=function(){this.panel.close();};MapSettingsWindow.prototype.save=function(){var a={mapTitle:"",maxValue:0,minValue:0};a.mapTitle=this.form.getMapTitle();a.maxValue=this.form.getMaxValue();a.minValue=0;this.onSaved.notify(a);
this.panel.close();};MapSettingsWindow.prototype.draw=function(d,c,b){var e=this;var a={mapTitle:d,maxValue:c,minValue:b};this._render(a);};MapSettingsWindow.prototype.getButtons=function(){var a=this;return[{text:"Save",handler:function(){a.save();}},{text:"Cancel",handler:function(){a.panel.close();
}}];};function MeshScanPanel(a){var b=this;this.width=1380;this.height=700;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}MeshScanPanel.prototype.getPanel=function(a,c,g){var f=this;var e=new MapPanel();e=e.getPanel(a,c,g);var d=new PositionGrid();d=d.getGrid(a);
var b=[];b.push(e);b.push(d);f.panel=Ext.create("Ext.Panel",{layout:{type:"vbox"},items:b});return f.panel;};function MeshTabPanel(a){var b=this;this.width=1380;this.height=700;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}MeshTabPanel.prototype.getPanel=function(c){var f=this;
var h=[];if(c&&c.listOfImages){var e=c.listOfImages.length;for(var d=0;d<e;d++){var g=new MeshScanPanel();var k=""+d;if(c.listOfCollect&&c.listOfCollect.length>d){collects=c.listOfCollect[d];if(collects.length>0){k=collects[0].imagePrefix;}}var b=null;if(c.listOfMeshData&&c.listOfMeshData.length>d){b=c.listOfMeshData[d];
}var a=null;if(c.listOfSnapshot&&c.listOfSnapshot.length>d){a=c.listOfSnapshot[d];}h.push({tabConfig:{title:k},items:[g.getPanel(b,a,d)]});}}var j=Ext.create("Ext.tab.Panel",{layout:"fit",activeTab:0,defaults:{bodyPadding:0},items:h});f.panel=Ext.create("Ext.Panel",{layout:"fit",items:[j]});return f.panel;
};function MeshWallImagePanel(a){var b=this;this.width=1380;this.height=800;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}ImageModel=Ext.define("ImageModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"url"},{name:"target"},{name:"size",type:"float"}]});
}MeshWallImagePanel.prototype.prepareData=function(e){this.features=[];var a=e;for(var b=0;b<a.length;b++){var d={};var c=d.name=a[b].fileName;d.url="imageDownload.do?reqCode=getImageJpgThumb&imageId="+a[b].imageId;d.size=125;d.target="viewResults.do?reqCode=viewJpegImage&imageId="+a[b].imageId+"&previousImageId="+a[b].previousImageId+"&nextImageId="+a[b].nextImageId;
this.features.push(d);}};MeshWallImagePanel.prototype.getNbCol=function(c){if(c&&c.length>0){var b=c[0].motorPosition.gridIndexY;var f=b;var a=b;for(var e=1;e<c.length;e++){b=c[e].motorPosition.gridIndexY;if(b<f){f=b;}else{if(b>a){a=b;}}}var g=[];var d=0;if(f){d=f;}while(d<a){g.push(d);d=Number(d)+1;
}if(a){g.push(a);}else{g.push(0);}return g.length;}};MeshWallImagePanel.prototype.getGridPosition=function(a,b){for(var c=0;c<a.length;c++){if(Number((a[c].imageId))===Number(b)){var d=new Array(2);d[0]=a[c].motorPosition.gridIndexZ;d[1]=a[c].motorPosition.gridIndexY;return d;}}return null;};MeshWallImagePanel.prototype.getPanel=function(e,c){var j=this;
this.prepareData(e);this.store=Ext.create("Ext.data.Store",{model:"ImageModel"});this.store.loadData(this.features,false);var k=[];if(e&&e.length>0){k.push({xtype:"displayfield",name:"location",labelWidth:175,width:"100%",fieldLabel:"Location",value:e[0].fileLocation});}var b=this.getNbCol(c);var n=0;
var g=[];if(c&&e){var a=e;n=140*((a.length/b));if(n<140){n=140;}for(var h=0;h<a.length;h++){var d=a[h].imageId;var m=this.getGridPosition(c,d);if(m){var f=Ext.create("Ext.Panel",{width:125,height:125,border:0,margin:"5 5 5 5",html:'<a href="viewResults.do?reqCode=viewJpegImage&imageId='+a[h].imageId+"&previousImageId="+a[h].previousImageId+"&nextImageId="+a[h].nextImageId+'" ><img src="imageDownload.do?reqCode=getImageJpgThumb&imageId='+a[h].imageId+'" width="125" height="125" border="0" /></a>'});
g.push(f);}}}var l=Ext.create("Ext.Panel",{layout:{type:"table",columns:b},height:n,items:g});k.push(l);j.panel=Ext.create("Ext.Panel",{width:"100%",autoScroll:true,layout:"vbox",items:k});return j.panel;};function PositionGrid(b){var a="";this.title="Positions";this.contextPath="";if(b!=null){if(b.height!=null){this.height=b.height;
}if(b.contextPath!=null){this.contextPath=b.contextPath;}if(b.title!=null){this.title=b.title;}if(b.listOfCrystalClass!=null){this.listOfCrystalClass=b.listOfCrystalClass;}if(b.contextPath!=null){this.contextPath=b.contextPath;}}Ext.define("positionModel",{extend:"Ext.data.Model",fields:[{name:"dataCollectionId",mapping:"dataCollectionId"},{name:"imagePrefix",mapping:"imagePrefix"},{name:"dataCollectionNumber",mapping:"dataCollectionNumber"},{name:"phiX",mapping:"phiX"},{name:"phiY",mapping:"phiY"},{name:"phiZ",mapping:"phiZ"},{name:"sampX",mapping:"sampX"},{name:"sampY",mapping:"sampY"},{name:"omega",mapping:"omega"},{name:"kappa",mapping:"kappa"},{name:"phi",mapping:"phi"},{name:"gridIndexY",mapping:"gridIndexY"},{name:"gridIndexZ",mapping:"gridIndexZ"},{name:"spotTotal",mapping:"spotTotal"},{name:"goodBraggCandidates",mapping:"goodBraggCandidates"},{name:"method1Res",mapping:"method1Res"},{name:"method2Res",mapping:"method2Res"},{name:"totalIntegratedSignal",mapping:"totalIntegratedSignal"},{name:"dozor_score",mapping:"dozor_score"}],idProperty:"dataCollectionId"});
}PositionGrid.prototype.getFilterTypes=function(){return[];};PositionGrid.prototype._prepareData=function(c){var e=[];for(var b=0;b<c.length;b++){var a=new Object();a=c[b];a.phiX=c[b].motorPosition.phiX;a.phiY=c[b].motorPosition.phiY;a.phiZ=c[b].motorPosition.phiZ;a.sampX=c[b].motorPosition.sampX;a.sampY=c[b].motorPosition.sampY;
a.omega=c[b].motorPosition.omega;a.kappa=c[b].motorPosition.kappa;a.phi=c[b].motorPosition.phi;a.gridIndexY=c[b].motorPosition.gridIndexY;a.gridIndexZ=c[b].motorPosition.gridIndexZ;e.push(a);}return e;};PositionGrid.prototype.getGrid=function(a){this.features=this._prepareData(a);return this.renderGrid(this.features);
};PositionGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;};PositionGrid.prototype.renderGrid=function(){var b=this;var a=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"positionModel",autoload:false});this._sort(this.store);this.store.totalCount=this.features.length;
this.store.loadData(this.features,false);this.title="("+this.features.length+") Positions";this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:"100%",model:"positionModel",height:"100%",store:this.store,columns:a,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"}});
return this.grid;};PositionGrid.prototype._sort=function(a){a.sort("dozor_score","DESC");};PositionGrid.prototype._getColumns=function(){var c=this;function b(d){if(d){return'<div style="white-space:normal !important;">'+d+"</div>";}else{return"";}}var a=[{text:"Image Prefix",dataIndex:"imagePrefix",flex:0.15},{text:"Run No",dataIndex:"dataCollectionNumber",flex:0.05},{text:"phiX",dataIndex:"phiX",flex:0.075},{text:"phiY",dataIndex:"phiY",flex:0.075},{text:"phiZ",dataIndex:"phiZ",flex:0.075},{text:"sampX",dataIndex:"sampX",flex:0.075},{text:"sampY",dataIndex:"sampY",flex:0.075},{text:"omega",dataIndex:"omega",flex:0.075},{text:"kappa",dataIndex:"kappa",flex:0.075},{text:"phi",dataIndex:"phi",flex:0.075},{text:"gridIndexY",dataIndex:"gridIndexY",flex:0.075},{text:"gridIndexZ",dataIndex:"gridIndexZ",flex:0.075},{text:"Spot Total",dataIndex:"spotTotal",flex:0.075},{text:"Good Bragg Candidates",dataIndex:"goodBraggCandidates",flex:0.075},{text:"Method 1 Resolution",dataIndex:"method1Res",flex:0.075},{text:"Method 2 Resolution",dataIndex:"method2Res",flex:0.075},{text:"Total Integrated Signal",dataIndex:"totalIntegratedSignal",flex:0.075},{text:"Dozor Score",dataIndex:"dozor_score",flex:0.075}];
return a;};function SliderWidget(a){var b=this;this.sliderValue=30;this.sliderChange=new Event(this);}SliderWidget.prototype.draw=function(){var a=this;return Ext.create("Ext.slider.Single",{hideLabel:true,width:214,value:a.sliderValue,increment:1,minValue:10,maxValue:50,listeners:{change:function(b,c){a.sliderValue=c;
a.sliderChange.notify();}}});};SliderWidget.prototype.getSliderValue=function(){var a=this;return a.sliderValue;};function ParametersPanel(a){var b=this;this.width=500;this.height=250;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ParametersPanel.prototype.getPanel=function(a){var b=this;
b.data=a;b.panel=Ext.widget({xtype:"form",layout:{type:"vbox"},style:{marginLeft:"10px",marginTop:"10px"},collapsible:true,frame:true,title:"Parameters",bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:180},defaultType:"textfield",items:[{fieldLabel:"Ignore RSymm in the<br/>  low resolution shell over",name:"rsymm",value:a.rMerge},{fieldLabel:"Ignore I / Sigma in the<br/>  low resolution shell under",name:"isigma",value:a.iSigma}],buttons:[{text:"Update",handler:function(){b.update();
}}]});return b.panel;};ParametersPanel.prototype.update=function(){var f=this;var b=Ext.getCmp(this.panel.getItemId()).getValues().rsymm;var c=Ext.getCmp(this.panel.getItemId()).getValues().isigma;if(f.data.dataCollectionId){var e=f.data.dataCollectionId;document.location.href="viewResults.do?reqCode=display&dataCollectionId="+e+"&rmerge="+b+"&isigma="+c;
}else{if(f.data.dataCollectionGroupId){var a=f.data.dataCollectionGroupId;document.location.href="viewDataCollection.do?reqCode=displayForDataCollectionGroup&dataCollectionGroupId="+a+"&rmerge="+b+"&isigma="+c;}else{var d=f.data.sessionId;document.location.href="viewDataCollection.do?reqCode=displayForSession&sessionId="+d+"&rmerge="+b+"&isigma="+c;
}}};function ReferencePanel(a){var b=this;this.width=300;this.height=250;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.listOfRef=null;}ReferencePanel.prototype.getListOfReference=function(){return this.listOfRef;};ReferencePanel.prototype.getPanel=function(f){var g=this;
var a="";var e=[];this.listOfRef=f.listOfReferences;if(f.referenceText){a+="<h2>"+f.referenceText+"</h2>";}if(this.listOfRef){for(var c=0;c<this.listOfRef.length;c++){var d=this.listOfRef[c];a+="<a href="+d.referenceUrl+" target=_blank>"+d.referenceName+"</a><br/> ";e.push(d.referenceId);}}var b=f.contextPath+"/viewReference.do?reqCode=downloadListOfReference&listOfReference="+e;
g.panel=Ext.widget({xtype:"form",layout:"fit",collapsible:true,frame:true,autoScroll:true,title:"References",width:this.width,fieldDefaults:{msgTarget:"side",labelWidth:100},defaultType:"textfield",style:{marginLeft:"10px",marginTop:"10px"},items:[{xtype:"panel",manageHeight:false,html:a}],buttons:[{xtype:"button",text:"Download as BibTeX",href:b,target:"_blank",hrefTarget:"_blank"}]});
return g.panel;};function ReportPanel(a){var b=this;this.width=500;this.height=250;this.isFx=false;this.isIndustrial=false;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ReportPanel.prototype.getPanel=function(f){var g=this;var b="";var e=null;if(f&&f.contextPath){b=f.contextPath;
}if(f&&f.sessionId){e=f.sessionId;}if(f&&f.isFx){this.isFx=f.isFx;}if(f&&f.isIndustrial){this.isIndustrial=f.isIndustrial;}var a=new Ext.Button({icon:"../images/Word.png",href:b+"/user/exportDataCollection.do?reqCode=exportAsRtf&sessionId="+e,hrefTarget:"_self",scale:"large",tooltip:"Export this table as DOC"});
var d=new Ext.Button({icon:"../images/pdf.png",href:b+"/user/exportDataCollection.do?reqCode=exportAsPdf&sessionId="+e,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export this table as PDF"});var k=new Ext.Button({icon:"../images/icon_excel07.jpg",href:b+"/user/exportDataCollection.do?reqCode=exportAsCsv&sessionId="+e,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export this table as CSV"});
var h=new Ext.Button({icon:"../images/pdfSend.png",href:b+"/user/exportDataCollection.do?reqCode=exportAndSendAsPdf&sessionId="+e,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export and send as PDF"});var c=new Ext.Button({icon:"../images/Word.png",href:b+"/user/exportDataCollection.do?reqCode=exportScreeningAsRtf&sessionId="+e,hrefTarget:"_self",scale:"large",tooltip:"Export Screenings into DOC"});
var l=new Ext.Button({icon:"../images/pdf.png",href:b+"/user/exportDataCollection.do?reqCode=exportScreeningAsPdf&sessionId="+e,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export Screenings into PDF"});var m=[];m.push(a,d,k);if(g.isFx&&!g.isIndustrial){m.push(h);}g.panelGeneralReport=Ext.create("Ext.Panel",{layout:{type:"hbox",border:0,bodyPadding:10},border:0,bodyStyle:"background-color:#dfe8f5;",collapsible:false,frame:false,items:m});
var j=[];j.push(c,l);g.panelScreeningReport=Ext.create("Ext.Panel",{layout:{type:"hbox",border:0,bodyPadding:10},border:0,bodyStyle:"background-color:#dfe8f5;",collapsible:false,frame:false,items:j});g.panel=Ext.create("Ext.form.Panel",{layout:{type:"vbox",border:0,bodyPadding:40},border:0,style:{marginLeft:"10px",marginTop:"10px"},fieldDefaults:{msgTarget:"side",labelWidth:200},collapsible:true,title:"Reports",frame:true,items:[{xtype:"displayfield",fieldLabel:"General report",labelStyle:"font-weight:bold;",value:""},g.panelGeneralReport,{xtype:"displayfield",fieldLabel:"Screening report",labelStyle:"font-weight:bold;",value:""},g.panelScreeningReport]});
return g.panel;};function ReportSessionPanel(a){var b=this;this.width=500;this.height=250;this.sessionId=null;this.contextPath="";this.isFx=false;this.isIndus=false;this.send=false;this.onExportReportSelected=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}}ReportSessionPanel.prototype.getPanel=function(f){var h=this;h.contextPath="";h.sessionId=null;if(f&&f.contextPath){h.contextPath=f.contextPath;}if(f&&f.sessionId){h.sessionId=f.sessionId;}if(f&&f.isFx){h.isFx=f.isFx;}if(f&&f.isIndus){h.isIndus=f.isIndus;}var k=[];var a=new Ext.Button({icon:"../images/Word.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportMXPressOWorkflowAsRtf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",tooltip:"Export the MXPressO/MXPressE pipeline report into DOC"});
var d=new Ext.Button({icon:"../images/pdf.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportMXPressOWorkflowAsPdf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export the MXPressO/MXPressE pipeline report into PDF"});k.push(a,d);h.panelReport=Ext.create("Ext.Panel",{layout:{type:"hbox",border:0,bodyPadding:10},border:0,bodyStyle:"background-color:#dfe8f5;",collapsible:false,frame:false,items:k});
var b=[];var g=new Ext.Button({icon:"../images/Word.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportIndustrialReportAsRtf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",tooltip:"Export the report into DOC"});var n=new Ext.Button({icon:"../images/pdf.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportIndustrialReportAsPdf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export the report into PDF"});
var m=new Ext.Button({icon:"../images/pdfSend.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportIndustrialReportAndSendAsPdf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export the report and send as PDF"});b.push(g,n);if(h.isFx&&!h.isIndus){b.push(m);
}h.panelIndustrialReport=Ext.create("Ext.Panel",{layout:{type:"hbox",border:0,bodyPadding:10},border:0,bodyStyle:"background-color:#dfe8f5;",collapsible:false,frame:false,items:b});var c=[];h.rtf=false;var e=new Ext.Button({icon:"../images/Word.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportSessionAsRtf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",tooltip:"Export the Session report into DOC",handler:function(q,p){h.rtf=true;
h.send=false;h.onExportReportSelected.notify({});}});var l=new Ext.Button({icon:"../images/pdf.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportSessionAsPdf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export the Session report into PDF",handler:function(q,p){h.rtf=false;
h.send=false;h.onExportReportSelected.notify({});}});var o=new Ext.Button({icon:"../images/pdfSend.png",href:h.contextPath+"/user/exportDataCollection.do?reqCode=exportSessionAsPdf&sessionId="+h.sessionId,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export the Session report and send as PDF",handler:function(q,p){h.rtf=false;
h.send=true;h.onExportReportSelected.notify({});}});c.push(e,l);if(h.isFx&&!h.isIndus){c.push(o);}h.panelGeneralReport=Ext.create("Ext.Panel",{layout:{type:"hbox",border:0,bodyPadding:10},border:0,bodyStyle:"background-color:#dfe8f5;",collapsible:false,frame:false,items:c});var j=[];if(f.sessionSummary&&f.sessionSummary==true){j.push({xtype:"displayfield",fieldLabel:"General report",labelStyle:"font-weight:bold;",value:""},h.panelIndustrialReport);
j.push({xtype:"displayfield",fieldLabel:"Screening report",labelStyle:"font-weight:bold;",value:""},h.panelGeneralReport);}if(f.sessionHasMXpressOWF&&f.sessionHasMXpressOWF==true){j.push({xtype:"displayfield",fieldLabel:"MXPressO-MXPressE report",labelStyle:"font-weight:bold;",value:""},h.panelReport);
}h.panel=Ext.create("Ext.form.Panel",{layout:{type:"vbox",border:0,bodyPadding:40},border:0,style:{marginLeft:"10px",marginTop:"10px"},fieldDefaults:{msgTarget:"side",labelWidth:200},collapsible:true,title:"Reports",frame:true,items:j});return h.panel;};ReportSessionPanel.prototype.exportSessionReport=function(){var a=this;
if(a.rtf){window.location.href=a.contextPath+"/user/exportDataCollection.do?reqCode=exportSessionAsRtf&sessionId="+a.sessionId;}else{if(a.send){window.location.href=a.contextPath+"/user/exportDataCollection.do?reqCode=exportSessionAndSendAsPdf&sessionId="+a.sessionId;}else{window.location.href=a.contextPath+"/user/exportDataCollection.do?reqCode=exportSessionAsPdf&sessionId="+a.sessionId;
}}};function ResultPanel(a){var b=this;this.width=1380;this.height=700;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ResultPanel.prototype.getPanel=function(e){var h=this;var b=[];if(e&&e.workflowVO&&e.workflowVO.resultFiles){var a=e.workflowVO.resultFiles.length;
for(var d=0;d<a;d++){var f=new WebPanel();var g=e.workflowVO.resultFiles[d].directoryName;b.push({tabConfig:{title:g},items:[f.getPanel(e.workflowVO.resultFiles[d])]});}}var c=Ext.create("Ext.tab.Panel",{layout:"fit",activeTab:0,defaults:{bodyPadding:0},items:b});h.panel=Ext.create("Ext.Panel",{layout:"fit",items:[c]});
return h.panel;};function SearchDataCollectionPanel(a){var b=this;this.width=550;this.height=500;this.onSearchDataCollection=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}SearchDataCollectionPanel.prototype.getSearchCriteria=function(){var f=Ext.getCmp(this.panel.getItemId()).getValues().beamline;
var e=Ext.getCmp(this.panel.getItemId()).getValues().searchStartDate;var d=Ext.getCmp(this.panel.getItemId()).getValues().searchEndDate;var c=Ext.getCmp(this.panel.getItemId()).getValues().searchStartTime;var b=Ext.getCmp(this.panel.getItemId()).getValues().searchEndTime;var a=[];a.beamline=f;a.startDate=e;
a.endDate=d;a.startTime=c;a.endTime=b;return a;};SearchDataCollectionPanel.prototype.selectAllBeamlines=function(a){Ext.each(Ext.getCmp("beamlineGroup").items.items,function(b){if(b.setValue){b.setValue(a);}return true;},Ext.getCmp("beamlineGroup"));};SearchDataCollectionPanel.prototype.setCriteria=function(b,a,h,f,c){if(Ext.getCmp("beamlineGroup")){Ext.each(Ext.getCmp("beamlineGroup").items.items,function(k){if(b&&b.length>0){var j=b.indexOf(k.boxLabel);
k.setValue(j!=-1);}return true;},Ext.getCmp("beamlineGroup"));}var e=Ext.getCmp(this.panel.getItemId()).items.items;for(var d=0;d<e.length;d++){var g=e[d];if(g.name=="searchStartDate"&&a&&a!="undefined"){g.setValue(a);}else{if(g.name=="searchEndDate"&&h&&h!="undefined"){g.setValue(h);}else{if(g.name=="searchStartTime"&&f&&f!="undefined"){g.setValue(f);
}else{if(g.name=="searchEndTime"&&c&&c!="undefined"){g.setValue(c);}}}}}};SearchDataCollectionPanel.prototype.getPanel=function(b){var c=this;var a=[];for(i=0;i<b.length;i++){a.push({xtype:"checkbox",boxLabel:b[i],name:"beamline",checked:true,inputValue:b[i]});}c.panel=Ext.widget({xtype:"form",collapsible:true,id:"searchSessionForm",frame:true,title:"Search DataCollection",width:this.width,fieldDefaults:{msgTarget:"side",labelWidth:100},defaultType:"textfield",layout:{type:"table",columns:2},defaults:{labelStyle:"padding-left:10px;"},items:[{xtype:"checkboxgroup",fieldLabel:"Beamline",id:"beamlineGroup",columns:[90,90,90,90,90],colspan:2,allowBlank:false,itemId:"beamlines",items:a},{xtype:"button",name:"selectAllBl",text:"Select all Beamlines",handler:function(){c.selectAllBeamlines(true);
}},{xtype:"button",name:"deselectAllBl",text:"Deselect all Beamlines",handler:function(){c.selectAllBeamlines(false);}},{xtype:"datefield",name:"searchStartDate",fieldLabel:"Start Date (DD/MM/YYYY)",format:"d/m/Y",submitFormat:"d/m/Y"},{xtype:"timefield",name:"searchStartTime",fieldLabel:"Start Time (hh:mm)",format:"H:i",submitFormat:"H:i"},{xtype:"datefield",name:"searchEndDate",fieldLabel:"End Date (DD/MM/YYYY)",format:"d/m/Y",submitFormat:"d/m/Y"},{xtype:"timefield",name:"searchEndTime",fieldLabel:"End Time (hh:mm)",format:"H:i",submitFormat:"H:i"}],buttons:[{text:"Search",handler:function(){var f=Ext.getCmp(c.panel.getItemId()).getValues().searchStartDate;
var e=Ext.getCmp(c.panel.getItemId()).getValues().searchEndDate;var h=((f==""&&e!="")||(f!=""&&e==""));if(f!=""&&e!=""){var k=f.split("/");var m=new Date(k[2],(k[1]-1),k[0]);k=e.split("/");var l=new Date(k[2],(k[1]-1),k[0]);var g=l.getTime()-m.getTime();var j=Math.ceil(g/(1000*60*60*24));h=(j>1);}var d=true;
if(h==true){d=confirm("This search may take a long time (period > 1 day). Are you sure to continue?");}if(d==true){c.onSearchDataCollection.notify();}}},{text:"Reset",handler:function(){this.up("form").getForm().reset();}}]});return c.panel;};function SessionStatsPanel(a){var b=this;this.width=300;this.height=250;
if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}SessionStatsPanel.prototype.getPanel=function(a){var b=this;b.panel=Ext.widget({xtype:"form",layout:{type:"vbox"},style:{marginLeft:"10px",marginTop:"10px"},collapsible:true,frame:true,title:"Session Statistics",bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:180},defaultType:"displayfield",items:[{fieldLabel:"Nb Collect",value:a.nbCollect,qtip:"> 4 Images",listeners:{render:function(d){Ext.QuickTips.register({target:d.getEl(),text:d.qtip});
}}},{fieldLabel:"Nb Test",value:a.nbTest,qtip:"<= 4 Images",listeners:{render:function(d){Ext.QuickTips.register({target:d.getEl(),text:d.qtip});}}},{fieldLabel:"Nb Energy Scan",value:a.nbEnergyScans},{fieldLabel:"Nb XRFSpectra",value:a.nbXRFSpectra}]});return b.panel;};function SessionSummaryObject(a){this.type="POST";
this.json=a;this.collectionGroupRetrieved=new Event(this);this.sessionRetrieved=new Event(this);this.imageSaved=new Event(this);this.sessionSummaryRetrieved=new Event(this);this.onSaved=new Event(this);this.onError=new Event(this);}SessionSummaryObject.prototype.getSessionSummary=function(b){var c=this;
var a=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"viewSessionSummary.do?reqCode=getSessionSummary&nbOfItems="+b,data:{},datatype:"text/json",success:function(d){c.sessionSummaryRetrieved.notify(d);a.hide();},error:function(f,d,e){c.onError.notify(f.responseText);a.hide();
}});};SessionSummaryObject.prototype.saveData=function(c,d,b){var e=this;var a=Ext.MessageBox.wait("Please wait...","Saving Data");$.ajax({type:this.type,url:"viewSessionSummary.do?reqCode=saveAllData",data:{nbOfItems:b,sessionId:d,listData:c},datatype:"text/json",success:function(f){e.onSaved.notify(f);
a.hide();},error:function(h,f,g){e.onError.notify(h.responseText);a.hide();}});};SessionSummaryObject.prototype.changeSessionReportPageNumber=function(a,b){var c=this;$.ajax({type:this.type,url:"viewSessionSummary.do?reqCode=changeCurrentPageNumber",data:{sessionId:b,sessionReportCurrentPageNumber:a},datatype:"text/json",success:function(){},error:function(f,d,e){c.onError.notify(f.responseText);
}});};function SessionViewGrid(c){this.onSaveButtonClicked=new Event(this);this.onExportReportWithGraphSelected=new Event(this);this.onPageChanged=new Event(this);var b=false;var d=false;var a="";this.listChartId=[];this.graph2Hidden=true;this.proteinSampleHidden=true;this.canSave=false;this.listOfCrystalClass=[];
this.startPageNumber=1;if(c!=null){if(c.height!=null){this.height=c.height;}if(c.isFx!=null){this.isFx=c.isFx;}if(c.isIndus!=null){this.isIndus=c.isIndus;}if(c.contextPath!=null){this.contextPath=c.contextPath;}if(c.title!=null){this.title=c.title;}if(c.sessionId!=null){this.sessionId=c.sessionId;}if(c.nbOfItems!=null){this.nbOfItems=c.nbOfItems;
}if(c.listOfCrystalClass!=null){this.listOfCrystalClass=c.listOfCrystalClass;}if(c.canSave!=null){this.canSave=c.canSave;}if(c.startPageNumber!=null){this.startPageNumber=c.startPageNumber;}}this._setCrystalClass();Ext.define("SessionDataModel",{extend:"Ext.data.Model",fields:[{name:"sessionId",mapping:"sessionId"},{name:"experimentType",mapping:"experimentType"},{name:"proteinAcronym",mapping:"proteinAcronym"},{name:"sampleName",mapping:"sampleName"},{name:"sampleNameProtein",mapping:"sampleNameProtein"},{name:"dataTime",mapping:"dataTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"dataCollectionId",mapping:"dataCollectionId"},{name:"imagePrefix",mapping:"imagePrefix"},{name:"runNumber",mapping:"runNumber"},{name:"listParameters",mapping:"listParameters"},{name:"crystalClass",mapping:"crystalClass"},{name:"comments",mapping:"comments"},{name:"imageThumbnailExist",mapping:"imageThumbnailExist"},{name:"imageThumbnailPath",mapping:"imageThumbnailPath"},{name:"imageId",mapping:"imageId"},{name:"crystalSnapshotExist",mapping:"crystalSnapshotExist"},{name:"crystalSnapshotPath",mapping:"crystalSnapshotPath"},{name:"graphExist",mapping:"graphExist"},{name:"graphPath",mapping:"graphPath"},{name:"graph2Exist",mapping:"graph2Exist"},{name:"graph2Path",mapping:"graph2Path"},{name:"graphData",mapping:"graphData"},{name:"resultStatus",mapping:"resultStatus"},{name:"result",mapping:"result"},{name:"listResults",mapping:"listResults"},{name:"workflow",mapping:"workflow"},{name:"energyScan",mapping:"energyScan"},{name:"xrfSpectra",mapping:"xrfSpectra"},{name:"dataCollection",mapping:"dataCollection"},{name:"samplePosition",mapping:"samplePosition"},{name:"barcode",mapping:"barcode"}]});
}SessionViewGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(a);};SessionViewGrid.prototype._setCrystalClass=function(){this.crystalClass=[];for(var a=0;a<this.listOfCrystalClass.length;a++){this.crystalClass.push(this.listOfCrystalClass[a].crystalClassName);}};SessionViewGrid.prototype.refresh=function(a){this.features=a.listSessionDataObjectInformation;
this.store.loadData(this.features,false);};SessionViewGrid.prototype._sort=function(a){a.sort("dataTime","DESC");};SessionViewGrid.prototype.renderGrid=function(){var l=this;l.graph2Hidden=true;l.proteinSampleHidden=true;var d=null;for(var m=0;m<l.features.length;m++){if(l.features[m].graph2Exist){l.graph2Hidden=false;
}if(l.features[m].sampleNameProtein&&l.features[m].sampleNameProtein!==""){l.proteinSampleHidden=false;d="sampleNameProtein";}if(l.features[m].graphData&&l.features[m].graphData.length>0){var q=l.features[m].graphData[0].autoProcProgramAttachmentId;l.listChartId.push(q);}}var h=[];var g=this._getColumns();
l.pagingMode=false;if(l.features.length>15){l.pagingMode=true;}if(l.pagingMode){this.store=Ext.create("Ext.data.Store",{model:"SessionDataModel",autoload:false,pageSize:10,groupField:"dataTime",proxy:{type:"pagingmemory",data:this.features,reader:{type:"array"}}});}else{this.store=Ext.create("Ext.data.Store",{model:"SessionDataModel",autoload:false,groupField:"dataTime"});
}var e=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{columnName}: {name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})',hideGroupedHeader:true,startCollapsed:false,id:"sessionReportGrouping"}),c=this.store.getGroups(),k=c.length,j=function(f){var r=f.text;if(f.checked){e.expand(r,true);
}else{e.collapse(r,true);}};var a=null;var b="Pagination";if(l.pagingMode){b="Remove pagination";a=Ext.create("Ext.PagingToolbar",{store:this.store,pageSize:this.pageSize,displayInfo:true,displayMsg:"Displaying data {0} - {1} of {2}",emptyMsg:"No data to display",listeners:{afterrender:function(){var r=Ext.query("button[data-qtip=Refresh]");
for(var f=0;f<r.length;f++){r[f].style.display="none";}}}});a.on({change:function(f,s){var r=s.currentPage;l.onPageChanged.notify({"sessionReportCurrentPageNumber":r,"sessionId":l.sessionId});}});}this.store.loadData(this.features,false);this._sort(this.store);var p=Ext.create("Ext.Panel",{layout:{type:"fit",align:"center",bodyPadding:0,border:0},html:"<html><h4>No Data have been found</h4></html>"});
if(this.features.length==0){return p;}var n=[];if(this.canSave){n.push({text:"Save Comments",tooltip:"Save comments",icon:"../images/save.gif",handler:function(){l.onSaveButtonClicked.notify({});}});}if(this.sessionId&&this.sessionId!="null"){n.push({text:"View All Summary info",tooltip:"View all data for summary. May take some time.",icon:"../images/magnif_16.png",handler:function(){document.location.href=contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewSessionSummary.do?reqCode=displayAll&sessionId="+l.sessionId;
}});}if(this.sessionId&&this.sessionId!="null"){n.push({text:"View All DataCollection",tooltip:"View all collects",icon:"../images/magnif_16.png",handler:function(){document.location.href=contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollection.do?reqCode=displayForSession&sessionId="+l.sessionId;
}});}n.push("->");n.push({text:"Expand All",handler:function(){var f=e.view.getEl().query(".x-grid-group-body");Ext.each(f,function(r){e.expand(Ext.get(r));});}},{text:"Collapse All",handler:function(){var f=e.view.getEl().query(".x-grid-group-body");Ext.each(f,function(r){e.collapse(Ext.get(r));});}});
n.push({text:"Clear Grouping",iconCls:"icon-clear-group",handler:function(){e.disable();}});var o=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0,marginTop:"10px"},model:"SessionDataModel",store:this.store,width:"100%",resizable:true,height:1000,title:"Session",columns:g,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},features:[e],plugins:[o],tbar:n,bbar:a});
if(l.pagingMode){this.store.loadPage(l.startPageNumber);}return this.grid;};SessionViewGrid.prototype._getColumns=function(){var j=this;function h(s,u,q){var t=Ext.Date.format(s,"H:i:s");var r=Ext.Date.format(s,"d-m-Y");return t+"<br />"+r;}function g(r,s,q){var u;var t;if(q.data.dataCollectionId){u=false;
t="Barcode (SC Position): ";if(q.data.barcode&&q.data.barcode!==""){t+=q.data.barcode;u=true;}if(q.data.samplePosition&&q.data.samplePosition!==""){t+=" ("+q.data.samplePosition+")";u=true;}if(u){s.tdAttr='data-qtip="'+t+'"';}return"<div style='white-space:normal !important;'><a href='"+j.contextPath+"/user/viewResults.do?reqCode=display&dataCollectionId="+q.data.dataCollectionId+"'>"+q.data.imagePrefix+"</a></div>";
}else{u=false;t="Barcode (SC Position): ";if(q.data.barcode&&q.data.barcode!==""){t+=q.data.barcode;u=true;}if(q.data.samplePosition&&q.data.samplePosition!==""){t+=" ("+q.data.samplePosition+")";u=true;}if(u){s.tdAttr='data-qtip="'+t+'"';}return'<div style="white-space:normal !important;">'+q.data.imagePrefix+"</div>";
}}function l(u,v,q){if(q.data.listParameters){var s="";for(var t=0;t<q.data.listParameters.length;t++){var x=q.data.listParameters[t];var w=x.text;var r=x.value;s+="<font color='#8E8888'><i>"+w+": </i></font>"+r+"<br />";}return s;}return"";}function o(r,s,q){if(!q.data.imageThumbnailExist){if(r){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Image not found:<br>"+r+"</h4></div>";
}else{return"";}}else{if(q.data.imageThumbnailPath.search("noDiffractionThumbnail.jpg")!=-1){return"";}return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewResults.do?reqCode=viewJpegImage&imageId="+q.data.imageId+"'  styleClass='LIST'>"+"<img width='110' height='110' src='imageDownload.do?reqCode=getImageJpgFromFile&file="+q.data.imageThumbnailPath+"' border='0' alt='Click to zoom the image' >"+"</a></div>";
}}function b(r,s,q){if(!q.data.crystalSnapshotExist){if(r){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Image not found:<br>"+r+"</h4></div>";}else{return"";}}else{if(q.data.crystalSnapshotPath.search("noXtalThumbnail.jpg")!=-1){return"";}return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewResults.do?reqCode=viewJpegImageFromFile&file="+q.data.crystalSnapshotPath+"'  styleClass='LIST'>"+"<img width='110' height='83' src='imageDownload.do?reqCode=getImageJpgFromFile&file="+q.data.crystalSnapshotPath+"' border='0' alt='Click to zoom the image' >"+"</a></div>";
}}function k(x,r,v){if(!v.data.graphExist){if(v.data.graphData){var w=[];for(var u=0;u<v.data.graphData.length;u++){var z={resolutionLimit:v.data.graphData[u].resolutionLimit,iSigma:v.data.graphData[u].iSigma};w.push(z);}var q=Ext.create("Ext.data.JsonStore",{fields:["resolutionLimit","iSigma"],data:w});
var t=Ext.id();var y="";if(v.data.graphData.length>0){y=v.data.graphData[0].autoProcProgramAttachmentId;}if(v.chart){v.chart.destroy();}Ext.defer(function(){v.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",id:"chart_"+y,width:140,height:130,renderTo:t,style:"background:#fff",animate:false,store:q,shadow:false,theme:"Category1",axes:[{type:"Numeric",position:"left",fields:["iSigma"],label:{font:"7px Arial"},grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb"}}},{type:"Category",position:"bottom",fields:["resolutionLimit"],title:"I/Sigl vs Resolution",labelTitle:{font:"8px Arial"},label:{font:"7px Arial"},grid:true}],series:[{type:"line",highlight:{size:3,radius:3},axis:"left",xField:"resolutionLimit",yField:"iSigma",markerConfig:{type:"cross",size:2,radius:2,"stroke-width":0}}]});
},50);return'<canvas id="canvas_'+y+'" style="display:none;"></canvas><div id="'+t+'"></div>';}else{if(v.data.graphPath){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Graph not found:<br>"+v.data.graphPath+"</h4></div>";}else{return"";}}}else{return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewResults.do?reqCode=viewJpegImageFromFile&file="+v.data.graphPath+"'  styleClass='LIST'>"+"<img width='120' height='100' src='imageDownload.do?reqCode=getImageJpgFromFile&file="+v.data.graphPath+"' border='0' alt='Click to zoom the image' >"+"</a></div>";
}}function d(r,s,q){if(!q.data.graph2Exist){if(q.data.graph2Path){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Graph not found:<br>"+q.data.graph2Path+"</h4></div>";}else{return"";}}else{return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewResults.do?reqCode=viewJpegImageFromFile&file="+q.data.graph2Path+"'  styleClass='LIST'>"+"<img width='120' height='100' src='imageDownload.do?reqCode=getImageJpgFromFile&file="+q.data.graph2Path+"' border='0' alt='Click to zoom the image' >"+"</a></div>";
}}function m(Q,P,u){if(u.data.result){var R="black";if(u.data.resultStatus.search("FAILED")!=-1){R="red";}else{if(u.data.resultStatus.search("SUCCESS")!=-1){R="green";}else{if(u.data.resultStatus.search("NOTDONE")!=-1){R="grey";}}}var V='<div style="white-space:normal !important;color: '+R+'">'+u.data.result+"</div>";
if(u.data.listResults){var U="<table border='1' ><tr>";var L=false;var M="<div style='white-space:normal !important;word-wrap: break-word;'>";for(var S=0;S<u.data.listResults.length;S++){var C=u.data.listResults[S];var N=C.text;var T=C.value;if(C.key=="completeness"){var K=T;var r=T.indexOf(",");var I=T.substring(0,r);
K=T.substring(r+1,T.length);var q=K.indexOf(",");var G=K.substring(0,q);K=K.substring(q+1,K.length);var E=K;var t=-61;var J=122;var B=(J/2)/100;var y=B*I;var A=t+y;var H=I<85?4:1;var w=B*G;var z=t+w;var F=G<85?4:1;var v=B*E;var x=t+v;var D=E<85?4:1;var O="";if(!(I===0&&G===0&&E===0)){O+='<img " src="../images/percentImage_small.png" title="'+I+'% (inner)" alt="'+I+'% (inner)" class="percentImage'+H+'" style="background-position: '+A+'px 0pt; "/><br/>';
O+='<img  src="../images/percentImage_small.png" title="'+G+'% (outer)" alt="'+G+'% (outer)" class="percentImage'+F+'" style="background-position: '+z+'px 0pt; "/><br/>';O+='<img  src="../images/percentImage_small.png" title="'+E+'% (overall)" alt="'+E+'% (overall)" class="percentImage'+D+'" style="background-position: '+x+'px 0pt; "/><br/>';
}M+="<font color='#8E8888'> <i>"+N+": </i> </font> <br />"+O;}else{if(!C.isTooltip){M+="<font color='#8E8888'> <i>"+N+": </i> </font>"+T+"<br />";}else{L=true;U+="<td  style='text-align:center'><font color='#8E8888'><i>"+N+"</i></font></td>";}}}U+="</tr>";if(L){U+="<tr>";for(var S=0;S<u.data.listResults.length;
S++){var C=u.data.listResults[S];var T=C.value;if(C.isTooltip){U+="<td  style='text-align:center'>"+T+"</td>";}}U+="</tr>";}U+="</table>";if(L){P.tdAttr='data-qtip="'+U+'"';}V+="</div>"+M;}return V;}}function c(p){if(p){return'<div style="white-space:normal !important;word-wrap: break-word">'+p+"</div>";
}else{return"";}}function f(t,u,q){if(q.data.workflow){var w="";if(q.data.workflow.status){w=q.data.workflow.status;}var s="../images/Sphere_White_12.png";if(w){if(w.search("Error")!=-1||w.search("Failure")!=-1){s="../images/Sphere_Red_12.png";}else{if(w.search("Started")!=-1||w.search("Launched")!=-1){s="../images/Sphere_Orange_12.png";
}else{if(w.search("Success")!=-1){s="../images/Sphere_Green_12.png";}}}}var r="";if(q.data.workflow.comments){r=q.data.workflow.comments;}var v=" <img src='"+s+"' border=0/>"+w+"<br/>"+q.data.workflow.workflowTitle+"<br/>"+r;u.tdAttr='data-qtip="'+v+'"';return"<a href='"+contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewWorkflow.do?reqCode=display&workflowId="+q.data.workflow.workflowId+"'>"+q.data.workflow.workflowType+"</a>";
}else{return q.data.experimentType;}}Ext.util.Format.comboRenderer=function(p){return function(r){var q=p.findRecord(p.valueField,r);return q?q.get(p.displayField):p.valueNotFoundText;};};var n=Ext.create("Ext.data.Store",{fields:["crystalClassCode","crystalClassName"],data:j.listOfCrystalClass});var a=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:n,valueField:"crystalClassCode",displayField:"crystalClassName",allowBlank:true,typeAhead:true,triggerAction:"all",listConfig:{cls:"small-combo-text"}});
var e=[{text:"Experiment<br/>Type",dataIndex:"experimentType",renderer:f,flex:0.1},{text:"Acronym<br/>Sample name",dataIndex:"sampleNameProtein",hidden:j.proteinSampleHidden,renderer:c,flex:0.1},{text:"Image Prefix",dataIndex:"imagePrefix",renderer:g,flex:0.1},{text:"Run#",dataIndex:"runNumber",flex:0.04},{text:"Start time",renderer:h,dataIndex:"dataTime",flex:0.07},{text:"Parameters",renderer:l,flex:0.2},{text:"Results",renderer:m,flex:0.3},{text:"Image Thumbnail",renderer:o,flex:0.15},{text:"Crystal snapshot",renderer:b,flex:0.15},{text:"Graph",renderer:k,flex:0.15},{text:"Second Graph",renderer:d,hidden:j.graph2Hidden,flex:0.15}];
if(j.isFx){if(j.canSave){e.push({text:"Crystal class",dataIndex:"crystalClass",flex:0.1,editor:a,renderer:Ext.util.Format.comboRenderer(a)});}else{e.push({text:"Crystal class",dataIndex:"crystalClass",flex:0.1,renderer:Ext.util.Format.comboRenderer(a)});}}if(j.canSave){e.push({text:"Comments",dataIndex:"comments",editor:{xtype:"textfield",allowBlank:true},flex:0.15,renderer:c});
}else{e.push({text:"Comments",dataIndex:"comments",flex:0.15,renderer:c});}return e;};SessionViewGrid.prototype.saveGraphAsImg=function(){var j=this;var b=[];var f=[];for(var e=0;e<j.listChartId.length;e++){var a="chart_"+j.listChartId[e];var g=Ext.getCmp(a);var c=document.getElementById("canvas_"+j.listChartId[e]);
if(g){var h=g.el.dom.innerHTML;canvg("canvas_"+j.listChartId[e],h);var d=c.toDataURL();f.push(j.listChartId[e]);b.push(d);}}j.onExportReportWithGraphSelected.notify({"listSvg":b,"sessionId":j.sessionId,"listId":f});};SessionViewGrid.prototype.getSessionId=function(){return this.sessionId;};SessionViewGrid.prototype.getNbOfItems=function(){return this.nbOfItems;
};SessionViewGrid.prototype.getListData=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};function addEvent(c,b,a){if(c.attachEvent){c.attachEvent("on"+b,a);}else{c.addEventListener(b,a,true);}}function onLoadPage(){var b=new Date().getTime();var a=setInterval(function(){if(new Date().getTime()-b>18000000){clearInterval(a);
return;}archivedRefresh();},59000);}function archivedRefresh(){var a="viewDataCollection.do?reqCode=updateArchiving";$.ajax({type:"get",url:a,success:function(c){var b=document.getElementById("pyarchArchivedDiv");b.innerHTML=c;}});}function WallImagePanel(a){var b=this;this.width=1380;this.height=800;
if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}ImageModel=Ext.define("ImageModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"url"},{name:"target"},{name:"size",type:"float"}]});}WallImagePanel.prototype.prepareData=function(e){this.features=[];var a=e;
for(var b=0;b<a.length;b++){var d={};var c=d.name=a[b].fileName;d.url="imageDownload.do?reqCode=getImageJpgThumb&imageId="+a[b].imageId;d.size=125;d.target="viewResults.do?reqCode=viewJpegImage&imageId="+a[b].imageId+"&previousImageId="+a[b].previousImageId+"&nextImageId="+a[b].nextImageId;this.features.push(d);
}};WallImagePanel.prototype.getPanel=function(e){var d=this;this.prepareData(e);this.store=Ext.create("Ext.data.Store",{model:"ImageModel"});this.store.loadData(this.features,false);var b=[];if(e&&e.length>0){b.push({xtype:"displayfield",name:"location",labelWidth:175,width:"100%",fieldLabel:"Location",value:e[0].fileLocation});
}var c=(this.features.length*125/this.width)+1;var a=Ext.create("Ext.view.View",{store:this.store,tpl:['<tpl for=".">','<div class="thumb-wrap"  id="{name:stripTags}">','<div  class="thumb"><a href="{target}" ><img src="{url}" title="{name:htmlEncode}" border="0" width="{size}" height="{size}"></a></div>',"</div>","</tpl>",'<div class="x-clear"></div>'],multiSelect:false,height:200*c,trackOver:true,emptyText:"No images to display",prepareData:function(f){Ext.apply(f,{shortName:Ext.util.Format.ellipsis(f.name,45),sizeString:Ext.util.Format.fileSize(f.size)});
return f;}});b.push(a);d.panel=Ext.create("Ext.Panel",{width:"100%",autoScroll:true,layout:"vbox",border:0,items:b});return d.panel;};function WebPanel(a){var b=this;this.width=1380;this.height=700;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}WebPanel.prototype.getPanel=function(b){var c=this;
var a="viewResults.do?reqCode=displayEDNAFile&EDNAFilePath="+b.fileFullPath;c.panel=Ext.create("Ext.Panel",{layout:"fit",autoScroll:true,html:b.fullFileContent});return c.panel;};function WorkflowPanel(a){var b=this;this.width=1380;this.height=700;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}}WorkflowPanel.prototype.getPanel=function(d){var g=this;var h="font-weight:bold;";var n=d.workflowVO;var f="../images/Sphere_White_12.png";var e="";if(n.status){e=n.status;}if(e){if(e.search("Error")!=-1||e.search("Failure")!=-1){f="../images/Sphere_Red_12.png";}else{if(e.search("Started")!=-1||e.search("Launched")!=-1){f="../images/Sphere_Orange_12.png";
}else{if(e.search("Success")!=-1){f="../images/Sphere_Green_12.png";}}}}var o=false;if(n&&n.dataFile&&n.dataFile.existFile){o=(n.dataFile.existFile==1);}var p="";if(n&&n.dataFile&&n.dataFile.fileName){p=n.dataFile.fileName;}var b=new Ext.Button({text:p,style:{marginBottom:"10px"},handler:function(){window.location.href="viewDataCollection.do?reqCode=downloadFile&fullFilePath="+n.dataFile.fileFullPath;
},disabled:!o});var c=false;if(n.logFile&&n.logFile.existFile){c=n.logFile.existFile==1;}var a="";if(n&&n.logFile&&n.logFile.fileName){a=n.logFile.fileName;}var m=new Ext.Button({text:a,style:{marginBottom:"10px"},handler:function(){window.location.href="viewDataCollection.do?reqCode=downloadFile&fullFilePath="+n.logFile.fileFullPath;
},disabled:!c});var l="";var k="";if(n&&n.workflowMesh){l=n.workflowMesh.value1;k=n.workflowMesh.value2;}var j=[{xtype:"field",name:"icon",fieldSubTpl:new Ext.XTemplate("<img src='"+f+"' border=0/>")},{xtype:"displayfield",name:"title",fieldLabel:"Title",labelStyle:h,value:n.workflowTitle},{xtype:"textareafield",name:"comments",fieldLabel:"Comments",readOnly:true,columns:30,width:500,rows:7,labelStyle:h,value:n.comments},{xtype:"textareafield",name:"status",fieldLabel:"Status",labelStyle:h,readOnly:true,columns:30,width:500,rows:4,value:n.status}];
if(d.displayMesh==1){j.push({xtype:"displayfield",name:"value1",fieldLabel:"Value 1",labelStyle:h,value:l},{xtype:"displayfield",name:"value2",fieldLabel:"Value 2",labelStyle:h,value:k});}if(a!=""){j.push(m);}if(p!=""){j.push(b);}if(c){j.push({xtype:"textareafield",labelStyle:h,name:"logFileTxt",fieldLabel:"Log File",readOnly:true,columns:30,width:800,rows:15,value:n.logFile.fullFileContent});
}g.panel=Ext.widget({xtype:"form",layout:{type:"vbox"},collapsible:false,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",items:j});return g.panel;};function XRFSpectraGrid(b){this.onSaveButtonClicked=new Event(this);var a=false;this.contextPath="";
this.title="XRFSpectra";this.listOfCrystalClass=[];this.canSave=false;if(b!=null){if(b.height!=null){this.height=b.height;}if(b.isFx!=null){this.isFx=b.isFx;}if(b.contextPath!=null){this.contextPath=b.contextPath;}if(b.title!=null){this.title=b.title;}if(b.listOfCrystalClass!=null){this.listOfCrystalClass=b.listOfCrystalClass;
}if(b.sessionId!=null){this.sessionId=b.sessionId;}if(b.canSave!=null){this.canSave=b.canSave;}}this._setCrystalClass();Ext.define("XRFSpectraModel",{extend:"Ext.data.Model",fields:[{name:"xfeFluorescenceSpectrumId",mapping:"xfeFluorescenceSpectrumId"},{name:"fittedDataFileFullPath",mapping:"fittedDataFileFullPath"},{name:"startTime",mapping:"startTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"endTime",mapping:"endTime",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"sampleName",mapping:"sampleName"},{name:"crystalClass"},{name:"comments",mapping:"comments"},{name:"scanFileFullPath",mapping:"scanFileFullPath"},{name:"jpegScanFileFullPath",mapping:"jpegScanFileFullPath"},{name:"filename",mapping:"filename"},{name:"energy",mapping:"energy"},{name:"exposureTime",mapping:"exposureTime"},{name:"beamTransmission",mapping:"beamTransmission"},{name:"annotatedPymcaXfeSpectrum",mapping:"annotatedPymcaXfeSpectrum"},{name:"beamSizeVertical",mapping:"beamSizeVertical"},{name:"beamSizeHorizontal",mapping:"beamSizeHorizontal"},{name:"blSampleVO",mapping:"blSampleVO"},{name:"jpegScanExists",mapping:"jpegScanExists"},{name:"jpegScanFileFullPathParser",mapping:"jpegScanFileFullPathParser"},{name:"annotatedPymcaXfeSpectrumExists",mapping:"annotatedPymcaXfeSpectrumExists"},{name:"shortFileNameAnnotatedPymcaXfeSpectrum",mapping:"shortFileNameAnnotatedPymcaXfeSpectrum"}],idProperty:"xfeFluorescenceSpectrumId"});
}XRFSpectraGrid.prototype.getFilterTypes=function(){return[];};XRFSpectraGrid.prototype._sort=function(a){a.sort("startTime","DESC");};XRFSpectraGrid.prototype._setCrystalClass=function(){this.crystalClass=[];for(var a=0;a<this.listOfCrystalClass.length;a++){this.crystalClass.push(listOfCrystalClass[a].crystalClassName);
}};XRFSpectraGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(a);};XRFSpectraGrid.prototype.refresh=function(a){this.features=a.xrfSpectraList;this.store.loadData(this.features,false);};XRFSpectraGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;
};XRFSpectraGrid.prototype.renderGrid=function(){var f=this;var d=[];var a=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"XRFSpectraModel",autoload:false});this._sort(this.store);this.store.totalCount=this.features.length;this.store.loadData(this.features,false);var c=Ext.create("Ext.Panel",{id:"noXFRDataPanel",layout:{type:"fit"},html:"<html><h4>No XRF Spectra found</h4></html>"});
if(this.features.length==0){return c;}var e=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});var b=[];if(this.canSave){b.push({text:"Save Comments",tooltip:"Save XRF Spectra",icon:"../images/save.gif",handler:function(){f.onSaveButtonClicked.notify({});}});}this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:"100%",model:"XRFSpectraModel",height:"100%",store:this.store,columns:a,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},plugins:[e],tbar:b});
return this.grid;};XRFSpectraGrid.prototype.getListXfeSpectra=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};XRFSpectraGrid.prototype.getSessionId=function(){return this.sessionId;};XRFSpectraGrid.prototype._getColumns=function(){var j=this;function g(n,o,m){return Ext.Date.format(n,"d-m-Y H:i:s");
}function c(m){if(m){return'<div style="white-space:normal !important;word-wrap: break-word;">'+m+"</div>";}else{return"";}}function k(q,r,m){if(m.data.crystalClass!=null){var o=m.data.crystalClass;for(var n=0;n<j.listOfCrystalClass.length;n++){var s=j.listOfCrystalClass[n].crystalClassCode;if(s==o){return j.listOfCrystalClass[n].crystalClassName;
}return o;}}else{return"";}}Ext.util.Format.comboRenderer=function(m){return function(o){var n=m.findRecord(m.valueField,o);return n?n.get(m.displayField):m.valueNotFoundText;};};function f(n,o,m){if(n==null){return"";}return Number(n).toFixed(3);}function h(n,o,m){if(n==null){return"";}return Number(n).toFixed(1);
}function e(n,o,m){if(!m.data.jpegScanExists){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Spectrum not found:<br>"+n+"</h4></div>";}else{return"<a href='viewResults.do?reqCode=viewJpegImageFromFile&file="+m.data.jpegScanFileFullPathParser+"'>"+"<img width='150' height='110' src='imageDownload.do?reqCode=getImageJpgFromFile&file="+m.data.jpegScanFileFullPathParser+"'  border='0' alt='Click to zoom the image' ></a>";
}}function b(n,o,m){if(!m.data.annotatedPymcaXfeSpectrumExists){return"<div style='white-space:normal !important;word-wrap: break-word;'><h4>Html report not found:<br>"+n+"</h4></div>";}else{return"<div style='white-space:normal !important;word-wrap: break-word;'>"+"<a  href='viewDataCollection.do?reqCode=downloadFile&fullFilePath= "+m.data.annotatedPymcaXfeSpectrum+"'  styleClass='LIST'>"+"<img src='../images/download.png' alt='Click to download the report' >"+"</a><br>"+"<a  href='viewResults.do?reqCode=displayHtmlFile&HTML_FILE="+m.data.annotatedPymcaXfeSpectrum+"'  styleClass='LIST'>"+m.data.shortFileNameAnnotatedPymcaXfeSpectrum+"</a></div>";
}}var l=Ext.create("Ext.data.Store",{id:0,fields:["crystalClassCode","crystalClassName"],data:j.listOfCrystalClass});var a=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:l,valueField:"crystalClassCode",displayField:"crystalClassName",allowBlank:true,typeAhead:true,triggerAction:"all"});var d=[{text:"Energy<br>(keV)",dataIndex:"energy",flex:0.075,renderer:f,id:"energy"},{text:"Sample name",dataIndex:"sampleName",flex:0.1},{text:"Exposure<br>Time<br>(s)",dataIndex:"exposureTime",flex:0.075,id:"exposureTime"},{text:"Start Time",dataIndex:"startTime",renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s"),flex:0.15},{text:"End Time",dataIndex:"endTime",renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s"),flex:0.15},{text:"Beam&nbsp;size Hor.<br>(&#181m)",dataIndex:"beamSizeHorizontal",flex:0.15},{text:"Beam&nbsp;size Ver.<br>(&#181m)",dataIndex:"beamSizeVertical",flex:0.15},{text:"Transm.<br>Factor<br>(%)",dataIndex:"beamTransmission",flex:0.15},{text:"Spectrum",dataIndex:"jpegScanFileFullPath",renderer:e,flex:0.2},{text:"Html Report",dataIndex:"annotatedPymcaXfeSpectrum",renderer:b,flex:0.15}];
if(j.isFx){d.push({text:"Crystal class",dataIndex:"crystalClass",flex:0.2,editor:a,renderer:Ext.util.Format.comboRenderer(a)});}if(this.canSave){d.push({text:"Comments",dataIndex:"comments",editor:{xtype:"textfield",allowBlank:true},flex:0.2,renderer:c});}else{d.push({text:"Comments",dataIndex:"comments",flex:0.2,renderer:c});
}return d;};XRFSpectraGrid.prototype.getListXRFSpectra=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};function XtalSnapshotPanel(a){var b=this;this.width=1200;this.height=250;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}XtalSnapshotPanel.prototype.getPanel=function(b){var d=this;
var a=[];if(b){a.push({xtype:"displayfield",name:"location",labelWidth:175,width:this.width,fieldLabel:"Expected Snapshots location",value:b.fileLocation});}if(b&&b.filePresent){var c=Ext.create("Ext.draw.Component",{width:316,height:197,listeners:{el:{click:function(){window.location.href="viewResults.do?reqCode=viewJpegImageFromFile&file="+b.fileLocation;
}}},items:[{type:"image",src:"imageDownload.do?reqCode=getImageJpgFromFile&file="+b.fileLocation,width:316,height:197}]});a.push(c);}d.panel=Ext.create("Ext.Panel",{layout:"fit",width:"100%",border:0,items:a});return d.panel;};Ext.Loader.setConfig({enabled:true});Ext.QuickTips.init();var IspybAutoProcRanking={start:function(a){this.tartgetId=a;
Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.grid.*","Ext.data.*","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.layout.container.Fit","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
this.showChartTabs(a);},showChartTabs:function(b){var a=new AutoProcRankingData();a.autoProcRankingRetrieved.attach(function(d,h){var g=new StackedBarChart(b);var j=new RadarChart(b);var f=new ChartPanel(b);var c=new LineChart(b);var e=Ext.create("Ext.tab.Panel",{renderTo:b,width:800,height:500,activeTab:0,defaults:{bodyPadding:0},items:[{tabConfig:{id:"barChart",title:"Stacked bar chart"},items:[g.getPanel(h)]},{tabConfig:{id:"radarChart",title:"Radar chart"},items:[j.getPanel(h)]},{tabConfig:{id:"lineChart",title:"Line chart"},items:[c.getPanel(h)]}]});
});a.getAutoProcRanking();}};function AutoProcRankingData(a){this.type="POST";this.json=a;this.autoProcRankingRetrieved=new Event(this);this.onError=new Event(this);}AutoProcRankingData.prototype.getAutoProcRanking=function(){var a=this;$.ajax({type:this.type,url:"autoProcRanking.do?reqCode=getAutoProcData",data:{},datatype:"text/json",success:function(b){a.autoProcRankingRetrieved.notify(b);
},error:function(d,b,c){a.onError.notify(d.responseText);}});};function LineChart(a){var b=this;this.targetId=a;this.store=null;this.chart=null;this.panel=null;}LineChart.prototype.formatData=function(b){var e=this;var c=[];for(i=0;i<b.length;i++){var a={dataCollectionId:b[i].dataCollectionId,imgPrefix:b[i].imagePrefix,rFactor:b[i].overallRFactorValue,highestResolution:b[i].highestResolutionValue,completeness:b[i].completenessValue};
c.push(a);}e.store=Ext.create("Ext.data.JsonStore",{fields:["dataCollectionId","imgPrefix","rFactor","highestResolution","completeness"],data:c});};LineChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",legend:{position:"right"},axes:[{type:"Numeric",minimum:0,position:"left",fields:["rFactor","highestResolution","completeness"],minorTickSteps:1,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["imgPrefix"],label:{font:"9px Arial",rotate:{degrees:300}}}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"imgPrefix",yField:"rFactor",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",smooth:true,xField:"imgPrefix",yField:"highestResolution",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",smooth:true,xField:"imgPrefix",yField:"completeness",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};LineChart.prototype.getPanel=function(c){var e=this;e.formatData(c);e.getChart();var b=function(f){if(f.id=="saveAsImageBtnL"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnL",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{width:800,height:400,tbar:a,layout:"fit",items:e.chart});return e.panel;};function RadarChart(a){var b=this;this.targetId=a;this.store=null;this.chart=null;this.panel=null;}RadarChart.prototype.formatData=function(b){var e=this;var c=[];for(i=0;i<b.length;i++){var a={dataCollectionId:b[i].dataCollectionId,imgPrefix:b[i].imagePrefix+" "+b[i].dataCollectionNumber,rFactor:b[i].overallRFactorValue,highestResolution:b[i].highestResolutionValue,completeness:b[i].completenessValue};
c.push(a);}e.store=Ext.create("Ext.data.JsonStore",{fields:["dataCollectionId","imgPrefix","rFactor","highestResolution","completeness"],data:c});};RadarChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{id:"chartCmp",xtype:"chart",style:"background:#fff",theme:"Category2",insetPadding:20,animate:true,store:a.store,legend:{position:"right"},axes:[{type:"Radial",position:"radial",label:{display:true}}],series:[{showInLegend:true,type:"radar",xField:"imgPrefix",yField:"rFactor",style:{opacity:0.4}},{showInLegend:true,type:"radar",xField:"imgPrefix",yField:"highestResolution",style:{opacity:0.5}},{showInLegend:true,type:"radar",xField:"imgPrefix",yField:"completeness",style:{opacity:0.4}}]});
return a.chart;};RadarChart.prototype.getPanel=function(c){var e=this;e.formatData(c);e.getChart();var b=function(f){if(f.id=="saveAsImageBtnR"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtnR",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{width:800,height:400,tbar:a,layout:"fit",items:e.chart});return e.panel;};function StackedBarChart(a){var b=this;this.targetId=a;this.store=null;this.chart=null;this.panel=null;}StackedBarChart.prototype.formatData=function(b){var e=this;var c=[];for(i=0;i<b.length;
i++){var a={dataCollectionId:b[i].dataCollectionId,imgPrefix:b[i].imagePrefix+" "+b[i].dataCollectionNumber,rFactor:b[i].overallRFactorValue,highestResolution:b[i].highestResolutionValue,completeness:b[i].completenessValue};c.push(a);}e.store=Ext.create("Ext.data.JsonStore",{fields:["dataCollectionId","imgPrefix","rFactor","highestResolution","completeness"],data:c});
};StackedBarChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",animate:true,shadow:true,store:a.store,legend:{position:"right"},axes:[{type:"Numeric",position:"bottom",fields:["rFactor","highestResolution","completeness"],title:false,grid:true},{type:"Category",position:"left",fields:["imgPrefix"],title:false}],series:[{type:"bar",axis:"bottom",gutter:80,xField:"dataCollectionId",yField:["rFactor","highestResolution","completeness"],stacked:true,tips:{trackMouse:true,width:65,height:28,renderer:function(c,b){this.setTitle(String(b.value[1]));
}}}]});return a.chart;};StackedBarChart.prototype.getPanel=function(c){var e=this;e.formatData(c);e.getChart();var b=function(f){if(f.id=="saveAsImageBtn"){e.chart.save({type:"image/png"});}};var d=new Ext.Button({id:"saveAsImageBtn",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});
var a=new Ext.Toolbar({items:[d]});this.panel=Ext.create("Ext.Panel",{width:800,height:400,tbar:a,layout:"fit",items:e.chart});return e.panel;};function ChartPanel(a){var b=this;this.width="800";this.height="500";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}this.data=null;}ChartPanel.prototype.getPanel=function(c){var e=this;e.data=c;var b=function(f){if(f.id=="saveAsImageBtn2"){}};var d=new Ext.Button({id:"saveAsImageBtn2",text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});this.panel=Ext.create("Ext.Panel",{id:"panelParallelChart",width:this.width,height:this.height,tbar:a,layout:{type:"vbox",align:"stretch",bodyPadding:0,border:0},listeners:{"afterrender":function(f){e.postRender();
}},html:"<div id='mainContent'></div>"});return this.panel;};ChartPanel.prototype.postRender=function(){var b=this;var a=[];if(b.data.length==0){a.push({border:0,padding:0,html:BUI.getWarningHTML("No data have been found.")});}a.push(new ParallelChart("mainContent").render(b.data));};function AutoProcActionPanel(a){var b=this;
this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.autoProcReportPanel=null;}AutoProcActionPanel.prototype.getPanel=function(b){var c=this;var a=[];c.autoProcParamPanel=new AutoProcParamPanel();a.push(c.autoProcParamPanel.getPanel(b));
c.panel=Ext.widget({xtype:"form",layout:{type:"hbox"},collapsible:true,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",items:a});c.addReport(b);return c.panel;};AutoProcActionPanel.prototype.addReport=function(a){var b=this;if(b.autoProcReportPanel==null&&a&&a.autoProcDetail){b.autoProcReportPanel=new AutoProcReportPanel();
b.panel.add(b.autoProcReportPanel.getPanel(a));b.panel.doLayout();}};AutoProcActionPanel.prototype.setSelectedAutoProc=function(a){var b=this;b.addReport(a);b.autoProcReportPanel.setSelectedAutoProc(a);b.panel.doLayout();};function AutoProcDataPanel(a){var b=this;this.width="800";this.height="800";this.leftPanel=null;
this.rightPanel=null;this.panel=null;this.onAutoProcGraphSelected=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}AutoProcDataPanel.prototype.getPanel=function(b){var c=this;var a=[];c.leftPanel=new AutoProcLeftPanel();c.rightPanel=new AutoProcRightPanel();
c.rightPanel.onAutoProcGraphSelected.attach(function(f,e){var d=e.autoProcProgramAttachmentId;c.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":d});});a.push(c.leftPanel.getPanel(b));a.push(c.rightPanel.getPanel(b));c.panel=Ext.widget({xtype:"form",layout:{type:"hbox"},collapsible:false,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",items:a});
return c.panel;};AutoProcDataPanel.prototype.setSelectedAutoProc=function(a){var b=this;b.leftPanel.setSelectedAutoProc(a);b.rightPanel.setSelectedAutoProc(a);};AutoProcDataPanel.prototype.displayGraphAttachment=function(a){var b=this;b.rightPanel.displayGraphAttachment(a);};function AutoProcFilePanel(a){var b=this;
this.width=600;this.height=700;this.onAutoProcGraphSelected=new Event(this);this.noFilePanel=null;this.filesPanel=null;this.graphPanel=null;this.data=null;this.autoProcPlotStore=null;this.autoProcPlot=null;this.graphCombo=null;this.bodyStyle="background-color:#dfe8f5;";this.type=1;if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}if(a.type!=null){this.type=a.type;}}Ext.define("AutoProcPlotModel",{extend:"Ext.data.Model",fields:[{type:"string",name:"autoProcProgramAttachmentId"},{type:"string",name:"fileName"}]});}AutoProcFilePanel.prototype.isAttachmentInStep=function(a){return((this.type==1&&a=="XDS")||(this.type==2&&a=="XSCALE")||(this.type==3&&a=="SCALA")||(this.type==4&&a=="SCALEPACK")||(this.type==5&&a=="TRUNCATE"));
};AutoProcFilePanel.prototype.getItems=function(v){var o=this;var a="font-weight:bold;";var l=[];var d={xtype:"displayfield",fieldLabel:"Input Files",labelStyle:a};var c={xtype:"displayfield",fieldLabel:"Log Files",labelStyle:a};var f={xtype:"displayfield",fieldLabel:"Output Files",labelStyle:a};var h={xtype:"displayfield",fieldLabel:"Correction Files",labelStyle:a,labelWidth:300};
var j=[];var g=[];var k=[];var q=[];var u=[];if(v&&v.autoProcDetail&&v.autoProcDetail.autoProcProgAttachmentsWebBeans){for(var p=0;p<v.autoProcDetail.autoProcProgAttachmentsWebBeans.length;p++){attachment=v.autoProcDetail.autoProcProgAttachmentsWebBeans[p];if(attachment.ispybAutoProcAttachment&&o.isAttachmentInStep(attachment.ispybAutoProcAttachment.step)){var n=attachment.ispybAutoProcAttachment.fileCategory;
var r="viewResults.do?reqCode=displayAutoProcProgAttachment&autoProcProgramAttachmentId="+attachment.autoProcProgramAttachmentId;if(n=="correction"){r="viewResults.do?reqCode=displayCorrectionFile&fileName="+attachment.fileName;}var t=[];var b=new Ext.Button({text:attachment.fileName,href:r,hrefTarget:"_self",tooltip:attachment.ispybAutoProcAttachment.description});
t.push(b);var m=attachment.ispybAutoProcAttachment.hasGraph;if(m==true){var e=new Ext.Button({id:""+attachment.autoProcProgramAttachmentId,name:""+attachment.fileName,tooltip:"View Graph",icon:"../images/icon_graph.png",handler:function(w){o.updateGraph(w.name);},style:{marginLeft:"10px"}});t.push(e);
}var s=Ext.create("Ext.Panel",{layout:{type:"hbox",align:"LEFT",bodyPadding:10},border:0,bodyStyle:o.bodyStyle,collapsible:false,frame:false,style:{marginBottom:"10px",marginTop:"10px"},items:t});if(n=="input"){j.push(s);}else{if(n=="output"){k.push(s);}else{if(n=="log"){g.push(s);}else{if(n=="correction"){q.push(s);
}}}}}}if(j.length>0){l.push(d);}for(var p=0;p<j.length;p++){l.push(j[p]);}if(g.length>0){l.push(c);}for(var p=0;p<g.length;p++){l.push(g[p]);}if(k.length>0){l.push(f);}for(var p=0;p<k.length;p++){l.push(k[p]);}if(q.length>0){l.push(h);}for(var p=0;p<q.length;p++){l.push(q[p]);}}return l;};AutoProcFilePanel.prototype.getPanel=function(d){var e=this;
e.data=d;var a=e.getItems(d);var b=e.getHtml(a);var c=e.getLayout(a);e.graphPanel=Ext.create("Ext.Panel",{layout:{type:"fit"},bodyBorder:false,bodyStyle:e.bodyStyle,collapsible:false,frame:false,items:[]});e.noFilePanel=Ext.create("Ext.Panel",{layout:{type:"fit"},bodyBorder:false,bodyStyle:e.bodyStyle,collapsible:false,frame:false,html:b});
e.filesPanel=Ext.create("Ext.Panel",{layout:{type:"vbox"},bodyBorder:false,bodyStyle:e.bodyStyle,collapsible:false,frame:false,items:a});e.panel=Ext.create("Ext.Panel",{layout:{type:"fit"},bodyStyle:e.bodyStyle,collapsible:false,frame:false,items:[e.noFilePanel,e.filesPanel,e.graphPanel]});return e.panel;
};AutoProcFilePanel.prototype.getHtml=function(a){var b="";if(a.length==0){b="<html><h4>No Files have been found</h4></html>";}return b;};AutoProcFilePanel.prototype.getLayout=function(a){var b="vbox";if(a.length==0){b="fit";}return b;};AutoProcFilePanel.prototype.setSelectedAutoProc=function(d){var e=this;
e.data=d;var c;while(c=e.filesPanel.items.first()){e.filesPanel.remove(c,true);}e.filesPanel.doLayout();var a=e.getItems(d);var b=e.getHtml(a);e.filesPanel.add(a);e.noFilePanel.update(b);e.cleanGraphPanel();e.panel.doLayout();};AutoProcFilePanel.prototype.updateGraph=function(c){var d=this;var a=-1;for(var b=0;
b<d.data.autoProcDetail.autoProcProgAttachmentsWebBeans.length;b++){if(c==d.data.autoProcDetail.autoProcProgAttachmentsWebBeans[b].fileName){a=d.data.autoProcDetail.autoProcProgAttachmentsWebBeans[b].autoProcProgramAttachmentId;break;}}if(a!=-1){d.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":a});
}};AutoProcFilePanel.prototype.cleanGraphPanel=function(){var b=this;var a;while(a=b.graphPanel.items.first()){b.graphPanel.remove(a,true);}b.graphPanel.doLayout();};AutoProcFilePanel.prototype.displayGraphAttachment=function(d){var e=this;e.cleanGraphPanel();var b=[];var c=[];c.width=e.width;c.height=e.height;
var a=new AutoProcProgramAttachmentGraphPanel(c);b.push(a.getPanel(d));e.graphPanel.add(b);e.graphPanel.doLayout();e.panel.doLayout();};function AutoProcGrid(b){this.onRowClicked=new Event(this);var a="";this.title="Autoprocessing Summary (click on an entry for more details)";this.contextPath="";if(b!=null){if(b.height!=null){this.height=b.height;
}if(b.contextPath!=null){this.contextPath=b.contextPath;}}this.selectedRow=null;Ext.define("autoProcModel",{extend:"Ext.data.Model",fields:[{name:"autoProcId",mapping:"autoProcId"},{name:"name",mapping:"name"},{name:"spaceGroup",mapping:"spaceGroup"},{name:"anomalous",mapping:"anomalous"},{name:"cellA",mapping:"cellA"},{name:"cellB",mapping:"cellB"},{name:"cellC",mapping:"cellC"},{name:"cellAlpha",mapping:"cellAlpha"},{name:"cellBeta",mapping:"cellBeta"},{name:"cellGamma",mapping:"cellGamma"}]});
}AutoProcGrid.prototype.getFilterTypes=function(){return[];};AutoProcGrid.prototype._prepareData=function(b){var c=[];if(b&&b.autoProcList){for(var a=0;a<b.autoProcList.length;a++){c.push(b.autoProcList[a]);}}return c;};AutoProcGrid.prototype.getGrid=function(a){this.features=this._prepareData(a);return this.renderGrid();
};AutoProcGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;};AutoProcGrid.prototype.renderGrid=function(){var g=this;var e=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"autoProcModel",autoload:false,groupField:"anomalous"});this._sort(this.store);
this.store.totalCount=this.features.length;this.store.loadData(this.features,false);var f=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{columnName}: {name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})',hideGroupedHeader:true,startCollapsed:false}),b=this.store.getGroups(),a=b.length,d=0,c=function(h){var j=h.text;
if(h.checked){f.expand(j,true);}else{f.collapse(j,true);}};this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:600,model:"autoProcModel",height:"100%",cls:"autoproc-grid",store:this.store,columns:e,features:[f],title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},listeners:{itemclick:function(n,h,m,j,o,k){var l=n.getSelectionModel().getSelection()[0];
g.selectAutoProc(l.get("autoProcId"));}}});return this.grid;};AutoProcGrid.prototype.setSelectedAutoProcId=function(b){var d=this;var c=-1;for(var a=0;a<this.features.length;a++){if(b==this.features[a].autoProcId){c=a;break;}}if(c!=-1){d.grid.getView().select(c);}};AutoProcGrid.prototype.selectAutoProc=function(a){this.selectedRow=a;
this.onRowClicked.notify({"autoProcId":a});};AutoProcGrid.prototype._sort=function(a){};AutoProcGrid.prototype._getColumns=function(){var c=this;function b(d){if(d){return'<div style="white-space:normal !important;">'+d+"</div>";}else{return"";}}var a=[{text:"Method",dataIndex:"name",flex:0.4},{text:"Anomalous",dataIndex:"anomalous",flex:0.2},{text:"Point<br/>Group",dataIndex:"spaceGroup",flex:0.2},{text:"Cell<br/>A",dataIndex:"cellA",flex:0.1},{text:"Cell<br/>B",dataIndex:"cellB",flex:0.1},{text:"Cell<br/>C",dataIndex:"cellC",flex:0.1},{text:"Cell<br/>Alpha",dataIndex:"cellAlpha",flex:0.1},{text:"Cell<br/>Beta",dataIndex:"cellBeta",flex:0.1},{text:"Cell<br/>Gamma",dataIndex:"cellGamma",flex:0.1}];
return a;};function AutoProcLeftPanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}AutoProcLeftPanel.prototype.getPanel=function(b){var c=this;var a="font-weight:bold;";c.panel=Ext.widget({xtype:"form",layout:{type:"vbox"},collapsible:false,frame:true,title:"Main Output Parameters",bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:150},defaultType:"textfield",items:[{xtype:"displayfield",fieldLabel:"Overall",labelStyle:a},{xtype:"displayfield",fieldLabel:"Overall Resolution",id:"overallResolution",value:b.autoProcDetail.overallResolution},{xtype:"displayfield",fieldLabel:"Overall Completeness",id:"overallCompleteness",value:b.autoProcDetail.overallCompleteness},{xtype:"displayfield",fieldLabel:"Overall I over Sigma",id:"overallIOverSigma",value:b.autoProcDetail.overallIOverSigma},{xtype:"displayfield",fieldLabel:"Overall Rsymm",id:"overallRsymm",value:b.autoProcDetail.overallRsymm},{xtype:"displayfield",fieldLabel:"Overall Multiplicity",id:"overallMultiplicity",value:b.autoProcDetail.overallMultiplicity},{xtype:"displayfield",fieldLabel:"Outer Shell",labelStyle:a},{xtype:"displayfield",fieldLabel:"Outer Shell Resolution",id:"outerResolution",value:b.autoProcDetail.outerResolution},{xtype:"displayfield",fieldLabel:"Outer Shell Completeness",id:"outerCompleteness",value:b.autoProcDetail.outerCompleteness},{xtype:"displayfield",fieldLabel:"Outer Shell I over Sigma",id:"outerIOverSigma",value:b.autoProcDetail.outerIOverSigma},{xtype:"displayfield",fieldLabel:"Outer Shell Rsymm",id:"outerRsymm",value:b.autoProcDetail.outerRsymm},{xtype:"displayfield",fieldLabel:"Outer Shell Multiplicity",id:"outerMultiplicity",value:b.autoProcDetail.outerMultiplicity},{xtype:"displayfield",fieldLabel:"Unit Cell",labelStyle:a},{xtype:"displayfield",fieldLabel:"Unit Cell A",id:"unitCellA",value:b.autoProcDetail.unitCellA},{xtype:"displayfield",fieldLabel:"Unit Cell B",id:"unitCellB",value:b.autoProcDetail.unitCellB},{xtype:"displayfield",fieldLabel:"Unit Cell C",id:"unitCellC",value:b.autoProcDetail.unitCellC},{xtype:"displayfield",fieldLabel:"Unit Cell Alpha",id:"unitCellAlpha",value:b.autoProcDetail.unitCellAlpha},{xtype:"displayfield",fieldLabel:"Unit Cell Beta",id:"unitCellBeta",value:b.autoProcDetail.unitCellBeta},{xtype:"displayfield",fieldLabel:"Unit Cell Gamma",id:"unitCellGamma",value:b.autoProcDetail.unitCellGamma}]});
return c.panel;};AutoProcLeftPanel.prototype.setSelectedAutoProc=function(a){var c=this;var b=Ext.getCmp("overallResolution");b.setValue(a.autoProcDetail.overallResolution);b=Ext.getCmp("overallCompleteness");b.setValue(a.autoProcDetail.overallCompleteness);b=Ext.getCmp("overallIOverSigma");b.setValue(a.autoProcDetail.overallIOverSigma);
b=Ext.getCmp("overallRsymm");b.setValue(a.autoProcDetail.overallRsymm);b=Ext.getCmp("overallMultiplicity");b.setValue(a.autoProcDetail.overallMultiplicity);b=Ext.getCmp("outerResolution");b.setValue(a.autoProcDetail.outerResolution);b=Ext.getCmp("outerCompleteness");b.setValue(a.autoProcDetail.outerCompleteness);
b=Ext.getCmp("outerIOverSigma");b.setValue(a.autoProcDetail.outerIOverSigma);b=Ext.getCmp("outerRsymm");b.setValue(a.autoProcDetail.outerRsymm);b=Ext.getCmp("outerMultiplicity");b.setValue(a.autoProcDetail.outerMultiplicity);b=Ext.getCmp("unitCellA");b.setValue(a.autoProcDetail.unitCellA);b=Ext.getCmp("unitCellB");
b.setValue(a.autoProcDetail.unitCellB);b=Ext.getCmp("unitCellC");b.setValue(a.autoProcDetail.unitCellC);b=Ext.getCmp("unitCellAlpha");b.setValue(a.autoProcDetail.unitCellAlpha);b=Ext.getCmp("unitCellBeta");b.setValue(a.autoProcDetail.unitCellBeta);b=Ext.getCmp("unitCellGamma");b.setValue(a.autoProcDetail.unitCellGamma);
};function AutoProcListPanel(a){var b=this;this.width="800";this.height="800";this.autoProcGrid=null;this.onAutoProcSelected=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}AutoProcListPanel.prototype.getPanel=function(c){var d=this;var a=[];
var b="";if(c&&c.autoProcList&&c.autoProcList.length>0){d.autoProcGrid=new AutoProcGrid();d.autoProcGrid.onRowClicked.attach(function(g,f){var e=f.autoProcId;d.onAutoProcSelected.notify({"autoProcId":e});});a.push(d.autoProcGrid.getGrid(c));}else{b="<html><h4>No Autoprocessings have been found</h4></html>";
}d.panel=Ext.create("Ext.Panel",{layout:{type:"fit",border:0,bodyPadding:0},collapsible:false,frame:true,items:a,html:b});return d.panel;};AutoProcListPanel.prototype.setSelectedAutoProcId=function(a){var b=this;if(b.autoProcGrid){b.autoProcGrid.setSelectedAutoProcId(a);}};function AutoProcParamPanel(a){var b=this;
this.width="800";this.height="800";this.data=null;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}AutoProcParamPanel.prototype.getPanel=function(a){var b=this;b.data=a;b.panel=Ext.widget({xtype:"form",layout:{type:"hbox"},collapsible:false,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",items:[{fieldLabel:"RSymm threshold in lower shell",name:"rsymm",anchor:"95%",value:a.rMerge},{fieldLabel:"I/Sigma threshold in lower shell",name:"isigma",anchor:"95%",value:a.iSigma,style:{marginLeft:"10px"}}],buttons:[{text:"Update",handler:function(){b.update();
}}]});return b.panel;};AutoProcParamPanel.prototype.update=function(){var d=this;var a=Ext.getCmp(this.panel.getItemId()).getValues().rsymm;var b=Ext.getCmp(this.panel.getItemId()).getValues().isigma;var c=d.data.dataCollectionId;document.location.href="viewResults.do?reqCode=display&dataCollectionId="+c+"&rmerge="+a+"&isigma="+b;
};function AutoProcProgramAttachmentGraph(a){this.type="POST";this.json=a;this.dataRetrieved=new Event(this);this.onError=new Event(this);}AutoProcProgramAttachmentGraph.prototype.getData=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"viewResults.do?reqCode=getAutoProcessingData&autoProcProgramAttachmentId="+a,data:{},datatype:"text/json",success:function(d){c.dataRetrieved.notify(d);
b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});};function AutoProcProgramAttachmentGraphChart(a){var b=this;this.store=null;this.chart=null;this.panel=null;this.width=990;this.height=580;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}}AutoProcProgramAttachmentGraphChart.prototype.getChart=function(){var a=this;a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",axes:[{type:"Numeric",position:"left",fields:[a.xField],title:a.xTitle,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["resolutionLimit"],title:"Resolution",grid:true}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"resolutionLimit",yField:a.xField,markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};AutoProcProgramAttachmentGraphChart.prototype.getPanel=function(e,c,d){var g=this;g.store=e;g.xField=c;g.xTitle=d;g.getChart();var b=function(h){g.chart.save({type:"image/png"});};var f=new Ext.Button({text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[f]});
this.panel=Ext.create("Ext.Panel",{width:this.width,height:this.height,tbar:a,layout:"fit",items:g.chart});return g.panel;};function AutoProcProgramAttachmentGraphPanel(a){var b=this;this.width=1000;this.height=600;this.store=null;this.changeSize=true;if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}if(a.changeSize!=null){this.changeSize=a.changeSize;}}}AutoProcProgramAttachmentGraphPanel.prototype.getPanel=function(v){var n=this;var u=[];var t=[];var g=[];for(i=0;i<v.autoProcessingData.length;i++){var h={resolutionLimit:v.autoProcessingData[i].resolutionLimit,completeness:v.autoProcessingData[i].completeness,rFactorObserved:v.autoProcessingData[i].rFactorObserved,iSigma:v.autoProcessingData[i].iSigma,cc2:v.autoProcessingData[i].cc2,sigAno:v.autoProcessingData[i].sigAno,anomalCorr:v.autoProcessingData[i].anomalCorr,resolution:v.autoProcessingData[i].resolution,wilsonPlot:v.autoProcessingData[i].wilsonPlot,z:v.autoProcessingData[i].z,acent_theor:v.autoProcessingData[i].acent_theor,acent_twin:v.autoProcessingData[i].acent_twin,acent_obser:v.autoProcessingData[i].acent_obser,centric_theor:v.autoProcessingData[i].centric_theor,centric_obser:v.autoProcessingData[i].centric_obser};
u.push(h);if(v.autoProcessingData[i].wilsonPlot!=null){t.push(h);}if(v.autoProcessingData[i].z!=null){g.push(h);}}var c=Ext.create("Ext.data.JsonStore",{fields:["resolutionLimit","completeness","rFactorObserved","iSigma","cc2","sigAno","anomalCorr","resolution","wilsonPlot","z","acent_theor","acent_twin","acent_obser","centric_theor","centric_obser"],data:u});
var q=Ext.create("Ext.data.JsonStore",{fields:["resolutionLimit","completeness","rFactorObserved","iSigma","cc2","sigAno","anomalCorr","resolution","wilsonPlot","z","acent_theor","acent_twin","acent_obser","centric_theor","centric_obser"],data:t});var j=Ext.create("Ext.data.JsonStore",{fields:["resolutionLimit","completeness","rFactorObserved","iSigma","cc2","sigAno","anomalCorr","resolution","wilsonPlot","z","acent_theor","acent_twin","acent_obser","centric_theor","centric_obser"],data:g});
var a=[];a.width=n.width;a.height=n.height;if(n.changeSize){a.width=n.width-10;a.height=n.height-250;}var p=new AutoProcProgramAttachmentGraphChart(a);var o=new AutoProcProgramAttachmentGraphChart(a);var m=new AutoProcProgramAttachmentGraphChart(a);var f=new AutoProcProgramAttachmentGraphChart(a);var e=new AutoProcProgramAttachmentGraphChart(a);
var l=new AutoProcProgramAttachmentGraphChart(a);var k=new WilsonChart(a);var b=new CumulativeIntensityDistributionChart(a);if(v&&v.xscaleLpData){var r=Ext.create("Ext.tab.Panel",{width:this.width,height:this.height,activeTab:0,defaults:{bodyPadding:0},items:[{tabConfig:{title:"I/SigI vs Resolution"},items:[m.getPanel(c,"iSigma","I/Sigl")]},{tabConfig:{title:"Completeness vs Resolution"},items:[p.getPanel(c,"completeness","Completeness")]},{tabConfig:{title:"R-factor vs Resolution"},items:[o.getPanel(c,"rFactorObserved","R-factor")]},{tabConfig:{title:"CC/2 vs Resolution"},items:[f.getPanel(c,"cc2","CC/2")]},{tabConfig:{title:"SigAno vs Resolution"},items:[e.getPanel(c,"sigAno","SigAno")]},{tabConfig:{title:"Anom Corr vs Resolution"},items:[e.getPanel(c,"anomalCorr","Anom Corr")]}]});
n.panel=Ext.create("Ext.Panel",{layout:"fit",width:this.width,height:this.height,items:[r]});}else{if(v&&v.truncateLogData){var r=Ext.create("Ext.tab.Panel",{width:this.width,height:this.height,activeTab:0,defaults:{bodyPadding:0},items:[{tabConfig:{title:"Wilson Plot"},items:[k.getPanel(q)]},{tabConfig:{title:"Cumulative Intensity Distribution"},items:[b.getPanel(j)]}]});
n.panel=Ext.create("Ext.Panel",{layout:"fit",width:this.width,height:this.height,items:[r]});}}return n.panel;};function AutoProcReportPanel(a){var b=this;this.width="410";this.height="100";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.panel=null;}AutoProcReportPanel.prototype.getPanel=function(b){var d=this;
var c="<p>View Data Collection Statistics</p>";var a=d.getItems(b);d.panelReport=Ext.create("Ext.Panel",{layout:{type:"hbox",border:0,bodyPadding:10},border:0,bodyStyle:"background-color:#dfe8f5;",collapsible:false,frame:false,items:a});d.panel=Ext.create("Ext.form.Panel",{layout:{type:"vbox",border:0,bodyPadding:40},border:0,style:{marginLeft:"10px"},fieldDefaults:{msgTarget:"side",labelWidth:200},collapsible:false,frame:true,items:[{xtype:"displayfield",fieldLabel:"View Data Collection Statistics",labelStyle:"font-weight:bold;",value:""},d.panelReport]});
return d.panel;};AutoProcReportPanel.prototype.getItems=function(e){var g=this;var d=null;if(e&&e.autoProcDetail){d=e.autoProcDetail.autoProcId;}var b="";if(e&&e.contextPath){b=e.contextPath;}var a=[];var c=new Ext.Button({icon:"../images/Word.png",href:b+"/user/exportAutoProc.do?reqCode=exportAutoProcAsRtf&autoProcId="+d,hrefTarget:"_self",scale:"large",tooltip:"Export Auto Processing into DOC"});
var f=new Ext.Button({icon:"../images/pdf.png",href:b+"/user/exportAutoProc.do?reqCode=exportAutoProcAsPdf&autoProcId="+d,hrefTarget:"_self",scale:"large",style:{marginLeft:"10px"},tooltip:"Export Auto Processing into PDF"});a.push(c,f);return a;};AutoProcReportPanel.prototype.setSelectedAutoProc=function(c){var d=this;
var b;while(b=d.panelReport.items.first()){d.panelReport.remove(b,true);}var a=d.getItems(c);d.panelReport.add(a);d.panelReport.doLayout();d.panel.doLayout();};function AutoProcRightPanel(a){var b=this;this.width="800";this.height="800";this.onAutoProcGraphSelected=new Event(this);this.data=null;this.tabs=null;
this.xdsPanel=null;this.xscalePanel=null;this.scalaPanel=null;this.scalePackPanel=null;this.truncatePanel=null;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}AutoProcRightPanel.prototype.getPanel=function(b){var c=this;c.data=b;var a=[];a.type=1;c.xdsPanel=new AutoProcFilePanel(a);
c.xdsPanel.onAutoProcGraphSelected.attach(function(f,e){var d=e.autoProcProgramAttachmentId;c.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":d});});a=[];a.type=2;c.xscalePanel=new AutoProcFilePanel(a);c.xscalePanel.onAutoProcGraphSelected.attach(function(f,e){var d=e.autoProcProgramAttachmentId;
c.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":d});});a=[];a.type=3;c.scalaPanel=new AutoProcFilePanel(a);c.scalaPanel.onAutoProcGraphSelected.attach(function(f,e){var d=e.autoProcProgramAttachmentId;c.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":d});});a=[];a.type=4;
c.scalePackPanel=new AutoProcFilePanel(a);c.scalePackPanel.onAutoProcGraphSelected.attach(function(f,e){var d=e.autoProcProgramAttachmentId;c.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":d});});a=[];a.type=5;c.truncatePanel=new AutoProcFilePanel(a);c.truncatePanel.onAutoProcGraphSelected.attach(function(f,e){var d=e.autoProcProgramAttachmentId;
c.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":d});});c.tabs=Ext.create("Ext.tab.Panel",{activeTab:0,width:600,bodyStyle:"background-color:#dfe8f5;",defaults:{bodyPadding:0,autoScroll:true},items:[{title:"XDS",items:[c.xdsPanel.getPanel(b)]},{title:"XSCALE",items:[c.xscalePanel.getPanel(b)]},{title:"SCALA/AIMLESS",items:[c.scalaPanel.getPanel(b)]},{title:"SCALEPACK",items:[c.scalePackPanel.getPanel(b)]},{title:"TRUNCATE",items:[c.truncatePanel.getPanel(b)]}]});
c.panel=Ext.widget({xtype:"form",layout:{type:"fit"},collapsible:false,frame:true,bodyPadding:"5 5 0",title:"Files",fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",tbar:[{text:"Download",tooltip:"Download all attachments for this autoprocessing",icon:"../images/download.png",href:"viewResults.do?reqCode=downloadAttachment&autoProcId="+c.data.autoProcDetail.autoProcId}],items:[c.tabs]});
return c.panel;};AutoProcRightPanel.prototype.setSelectedAutoProc=function(a){var b=this;b.xdsPanel.setSelectedAutoProc(a);b.xscalePanel.setSelectedAutoProc(a);b.scalaPanel.setSelectedAutoProc(a);b.scalePackPanel.setSelectedAutoProc(a);b.truncatePanel.setSelectedAutoProc(a);b.tabs.setActiveTab(0);b.panel.doLayout();
};AutoProcRightPanel.prototype.displayGraphAttachment=function(d){var e=this;var b=e.tabs.getActiveTab();var a=e.tabs.items.indexOf(b);var c=null;if(a==0){c=e.xdsPanel;}else{if(a==1){c=e.xscalePanel;}else{if(a==2){c=e.scalaPanel;}else{if(a==3){c=e.scalePackPanel;}else{if(a==4){c=e.truncatePanel;}}}}}if(c!=null){c.displayGraphAttachment(d);
}e.panel.doLayout();};function AutoProcStatusGrid(b){var a="";this.title="Status History";this.contextPath="";if(b!=null){if(b.height!=null){this.height=b.height;}if(b.contextPath!=null){this.contextPath=b.contextPath;}}this.width=700;Ext.define("statusModel",{extend:"Ext.data.Model",fields:[{name:"blTimeStamp",mapping:"blTimeStamp",type:"date",dateFormat:"d-m-Y H:i:s"},{name:"step",mapping:"step"},{name:"status",mapping:"status"},{name:"comments",mapping:"comments"}]});
}AutoProcStatusGrid.prototype.getFilterTypes=function(){return[];};AutoProcStatusGrid.prototype.getGrid=function(a){this.features=a;return this.renderGrid(this.features);};AutoProcStatusGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;};AutoProcStatusGrid.prototype.renderGrid=function(){var b=this;
var a=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"statusModel",autoload:false});this._sort(this.store);this.store.loadData(this.features,false);this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:this.width,model:"statusModel",height:"100%",store:this.store,columns:a,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"}});
return this.grid;};AutoProcStatusGrid.prototype._sort=function(a){};AutoProcStatusGrid.prototype._getColumns=function(){var c=this;function b(d){if(d){return'<div style="white-space:normal !important;">'+d+"</div>";}else{return"";}}var a=[{text:"Date",dataIndex:"blTimeStamp",flex:0.2,renderer:Ext.util.Format.dateRenderer("d-m-Y H:i:s")},{text:"Step",dataIndex:"step",flex:0.1},{text:"Status",dataIndex:"status",flex:0.1},{text:"Comments",dataIndex:"comments",flex:0.3}];
return a;};AutoProcStatusGrid.prototype.setSelectedAutoProc=function(a){this.features=a;this.store.loadData(this.features,false);};function AutoProcStatusPanel(a){var b=this;this.width="800";this.height="800";this.autoProcStatusGrid=null;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}}AutoProcStatusPanel.prototype.getPanel=function(d){var e=this;var b=[];var c=e.getHtml(d);if(e.hasStatusData(d)){e.autoProcStatusGrid=new AutoProcStatusGrid();var a=e.getDataGrid(d);b.push(e.autoProcStatusGrid.getGrid(a));}e.panel=Ext.create("Ext.Panel",{layout:{type:"fit",border:0,bodyPadding:0},title:"Status History",collapsible:true,frame:true,items:b,html:c});
return e.panel;};AutoProcStatusPanel.prototype.hasStatusData=function(a){return(a&&a.autoProcDetail&&a.autoProcDetail.autoProcEvents&&a.autoProcDetail.autoProcEvents.length>0);};AutoProcStatusPanel.prototype.getHtml=function(b){var c=this;var a="";if(!c.hasStatusData(b)){a="<html><h4>No Status has been found</h4></html>";
}return a;};AutoProcStatusPanel.prototype.getDataGrid=function(b){var c=new Array();if(b&&b.autoProcDetail&&b.autoProcDetail.autoProcEvents){for(var a=0;a<b.autoProcDetail.autoProcEvents.length;a++){c.push(b.autoProcDetail.autoProcEvents[a]);}}return c;};AutoProcStatusPanel.prototype.setSelectedAutoProc=function(e){var g=this;
var c=g.getHtml(e);g.panel.update(c);if(g.hasStatusData(e)){if(g.autoProcStatusGrid==null){var b=new Array();g.autoProcStatusGrid=new AutoProcStatusGrid();var a=g.getDataGrid(e);b.push(g.autoProcStatusGrid.getGrid(a));g.panel.add(b);}else{var a=g.getDataGrid(e);g.autoProcStatusGrid.setSelectedAutoProc(a);
}}else{var d;while(d=g.panel.items.first()){g.panel.remove(d,true);}g.autoProcStatusGrid=null;}g.panel.doLayout();};function AutoprocessingPanel(a){var b=this;this.width="800";this.height="800";this.onAutoProcSelected=new Event(this);this.onAutoProcGraphSelected=new Event(this);this.autoProcListPanel=null;
this.autoProcActionPanel=null;this.autoProcDataPanel=null;this.autoProcStatusPanel=null;this.interruptedAutoProcPanel=null;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}AutoprocessingPanel.prototype.getPanel=function(b){var c=this;c.autoProcListPanel=new AutoProcListPanel();
c.autoProcListPanel.onAutoProcSelected.attach(function(f,e){var d=e.autoProcId;c.onAutoProcSelected.notify({"autoProcId":d});});var a=[];a.push(c.autoProcListPanel.getPanel(b));if(b&&b.autoProcList){c.autoProcActionPanel=new AutoProcActionPanel();a.push(c.autoProcActionPanel.getPanel(b));}if(b&&b.interruptedAutoProcEvents&&b.interruptedAutoProcEvents.length>0){c.interruptedAutoProcPanel=new InterruptedAutoProcPanel();
a.push(c.interruptedAutoProcPanel.getPanel(b));}c.panel=Ext.widget({xtype:"form",layout:{type:"vbox"},collapsible:false,frame:true,items:a});return c.panel;};AutoprocessingPanel.prototype.setSelectedAutoProcId=function(a){var b=this;b.autoProcListPanel.setSelectedAutoProcId(a);};AutoprocessingPanel.prototype.displayGraphAttachment=function(a){var b=this;
b.autoProcDataPanel.displayGraphAttachment(a);};AutoprocessingPanel.prototype.hasStatusData=function(a){return(a&&a.autoProcDetail&&a.autoProcDetail.autoProcEvents&&a.autoProcDetail.autoProcEvents.length>0);};AutoprocessingPanel.prototype.displayAutoProc=function(a){var b=this;Ext.suspendLayouts();if(b.autoProcActionPanel!=null){b.autoProcActionPanel.setSelectedAutoProc(a);
}if(b.autoProcDataPanel==null){b.autoProcDataPanel=new AutoProcDataPanel();b.autoProcDataPanel.onAutoProcGraphSelected.attach(function(e,d){var c=d.autoProcProgramAttachmentId;b.onAutoProcGraphSelected.notify({"autoProcProgramAttachmentId":c});});b.panel.add(b.autoProcDataPanel.getPanel(a));}else{b.autoProcDataPanel.setSelectedAutoProc(a);
}if(b.hasStatusData(a)){if(b.autoProcStatusPanel==null){b.autoProcStatusPanel=new AutoProcStatusPanel();b.panel.add(b.autoProcStatusPanel.getPanel(a));}else{b.autoProcStatusPanel.setSelectedAutoProc(a);}}else{if(b.autoProcStatusPanel==null){}else{b.panel.remove(b.panel.items.last(),true);b.autoProcStatusPanel=null;
}}Ext.resumeLayouts();b.panel.doLayout();};function BeamlinePanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}BeamlinePanel.prototype.getPanel=function(d){var h=this;var j="font-weight:bold;";var b="0 0 20 0";
var n=d.dataCollection;var e=d.beamline;var l=d.session;var f=d.detector;var q="";if(e){if(e.undulatorType1){q+=e.undulatorType1+" ";}if(e.undulatorType2){q+=e.undulatorType2+" ";}if(e.undulatorType3){q+=e.undulatorType3+" ";}}var p="";if(n&&n.flux){p=n.flux.toExponential()+"  photons/sec";}var c="";
if(n&&n.flux_end){c=n.flux_end.toExponential()+"  photons/sec";}var m="";var a="";var o="";var g="";if(f){m=f.detectorType;a=f.detectorModel;o=f.detectorManufacturer;g=f.detectorMode;}var k=[];k.push({xtype:"displayfield",name:"synchrotronName",fieldLabel:"Synchrotron name",labelStyle:j,value:e?e.synchrotronName:""},{xtype:"displayfield",name:"synchrotronMode",fieldLabel:"Synchrotron filling mode",labelStyle:j,value:n?n.synchrotronMode:"",margin:b});
k.push({xtype:"displayfield",name:"beamlineName",fieldLabel:"Beamline name",labelStyle:j,value:l?l.beamlineName:""},{xtype:"displayfield",name:"undulatorTypes",fieldLabel:"Undulator types",labelStyle:j,value:q},{xtype:"displayfield",name:"undulatorGaps",fieldLabel:"Undulator gaps",labelStyle:j,value:n?n.undulatorGaps:"",margin:b});
k.push({xtype:"displayfield",name:"beamTransmission",fieldLabel:"Beam transmission",labelStyle:j,value:n?(n.transmission?(n.transmission.toFixed(0)+" %"):""):""},{xtype:"displayfield",name:"slitGapHorizontalMicro",fieldLabel:"Slit gap Hor",labelStyle:j,value:n?(n.slitGapHorizontalMicro?(n.slitGapHorizontalMicro+" &mu;m"):""):""},{xtype:"displayfield",name:"slitGapVerticalMicro",fieldLabel:"Slit gap Vert",labelStyle:j,value:n?(n.slitGapVerticalMicro?(n.slitGapVerticalMicro+" &mu;m"):""):"",margin:b});
k.push({xtype:"displayfield",name:"detectorType",fieldLabel:"Detector type",labelStyle:j,value:m},{xtype:"displayfield",name:"detectorName",fieldLabel:"Detector name",labelStyle:j,value:a},{xtype:"displayfield",name:"detectorManufacturer",fieldLabel:"Detector manufacturer",labelStyle:j,value:o},{xtype:"displayfield",name:"detectorMode",fieldLabel:"Detector mode",labelStyle:j,value:g},{xtype:"displayfield",name:"detectorPixelSizeHorizontalMicro",fieldLabel:"Detector pixel size Hor",labelStyle:j,value:n?(n.detectorPixelSizeHorizontalMicro?(n.detectorPixelSizeHorizontalMicro+"  mm"):""):""},{xtype:"displayfield",name:"detectorPixelSizeVerticalMicro",fieldLabel:"Detector pixel size Vert",labelStyle:j,value:n?(n.detectorPixelSizeVerticalMicro?(n.detectorPixelSizeVerticalMicro+"  mm"):""):"",margin:b});
k.push({xtype:"displayfield",name:"focusingOptic",fieldLabel:"Focusing optics",labelStyle:j,value:e?e.focusingOptic:""},{xtype:"displayfield",name:"monochromatorType",fieldLabel:"Monochromator type",labelStyle:j,value:e?e.monochromatorType:""},{xtype:"displayfield",name:"beamShape",fieldLabel:"Beam shape",labelStyle:j,value:n?n.beamShape:""},{xtype:"displayfield",name:"flux",fieldLabel:"Flux",labelStyle:j,value:p},{xtype:"displayfield",name:"fluxEnd",fieldLabel:"Flux end",labelStyle:j,value:c},{xtype:"displayfield",name:"beamSizeAtSampleXMicro",fieldLabel:"Beam size at sample Hor",labelStyle:j,value:n?(n.beamSizeAtSampleXMicro?(n.beamSizeAtSampleXMicro+" &mu;m"):""):""},{xtype:"displayfield",name:"beamSizeAtSampleYMicro",fieldLabel:"Beam size at sample Vert",labelStyle:j,value:n?(n.beamSizeAtSampleYMicro?(n.beamSizeAtSampleYMicro+" &mu;m"):""):""},{xtype:"displayfield",name:"beamDivergenceHorizontalInt",fieldLabel:"Beam divergence Hor",labelStyle:j,value:n?(n.beamDivergenceHorizontalInt?(n.beamDivergenceHorizontalInt+" &mu;rad"):""):""},{xtype:"displayfield",name:"beamDivergenceVerticalInt",fieldLabel:"Beam divergence Vert",labelStyle:j,value:n?(n.beamDivergenceVerticalInt?(n.beamDivergenceVerticalInt+" &mu;rad"):""):""},{xtype:"displayfield",name:"polarisation",fieldLabel:"Polarisation",labelStyle:j,value:e?(e.polarisation?(e.polarisation+" &deg"):""):""});
h.panel=Ext.create("Ext.form.Panel",{layout:"vbox",collapsible:false,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:200},defaultType:"textfield",items:k});return h.panel;};function CharacterisationParamPanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}}}CharacterisationParamPanel.prototype.getPanel=function(B){var t=this;var a="font-weight:bold;";var f="0 0 20 0";var e="color: black";var g=B.dataCollection;var o=g.screeningOutput;var z="";var y="";var v="";var n="N/A";var u="";var d="";var c="";var b="";var j="";
var h="";var k="";if(o){z=o.statusDescription;if(o.mosaicity){v=o.mosaicity.toFixed(2)+" &deg;";}if(o.resolutionObtained){y=o.resolutionObtained+" &Aring;";}if(o.ioverSigma){n=o.ioverSigma;}if(o.numSpotsUsed){u=o.numSpotsUsed;}if(o.numSpotsFound){d=o.numSpotsFound;}if(o.spotDeviationTheta){c=o.spotDeviationTheta.toFixed(2)+" &deg;";
}if(o.spotDeviationR){b=o.spotDeviationR;}if(o.beamShiftX){j=o.beamShiftX;}if(o.beamShiftY){h=o.beamShiftY;}if(o.rankingResolution){k=o.rankingResolution.toFixed(2)+" &Aring;";}if(o.indexingSuccess){if(o.indexingSuccess==0){e="color: red";}else{e="color: green";}}}var m=g.lattice;var A="";var r="";var q="";
var p="";var s="";var x="";var w="";if(m){A=m.spaceGroup;r=m.unitCell_a.toFixed(3)+" &Aring;";q=m.unitCell_b.toFixed(3)+" &Aring;";p=m.unitCell_c.toFixed(3)+" &Aring;";s=m.unitCell_alpha.toFixed(3)+" &deg";x=m.unitCell_beta.toFixed(3)+" &deg";w=m.unitCell_gamma.toFixed(3)+" &deg";}var l=[];l.push({xtype:"displayfield",name:"indexingStatus",fieldLabel:"Indexing status",fieldStyle:e,labelStyle:a,value:z},{xtype:"displayfield",name:"spaceGroup",fieldLabel:"Spacegroup",labelStyle:a,value:A},{xtype:"displayfield",name:"unitCellA",fieldLabel:"Unit Cell a",labelStyle:a,value:r},{xtype:"displayfield",name:"unitCellB",fieldLabel:"Unit Cell b",labelStyle:a,value:q},{xtype:"displayfield",name:"unitCellC",fieldLabel:"Unit Cell c",labelStyle:a,value:p},{xtype:"displayfield",name:"unitCellAlpha",fieldLabel:"Unit Cell alpha",labelStyle:a,value:s},{xtype:"displayfield",name:"unitCellBeta",fieldLabel:"Unit Cell beta",labelStyle:a,value:x},{xtype:"displayfield",name:"unitCellGamma",fieldLabel:"Unit Cell gamma",labelStyle:a,value:w},{xtype:"displayfield",name:"mosaicity",fieldLabel:"Mosaicity",labelStyle:a,value:v},{xtype:"displayfield",name:"resolutionObserved",fieldLabel:"Resolution observed",labelStyle:a,value:y},{xtype:"displayfield",name:"ioverSigma",fieldLabel:"I/Sigl at that resolution",labelStyle:a,value:n},{xtype:"displayfield",name:"numSpotsUsed",fieldLabel:"Number of spots used",labelStyle:a,value:u},{xtype:"displayfield",name:"numSpotsFound",fieldLabel:"Number of spots total",labelStyle:a,value:d},{xtype:"displayfield",name:"spotDeviationTheta",fieldLabel:"Spot deviation angular",labelStyle:a,value:c},{xtype:"displayfield",name:"spotDeviationR",fieldLabel:"Spot deviation positional",labelStyle:a,value:b?b.toFixed(3):""},{xtype:"displayfield",name:"beamShiftX",fieldLabel:"Beam shift x",labelStyle:a,value:j?j.toFixed(3):""},{xtype:"displayfield",name:"beamShiftY",fieldLabel:"Beam shift y",labelStyle:a,value:h?h.toFixed(3):""},{xtype:"displayfield",name:"rankingResolution",fieldLabel:"Ranking resolution",labelStyle:a,value:k});
t.panel=Ext.create("Ext.form.Panel",{layout:"vbox",collapsible:false,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:200},defaultType:"textfield",items:l});return t.panel;};function CharacterisationResultPanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;
}if(a.height!=null){this.height=a.height;}}}CharacterisationResultPanel.prototype.getPanel=function(c){var d=this;var a=c.dataCollection;var b=Ext.create("Ext.ux.SimpleIFrame",{src:"viewResults.do?reqCode=displayEDNAPagesContent&dataCollectionId="+c.dataCollectionId});b.setSize(800,800);d.panel=Ext.create("Ext.Panel",{layout:"fit",collapsible:false,frame:true,bodyPadding:"5 5 0",items:[b]});
return d.panel;};function CumulativeIntensityDistributionChart(a){var b=this;this.store=null;this.chart=null;this.panel=null;this.width=980;this.height=580;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}CumulativeIntensityDistributionChart.prototype.getChart=function(){var a=this;
a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,legend:{position:"right"},theme:"Category1",axes:[{type:"Numeric",position:"left",fields:["acent_theor"],maximum:100,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"left",fields:["acent_twin"],maximum:100,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"left",fields:["acent_obser"],maximum:100,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"left",fields:["centric_theor"],maximum:100,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Numeric",position:"left",fields:["centric_obser"],maximum:100,grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["z"],title:"Z",maximum:1,grid:true,label:{rotation:{degrees:325}}}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"z",yField:"acent_theor",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"z",yField:"acent_twin",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"z",yField:"acent_obser",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"z",yField:"centric_theor",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}},{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"z",yField:"centric_obser",markerConfig:{type:"circle",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};CumulativeIntensityDistributionChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){e.chart.save({type:"image/png"});};var d=new Ext.Button({text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});
this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});return e.panel;};function DenzoPanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}DenzoPanel.prototype.getPanel=function(c){var d=this;
var a="font-weight:bold;";var b="viewResults.do?reqCode=displayDenzoFiles&dataCollectionId="+c.dataCollectionId;d.panel=Ext.widget({xtype:"form",collapsible:false,frame:true,layout:"vbox",bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:200},defaultType:"textfield",items:[{xtype:"button",text:"Display Denzo Files",href:b,target:"_blank",hrefTarget:"_blank",disabled:!c.DenzonContentPresent},{xtype:"displayfield",name:"denzoFileLocation",fieldLabel:"Denzo files location",labelStyle:a,value:c.fullDenzoPath}]});
return d.panel;};function ExperimentPanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}ExperimentPanel.prototype.getPanel=function(c){var d=this;var e="font-weight:bold;";var b="0 0 20 0";var h=c.dataCollection;
var g="";if(h&&h.wavelength){g=h.wavelength+" &Aring;";}var j="";if(h&&h.energy){j=h.energy+" keV";}var a="";if(h){a=h.axisStart+" &deg";}var k="";if(h&&h.totalAbsorbedDose){k=h.totalAbsorbedDose+" Gy";}var f=[];f.push({xtype:"displayfield",name:"dataCollection.imageDirectory",fieldLabel:"Img directory",labelStyle:e,value:h?h.imageDirectory:""},{xtype:"displayfield",name:"dataCollection.imageprefix",fieldLabel:"Img prefix",labelStyle:e,value:h?h.imagePrefix:""},{xtype:"displayfield",name:"dataCollection.dataCollectionNumber",fieldLabel:"Run no",labelStyle:e,value:h?h.dataCollectionNumber:""},{xtype:"displayfield",name:"dataCollection.startTime",fieldLabel:"Start Time",labelStyle:e,value:h?h.startTime:""},{xtype:"displayfield",name:"dataCollection.endTime",fieldLabel:"End Time",labelStyle:e,value:h?h.endTime:""},{xtype:"displayfield",name:"dataCollectionGroup.experimentType",fieldLabel:"Type of experiment",labelStyle:e,value:h?h.experimentType:"",margin:b});
f.push({xtype:"displayfield",name:"dataCollectionGroup.wavelength",fieldLabel:"Wavelength",labelStyle:e,value:g},{xtype:"displayfield",name:"dataCollectionGroup.energy",fieldLabel:"Energy",labelStyle:e,value:j,margin:b});f.push({xtype:"displayfield",name:"omegaStart",fieldLabel:h?h.axisStartLabel:"omegaStart",labelStyle:e,value:a},{xtype:"displayfield",name:"axisRange",fieldLabel:"Oscillation range",labelStyle:e,value:h?(h.axisRange+" &deg"):""},{xtype:"displayfield",name:"overlap",fieldLabel:"Overlap",labelStyle:e,value:h?(h.overlap+" &deg"):""},{xtype:"displayfield",name:"exposureTime",fieldLabel:"Exposure Time",labelStyle:e,value:h?(h.exposureTime+" s"):""},{xtype:"displayfield",name:"totalExposureTime",fieldLabel:"Total Exposure Time",labelStyle:e,value:h?(h.totalExposureTime+" s"):""},{xtype:"displayfield",name:"estimatedTotalAbsorbedDose",fieldLabel:"Estimated Total Absorbed Dose",labelStyle:e,value:k},{xtype:"displayfield",name:"numberOfPasses",fieldLabel:"Number of passes",labelStyle:e,value:h?h.numberOfPasses:"",margin:b});
f.push({xtype:"displayfield",name:"detectorDistance",fieldLabel:"Detector Distance",labelStyle:e,value:h?(h.detectorDistance?(h.detectorDistance.toFixed(2)+" mm"):""):""},{xtype:"displayfield",name:"resolutionAtEdge",fieldLabel:"Resolution at edge",labelStyle:e,value:h?(h.resolution?(h.resolution.toFixed(2)+" &Aring;"):""):""},{xtype:"displayfield",name:"resolutionAtCorner",fieldLabel:"Resolution at corner",labelStyle:e,value:h?(h.resolutionAtCorner?(h.resolutionAtCorner.toFixed(2)+" &Aring;"):""):"",margin:b});
f.push({xtype:"displayfield",name:"xbeam",fieldLabel:"Xbeam",labelStyle:e,value:h?(h.xbeam?(h.xbeam.toFixed(2)+" mm"):""):""},{xtype:"displayfield",name:"ybeam",fieldLabel:"Ybeam",labelStyle:e,value:h?(h.ybeam?(h.ybeam.toFixed(2)+" mm"):""):"",margin:b});f.push({xtype:"displayfield",name:"kappa",fieldLabel:"Kappa",labelStyle:e,value:h?h.kappa:""},{xtype:"displayfield",name:"phi",fieldLabel:"Phi",labelStyle:e,value:h?h.phi:"",margin:b});
f.push({xtype:"displayfield",name:"comment",fieldLabel:"Experiment comment",labelStyle:e,value:h?h.comments:""});d.panel=Ext.create("Ext.form.Panel",{layout:"vbox",collapsible:false,frame:true,bodyPadding:"5 5 0",fieldDefaults:{msgTarget:"side",labelWidth:200},defaultType:"textfield",items:f});return d.panel;
};function InterruptedAutoProcPanel(a){var b=this;this.width="800";this.height="800";if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}InterruptedAutoProcPanel.prototype.getPanel=function(e){var g=this;var b=[];var d=g.getHtml(e);if(g.hasStatusData(e)){for(var c=0;
c<e.interruptedAutoProcEvents.length;c++){var f=new AutoProcStatusGrid();var a=g.getDataGrid(e.interruptedAutoProcEvents[c]);b.push(f.getGrid(a));}}g.panel=Ext.create("Ext.Panel",{layout:{type:"vbox",border:0,bodyPadding:0},title:"Interrupted Autoprocessing",collapsible:true,frame:true,items:b,html:d});
return g.panel;};InterruptedAutoProcPanel.prototype.getDataGrid=function(b){var c=[];if(b){for(var a=0;a<b.length;a++){c.push(b[a]);}}return c;};InterruptedAutoProcPanel.prototype.hasStatusData=function(a){return(a&&a.interruptedAutoProcEvents&&a.interruptedAutoProcEvents.length>0);};InterruptedAutoProcPanel.prototype.getHtml=function(b){var c=this;
var a="";if(!c.hasStatusData(b)){a="<html><h4>No Status has been found</h4></html>";}return a;};Ext.Loader.setConfig({enabled:true});var IspybAutoProcAttachmentGraph={start:function(b,a){this.tartgetId=b;this.autoProcProgramAttachmentId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showGraph(b,a);},showGraph:function(d,a){var f=this;var e=new AutoProcProgramAttachmentGraph();var c=[];c.changeSize=false;autoProcProgramAttachmentGraphPanel=new AutoProcProgramAttachmentGraphPanel(c);var b=[];e.dataRetrieved.attach(function(g,h){if(h.autoProcessingData&&h.autoProcessingData.length>0){b.push(autoProcProgramAttachmentGraphPanel.getPanel(h));
f.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,renderTo:d,style:{padding:0},items:b});}});e.getData(a);}};Ext.Loader.setConfig({enabled:true});var autoprocessingPanel=null;var panel=null;var IspybAutoProc={start:function(a){this.targetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");
Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showAutoprocTab(a);},showAutoprocTab:function(c){var e=this;var a=new Result();var d=new AutoProcProgramAttachmentGraph();autoprocessingPanel=new AutoprocessingPanel();autoprocessingPanel.onAutoProcSelected.attach(function(h,g){var f=g.autoProcId;a.getAutoprocessingDetails(f);
});autoprocessingPanel.onAutoProcGraphSelected.attach(function(h,g){var f=g.autoProcProgramAttachmentId;d.getData(f);});var b=[];a.autoProcRetrieved.attach(function(f,g){if(panel==null){b.push(autoprocessingPanel.getPanel(g));panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,width:900,border:0,renderTo:c,style:{padding:0},items:b});
if(g&&g.autoProcIdSelected&&g.autoProcIdSelected!=null){autoprocessingPanel.setSelectedAutoProcId(g.autoProcIdSelected);a.getAutoprocessingDetails(g.autoProcIdSelected);}}else{autoprocessingPanel.setAutoProcList(g);}});a.autoProcDetailRetrieved.attach(function(f,g){autoprocessingPanel.displayAutoProc(g);
});d.dataRetrieved.attach(function(f,g){if(g.autoProcessingData&&g.autoProcessingData.length>0){autoprocessingPanel.displayGraphAttachment(g);}});a.getAutoprocessingInfo(10,1);}};Ext.Loader.setConfig({enabled:true});var autoprocessingPanel=null;var tabs=null;var IspybResult={start:function(a){this.tartgetId=a;
Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.ux.SimpleIFrame","Ext.tip.*"]);
Ext.QuickTips.init();this.showResult(a);},showResult:function(f){var e=this;var j=new Result();var g=new ExperimentPanel();var d=new BeamlinePanel();var a=new CharacterisationParamPanel();var c=new CharacterisationResultPanel();var h=new AutoProcProgramAttachmentGraph();var b=new DenzoPanel();autoprocessingPanel=new AutoprocessingPanel();
autoprocessingPanel.onAutoProcSelected.attach(function(m,l){var k=l.autoProcId;j.getAutoprocessingDetails(k);});autoprocessingPanel.onAutoProcGraphSelected.attach(function(m,l){var k=l.autoProcProgramAttachmentId;h.getData(k);});j.resultRetrieved.attach(function(l,r){if(r.errors&&r.errors.length>0){var n=[];
n.targetId=f;n.errors=r.errors;var p=new ErrorPanel(n);return;}if(o==null){var m=[];var k=0;var q=2;m.push({tabConfig:{id:"experiment",title:"Experiment parameters"},items:[g.getPanel(r)]},{tabConfig:{id:"beamline",title:"Beamline parameters"},items:[d.getPanel(r)]});if(r.displayOutputParam){k=3;q=4;
m.push({tabConfig:{id:"characterisationParameter",title:"Characterisation parameters"},items:[a.getPanel(r)]},{tabConfig:{id:"characterisationResults",title:"Characterisation results"},items:[c.getPanel(r)]});}m.push({tabConfig:{id:"autoprocessing",title:"AutoProcessing"},items:[autoprocessingPanel.getPanel(r)]});
if(r.displayDenzoContent){m.push({tabConfig:{id:"denzo",title:"Denzo files"},items:[b.getPanel(r)]});}var o=Ext.create("Ext.tab.Panel",{renderTo:f,activeTab:0,defaults:{bodyPadding:0,autoScroll:true},items:m});if(r.isEDNACharacterisation){o.setActiveTab(k);}if(r.isAutoprocessing){o.setActiveTab(q);}if(r&&r.autoProcIdSelected&&r.autoProcIdSelected!=null){autoprocessingPanel.setSelectedAutoProcId(r.autoProcIdSelected);
j.getAutoprocessingDetails(r.autoProcIdSelected);}}else{autoprocessingPanel.setAutoProcList(r);}});j.autoProcDetailRetrieved.attach(function(k,l){autoprocessingPanel.displayAutoProc(l);});h.dataRetrieved.attach(function(k,n){if(n.errors&&n.errors.length>0){var l=[];l.targetId=f;l.errors=n.errors;var m=new ErrorPanel(l);
return;}if(n.autoProcessingData&&n.autoProcessingData.length>0){autoprocessingPanel.displayGraphAttachment(n);}});j.getResult(10,1);}};function Result(a){this.type="POST";this.json=a;this.resultRetrieved=new Event(this);this.autoProcRetrieved=new Event(this);this.autoProcDetailRetrieved=new Event(this);
this.onError=new Event(this);}Result.prototype.getResult=function(a,c){var d=this;var b=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"viewResults.do?reqCode=getResultData&rMerge="+a+"&iSigma="+c,data:{},datatype:"text/json",success:function(e){d.resultRetrieved.notify(e);
b.hide();},error:function(g,e,f){d.onError.notify(g.responseText);b.hide();}});};Result.prototype.getAutoprocessingInfo=function(a,c){var d=this;var b=Ext.MessageBox.wait("Please wait...","Loading Autoprocessings");$.ajax({type:this.type,url:"viewResults.do?reqCode=getAutoprocessingInfo&rMerge="+a+"&iSigma="+c,data:{},datatype:"text/json",success:function(e){d.autoProcRetrieved.notify(e);
b.hide();},error:function(g,e,f){d.onError.notify(g.responseText);b.hide();}});};Result.prototype.getAutoprocessingDetails=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Displaying Autoprocessing information");$.ajax({type:this.type,url:"viewResults.do?reqCode=getAutoprocessingDetails&autoProcId="+a,data:{},datatype:"text/json",success:function(d){c.autoProcDetailRetrieved.notify(d);
b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});};function WilsonChart(a){var b=this;this.store=null;this.chart=null;this.panel=null;this.width=980;this.height=580;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}WilsonChart.prototype.getChart=function(){var a=this;
a.chart=Ext.create("Ext.chart.Chart",{xtype:"chart",style:"background:#fff",animate:true,store:a.store,shadow:true,theme:"Category1",axes:[{type:"Numeric",position:"left",fields:["wilsonPlot"],title:"ln(Mn(Fsquared/n_obs)/Mn(ff)",grid:{odd:{opacity:1,fill:"#ddd",stroke:"#bbb","stroke-width":0.5}}},{type:"Category",position:"bottom",fields:["resolution"],title:"Resolution",grid:true,label:{rotation:{degrees:325}}}],series:[{type:"line",highlight:{size:7,radius:7},axis:"left",xField:"resolution",yField:"wilsonPlot",markerConfig:{type:"cross",size:4,radius:4,"stroke-width":0}}]});
return a.chart;};WilsonChart.prototype.getPanel=function(c){var e=this;e.store=c;e.getChart();var b=function(f){e.chart.save({type:"image/png"});};var d=new Ext.Button({text:"",tooltip:"Save as Image",icon:"../images/folder_go.png",handler:b});var a=new Ext.Toolbar({items:[d]});this.panel=Ext.create("Ext.Panel",{height:this.height,tbar:a,layout:"fit",items:e.chart});
return e.panel;};Ext.Loader.setConfig({enabled:true});var session;var sessions;var sessionGrid;var emptyPanel=null;var IspybSession={start:function(a,b){this.tartgetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showSessions(a,b);},showSessions:function(c,d){var e=this;session=new Session();sessions=[];var a=new SearchSessionPanel();var b=[];session.sessionRetrieved.attach(function(f,l){if(l.errors&&l.errors.length>0){var h=[];h.targetId=c;h.errors=l.errors;var k=new ErrorPanel(h);return;
}sessions=[];var g=l.listSessionInformation;for(var j=0;j<g.length;j++){sessions.push(new Session(g[j]));}b=[];b.push(a.getPanel(l.beamlines));emptyPanel=Ext.create("Ext.Panel",{id:"emptyPanel",border:false,width:600,height:20});b.push(emptyPanel);if(sessions.length==0){b.push({border:0,padding:0,html:BUI.getWarningHTML("No sessions have been found.")});
}sessionGrid=new SessionGrid(l);sessionGrid.onEditButtonClicked.attach(function(o,n){var m=session.getSessionById(n.sessionId,sessions);if(m!=null){var p=new SessionWindow(l);p.onSaved.attach(function(q,r){session.saveSession(r);});p.draw(m);}});sessionGrid.onSubmitReportButtonClicked.attach(function(o,n){var m=session.getSessionById(n.sessionId,sessions);
if(m!=null){session.submitReport(m);}});sessionGrid.onRemoveButtonClicked.attach(function(o,n){var m=session.getSessionById(n.sessionId,sessions);if(m!=null){session.removeSession(m);}});b.push(sessionGrid.getGrid(sessions));this.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,renderTo:c,style:{padding:0},items:b});
});session.onSaved.attach(function(f,g){e.refresh(g);});session.getSessionByProposal(d);},refresh:function(b){var c=this;sessions=[];for(var a=0;a<b.length;a++){sessions.push(new Session(b[a]));}sessionGrid.refresh(sessions);}};function SearchSessionPanel(a){var b=this;this.width="340";this.height="500";
this.onSearchSession=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}}SearchSessionPanel.prototype.getPanel=function(c){var e=this;var b=[];for(i=0;i<c.length;i++){var a={beamlineName:c[i]};b.push(a);}e.beamlines=Ext.create("Ext.data.Store",{fields:["beamlineName"],data:b});
e.panel=Ext.widget({xtype:"form",layout:"form",collapsible:true,id:"searchSessionForm",frame:true,title:"Search Session",bodyPadding:"5 5 0",width:350,fieldDefaults:{msgTarget:"side",labelWidth:90},defaultType:"textfield",items:[{xtype:"combobox",fieldLabel:"Beamline",id:"cbBeamline",name:"beamline",store:e.beamlines,valueField:"beamlineName",displayField:"beamlineName",typeAhead:true,queryMode:"local",emptyText:"Select a beamline..."},{xtype:"datefield",name:"startDate",id:"fieldStartDate",fieldLabel:"Start Date (DD/MM/YYYY)"},{xtype:"datefield",name:"endDate",id:"fieldEndDate",fieldLabel:"End Date (DD/MM/YYYY)"}],buttons:[{text:"Search",handler:function(){if(this.up("form").getForm().isValid()){this.up("form").getForm().submit({url:"viewSession.do?reqCode=getSessions",waitMsg:"Searching sessions...",success:function(d,f){e.onSearchSession.notify({"sessions":d});
}});this.up("form").getForm().reset();}}},{text:"Reset",handler:function(){this.up("form").getForm().reset();}}]});return e.panel;};function Session(a){this.type="POST";this.json=a;this.sessionRetrieved=new Event(this);this.dataRetrieved=new Event(this);this.onSaved=new Event(this);this.onError=new Event(this);
}Session.prototype.getSessionByProposal=function(b){var c=this;var a=Ext.MessageBox.wait("Please wait...","Loading Session");$.ajax({type:this.type,url:"viewSession.do?reqCode=getSessions&nbSessionsToDisplay="+b,data:{},datatype:"text/json",success:function(d){c.sessionRetrieved.notify(d);a.hide();},error:function(f,d,e){c.onError.notify(f.responseText);
a.hide();}});};Session.prototype.getSessionById=function(b,c){if(c){for(var a=0;a<c.length;a++){if(c[a].json.sessionId==b){return c[a].json;}}}return null;};Session.prototype.saveSession=function(b){var c=this;var a=Ext.MessageBox.wait("Please wait...","Saving Session");if(b){$.ajax({type:this.type,url:"viewSession.do?reqCode=saveSession&nbSessionsToDisplay="+nbSessionsToDisplay,data:{session:JSON.stringify(b)},datatype:"text/json",success:function(d){c.onSaved.notify(d.listSessionInformation);
a.hide();},error:function(f,d,e){c.onError.notify(f.responseText);a.hide();}});}return null;};Session.prototype.submitReport=function(b){var c=this;var a=Ext.MessageBox.wait("Please wait...","Submit Report");if(b){$.ajax({type:this.type,url:"viewSession.do?reqCode=submitReport&nbSessionsToDisplay="+nbSessionsToDisplay,data:{session:JSON.stringify(b)},datatype:"text/json",success:function(d){a.hide();
},error:function(f,d,e){c.onError.notify(f.responseText);a.hide();}});}return null;};Session.prototype.removeSession=function(b){var c=this;var a=Ext.MessageBox.wait("Please wait...","Remove Session");if(b){$.ajax({type:this.type,url:"viewSession.do?reqCode=removeSession&nbSessionsToDisplay="+nbSessionsToDisplay,data:{session:JSON.stringify(b)},datatype:"text/json",success:function(d){c.onSaved.notify(d.listSessionInformation);
a.hide();},error:function(f,d,e){c.onError.notify(f.responseText);a.hide();}});}return null;};function SessionForm(a){this.actions=[];this.isFx=false;this.isIx=false;if(a!=null){if(a.isFx!=null){this.isFx=a.isFx;}if(a.isIx!=null){this.isIx=a.isIx;}}this.session=null;this.emailButton=null;}SessionForm.prototype.getSession=function(){var a=this;
this.session.beamlineOperator=Ext.getCmp(this.panel.getItemId()).getValues().beamlineOperator;this.session.comments=Ext.getCmp(this.panel.getItemId()).getValues().comments;if(a.isFx){this.session.sessionTitle=Ext.getCmp(this.panel.getItemId()).getValues().sessionTitle;this.session.structureDeterminations=Ext.getCmp(this.panel.getItemId()).getValues().structureDeterminations;
if(this.session.structureDeterminations==""){this.session.structureDeterminations=0;}}if(a.isFx||a.isIx){this.session.dewarTransport=Ext.getCmp(this.panel.getItemId()).getValues().dewarTransport;this.session.databackupFrance=Ext.getCmp(this.panel.getItemId()).getValues().databackupFrance;this.session.databackupEurope=Ext.getCmp(this.panel.getItemId()).getValues().databackupEurope;
if(this.session.dewarTransport==""){this.session.dewarTransport=0;}if(this.session.databackupFrance==""){this.session.databackupFrance=0;}if(this.session.databackupEurope==""){this.session.databackupEurope=0;}}return this.session;};SessionForm.prototype.refresh=function(a){this.session=a;this.emailButton.setTooltip("mail to: "+this.session.beamLineOperatorEmail);
this.emailButton.setHandler(function(){window.location="mailto:"+a.beamLineOperatorEmail;});};SessionForm.prototype.getPanel=function(d){this.session=d;var f=this;var b=380;var c=200;var a=90;var e=[];e.push({fieldLabel:"Local Contact",name:"beamlineOperator",tooltip:"Local contact beamline Operator",value:this.session.beamlineOperator});
this.emailButton=new Ext.Button({text:"",handler:function(){window.location="mailto:"+d.beamLineOperatorEmail;},tooltip:"mail to: "+this.session.beamLineOperatorEmail,icon:"../images/mail_generic.png"});if(this.session.beamLineOperatorEmail&&this.session.beamLineOperatorEmail!=""){e.push(this.emailButton);
}e.push({xtype:"textareafield",name:"comments",width:500,grow:true,fieldLabel:"Comments",tooltip:"Session comments",value:this.session.comments});if(f.isFx){a=160;c=330;e.push({fieldLabel:"Session Title",name:"sessionTitle",tooltip:"Session title",value:this.session.sessionTitle},{fieldLabel:"Structure Determinations",name:"structureDeterminations",tooltip:"Structure Determinations",value:this.session.structureDeterminations,xtype:"numberfield",hideTrigger:true},{fieldLabel:"Dewar Transport",name:"dewarTransport",tooltip:"Dewar Transport",value:this.session.dewarTransport,xtype:"numberfield",hideTrigger:true},{fieldLabel:"Data backup &<br/>Express delivery France",name:"databackupFrance",tooltip:"Data backup & Express delivery France",value:this.session.databackupFrance,xtype:"numberfield",hideTrigger:true},{fieldLabel:"Data backup &<br/>Express delivery Europe",name:"databackupEurope",tooltip:"Data backup & Express delivery Europe",value:this.session.databackupEurope,xtype:"numberfield",hideTrigger:true});
}else{if(f.isIx){a=160;c=270;e.push({fieldLabel:"Dewar Transport",name:"dewarTransport",tooltip:"Dewar Transport",value:this.session.dewarTransport,xtype:"numberfield",hideTrigger:true},{fieldLabel:"Data backup &<br/>Express delivery France",name:"databackupFrance",tooltip:"Data backup & Express delivery France",value:this.session.databackupFrance,xtype:"numberfield",hideTrigger:true},{fieldLabel:"Data backup &<br/>Express delivery Europe",name:"databackupEurope",tooltip:"Data backup & Express delivery Europe",value:this.session.databackupEurope,xtype:"numberfield",hideTrigger:true});
}}if(this.panel==null){this.panel=Ext.createWidget("form",{bodyPadding:5,frame:true,border:0,layout:"fit",fieldDefaults:{labelAlign:"left",labelWidth:a},items:[{xtype:"container",border:false,defaultType:"textfield",items:e}]});}return this.panel;};function SessionGrid(e){this.onEditButtonClicked=new Event(this);
this.onSubmitReportButtonClicked=new Event(this);this.onRemoveButtonClicked=new Event(this);this.pageSize=20;var h=false;var d=false;var g=false;var f=false;var a=false;var c=false;var b="";this.title="Sessions";if(e!=null){if(e.height!=null){this.height=e.height;}if(e.isManager!=null){this.isManager=e.isManager;
}if(e.isLocalContact!=null){this.isLocalContact=e.isLocalContact;}if(e.isIndustrial!=null){this.isIndustrial=e.isIndustrial;}if(e.allowedToSubmitReport!=null){this.allowedToSubmitReport=e.allowedToSubmitReport;}if(e.proposalIsBM14!=null){this.proposalIsBM14=e.proposalIsBM14;}if(e.isFx!=null){this.isFx=e.isFx;
}if(e.contextPath!=null){this.contextPath=e.contextPath;}if(e.title!=null){this.title=e.title;}}Ext.define("SessionModel",{extend:"Ext.data.Model",fields:[{name:"sessionId",mapping:"sessionId"},{name:"expSessionPk",mapping:"expSessionPk"},{name:"startDate",mapping:"startDate",type:"date",dateFormat:"d-m-Y"},{name:"endDate",mapping:"endDate",type:"date",dateFormat:"d-m-Y"},{name:"beamlineName",mapping:"beamlineName"},{name:"beamlineOperator",mapping:"beamlineOperator"},{name:"beamLineOperatorEmail",mapping:"beamLineOperatorEmail"},{name:"proposalCodeNumber",mapping:"proposalCodeNumber"},{name:"hasDataCollectionGroup",mapping:"hasDataCollectionGroup"},{name:"nbShifts",mapping:"nbShifts"},{name:"sessionTitle",mapping:"sessionTitle"},{name:"comments",mapping:"comments"}],idProperty:"sessionId"});
}SessionGrid.prototype.getFilterTypes=function(){return[];};SessionGrid.prototype._prepareData=function(){var c=[];for(var a=0;a<this.features.length;a++){var b={};b=this.features[a].json;c.push(b);}return c;};SessionGrid.prototype._sort=function(a){a.sort("startDate","DESC");};SessionGrid.prototype.getGrid=function(a){this.features=a;
return this.renderGrid(a);};SessionGrid.prototype.refresh=function(a){this.features=a;this.store.loadData(this._prepareData(),false);};SessionGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;};SessionGrid.prototype.renderGrid=function(){var e=this;var d=[];var b=this._getColumns();
var c=this._prepareData();this.store=Ext.create("Ext.data.Store",{model:"SessionModel",autoload:false,pageSize:this.pageSize,proxy:{type:"pagingmemory",data:c,reader:{type:"array"}}});this._sort(this.store);this.store.totalCount=this.features.length;this.store.loadData(c,false);var a=true;this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:"100%",model:"SessionModel",height:this.height,store:this.store,columns:b,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true,listeners:{itemdblclick:function(g,f,h,j){e.editSession(f.data.sessionId);
}}},selModel:{mode:"SINGLE"},bbar:Ext.create("Ext.PagingToolbar",{store:this.store,pageSize:this.pageSize,displayInfo:true,displayMsg:"Displaying sessions {0} - {1} of {2}",emptyMsg:"No sessions to display",listeners:{afterrender:function(){var g=Ext.query("button[data-qtip=Refresh]");for(var f=0;f<g.length;
f++){g[f].style.display="none";}}}})});this.store.load();return this.grid;};SessionGrid.prototype._getColumns=function(){var g=this;function a(j,k,h){return Ext.String.format("<a href="+contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollectionGroup.do?reqCode=display&sessionId={1}>{0}</a>",Ext.Date.format(j,"d-m-Y"),h.getId());
}function c(j,k,h){if(h.get("expSessionPk")){return Ext.String.format('<a href="https://wwws.esrf.fr/misapps/SMISWebClient/protected/aform/manageAForm.do?action=view&currentTab=howtoTab&expSessionVO.pk={1}" target="_blank" >A-Form</a>',j,h.get("expSessionPk"));}else{return"";}}function b(j,k,h){if(h.get("beamLineOperatorEmail")){return Ext.String.format('<a href="mailto:{1}" " >{0}</a>',h.get("beamlineOperator"),h.get("beamLineOperatorEmail"));
}else{return h.get("beamlineOperator");}}function f(h){if(h){return'<div style="white-space:normal !important;">'+h+"</div>";}else{return"";}}function e(l,m,h,n,k,j){if(!h.get("hasDataCollectionGroup")){return"x-hide-display";}}var d=[{id:"sessionId",text:"Start Date",dataIndex:"startDate",renderer:a,flex:0.075},{text:"End Date",dataIndex:"endDate",renderer:Ext.util.Format.dateRenderer("d-m-Y"),flex:0.075},{text:"Beamline",dataIndex:"beamlineName",type:"string",flex:0.05},{text:"Local contact",dataIndex:"beamlineOperator",renderer:b,type:"string",flex:0.075}];
if(g.isManager||g.isLocalContact){d.push({text:"Proposal",dataIndex:"proposalCodeNumber",type:"string",flex:0.075});}d.push({text:"# Shifts",dataIndex:"nbShifts",type:"string",flex:0.05});if(g.isFx){d.push({text:"Title",dataIndex:"sessionTitle",type:"string",flex:0.1});}d.push({text:"Comments",dataIndex:"comments",type:"string",flex:0.3,renderer:f});
if(!g.isIndustrial){d.push({xtype:"actioncolumn",width:50,header:"Edit",sortable:false,items:[{icon:"../images/Edit_16x16_01.png",tooltip:"Edit Session",handler:function(j,k,h){g.editSession(g.store.getAt(k).data.sessionId);}}]});}d.push({xtype:"actioncolumn",id:"viewGroup",width:70,header:"View<br/>Collections<br/>Groups",sortable:false,items:[{icon:"../images/magnif_16.png",tooltip:"View Collections Groups",getClass:e,handler:function(j,k,h){g.viewCollectionsGroups(g.store.getAt(k).data.sessionId);
}}]},{xtype:"actioncolumn",id:"viewCollect",width:70,header:"View<br/>Collections",sortable:false,items:[{icon:"../images/magnif_16.png",tooltip:"View Collections",getClass:e,handler:function(j,k,h){g.viewCollections(g.store.getAt(k).data.sessionId);}}]});if(g.proposalIsBM14){d.push({xtype:"actioncolumn",width:50,header:"Export",sortable:false,items:[{icon:"../images/export.gif",tooltip:"Export information",handler:function(j,k,h){g.exportSession(g.store.getAt(k).data.sessionId);
}}]});}if(g.allowedToSubmitReport){d.push({xtype:"actioncolumn",width:50,header:"Submit<br/>Report",sortable:false,items:[{icon:"../images/submitReport_pdf.gif",tooltip:"SubmitReport",handler:function(j,k,h){g.submitReport(g.store.getAt(k).data.sessionId);}}]});}if(g.isManager){d.push({xtype:"actioncolumn",width:50,header:"Delete",sortable:false,items:[{icon:"../images/cancel.png",tooltip:"Remove Session",handler:function(j,k,h){g.removeSession(g.store.getAt(k).data.sessionId);
}}]});}d.push({text:"SMIS<br/>A-Form",type:"string",renderer:c,flex:0.05,tdCls:"wrap"});return d;};SessionGrid.prototype.editSession=function(a){this.onEditButtonClicked.notify({"sessionId":a});};SessionGrid.prototype.viewCollectionsGroups=function(a){document.location.href=contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollectionGroup.do?reqCode=display&sessionId="+a;
};SessionGrid.prototype.viewCollections=function(a){document.location.href=contextPath+"/menuSelected.do?leftMenuId=-1&topMenuId=16&targetUrl=/user/viewDataCollection.do?reqCode=displayForSession&sessionId="+a;};SessionGrid.prototype.submitReport=function(a){this.onSubmitReportButtonClicked.notify({"sessionId":a});
};SessionGrid.prototype.removeSession=function(a){if(confirm("Do you want to remove this session?")){this.onRemoveButtonClicked.notify({"sessionId":a});}};SessionWindow.prototype.getButtons=GenericWindow.prototype.getButtons;SessionWindow.prototype._render=GenericWindow.prototype._render;SessionWindow.prototype._postRender=GenericWindow.prototype._postRender;
function SessionWindow(a){this.title="Edit session";this.width=450;this.height=300;this.isFx=false;this.isIx=false;if(a!=null){if(a.isFx!=null){this.isFx=a.isFx;}if(a.isIx!=null){this.isIx=a.isIx;}}if(this.isFx){this.height=500;}if(this.isIx){this.height=450;}this.form=new SessionForm(a);GenericWindow.prototype.constructor.call(this,{form:this.form,width:this.width,height:this.height});
}SessionWindow.prototype.save=function(){this.onSaved.notify(this.form.getSession());this.panel.close();};SessionWindow.prototype.cancel=function(){this.panel.close();};SessionWindow.prototype.draw=function(a){this.title="Edit session";this._render(a);};function CreatePuckGrid(a){this.onSaveButtonClicked=new Event(this);
this.onEditPuckButtonClicked=new Event(this);this.onRemovePuckButtonClicked=new Event(this);this.onCopyPuckButtonClicked=new Event(this);this.onCopySampleButtonClicked=new Event(this);this.title="Create a new Puck";this.saveButton="Save";this.proteinList=[];this.spaceGroupList=[];this.experimentTypeList=[];
this.crystalValuesList=[];this.puckData=null;this.sampleToCopy=null;this.fillShipmentMode=false;if(a!=null){if(a.height!=null){this.height=a.height;}}this.changeSampleNameAuto=false;Ext.define("SampleModel",{extend:"Ext.data.Model",fields:[{name:"sampleId",mapping:"sampleId"},{name:"position",mapping:"position"},{name:"sampleName",mapping:"sampleName"},{name:"proteinAcronym",mapping:"proteinAcronym"},{name:"spaceGroup",mapping:"spaceGroup"},{name:"preObservedResolution",mapping:"preObservedResolution"},{name:"neededResolution",mapping:"neededResolution"},{name:"oscillationRange",mapping:"oscillationRange"},{name:"experimentType",mapping:"experimentType"},{name:"unitCellA",mapping:"unitCellA"},{name:"unitCellB",mapping:"unitCellB"},{name:"unitCellC",mapping:"unitCellC"},{name:"unitCellC",mapping:"unitCellC"},{name:"unitCellAlpha",mapping:"unitCellAlpha"},{name:"unitCellBeta",mapping:"unitCellBeta"},{name:"unitCellGamma",mapping:"unitCellGamma"},{name:"smiles",mapping:"smiles"},{name:"comments",mapping:"comments"},{name:"pinBarcode",mapping:"pinBarcode"}],idProperty:"sampleId"});
}CreatePuckGrid.prototype.getFilterTypes=function(){return[];};CreatePuckGrid.prototype._sort=function(a){a.sort("position","ASC");};CreatePuckGrid.prototype._setProteinList=function(c){this.proteinList=[];if(c&&c.proteinList){for(var a=0;a<c.proteinList.length;a++){var b=[];b.proteinAcronym=c.proteinList[a];
this.proteinList.push(b);}}};CreatePuckGrid.prototype._setSpaceGroupList=function(c){this.spaceGrouplist=[];if(c&&c.spaceGroupList){for(var a=0;a<c.spaceGroupList.length;a++){var b=[];b.spaceGroup=c.spaceGroupList[a];this.spaceGroupList.push(b);}}};CreatePuckGrid.prototype._setExperimentTypeList=function(c){this.experimentTypeList=[];
if(c&&c.experimentTypeList){for(var a=0;a<c.experimentTypeList.length;a++){var b=[];b.experimentType=c.experimentTypeList[a];this.experimentTypeList.push(b);}}};CreatePuckGrid.prototype._setCrystalValuesList=function(c){this.crystalValuesList=[];if(c&&c.crystalValuesList){for(var a=0;a<c.crystalValuesList.length;
a++){var b=c.crystalValuesList[a];this.crystalValuesList.push(b);}}};CreatePuckGrid.prototype.getGrid=function(a){this.puckData=a;this._setProteinList(a);this._setSpaceGroupList(a);this._setExperimentTypeList(a);this._setCrystalValuesList(a);this.initGrid();this.updateListSamples(a);return this.renderGrid();
};CreatePuckGrid.prototype.initGrid=function(){this.features=[];for(var a=0;a<10;a++){this.features.push({sampleId:-1,position:a+1,experimentType:"Default"});}};CreatePuckGrid.prototype.updateListSamples=function(b){for(var a=0;a<b.listSamples.length;a++){var c=b.listSamples[a].position;this.features[c-1]=b.listSamples[a];
this.features[c-1].position=Number(b.listSamples[a].position);}if(b.listSamples.length>0){this.title="Update Puck";}else{this.title="Create Puck";}this.fillShipmentMode=false;if(b&&b.fillShipmentMode&&b.fillShipmentMode==true){this.title="";this.fillShipmentMode=true;}};CreatePuckGrid.prototype._formatPostionNumber=function(a){if(a&&a<10){return"0"+a;
}return a;};CreatePuckGrid.prototype.refresh=function(a){this.initGrid();this.puckData=a;this.updateListSamples(a);this.store.loadData(this.features,false);this._sort(this.store);};CreatePuckGrid.prototype.getActions=function(){var a=this;this.actions=[];return this.actions;};CreatePuckGrid.prototype.renderGrid=function(){var d=this;
var a=this._getColumns();this.store=Ext.create("Ext.data.Store",{model:"SampleModel",autoload:false});this._sort(this.store);this.store.totalCount=this.features.length;this.store.loadData(this.features,false);var b=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1,listeners:{afteredit:function(j,f){var l=f.record;
var h=f.field;var k=f.value;var g=f.rowIdx;if(h=="sampleName"){d.changeSampleName(k,g);}else{if(h=="proteinAcronym"){d.changeProteinAcronym(k,g);}else{if(h=="experimentType"){d.changeExperimentType(k,g);}}}}}});var c=[];if(d.fillShipmentMode==true){c.push({tooltip:{text:"Edit the puck label",title:"Edit puck"},icon:"../images/Edit_16x16_01.png",handler:function(){d.editPuck();
}},{xtype:"tbseparator"});c.push({tooltip:{text:"Copy the puck with the samples. Then you can paste it in any dewar; it will create a new puck with the same samples.",title:"Copy puck"},id:"button_copy_"+d.puckData.puckInfo.containerId,icon:"../images/editcopy.png",handler:function(){d.copyPuck();}},{tooltip:{text:"Copy the puck and remove it. Then you can paste it in any dewar.",title:"Cut puck"},id:"button_cut_"+d.puckData.puckInfo.containerId,icon:"../images/editcut.png"},{xtype:"tbseparator"});
}c.push({text:this.saveButton,tooltip:{text:"Save all samples contained in this puck",title:"Save samples"},icon:"../images/save.gif",handler:function(){d.onSaveButtonClicked.notify({"listSamples":d.getListSamples(),"puckInfo":d.puckData.puckInfo});}},{xtype:"tbseparator"},{text:"Reset",tooltip:{text:"Reset the samples table: all fields are set to their default value.",title:"Reset the samples"},icon:"../images/recur.png",handler:function(){d.reset();
}},{xtype:"checkboxfield",name:"cbchangeName",boxLabel:"Change sample name automatically",checked:false,inputValue:"all",handler:function(g,f){var e=g.getValue();d.changeSampleNameAuto=e;}});if(d.fillShipmentMode==true){c.push({xtype:"tbseparator"},{tooltip:{text:"Remove this puck together with samples inside",title:"Delete puck"},icon:"../images/cancel.png",handler:function(){d.deletePuck();
}});}this.grid=Ext.create("Ext.grid.Panel",{style:{padding:0},width:"100%",model:"SampleModel",height:"100%",store:this.store,columns:a,title:this.title,viewConfig:{stripeRows:true,enableTextSelection:true},selModel:{mode:"SINGLE"},plugins:[b],tbar:c});this.grid.on("beforeedit",function(k,e,h){var l=e.colIdx;
var g=this.columns[l].dataIndex=="oscillationRange";var j=e.record.index;var f=d.getExperimentTypeValue(j);if(g&&!d.canEditOscillationRange(f)){return false;}return true;});return this.grid;};CreatePuckGrid.prototype.getExperimentTypeValue=function(a){return this.grid.store.getAt(a).get("experimentType");
};CreatePuckGrid.prototype.editPuck=function(){var a=this;a.onEditPuckButtonClicked.notify({"containerId":a.puckData.puckInfo.containerId,"puckName":a.puckData.puckInfo.code});};CreatePuckGrid.prototype.changeSampleName=function(m,n){if(this.changeSampleNameAuto&&m){var d=m.length;var j=0;if(d>=1){var h=m.substring(d-1);
if(!isNaN(parseFloat(h))&&isFinite(h)){j=1;}}if(d>=2){var h=m.substring(d-2);if(!isNaN(parseFloat(h))&&isFinite(h)){j=2;}}var a=m.substring(0,d-j);var b=this.grid.store.getAt(n).data.proteinAcronym;var g=1;for(var f=0;f<10;f++){var k=this.grid.store.getAt(f).data.proteinAcronym;if(b==k){this.grid.store.getAt(f).set("sampleName",a+this._formatPostionNumber(g));
g=g+1;}}}};CreatePuckGrid.prototype._getColumns=function(){var j=this;function b(q){if(q){return'<div style="white-space:normal !important;word-wrap: break-word;">'+q+"</div>";}else{return"";}}function l(r,q){q.tdAttr='style="background-color: #FFEBEB"';if(r){return'<div style="white-space:normal !important;word-wrap: break-word;">'+r+"</div>";
}else{return"";}}function h(r,q){q.tdAttr='style="background-color: #FFEBEB"';return r;}function n(t,s,q){var r=j.getExperimentTypeValue(q.index);if(!j.canEditOscillationRange(r)){s.tdAttr='style="background-color: #EBE8E8"';}return t;}Ext.util.Format.comboRenderer=function(q){return function(s){var r=q.findRecord(q.valueField,s);
return r?r.get(q.displayField):q.valueNotFoundText;};};function e(r,s,q){if(r==null){return"";}return Number(r).toFixed(3);}function g(r,s,q){if(r==null){return"";}return Number(r).toFixed(1);}function a(r,s,q){if(r==null){return"";}return Number(r);}var k=Ext.create("Ext.data.Store",{id:0,fields:["proteinAcronym"],data:j.proteinList});
var f=Ext.create("Ext.data.Store",{id:0,fields:["spaceGroup"],data:j.spaceGroupList});var m=Ext.create("Ext.data.Store",{id:0,fields:["experimentType"],data:j.experimentTypeList});var p=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:k,valueField:"proteinAcronym",displayField:"proteinAcronym",queryMode:"local",allowBlank:false,typeAhead:true,triggerAction:"all",listConfig:{cls:"small-combo-text"}});
var o=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:f,valueField:"spaceGroup",displayField:"spaceGroup",allowBlank:true,queryMode:"local",typeAhead:true,triggerAction:"all"});var d=new Ext.form.ComboBox({mode:"local",emptyText:"---",store:m,valueField:"experimentType",displayField:"experimentType",allowBlank:false,queryMode:"local",typeAhead:true,triggerAction:"all",listConfig:{cls:"small-combo-text"}});
d.setValue("Default");var c=[{text:"Sample<br>Position",dataIndex:"position",flex:0.04,renderer:a},{text:"Protein<br>Acronym (*)",dataIndex:"proteinAcronym",flex:0.1,editor:p,renderer:h},{text:"Sample<br>Name (*)",dataIndex:"sampleName",flex:0.09,editor:{xtype:"textfield",allowBlank:false,regex:/^[a-zA-Z0-9_-]+$/,regexText:"Make sure the sample name contains only a-z , A-Z or 0-9 or - or _ characters!",msgTarget:"under"},renderer:l},{text:"PinBarcode",dataIndex:"pinBarcode",flex:0.07,editor:{xtype:"textfield"}},{text:"Space<br>Group",dataIndex:"spaceGroup",flex:0.075,editor:o},{text:"Pre-Observed<br>resolution",dataIndex:"preObservedResolution",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Needed<br>resolution",dataIndex:"neededResolution",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Oscillation<br>Range",dataIndex:"oscillationRange",flex:0.05,editor:{xtype:"textfield",allowBlank:true},renderer:n},{text:"Experiment<br>Type",dataIndex:"experimentType",flex:0.075,editor:d},{text:"Unit Cell<br>a",dataIndex:"unitCellA",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Unit Cell<br>b",dataIndex:"unitCellB",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Unit Cell<br>c",dataIndex:"unitCellC",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Unit Cell<br>alpha",dataIndex:"unitCellAlpha",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Unit Cell<br>beta",dataIndex:"unitCellBeta",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"Unit Cell<br>gamma",dataIndex:"unitCellGamma",flex:0.05,editor:{xtype:"textfield",allowBlank:true}},{text:"SMILES",dataIndex:"smiles",flex:0.1,editor:{xtype:"textfield",allowBlank:true,maxLength:400},renderer:b},{text:"Comments",dataIndex:"comments",flex:0.1,editor:{xtype:"textfield",allowBlank:true,maxLength:1024},renderer:b}];
c.push({xtype:"actioncolumn",width:50,header:"Action",sortable:false,renderer:function(s,r,q){this.items[1].disabled=!j.canCopySample();return s;},items:[{icon:"../images/editcopy.png",tooltip:"Copy sample",handler:function(r,s,q){j.copySample(j.store.getAt(s).data);}},{icon:"../images/editpaste.png",tooltip:"Paste sample",handler:function(r,s,q){j.pasteSample(s);
}}]});return c;};CreatePuckGrid.prototype.copySample=function(a){var b=this;if(a){b.sampleToCopy=a;b.copyId=1;b.grid.getView().refresh();this.onCopySampleButtonClicked.notify({"sampleToCopy":b.sampleToCopy});}};CreatePuckGrid.prototype.canCopySample=function(){var a=this;return a.sampleToCopy&&a.sampleToCopy.position;
};CreatePuckGrid.prototype.setSampleToCopy=function(a){var b=this;b.sampleToCopy=a;if(!b.copyId){b.copyId=1;}b.grid.getView().refresh();};CreatePuckGrid.prototype.pasteSample=function(b){var a=this;if(a.canCopySample()){a.grid.store.getAt(b).set("proteinAcronym",a.sampleToCopy.proteinAcronym);a.grid.store.getAt(b).set("sampleName",a.sampleToCopy.sampleName+"_"+a.copyId);
a.grid.store.getAt(b).set("pinBarcode",a.sampleToCopy.pinBarcode);a.grid.store.getAt(b).set("spaceGroup",a.sampleToCopy.spaceGroup);a.grid.store.getAt(b).set("preObservedResolution",a.sampleToCopy.preObservedResolution);a.grid.store.getAt(b).set("neededResolution",a.sampleToCopy.neededResolution);a.grid.store.getAt(b).set("oscillationRange",a.sampleToCopy.oscillationRange);
a.grid.store.getAt(b).set("experimentType",a.sampleToCopy.experimentType);a.grid.store.getAt(b).set("unitCellA",a.sampleToCopy.unitCellA);a.grid.store.getAt(b).set("unitCellB",a.sampleToCopy.unitCellB);a.grid.store.getAt(b).set("unitCellC",a.sampleToCopy.unitCellC);a.grid.store.getAt(b).set("unitCellAlpha",a.sampleToCopy.unitCellAlpha);
a.grid.store.getAt(b).set("unitCellBeta",a.sampleToCopy.unitCellBeta);a.grid.store.getAt(b).set("unitCellGamma",a.sampleToCopy.unitCellGamma);a.grid.store.getAt(b).set("smiles",a.sampleToCopy.smiles);a.grid.store.getAt(b).set("comments",a.sampleToCopy.comments);a.copyId=a.copyId+1;a.changeSampleName(a.sampleToCopy.sampleName,a.sampleToCopy.position-1);
}};CreatePuckGrid.prototype.getListSamples=function(){var a=Ext.encode(Ext.pluck(this.store.data.items,"data"));return a;};CreatePuckGrid.prototype.getPuckInfo=function(){var b=this;var a=[];a.shipmentName=b.puckData.puckInfo.shipmentName;a.dewarCode=b.puckData.puckInfo.dewarCode;a.puckCode=b.puckData.puckInfo.code;
a.shippingId=b.puckData.puckInfo.shippingId;a.dewarId=b.puckData.puckInfo.dewarId;a.containerId=b.puckData.puckInfo.containerId;return a;};CreatePuckGrid.prototype.changeProteinAcronym=function(d,c){var b=this.getCellValue(d);var a=0;this.grid.store.getAt(c).set("unitCellA",b.cellA);this.grid.store.getAt(c).set("unitCellB",b.cellB);
this.grid.store.getAt(c).set("unitCellC",b.cellC);this.grid.store.getAt(c).set("unitCellAlpha",b.cellAlpha);this.grid.store.getAt(c).set("unitCellBeta",b.cellBeta);this.grid.store.getAt(c).set("unitCellGamma",b.cellGamma);this.grid.store.getAt(c).set("spaceGroup",b.spaceGroup);this.grid.store.getAt(c).set("comments",b.comments);
if(b.diffractionPlanVO){this.grid.store.getAt(c).set("oscillationRange",b.diffractionPlanVO.oscillationRange);this.grid.store.getAt(c).set("neededResolution",b.diffractionPlanVO.requiredResolution);this.grid.store.getAt(c).set("preObservedResolution",b.diffractionPlanVO.observedResolution);this.grid.store.getAt(c).set("experimentType",b.diffractionPlanVO.experimentKind);
}};CreatePuckGrid.prototype.canEditOscillationRange=function(a){return(a!="MXPressE"&&a!="MXPressO"&&a!="MXPressL"&&a!="MXScore");};CreatePuckGrid.prototype.changeExperimentType=function(b,a){if(!this.canEditOscillationRange(b)){this.grid.store.getAt(a).set("oscillationRange","");}};CreatePuckGrid.prototype.getCellValue=function(d){var a=new Array(6);
for(var c=0;c<7;c++){a[c]="";}var b=-1;for(var c=0;c<this.proteinList.length;c++){if(this.proteinList[c].proteinAcronym==d){b=c;break;}}if(b!=-1){a=this.crystalValuesList[b];}return a;};CreatePuckGrid.prototype.reset=function(){var b=[];for(var a=0;a<10;a++){b.push({sampleId:this.features[a].sampleId,position:a+1,experimentType:"Default"});
}this.features=b;this.store.loadData(this.features,false);};CreatePuckGrid.prototype.deletePuck=function(){var a=this;if(confirm("Do you want to remove this puck?")){this.onRemovePuckButtonClicked.notify({"containerId":a.puckData.puckInfo.containerId});}};CreatePuckGrid.prototype.copyPuck=function(){this.onCopyPuckButtonClicked.notify({"containerId":this.puckData.puckInfo.containerId,"listSamples":this.getListSamples()});
};function DewarForm(a){this.dewar=null;}DewarForm.prototype.getDewar=function(){var a=this;this.dewar.dewarName=Ext.getCmp(this.panel.getItemId()).getValues().dewarName;return this.dewar;};DewarForm.prototype.refresh=function(a){this.dewar=a;};DewarForm.prototype.getPanel=function(b){this.dewar=b;var a=this;
if(this.panel==null){this.panel=Ext.createWidget("form",{bodyPadding:5,frame:true,border:0,layout:"fit",fieldDefaults:{labelAlign:"left"},items:[{xtype:"container",border:false,defaultType:"textfield",items:[{fieldLabel:"Dewar label",name:"dewarName",tooltip:"Dewar label",width:350,allowBlank:false,maxLength:45,value:this.dewar.dewarName}]}]});
}return this.panel;};DewarForm.prototype.isValid=function(){return this.panel.getForm().isValid();};function DewarPanel(a){var b=this;this.width=550;this.height=500;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.dewarIndex=-1;this.dewarId=-1;this.contextPath="";
this.puckTab=null;this.listPuckPanel=null;this.onAddPuckButtonClicked=new Event(this);this.onEditDewarButtonClicked=new Event(this);this.onRemoveDewarButtonClicked=new Event(this);this.onEditPuckButtonClicked=new Event(this);this.onRemovePuckButtonClicked=new Event(this);this.onSavePuckButtonClicked=new Event(this);
this.onCopyPuckButtonClicked=new Event(this);this.onPastePuckButtonClicked=new Event(this);this.onCopySampleButtonClicked=new Event(this);}DewarPanel.prototype.getPanel=function(b,c){var e=this;e.dewarIndex=c;e.dewarId=-1;e.contextPath="";if(b){e.contextPath=b.contextPath;e.dewarId=b.listDewar[c].dewarId;
}var d=e.getItems(b);e.puckTab=e.getPuckTab(d);var g="../images/print_16x16.png";var j="Please print your component labels and stick them on the transport box.";var a="";if(b&&b.listDewar&&b.listDewar[c]){var h=b.listDewar[c].warningIcon;if(b.listDewar[c].warningIcon==true){g="../images/print_warning_16x16.png";
}j=b.listDewar[c].tooltip;a=b.listDewar[c].alertMessage;}var f=true;if(b&&b.canPaste&&b.canPaste==true){f=false;}e.panel=Ext.widget({xtype:"form",layout:{type:"fit"},collapsible:false,frame:true,fieldDefaults:{msgTarget:"side",labelWidth:100},defaultType:"textfield",defaults:{labelStyle:"padding-bottom:10px;"},style:{marginBottom:"10px"},tbar:[{icon:"../images/Edit_16x16_01.png",tooltip:{text:"Edit the dewar label",title:"Edit dewar"},handler:function(){e.editDewar();
}},{icon:g,tooltip:{text:j,title:"Print labels"},handler:function(){if(confirm(a)){window.location.href=e.contextPath+"/reader/viewDewarAction.do?reqCode=generateLabels&dewarId="+e.dewarId;}}},{xtype:"tbseparator"},{tooltip:{text:"Paste the copied puck with samples in this dewar",title:"Paste puck"},id:"button_paste_"+e.dewarId,icon:"../images/editpaste.png",disabled:f,handler:function(){e.pastePuck();
}},{xtype:"tbseparator"},{icon:"../images/cancel.png",tooltip:{text:"Delete this dewar together with the pucks inside",title:"Delete dewar"},handler:function(){e.deleteDewar();}}],items:[e.puckTab]});return e.panel;};DewarPanel.prototype.getItems=function(f){var g=this;g.puckItems=[];g.listPuckPanel=[];
var e=[];if(f&&f.listOfContainer){e=f.listOfContainer[g.dewarIndex];}for(var d=e.length-1;d>=0;d--){var a=new CreatePuckGrid();a.onEditPuckButtonClicked.attach(function(h,j){g.editPuck(j.containerId,j.puckName);});a.onRemovePuckButtonClicked.attach(function(h,j){g.deletePuck(j.containerId);});a.onSaveButtonClicked.attach(function(j,h){g.savePuck(h.listSamples,h.puckInfo);
});a.onCopyPuckButtonClicked.attach(function(h,j){g.copyPuck(j.containerId,j.listSamples);});a.onCopySampleButtonClicked.attach(function(h,k){var j=k.sampleToCopy;g.onCopySampleButtonClicked.notify({"sampleToCopy":j});});var b=[];b.proteinList=f.proteinList;b.spaceGroupList=f.spaceGroupList;b.experimentTypeList=f.experimentTypeList;
b.crystalValuesList=f.crystalValuesList;b.listSamples=f.listOfSamples[g.dewarIndex][d];b.fillShipmentMode=true;var c=[];c.containerId=e[d].containerId;c.code=e[d].code;c.shippingId=f.shippingId;c.dewarId=f.listDewar[g.dewarIndex].dewarId;c.dewarCode=f.listDewar[g.dewarIndex].code;c.shipmentName=f.shippingName;
b.puckInfo=c;g.puckItems.push({tabConfig:{title:e[d].code,iconCls:"icon-puck"},items:[a.getGrid(b)]});g.listPuckPanel.push(a);}g.puckItems.push({tabConfig:{title:"+",name:"add-puck-tab",iconCls:"icon-puck",tooltip:{text:"Click here to add a new puck",title:"Add a new puck"}}});return g.puckItems;};DewarPanel.prototype.setSampleToCopy=function(b){var c=this;
for(var a=0;a<c.listPuckPanel.length;a++){c.listPuckPanel[a].setSampleToCopy(b);}};DewarPanel.prototype.getPuckTab=function(a){var b=this;b.puckTab=Ext.create("Ext.tab.Panel",{activeTab:0,width:"100%",style:{marginTop:"10px"},defaults:{bodyPadding:0,autoScroll:true},items:a,listeners:{render:function(){this.items.each(function(c){c.tab.on("click",function(){if(c.tab.name=="add-puck-tab"){b.addNewPuck(b.dewarId);
}});});}}});return b.puckTab;};DewarPanel.prototype.refresh=function(c){var d=this;d.data=c;var b;while(b=d.panel.items.first()){d.panel.remove(b,true);}var a=d.getItems(c);d.puckTab=d.getPuckTab(a);d.panel.add(d.puckTab);d.panel.doLayout();};DewarPanel.prototype.setFirstActiveTab=function(){var a=this;
a.puckTab.setActiveTab(0);};DewarPanel.prototype.setLastActiveTab=function(){var c=this;var a=c.puckTab.items.getCount();var b=a-1;if(a>1){b=a-2;}c.puckTab.setActiveTab(b);};DewarPanel.prototype.addNewPuck=function(a){this.onAddPuckButtonClicked.notify({"dewarId":a});};DewarPanel.prototype.editDewar=function(){var a=this;
a.onEditDewarButtonClicked.notify({"dewarIndex":a.dewarIndex});};DewarPanel.prototype.deleteDewar=function(){var a=this;if(confirm("Do you want to remove this dewar?")){this.onRemoveDewarButtonClicked.notify({"dewarIndex":a.dewarIndex});}};DewarPanel.prototype.editPuck=function(a,b){var c=this;c.onEditPuckButtonClicked.notify({"containerId":a,"puckName":b});
};DewarPanel.prototype.deletePuck=function(a){var b=this;b.onRemovePuckButtonClicked.notify({"containerId":a});};DewarPanel.prototype.savePuck=function(b,a){var c=this;c.onSavePuckButtonClicked.notify({"listSamples":b,"puckInfo":a});};DewarPanel.prototype.copyPuck=function(a,b){var c=this;c.onCopyPuckButtonClicked.notify({"containerId":a,"listSamples":b});
};DewarPanel.prototype.getActivPuckPanel=function(){var c=this;var b=c.puckTab.getActiveTab();var a=c.puckTab.items.indexOf(b);return c.listPuckPanel[a];};DewarPanel.prototype.setPuckPasteActiv=function(a){var b=this;Ext.getCmp("button_paste_"+b.dewarId).setDisabled(!a);};DewarPanel.prototype.pastePuck=function(){var a=this;
a.onPastePuckButtonClicked.notify({"dewarId":a.dewarId});};function DewarWindow(a){this.width=400;this.height=100;this.addMode=true;if(a!=null){if(a.addMode!=null){this.addMode=a.addMode;}}this.form=new DewarForm(a);GenericWindow.prototype.constructor.call(this,{form:this.form,width:this.width,height:this.height});
}DewarWindow.prototype.getButtons=GenericWindow.prototype.getButtons;DewarWindow.prototype._render=GenericWindow.prototype._render;DewarWindow.prototype._postRender=GenericWindow.prototype._postRender;DewarWindow.prototype.save=function(){if(!this.form.isValid()){BUI.showError("The dewar label is required");
return;}this.onSaved.notify(this.form.getDewar());this.panel.close();};DewarWindow.prototype.cancel=function(){this.onCancelled.notify();this.panel.close();};DewarWindow.prototype.draw=function(a){this.title="Edit dewar";if(this.addMode==true){this.title="Add a new dewar";}this._render(a);};function FillShipmentPanel(a){var b=this;
this.width=550;this.height=500;this.onAddDewarButtonClicked=new Event(this);this.onEditDewarButtonClicked=new Event(this);this.onRemoveDewarButtonClicked=new Event(this);this.onAddPuckButtonClicked=new Event(this);this.onEditPuckButtonClicked=new Event(this);this.onRemovePuckButtonClicked=new Event(this);
this.onSavePuckButtonClicked=new Event(this);this.onCopyPuckButtonClicked=new Event(this);this.onPastePuckButtonClicked=new Event(this);this.dewarTab=null;this.shippingId=null;this.listDewarPanel=null;this.dewarItems=[];if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;
}}}FillShipmentPanel.prototype.getPanel=function(b){var c=this;c.data=b;c.shippingId=b.shippingId;var a=c.getItems(b);c.dewarTab=c.getDewarTab(a);c.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,layout:{type:"vbox"},autoScroll:true,style:{padding:0},items:[c.dewarTab]});return c.panel;
};FillShipmentPanel.prototype.getItems=function(c){var d=this;d.dewarItems=[];d.listDewarPanel=[];if(c&&c.listDewar){for(var a=c.listDewar.length-1;a>=0;a--){var b=new DewarPanel();b.onEditDewarButtonClicked.attach(function(e,f){d.editDewar(f.dewarIndex);});b.onRemoveDewarButtonClicked.attach(function(e,f){d.removeDewar(f.dewarIndex);
});b.onAddPuckButtonClicked.attach(function(e,f){d.addNewPuck(f.dewarId);});b.onEditPuckButtonClicked.attach(function(e,f){d.editPuck(f);});b.onRemovePuckButtonClicked.attach(function(e,f){d.deletePuck(f.containerId);});b.onSavePuckButtonClicked.attach(function(e,f){d.savePuck(f.listSamples,f.puckInfo);
});b.onCopyPuckButtonClicked.attach(function(e,f){d.copyPuck(f.containerId,f.listSamples);});b.onPastePuckButtonClicked.attach(function(e,f){d.pastePuck(f.dewarId);});b.onCopySampleButtonClicked.attach(function(e,f){d.setSampleToCopy(f.sampleToCopy);});d.dewarItems.push({tabConfig:{title:c.listDewar[a].code,iconCls:"icon-dewar"},items:[b.getPanel(c,a)]});
d.listDewarPanel.push(b);}}d.dewarItems.push({tabConfig:{title:"+",name:"add-dewar-tab",iconCls:"icon-dewar",tooltip:{text:"Click here to add a new dewar",title:"Add a new dewar"}}});return d.dewarItems;};FillShipmentPanel.prototype.getDewarTab=function(a){var b=this;b.dewarTab=Ext.create("Ext.tab.Panel",{activeTab:0,width:"100%",style:{marginTop:"10px"},defaults:{bodyPadding:0,autoScroll:true},listeners:{render:function(){this.items.each(function(c){c.tab.on("click",function(){if(c.tab.name=="add-dewar-tab"){b.addNewDewar(b.shippingId);
}});});}},items:a});return b.dewarTab;};FillShipmentPanel.prototype.refresh=function(c){var d=this;d.data=c;var b;while(b=d.panel.items.first()){d.panel.remove(b,true);}var a=d.getItems(c);d.dewarTab=d.getDewarTab(a);d.panel.add(d.dewarTab);d.panel.doLayout();};FillShipmentPanel.prototype.addNewPuck=function(a){this.onAddPuckButtonClicked.notify({"dewarId":a});
};FillShipmentPanel.prototype.addNewDewar=function(a){this.onAddDewarButtonClicked.notify({"shippingId":a});};FillShipmentPanel.prototype.setFirstActiveTab=function(){var a=this;a.dewarTab.setActiveTab(0);};FillShipmentPanel.prototype.setLastActiveTab=function(){var c=this;var a=c.dewarTab.items.getCount();
var b=a-1;if(a>1){b=a-2;}c.dewarTab.setActiveTab(b);};FillShipmentPanel.prototype.getActivDewarPanel=function(){var c=this;var b=c.dewarTab.getActiveTab();var a=c.dewarTab.items.indexOf(b);return c.listDewarPanel[a];};FillShipmentPanel.prototype.setPuckFirstActiveTab=function(){var b=this;var a=b.getActivDewarPanel();
a.setFirstActiveTab();};FillShipmentPanel.prototype.setPuckLastActiveTab=function(){var b=this;var a=b.getActivDewarPanel();a.setLastActiveTab();};FillShipmentPanel.prototype.setSampleToCopy=function(a){var c=this;for(var b=0;b<c.listDewarPanel.length;b++){c.listDewarPanel[b].setSampleToCopy(a);}};FillShipmentPanel.prototype.editDewar=function(c){var d=this;
var a=d.data.listDewar[c].code;var b=d.data.listDewar[c].dewarId;d.onEditDewarButtonClicked.notify({"dewarId":b,"dewarName":a});};FillShipmentPanel.prototype.removeDewar=function(b){var c=this;var a=c.data.listDewar[b].dewarId;c.onRemoveDewarButtonClicked.notify({"dewarId":a});};FillShipmentPanel.prototype.editPuck=function(b){var d=this;
var c=b.puckName;var a=b.containerId;d.onEditPuckButtonClicked.notify({"containerId":a,"puckName":c});};FillShipmentPanel.prototype.deletePuck=function(a){var b=this;b.onRemovePuckButtonClicked.notify({"containerId":a});};FillShipmentPanel.prototype.savePuck=function(b,a){var c=this;c.onSavePuckButtonClicked.notify({"listSamples":b,"puckInfo":a});
};FillShipmentPanel.prototype.copyPuck=function(a,b){var c=this;c.onCopyPuckButtonClicked.notify({"containerId":a,"listSamples":b});};FillShipmentPanel.prototype.setPuckPasteActiv=function(a){var e=this;var b=e.dewarTab.items.length-1;for(var c=0;c<b;c++){var d=e.listDewarPanel[c];d.setPuckPasteActiv(a);
}};FillShipmentPanel.prototype.pastePuck=function(a){var b=this;b.onPastePuckButtonClicked.notify({"dewarId":a});};function HelpPanel(a){var b=this;this.width=550;this.height=500;this.allHelp=true;if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}if(a.allHelp!=null){this.allHelp=a.allHelp;
}}}HelpPanel.prototype.getPanel=function(){var b=this;var a='<div style="white-space:normal !important;word-wrap: break-word;">';if(b.allHelp==true){a+="<h4>Description</h4>";a+="This page allows you to describe the composition of your shipment, by editing the contents of the dewars.</br>";a+="</br><h4>Dewar level</h4>";
a+="Each tab represents a dewar.</br>";a+='<img src="../images/Dewar.png" alt="Dewar">+: to add a new dewar to a shipment.</br>';a+='<img src="../images/Edit_16x16_01.png" alt="Edit label">: to change the name of the selected dewar. Remember that the names of the dewars must be unique within the same shipment.</br>';
a+='<img src="../images/print_16x16.png" alt="Print components labels">: to print your component labels. Stick them to your shipment components prior to sending (see instructions on first page) in order to track progress to the beamline.</br>';a+='<img src="../images/editpaste.png" alt="Paste puck">: to paste the contents of a puck into the current dewar after you have copied them from the puck interface using '+'one of the two icons <img src="../images/editcopy.png" alt="Copy puck"> or <img src="../images/editcut.png" alt="Cut puck">. '+'You can then change the puck label and the samples names (using <img src="../images/Edit_16x16_01.png" alt="Edit label">at the appropriate level) which are automatically modified to avoid a duplication of the sample names in the same shipment.</br>';
a+='<img src="../images/cancel.png" alt="Delete dewar">: to remove the selected dewar and its contents.</br>';a+="</br><h4>Puck level</h4>";a+="Each tab represents a puck. </br>";}a+="Each row of the table represents a sample at a given position in the puck. Make sure you provide data in all mandatory fields (highlighted in light red) for each sample. </br>";
a+="Sample names: </br>";a+="- Make sure the sample name contains only a-z , A-Z or 0-9 or - or _ characters.</br>";a+="- Make sure the sample name is unique for a protein in the same shipment.</br>";a+="The experiment type should not be null, Default as default. </br>";a+='The top-left red icon in a cell <img src="../images/help/gridFieldUpdated.PNG" alt="modification icon"> indicates that the field has been updated. '+'You have to click on the <img src="../images/save.gif" alt="Save"> button to save any modifications. </br>';
if(b.allHelp==true){a+='<img src="../images/Basket.png" alt="Puck">+: to add a new puck to the selected dewar.</br>';a+='<img src="../images/Edit_16x16_01.png" alt="Edit label">: to change the selected puck label (to its barcode for example). Remember that the labels of the pucks must be unique within the same shipment.</br>';
a+='<img src="../images/editcopy.png" alt="Copy puck">: to copy a puck and its contents. You can then paste this in any dewar (in this shipment or another), by clicking on the <img src="../images/editpaste.png" alt="Paste puck"> button at the dewar menu level.</br>';a+='<img src="../images/editcut.png" alt="Cut puck">: to copy the puck into the clipboard and remove it. You can then paste the puck into another dewar.</br>';
}a+='<img src="../images/save.gif" alt="Save">: to save your modifications.</br>';if(b.allHelp==true){a+='<img src="../images/cancel.png" alt="Delete puck">: to remove this puck and its contents.</br>';}a+='<img src="../images/recur.png" alt="Reset">: to reset the puck contents, all fields are set to their default values.</br>';
a+='<img src="../images/help/changeSampleNameAuto.PNG" alt="change sample name">: to automatically update the names of the samples in the puck, with the same protein (protein acronym and space group), by adding an increment number to the name of the 1st sample.</br>';a+="</br><h4>Experiment type definitions</h4>";
a+="These types are defined for automatic processes to be performed on that sample. This is an ongoing developement. These parameters will only be taken in account for specific pilote studies. Don't use this field if you don't belong to that studies.</br>";a+="<b>Default</b> = manual intervention by the crystallographer at the beamline</br>";
a+="<b>MXPressE</b> = the sample is automatically going through an autoloop centring followed by an X-ray centring, by an EDNA enhanced characterisation and a data collection based on the EDNA proposed diffraction plan</br>";a+="<b>MXPressO</b> = the sample is automatically going through an autoloop centring followed by an X-ray centring and a data collection of 180&deg; by steps of 0.2&deg; oscillations with an attenuated beam (value calculated on an average protein crystal size)</br>";
a+="<b>MXPressL</b> = the sample is automatically going through an autoloop centring followed by a data collection of 180&deg; by steps of 0.2&deg; oscillations with an attenuated beam (value calculated on an average protein crystal size)</br>";a+="<b>MXScore</b> = the sample is automatically going through an autoloop centring followed by an X-ray centring and an EDNA characterisation.</br>";
a+="</div>";b.panel=Ext.widget({xtype:"form",layout:{type:"fit"},collapsible:true,collapsed:true,frame:true,title:"Help",style:{marginBottom:"10px"},items:[{xtype:"component",style:"margin-top:10px",html:a}]});return b.panel;};Ext.Loader.setConfig({enabled:true});var createPuckGrid=null;var puckHeadPanel=null;
var IspybCreatePuck={start:function(a){this.tartgetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showCreatePuckPage(a);},showCreatePuckPage:function(b){var c=this;var a=new Shipping();a.onSaved.attach(function(e,g){if(g&&g.errors&&g.errors.length>0){var d=[];d.targetId=b;d.errors=g.errors;var f=new ErrorPanel(d);return;}c.refreshPuck(g);});createPuckGrid=new CreatePuckGrid();
createPuckGrid.onSaveButtonClicked.attach(function(f,e){var g=createPuckGrid.getListSamples();var d=puckHeadPanel.getPuckInfo();a.savePuck(g,d);});a.shippingRetrieved.attach(function(e,h){puckHeadPanel=new PuckHeadPanel();var g=[];g.allHelp=false;var f=new HelpPanel(g);var j=[];j.push(f.getPanel());j.push(puckHeadPanel.getPanel(h));
j.push(createPuckGrid.getGrid(h));var d=Ext.widget({xtype:"form",layout:{type:"fit"},frame:true,style:{marginTop:"10px"},items:[{xtype:"component",style:"margin-top:10px",html:"(*) mandatory field for each sample"}]});j.push(d);c.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,width:"100%",renderTo:b,style:{padding:0},items:j});
});a.getInformationForPuck();},refreshPuck:function(a){var b=this;createPuckGrid.refresh(a);if(a&&a.shippingId&&a.shippingId!=-1){document.location.href="viewSample.do?reqCode=displayForShipping&shippingId="+a.shippingId;}}};Ext.Loader.setConfig({enabled:true});var createPuckGrid=null;var fillShipmentPanel=null;
var IspybFillShipment={start:function(a){this.tartgetId=a;Ext.Loader.setPath("Ext.ux","../js/external/ux");Ext.require(["Ext.selection.CellModel","Ext.grid.*","Ext.data.*","Ext.ux.data.PagingMemoryProxy","Ext.util.*","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.RowExpander","Ext.selection.CheckboxModel","Ext.selection.CellModel","Ext.layout.container.Column","Ext.tab.*","Ext.ux.grid.FiltersFeature","Ext.selection.CellModel","Ext.state.*","Ext.form.*","Ext.ux.CheckColumn","Ext.ux.form.MultiSelect","Ext.ux.form.ItemSelector","Ext.chart.*","Ext.Window","Ext.fx.target.Sprite","Ext.layout.container.Fit","Ext.window.MessageBox","Ext.tip.*"]);
Ext.QuickTips.init();this.showFillShipmentPage(a);},showFillShipmentPage:function(b){var d=this;var a=new Shipping();createPuckGrid=new CreatePuckGrid();var c=new PuckHeadPanel();createPuckGrid.onSaveButtonClicked.attach(function(g,f){var h=createPuckGrid.getListSamples();var e=c.getPuckInfo();a.savePuck(h,e);
});a.shipmentRetrieved.attach(function(f,k){if(k.errors&&k.errors.length>0){var g=[];g.targetId=b;g.errors=k.errors;var j=new ErrorPanel(g);return;}fillShipmentPanel=new FillShipmentPanel();fillShipmentPanel.onAddDewarButtonClicked.attach(function(o,n){var m=n.shippingId;var r=[];r.dewarName="";var p=[];
p.addMode=true;var q=new DewarWindow(p);q.onSaved.attach(function(s,t){a.addDewar(t);});q.onCancelled.attach(function(s){fillShipmentPanel.setFirstActiveTab();});q.draw(r);});fillShipmentPanel.onEditDewarButtonClicked.attach(function(n,m){var q=[];q.dewarName=m.dewarName;q.dewarId=m.dewarId;var o=[];
o.addMode=false;var p=new DewarWindow(o);p.onSaved.attach(function(r,s){a.editDewar(s);});p.onCancelled.attach(function(r){});p.draw(q);});fillShipmentPanel.onRemoveDewarButtonClicked.attach(function(n,m){a.removeDewar(m.dewarId);});fillShipmentPanel.onAddPuckButtonClicked.attach(function(o,n){var r=n.dewarId;
var m=[];m.puckName="";m.dewarId=n.dewarId;var p=[];p.addMode=true;var q=new PuckWindow(p);q.onSaved.attach(function(t,s){a.addPuck(s);});q.onCancelled.attach(function(s){fillShipmentPanel.setPuckFirstActiveTab();});q.draw(m);});fillShipmentPanel.onPastePuckButtonClicked.attach(function(n,m){a.pastePuck(m.dewarId);
});fillShipmentPanel.onEditPuckButtonClicked.attach(function(o,n){var m=[];m.puckName=n.puckName;m.containerId=n.containerId;var p=[];p.addMode=false;var q=new PuckWindow(p);q.onSaved.attach(function(s,r){a.editPuck(r);});q.onCancelled.attach(function(r){});q.draw(m);});fillShipmentPanel.onRemovePuckButtonClicked.attach(function(n,m){a.removePuck(m.containerId);
});fillShipmentPanel.onSavePuckButtonClicked.attach(function(n,m){a.updatePuck(m.listSamples,m.puckInfo);});fillShipmentPanel.onCopyPuckButtonClicked.attach(function(n,m){a.copyPuck(m.containerId,m.listSamples);});var h=new HelpPanel();var l=[];l.push(h.getPanel());l.push(fillShipmentPanel.getPanel(k));
var e=Ext.widget({xtype:"form",layout:{type:"fit"},frame:true,style:{marginTop:"10px"},items:[{xtype:"component",style:"margin-top:10px",html:"(*) mandatory field for each sample"}]});l.push(e);d.panel=Ext.create("Ext.panel.Panel",{plain:true,frame:false,border:0,width:"100%",renderTo:b,style:{padding:0},items:l});
});a.onDewarUpdated.attach(function(e,h){if(h.errors&&h.errors.length>0){var f=[];f.targetId=b;f.errors=h.errors;var g=new ErrorPanel(f);return;}fillShipmentPanel.refresh(h);fillShipmentPanel.setLastActiveTab();});a.onPuckUpdated.attach(function(e,h){if(h.errors&&h.errors.length>0){var f=[];f.targetId=b;
f.errors=h.errors;var g=new ErrorPanel(f);return;}fillShipmentPanel.refresh(h);fillShipmentPanel.setPuckLastActiveTab();});a.onPuckCopied.attach(function(e,h){if(h.errors&&h.errors.length>0){var f=[];f.targetId=b;f.errors=h.errors;var g=new ErrorPanel(f);return;}fillShipmentPanel.setPuckPasteActiv(true);
});a.onPuckPasted.attach(function(e,h){if(h.errors&&h.errors.length>0){var f=[];f.targetId=b;f.errors=h.errors;var g=new ErrorPanel(f);return;}fillShipmentPanel.refresh(h);});a.onSaved.attach(function(e,h){if(h.errors&&h.errors.length>0){var f=[];f.targetId=b;f.errors=h.errors;var g=new ErrorPanel(f);
return;}});a.getInformationForShipping();}};function PuckForm(a){this.puck=null;}PuckForm.prototype.getPuck=function(){var a=this;this.puck.puckName=Ext.getCmp(this.panel.getItemId()).getValues().puckName;return this.puck;};PuckForm.prototype.refresh=function(a){this.puck=a;};PuckForm.prototype.getPanel=function(a){this.puck=a;
var b=this;if(this.panel==null){this.panel=Ext.createWidget("form",{bodyPadding:5,frame:true,border:0,layout:{type:"vbox"},fieldDefaults:{labelAlign:"left"},items:[{xtype:"container",border:false,defaultType:"textfield",items:[{fieldLabel:"Puck label",name:"puckName",tooltip:"Puck label",allowBlank:false,width:350,maxLength:45,value:this.puck.puckName}]}]});
}return this.panel;};PuckForm.prototype.isValid=function(){return this.panel.getForm().isValid();};function PuckHeadPanel(a){var b=this;this.width=550;this.height=500;this.onSavePuckInfo=new Event(this);if(a!=null){if(a.width!=null){this.width=a.width;}if(a.height!=null){this.height=a.height;}}this.shippingId=null;
this.dewarId=null;this.containerId=null;}PuckHeadPanel.prototype.getPuckInfo=function(){var b=Ext.getCmp(this.panel.getItemId()).getValues().shipmentName;var d=Ext.getCmp(this.panel.getItemId()).getValues().dewarCode;var a=Ext.getCmp(this.panel.getItemId()).getValues().puckCode;var c=[];c.shipmentName=b;
c.dewarCode=d;c.puckCode=a;c.shippingId=this.shippingId;c.dewarId=this.dewarId;c.containerId=this.containerId;return c;};PuckHeadPanel.prototype.getPanel=function(e){var g=this;var c="";var f="";var b="";var d=false;var a=false;if(e&&e.puckInfo){c=e.puckInfo.shipmentName;f=e.puckInfo.dewarCode;b=e.puckInfo.puckCode;
g.shippingId=e.puckInfo.shippingId;g.dewarId=e.puckInfo.dewarId;g.containerId=e.puckInfo.containerId;if(e.puckInfo.shippingId&&e.puckInfo.shippingId!="null"){d=true;}if(e.puckInfo.containerId&&e.puckInfo.containerId!="null"){a=true;}}g.panel=Ext.widget({xtype:"form",layout:{type:"vbox"},collapsible:true,frame:true,title:"Puck Information",fieldDefaults:{msgTarget:"side",labelWidth:100},defaultType:"textfield",defaults:{labelStyle:"padding-bottom:10px;"},style:{marginBottom:"10px"},items:[{fieldLabel:"Shipping",name:"shipmentName",tooltip:"Shipping Name",value:c,readOnly:d,allowBlank:false,maxLength:45,hideTrigger:true},{fieldLabel:"Dewar",name:"dewarCode",tooltip:"Dewar code",value:f,readOnly:d,allowBlank:false,maxLength:45,hideTrigger:true},{fieldLabel:"Puck",name:"puckCode",tooltip:"Puck code",value:b,readOnly:a,allowBlank:false,maxLength:45,hideTrigger:true}]});
return g.panel;};function PuckWindow(a){this.width=400;this.height=100;this.addMode=true;if(a!=null){if(a.addMode!=null){this.addMode=a.addMode;}}this.form=new PuckForm(a);GenericWindow.prototype.constructor.call(this,{form:this.form,width:this.width,height:this.height});}PuckWindow.prototype.getButtons=GenericWindow.prototype.getButtons;
PuckWindow.prototype._render=GenericWindow.prototype._render;PuckWindow.prototype._postRender=GenericWindow.prototype._postRender;PuckWindow.prototype.save=function(){if(!this.form.isValid()){BUI.showError("The puck label is required");return;}this.onSaved.notify(this.form.getPuck());this.panel.close();
};PuckWindow.prototype.cancel=function(){this.onCancelled.notify();this.panel.close();};PuckWindow.prototype.draw=function(a){this.title="Edit puck";if(this.addMode==true){this.title="Add a new puck";}this._render(a);};function Shipping(a){this.type="POST";this.json=a;this.onSaved=new Event(this);this.shippingRetrieved=new Event(this);
this.shipmentRetrieved=new Event(this);this.onDewarUpdated=new Event(this);this.onPuckUpdated=new Event(this);this.onPuckCopied=new Event(this);this.onPuckPasted=new Event(this);this.onError=new Event(this);}Shipping.prototype.getInformationForPuck=function(){var b=this;var a=Ext.MessageBox.wait("Please wait...","Loading Data");
$.ajax({type:this.type,url:"createPuckAction.do?reqCode=getInformationForPuck",data:{},datatype:"text/json",success:function(c){b.shippingRetrieved.notify(c);a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});};Shipping.prototype.getInformationForShipping=function(){var b=this;
var a=Ext.MessageBox.wait("Please wait...","Loading Data");$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=getInformationForShipment",data:{},datatype:"text/json",success:function(c){b.shipmentRetrieved.notify(c);a.hide();},error:function(e,c,d){b.onError.notify(e.responseText);a.hide();}});
};Shipping.prototype.updatePuck=function(c,a){var e=this;var b=Ext.MessageBox.wait("Please wait...","Saving Data");var d={listSamples:c,shipmentName:a.shipmentName,dewarCode:a.dewarCode,puckCode:a.puckCode,shippingId:a.shippingId,dewarId:a.dewarId,containerId:a.containerId};$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=savePuck",data:d,datatype:"text/json",success:function(f){e.onPuckUpdated.notify(f);
b.hide();},error:function(h,f,g){e.onError.notify(h.responseText);b.hide();}});};Shipping.prototype.savePuck=function(c,a){var e=this;var b=Ext.MessageBox.wait("Please wait...","Saving Data");var d={listSamples:c,shipmentName:a.shipmentName,dewarCode:a.dewarCode,puckCode:a.puckCode,shippingId:a.shippingId,dewarId:a.dewarId,containerId:a.containerId};
$.ajax({type:this.type,url:"createPuckAction.do?reqCode=savePuck",data:d,datatype:"text/json",success:function(f){e.onSaved.notify(f);b.hide();},error:function(h,f,g){e.onError.notify(h.responseText);b.hide();}});};Shipping.prototype.addDewar=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Adding dewar");
if(a){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=addDewar",data:{dewarName:a.dewarName},datatype:"text/json",success:function(d){c.onDewarUpdated.notify(d);b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});}return null;};Shipping.prototype.editDewar=function(c){var b=this;
var a=Ext.MessageBox.wait("Please wait...","Editing dewar");if(c){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=editDewar",data:{dewarName:c.dewarName,dewarId:c.dewarId},datatype:"text/json",success:function(d){b.onDewarUpdated.notify(d);a.hide();},error:function(f,d,e){b.onError.notify(f.responseText);
a.hide();}});}return null;};Shipping.prototype.removeDewar=function(b){var c=this;var a=Ext.MessageBox.wait("Please wait...","Removing dewar");if(b){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=removeDewar",data:{dewarId:b},datatype:"text/json",success:function(d){c.onDewarUpdated.notify(d);
a.hide();},error:function(f,d,e){c.onError.notify(f.responseText);a.hide();}});}return null;};Shipping.prototype.addPuck=function(c){var b=this;var a=Ext.MessageBox.wait("Please wait...","Adding puck");if(c){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=addPuck",data:{puckName:c.puckName,dewarId:c.dewarId},datatype:"text/json",success:function(d){b.onPuckUpdated.notify(d);
a.hide();},error:function(f,d,e){b.onError.notify(f.responseText);a.hide();}});}return null;};Shipping.prototype.editPuck=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Editing puck");if(a){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=editPuck",data:{puckName:a.puckName,containerId:a.containerId},datatype:"text/json",success:function(d){c.onPuckUpdated.notify(d);
b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});}return null;};Shipping.prototype.removePuck=function(a){var c=this;var b=Ext.MessageBox.wait("Please wait...","Removing puck");if(a){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=removePuck",data:{containerId:a},datatype:"text/json",success:function(d){c.onPuckUpdated.notify(d);
b.hide();},error:function(f,d,e){c.onError.notify(f.responseText);b.hide();}});}return null;};Shipping.prototype.copyPuck=function(a,b){var c=this;if(a){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=copyPuck",data:{containerId:a,listSamples:b},datatype:"text/json",success:function(d){c.onPuckCopied.notify(d);
},error:function(f,d,e){c.onError.notify(f.responseText);}});}return null;};Shipping.prototype.pastePuck=function(a){var b=this;if(a){$.ajax({type:this.type,url:"fillShipmentAction.do?reqCode=pastePuck",data:{dewarId:a},datatype:"text/json",success:function(c){b.onPuckPasted.notify(c);},error:function(e,c,d){b.onError.notify(e.responseText);
}});}return null;};